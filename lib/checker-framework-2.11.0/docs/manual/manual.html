<!DOCTYPE html>
<html >
<head><link rel="icon" href="favicon-checkerframework.png" type="image/png"/>
<meta http-equiv="Content-Type" content="text/html; charset=US-ASCII">
<meta name="generator" content="hevea 2.28">
<style type="text/css">
img { max-width: 100%; max-height: 100%; }
.li-itemize{margin:1ex 0ex;}
.li-enumerate{margin:1ex 0ex;}
.dd-description{margin:0ex 0ex 1ex 4ex;}
.dt-description{margin:0ex;}
.toc{list-style:none;}
.footnotetext{margin:0ex; padding:0ex;}
div.footnotetext P{margin:0px; text-indent:1em;}
.thefootnotes{text-align:left;margin:0ex;}
.dt-thefootnotes{margin:0em;}
.dd-thefootnotes{margin:0em 0em 0em 2em;}
.footnoterule{margin:1em auto 1em 0px;width:50%;}
.caption{padding-left:2ex; padding-right:2ex; margin-left:auto; margin-right:auto}
.title{margin:2ex auto;text-align:center}
.titlemain{margin:1ex 2ex 2ex 1ex;}
.titlerest{margin:0ex 2ex;}
.center{text-align:center;margin-left:auto;margin-right:auto;}
.flushleft{text-align:left;margin-left:0ex;margin-right:auto;}
.flushright{text-align:right;margin-left:auto;margin-right:0ex;}
div table{margin-left:inherit;margin-right:inherit;margin-bottom:2px;margin-top:2px}
td table{margin:auto;}
table{border-collapse:collapse;}
td{padding:0;}
.cellpadding0 tr td{padding:0;}
.cellpadding1 tr td{padding:1px;}
pre{text-align:left;margin-left:0ex;margin-right:auto;}
blockquote{margin-left:4ex;margin-right:4ex;text-align:left;}
td p{margin:0px;}
.boxed{border:1px solid black}
.textboxed{border:1px solid black}
.vbar{border:none;width:2px;background-color:black;}
.hbar{border:none;height:2px;width:100%;background-color:black;}
.hfill{border:none;height:1px;width:200%;background-color:black;}
.vdisplay{border-collapse:separate;border-spacing:2px;width:auto; empty-cells:show; border:2px solid red;}
.vdcell{white-space:nowrap;padding:0px; border:2px solid green;}
.display{border-collapse:separate;border-spacing:2px;width:auto; border:none;}
.dcell{white-space:nowrap;padding:0px; border:none;}
.dcenter{margin:0ex auto;}
.vdcenter{border:solid #FF8000 2px; margin:0ex auto;}
.minipage{text-align:left; margin-left:0em; margin-right:auto;}
.marginpar{border:solid thin black; width:20%; text-align:left;}
.marginparleft{float:left; margin-left:0ex; margin-right:1ex;}
.marginparright{float:right; margin-left:1ex; margin-right:0ex;}
.theorem{text-align:left;margin:1ex auto 1ex 0ex;}
.part{margin:2ex auto;text-align:center}
.lstlisting{font-family:monospace;white-space:pre;margin-right:auto;margin-left:0pt;text-align:left}
.lstframe{margin:auto;margin-bottom:2em}
</style>
<title>The Checker Framework Manual:  
Custom pluggable types for Java
</title>
</head>
<body >
<!--HEVEA command line is: hevea -fix -exec xxdate.exe manual.tex -->
<!--CUT STYLE book--><!--CUT DEF chapter 1 --><div class="center">
<img src="CFLogo.png">
</div><table class="title"><tr><td style="padding:1ex"><h1 class="titlemain">The Checker Framework Manual: <br>
Custom pluggable types for Java</h1><h3 class="titlerest"><a href="https://checkerframework.org/"><span style="font-family:monospace">https://checkerframework.org/</span></a></h3><h3 class="titlerest">Version 2.11.0 (30 Aug 2019)</h3></td></tr>
</table><p><span style="font-weight:bold">For the impatient:</span>
Section&#XA0;<a href="#installation">1.3</a>
describes how to <span style="font-weight:bold">install and use</span> pluggable type-checkers.</p><p>This manual is also available in <a href="https://checkerframework.org/manual/checker-framework-manual.pdf">PDF</a>.</p><!--TOC chapter id="sec1" Contents-->
<h1 id="sec1" class="chapter">Contents</h1><!--SEC END --><ul class="toc"><li class="li-toc">
<a href="#introduction">Chapter&#XA0;1&#XA0;&#XA0;Introduction</a>
<ul class="toc"><li class="li-toc">
<a href="#how-to-read-this-manual">1.1&#XA0;&#XA0;How to read this manual</a>
</li><li class="li-toc"><a href="#pluggable-types">1.2&#XA0;&#XA0;How it works: Pluggable types</a>
</li><li class="li-toc"><a href="#installation">1.3&#XA0;&#XA0;Installation</a>
</li><li class="li-toc"><a href="#example-use">1.4&#XA0;&#XA0;Example use: detecting a null pointer bug</a>
</li></ul>
</li><li class="li-toc"><a href="#using-a-checker">Chapter&#XA0;2&#XA0;&#XA0;Using a checker</a>
<ul class="toc"><li class="li-toc">
<a href="#writing-annotations">2.1&#XA0;&#XA0;Writing annotations</a>
</li><li class="li-toc"><a href="#running">2.2&#XA0;&#XA0;Running a checker</a>
</li><li class="li-toc"><a href="#checker-guarantees">2.3&#XA0;&#XA0;What the checker guarantees</a>
</li><li class="li-toc"><a href="#tips-about-writing-annotations">2.4&#XA0;&#XA0;Tips about writing annotations</a>
</li></ul>
</li><li class="li-toc"><a href="#nullness-checker">Chapter&#XA0;3&#XA0;&#XA0;Nullness Checker</a>
<ul class="toc"><li class="li-toc">
<a href="#nullness-checks">3.1&#XA0;&#XA0;What the Nullness Checker checks</a>
</li><li class="li-toc"><a href="#nullness-annotations">3.2&#XA0;&#XA0;Nullness annotations</a>
</li><li class="li-toc"><a href="#writing-nullness-annotations">3.3&#XA0;&#XA0;Writing nullness annotations</a>
</li><li class="li-toc"><a href="#suppressing-warnings-nullness">3.4&#XA0;&#XA0;Suppressing nullness warnings</a>
</li><li class="li-toc"><a href="#nullness-example">3.5&#XA0;&#XA0;Examples</a>
</li><li class="li-toc"><a href="#nullness-getting-started">3.6&#XA0;&#XA0;Tips for getting started</a>
</li><li class="li-toc"><a href="#nullness-related-work">3.7&#XA0;&#XA0;Other tools for nullness checking</a>
</li><li class="li-toc"><a href="#initialization-checker">3.8&#XA0;&#XA0;Initialization Checker</a>
</li></ul>
</li><li class="li-toc"><a href="#map-key-checker">Chapter&#XA0;4&#XA0;&#XA0;Map Key Checker</a>
<ul class="toc"><li class="li-toc">
<a href="#map-key-annotations">4.1&#XA0;&#XA0;Map key annotations</a>
</li><li class="li-toc"><a href="#map-key-defaults">4.2&#XA0;&#XA0;Default annotations</a>
</li><li class="li-toc"><a href="#map-key-examples">4.3&#XA0;&#XA0;Examples</a>
</li><li class="li-toc"><a href="#map-key-annotations-inference">4.4&#XA0;&#XA0;Inference of @KeyFor annotations</a>
</li></ul>
</li><li class="li-toc"><a href="#optional-checker">Chapter&#XA0;5&#XA0;&#XA0;Optional Checker for possibly-present data</a>
<ul class="toc"><li class="li-toc">
<a href="#optional-run-checker">5.1&#XA0;&#XA0;How to run the Optional Checker</a>
</li><li class="li-toc"><a href="#optional-annotations">5.2&#XA0;&#XA0;Optional annotations</a>
</li><li class="li-toc"><a href="#optional-guarantees">5.3&#XA0;&#XA0;What the Optional Checker guarantees</a>
</li></ul>
</li><li class="li-toc"><a href="#interning-checker">Chapter&#XA0;6&#XA0;&#XA0;Interning Checker</a>
<ul class="toc"><li class="li-toc">
<a href="#interning-annotations">6.1&#XA0;&#XA0;Interning annotations</a>
</li><li class="li-toc"><a href="#interning-annotating">6.2&#XA0;&#XA0;Annotating your code with <span style="font-family:monospace">@Interned</span></a>
</li><li class="li-toc"><a href="#interning-interned-classes">6.3&#XA0;&#XA0;Interned classes</a>
</li><li class="li-toc"><a href="#interning-checks">6.4&#XA0;&#XA0;What the Interning Checker checks</a>
</li><li class="li-toc"><a href="#interning-example">6.5&#XA0;&#XA0;Examples</a>
</li><li class="li-toc"><a href="#other-interning-annotations">6.6&#XA0;&#XA0;Other interning annotations</a>
</li></ul>
</li><li class="li-toc"><a href="#lock-checker">Chapter&#XA0;7&#XA0;&#XA0;Lock Checker</a>
<ul class="toc"><li class="li-toc">
<a href="#lock-guarantees">7.1&#XA0;&#XA0;What the Lock Checker guarantees</a>
</li><li class="li-toc"><a href="#lock-annotations">7.2&#XA0;&#XA0;Lock annotations</a>
</li><li class="li-toc"><a href="#lock-type-checking-rules">7.3&#XA0;&#XA0;Type-checking rules</a>
</li><li class="li-toc"><a href="#lock-examples">7.4&#XA0;&#XA0;Examples</a>
</li><li class="li-toc"><a href="#lock-details">7.5&#XA0;&#XA0;More locking details</a>
</li><li class="li-toc"><a href="#lock-other-annotations">7.6&#XA0;&#XA0;Other lock annotations</a>
</li><li class="li-toc"><a href="#lock-extensions">7.7&#XA0;&#XA0;Possible extensions</a>
</li></ul>
</li><li class="li-toc"><a href="#index-checker">Chapter&#XA0;8&#XA0;&#XA0;Index Checker for sequence bounds (arrays and strings)</a>
<ul class="toc"><li class="li-toc">
<a href="#index-annotations">8.1&#XA0;&#XA0;Index Checker structure and annotations</a>
</li><li class="li-toc"><a href="#index-lowerbound">8.2&#XA0;&#XA0;Lower bounds</a>
</li><li class="li-toc"><a href="#index-upperbound">8.3&#XA0;&#XA0;Upper bounds</a>
</li><li class="li-toc"><a href="#index-minlen">8.4&#XA0;&#XA0;Sequence minimum lengths</a>
</li><li class="li-toc"><a href="#index-samelen">8.5&#XA0;&#XA0;Sequences of the same length</a>
</li><li class="li-toc"><a href="#index-searchindex">8.6&#XA0;&#XA0;Binary search indices</a>
</li><li class="li-toc"><a href="#index-substringindex">8.7&#XA0;&#XA0;Substring indices</a>
</li><li class="li-toc"><a href="#index-inequalities">8.8&#XA0;&#XA0;Inequalities</a>
</li><li class="li-toc"><a href="#index-annotating-fixed-size">8.9&#XA0;&#XA0;Annotating fixed-size data structures</a>
</li></ul>
</li><li class="li-toc"><a href="#fenum-checker">Chapter&#XA0;9&#XA0;&#XA0;Fake Enum Checker for fake enumerations</a>
<ul class="toc"><li class="li-toc">
<a href="#fenum-annotations">9.1&#XA0;&#XA0;Fake enum annotations</a>
</li><li class="li-toc"><a href="#fenum-checks">9.2&#XA0;&#XA0;What the Fenum Checker checks</a>
</li><li class="li-toc"><a href="#fenum-running">9.3&#XA0;&#XA0;Running the Fenum Checker</a>
</li><li class="li-toc"><a href="#fenum-suppressing">9.4&#XA0;&#XA0;Suppressing warnings</a>
</li><li class="li-toc"><a href="#fenum-example">9.5&#XA0;&#XA0;Example</a>
</li><li class="li-toc"><a href="#fenum-pattern">9.6&#XA0;&#XA0;The fake enumeration pattern</a>
</li><li class="li-toc"><a href="#fenum-references">9.7&#XA0;&#XA0;References</a>
</li></ul>
</li><li class="li-toc"><a href="#tainting-checker">Chapter&#XA0;10&#XA0;&#XA0;Tainting Checker</a>
<ul class="toc"><li class="li-toc">
<a href="#tainting-annotations">10.1&#XA0;&#XA0;Tainting annotations</a>
</li><li class="li-toc"><a href="#writing-untainted">10.2&#XA0;&#XA0;Tips on writing <span style="font-family:monospace">@Untainted</span> annotations</a>
</li><li class="li-toc"><a href="#tainting-many-uses">10.3&#XA0;&#XA0;<span style="font-family:monospace">@Tainted</span> and <span style="font-family:monospace">@Untainted</span> can be used for many purposes</a>
</li><li class="li-toc"><a href="#tainting-polymorphism-caution">10.4&#XA0;&#XA0;A caution about polymorphism and side effects</a>
</li></ul>
</li><li class="li-toc"><a href="#regex-checker">Chapter&#XA0;11&#XA0;&#XA0;Regex Checker for regular expression syntax</a>
<ul class="toc"><li class="li-toc">
<a href="#regex-annotations">11.1&#XA0;&#XA0;Regex annotations</a>
</li><li class="li-toc"><a href="#annotating-with-regex">11.2&#XA0;&#XA0;Annotating your code with <span style="font-family:monospace">@Regex</span></a>
</li></ul>
</li><li class="li-toc"><a href="#formatter-checker">Chapter&#XA0;12&#XA0;&#XA0;Format String Checker</a>
<ul class="toc"><li class="li-toc">
<a href="#formatter-terminology">12.1&#XA0;&#XA0;Formatting terminology</a>
</li><li class="li-toc"><a href="#formatter-annotations">12.2&#XA0;&#XA0;Format String Checker annotations</a>
</li><li class="li-toc"><a href="#formatter-guarantees">12.3&#XA0;&#XA0;What the Format String Checker checks</a>
</li><li class="li-toc"><a href="#formatter-implicit">12.4&#XA0;&#XA0;Implicit qualifiers</a>
</li><li class="li-toc"><a href="#formatter-FormatMethod">12.5&#XA0;&#XA0;@FormatMethod</a>
</li><li class="li-toc"><a href="#formatter-run-time-tests">12.6&#XA0;&#XA0;Testing whether a format string is valid</a>
</li></ul>
</li><li class="li-toc"><a href="#i18n-formatter-checker">Chapter&#XA0;13&#XA0;&#XA0;Internationalization Format String Checker (I18n Format String Checker)</a>
<ul class="toc"><li class="li-toc">
<a href="#i18n-format-annotation">13.1&#XA0;&#XA0;Internationalization Format String Checker annotations</a>
</li><li class="li-toc"><a href="#i18n-format-conversion-catgeories">13.2&#XA0;&#XA0;Conversion categories</a>
</li><li class="li-toc"><a href="#i18n-formatter-format-subtyping">13.3&#XA0;&#XA0;Subtyping rules for <span style="font-family:monospace">@I18nFormat</span></a>
</li><li class="li-toc"><a href="#i18n-format-checks">13.4&#XA0;&#XA0;What the Internationalization Format String Checker checks</a>
</li><li class="li-toc"><a href="#i18n-format-resource-files">13.5&#XA0;&#XA0;Resource files</a>
</li><li class="li-toc"><a href="#i18n-format-running">13.6&#XA0;&#XA0;Running the Internationalization Format Checker</a>
</li><li class="li-toc"><a href="#i18n-format-testing">13.7&#XA0;&#XA0;Testing whether a string has an i18n format type</a>
</li><li class="li-toc"><a href="#i18n-format-examples">13.8&#XA0;&#XA0;Examples of using the Internationalization Format Checker</a>
</li></ul>
</li><li class="li-toc"><a href="#propkey-checker">Chapter&#XA0;14&#XA0;&#XA0;Property File Checker</a>
<ul class="toc"><li class="li-toc">
<a href="#genpropkey-checker">14.1&#XA0;&#XA0;General Property File Checker</a>
</li><li class="li-toc"><a href="#i18n-checker">14.2&#XA0;&#XA0;Internationalization Checker (I18n Checker)</a>
</li><li class="li-toc"><a href="#compilermsgs-checker">14.3&#XA0;&#XA0;Compiler Message Key Checker</a>
</li></ul>
</li><li class="li-toc"><a href="#signature-checker">Chapter&#XA0;15&#XA0;&#XA0;Signature String Checker for string representations of types</a>
<ul class="toc"><li class="li-toc">
<a href="#signature-annotations">15.1&#XA0;&#XA0;Signature annotations</a>
</li><li class="li-toc"><a href="#signature-checks">15.2&#XA0;&#XA0;What the Signature Checker checks</a>
</li></ul>
</li><li class="li-toc"><a href="#guieffect-checker">Chapter&#XA0;16&#XA0;&#XA0;GUI Effect Checker</a>
<ul class="toc"><li class="li-toc">
<a href="#guieffect-annotations">16.1&#XA0;&#XA0;GUI effect annotations</a>
</li><li class="li-toc"><a href="#guieffect-checks">16.2&#XA0;&#XA0;What the GUI Effect Checker checks</a>
</li><li class="li-toc"><a href="#guieffect-running">16.3&#XA0;&#XA0;Running the GUI Effect Checker</a>
</li><li class="li-toc"><a href="#guieffect-defaults">16.4&#XA0;&#XA0;Annotation defaults</a>
</li><li class="li-toc"><a href="#guieffect-polymorphism">16.5&#XA0;&#XA0;Polymorphic effects</a>
</li><li class="li-toc"><a href="#guieffect-references">16.6&#XA0;&#XA0;References</a>
</li></ul>
</li><li class="li-toc"><a href="#units-checker">Chapter&#XA0;17&#XA0;&#XA0;Units Checker</a>
<ul class="toc"><li class="li-toc">
<a href="#units-annotations">17.1&#XA0;&#XA0;Units annotations</a>
</li><li class="li-toc"><a href="#extending-units">17.2&#XA0;&#XA0;Extending the Units Checker</a>
</li><li class="li-toc"><a href="#units-checks">17.3&#XA0;&#XA0;What the Units Checker checks</a>
</li><li class="li-toc"><a href="#units-running">17.4&#XA0;&#XA0;Running the Units Checker</a>
</li><li class="li-toc"><a href="#units-suppressing">17.5&#XA0;&#XA0;Suppressing warnings</a>
</li><li class="li-toc"><a href="#units-references">17.6&#XA0;&#XA0;References</a>
</li></ul>
</li><li class="li-toc"><a href="#signedness-checker">Chapter&#XA0;18&#XA0;&#XA0;Signedness Checker</a>
<ul class="toc"><li class="li-toc">
<a href="#signedness-checker-annotations">18.1&#XA0;&#XA0;Annotations</a>
</li><li class="li-toc"><a href="#signedness-checker-prohibited-operations">18.2&#XA0;&#XA0;Prohibited operations</a>
</li><li class="li-toc"><a href="#signedness-checker-rationale">18.3&#XA0;&#XA0;Rationale</a>
</li><li class="li-toc"><a href="#signedness-utilities">18.4&#XA0;&#XA0;Utility routines for manipulating unsigned values</a>
</li><li class="li-toc"><a href="#signedness-refinement">18.5&#XA0;&#XA0;Local type refinement</a>
</li></ul>
</li><li class="li-toc"><a href="#aliasing-checker">Chapter&#XA0;19&#XA0;&#XA0;Aliasing Checker</a>
<ul class="toc"><li class="li-toc">
<a href="#aliasing-annotations">19.1&#XA0;&#XA0;Aliasing annotations</a>
</li><li class="li-toc"><a href="#aliasing-leaking-contexts">19.2&#XA0;&#XA0;Leaking contexts</a>
</li><li class="li-toc"><a href="#aliasing-unique-restrictions">19.3&#XA0;&#XA0;Restrictions on where <span style="font-family:monospace">@Unique</span> may be written</a>
</li><li class="li-toc"><a href="#aliasing-refinement">19.4&#XA0;&#XA0;Aliasing type refinement</a>
</li></ul>
</li><li class="li-toc"><a href="#purity-checker">Chapter&#XA0;20&#XA0;&#XA0;Purity Checker</a>
<ul class="toc"><li class="li-toc">
<a href="#purity-annotations">20.1&#XA0;&#XA0;Purity annotations</a>
</li><li class="li-toc"><a href="#purity-trusted">20.2&#XA0;&#XA0;Purity annotations are trusted</a>
</li><li class="li-toc"><a href="#purity-override">20.3&#XA0;&#XA0;Overriding methods must respect specifications in superclasses</a>
</li><li class="li-toc"><a href="#purity-suppress-warnings">20.4&#XA0;&#XA0;Suppressing warnings</a>
</li></ul>
</li><li class="li-toc"><a href="#constant-value-checker">Chapter&#XA0;21&#XA0;&#XA0;Constant Value Checker</a>
<ul class="toc"><li class="li-toc">
<a href="#constant-value-checker-annotations">21.1&#XA0;&#XA0;Annotations</a>
</li><li class="li-toc"><a href="#other-constant-value-annotations">21.2&#XA0;&#XA0;Other constant value annotations</a>
</li><li class="li-toc"><a href="#value-checker-warnings">21.3&#XA0;&#XA0;Warnings</a>
</li><li class="li-toc"><a href="#value-checker-overflow">21.4&#XA0;&#XA0;Unsoundly ignoring overflow</a>
</li></ul>
</li><li class="li-toc"><a href="#reflection-resolution">Chapter&#XA0;22&#XA0;&#XA0;Reflection resolution</a>
<ul class="toc"><li class="li-toc">
<a href="#reflection-examples">22.1&#XA0;&#XA0;Reflection resolution example</a>
</li><li class="li-toc"><a href="#methodval-and-classval-checkers">22.2&#XA0;&#XA0;MethodVal and ClassVal Checkers</a>
</li></ul>
</li><li class="li-toc"><a href="#subtyping-checker">Chapter&#XA0;23&#XA0;&#XA0;Subtyping Checker</a>
<ul class="toc"><li class="li-toc">
<a href="#subtyping-using">23.1&#XA0;&#XA0;Using the Subtyping Checker</a>
</li><li class="li-toc"><a href="#encrypted-example">23.2&#XA0;&#XA0;Subtyping Checker example</a>
</li><li class="li-toc"><a href="#subtyping-type-alias">23.3&#XA0;&#XA0;Type aliases and typedefs</a>
</li></ul>
</li><li class="li-toc"><a href="#external-checkers">Chapter&#XA0;24&#XA0;&#XA0;Third-party checkers</a>
<ul class="toc"><li class="li-toc">
<a href="#typestate-checker">24.1&#XA0;&#XA0;Typestate checkers</a>
</li><li class="li-toc"><a href="#units-and-dimensions-checker">24.2&#XA0;&#XA0;Units and dimensions checker</a>
</li><li class="li-toc"><a href="#loci-thread-locality-checker">24.3&#XA0;&#XA0;Thread locality checker</a>
</li><li class="li-toc"><a href="#safety-critical-java-checker">24.4&#XA0;&#XA0;Safety-Critical Java checker</a>
</li><li class="li-toc"><a href="#gut-checker">24.5&#XA0;&#XA0;Generic Universe Types checker</a>
</li><li class="li-toc"><a href="#enerj-checker">24.6&#XA0;&#XA0;EnerJ checker</a>
</li><li class="li-toc"><a href="#checklt-checker">24.7&#XA0;&#XA0;CheckLT taint checker</a>
</li><li class="li-toc"><a href="#sparta-checker">24.8&#XA0;&#XA0;SPARTA information flow type-checker for Android</a>
</li><li class="li-toc"><a href="#javari-checker">24.9&#XA0;&#XA0;Immutability checkers: IGJ, OIGJ, and Javari</a>
</li><li class="li-toc"><a href="#initialization-rawness-checker">24.10&#XA0;&#XA0;Nullness Rawness Checker</a>
</li><li class="li-toc"><a href="#read-checker">24.11&#XA0;&#XA0;Read Checker for CERT FIO08-J</a>
</li><li class="li-toc"><a href="#sql-schecker">24.12&#XA0;&#XA0;SQL checker that supports multiple dialects</a>
</li><li class="li-toc"><a href="#glacier-immutability-checker">24.13&#XA0;&#XA0;Glacier: Class immutability</a>
</li><li class="li-toc"><a href="#rx-thread-checker">24.14&#XA0;&#XA0;UI Thread Checker for ReactiveX</a>
</li><li class="li-toc"><a href="#kms-compliance-checker">24.15&#XA0;&#XA0;AWS KMS compliance checker</a>
</li><li class="li-toc"><a href="#crypto-policy-compliance-checker">24.16&#XA0;&#XA0;AWS crypto policy compliance checker</a>
</li></ul>
</li><li class="li-toc"><a href="#polymorphism">Chapter&#XA0;25&#XA0;&#XA0;Generics and polymorphism</a>
<ul class="toc"><li class="li-toc">
<a href="#generics">25.1&#XA0;&#XA0;Generics (parametric polymorphism or type polymorphism)</a>
</li><li class="li-toc"><a href="#qualifier-polymorphism">25.2&#XA0;&#XA0;Qualifier polymorphism</a>
</li></ul>
</li><li class="li-toc"><a href="#advanced-type-system-features">Chapter&#XA0;26&#XA0;&#XA0;Advanced type system features</a>
<ul class="toc"><li class="li-toc">
<a href="#invariant-arrays">26.1&#XA0;&#XA0;Invariant array types</a>
</li><li class="li-toc"><a href="#array-context-sensitive">26.2&#XA0;&#XA0;Context-sensitive type inference for array constructors</a>
</li><li class="li-toc"><a href="#upper-bound-for-use">26.3&#XA0;&#XA0;Upper bound of qualifiers on uses of a given type</a>
</li><li class="li-toc"><a href="#effective-qualifier">26.4&#XA0;&#XA0;The effective qualifier on a type (defaults and inference)</a>
</li><li class="li-toc"><a href="#defaults">26.5&#XA0;&#XA0;Default qualifier for unannotated types</a>
</li><li class="li-toc"><a href="#annotations-on-constructors">26.6&#XA0;&#XA0;Annotations on constructors</a>
</li><li class="li-toc"><a href="#type-refinement">26.7&#XA0;&#XA0;Type refinement (flow-sensitive type qualifier inference)</a>
</li><li class="li-toc"><a href="#java-expressions-as-arguments">26.8&#XA0;&#XA0;Writing Java expressions as annotation arguments</a>
</li><li class="li-toc"><a href="#field-invariants">26.9&#XA0;&#XA0;Field invariants</a>
</li><li class="li-toc"><a href="#unused-fields">26.10&#XA0;&#XA0;Unused fields</a>
</li></ul>
</li><li class="li-toc"><a href="#suppressing-warnings">Chapter&#XA0;27&#XA0;&#XA0;Suppressing warnings</a>
<ul class="toc"><li class="li-toc">
<a href="#suppresswarnings-annotation">27.1&#XA0;&#XA0;<span style="font-family:monospace">@SuppressWarnings</span> annotation</a>
</li><li class="li-toc"><a href="#assumeassertion">27.2&#XA0;&#XA0;<span style="font-family:monospace">@AssumeAssertion</span> string in an <span style="font-family:monospace">assert</span> message</a>
</li><li class="li-toc"><a href="#suppresswarnings-command-line">27.3&#XA0;&#XA0;<span style="font-family:monospace">-AsuppressWarnings</span> command-line option</a>
</li><li class="li-toc"><a href="#askipuses">27.4&#XA0;&#XA0;<span style="font-family:monospace">-AskipUses</span> and <span style="font-family:monospace">-AonlyUses</span> command-line options</a>
</li><li class="li-toc"><a href="#askipdefs">27.5&#XA0;&#XA0;<span style="font-family:monospace">-AskipDefs</span> and <span style="font-family:monospace">-AonlyDefs</span> command-line options</a>
</li><li class="li-toc"><a href="#lint-options">27.6&#XA0;&#XA0;<span style="font-family:monospace">-Alint</span> command-line option</a>
</li><li class="li-toc"><a href="#no-processor">27.7&#XA0;&#XA0;Don&#X2019;t run the processor</a>
</li><li class="li-toc"><a href="#checker-specific-suppression">27.8&#XA0;&#XA0;Checker-specific mechanisms</a>
</li></ul>
</li><li class="li-toc"><a href="#legacy-code">Chapter&#XA0;28&#XA0;&#XA0;Handling legacy code</a>
<ul class="toc"><li class="li-toc">
<a href="#unannotated-code">28.1&#XA0;&#XA0;Checking partially-annotated programs: handling unannotated code</a>
</li></ul>
</li><li class="li-toc"><a href="#type-inference">Chapter&#XA0;29&#XA0;&#XA0;Type inference</a>
<ul class="toc"><li class="li-toc">
<a href="#type-inference-refinement">29.1&#XA0;&#XA0;Local type inference during type-checking</a>
</li><li class="li-toc"><a href="#type-inference-to-annotate">29.2&#XA0;&#XA0;Type inference to annotate a program</a>
</li><li class="li-toc"><a href="#whole-program-inference">29.3&#XA0;&#XA0;Whole-program inference</a>
</li></ul>
</li><li class="li-toc"><a href="#annotating-libraries">Chapter&#XA0;30&#XA0;&#XA0;Annotating libraries</a>
<ul class="toc"><li class="li-toc">
<a href="#library-tips">30.1&#XA0;&#XA0;Tips for annotating a library</a>
</li><li class="li-toc"><a href="#annotating-libraries-create">30.2&#XA0;&#XA0;Creating an annotated library</a>
</li><li class="li-toc"><a href="#annotating-jdk">30.3&#XA0;&#XA0;Creating an annotated JDK</a>
</li><li class="li-toc"><a href="#compiling-libraries">30.4&#XA0;&#XA0;Compiling partially-annotated libraries</a>
</li><li class="li-toc"><a href="#stub">30.5&#XA0;&#XA0;Using stub classes</a>
</li><li class="li-toc"><a href="#libraries-troubleshooting">30.6&#XA0;&#XA0;Troubleshooting/debugging annotated libraries</a>
</li></ul>
</li><li class="li-toc"><a href="#creating-a-checker">Chapter&#XA0;31&#XA0;&#XA0;How to create a new checker</a>
<ul class="toc"><li class="li-toc">
<a href="#creating-tool-relationships">31.1&#XA0;&#XA0;How checkers build on the Checker Framework</a>
</li><li class="li-toc"><a href="#creating-parts-of-a-checker">31.2&#XA0;&#XA0;The parts of a checker</a>
</li><li class="li-toc"><a href="#creating-compiling">31.3&#XA0;&#XA0;Compiling and using a custom checker</a>
</li><li class="li-toc"><a href="#creating-typequals">31.4&#XA0;&#XA0;Annotations: Type qualifiers and hierarchy</a>
</li><li class="li-toc"><a href="#creating-compiler-interface">31.5&#XA0;&#XA0;The checker class: Compiler interface</a>
</li><li class="li-toc"><a href="#creating-extending-visitor">31.6&#XA0;&#XA0;Visitor: Type rules</a>
</li><li class="li-toc"><a href="#creating-type-introduction">31.7&#XA0;&#XA0;Type factory: Type introduction rules</a>
</li><li class="li-toc"><a href="#creating-dataflow">31.8&#XA0;&#XA0;Dataflow: enhancing flow-sensitive type refinement</a>
</li><li class="li-toc"><a href="#creating-a-checker-annotated-jdk">31.9&#XA0;&#XA0;Annotated JDK</a>
</li><li class="li-toc"><a href="#creating-testing-framework">31.10&#XA0;&#XA0;Testing framework</a>
</li><li class="li-toc"><a href="#creating-debugging-options">31.11&#XA0;&#XA0;Debugging options</a>
</li><li class="li-toc"><a href="#creating-documenting-a-checker">31.12&#XA0;&#XA0;Documenting the checker</a>
</li><li class="li-toc"><a href="#creating-javac-tips">31.13&#XA0;&#XA0;javac implementation survival guide</a>
</li><li class="li-toc"><a href="#creating-integrating-a-checker">31.14&#XA0;&#XA0;Integrating a checker with the Checker Framework</a>
</li></ul>
</li><li class="li-toc"><a href="#external-tools">Chapter&#XA0;32&#XA0;&#XA0;Integration with external tools</a>
<ul class="toc"><li class="li-toc">
<a href="#android">32.1&#XA0;&#XA0;Android</a>
</li><li class="li-toc"><a href="#android-gradle">32.2&#XA0;&#XA0;Android Studio 3.0 and the Android Gradle Plugin 3.0</a>
</li><li class="li-toc"><a href="#ant-task">32.3&#XA0;&#XA0;Ant task</a>
</li><li class="li-toc"><a href="#buck">32.4&#XA0;&#XA0;Buck</a>
</li><li class="li-toc"><a href="#eclipse">32.5&#XA0;&#XA0;Eclipse</a>
</li><li class="li-toc"><a href="#gradle">32.6&#XA0;&#XA0;Gradle</a>
</li><li class="li-toc"><a href="#intellij">32.7&#XA0;&#XA0;IntelliJ IDEA</a>
</li><li class="li-toc"><a href="#javac-installation">32.8&#XA0;&#XA0;Javac compiler (command line)</a>
</li><li class="li-toc"><a href="#lombok">32.9&#XA0;&#XA0;Lombok</a>
</li><li class="li-toc"><a href="#maven">32.10&#XA0;&#XA0;Maven</a>
</li><li class="li-toc"><a href="#netbeans">32.11&#XA0;&#XA0;NetBeans</a>
</li><li class="li-toc"><a href="#tide">32.12&#XA0;&#XA0;tIDE</a>
</li><li class="li-toc"><a href="#type-inference-varieties">32.13&#XA0;&#XA0;Type inference tools</a>
</li></ul>
</li><li class="li-toc"><a href="#faq">Chapter&#XA0;33&#XA0;&#XA0;Frequently Asked Questions (FAQs)</a>
<ul class="toc"><li class="li-toc">
<a href="#faq-motivation-section">33.1&#XA0;&#XA0;Motivation for pluggable type-checking</a>
</li><li class="li-toc"><a href="#faq-getting-started-section">33.2&#XA0;&#XA0;Getting started</a>
</li><li class="li-toc"><a href="#faq-usability-section">33.3&#XA0;&#XA0;Usability of pluggable type-checking</a>
</li><li class="li-toc"><a href="#faq-warnings-section">33.4&#XA0;&#XA0;How to handle warnings and errors</a>
</li><li class="li-toc"><a href="#faq-false-positives-section">33.5&#XA0;&#XA0;False positive warnings</a>
</li><li class="li-toc"><a href="#faq-syntax-section">33.6&#XA0;&#XA0;Syntax of type annotations</a>
</li><li class="li-toc"><a href="#faq-semantics-section">33.7&#XA0;&#XA0;Semantics of type annotations</a>
</li><li class="li-toc"><a href="#faq-create-a-checker-section">33.8&#XA0;&#XA0;Creating a new checker</a>
</li><li class="li-toc"><a href="#faq-tool-section">33.9&#XA0;&#XA0;Tool questions</a>
</li><li class="li-toc"><a href="#faq-other-tools-section">33.10&#XA0;&#XA0;Relationship to other tools</a>
</li></ul>
</li><li class="li-toc"><a href="#troubleshooting">Chapter&#XA0;34&#XA0;&#XA0;Troubleshooting, getting help, and contributing</a>
<ul class="toc"><li class="li-toc">
<a href="#common-problems">34.1&#XA0;&#XA0;Common problems and solutions</a>
</li><li class="li-toc"><a href="#reporting-bugs">34.2&#XA0;&#XA0;How to report problems (bug reporting)</a>
</li><li class="li-toc"><a href="#build-source">34.3&#XA0;&#XA0;Building from source</a>
</li><li class="li-toc"><a href="#pull-request">34.4&#XA0;&#XA0;Contributing fixes (creating a pull request)</a>
</li><li class="li-toc"><a href="#publications">34.5&#XA0;&#XA0;Publications</a>
</li><li class="li-toc"><a href="#credits">34.6&#XA0;&#XA0;Credits and changelog</a>
</li><li class="li-toc"><a href="#license">34.7&#XA0;&#XA0;License</a>
</li></ul>
</li></ul><hr>
<!--TOC chapter id="introduction" Introduction-->
<h1 id="introduction" class="chapter">Chapter&#XA0;1&#XA0;&#XA0;Introduction <a href="#introduction" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h1><!--SEC END --><p>The Checker Framework enhances Java&#X2019;s type system to make it more powerful
and useful.
This lets software developers detect and
prevent errors in their Java programs.</p><p>A &#X201C;checker&#X201D; is a tool that warns you about certain errors or gives you a
guarantee that those errors do not occur.
The Checker Framework comes with checkers for specific types of errors:</p><ol class="enumerate" type=1><li class="li-enumerate"><a href="#nullness-checker">Nullness Checker</a> for null pointer errors
(see Chapter&#XA0;<a href="#nullness-checker">3</a>)
</li><li class="li-enumerate"><a href="#initialization-checker">Initialization Checker</a> to ensure all
fields are set in the constructor (see
Chapter&#XA0;<a href="#initialization-checker">3.8</a>)
</li><li class="li-enumerate"><a href="#map-key-checker">Map Key Checker</a> to track which values are
keys in a map (see Chapter&#XA0;<a href="#map-key-checker">4</a>)
</li><li class="li-enumerate"><a href="#optional-checker">Optional Checker</a> for errors in using the
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html"><span style="font-family:monospace">Optional</span></a> type (see
Chapter&#XA0;<a href="#optional-checker">5</a>)
</li><li class="li-enumerate"><a href="#interning-checker">Interning Checker</a> for errors in equality
testing and interning (see Chapter&#XA0;<a href="#interning-checker">6</a>)
</li><li class="li-enumerate"><a href="#lock-checker">Lock Checker</a> for concurrency and lock errors
(see Chapter&#XA0;<a href="#lock-checker">7</a>)
</li><li class="li-enumerate"><a href="#index-checker">Index Checker</a> for array accesses
(see Chapter&#XA0;<a href="#index-checker">8</a>)
</li><li class="li-enumerate"><a href="#fenum-checker">Fake Enum Checker</a> to allow type-safe fake enum
patterns and type aliases or typedefs (see Chapter&#XA0;<a href="#fenum-checker">9</a>)
</li><li class="li-enumerate"><a href="#tainting-checker">Tainting Checker</a> for trust and security errors
(see Chapter&#XA0;<a href="#tainting-checker">10</a>)
</li><li class="li-enumerate"><a href="#regex-checker">Regex Checker</a> to prevent use of syntactically
invalid regular expressions (see Chapter&#XA0;<a href="#regex-checker">11</a>)
</li><li class="li-enumerate"><a href="#formatter-checker">Format String Checker</a> to ensure that format
strings have the right number and type of <span style="font-family:monospace">%</span> directives (see
Chapter&#XA0;<a href="#formatter-checker">12</a>)
</li><li class="li-enumerate"><a href="#i18n-formatter-checker">Internationalization Format String Checker</a>
to ensure that i18n format strings have the right number and type of
<span style="font-family:monospace">{}</span> directives (see Chapter&#XA0;<a href="#i18n-formatter-checker">13</a>)
</li><li class="li-enumerate"><a href="#propkey-checker">Property File Checker</a> to ensure that valid
keys are used for property files and resource bundles (see
Chapter&#XA0;<a href="#propkey-checker">14</a>)
</li><li class="li-enumerate"><a href="#i18n-checker">Internationalization Checker</a> to
ensure that code is properly internationalized (see
Chapter&#XA0;<a href="#i18n-checker">14.2</a>)
</li><li class="li-enumerate"><a href="#signature-checker">Signature String Checker</a> to ensure that the
string representation of a type is properly used, for example in
<span style="font-family:monospace">Class.forName</span> (see Chapter&#XA0;<a href="#signature-checker">15</a>)
</li><li class="li-enumerate"><a href="#guieffect-checker">GUI Effect Checker</a> to ensure that non-GUI
threads do not access the UI, which would crash the application
(see Chapter&#XA0;<a href="#guieffect-checker">16</a>)
</li><li class="li-enumerate"><a href="#units-checker">Units Checker</a> to ensure operations are
performed on correct units of measurement
(see Chapter&#XA0;<a href="#units-checker">17</a>)
</li><li class="li-enumerate"><a href="#signedness-checker">Signedness Checker</a> to
ensure unsigned and signed values are not mixed
(see Chapter&#XA0;<a href="#signedness-checker">18</a>)
</li><li class="li-enumerate"><a href="#aliasing-checker">Aliasing Checker</a> to identify whether
expressions have aliases (see Chapter&#XA0;<a href="#aliasing-checker">19</a>)
</li><li class="li-enumerate"><a href="#purity-checker">Purity Checker</a> to identify whether
methods have side effects (see Chapter&#XA0;<a href="#purity-checker">20</a>)
</li><li class="li-enumerate"><a href="#constant-value-checker">Constant Value Checker</a> to determine
whether an expression&#X2019;s value can be known at compile time
(see Chapter&#XA0;<a href="#constant-value-checker">21</a>)
</li><li class="li-enumerate"><a href="#reflection-resolution">Reflection Checker</a> to determine
whether an expression&#X2019;s value (of type <span style="font-family:monospace">Method</span> or <span style="font-family:monospace">Class</span>) can be known at compile time
(see Chapter&#XA0;<a href="#reflection-resolution">22</a>)
</li><li class="li-enumerate"><a href="#subtyping-checker">Subtyping Checker</a> for customized checking without
writing any code (see Chapter&#XA0;<a href="#subtyping-checker">23</a>)
</li><li class="li-enumerate"><a href="#third-party-checkers">Third-party checkers</a> that are distributed
separately from the Checker Framework
(see Chapter&#XA0;<a href="#third-party-checkers">24</a>)</li></ol><p>These checkers are easy to use and are invoked as arguments to <span style="font-family:monospace">javac</span>.</p><p>The Checker Framework also enables you to write new checkers of your
own; see Chapters&#XA0;<a href="#subtyping-checker">23</a> and&#XA0;<a href="#creating-a-checker">31</a>.</p>
<!--TOC section id="how-to-read-this-manual" How to read this manual-->
<h2 id="how-to-read-this-manual" class="section">1.1&#XA0;&#XA0;How to read this manual <a href="#how-to-read-this-manual" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>If you wish to get started using some particular type system from the list
above, then the most effective way to read this manual is:</p><ul class="itemize"><li class="li-itemize">
Read all of the introductory material
(Chapters&#XA0;<a href="#introduction">1</a>&#X2013;<a href="#using-a-checker">2</a>).
</li><li class="li-itemize">Read just one of the descriptions of a particular type system and its
checker (Chapters&#XA0;<a href="#nullness-checker">3</a>&#X2013;<a href="#third-party-checkers">24</a>).
</li><li class="li-itemize">Skim the advanced material that will enable you to make more effective
use of a type system
(Chapters&#XA0;<a href="#polymorphism">25</a>&#X2013;<a href="#troubleshooting">34</a>), so that you will
know what is available and can find it later. Skip
Chapter&#XA0;<a href="#creating-a-checker">31</a> on creating a new checker.
</li></ul>
<!--TOC section id="pluggable-types" How it works: Pluggable types-->
<h2 id="pluggable-types" class="section">1.2&#XA0;&#XA0;How it works: Pluggable types <a href="#pluggable-types" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The Checker Framework supports adding
pluggable type systems to the Java language in a backward-compatible way.
Java&#X2019;s built-in type-checker finds and prevents many errors &#X2014; but it
doesn&#X2019;t find and prevent <em>enough</em> errors. The Checker Framework lets you
run an additional type-checker as a plug-in to the javac compiler. Your
code stays completely backward-compatible: your code compiles with any
Java compiler, it runs on any JVM, and your coworkers don&#X2019;t have to use the
enhanced type system if they don&#X2019;t want to. You can check only part of
your program. Type inference tools exist to help you annotate your
code; see Chapter&#XA0;<a href="#type-inference-to-annotate">29.2</a>.</p><p>A type system designer uses the Checker Framework to define type qualifiers
and their semantics, and a
compiler plug-in (a &#X201C;checker&#X201D;) enforces the semantics. Programmers can
write the type qualifiers in their programs and use the plug-in to detect
or prevent errors. The Checker Framework is useful both to programmers who
wish to write error-free code, and to type system designers who wish to
evaluate and deploy their type systems.</p><p>This document uses the terms &#X201C;checker&#X201D;, &#X201C;checker plugin&#X201D;,
&#X201C;type-checking compiler plugin&#X201D;, and &#X201C;annotation processor&#X201D; as
synonyms.</p>
<!--TOC section id="installation" Installation-->
<h2 id="installation" class="section">1.3&#XA0;&#XA0;Installation <a href="#installation" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>This section describes how to install the Checker Framework.
</p><ul class="itemize"><li class="li-itemize">
If you use a build system that automatically downloads dependencies,
such as Gradle or Maven, <span style="font-weight:bold">no installation is necessary</span>; just see
Chapter&#XA0;<a href="#external-tools">32</a>.
</li><li class="li-itemize">If you wish to try the Checker Framework without installing it, use the
<a href="http://eisop.uwaterloo.ca/live/">Checker Framework Live Demo</a> webpage.
</li><li class="li-itemize">This section describes how to install the Checker Framework from its
distribution. The Checker Framework release contains everything that you
need, both to run checkers and to write your own checkers.
</li><li class="li-itemize">Alternately, you can build the latest development version from source
(Section&#XA0;<a href="#build-source">34.3</a>).
</li></ul><p><span style="font-weight:bold">Requirement:</span>
You must have <span style="font-weight:bold">JDK 8</span>
installed. You can get the JDK from
<a href="https://www.oracle.com/technetwork/java/javase/downloads/index.html">Oracle</a>
or elsewhere.</p><p>The installation process is simple! It has two required steps and one
optional step.
</p><ol class="enumerate" type=1><li class="li-enumerate">
Download the Checker Framework distribution:
<a href="https://checkerframework.org/checker-framework-2.11.0.zip"><span style="font-family:monospace">https://checkerframework.org/checker-framework-2.11.0.zip</span></a></li><li class="li-enumerate">Unzip it to create a <span style="font-family:monospace">checker-framework</span> directory.</li><li class="li-enumerate"><a id="installation-configure-step"></a>Configure your IDE, build system, or command shell to include the Checker
Framework on the classpath. Choose the appropriate section of
Chapter&#XA0;<a href="#external-tools">32</a>.</li></ol><p>That&#X2019;s all there is to it! Now you are ready to start using the checkers.</p><p>We recommend that you work through the
<a href="https://checkerframework.org/tutorial/">Checker
Framework tutorial</a>, which walks you through how to use the Checker
Framework on
the command line (Nullness, Regex, and Tainting Checkers).
There is also a
<a href="https://github.com/glts/safer-spring-petclinic/wiki">Nullness Checker
tutorial</a> by David B&#XFC;rgin; the setup instructions are out of date, but
you can read through the steps.</p><p>Section&#XA0;<a href="#example-use">1.4</a> walks you through a simple example. More detailed
instructions for using a checker appear in Chapter&#XA0;<a href="#using-a-checker">2</a>.</p>
<!--TOC section id="example-use" Example use: detecting a null pointer bug-->
<h2 id="example-use" class="section">1.4&#XA0;&#XA0;Example use: detecting a null pointer bug <a href="#example-use" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>This section gives a very simple example of running the Checker Framework.
There is also a <a href="https://checkerframework.org/tutorial/">tutorial</a>
that gives more extensive instructions for using the Checker Framework
on the command line,
and a
<a href="https://github.com/glts/safer-spring-petclinic/wiki">Nullness Checker
tutorial</a> by David B&#XFC;rgin.</p><ol class="enumerate" type=1><li class="li-enumerate">
Let&#X2019;s consider this very simple Java class. The local variable <span style="font-family:monospace">ref</span>&#X2019;s type is
annotated as <a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a>, indicating that <span style="font-family:monospace">ref</span> must be a reference to a
non-null object. Save the file as <span style="font-family:monospace">GetStarted.java</span>.<pre class="verbatim">import org.checkerframework.checker.nullness.qual.*;

public class GetStarted {
    void sample() {
        @NonNull Object ref = new Object();
    }
}
</pre></li><li class="li-enumerate">Run the Nullness Checker on the class.
You can do that from the command line or from an IDE:<ol class="enumerate" type=a><li class="li-enumerate">
From the command line, run this command:<pre>
  <em>javac</em> -processor org.checkerframework.checker.nullness.NullnessChecker GetStarted.java
</pre><p>where <em><span style="font-family:monospace">javac</span></em> is set as in Section&#XA0;<a href="#javac-installation">32.8</a>.</p></li><li class="li-enumerate">To compile within your IDE, you must have customized it to use the
Checker Framework compiler and to pass the extra arguments (see
Chapter&#XA0;<a href="#external-tools">32</a>).
</li></ol><p>The compilation should complete without any errors.</p></li><li class="li-enumerate">Let&#X2019;s introduce an error now. Modify <span style="font-family:monospace">ref</span>&#X2019;s assignment to:
<pre>
  @NonNull Object ref = <span style="font-weight:bold">null</span>;
</pre></li><li class="li-enumerate">Run the Nullness Checker again, just as before. This run should emit
the following error:
<pre class="verbatim">GetStarted.java:5: incompatible types.
found   : @Nullable &lt;nulltype&gt;
required: @NonNull Object
        @NonNull Object ref = null;
                              ^
1 error
</pre></li></ol><p>The type qualifiers (e.g., <span style="font-family:monospace">@NonNull</span>) are permitted anywhere
that you can write a type, including generics and casts; see
Section&#XA0;<a href="#writing-annotations">2.1</a>. Here are some examples:</p><pre>
  <U>@Interned</U> String intern() <span style="font-family:monospace">{</span> ... <span style="font-family:monospace">}</span>             // return value
  int compareTo(<U>@NonNull</U> String other) <span style="font-family:monospace">{</span> ... <span style="font-family:monospace">}</span>  // parameter
  <U>@NonNull</U> List&lt;<U>@Interned</U> String&gt; messages;     // non-null list of interned Strings
</pre><hr>
<!--TOC chapter id="using-a-checker" Using a checker-->
<h1 id="using-a-checker" class="chapter">Chapter&#XA0;2&#XA0;&#XA0;Using a checker <a href="#using-a-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h1><!--SEC END --><p>A pluggable type-checker enables you to detect certain bugs in your code,
or to prove that they are not present. The verification happens at compile
time.</p><p>Finding bugs, or verifying their absence, with a checker plugin is a two-step process, whose steps are
described in Sections&#XA0;<a href="#writing-annotations">2.1</a> and&#XA0;<a href="#running">2.2</a>.</p><ol class="enumerate" type=1><li class="li-enumerate">The programmer writes annotations, such as <a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a> and
<a href="../api/org/checkerframework/checker/interning/qual/Interned.html"><span style="font-family:monospace">@Interned</span></a>, that specify additional information about Java types.
(Or, the programmer uses an inference tool to automatically insert
annotations in his code: see Section&#XA0;<a href="#nullness-inference">3.3.7</a>.)
It is possible to annotate only part of your code: see
Section&#XA0;<a href="#unannotated-code">28.1</a>.</li><li class="li-enumerate">The checker reports whether the program contains any erroneous code
&#X2014; that is, code that is inconsistent with the annotations.</li></ol><p>This chapter is structured as follows:
</p><ul class="itemize"><li class="li-itemize">
Section&#XA0;<a href="#writing-annotations">2.1</a>: How to write annotations
</li><li class="li-itemize">Section&#XA0;<a href="#running">2.2</a>: How to run a checker
</li><li class="li-itemize">Section&#XA0;<a href="#checker-guarantees">2.3</a>: What the checker guarantees
</li><li class="li-itemize">Section&#XA0;<a href="#tips-about-writing-annotations">2.4</a>: Tips about writing annotations
</li></ul><p>Additional topics that apply to all checkers are covered later in the manual:
</p><ul class="itemize"><li class="li-itemize">
Chapter&#XA0;<a href="#advanced-type-system-features">26</a>: Advanced type system features
</li><li class="li-itemize">Chapter&#XA0;<a href="#suppressing-warnings">27</a>: Suppressing warnings
</li><li class="li-itemize">Chapter&#XA0;<a href="#legacy-code">28</a>: Handling legacy code
</li><li class="li-itemize">Chapter&#XA0;<a href="#annotating-libraries">30</a>: Annotating libraries
</li><li class="li-itemize">Chapter&#XA0;<a href="#creating-a-checker">31</a>: How to create a new checker
</li><li class="li-itemize">Chapter&#XA0;<a href="#external-tools">32</a>: Integration with external tools
</li></ul><p>Finally, there is a
<a href="https://checkerframework.org/tutorial/">tutorial</a>
that walks you through using the Checker Framework on the
command line, and a separate
<a href="https://github.com/glts/safer-spring-petclinic/wiki">Nullness
Checker tutorial</a> by David B&#XFC;rgin.</p>
<!--TOC section id="writing-annotations" Writing annotations-->
<h2 id="writing-annotations" class="section">2.1&#XA0;&#XA0;Writing annotations <a href="#writing-annotations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The syntax of type annotations in Java is specified by
the Java Language Specification (Java SE 8 edition).
</p><p>Java 5 defines declaration annotations such as <span style="font-family:monospace">@Deprecated</span>, which apply
to a class, method, or field, but do not apply to the method&#X2019;s return type
or the field&#X2019;s type. They are typically written on their own line in the
source code.</p><p>Java 8 defines type annotations, which you write immediately before any
use of a type, including in generics and casts. Because array levels are
types and receivers have types, you can also write type annotations on
them. Here are a few examples of type annotations:</p><pre>
  <U>@Interned</U> String intern() <span style="font-family:monospace">{</span> ... <span style="font-family:monospace">}</span>               // return value
  int compareTo(<U>@NonNull</U> String other) <span style="font-family:monospace">{</span> ... <span style="font-family:monospace">}</span>    // parameter
  String toString(<U>@Tainted</U> MyClass this) <span style="font-family:monospace">{</span> ... <span style="font-family:monospace">}</span>  // receiver ("this" parameter)
  <U>@NonNull</U> List&lt;<U>@Interned</U> String&gt; messages;       // generics:  non-null list of interned Strings
  <U>@Interned</U> String <U>@NonNull</U> [] messages;          // arrays:  non-null array of interned Strings
  myDate = (<U>@Initialized</U> Date) beingConstructed;  // cast
</pre><p>You only need to write annotations on method signatures, fields, and some type arguments.
Most annotations within method bodies are inferred for you; for more details,
see Section&#XA0;<a href="#type-refinement">26.7</a>.</p>
<!--TOC section id="running" Running a checker-->
<h2 id="running" class="section">2.2&#XA0;&#XA0;Running a checker <a href="#running" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>To run a checker plugin, run the compiler <span style="font-family:monospace">javac</span> as usual,
but pass the <span style="font-family:monospace">-processor </span><span style="font-family:monospace"><em>plugin_class</em></span> command-line
option.
A concrete example (using the Nullness Checker) is:</p><pre class="verbatim">  javac -processor nullness MyFile.java
</pre><p>where <span style="font-family:monospace">javac</span> is as specified in Section&#XA0;<a href="#javac-installation">32.8</a>.</p><p>You can also run a checker from within your favorite IDE or build system. See
Chapter&#XA0;<a href="#external-tools">32</a> for details about build tools such as
Ant (Section&#XA0;<a href="#ant-task">32.3</a>),
Buck (Section&#XA0;<a href="#buck">32.4</a>),
Gradle (Section&#XA0;<a href="#gradle">32.6</a>), and
Maven (Section&#XA0;<a href="#maven">32.10</a>);
IDEs such as
IntelliJ IDEA (Section&#XA0;<a href="#intellij">32.7</a>),
Eclipse (Section&#XA0;<a href="#eclipse">32.5</a>),
NetBeans (Section&#XA0;<a href="#netbeans">32.11</a>),
and
tIDE (Section&#XA0;<a href="#tide">32.12</a>);
and about customizing other IDEs and build tools.</p><p>The checker is run on only the Java files that javac compiles.
This includes all Java files specified on the command line (or
created by another annotation processor). It may also include other of
your Java files (but not if a more recent <span style="font-family:monospace">.class</span> file exists).
Even when the checker does not analyze a class (say, the class was
already compiled, or source code is not available), it does check
the <em>uses</em> of those classes in the source code being compiled.</p><p>You can always compile the code without the <span style="font-family:monospace">-processor</span>
command-line option, but in that case no checking of the type
annotations is performed. Furthermore, only explicitly-written annotations
are written to the <span style="font-family:monospace">.class</span> file; defaulted annotations are not, and this
will interfere with type-checking of clients that use your code.
Therefore, it is strongly recommended that whenever you are creating
<span style="font-family:monospace">.class</span> files that will be distributed or compiled against, you run the
type-checkers for all the annotations that your have written.</p>
<!--TOC subsection id="annotated-libraries-using" Using annotated libraries-->
<h3 id="annotated-libraries-using" class="subsection">2.2.1&#XA0;&#XA0;Using annotated libraries <a href="#annotated-libraries-using" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>When your code uses a library that is not currently being compiled, the
Checker Framework looks up the library&#X2019;s annotations in its class files.</p><p>Some projects are already distributed with type annotations by their
maintainers, so you do not need to do anything special.
Over time, this should become more common.</p><p>For some other libraries, the Checker Framework developers have provided an
annotated version of the library.
The annotated libraries appear in
<a href="https://search.maven.org/search?q=org.checkerframework.annotatedlib">the
<span style="font-family:monospace">org.checkerframework.annotatedlib</span> group in the Central Repository</a>.
The annotated library has <em>identical</em> behavior to the upstream,
unannotated version; the source code is identical other than the
annotations are different, so the only difference is with respect to
pluggable type-checking of clients.</p><p>(Some of the annotated libraries are
bcel,
commons-csv,
commons-io,
guava,
and
java-getopt.
If the library you are interested in does not appear
<a href="https://search.maven.org/search?q=org.checkerframework.annotatedlib">in
the Central Repository</a>, you can contribute by annotating it, which will
help you and all other Checker Framework users; see
Chapter&#XA0;<a href="#annotating-libraries">30</a>.)</p><p>To use an annotated library:</p><ul class="itemize"><li class="li-itemize">
If your project stores <span style="font-family:monospace">.jar</span> files locally, then
<a href="https://search.maven.org/search?q=org.checkerframework.annotatedlib">download
the <span style="font-family:monospace">.jar</span> file from the Central Repository</a>.</li><li class="li-itemize">If your project manages dependencies using a tool such as Gradle or Maven,
then update your buildfile to use the <span style="font-family:monospace">org.checkerframework.annotatedlib</span>
group. For example, in <span style="font-family:monospace">build.gradle</span>, change<pre class="verbatim">  api group: 'org.apache.bcel', name: 'bcel', version: '6.3.1'
  api group: 'commons-io', name: 'commans-io', version: '2.6'
</pre><p>to</p><pre class="verbatim">  api group: 'org.checkerframework.annotatedlib', name: 'bcel', version: '6.3.1'
  api group: 'org.checkerframework.annotatedlib', name: 'commons-io', version: '2.6.0.1'
</pre><p>Use the same version number. (Sometimes you will use a slightly larger
number, if the Checker Framework developers have improved the type
annotations since the last release by the upstream maintainers.) If a
newer version of the upstream library is available but that version is not
available in <span style="font-family:monospace">org.checkerframework.annotatedlib</span>, then
<a href="#reporting-bugs">open an issue</a> requesting that the
<span style="font-family:monospace">org.checkerframework.annotatedlib</span> version be updated.
</p></li></ul><p>There are two special cases.
</p><ul class="itemize"><li class="li-itemize">
The annotated JDK is automatically put on your
classpath; you don&#X2019;t have to do anything special for it.
</li><li class="li-itemize">For the Javadoc classes in the JDK&#X2019;s <span style="font-family:monospace">com.sun.javadoc</span> package,
use the stub file <span style="font-family:monospace">checker/resources/javadoc.astub</span> by using <span style="font-family:monospace">-Astubs=checker.jar/javadoc.astub</span>.
</li></ul>
<!--TOC subsection id="distributing" Distributing your annotated project-->
<h3 id="distributing" class="subsection">2.2.2&#XA0;&#XA0;Distributing your annotated project <a href="#distributing" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The distributed
<span style="font-family:monospace">.jar</span> files can be used for pluggable type-checking of client code.
The <span style="font-family:monospace">.jar</span> files are only compatible with a Java 8
JVM.
Developers perform pluggable type-checking in-house to detect errors and
verify their absence.
When you create <span style="font-family:monospace">.class</span> files, run each relevant type system.
Create the distributed <span style="font-family:monospace">.jar</span> files from those <span style="font-family:monospace">.class</span> files.</p>
<!--TOC subsection id="checker-options" Summary of command-line options-->
<h3 id="checker-options" class="subsection">2.2.3&#XA0;&#XA0;Summary of command-line options <a href="#checker-options" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>You can pass command-line arguments to a checker via javac&#X2019;s standard <span style="font-family:monospace">-A</span>
option (&#X201C;<span style="font-family:monospace">A</span>&#X201D; stands for &#X201C;annotation&#X201D;). All of the distributed
checkers support the following command-line options.</p><p>Unsound checking: ignore some errors
</p><ul class="itemize"><li class="li-itemize">
<span style="font-family:monospace">-AsuppressWarnings</span>
Suppress all errors and warnings matching the given key; see
Section&#XA0;<a href="#suppresswarnings-command-line">27.3</a>.
</li><li class="li-itemize"><span style="font-family:monospace">-AskipUses</span>, <span style="font-family:monospace">-AonlyUses</span>
Suppress all errors and warnings at all uses of a given class &#X2014; or at all
uses except those of a given class. See Section&#XA0;<a href="#askipuses">27.4</a>.
</li><li class="li-itemize"><span style="font-family:monospace">-AskipDefs</span>, <span style="font-family:monospace">-AonlyDefs</span>
Suppress all errors and warnings within the definition of a given class
&#X2014; or everywhere except within the definition of a given class. See
Section&#XA0;<a href="#askipdefs">27.5</a>.
</li><li class="li-itemize"><span style="font-family:monospace">-AignoreRawTypeArguments</span>
Ignore subtype tests for type arguments that were inferred for a raw
type. If possible, it is better to write the type arguments. See
Section&#XA0;<a href="#generics-raw-types">25.1.1</a>.
</li><li class="li-itemize"><span style="font-family:monospace">-AassumeSideEffectFree</span>
Unsoundly assume that every method is side-effect-free; see
Section&#XA0;<a href="#type-refinement-purity">26.7.5</a>.
</li><li class="li-itemize"><span style="font-family:monospace">-AassumeAssertionsAreEnabled</span>, <span style="font-family:monospace">-AassumeAssertionsAreDisabled</span>
Whether to assume that assertions are enabled or disabled; see Section&#XA0;<a href="#type-refinement-assertions">26.7.6</a>.
</li><li class="li-itemize"><span style="font-family:monospace">-AignoreRangeOverflow</span>
Ignore the possibility of overflow for range annotations such as
<span style="font-family:monospace">@IntRange</span>; see Section&#XA0;<a href="#value-checker-overflow">21.4</a>.
</li><li class="li-itemize"><span style="font-family:monospace">-Awarns</span>
Treat checker errors as warnings. If you use this, you may wish to also
supply <span style="font-family:monospace">-Xmaxwarns 10000</span>, because by default <span style="font-family:monospace">javac</span> prints at
most 100 warnings. If you use this, don&#X2019;t supply <span style="font-family:monospace">-Werror</span>,
which is a javac argument to halt compilation if a warning is issued.
</li></ul><p><a id="unsound-by-default"></a>
More sound (strict) checking: enable errors that are disabled by default
</p><ul class="itemize"><li class="li-itemize">
<span style="font-family:monospace">-AcheckPurityAnnotations</span>
Check the bodies of methods marked
<a href="../api/org/checkerframework/dataflow/qual/SideEffectFree.html"><span style="font-family:monospace">@SideEffectFree</span></a>,
<a href="../api/org/checkerframework/dataflow/qual/Deterministic.html"><span style="font-family:monospace">@Deterministic</span></a>,
and <a href="../api/org/checkerframework/dataflow/qual/Pure.html"><span style="font-family:monospace">@Pure</span></a>
to ensure the method satisfies the annotation. By default,
the Checker Framework unsoundly trusts the method annotation. See
Section&#XA0;<a href="#type-refinement-purity">26.7.5</a>.
</li><li class="li-itemize"><span style="font-family:monospace">-AinvariantArrays</span>
Make array subtyping invariant; that is, two arrays are subtypes of one
another only if they have exactly the same element type. By default,
the Checker Framework unsoundly permits covariant array subtyping, just
as Java does. See Section&#XA0;<a href="#invariant-arrays">26.1</a>.
</li><li class="li-itemize"><span style="font-family:monospace">-AcheckCastElementType</span>
In a cast, require that parameterized type arguments and array elements
are the same. By default, the Checker Framework unsoundly permits them
to differ, just as Java does. See Section&#XA0;<a href="#covariant-type-parameters">25.1.6</a>
and Section&#XA0;<a href="#invariant-arrays">26.1</a>.
</li><li class="li-itemize"><span style="font-family:monospace">-AuseDefaultsForUncheckedCode</span>
Enables/disables unchecked code defaults. Takes arguments &#X201C;source,bytecode&#X201D;.
&#X201C;-source,-bytecode&#X201D; is the (unsound) default setting.
&#X201C;bytecode&#X201D; specifies
whether the checker should apply unchecked code defaults to
bytecode; see
Section&#XA0;<a href="#defaults-classfile">26.5.6</a>.
Outside the scope of any relevant
<a href="../api/org/checkerframework/framework/qual/AnnotatedFor.html"><span style="font-family:monospace">@AnnotatedFor</span></a> annotation, &#X201C;source&#X201D; specifies whether unchecked code
default annotations are applied to source code and suppress all type-checking warnings; see
Section&#XA0;<a href="#compiling-libraries">30.4</a>.
</li><li class="li-itemize"><span style="font-family:monospace">-AconcurrentSemantics</span>
Whether to assume concurrent semantics (field values may change at any
time) or sequential semantics; see Section&#XA0;<a href="#faq-concurrency">33.4.4</a>.
</li><li class="li-itemize"><span style="font-family:monospace">-AconservativeUninferredTypeArguments</span>
Whether an error should be issued if type arguments could not be inferred and
whether method type arguments that could not be inferred should use
conservative defaults.
By default, such type arguments are (largely) ignored in later
checks.
Passing this option uses a conservative value instead.
See <a href="https://github.com/typetools/checker-framework/issues/979">Issue
979</a>.
</li></ul><p>Type-checking modes: enable/disable functionality
</p><ul class="itemize"><li class="li-itemize">
<span style="font-family:monospace">-Alint</span>
Enable or disable optional checks; see Section&#XA0;<a href="#lint-options">27.6</a>.
</li><li class="li-itemize"><span style="font-family:monospace">-AsuggestPureMethods</span>
Suggest methods that could be marked
<a href="../api/org/checkerframework/dataflow/qual/SideEffectFree.html"><span style="font-family:monospace">@SideEffectFree</span></a>,
<a href="../api/org/checkerframework/dataflow/qual/Deterministic.html"><span style="font-family:monospace">@Deterministic</span></a>,
or <a href="../api/org/checkerframework/dataflow/qual/Pure.html"><span style="font-family:monospace">@Pure</span></a>; see
Section&#XA0;<a href="#type-refinement-purity">26.7.5</a>.
</li><li class="li-itemize"><span style="font-family:monospace">-AresolveReflection</span>
Determine the target of reflective calls, and perform more precise
type-checking based no that information; see
Chapter&#XA0;<a href="#reflection-resolution">22</a>. <span style="font-family:monospace">-AresolveReflection=debug</span> causes
debugging information to be output.
</li><li class="li-itemize"><span style="font-family:monospace">-Ainfer</span>
Output suggested annotations for method signatures and fields.
These annotations may reduce the number of type-checking
errors when running type-checking in the future; see
Section&#XA0;<a href="#whole-program-inference">29.3</a>.
</li><li class="li-itemize"><span style="font-family:monospace">-AshowSuppressWarningKeys</span>
With each warning, show all possible keys to suppress that warning.
</li><li class="li-itemize"><span style="font-family:monospace">-AwarnUnneededSuppressions</span>
Issue a warning if a <span style="font-family:monospace">@SuppressWarnings</span> did not suppress a warning
issued by the checker. This may issue false positive warnings about
<span style="font-family:monospace">@SuppressWarnings</span> keys without a <span style="font-family:monospace"><em>checkername</em></span><span style="font-family:monospace">:</span> prefix
(Section&#XA0;<a href="#suppresswarnings-annotation-syntax">27.1.1</a>). You can use the
<span style="font-family:monospace">-ArequirePrefixInWarningSuppressions</span> command-line argument to ensure
your <span style="font-family:monospace">@SuppressWarnings</span> always use a <span style="font-family:monospace"><em>checkername</em></span><span style="font-family:monospace">:</span> prefix.
</li><li class="li-itemize"><span style="font-family:monospace">-ArequirePrefixInWarningSuppressions</span>
Require that the key in a warning suppression annotation begin with a checker
warning suppression key. Otherwise, the suppress warning annotation does not
suppress any warnings. For example, if this command-line option is
supplied, then <span style="font-family:monospace">@SuppressWarnings("assignment.type.incompatible")</span> has no effect, but
<span style="font-family:monospace">@SuppressWarnings("nullness:assignment.type.incompatible")</span> does.
</li></ul><p>Partially-annotated libraries
</p><ul class="itemize"><li class="li-itemize">
<span style="font-family:monospace">-Astubs</span>
List of stub files or directories; see Section&#XA0;<a href="#stub-using">30.5.1</a>.
</li><li class="li-itemize"><span style="font-family:monospace">-AstubWarnIfNotFound</span>
Warn if a stub file entry could not be found; see Section&#XA0;<a href="#stub-using">30.5.1</a>.
</li><li class="li-itemize"><span style="font-family:monospace">-AstubWarnIfNotFoundIgnoresClasses</span>
Don&#X2019;t warn about missing classes (only methods and fields) even when <span style="font-family:monospace">-AwarnIfNotFound</span> is true.
</li><li class="li-itemize"><span style="font-family:monospace">-AstubWarnIfOverwritesBytecode</span>
Warn if a stub file entry overwrite bytecode information; see
Section&#XA0;<a href="#stub-using">30.5.1</a>.
</li><li class="li-itemize"><span style="font-family:monospace">-AuseDefaultsForUncheckedCode=source</span>
Outside the scope of any relevant
<a href="../api/org/checkerframework/framework/qual/AnnotatedFor.html"><span style="font-family:monospace">@AnnotatedFor</span></a> annotation, use unchecked code
default annotations and suppress all type-checking warnings; see
Section&#XA0;<a href="#compiling-libraries">30.4</a>.
</li></ul><p>Debugging
</p><ul class="itemize"><li class="li-itemize">
<span style="font-family:monospace">-AprintAllQualifiers</span>,
<span style="font-family:monospace">-AprintVerboseGenerics</span>,
<span style="font-family:monospace">-Adetailedmsgtext</span>,
<span style="font-family:monospace">-Anomsgtext</span>
Amount of detail in messages; see Section&#XA0;<a href="#creating-debugging-options-detail">31.11.1</a>.</li><li class="li-itemize"><span style="font-family:monospace">-Aignorejdkastub</span>,
<span style="font-family:monospace">-Anocheckjdk</span>,
<span style="font-family:monospace">-AstubDebug</span>
Stub and JDK libraries; see Section&#XA0;<a href="#creating-debugging-options-libraries">31.11.2</a>.</li><li class="li-itemize"><span style="font-family:monospace">-Afilenames</span>,
<span style="font-family:monospace">-Ashowchecks</span>,
<span style="font-family:monospace">-AshowInferenceSteps</span>
Progress tracing; see Section&#XA0;<a href="#creating-debugging-options-progress">31.11.3</a>.</li><li class="li-itemize"><span style="font-family:monospace">-AoutputArgsToFile</span>
Output the compiler command-line arguments to a file. Useful when the
command line is generated and executed by a tool, such as a build system.
This produces a standalone command line that can be executed independently
of the tool that generated it can make it easier to reproduce, report, and
debug issues. For example, the command line can be modified to enable
attaching a debugger.
See Section&#XA0;<a href="#creating-debugging-options-output-args">31.11.4</a>.</li><li class="li-itemize"><span style="font-family:monospace">-Aflowdotdir</span>,
<span style="font-family:monospace">-Averbosecfg</span>,
<span style="font-family:monospace">-Acfgviz</span>
Draw a visualization of the CFG (control flow graph); see
Section&#XA0;<a href="#creating-debugging-dataflow-graph">31.11.5</a>.</li><li class="li-itemize"><span style="font-family:monospace">-AresourceStats</span>,
<span style="font-family:monospace">-AatfDoNotCache</span>,
<span style="font-family:monospace">-AatfCacheSize</span>
Miscellaneous debugging options; see Section&#XA0;<a href="#creating-debugging-options-misc">31.11.6</a>.</li></ul><p>Some checkers support additional options, which are described in that
checker&#X2019;s manual section.
For example, <span style="font-family:monospace">-Aquals</span> tells
the Subtyping Checker (see Chapter&#XA0;<a href="#subtyping-checker">23</a>) and the Fenum Checker
(see Chapter&#XA0;<a href="#fenum-checker">9</a>) which annotations to check.</p><p>Here are some standard javac command-line options that you may find useful.
Many of them contain the word &#X201C;processor&#X201D;, because in javac jargon, a
checker is an &#X201C;annotation processor&#X201D;.</p><ul class="itemize"><li class="li-itemize">
<span style="font-family:monospace">-processor</span> Names the checker to be
run; see Section&#XA0;<a href="#running">2.2</a>
</li><li class="li-itemize"><span style="font-family:monospace">-processorpath</span> Indicates where to search for the
checker; should also contain any qualifiers used by the Subtyping
Checker; see Section&#XA0;<a href="#subtyping-example">23.2</a>
</li><li class="li-itemize"><span style="font-family:monospace">-proc:</span>{<span style="font-family:monospace">none</span>,<span style="font-family:monospace">only</span>} Controls whether checking
happens; <span style="font-family:monospace">-proc:none</span>
means to skip checking; <span style="font-family:monospace">-proc:only</span> means to do only
checking, without any subsequent compilation; see
Section&#XA0;<a href="#checker-auto-discovery">2.2.4</a>
</li><li class="li-itemize"><span style="font-family:monospace">-implicit:class</span> Suppresses warnings about implicitly compiled files
(not named on the command line); see Section&#XA0;<a href="#ant-task">32.3</a>
</li><li class="li-itemize"><span style="font-family:monospace">-J</span> Supply an argument to the JVM that is running javac;
for example, <span style="font-family:monospace">-J-Xmx2500m</span> to increase its maximum heap size
</li><li class="li-itemize"><span style="font-family:monospace">-doe</span> To &#X201C;dump on error&#X201D;, that is, output a stack trace
whenever a compiler warning/error is produced. Useful when debugging
the compiler or a checker.
</li></ul><p>The Checker Framework does not support <span style="font-family:monospace">-source 1.7</span> or earlier. You must
supply <span style="font-family:monospace">-source 1.8</span> or later, or no <span style="font-family:monospace">-source</span> command-line argument,
when running <span style="font-family:monospace">javac</span>.</p>
<!--TOC subsection id="checker-auto-discovery" Checker auto-discovery-->
<h3 id="checker-auto-discovery" class="subsection">2.2.4&#XA0;&#XA0;Checker auto-discovery <a href="#checker-auto-discovery" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>&#X201C;Auto-discovery&#X201D; makes the <span style="font-family:monospace">javac</span> compiler always run a checker
plugin, even if you do not explicitly pass the <span style="font-family:monospace">-processor</span>
command-line option. This can make your command line shorter, and ensures
that your code is checked even if you forget the command-line option.</p><p>
To enable auto-discovery, place a configuration file named
<span style="font-family:monospace">META-INF/services/javax.annotation.processing.Processor</span>
in your classpath. The file contains the names of the checker plugins to
be used, listed one per line. For instance, to run the Nullness Checker and the
Interning Checker automatically, the configuration file should contain:
</p><pre class="verbatim">  org.checkerframework.checker.nullness.NullnessChecker
  org.checkerframework.checker.interning.InterningChecker
</pre><p>You can disable this auto-discovery mechanism by passing the
<span style="font-family:monospace">-proc:none</span> command-line option to <span style="font-family:monospace">javac</span>, which disables all
annotation processing including all pluggable type-checking.</p>
<!--TOC subsection id="shorthand-for-checkers" Shorthand for built-in checkers -->
<h3 id="shorthand-for-checkers" class="subsection">2.2.5&#XA0;&#XA0;Shorthand for built-in checkers  <a href="#shorthand-for-checkers" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Ordinarily, javac&#X2019;s <span style="font-family:monospace">-processor</span> flag requires fully-qualified class names.
When running a built-in checker, you may
omit the package name and the <span style="font-family:monospace">Checker</span> suffix.
The following three commands are equivalent:</p><pre>
  javac -processor <span style="font-weight:bold">org.checkerframework.checker.nullness.NullnessChecker</span> MyFile.java
  javac -processor <span style="font-weight:bold">NullnessChecker</span> MyFile.java
  javac -processor <span style="font-weight:bold">nullness</span> MyFile.java
</pre><p>This feature also works when multiple checkers are specified.
Their names are separated by commas, with no surrounding space.
For example:</p><pre>
  javac -processor NullnessChecker,RegexChecker MyFile.java
  javac -processor nullness,regex MyFile.java
</pre><p>This feature does not apply to Javac <a href="https://docs.oracle.com/javase/8/docs/technotes/tools/windows/javac.html#BHCJEIBB">@argfiles</a>.</p>
<!--TOC section id="checker-guarantees" What the checker guarantees-->
<h2 id="checker-guarantees" class="section">2.3&#XA0;&#XA0;What the checker guarantees <a href="#checker-guarantees" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>A checker can guarantee that a particular property holds throughout the
code. For example, the Nullness Checker (Chapter&#XA0;<a href="#nullness-checker">3</a>)
guarantees that every expression whose type is a <a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a> type never
evaluates to null. The Interning Checker (Chapter&#XA0;<a href="#interning-checker">6</a>)
guarantees that every expression whose type is an <a href="../api/org/checkerframework/checker/interning/qual/Interned.html"><span style="font-family:monospace">@Interned</span></a> type
evaluates to an interned value. The checker makes its guarantee by
examining every part of your program and verifying that no part of the
program violates the guarantee.</p><p>There are some limitations to the guarantee.</p><ul class="itemize"><li class="li-itemize">A compiler plugin can check only those parts of your program that you run
it on. If you compile some parts of your program without running the
checker, then there is no guarantee that the entire program satisfies the
property being checked. Some examples of un-checked code are:<ul class="itemize"><li class="li-itemize">
Code compiled without the <span style="font-family:monospace">-processor</span> switch, including any
external library supplied as a <span style="font-family:monospace">.class</span> file.
</li><li class="li-itemize">Code compiled with the <span style="font-family:monospace">-AskipUses</span>, <span style="font-family:monospace">-AonlyUses</span>, <span style="font-family:monospace">-AskipDefs</span> or <span style="font-family:monospace">-AonlyDefs</span>
properties (see Chapter&#XA0;<a href="#suppressing-warnings">27</a>).
</li><li class="li-itemize">Suppression of warnings, such as via the <span style="font-family:monospace">@SuppressWarnings</span>
annotation (see Chapter&#XA0;<a href="#suppressing-warnings">27</a>).
</li><li class="li-itemize">Native methods (because the implementation is not Java code, it cannot
be checked).
</li></ul><p>In each of these cases, any <em>use</em> of the code is checked &#X2014; for
example, a call to a native method must be compatible with any
annotations on the native method&#X2019;s signature.
However, the annotations on the un-checked code are trusted; there is no
verification that the implementation of the native method satisfies the
annotations.</p></li><li class="li-itemize">The Checker Framework is, by default, unsound in a few places where a
conservative analysis would issue too many false positive warnings.
These are listed in Section&#XA0;<a href="#unsound-by-default">2.2.3</a>.
You can supply a command-line argument to make the Checker Framework
sound for each of these cases.</li><li class="li-itemize">Specific checkers may have other limitations; see their documentation for
details.</li></ul><p>A checker can be useful in finding bugs or in verifying part of a
program, even if the checker is unable to verify the correctness of an
entire program.</p><p>In order to avoid a flood of unhelpful warnings, many of the checkers avoid
issuing the same warning multiple times. For example, in this code:</p><pre class="verbatim">  @Nullable Object x = ...;
  x.toString();                 // warning
  x.toString();                 // no warning
</pre><p>In this case, the second call to <span style="font-family:monospace">toString</span> cannot possibly throw a null
pointer warning &#X2014; <span style="font-family:monospace">x</span> is non-null if control flows to the second
statement.
In other cases, a checker avoids issuing later warnings with the same cause
even when later code in a method might also fail.
This does not
affect the soundness guarantee, but a user may need to examine more
warnings after fixing the first ones identified. (More often, at least in
our experience to date, a single fix corrects all the warnings.)</p><p>If you find that a checker fails to issue a warning that it
should, then please report a bug (see Section&#XA0;<a href="#reporting-bugs">34.2</a>).</p>
<!--TOC section id="tips-about-writing-annotations" Tips about writing annotations-->
<h2 id="tips-about-writing-annotations" class="section">2.4&#XA0;&#XA0;Tips about writing annotations <a href="#tips-about-writing-annotations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>Section&#XA0;<a href="#library-tips">30.1</a> gives additional tips that are
specific to annotating a third-party library.</p>
<!--TOC subsection id="annotate-before-checking" Write annotations before you run a checker-->
<h3 id="annotate-before-checking" class="subsection">2.4.1&#XA0;&#XA0;Write annotations before you run a checker <a href="#annotate-before-checking" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Before you run a checker, annotate the code, based on its documentation.
Then, run the checker to uncover bugs in the code or the documentation.</p><p>Don&#X2019;t do the opposite, which is to run the checker and then add annotations
according to the warnings issued. This approach is less systematic, so you
may overlook some annotations. It often leads to confusion and poor
results. It leads users to make changes not for any principled reason, but
to &#X201C;make the type-checker happy&#X201D;, even when the changes are in conflict
with the documentation or the code. Also see &#X201C;Annotations
are a specification&#X201D;, below.</p>
<!--TOC subsection id="get-started-with-legacy-code" How to get started annotating legacy code-->
<h3 id="get-started-with-legacy-code" class="subsection">2.4.2&#XA0;&#XA0;How to get started annotating legacy code <a href="#get-started-with-legacy-code" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Annotating an entire existing program may seem like a daunting task. But,
if you approach it systematically and do a little bit at a time, you will
find that it is manageable.</p>
<!--TOC subsubsection id="get-started-start-small" Start small-->
<h4 id="get-started-start-small" class="subsubsection">Start small <a href="#get-started-start-small" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h4><!--SEC END --><p>Start small. Focus on one specific property that matters to you; in
other words, run just one checker rather than multiple ones. You may
choose a different checker for different programs.
Focus on
the most mission-critical or error-prone part of your code; don&#X2019;t try to
annotate your whole program at first.</p><p>It is easiest to add annotations if you know the code or the
code contains documentation; you will find that you spend most of your time
understanding the code, and very little time actually writing annotations
or running the checker.</p><p>When annotating, be systematic; we recommend
annotating an entire class at a time (not just some of the methods)
so that you don&#X2019;t lose track of your work or redo work. For example,
working class-by-class avoids confusion about whether an unannotated type
means you determined that the default is desirable, or it means you didn&#X2019;t
yet examine that type.
You may find it helpful to start annotating the leaves of the call tree &#X2014;
that is,
start with methods/classes/packages that have few dependencies on other
code or, equivalently, start with code that a lot of your other code
depends on. For example, within a package annotate supertypes before you
annotated classes that extend or implement them.
The reason for this rule is that it is
easiest to annotate a class if the code it depends on has already been
annotated.</p><p>Don&#X2019;t overuse pluggable type-checking. If the regular Java type system can
verify a property using Java subclasses, then that is a better choice than
pluggable type-checking (see Section&#XA0;<a href="#faq-typequals-vs-subtypes">33.1.2</a>).</p>
<!--TOC subsubsection id="get-started-annotations-are-a-specification" Annotations are a specification-->
<h4 id="get-started-annotations-are-a-specification" class="subsubsection">Annotations are a specification <a href="#get-started-annotations-are-a-specification" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h4><!--SEC END --><p>When you write annotations, you are writing a specification, and you should
think about them that way. Start out by understanding the program so that
you can write an accurate specification.
Sections&#XA0;<a href="#annotate-normal-behavior">2.4.3</a>
and&#XA0;<a href="#annotations-are-a-contract">2.4.4</a> give more tips about writing
specifications.</p><p>For each class, read its Javadoc. For instance, if you are adding
annotations for the Nullness Checker (Section&#XA0;<a href="#nullness-checker">3</a>), then
you can search the documentation for &#X201C;null&#X201D; and then add <span style="font-family:monospace">@Nullable</span>
anywhere appropriate. For now, just annotate signatures and fields; there is no
need to annotate method bodies. The only reason to even
<em>read</em> the method bodies yet is to determine signature annotations for
undocumented methods &#X2014;
for example, if the method returns null, you know its return type should be
annotated <span style="font-family:monospace">@Nullable</span>, and a parameter that is compared against <span style="font-family:monospace">null</span>
may need to be annotated <span style="font-family:monospace">@Nullable</span>.</p><p>After you have annotated all the signatures, run the checker.
Then, fix bugs in code and add/modify annotations as necessary.
Don&#X2019;t get discouraged if you see many type-checker warnings at first.
Often, adding just a few missing annotations will eliminate many warnings,
and you&#X2019;ll be surprised how fast the process goes overall.</p><p>You may wonder about the effect of adding a given annotation (that is, of
changing the specification for a given method or class): how many
other specification changes (added annotations) will it require, and will
it conflict with other code? It&#X2019;s best to reason about the desired design,
but you can also do an experiment.
Suppose you are considering adding an annotation to a method parameter.
One approach is to manually examine all callees.
A more automated approach is to save the checker
output before adding the annotation, and to compare it to the checker
output after adding the annotation. This helps you to focus on the
specific consequences of your change.</p><p>Chapter&#XA0;<a href="#annotating-libraries">30</a> tells you how to annotate libraries that
your code uses. Section&#XA0;<a href="#handling-warnings">2.4.5</a> and
Chapter&#XA0;<a href="#suppressing-warnings">27</a> tell you what to do when you are unable
to eliminate checker warnings by adding annotations.</p>
<!--TOC subsubsection id="get-started-write-good-code" Write good code-->
<h4 id="get-started-write-good-code" class="subsubsection">Write good code <a href="#get-started-write-good-code" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h4><!--SEC END --><p>Avoid complex code, which is more error-prone. If you write your code to
be simple and clean enough for the type-checker to verify, then it will
also be easier for programmers to understand.</p><p>Your code should compile cleanly under the regular Java compiler. If you
are not willing to write code that type-checks in Java, then there is
little point in using an even more powerful, restrictive type system. As a
specific example, your code should not use raw types like <span style="font-family:monospace">List</span>; use
parameterized types like <span style="font-family:monospace">List&lt;String&gt;</span> instead
(Section&#XA0;<a href="#generics-raw-types">25.1.1</a>).</p><p>Do not write unnecessary annotations.
</p><ul class="itemize"><li class="li-itemize">
Do not annotate local variables unless necessary. The checker infers
annotations for local variables (see Section&#XA0;<a href="#type-refinement">26.7</a>).
Usually, you only need to annotate fields and method signatures. You
should add annotations inside method bodies only if the checker is unable
to infer the correct annotation (usually on type arguments or array
element types, rather than
on top-level types).
</li><li class="li-itemize">Do not write annotations that are redundant with defaults. For example,
when checking nullness (Chapter&#XA0;<a href="#nullness-checker">3</a>), the default
annotation is <span style="font-family:monospace">@NonNull</span>, in most locations other than some type bounds
(Section&#XA0;<a href="#climb-to-top">26.5.3</a>). When you are starting out, it might seem
helpful to write redundant annotations as a reminder, but that&#X2019;s like
when beginning programmers write a comment about every simple piece of
code:<pre class="verbatim">// The below code increments variable i by adding 1 to it.
i++;
</pre><p>As you become comfortable with pluggable type-checking, you will find
redundant annotations to be distracting clutter, so avoid putting them in
your code in the first place.</p></li><li class="li-itemize">Avoid writing <span style="font-family:monospace">@SuppressWarnings</span> annotations unless there is no
alternative. It is tempting to think that your code is right and the
checker&#X2019;s warnings are false positives. Sometimes they are, but slow
down and convince yourself of that before you dismiss them.
Section&#XA0;<a href="#handling-warnings">2.4.5</a> discusses what to do when a checker
issues a warning about your code.</li></ul>
<!--TOC subsection id="annotate-normal-behavior" Annotations indicate non-exceptional behavior-->
<h3 id="annotate-normal-behavior" class="subsection">2.4.3&#XA0;&#XA0;Annotations indicate non-exceptional behavior <a href="#annotate-normal-behavior" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>You should use annotations to specify <em>normal</em> behavior. The
annotations indicate all the values that you <em>want</em> to flow to a
reference &#X2014; not every value that might possibly flow there if your
program has a bug.</p><p>As an example, the goal of the Nullness Checker is to guarantee that your
program does not crash due to a null value. In a method like this:</p><pre class="verbatim">  /** @throws IllegalArgumentException if arg is null */
  void m(Object arg) {
    if (arg == null) {
      throw new IllegalArgumentException();
    }
    ...
  }
</pre><p>the program crashes if <span style="font-family:monospace">null</span> is passed. Therefore, the type of <span style="font-family:monospace">arg</span>
should be <span style="font-family:monospace">@NonNull Object</span> (which you can write as just <span style="font-family:monospace">Object</span> due to
defaulting). The Nullness Checker (Chapter&#XA0;<a href="#nullness-checker">3</a>)
will warn whenever a client passes a
value that might cause m to crash. If you wrote the type of the formal
parameter as <span style="font-family:monospace">@Nullable Object</span>, the Nullness Checker would permit clients
to make calls that lead to a crash.</p><p>Many methods are guaranteed to throw an exception if they are passed <span style="font-family:monospace">null</span>
as an argument. Examples include</p><pre class="verbatim">  java.lang.Double.valueOf(String)
  java.lang.String.contains(CharSequence)
  org.junit.Assert.assertNotNull(Object)
  com.google.common.base.Preconditions.checkNotNull(Object)
</pre><p><a href="../api/org/checkerframework/checker/nullness/qual/Nullable.html"><span style="font-family:monospace">@Nullable</span></a> (see Section&#XA0;<a href="#nullness-annotations">3.2</a>)
might seem like a reasonable annotation for the parameter,
for two reasons. First, <span style="font-family:monospace">null</span> is a legal argument with a
well-defined semantics: throw an exception. Second, <span style="font-family:monospace">@Nullable</span>
describes a possible program execution: it might be possible for
<span style="font-family:monospace">null</span> to flow there, if your program has a bug.</p><p>However, it is never useful for a programmer to pass <span style="font-family:monospace">null</span>. It is
the programmer&#X2019;s intention that <span style="font-family:monospace">null</span> never flows there. If
<span style="font-family:monospace">null</span> does flow there, the program will not continue normally
(whether or not it throws a NullPointerException).</p><p>Therefore, you should specify such parameters as
<a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a>, indicating
the intended use of the method. When you specify the parameter as the <span style="font-family:monospace">@NonNull</span>
annotation, the checker is able to issue compile-time warnings about
possible run-time exceptions, which is its purpose. Specifying the parameter
as <span style="font-family:monospace">@Nullable</span> would suppress such warnings, which is undesirable.
(Since <span style="font-family:monospace">@NonNull</span> is the default, you don&#X2019;t have to write anything in
the source code to specify the parameter as non-null. You are allowed to
write a redundant <span style="font-family:monospace">@NonNull</span> annotation, but it is discouraged.)</p><p>If a method can possibly throw an exception because its parameter
is <span style="font-family:monospace">null</span>, then that parameter&#X2019;s type should be <span style="font-family:monospace">@NonNull</span>, which
guarantees that the type-checker will issue a warning for every client
use that has the potential to cause an exception. Don&#X2019;t write
<span style="font-family:monospace">@Nullable</span> on the parameter just because there exist some executions that
don&#X2019;t necessarily throw an exception.</p><p>Another example is the Optional Checker (Chapter&#XA0;<a href="#optional-checker">5</a>)
and the <span style="font-family:monospace">orElseThrow</span> method.
The goal of the Optional Checker is to ensure that the program does not
crash due to use of a non-present Optional value. Therefore, the receiver
of <a href="https://docs.oracle.com/en/java/javase/11/docs/api/java.base/java/util/Optional.html#orElseThrow()"><span style="font-family:monospace">orElseThrow</span></a> is annotated as
<a href="https://checkerframework.org/api/org/checkerframework/checker/optional/qual/Present.html"><span style="font-family:monospace">@Present</span></a>,
and the optional Checker issues a warning if the client calls
<span style="font-family:monospace">orElseThrow</span> on a <span style="font-family:monospace">@MaybePresent</span> value.</p>
<!--TOC subsection id="annotations-are-a-contract" Subclasses must respect superclass annotations-->
<h3 id="annotations-are-a-contract" class="subsection">2.4.4&#XA0;&#XA0;Subclasses must respect superclass annotations <a href="#annotations-are-a-contract" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>An annotation indicates a guarantee that a client can depend upon. A subclass
is not permitted to <em>weaken</em> the contract; for example,
if a method accepts <span style="font-family:monospace">null</span> as an argument, then every overriding
definition must also accept <span style="font-family:monospace">null</span>.
A subclass is permitted to <em>strengthen</em> the contract; for example,
if a method does <em>not</em> accept <span style="font-family:monospace">null</span> as an argument, then an
overriding definition is permitted to accept <span style="font-family:monospace">null</span>.</p><p>
As a bad example, consider an erroneous <span style="font-family:monospace">@Nullable</span> annotation in
<a href="https://github.com/google/guava/blob/master/guava/src/com/google/common/collect/Multiset.java#L129"><span style="font-family:monospace">com/google/common/collect/Multiset.java</span></a>:
</p><pre class="verbatim">101  public interface Multiset&lt;E&gt; extends Collection&lt;E&gt; {
...
122    /**
123     * Adds a number of occurrences of an element to this multiset.
...
129     * @param element the element to add occurrences of; may be {@code null} only
130     *     if explicitly allowed by the implementation
...
137     * @throws NullPointerException if {@code element} is null and this
138     *     implementation does not permit null elements. Note that if {@code
139     *     occurrences} is zero, the implementation may opt to return normally.
140     */
141    int add(@Nullable E element, int occurrences);
</pre><p>There exist implementations of Multiset that permit <span style="font-family:monospace">null</span> elements,
and implementations of Multiset that do not permit <span style="font-family:monospace">null</span> elements. A
client with a variable <span style="font-family:monospace">Multiset ms</span> does not know which variety of
Multiset <span style="font-family:monospace">ms</span> refers to. However, the <span style="font-family:monospace">@Nullable</span> annotation
promises that <span style="font-family:monospace">ms.add(null, 1)</span> is permissible. (Recall from
Section&#XA0;<a href="#annotate-normal-behavior">2.4.3</a> that annotations should indicate
normal behavior.)</p><p>If parameter <span style="font-family:monospace">element</span> on line 141 were to be annotated, the correct
annotation would be <span style="font-family:monospace">@NonNull</span>. Suppose a client has a reference to
same Multiset <span style="font-family:monospace">ms</span>. The only way the client can be sure not to throw an exception is to pass
only non-<span style="font-family:monospace">null</span> elements to <span style="font-family:monospace">ms.add()</span>. A particular class
that implements Multiset could declare <span style="font-family:monospace">add</span> to take a
<span style="font-family:monospace">@Nullable</span> parameter. That still satisfies the original contract.
It strengthens the contract by promising even more: a client with such a
reference can pass any non-<span style="font-family:monospace">null</span> value to <span style="font-family:monospace">add()</span>, and may also
pass <span style="font-family:monospace">null</span>.</p><p><span style="font-weight:bold">However</span>, the best annotation for line 141 is no annotation at all.
The reason is that each implementation of the Multiset interface should
specify its own nullness properties when it specifies the type parameter
for Multiset. For example, two clients could be written as</p><pre class="verbatim">  class MyNullPermittingMultiset implements Multiset&lt;@Nullable Object&gt; { ... }
  class MyNullProhibitingMultiset implements Multiset&lt;@NonNull Object&gt; { ... }
</pre><p>or, more generally, as</p><pre class="verbatim">  class MyNullPermittingMultiset&lt;E extends @Nullable Object&gt; implements Multiset&lt;E&gt; { ... }
  class MyNullProhibitingMultiset&lt;E extends @NonNull Object&gt; implements Multiset&lt;E&gt; { ... }
</pre><p>Then, the specification is more informative, and the Checker Framework is
able to do more precise checking, than if line 141 has an annotation.</p><p>It is a pleasant feature of the Checker Framework that in many cases, no
annotations at all are needed on type parameters such as <span style="font-family:monospace">E</span> in <span style="font-family:monospace">MultiSet</span>.</p>
<!--TOC subsection id="handling-warnings" What to do if a checker issues a warning about your code-->
<h3 id="handling-warnings" class="subsection">2.4.5&#XA0;&#XA0;What to do if a checker issues a warning about your code <a href="#handling-warnings" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>When you run a type-checker on your code, it is likely to issue warnings or
errors. Don&#X2019;t panic! There are three general causes for the warnings:</p><ul class="itemize"><li class="li-itemize">
There is a bug in your code, such as a possible null dereference. Fix
your code to prevent that crash.</li><li class="li-itemize">The annotations are too strong (they are incorrect) or too weak (they
are imprecise). Improve the
annotations, usually by writing more annotations in order to better
express the specification.
Only write annotations that accurately describe the intended behavior of
the software &#X2014; don&#X2019;t write inaccurate annotations just for the purpose
of eliminating type-checker warnings.<p>Usually you need to improve the annotations in your source code.
Sometimes you need to improve annotations in a library that your program
uses (see Chapter&#XA0;<a href="#annotating-libraries">30</a>).</p></li><li class="li-itemize">There is a weakness in the type-checker. Your code is safe &#X2014; it never
suffers the error at run time &#X2014; but the checker cannot prove this fact.
If possible, rewrite your code to be simpler for the checker to analyze;
this is likely to make it easier for people to understand, too.
If that is not possible, suppress the warning (see
Chapter&#XA0;<a href="#suppressing-warnings">27</a>); be sure to include a code
comment explaining how you know the code is correct even though the
type-checker cannot deduce that fact.<p>(Do not add an <span style="font-family:monospace">if</span> test that can never fail, just to suppress a
warning. Adding a gratuitous <span style="font-family:monospace">if</span> clutters the code and confuses
readers, who will assume that every <span style="font-family:monospace">if</span> condition can evaluate to true
or false. It can be acceptable to add an <span style="font-family:monospace">if</span> test that throws a
descriptive error message.)
</p></li></ul><p>For each warning issued by the checker, you need to determine which of the
above categories it falls into. Here is an effective methodology to do so.
It relies mostly on manual code examination, but you may also find it
useful to write test cases for your code or do other kinds of analysis, to
verify your reasoning.</p><ol class="enumerate" type=1><li class="li-enumerate">
Write an explanation of why your code is correct and it
never suffers the error at run time. In other words, this is an English proof
that the type-checker&#X2019;s warning is incorrect.<p>Don&#X2019;t skip any steps in your proof.
(For example, don&#X2019;t write an unsubstantiated claim such as &#X201C;<span style="font-family:monospace">x</span> is
non-null here&#X201D;; instead, give a justification.)
Don&#X2019;t let your reasoning rely on
facts that you do not write down explicitly. For example, remember that
calling a method might change the values of object fields; your proof
might need to state that certain methods have no side effects.</p><p>If you cannot write a proof, then there is a bug
in your code (you should fix the bug) or your code is too complex for you
to understand (you should improve its documentation and/or design).</p></li><li class="li-enumerate">Translate the proof into annotations. Here are some examples.<ul class="itemize"><li class="li-itemize">
If your proof includes &#X201C;variable <span style="font-family:monospace">x</span> is never <span style="font-family:monospace">null</span>
at run time&#X201D;, then annotate &lt;x&gt;&#X2019;s type with
<a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a>.
</li><li class="li-itemize">If your proof
includes &#X201C;method <span style="font-family:monospace">foo</span> always returns a legal regular expression&#X201D;,
then annotate <span style="font-family:monospace">foo</span>&#X2019;s return type with
<a href="../api/org/checkerframework/checker/regex/qual/Regex.html"><span style="font-family:monospace">@Regex</span></a>.
</li><li class="li-itemize">If your proof includes &#X201C;if method <span style="font-family:monospace">join</span>&#X2019;s first argument is
non-null, then <span style="font-family:monospace">join</span> returns a non-null result&#X201D;, then annotate
<span style="font-family:monospace">join</span>&#X2019;s first parameter and return type with
<a href="../api/org/checkerframework/checker/nullness/qual/PolyNull.html"><span style="font-family:monospace">@PolyNull</span></a>.
</li><li class="li-itemize">If your proof includes &#X201C;method <span style="font-family:monospace">processOptions</span> has already been called and it
set field <span style="font-family:monospace">tz1</span>&#X201D;, then annotate <span style="font-family:monospace">processOptions</span>&#X2019;s declaration with
<a href="../api/org/checkerframework/checker/nullness/qual/EnsuresNonNull.html"><span style="font-family:monospace">@EnsuresNonNull</span></a><span style="font-family:monospace">("tz1")</span>.
</li><li class="li-itemize">If your proof includes &#X201C;method <span style="font-family:monospace">isEmpty</span> returned false, so its
argument must have been non-null&#X201D;, then annotate <span style="font-family:monospace">isEmpty</span>&#X2019;s
declaration with
<a href="../api/org/checkerframework/checker/nullness/qual/EnsuresNonNullIf.html"><span style="font-family:monospace">@EnsuresNonNullIf</span></a><span style="font-family:monospace">(expression="#1",result=false)</span>.
</li></ul><p>
All of these are examples of correcting weaknesses in the annotations you wrote.
The Checker Framework provides many other powerful annotations; you may
be surprised how many proofs you can express in annotations.
If you need to annotate a method that is defined in a
library that your code uses, see Chapter&#XA0;<a href="#annotating-libraries">30</a>,
Annotating Libraries.</p><p>If there are complex facts in your proof that cannot be expressed as
annotations, then that is a weakness in the type-checker. For example,
the Nullness Checker cannot express &#X201C;in list <span style="font-family:monospace">lst</span>, elements stored at
even indices are always non-<span style="font-family:monospace">null</span>, but elements stored at odd elements
might be <span style="font-family:monospace">null</span>.&#X201D; In this case, you have two choices.
First, you can suppress the warning
(Chapter&#XA0;<a href="#suppressing-warnings">27</a>); be sure to write a comment
explaining your reasoning for suppressing the warning. You may wish to
submit a feature request (Section&#XA0;<a href="#reporting-bugs">34.2</a>) asking for
annotations that handle your use case.
Second, you can rewrite the code to make the proof simpler;
in the above example, it might be better to use a list of pairs
rather than a heterogeneous list.</p></li><li class="li-enumerate">At this point, all the steps in your proof have been formalized as
annotations. Re-run the checker and repeat the process for any new or
remaining warnings.<p>If every step of your proof can be expressed in annotations, but the
checker cannot make one of the deductions (it cannot follow one of the
steps), then that is a weakness in the type-checker. First, double-check
your reasoning. Then, suppress the warning, along with a comment
explaining your reasoning (Chapter&#XA0;<a href="#suppressing-warnings">27</a>).
The comment is an excerpt from your English proof, and the proof guides
you to the best place to suppress the warning.
Finally, please submit a bug report so that the checker can be improved
in the future (Section&#XA0;<a href="#reporting-bugs">34.2</a>).</p></li></ol><p>If you have trouble understanding a Checker Framework warning message, you
can search for its text in this manual. Also see
Section&#XA0;<a href="#common-problems-typechecking">34.1.4</a> and
Chapter&#XA0;<a href="#troubleshooting">34</a>, Troubleshooting.
In particular, Section&#XA0;<a href="#common-problems-typechecking">34.1.4</a> explains this
same methodology in different words.</p><hr>
<!--TOC chapter id="nullness-checker" Nullness Checker-->
<h1 id="nullness-checker" class="chapter">Chapter&#XA0;3&#XA0;&#XA0;Nullness Checker <a href="#nullness-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h1><!--SEC END --><p>If the Nullness Checker issues no warnings for a given program, then
running that program will never throw a null pointer exception. This
guarantee enables a programmer to prevent errors from occurring when a
program is run. See Section&#XA0;<a href="#nullness-checks">3.1</a> for more details about
the guarantee and what is checked.</p><p>The most important annotations supported by the Nullness Checker are
<a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a> and
<a href="../api/org/checkerframework/checker/nullness/qual/Nullable.html"><span style="font-family:monospace">@Nullable</span></a>.
<a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a> is rarely written, because it is
the default. All of the annotations are explained in
Section&#XA0;<a href="#nullness-annotations">3.2</a>.</p><p>To run the Nullness Checker, supply the
<span style="font-family:monospace">-processor org.checkerframework.checker.nullness.NullnessChecker</span>
command-line option to javac. For
examples, see Section&#XA0;<a href="#nullness-example">3.5</a>.</p><p>The NullnessChecker is actually an ensemble of three pluggable
type-checkers that work together: the Nullness Checker proper (which is the
main focus of this chapter), the Initialization Checker
(Section&#XA0;<a href="#initialization-checker">3.8</a>), and the Map Key Checker
(Chapter&#XA0;<a href="#map-key-checker">4</a>).
Their type hierarchies are completely independent, but they work together
to provide precise nullness checking.</p>
<!--TOC section id="nullness-checks" What the Nullness Checker checks-->
<h2 id="nullness-checks" class="section">3.1&#XA0;&#XA0;What the Nullness Checker checks <a href="#nullness-checks" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The checker issues a warning in these cases:</p><ol class="enumerate" type=1><li class="li-enumerate">When an expression of non-<a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a> type
is dereferenced, because it might cause a null pointer exception.
Dereferences occur not only when a field is accessed, but when an array
is indexed, an exception is thrown, a lock is taken in a synchronized
block, and more. For a complete description of all checks performed by
the Nullness Checker, see the Javadoc for
<a href="../api/org/checkerframework/checker/nullness/NullnessVisitor.html"><span style="font-family:monospace">NullnessVisitor</span></a>.</li><li class="li-enumerate">When an expression of <a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a> type
might become null, because it
is a misuse of the type: the null value could flow to a dereference that
the checker does not warn about.<p>As a special case of an of <a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a>
type becoming null, the checker also warns whenever a field of
<a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a> type is not initialized in a
constructor.</p></li></ol><p>This example illustrates the programming errors that the checker detects:</p><pre class="verbatim">  @Nullable Object   obj;  // might be null
  @NonNull  Object nnobj;  // never null
  ...
  obj.toString()         // checker warning:  dereference might cause null pointer exception
  nnobj = obj;           // checker warning:  nnobj may become null
  if (nnobj == null)     // checker warning:  redundant test
</pre><p>Parameter passing and return values are checked analogously to assignments.</p><p>The Nullness Checker also checks the correctness, and correct use, of
initialization (see
Section&#XA0;<a href="#initialization-checker">3.8</a>) and of map key annotations (see
Chapter&#XA0;<a href="#map-key-checker">4</a>).</p><p>The checker performs additional checks if certain <span style="font-family:monospace">-Alint</span>
command-line options are provided. (See
Section&#XA0;<a href="#alint">27.6</a> for more details about the <span style="font-family:monospace">-Alint</span>
command-line option.)</p>
<!--TOC subsection id="nullness-lint" Nullness Checker optional warnings-->
<h3 id="nullness-lint" class="subsection">3.1.1&#XA0;&#XA0;Nullness Checker optional warnings <a href="#nullness-lint" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><ol class="enumerate" type=1><li class="li-enumerate">
Options that control soundness:<ul class="itemize"><li class="li-itemize">
<a id="nullness-lint-nonnullarraycomponents"></a>If you supply the <span style="font-family:monospace">-Alint=forbidnonnullarraycomponents</span> command-line
option, then the checker warns if it encounters an array creation
with a non-null component type.
See Section&#XA0;<a href="#nullness-arrays">3.3.4</a> for a discussion.
</li></ul></li><li class="li-enumerate">Options that warn about poor code style:<ul class="itemize"><li class="li-itemize">
<a id="nullness-lint-nulltest"></a>If you supply the <span style="font-family:monospace">-Alint=redundantNullComparison</span> command-line option, then the
checker warns when a null check is performed against a value that is
guaranteed to be non-null, as in <span style="font-family:monospace">("m" == null)</span>. Such a check is
unnecessary and might indicate a programmer error or misunderstanding.
The lint option is disabled by default because sometimes such checks are
part of ordinary defensive programming.
</li></ul></li></ol>
<!--TOC section id="nullness-annotations" Nullness annotations-->
<h2 id="nullness-annotations" class="section">3.2&#XA0;&#XA0;Nullness annotations <a href="#nullness-annotations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The Nullness Checker uses three separate type hierarchies: one for nullness,
one for initialization (Section&#XA0;<a href="#initialization-checker">3.8</a>),
and one for map keys (Chapter&#XA0;<a href="#map-key-checker">4</a>)
The Nullness Checker has four varieties of annotations: nullness
type qualifiers, nullness method annotations, initialization type qualifiers, and
map key type
qualifiers.</p>
<!--TOC subsection id="nullness-qualifiers" Nullness qualifiers-->
<h3 id="nullness-qualifiers" class="subsection">3.2.1&#XA0;&#XA0;Nullness qualifiers <a href="#nullness-qualifiers" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The nullness hierarchy contains these qualifiers:</p><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/nullness/qual/Nullable.html"><span style="font-weight:bold"><span style="font-family:monospace">@Nullable</span></span></a></dt><dd class="dd-description">
indicates a type that includes the null value. For example, the type <span style="font-family:monospace">Boolean</span>
is nullable: a variable of type <span style="font-family:monospace">Boolean</span> always has one of the
values <span style="font-family:monospace">TRUE</span>, <span style="font-family:monospace">FALSE</span>, or <span style="font-family:monospace">null</span>.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-weight:bold"><span style="font-family:monospace">@NonNull</span></span></a></dt><dd class="dd-description">
indicates a type that does not include the null value. The type
<span style="font-family:monospace">boolean</span> is non-null; a variable of type <span style="font-family:monospace">boolean</span> always has
one of the values <span style="font-family:monospace">true</span> or <span style="font-family:monospace">false</span>. The type <span style="font-family:monospace">@NonNull
Boolean</span> is also non-null: a variable of type <span style="font-family:monospace">@NonNull Boolean</span>
always has one of the values <span style="font-family:monospace">TRUE</span> or <span style="font-family:monospace">FALSE</span> &#X2014; never
<span style="font-family:monospace">null</span>. Dereferencing an expression of non-null type can never cause
a null pointer exception.<p>The <span style="font-family:monospace">@NonNull</span> annotation is rarely written in a program, because it is
the default (see Section&#XA0;<a href="#null-defaults">3.3.2</a>).</p></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/nullness/qual/PolyNull.html"><span style="font-weight:bold"><span style="font-family:monospace">@PolyNull</span></span></a></dt><dd class="dd-description">
indicates qualifier polymorphism. For a description of
<a href="../api/org/checkerframework/checker/nullness/qual/PolyNull.html"><span style="font-family:monospace">@PolyNull</span></a>, see
Section&#XA0;<a href="#qualifier-polymorphism">25.2</a>.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/nullness/qual/MonotonicNonNull.html"><span style="font-weight:bold"><span style="font-family:monospace">@MonotonicNonNull</span></span></a></dt><dd class="dd-description">
indicates a reference that may be <span style="font-family:monospace">null</span>, but if it ever becomes
non-<span style="font-family:monospace">null</span>, then it never becomes <span style="font-family:monospace">null</span> again. This is
appropriate for lazily-initialized fields, for field initialization that
occurs in a lifecycle method other than the constructor (e.g., an
override of <span style="font-family:monospace">android.app.Activity.onCreate</span>), and other uses. When the
variable is read, its type is treated as
<a href="../api/org/checkerframework/checker/nullness/qual/Nullable.html"><span style="font-family:monospace">@Nullable</span></a>, but when the variable is
assigned, its type is treated as
<a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a>.<p>
Because the Nullness Checker works intraprocedurally (it analyzes one
method at a time), when a <span style="font-family:monospace">MonotonicNonNull</span> field is first read within a
method, the field cannot be assumed to be non-null. The benefit of
MonotonicNonNull over Nullable is its different interaction with
type refinement (Section&#XA0;<a href="#type-refinement">26.7</a>).
After a check of a MonotonicNonNull
field, all subsequent accesses <em>within that method</em> can be assumed
to be NonNull, even after arbitrary external method calls that have
access to the given field.
</p><p>It is permitted to initialize a MonotonicNonNull field to null, but the
field may not be assigned to null anywhere else in the program. If you
supply the <span style="font-family:monospace">noInitForMonotonicNonNull</span> lint flag (for example, supply
<span style="font-family:monospace">-Alint=noInitForMonotonicNonNull</span> on the command line), then
<span style="font-family:monospace">@MonotonicNonNull</span> fields are not allowed to have initializers at their
declarations.</p><p>Use of <span style="font-family:monospace">@MonotonicNonNull</span> on a static field is a code smell: it may
indicate poor design. You should consider whether it is possible to make
the field a member field that is set in the constructor.</p></dd></dl><p>Figure&#XA0;<a href="#fig-nullness-hierarchy">3.1</a> shows part of the type hierarchy for the
Nullness type system.
(The annotations exist only at compile time; at run time, Java has no
multiple inheritance.)</p><blockquote class="figure"><div class="center"><hr style="width:80%;height:2"></div>
<div class="center">
<img src="nullness.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 3.1: Partial type hierarchy for the Nullness type system.
Java&#X2019;s <span style="font-family:monospace">Object</span> is expressed as <span style="font-family:monospace">@Nullable Object</span>. Programmers can omit
most type qualifiers, because the default annotation
(Section&#XA0;<a href="#null-defaults">3.3.2</a>) is usually correct.
The Nullness Checker verifies three type hierarchies: this one for
nullness, one for initialization (Section&#XA0;<a href="#initialization-checker">3.8</a>),
and one for map keys (Chapter&#XA0;<a href="#map-key-checker">4</a>).</td></tr>
</table></div>
<a id="fig-nullness-hierarchy"></a>
<div class="center"><hr style="width:80%;height:2"></div></blockquote>
<!--TOC subsection id="nullness-method-annotations" Nullness method annotations-->
<h3 id="nullness-method-annotations" class="subsection">3.2.2&#XA0;&#XA0;Nullness method annotations <a href="#nullness-method-annotations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The Nullness Checker supports several annotations that specify method
behavior. These are declaration annotations, not type annotations: they
apply to the method itself rather than to some particular type.</p><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/nullness/qual/RequiresNonNull.html"><span style="font-weight:bold"><span style="font-family:monospace">@RequiresNonNull</span></span></a></dt><dd class="dd-description">
indicates a method precondition: The annotated method expects the
specified variables to be non-null when the
method is invoked. Don&#X2019;t use this for formal parameters (just annotate
their type as <span style="font-family:monospace">@NonNull</span>). <span style="font-family:monospace">@RequiresNonNull</span> is appropriate for
a field that is <span style="font-family:monospace">@Nullable</span> in general, but some method requires the
field to be non-null.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/nullness/qual/EnsuresNonNull.html"><span style="font-weight:bold"><span style="font-family:monospace">@EnsuresNonNull</span></span></a></dt><dd class="dd-description">
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/nullness/qual/EnsuresNonNullIf.html"><span style="font-weight:bold"><span style="font-family:monospace">@EnsuresNonNullIf</span></span></a></dt><dd class="dd-description">
indicates a method postcondition. With <span style="font-family:monospace">@EnsuresNonNull</span>, the given
expressions are non-null after the method returns; this is useful for a
method that initializes a field, for example. With
<span style="font-family:monospace">@EnsuresNonNullIf</span>, if the annotated
method returns the given boolean value (true or false), then the given
expressions are non-null. See Section&#XA0;<a href="#conditional-nullness">3.3.3</a> and the
Javadoc for examples of their use.</dd></dl>
<!--TOC subsection id="initialization-qualifiers-overview" Initialization qualifiers-->
<h3 id="initialization-qualifiers-overview" class="subsection">3.2.3&#XA0;&#XA0;Initialization qualifiers <a href="#initialization-qualifiers-overview" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The Nullness Checker invokes an Initialization Checker, whose annotations indicate whether
an object is fully initialized &#X2014; that is, whether all of its fields have
been assigned.</p><dl class="description"><dt class="dt-description">
<a href="../api/org/checkerframework/checker/initialization/qual/Initialized.html"><span style="font-weight:bold"><span style="font-family:monospace">@Initialized</span></span></a></dt><dd class="dd-description">
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/initialization/qual/UnknownInitialization.html"><span style="font-weight:bold"><span style="font-family:monospace">@UnknownInitialization</span></span></a></dt><dd class="dd-description">
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/initialization/qual/UnderInitialization.html"><span style="font-weight:bold"><span style="font-family:monospace">@UnderInitialization</span></span></a></dt><dd class="dd-description">
</dd></dl><p>Use of these annotations can help you to type-check more
code. Figure&#XA0;<a href="#fig-initialization-hierarchy">3.3</a> shows its type hierarchy. For
details, see Section&#XA0;<a href="#initialization-checker">3.8</a>.</p>
<!--TOC subsection id="map-key-qualifiers" Map key qualifiers-->
<h3 id="map-key-qualifiers" class="subsection">3.2.4&#XA0;&#XA0;Map key qualifiers <a href="#map-key-qualifiers" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><dl class="description"><dt class="dt-description">
<a href="../api/org/checkerframework/checker/nullness/qual/KeyFor.html"><span style="font-weight:bold"><span style="font-family:monospace">@KeyFor</span></span></a></dt><dd class="dd-description">
</dd></dl><p>
indicates that a value is a key for a given map &#X2014; that is, indicates
whether <span style="font-family:monospace">map.containsKey(value)</span> would evaluate to <span style="font-family:monospace">true</span>.</p><p>This annotation is checked by a Map Key Checker
(Chapter&#XA0;<a href="#map-key-checker">4</a>) that the Nullness Checker
invokes. The <a href="../api/org/checkerframework/checker/nullness/qual/KeyFor.html"><span style="font-family:monospace">@KeyFor</span></a> annotation enables
the Nullness Checker to treat calls to
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html#get-java.lang.Object-"><span style="font-family:monospace">Map.get</span></a>
precisely rather than assuming it may always return null. In particular,
a call <span style="font-family:monospace">mymap.get(mykey)</span> returns a non-<span style="font-family:monospace">null</span> value if two conditions
are satisfied:
</p><ol class="enumerate" type=1><li class="li-enumerate">
<span style="font-family:monospace">mymap</span>&#X2019;s values are all non-<span style="font-family:monospace">null</span>; that is, <span style="font-family:monospace">mymap</span> was
declared as <span style="font-family:monospace">Map&lt;</span><span style="font-family:monospace"><em>KeyType</em></span><span style="font-family:monospace">, @NonNull </span><span style="font-family:monospace"><em>ValueType</em></span><span style="font-family:monospace">&gt;</span>. Note
that <span style="font-family:monospace">@NonNull</span> is the default type, so it need not be written explicitly.
</li><li class="li-enumerate"><span style="font-family:monospace">mykey</span> is a key in <span style="font-family:monospace">mymap</span>; that is, <span style="font-family:monospace">mymap.containsKey(mykey)</span>
returns <span style="font-family:monospace">true</span>. You express this fact to the Nullness Checker by
declaring <span style="font-family:monospace">mykey</span> as <span style="font-family:monospace">@KeyFor("mymap") </span><span style="font-family:monospace"><em>KeyType</em></span><span style="font-family:monospace"> mykey</span>. For a
local variable, you generally do not need to write the
<span style="font-family:monospace">@KeyFor("mymap")</span> type qualifier, because it can be inferred.
</li></ol><p>
If either of these two conditions is violated, then <span style="font-family:monospace">mymap.get(mykey)</span> has
the possibility of returning <span style="font-family:monospace">null</span>.</p>
<!--TOC section id="writing-nullness-annotations" Writing nullness annotations-->
<h2 id="writing-nullness-annotations" class="section">3.3&#XA0;&#XA0;Writing nullness annotations <a href="#writing-nullness-annotations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END -->
<!--TOC subsection id="nullness-implicit-qualifiers" Implicit qualifiers-->
<h3 id="nullness-implicit-qualifiers" class="subsection">3.3.1&#XA0;&#XA0;Implicit qualifiers <a href="#nullness-implicit-qualifiers" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The Nullness Checker
adds implicit qualifiers, reducing the number of annotations that must
appear in your code (see Section&#XA0;<a href="#effective-qualifier">26.4</a>).
For example, enum types are implicitly non-null, so you never need to write
<span style="font-family:monospace">@NonNull MyEnumType</span>.</p><p>If you want details about implicitly-added nullness qualifiers, see the
implementation of <a href="../api/org/checkerframework/checker/nullness/NullnessAnnotatedTypeFactory.html"><span style="font-family:monospace">NullnessAnnotatedTypeFactory</span></a>.</p>
<!--TOC subsection id="null-defaults" Default annotation-->
<h3 id="null-defaults" class="subsection">3.3.2&#XA0;&#XA0;Default annotation <a href="#null-defaults" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Unannotated references are treated as if they had a default annotation.
The standard defaulting rule is CLIMB-to-top, described in
Section&#XA0;<a href="#climb-to-top">26.5.3</a>. Its effect is to default all types to
<span style="font-family:monospace">@NonNull</span>, except that <span style="font-family:monospace">@Nullable</span> is used for casts, locals,
instanceof, and implicit bounds. A user can choose a different defaulting
rule by writing a <a href="../api/org/checkerframework/framework/qual/DefaultQualifier.html"><span style="font-family:monospace">@DefaultQualifier</span></a> annotation on a
package, class, or method. In the example below, fields are defaulted to
<span style="font-family:monospace">@Nullable</span> instead of <span style="font-family:monospace">@NonNull</span>.</p><pre class="verbatim">@DefaultQualifier(value = Nullable.class, locations = TypeUseLocation.FIELD)
class MyClass {
    Object nullableField = null;
    @NonNull Object nonNullField = new Object();
}
</pre>
<!--TOC subsection id="conditional-nullness" Conditional nullness-->
<h3 id="conditional-nullness" class="subsection">3.3.3&#XA0;&#XA0;Conditional nullness <a href="#conditional-nullness" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The Nullness Checker supports a form of conditional nullness types, via the
<a href="../api/org/checkerframework/checker/nullness/qual/EnsuresNonNullIf.html"><span style="font-family:monospace">@EnsuresNonNullIf</span></a> method annotations.
The annotation on a method declares that some expressions are non-null, if
the method returns true (false, respectively).</p><p>Consider <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Class.html"><span style="font-family:monospace">java.lang.Class</span></a>.
Method
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Class.html#getComponentType--"><span style="font-family:monospace">Class.getComponentType()</span></a>
may return null, but it is specified to return a non-null value if
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Class.html#isArray--"><span style="font-family:monospace">Class.isArray()</span></a> is
true.
You could declare this relationship in the following way (this particular
example is already
done for you in the annotated JDK that comes with the Checker Framework):</p><pre class="verbatim">  class Class&lt;T&gt; {
    @EnsuresNonNullIf(expression="getComponentType()", result=true)
    public native boolean isArray();

    public native @Nullable Class&lt;?&gt; getComponentType();
  }
</pre><p>A client that checks that a <span style="font-family:monospace">Class</span> reference is indeed that of an array,
can then de-reference the result of <span style="font-family:monospace">Class.getComponentType</span> safely
without any nullness check. The Checker Framework source code itself
uses such a pattern:</p><pre class="verbatim">    if (clazz.isArray()) {
      // no possible null dereference on the following line
      TypeMirror componentType = typeFromClass(clazz.getComponentType());
      ...
    }
</pre><p>Another example is <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Queue.html#peek--"><span style="font-family:monospace">Queue.peek</span></a>
and <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Queue.html#poll--"><span style="font-family:monospace">Queue.poll</span></a>, which return
non-null if <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Collection.html#isEmpty--"><span style="font-family:monospace">isEmpty</span></a>
returns false.</p><p>The argument to <span style="font-family:monospace">@EnsuresNonNullIf</span> is a Java expression, including method calls
(as shown above), method formal parameters, fields, etc.; for details, see
Section&#XA0;<a href="#java-expressions-as-arguments">26.8</a>.
More examples of the use of these annotations appear in the Javadoc for
<a href="../api/org/checkerframework/checker/nullness/qual/EnsuresNonNullIf.html"><span style="font-family:monospace">@EnsuresNonNullIf</span></a>.</p>
<!--TOC subsection id="nullness-arrays" Nullness and arrays-->
<h3 id="nullness-arrays" class="subsection">3.3.4&#XA0;&#XA0;Nullness and arrays <a href="#nullness-arrays" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Suppose that you declare an array to contain non-null elements.
Currently, the Nullness Checker does not verify that all the elements of the
array are initialized to a non-null value. This is an unsoundness in the
checker.</p><p>To make the Nullness Checker conservatively reject code that may leave a
non-null value in an array, use the command-line option
<span style="font-family:monospace">-Alint=forbidnonnullarraycomponents</span>. The option is currently disabled
because it makes the checker issue many false positive errors.
</p><p>When the <span style="font-family:monospace">-Alint=forbidnonnullarraycomponents</span> option is supplied,
the following is not allowed:</p><pre class="verbatim">  Object [] oa = new Object[10]; // error
</pre><p>(recall that <span style="font-family:monospace">Object</span> means the same thing as <span style="font-family:monospace">@NonNull Object</span>).</p><p>Instead, your code needs to create a nullable or lazy-nonnull array, initialize
each component, and then assign the result to a non-null array:</p><pre class="verbatim">  @MonotonicNonNull Object [] temp = new @MonotonicNonNull Object[10];
  for (int i = 0; i &lt; temp.length; ++i) {
    temp[i] = new Object();
  }
  @SuppressWarnings("nullness") // temp array is now fully initialized
  @NonNull Object [] oa = temp;
</pre><p>Note that the checker is currently not powerful enough to ensure that
each array component was initialized. Therefore, the last assignment
needs to be trusted: that is, a programmer must verify that it is safe,
then write a <span style="font-family:monospace">@SuppressWarnings</span> annotation.</p>
<!--TOC subsection id="nullness-runtime-checks" Run-time checks for nullness-->
<h3 id="nullness-runtime-checks" class="subsection">3.3.5&#XA0;&#XA0;Run-time checks for nullness <a href="#nullness-runtime-checks" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>When you perform a run-time check for nullness, such as <span style="font-family:monospace">if (x != null)
...</span>, then the Nullness Checker refines the type of <span style="font-family:monospace">x</span> to
<span style="font-family:monospace">@NonNull</span>. The refinement lasts until the end of the scope of the test
or until <span style="font-family:monospace">x</span> may be side-effected. For more details, see
Section&#XA0;<a href="#type-refinement">26.7</a>.</p>
<!--TOC subsection id="nullness-additional-details" Additional details-->
<h3 id="nullness-additional-details" class="subsection">3.3.6&#XA0;&#XA0;Additional details <a href="#nullness-additional-details" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The Nullness Checker does some special checks in certain circumstances, in
order to soundly reduce the number of warnings that it produces.</p><p>For example, a call to
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/System.html#getProperty-java.lang.String-"><span style="font-family:monospace">System.getProperty(String)</span></a>
can return null in general, but it will not return null if the argument is
one of the built-in-keys listed in the documentation of
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/System.html#getProperties--"><span style="font-family:monospace">System.getProperties()</span></a>.
The Nullness Checker is aware of this fact, so you do not have to suppress
a warning for a call like <span style="font-family:monospace">System.getProperty("line.separator")</span>. The
warning is still issued for code like this:</p><pre class="verbatim">  final String s = "line.separator";
  nonNullvar = System.getProperty(s);
</pre><p>though that case could be handled as well, if desired.
(Suppression of the warning is, strictly speaking, not sound, because a
library that your code calls, or your code itself, could perversely change
the system properties; the Nullness Checker assumes this bizarre coding
pattern does not happen.)</p>
<!--TOC subsection id="nullness-inference" Inference of <span style="font-family:monospace">@NonNull</span> and <span style="font-family:monospace">@Nullable</span> annotations-->
<h3 id="nullness-inference" class="subsection">3.3.7&#XA0;&#XA0;Inference of <span style="font-family:monospace">@NonNull</span> and <span style="font-family:monospace">@Nullable</span> annotations <a href="#nullness-inference" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>It can be tedious to write annotations in your code. Tools exist that
can automatically infer annotations and insert them in your source code.
(This is different than type qualifier refinement for local variables
(Section&#XA0;<a href="#type-refinement">26.7</a>), which infers a more specific type for
local variables and uses them during type-checking but does not insert them
in your source code. Type qualifier refinement is always enabled, no
matter how annotations on signatures got inserted in your source code.)</p><p>Your choice of tool depends on what default annotation (see
Section&#XA0;<a href="#null-defaults">3.3.2</a>) your code uses. You only need one of these tools.</p><ul class="itemize"><li class="li-itemize">Inference of <a href="../api/org/checkerframework/checker/nullness/qual/Nullable.html"><span style="font-family:monospace">@Nullable</span></a>:
If your code uses the standard CLIMB-to-top default (Section&#XA0;<a href="#climb-to-top">26.5.3</a>) or
the NonNull default, then use the
<a href="http://plse.cs.washington.edu/daikon/download/doc/daikon.html#AnnotateNullable">AnnotateNullable</a>
tool of the <a href="http://plse.cs.washington.edu/daikon/">Daikon invariant
detector</a>.</li><li class="li-itemize">Inference of <a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a>:
If your code uses the Nullable default, use one of these tools:
<ul class="itemize"><li class="li-itemize">
<a href="https://juliasoft.com/solutions/">Julia analyzer</a>,
</li><li class="li-itemize"><a href="http://nit.gforge.inria.fr">Nit: Nullability Inference Tool</a>,
</li><li class="li-itemize"><a href="http://jastadd.org/jastadd-tutorial-examples/non-null-types-for-java/">Non-null
checker and inferencer</a> of the <a href="http://jastadd.org/">JastAdd
Extensible Compiler</a>.
</li></ul></li></ul>
<!--TOC section id="suppressing-warnings-nullness" Suppressing nullness warnings-->
<h2 id="suppressing-warnings-nullness" class="section">3.4&#XA0;&#XA0;Suppressing nullness warnings <a href="#suppressing-warnings-nullness" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>When the Nullness Checker reports a warning, it&#X2019;s best to change the code
or its annotations, to eliminate the warning. Alternately, you can
suppress the warning, which does not change the code but prevents the
Nullness Checker from reporting this particular warning to you.</p><p>
The Checker Framework supplies several ways to suppress warnings, most
notably the <span style="font-family:monospace">@SuppressWarnings("nullness")</span> annotation (see
Chapter&#XA0;<a href="#suppressing-warnings">27</a>). An example use is
</p><pre class="verbatim">    // might return null
    @Nullable Object getObject(...) { ... }

    void myMethod() {
      @SuppressWarnings("nullness") // with argument x, getObject always returns a non-null value
      @NonNull Object o2 = getObject(x);
</pre><p>The Nullness Checker supports an additional warning suppression key,
<span style="font-family:monospace">nullness:generic.argument</span>.
Use of <span style="font-family:monospace">@SuppressWarnings("nullness:generic.argument")</span> causes the Nullness
Checker to suppress warnings related to misuse of generic type
arguments. One use for this key is when a class is declared to take only
<span style="font-family:monospace">@NonNull</span> type arguments, but you want to instantiate the class with a
<span style="font-family:monospace">@Nullable</span> type argument, as in <span style="font-family:monospace">List&lt;@Nullable Object&gt;</span>.</p><p>The Nullness Checker also permits you to use assertions or method calls to
suppress warnings; see below.</p>
<!--TOC subsection id="suppressing-warnings-with-assertions" Suppressing warnings with assertions and method calls-->
<h3 id="suppressing-warnings-with-assertions" class="subsection">3.4.1&#XA0;&#XA0;Suppressing warnings with assertions and method calls <a href="#suppressing-warnings-with-assertions" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Occasionally, it is inconvenient or
verbose to use the <span style="font-family:monospace">@SuppressWarnings</span> annotation. For example, Java does
not permit annotations such as <span style="font-family:monospace">@SuppressWarnings</span> to appear on statements.
In such cases, you can use the <span style="font-family:monospace">@AssumeAssertion</span> string in
an <span style="font-family:monospace">assert</span> message (see Section&#XA0;<a href="#assumeassertion">27.2</a>).</p><p>If you need to suppress a warning within an expression, then
sometimes writing an assertion is not convenient. In such a case,
you can suppress warnings by writing a call to the
<a href="../api/org/checkerframework/checker/nullness/NullnessUtil.html#castNonNull-T-"><span style="font-family:monospace">NullnessUtil.castNonNull</span></a> method.
The rest of this section discusses the <span style="font-family:monospace">castNonNull</span> method.</p><p>The Nullness Checker considers both the return value, and also the
argument, to be non-null after the <span style="font-family:monospace">castNonNull</span> method call.
The Nullness Checker issues no warnings in any of the following
code:</p><pre class="verbatim">  // One way to use castNonNull as a cast:
  @NonNull String s = castNonNull(possiblyNull1);

  // Another way to use castNonNull as a cast:
  castNonNull(possiblyNull2).toString();

  // It is possible, but not recommmended, to use castNonNull as a statement:
  // (It would be better to write an assert statement with @AssumeAssertion
  // in its message, instead.)
  castNonNull(possiblyNull3);
  possiblyNull3.toString();
</pre><p>The <span style="font-family:monospace">castNonNull</span> method throws <span style="font-family:monospace">AssertionError</span> if Java assertions are enabled and
the argument is <span style="font-family:monospace">null</span>. However, it is not intended for general defensive
programming; see Section&#XA0;<a href="#defensive-programming">27.2.1</a>.</p><p>To use the <span style="font-family:monospace">castNonNull</span> method, the <span style="font-family:monospace">checker-qual.jar</span> file
must be on the classpath at run time.</p><p>
The Nullness Checker introduces a new method, rather than re-using an
existing method such as <span style="font-family:monospace">org.junit.Assert.assertNotNull(Object)</span> or
<span style="font-family:monospace">com.google.common.base.Preconditions.checkNotNull(Object)</span>. Those
methods are commonly used for defensive programming, so it is impossible to
know the programmer&#X2019;s intent when writing them. Therefore, it is important to
have a method call that is used only for warning suppression. See
Section&#XA0;<a href="#defensive-programming">27.2.1</a> for a discussion of
the distinction between warning suppression and defensive programming.
</p>
<!--TOC section id="nullness-example" Examples-->
<h2 id="nullness-example" class="section">3.5&#XA0;&#XA0;Examples <a href="#nullness-example" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END -->
<!--TOC subsection id="nullness-tiny-examples" Tiny examples-->
<h3 id="nullness-tiny-examples" class="subsection">3.5.1&#XA0;&#XA0;Tiny examples <a href="#nullness-tiny-examples" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>To try the Nullness Checker on a source file that uses the <a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a> qualifier,
use the following command (where <span style="font-family:monospace">javac</span> is the Checker Framework compiler that
is distributed with the Checker Framework):</p><pre class="verbatim">  javac -processor org.checkerframework.checker.nullness.NullnessChecker docs/examples/NullnessExample.java
</pre><p>Compilation will complete without warnings.</p><p>To see the checker warn about incorrect usage of annotations (and therefore the
possibility of a null pointer exception at run time), use the following command:</p><div style="font-size:small;">
<pre class="verbatim">  javac -processor org.checkerframework.checker.nullness.NullnessChecker docs/examples/NullnessExampleWithWarnings.java
</pre></div><p>The compiler will issue two warnings regarding violation of the semantics of
<a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a>.
</p>
<!--TOC subsection id="nullness-annotated-library" Example annotated source code-->
<h3 id="nullness-annotated-library" class="subsection">3.5.2&#XA0;&#XA0;Example annotated source code <a href="#nullness-annotated-library" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Some libraries that are annotated with nullness qualifiers are:</p><ul class="itemize"><li class="li-itemize">
The Nullness Checker itself.</li><li class="li-itemize">The Java projects in the <a href="https://github.com/plume-lib/">plume-lib GitHub organization</a>.
Type-checking occurs on each build.</li><li class="li-itemize">The
<a href="http://plse.cs.washington.edu/daikon/">Daikon invariant detector</a>.
Run the command <span style="font-family:monospace">make check-nullness</span>.</li></ul>
<!--TOC section id="nullness-getting-started" Tips for getting started-->
<h2 id="nullness-getting-started" class="section">3.6&#XA0;&#XA0;Tips for getting started <a href="#nullness-getting-started" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>Here are some tips about getting started using the Nullness Checker on a
legacy codebase. For more generic advice (not specific to the Nullness
Checker), see Section&#XA0;<a href="#get-started-with-legacy-code">2.4.2</a>.</p><p>Your goal is to add <a href="../api/org/checkerframework/checker/nullness/qual/Nullable.html"><span style="font-family:monospace">@Nullable</span></a> annotations
to the types of any variables that can be null. (The default is to assume
that a variable is non-null unless it has a <span style="font-family:monospace">@Nullable</span> annotation.)
Then, you will run the Nullness Checker. Each of its errors indicates
either a possible null pointer exception, or a wrong/missing annotation.
When there are no more warnings from the checker, you are done!</p><p>We recommend that you start by searching the code for occurrences of
<span style="font-family:monospace">null</span> in the following locations; when you find one, write the
corresponding annotation:</p><ul class="itemize"><li class="li-itemize">
in Javadoc: add <span style="font-family:monospace">@Nullable</span> annotations to method signatures (parameters and return types).
</li><li class="li-itemize"><span style="font-family:monospace">return null</span>: add a <span style="font-family:monospace">@Nullable</span> annotation to the return type
of the given method.
</li><li class="li-itemize"><span style="font-family:monospace"><em>param</em></span><span style="font-family:monospace"> == null</span>: when a formal parameter is compared to
<span style="font-family:monospace">null</span>, then in most cases you can add a <span style="font-family:monospace">@Nullable</span> annotation
to the formal parameter&#X2019;s type
</li><li class="li-itemize"><span style="font-family:monospace"><em>TypeName</em></span><span style="font-family:monospace"> </span><span style="font-family:monospace"><em>field</em></span><span style="font-family:monospace"> = null;</span>: when a field is initialized to
<span style="font-family:monospace">null</span> in its declaration, then it needs either a
<a href="../api/org/checkerframework/checker/nullness/qual/Nullable.html"><span style="font-family:monospace">@Nullable</span></a> or a
<a href="../api/org/checkerframework/checker/nullness/qual/MonotonicNonNull.html"><span style="font-family:monospace">@MonotonicNonNull</span></a> annotation. If the field
is always set to a non-null value in the constructor, then you can just
change the declaration to <span style="font-family:monospace"><em>Type</em></span><span style="font-family:monospace"> </span><span style="font-family:monospace"><em>field</em></span><span style="font-family:monospace">;</span>, without an
initializer, and write no type annotation (because the default is
<span style="font-family:monospace">@NonNull</span>).
</li><li class="li-itemize">declarations of <span style="font-family:monospace">contains</span>, <span style="font-family:monospace">containsKey</span>, <span style="font-family:monospace">containsValue</span>, <span style="font-family:monospace">equals</span>,
<span style="font-family:monospace">get</span>, <span style="font-family:monospace">indexOf</span>, <span style="font-family:monospace">lastIndexOf</span>, and <span style="font-family:monospace">remove</span> (with <span style="font-family:monospace">Object</span> as the
argument type):
change the argument type to <span style="font-family:monospace">@Nullable Object</span>; for <span style="font-family:monospace">remove</span>, also change
the return type to <span style="font-family:monospace">@Nullable Object</span>.
</li></ul><p>You should ignore all other occurrences of <span style="font-family:monospace">null</span> within a method
body. In particular, you rarely need to annotate local variables
(except their type arguments or array element types).</p><p>Only after this step should you run
the Nullness Checker. The reason is that it is quicker to search for
places to change than to repeatedly run the checker and fix the errors it
tells you about, one at a time.</p><p>Here are some other tips:
</p><ul class="itemize"><li class="li-itemize">

In any file where you write an annotation such as <span style="font-family:monospace">@Nullable</span>,
don&#X2019;t forget to add <span style="font-family:monospace">import org.checkerframework.checker.nullness.qual.*;</span>.

</li><li class="li-itemize">To indicate an array that can be null, write, for example: <span style="font-family:monospace">int
@Nullable []</span>. <br>
 By contrast, <span style="font-family:monospace">@Nullable Object []</span> means a non-null array that
contains possibly-null objects.
</li><li class="li-itemize">If you know that a particular variable is definitely not null, but the
Nullness Checker estimates that the variable might be null, then you can
make the Nullness Checker trust your judgment by writing
an assertion (see Section&#XA0;<a href="#assumeassertion">27.2</a>):
<pre class="verbatim">assert var != null : "@AssumeAssertion(nullness)";
</pre></li><li class="li-itemize">To indicate that a routine returns the same value every time it is
called, use <a href="../api/org/checkerframework/dataflow/qual/Pure.html"><span style="font-family:monospace">@Pure</span></a> (see Section&#XA0;<a href="#type-refinement-purity">26.7.5</a>).
</li><li class="li-itemize">To indicate a method precondition (a contract stating the conditions
under which a client is allowed to call it), you can use annotations
such as <a href="../api/org/checkerframework/checker/nullness/qual/RequiresNonNull.html"><span style="font-family:monospace">@RequiresNonNull</span></a> (see Section&#XA0;<a href="#nullness-method-annotations">3.2.2</a>).
</li></ul>
<!--TOC section id="nullness-related-work" Other tools for nullness checking-->
<h2 id="nullness-related-work" class="section">3.7&#XA0;&#XA0;Other tools for nullness checking <a href="#nullness-related-work" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The Checker Framework&#X2019;s nullness annotations are similar to annotations used
in other
tools.
You might prefer to use the Checker Framework because it has a more
powerful analysis that can warn you about more null pointer errors in your
code.
Most of the other tools are bug-finding tools rather than verification tools, since they
give up precision, soundness, or both in favor of being fast and
easy to use. Also
see Section&#XA0;<a href="#faq-type-checking-vs-bug-detectors">33.10.1</a> for a comparison to other tools.</p><p>If your code is already annotated with a different nullness
annotation, the Checker Framework can type-check your code.
It treats annotations from other tools
as if you had written the corresponding annotation from the
Nullness Checker, as described in Figure&#XA0;<a href="#fig-nullness-refactoring">3.2</a>.
If the other annotation is a declaration annotation, it may be moved; see
Section&#XA0;<a href="#declaration-annotations-moved">28.1.1</a>.</p><blockquote class="figure"><div class="center"><hr style="width:80%;height:2"></div>
<div class="center">
<table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="text-align:left;white-space:nowrap" ><table border=1  style="border-spacing:0;" class="cellpadding1"><tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;android.annotation.NonNull&#XA0; </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;android.support.annotation.NonNull&#XA0; </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;androidx.annotation.NonNull&#XA0; </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;androidx.annotation.RecentlyNonNull&#XA0; </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;com.sun.istack.internal.NotNull&#XA0; </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;edu.umd.cs.findbugs.annotations.NonNull&#XA0; </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;io.reactivex.annotations.NonNull&#XA0; </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;javax.annotation.Nonnull&#XA0; </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;javax.validation.constraints.NotNull&#XA0; </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;lombok.NonNull&#XA0; </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;org.checkerframework.checker.nullness.compatqual.NonNullDecl&#XA0; </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;org.checkerframework.checker.nullness.compatqual.NonNullType&#XA0; </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;org.eclipse.jdt.annotation.NonNull&#XA0; </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;org.eclipse.jgit.annotations.NonNull&#XA0; </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;org.jetbrains.annotations.NotNull&#XA0; </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;org.jmlspecs.annotation.NonNull&#XA0; </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;org.netbeans.api.annotations.common.NonNull&#XA0; </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;org.springframework.lang.NonNull&#XA0; </td></tr>
</table></td><td style="text-align:left;white-space:nowrap" >&#X21D2;
&#XA0;org.checkerframework.checker.nullness.qual.NonNull&#XA0;
</td></tr>
<tr><td style="text-align:left;white-space:nowrap" >&nbsp;</td></tr>
<tr><td style="text-align:left;white-space:nowrap" ><table border=1  style="border-spacing:0;" class="cellpadding1"><tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;android.annotation.Nullable&#XA0; </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;android.support.annotation.Nullable&#XA0; </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;androidx.annotation.Nullable&#XA0; </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;androidx.annotation.RecentlyNullable&#XA0; </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;com.sun.istack.internal.Nullable&#XA0; </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;edu.umd.cs.findbugs.annotations.Nullable&#XA0; </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;edu.umd.cs.findbugs.annotations.CheckForNull&#XA0; </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;edu.umd.cs.findbugs.annotations.PossiblyNull&#XA0; </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;edu.umd.cs.findbugs.annotations.UnknownNullness&#XA0; </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;io.reactivex.annotations.Nullable&#XA0; </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;javax.annotation.Nullable&#XA0; </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;javax.annotation.CheckForNull&#XA0; </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;org.checkerframework.checker.nullness.compatqual.NullableDecl&#XA0; </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;org.checkerframework.checker.nullness.compatqual.NullableType&#XA0; </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;org.eclipse.jdt.annotation.Nullable&#XA0; </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;org.eclipse.jgit.annotations.Nullable&#XA0; </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;org.jetbrains.annotations.Nullable&#XA0; </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;org.jmlspecs.annotation.Nullable&#XA0; </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;org.netbeans.api.annotations.common.NullAllowed&#XA0; </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;org.netbeans.api.annotations.common.CheckForNull&#XA0; </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;org.netbeans.api.annotations.common.NullUnknown&#XA0; </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;org.springframework.lang.Nullable&#XA0; </td></tr>
</table></td><td style="text-align:left;white-space:nowrap" >&#X21D2;
&#XA0;org.checkerframework.checker.nullness.qual.Nullable&#XA0;
</td></tr>
</table>
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 3.2: Correspondence between other nullness annotations and the
Checker Framework&#X2019;s annotations.</td></tr>
</table></div>
<a id="fig-nullness-refactoring"></a>
<div class="center"><hr style="width:80%;height:2"></div></blockquote><p>The Checker Framework may issue more or fewer errors than another tool.
This is expected, since each tool uses a different analysis. Remember that
the Checker Framework aims at soundness: it aims to never miss a possible
null dereference, while at the same time limiting false reports. Also,
note FindBugs&#X2019;s non-standard meaning for <span style="font-family:monospace">@Nullable</span>
(Section&#XA0;<a href="#findbugs-nullable">3.7.2</a>).</p><p>Java permits you to import at most one annotation of a given name. For
example, if you use both <span style="font-family:monospace">android.annotation.NonNull</span> and
<span style="font-family:monospace">lombok.NonNull</span> in your source code, then you must write at least one of
them in fully-qualified form, as <span style="font-family:monospace">@android.annotation.NonNull</span> rather than
as <span style="font-family:monospace">@NonNull</span>.</p>
<!--TOC subsection id="choosing-nullness-tool" Which tool is right for you?-->
<h3 id="choosing-nullness-tool" class="subsection">3.7.1&#XA0;&#XA0;Which tool is right for you? <a href="#choosing-nullness-tool" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Different tools are appropriate in different circumstances. Here is a
brief comparison with FindBugs, but similar points apply to other tools.
(For example, the <a href="https://github.com/uber/NullAway">NullAway</a> and
<a href="https://fbinfer.com/docs/eradicate.html">Eradicate</a> tools are more
like sound type-checking than FindBugs, but all of those tools accept
unsoundness &#X2014; that is, false negatives or missed warnings &#X2014; in exchange
for analysis speed.)</p><p>The Checker Framework has a more powerful nullness analysis; FindBugs misses
some real
errors. FindBugs requires you to annotate your code, but usually not as
thoroughly as the Checker Framework does. Depending on the importance of
your code, you may desire: no nullness checking, the cursory checking of
FindBugs, or the thorough checking of the Checker Framework. You might
even want to ensure that both tools run, for example if your coworkers or
some other organization are still using FindBugs. If you know that you
will eventually want to use the Checker Framework, there is no point using
FindBugs first; it is easier to go straight to using the Checker Framework.</p><p>FindBugs can find other errors in addition to nullness errors; here
we focus on its nullness checks. Even if you use FindBugs for its other
features, you may want to use the Checker Framework for analyses that can
be expressed as pluggable type-checking, such as detecting nullness errors.</p><p>Regardless of whether you wish to use the FindBugs nullness analysis, you
may continue running all of the other FindBugs analyses at the same time as
the Checker Framework; there are no interactions among them.</p><p>If FindBugs (or any other tool) discovers a nullness error that the Checker
Framework does not, please report it to us (see
Section&#XA0;<a href="#reporting-bugs">34.2</a>) so that we can enhance the Checker Framework.</p>
<!--TOC subsection id="findbugs-nullable" Incompatibility note about FindBugs <span style="font-family:monospace">@Nullable</span>-->
<h3 id="findbugs-nullable" class="subsection">3.7.2&#XA0;&#XA0;Incompatibility note about FindBugs <span style="font-family:monospace">@Nullable</span><span style="font-family:monospace"> </span><a href="#findbugs-nullable"><span style="font-family:monospace"><span style="font-size:small">&#X1F517;</span></span></a></h3><!--SEC END --><p>FindBugs has a non-standard definition of <span style="font-family:monospace">@Nullable</span>. FindBugs&#X2019;s treatment is not
documented in its own
<a href="http://findbugs.sourceforge.net/api/edu/umd/cs/findbugs/annotations/Nullable.html">Javadoc</a>;
it is different from the definition of <span style="font-family:monospace">@Nullable</span> in every other tool for
nullness analysis; it means the same thing as <span style="font-family:monospace">@NonNull</span> when applied to a
formal parameter; and it invariably surprises programmers. Thus, FindBugs&#X2019;s
<span style="font-family:monospace">@Nullable</span> is detrimental rather than useful as documentation.
In practice, your best bet is to not rely on FindBugs for nullness analysis,
even if you find FindBugs useful for other purposes.</p><p>You can skip the rest of this section unless you wish to learn more details.</p><p>FindBugs suppresses all warnings at uses of a <span style="font-family:monospace">@Nullable</span> variable.
(You have to use <span style="font-family:monospace">@CheckForNull</span> to
indicate a nullable variable that FindBugs should check.) For example:</p><pre class="verbatim">     // declare getObject() to possibly return null
     @Nullable Object getObject() { ... }

     void myMethod() {
       @Nullable Object o = getObject();
       // FindBugs issues no warning about calling toString on a possibly-null reference!
       o.toString();
     }
</pre><p>The Checker Framework does not emulate this non-standard behavior of
FindBugs, even if the code uses FindBugs annotations.</p><p>With FindBugs, you annotate a declaration, which suppresses checking at
<em>all</em> client uses, even the places that you want to check.
It is better to suppress warnings at only the specific client uses
where the value is known to be non-null; the Checker Framework supports
this, if you write <span style="font-family:monospace">@SuppressWarnings</span> at the client uses.
The Checker Framework also supports suppressing checking at all client uses,
by writing a <span style="font-family:monospace">@SuppressWarnings</span> annotation at the declaration site.
Thus, the Checker Framework supports both use cases, whereas FindBugs
supports only one and gives the programmer less flexibility.</p><p>In general, the Checker Framework will issue more warnings than FindBugs,
and some of them may be about real bugs in your program.
See Section&#XA0;<a href="#suppressing-warnings-nullness">3.4</a> for information about
suppressing nullness warnings.</p><p>(FindBugs made a poor choice of names. The choice of names should make a
clear distinction between annotations that specify whether a reference is
null, and annotations that suppress false warnings. The choice of names
should also have been consistent for other tools, and intuitively clear to
programmers. The FindBugs choices make the FindBugs annotations less
helpful to people, and much less useful for other tools. As a separate
issue, the FindBugs
analysis is also very imprecise. For type-related analyses, it is best to
stay away from the FindBugs nullness annotations, and use a more capable
tool like the Checker Framework.)</p>
<!--TOC subsection id="nullness-vs-optional" Relationship to <span style="font-family:monospace">Optional&lt;T&gt;</span>-->
<h3 id="nullness-vs-optional" class="subsection">3.7.3&#XA0;&#XA0;Relationship to <span style="font-family:monospace">Optional&lt;T&gt;</span><span style="font-family:monospace"> </span><a href="#nullness-vs-optional"><span style="font-family:monospace"><span style="font-size:small">&#X1F517;</span></span></a></h3><!--SEC END --><p>Many null pointer exceptions occur because the programmer forgets to check
whether a reference is null before dereferencing it. Java 8&#X2019;s
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html"><span style="font-family:monospace">Optional&lt;T&gt;</span></a>
class provides a partial solution: a programmer must call the <span style="font-family:monospace">get</span> method to
access the value, and the designers of <span style="font-family:monospace">Optional</span> hope that the syntactic
occurrence of the <span style="font-family:monospace">get</span> method will remind programmers to first check that
the value is present. This is still easy to forget, however.</p><p>The Checker Framework contains an Optional Checker (see
Chapter&#XA0;<a href="#optional-checker">5</a>) that guarantees that programmers use
<span style="font-family:monospace">Optional</span> correctly, such as calling <span style="font-family:monospace">isPresent</span> before calling <span style="font-family:monospace">get</span>.</p><p>There are some limitations to the utility of <span style="font-family:monospace">Optional</span>, which might
lead to you choose to use regular Java references rather than <span style="font-family:monospace">Optional</span>.
(For more details, see the article
<a href="https://homes.cs.washington.edu/~mernst/advice/nothing-is-better-than-optional.html">&#X201C;Nothing
is better than the <span style="font-family:monospace">Optional</span> type&#X201D;</a>.)</p><ul class="itemize"><li class="li-itemize">
It is still possible to call <span style="font-family:monospace">get</span> on a non-present <span style="font-family:monospace">Optional</span>, leading
to a <span style="font-family:monospace">NoSuchElementException</span>. In other words, <span style="font-family:monospace">Optional</span>
doesn&#X2019;t solve the underlying problem &#X2014; it merely converts a
<span style="font-family:monospace">NullPointerException</span> into a <span style="font-family:monospace">NoSuchElementException</span>
exception, and in either case your code crashes.
</li><li class="li-itemize"><span style="font-family:monospace">NullPointerException</span> is still possible in code that uses <span style="font-family:monospace">Optional</span>.
</li><li class="li-itemize"><span style="font-family:monospace">Optional</span> adds syntactic complexity, making your code longer and harder to
read.
</li><li class="li-itemize"><span style="font-family:monospace">Optional</span> adds time and space overhead.
</li><li class="li-itemize"><span style="font-family:monospace">Optional</span> does not address important sources of null pointer
exceptions, such as partially-initialized objects and calls to <span style="font-family:monospace">Map.get</span>.
</li></ul><p>The Nullness Checker does not suffer these limitations. Furthermore, it
works with existing code and types, it ensures that you check for null
wherever necessary, and it infers when the check for null is not necessary
based on previous statements in the method.</p><p>Java&#X2019;s <span style="font-family:monospace">Optional</span> class provides utility routines to reduce clutter when
using <span style="font-family:monospace">Optional</span>. The Nullness Checker provides an
<a href="../api/org/checkerframework/checker/nullness/Opt.html"><span style="font-family:monospace">Opt</span></a> class that provides all the same methods,
but written for regular possibly-null Java references.</p>
<!--TOC section id="initialization-checker" Initialization Checker-->
<h2 id="initialization-checker" class="section">3.8&#XA0;&#XA0;Initialization Checker <a href="#initialization-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The Initialization Checker determines whether an object is initialized or
not. For any object that is not fully initialized, the Nullness Checker
treats its fields as possibly-null &#X2014; even fields annotated as
<span style="font-family:monospace">@NonNull</span>.</p><p>Every object&#X2019;s fields start out as null. By the time the constructor
finishes executing, the <span style="font-family:monospace">@NonNull</span> fields have been set to a different
value. Your code can suffer a NullPointerException when using a
<span style="font-family:monospace">@NonNull</span> field, if your code uses the field during initialization.
The Nullness Checker prevents this problem by warning you anytime that you
may be accessing an uninitialized field. This check is useful because it
prevents errors in your code. However, the analysis can be confusing to
understand. If you wish to disable the initialization checks, pass the
command-line argument <span style="font-family:monospace">-AsuppressWarnings=uninitialized</span> when running the
Nullness Checker. You will no longer get a guarantee of no null pointer
exceptions, but you can still use the Nullness Checker to find most of the
null pointer problems in your code.</p><p>An object is partially initialized from the time that its constructor starts until its constructor
finishes. This is relevant to the Nullness Checker because while the
constructor is executing &#X2014; that is, before initialization completes &#X2014;
a <span style="font-family:monospace">@NonNull</span>
field may be observed to be null, until that field is set. In
particular, the Nullness Checker issues a warning for code like this:</p><pre class="verbatim">  public class MyClass {
    private @NonNull Object f;
    public MyClass(int x) {
      // Error because constructor contains no assignment to this.f.
      // By the time the constructor exits, f must be initialized to a non-null value.
    }
    public MyClass(int x, int y) {
      // Error because this.f is accessed before f is initialized.
      // At the beginning of the constructor's execution, accessing this.f
      // yields null, even though field f has a non-null type.
      this.f.toString();
      f = new Object();
    }
    public MyClass(int x, int y, int z) {
      m();
      f = new Object();
    }
    public void m() {
      // Error because this.f is accessed before f is initialized,
      // even though the access is not in a constructor.
      // When m is called from the constructor, accessing f yields null,
      // even though field f has a non-null type.
      this.f.toString();
    }
</pre><p>When a field <span style="font-family:monospace">f</span> is declared with a <a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a>
type, then code can depend on the fact that the field is not <span style="font-family:monospace">null</span>.
However, this guarantee does not hold for a partially-initialized object.</p><p>The Nullness Checker uses three annotations to indicate whether an object
is initialized (all its <span style="font-family:monospace">@NonNull</span> fields have been assigned), under
initialization (its constructor is currently executing), or its
initialization state is unknown.</p><p>These distinctions are mostly relevant within the constructor, or for
references to <span style="font-family:monospace">this</span> that escape the constructor (say, by being stored
in a field or passed to a method before initialization is complete).
Use of initialization annotations is rare in most code.</p>
<!--TOC subsection id="initialization-qualifiers" Initialization qualifiers-->
<h3 id="initialization-qualifiers" class="subsection">3.8.1&#XA0;&#XA0;Initialization qualifiers <a href="#initialization-qualifiers" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><blockquote class="figure"><div class="center"><hr style="width:80%;height:2"></div>
<div class="center">
<img src="initialization.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 3.3: Partial type hierarchy for the Initialization type system.
<span style="font-family:monospace">@UnknownInitialization</span> and <span style="font-family:monospace">@UnderInitialization</span> each take an
optional parameter indicating how far initialization has proceeded, and
the right side of the figure illustrates its type hierarchy in more detail.</td></tr>
</table></div>
<a id="fig-initialization-hierarchy"></a>
<div class="center"><hr style="width:80%;height:2"></div></blockquote><p>The initialization hierarchy is shown in Figure&#XA0;<a href="#fig-initialization-hierarchy">3.3</a>.
The initialization hierarchy contains these qualifiers:</p><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/initialization/qual/Initialized.html"><span style="font-weight:bold"><span style="font-family:monospace">@Initialized</span></span></a></dt><dd class="dd-description">
indicates a type that contains a fully-initialized object. <span style="font-family:monospace">Initialized</span>
is the default, so there is little need for a programmer to write this
explicitly.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/initialization/qual/UnknownInitialization.html"><span style="font-weight:bold"><span style="font-family:monospace">@UnknownInitialization</span></span></a></dt><dd class="dd-description">
indicates a type that may contain a partially-initialized object. In a
partially-initialized object, fields that are annotated as
<a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a> may be null because the field
has not yet been assigned.<p><span style="font-family:monospace">@UnknownInitialization</span> takes a parameter that is the class the object
is definitely initialized up to. For instance, the type
<span style="font-family:monospace">@UnknownInitialization(Foo.class)</span> denotes an object in which every
fields declared in <span style="font-family:monospace">Foo</span> or its superclasses is initialized, but other
fields might not be.
Just <span style="font-family:monospace">@UnknownInitialization</span> is equivalent to
<span style="font-family:monospace">@UnknownInitialization(Object.class)</span>.</p></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/initialization/qual/UnderInitialization.html"><span style="font-weight:bold"><span style="font-family:monospace">@UnderInitialization</span></span></a></dt><dd class="dd-description">
indicates a type that contains a partially-initialized object that is
under initialization &#X2014; that is, its constructor is currently executing.
It is otherwise the same as <span style="font-family:monospace">@UnknownInitialization</span>. Within the
constructor, <span style="font-family:monospace">this</span> has
<a href="../api/org/checkerframework/checker/initialization/qual/UnderInitialization.html"><span style="font-family:monospace">@UnderInitialization</span></a> type until
all the <span style="font-family:monospace">@NonNull</span> fields have been assigned.</dd></dl><p>A partially-initialized object (<span style="font-family:monospace">this</span> in a constructor) may be
passed to a helper method or stored in a variable; if so, the method
receiver, or the field, would have to be annotated as
<span style="font-family:monospace">@UnknownInitialization</span> or as <span style="font-family:monospace">@UnderInitialization</span>.</p><p>If a reference has
<span style="font-family:monospace">@UnknownInitialization</span> or <span style="font-family:monospace">@UnderInitialization</span> type, then all of its <span style="font-family:monospace">@NonNull</span> fields are treated as
<a href="../api/org/checkerframework/checker/nullness/qual/MonotonicNonNull.html"><span style="font-family:monospace">@MonotonicNonNull</span></a>: when read, they are
treated as being <a href="../api/org/checkerframework/checker/nullness/qual/Nullable.html"><span style="font-family:monospace">@Nullable</span></a>, but when
written, they are treated as being
<a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a>.</p><p>
The initialization hierarchy is orthogonal to the nullness hierarchy. It
is legal for a reference to be <span style="font-family:monospace">@NonNull @UnderInitialization</span>, <span style="font-family:monospace">@Nullable @UnderInitialization</span>,
<span style="font-family:monospace">@NonNull @Initialized</span>, or <span style="font-family:monospace">@Nullable @Initialized</span>. The nullness hierarchy tells
you about the reference itself: might the reference be null? The initialization
hierarchy tells you about the <span style="font-family:monospace">@NonNull</span> fields in the referred-to object:
might those fields be temporarily null in contravention of their
type annotation?
Figure&#XA0;<a href="#fig-initialization-examples">3.4</a> contains some examples.
</p><blockquote class="figure"><div class="center"><hr style="width:80%;height:2"></div>
<table border=1  style="border-spacing:0;" class="cellpadding1"><tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >Declarations</td><td style="text-align:left;border:solid 1px;white-space:nowrap" >Expression</td><td style="text-align:left;border:solid 1px;white-space:nowrap" >Expression&#X2019;s nullness type, or checker error </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" ><div class="minipage">
<pre class="verbatim">class C {
  @NonNull Object f;
  @Nullable Object g;
  ...
}
</pre></div></td><td style="text-align:left;border:solid 1px;white-space:nowrap" >&nbsp;</td><td style="text-align:left;border:solid 1px;white-space:nowrap" >&nbsp;</td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">@NonNull @Initialized C a;</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">a</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">@NonNull</span> </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >&nbsp;</td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">a.f</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">@NonNull</span> </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >&nbsp;</td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">a.g</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">@Nullable</span> </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">@NonNull @UnderInitialization C b;</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">b</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">@NonNull</span> </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >&nbsp;</td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">b.f</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">@MonotonicNonNull</span> </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >&nbsp;</td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">b.g</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">@Nullable</span> </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">@Nullable @Initialized C c;</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">c</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">@Nullable</span> </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >&nbsp;</td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">c.f</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" >error: deref of nullable </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >&nbsp;</td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">c.g</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" >error: deref of nullable </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">@Nullable @UnderInitialization C d;</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">d</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">@Nullable</span> </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >&nbsp;</td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">d.f</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" >error: deref of nullable </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >&nbsp;</td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">d.g</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" >error: deref of nullable </td></tr>
</table>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 3.4: Examples of the interaction between nullness and initialization.
Declarations are shown at the left for reference, but the focus of the
table is the expressions and their nullness type or error.</td></tr>
</table></div>
<a id="fig-initialization-examples"></a>
<div class="center"><hr style="width:80%;height:2"></div></blockquote>
<!--TOC subsection id="becoming-initialized" How an object becomes initialized-->
<h3 id="becoming-initialized" class="subsection">3.8.2&#XA0;&#XA0;How an object becomes initialized <a href="#becoming-initialized" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Within the constructor,
<span style="font-family:monospace">this</span> starts out with <a href="../api/org/checkerframework/checker/initialization/qual/UnderInitialization.html"><span style="font-family:monospace">@UnderInitialization</span></a> type.
As soon as all of the <a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a> fields
in class <span style="font-style:italic">C</span> have been initialized, then <span style="font-family:monospace">this</span> is treated as
<a href="../api/org/checkerframework/checker/initialization/qual/UnderInitialization.html"><span style="font-family:monospace">@UnderInitialization</span></a><span style="font-family:monospace">(</span><span style="font-family:monospace"><em>C</em></span><span style="font-family:monospace">)</span>.
This means that <span style="font-family:monospace">this</span> is still being initialized, but all
initialization of <span style="font-style:italic">C</span>&#X2019;s fields is complete, including all fields of supertypes.
Eventually, when all constructors complete, the type is
<a href="../api/org/checkerframework/checker/initialization/qual/Initialized.html"><span style="font-family:monospace">@Initialized</span></a>.</p><p>The Initialization Checker issues an error if the constructor fails to initialize
any <span style="font-family:monospace">@NonNull</span> field. This ensures that the object is in a legal (initialized)
state by the time that the constructor exits.
This is different than Java&#X2019;s test for definite assignment (see
<a href="https://docs.oracle.com/javase/specs/jls/se10/html/jls-16.html">JLS ch.16</a>),
which does not apply to fields (except blank final ones, defined in
<a href="https://docs.oracle.com/javase/specs/jls/se10/html/jls-4.html#jls-4.12.4">JLS &#XA7;4.12.4</a>) because fields
have a default value of null.</p><p>All <span style="font-family:monospace">@NonNull</span> fields must either have a
default in the field declaration, or be assigned in the constructor or in a
helper method that the constructor calls. If
your code initializes (some) fields in a helper method, you will need to
annotate the helper method with an annotation such as
<a href="../api/org/checkerframework/checker/nullness/qual/EnsuresNonNull.html"><span style="font-family:monospace">@EnsuresNonNull</span></a><span style="font-family:monospace">({"field1", "field2"})</span>
for all the fields that the helper method assigns.</p>
<!--TOC subsection id="underinitialization-examples" <span style="font-family:monospace">@UnderInitialization</span> examples-->
<h3 id="underinitialization-examples" class="subsection">3.8.3&#XA0;&#XA0;<span style="font-family:monospace">@UnderInitialization</span> examples <a href="#underinitialization-examples" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The most common use for the <span style="font-family:monospace">@UnderInitialization</span> annotation is for a
helper routine that is called by constructor. For example:</p><pre class="verbatim">  class MyClass {
    Object field1;
    Object field2;
    Object field3;

    public MyClass(String arg1) {
      this.field1 = arg1;
      init_other_fields();
    }

    // A helper routine that initializes all the fields other than field1.
    @EnsuresNonNull({"field2", "field3"})
    private void init_other_fields(@UnderInitialization(Object.class) MyClass this) {
      field2 = new Object();
      field3 = new Object();
    }

    public MyClass(String arg1, String arg2, String arg3) {
      this.field1 = arg1;
      this.field2 = arg2;
      this.field3 = arg3;
      checkRep();
    }

    // Verify that the representation invariants are satisfied.
    // Works as long as the MyClass fields are initialized, even if the receiver's
    // class is a subclass of MyClass and not all of the subclass fields are initialized.
    private void checkRep(@UnderInitialization(MyClass.class) MyClass this) {
      ...
    }


  }
</pre><p>At the end of the constructor, <span style="font-family:monospace">this</span> is not fully initialized. Rather,
it is <span style="font-family:monospace">@UnderInitialization(</span><span style="font-family:monospace"><em>CurrentClass.class</em></span><span style="font-family:monospace">)</span>.
The reason is that there might be subclasses with uninitialized fields.
The following example illustrates this:</p><pre class="verbatim">class A {
   @NonNull String a;
   public A() {
       a = "";
       // Now, all fields of A are initialized.
       // However, if this constructor is invoked as part of 'new B()', then
       // the fields of B are not yet initialized.
       // If we would type 'this' as @Initialized, then the following call is valid:
       foo();
   }
   void foo() {}
}

class B extends A {
   @NonNull String b;
   @Override
   void foo() {
       // Dereferencing 'b' is ok, since 'this' is @Initialized and 'b' @NonNull.
       // However, when executing 'new B()', this line throws a null-pointer exception.
       b.toString();
   }
}
</pre>
<!--TOC subsection id="partial-initialization" Partial initialization-->
<h3 id="partial-initialization" class="subsection">3.8.4&#XA0;&#XA0;Partial initialization <a href="#partial-initialization" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>So far, we have discussed initialization as if it is an all-or-nothing property:
an object is non-initialized until initialization completes, and then it is initialized. The full truth is a bit more complex: during the
initialization process an object can be partially initialized, and as the
object&#X2019;s superclass constructors complete, its initialization status is updated. The
Initialization Checker lets you express such properties when necessary.</p><p>Consider a simple example:</p><pre class="verbatim">class A {
  Object aField;
  A() {
    aField = new Object();
  }
}
class B extends A {
  Object bField;
  B() {
    super();
    bField = new Object();
  }
}
</pre><p>Consider what happens during execution of <span style="font-family:monospace">new B()</span>.</p><ol class="enumerate" type=1><li class="li-enumerate">
<span style="font-family:monospace">B</span>&#X2019;s constructor begins to execute. At this point, neither the
fields of <span style="font-family:monospace">A</span> nor those of <span style="font-family:monospace">B</span> have been initialized yet.
</li><li class="li-enumerate"><span style="font-family:monospace">B</span>&#X2019;s constructor calls <span style="font-family:monospace">A</span>&#X2019;s constructor, which begins to execute.
No fields of <span style="font-family:monospace">A</span> nor of <span style="font-family:monospace">B</span> have been initialized yet.
</li><li class="li-enumerate"><span style="font-family:monospace">A</span>&#X2019;s constructor completes. Now, all the fields of <span style="font-family:monospace">A</span> have been
initialized, and their invariants (such as that field <span style="font-family:monospace">a</span> is non-null) can be
depended on. However, because <span style="font-family:monospace">B</span>&#X2019;s constructor has not yet completed
executing, the object being constructed is not yet fully initialized.
When treated as an <span style="font-family:monospace">A</span> (e.g., if only the <span style="font-family:monospace">A</span> fields are accessed), the
object is initialized, but when treated as a <span style="font-family:monospace">B</span>, the object
is still non-initialized.
</li><li class="li-enumerate"><span style="font-family:monospace">B</span>&#X2019;s constructor completes. The object is initialized when treated
as an <span style="font-family:monospace">A</span> or a <span style="font-family:monospace">B</span>. (And, the object is fully initialized
if <span style="font-family:monospace">B</span>&#X2019;s constructor was invoked via a <span style="font-family:monospace">new B()</span>. But the type system
cannot assume that &#X2014; there might be a <span style="font-family:monospace">class C extends B {
... }</span>, and <span style="font-family:monospace">B</span>&#X2019;s constructor might have been invoked from that.)
</li></ol><p>At any moment during initialization, the superclasses of a given class
can be divided into those that have completed initialization and those that
have not yet completed initialization. More precisely, at any moment there
is a point in the class hierarchy such that all the classes above that
point are fully initialized, and all those below it are not yet
initialized. As initialization proceeds, this dividing line between the
initialized and uninitialized classes moves down the type hierarchy.</p><p>The Nullness Checker lets you indicate where the dividing line is between
the initialized and non-initialized classes.
The <span style="font-family:monospace">@UnderInitialization(</span><span style="font-family:monospace"><em>classliteral</em></span><span style="font-family:monospace">)</span>
indicates the first class that is known to be fully initialized.
When you write <a href="../api/org/checkerframework/checker/initialization/qual/UnderInitialization.html"><span style="font-family:monospace">@UnderInitialization</span></a><span style="font-family:monospace">(OtherClass.class) MyClass x;</span>, that
means that variable <span style="font-family:monospace">x</span> is initialized for <span style="font-family:monospace">OtherClass</span> and its
superclasses, and <span style="font-family:monospace">x</span> is (possibly) uninitialized for <span style="font-family:monospace">MyClass</span> and all subclasses.</p><p>The example above lists 4 moments during construction. At those moments,
the type of the object being constructed is:</p><ol class="enumerate" type=1><li class="li-enumerate">
<span style="font-family:monospace">@UnderInitialization B</span>
</li><li class="li-enumerate"><span style="font-family:monospace">@UnderInitialization A</span>
</li><li class="li-enumerate"><span style="font-family:monospace">@UnderInitialization(A.class) A</span>
</li><li class="li-enumerate"><span style="font-family:monospace">@UnderInitialization(B.class) B</span>
</li></ol>
<!--TOC subsection id="initialization-constructor" Method calls from the constructor-->
<h3 id="initialization-constructor" class="subsection">3.8.5&#XA0;&#XA0;Method calls from the constructor <a href="#initialization-constructor" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Consider the following incorrect program.</p><pre class="verbatim">class A {
  Object aField;
  A() {
    aField = new Object();
    process(5);  // illegal call
  }
  public void process(int arg) { ... }
}
</pre><p>The call to <span style="font-family:monospace">process()</span> is not legal.
<span style="font-family:monospace">process()</span> is declared to be called on a fully-initialized receiver, which is
the default if you do not write a different initialization annotation.
At the call to <span style="font-family:monospace">process()</span>, all the fields of <span style="font-family:monospace">A</span> have been set,
but <span style="font-family:monospace">this</span> is not fully initialized because fields in subclasses of <span style="font-family:monospace">A</span> have
not yet been set. The type of <span style="font-family:monospace">this</span> is <span style="font-family:monospace">@UnderInitialization(A.class)</span>,
meaning that <span style="font-family:monospace">this</span> is partially-initialized, with the <span style="font-family:monospace">A</span> part of
initialization done but the initialization of subclasses not yet complete.</p><p>The Initialization Checker output indicates this problem:</p><pre class="verbatim">Client.java:7: error: [method.invocation.invalid] call to process(int) not allowed on the given receiver.
    process(5);  // illegal call
           ^
  found   : @UnderInitialization(A.class) A
  required: @Initialized A
</pre><p>Here is a subclass and client code that crashes with a <span style="font-family:monospace">NullPointerException</span>.</p><pre class="verbatim">class B extends A {
  List&lt;Integer&gt; processed;
  B() {
    super();
    processed = new ArrayList&lt;Integer&gt;();
  }
  @Override
  public void process(int arg) {
    super();
    processed.add(arg);
  }
}
class Client {
  public static void main(String[] args) {
    new B();
  }
}
</pre><p>You can correct the problem in multiple ways.</p><p>One solution is to not call methods that can be overridden from the
constructor: move the call to <span style="font-family:monospace">process()</span> to after the constructor has
completed.</p><p>Another solution is to change the declaration of <span style="font-family:monospace">process()</span>:</p><pre class="verbatim">  public void process(@UnderInitialization(A.class) A this, int arg) { ... }
</pre><p>If you choose this solution, you will need to rewrite the definition of
<span style="font-family:monospace">B.process()</span> so that it is consistent with the declared receiver type.</p><p>A non-solution is to prevent subclasses from overriding <span style="font-family:monospace">process()</span> by
using <span style="font-family:monospace">final</span> on the method. This doesn&#X2019;t work because even if
<span style="font-family:monospace">process()</span> is not overridden, it might call other methods that are
overridden.</p><p>As final classes cannot have subclasses, they can be handled more
flexibly: once all fields of the final class have been
initialized, <span style="font-family:monospace">this</span> is fully initialized.</p>
<!--TOC subsection id="circular-initialization" Initialization of circular data structures-->
<h3 id="circular-initialization" class="subsection">3.8.6&#XA0;&#XA0;Initialization of circular data structures <a href="#circular-initialization" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>There is one final aspect of the initialization type system to be
considered: the rules governing reading and writing to objects that are
currently under initialization (both reading from fields of objects under
initialization, as well as writing objects under initialization to fields).
By default, only fully-initialized objects can be stored in a field of
another object. If this was the only option, then it would not be possible
to create circular data structures (such as a doubly-linked list) where
fields have a <a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a> type. However,
the annotation
<a href="../api/org/checkerframework/checker/initialization/qual/NotOnlyInitialized.html"><span style="font-family:monospace">@NotOnlyInitialized</span></a> can be used to
indicate that a field can store objects that are currently under initialization.
In this case, the rules for reading and writing to that field become a little
bit more interesting, to soundly support circular structures.</p><p>The rules for reading from a
<a href="../api/org/checkerframework/checker/initialization/qual/NotOnlyInitialized.html"><span style="font-family:monospace">@NotOnlyInitialized</span></a> field
are summarized in Figure&#XA0;<a href="#fig-init-read-field">3.5</a>. Essentially, nothing is
known about the initialization status of the value returned unless the receiver
was <a href="../api/org/checkerframework/checker/initialization/qual/Initialized.html"><span style="font-family:monospace">@Initialized</span></a>.</p><blockquote class="figure"><div class="center"><div class="center"><hr style="width:80%;height:2"></div>
<table border=1  style="border-spacing:0;" class="cellpadding1"><tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > <span style="font-family:monospace">x.f</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">f</span> is <span style="font-family:monospace">@NonNull</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">f</span> is <span style="font-family:monospace">@Nullable</span></td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > <span style="font-family:monospace">x</span> is <span style="font-family:monospace">@Initialized</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">@Initialized @NonNull</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">@Initialized @Nullable</span> </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > <span style="font-family:monospace">x</span> is <span style="font-family:monospace">@UnderInitialization</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">@UnknownInitialization @Nullable</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">@UnknownInitialization @Nullable</span> </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > <span style="font-family:monospace">x</span> is <span style="font-family:monospace">@UnknownInitialization</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">@UnknownInitialization @Nullable</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">@UnknownInitialization @Nullable</span> </td></tr>
</table>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 3.5: Initialization rules for reading a <a href="../api/org/checkerframework/checker/initialization/qual/NotOnlyInitialized.html"><span style="font-family:monospace">@NotOnlyInitialized</span></a> field <span style="font-family:monospace">f</span>.</td></tr>
</table></div>
<a id="fig-init-read-field"></a>
<div class="center"><hr style="width:80%;height:2"></div></div></blockquote><p>Similarly, Figure&#XA0;<a href="#fig-init-write-field">3.6</a> shows under which conditions
an assignment <span style="font-family:monospace">x.f = y</span> is allowed for a
<a href="../api/org/checkerframework/checker/initialization/qual/NotOnlyInitialized.html"><span style="font-family:monospace">@NotOnlyInitialized</span></a> field <span style="font-family:monospace">f</span>.
If the receiver <span style="font-family:monospace">x</span> is
<a href="../api/org/checkerframework/checker/initialization/qual/UnderInitialization.html"><span style="font-family:monospace">@UnderInitialization</span></a>, then any
<span style="font-family:monospace">y</span> can be of any initialization state. If <span style="font-family:monospace">y</span> is known to be
fully initialized, then any receiver is allowed. All other assignments
are disallowed.</p><blockquote class="figure"><div class="center"><div class="center"><hr style="width:80%;height:2"></div>
<table border=1  style="border-spacing:0;" class="cellpadding1"><tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > <span style="font-family:monospace">x.f = y</span></td><td style="text-align:center;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">y</span> is <span style="font-family:monospace">@Initialized</span></td><td style="text-align:center;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">y</span> is <span style="font-family:monospace">@UnderInitialization</span></td><td style="text-align:center;border:solid 1px;white-space:nowrap" ><span style="font-family:monospace">y</span> is <span style="font-family:monospace">@UnknownInitialization</span></td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > <span style="font-family:monospace">x</span> is <span style="font-family:monospace">@Initialized</span></td><td style="text-align:center;border:solid 1px;white-space:nowrap" >yes</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >no</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >no </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > <span style="font-family:monospace">x</span> is <span style="font-family:monospace">@UnderInitialization</span></td><td style="text-align:center;border:solid 1px;white-space:nowrap" >yes</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >yes</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >yes </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > <span style="font-family:monospace">x</span> is <span style="font-family:monospace">@UnknownInitialization</span></td><td style="text-align:center;border:solid 1px;white-space:nowrap" >yes</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >no</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >no </td></tr>
</table>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 3.6: Rules for deciding when an assignment <span style="font-family:monospace">x.f = y</span> is allowed for a
<a href="../api/org/checkerframework/checker/initialization/qual/NotOnlyInitialized.html"><span style="font-family:monospace">@NotOnlyInitialized</span></a> field <span style="font-family:monospace">f</span>.</td></tr>
</table></div>
<a id="fig-init-write-field"></a>
<div class="center"><hr style="width:80%;height:2"></div></div></blockquote><p>These rules allow for the safe initialization of circular structures. For instance,
consider a doubly linked list:</p><pre class="verbatim">  class List&lt;T&gt; {
    @NotOnlyInitialized
    Node&lt;T&gt; sentinel;

    public List() {
      this.sentinel = new Node&lt;&gt;(this);
    }

    void insert(@Nullable T data) {
      this.sentinel.insertAfter(data);
    }

    public static void main() {
      List&lt;Integer&gt; l = new List&lt;&gt;();
      l.insert(1);
      l.insert(2);
    }
  }

  class Node&lt;T&gt; {
    @NotOnlyInitialized
    Node&lt;T&gt; prev;

    @NotOnlyInitialized
    Node&lt;T&gt; next;

    @NotOnlyInitialized
    List parent;

    @Nullable
    T data;

    // for sentinel construction
    Node(@UnderInitialization List parent) {
      this.parent = parent;
      this.prev = this;
      this.next = this;
    }

    // for data node construction
    Node(Node&lt;T&gt; prev, Node&lt;T&gt; next, @Nullable T data) {
      this.parent = prev.parent;
      this.prev = prev;
      this.next = next;
      this.data = data;
    }

    void insertAfter(@Nullable T data) {
      Node&lt;T&gt; n = new Node&lt;&gt;(this, this.next, data);
      this.next.prev = n;
      this.next = n;
    }
  }
</pre>
<!--TOC subsection id="initialization-warnings" How to handle warnings-->
<h3 id="initialization-warnings" class="subsection">3.8.7&#XA0;&#XA0;How to handle warnings <a href="#initialization-warnings" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END -->
<!--TOC subsubsection id="initialization-warnings-constructor" &#X201C;error: the constructor does not initialize fields: &#X2026;&#X201D;-->
<h4 id="initialization-warnings-constructor" class="subsubsection">&#X201C;error: the constructor does not initialize fields: &#X2026;&#X201D; <a href="#initialization-warnings-constructor" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h4><!--SEC END --><p>Like any warning, &#X201C;error: the constructor does not initialize fields:
&#X2026;&#X201D; indicates that either your annotations are incorrect or your code
is buggy. You can fix either the annotations or the code.</p><ul class="itemize"><li class="li-itemize">
Declare the field as <a href="../api/org/checkerframework/checker/nullness/qual/Nullable.html"><span style="font-family:monospace">@Nullable</span></a>. Recall
that if you did not write an annotation, the field defaults to
<a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a>.
</li><li class="li-itemize">Declare the field as <a href="../api/org/checkerframework/checker/nullness/qual/MonotonicNonNull.html"><span style="font-family:monospace">@MonotonicNonNull</span></a>.
This is appropriate if the field starts out as <span style="font-family:monospace">null</span> but is later set
to a non-null value. You may then wish to use the
<a href="../api/org/checkerframework/checker/nullness/qual/EnsuresNonNull.html"><span style="font-family:monospace">@EnsuresNonNull</span></a> annotation to indicate
which methods set the field, and the
<a href="../api/org/checkerframework/checker/nullness/qual/RequiresNonNull.html"><span style="font-family:monospace">@RequiresNonNull</span></a> annotation to indicate
which methods require the field to be non-null.
</li><li class="li-itemize">Initialize the field in the constructor or in the field&#X2019;s initializer, if
the field should be initialized. (In this case, the Initialization
Checker has found a bug!)<p>Do <em>not</em> initialize the field to an arbitrary non-null value just to
eliminate the warning. Doing so degrades your code: it introduces a
value that will confuse other programmers, and it converts a clear
NullPointerException into a more obscure error.
</p></li></ul>
<!--TOC subsubsection id="initialization-warnings-receiver" &#X201C;call to &#X2026; is not allowed on the given receiver&#X201D;-->
<h4 id="initialization-warnings-receiver" class="subsubsection">&#X201C;call to &#X2026; is not allowed on the given receiver&#X201D; <a href="#initialization-warnings-receiver" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h4><!--SEC END --><p>If your code calls an instance method from a constructor, you may see a
message such as the following:</p><pre class="verbatim">Foo.java:123: error: call to initHelper() not allowed on the given receiver.
    initHelper();
              ^
  found   : @UnderInitialization(com.google.Bar.class) @NonNull MyClass
  required: @Initialized @NonNull MyClass
</pre><p>The problem is that the current object (<span style="font-family:monospace">this</span>) is under initialization,
but the receiver formal parameter (Section&#XA0;<a href="#faq-receiver">33.6.1</a>) of method
<span style="font-family:monospace">initHelper()</span> is implicitly annotated as
<a href="../api/org/checkerframework/checker/initialization/qual/Initialized.html"><span style="font-family:monospace">@Initialized</span></a>. If
<span style="font-family:monospace">initHelper()</span> doesn&#X2019;t depend on its receiver being initialized &#X2014; that
is, it&#X2019;s OK to call <span style="font-family:monospace">x.initHelper</span> even if <span style="font-family:monospace">x</span> is not initialized &#X2014;
then you can indicate that by using
<a href="../api/org/checkerframework/checker/initialization/qual/UnderInitialization.html"><span style="font-family:monospace">@UnderInitialization</span></a> or
<a href="../api/org/checkerframework/checker/initialization/qual/UnknownInitialization.html"><span style="font-family:monospace">@UnknownInitialization</span></a>.</p><pre class="verbatim">class MyClass {
  void initHelper(@UnknownInitialization MyClass this, String param1) { ... }
}
</pre><p>You are likely to want to annotate <span style="font-family:monospace">initHelper()</span> with
<a href="../api/org/checkerframework/checker/nullness/qual/EnsuresNonNull.html"><span style="font-family:monospace">@EnsuresNonNull</span></a> as well; see
Section&#XA0;<a href="#nullness-method-annotations">3.2.2</a>.</p><p>You may get the &#X201C;call to &#X2026; is not allowed on the given receiver&#X201D;
error even if your constructor has already initialized all the fields.
For this code:</p><pre class="verbatim">public class MyClass {
  @NonNull Object field;
  public MyClass() {
    field = new Object();
    helperMethod();
  }
  private void helperMethod() {
  }
}
</pre><p>the Nullness Checker issues the following warning:</p><pre class="verbatim">MyClass.java:7: error: call to helperMethod() not allowed on the given receiver.
    helperMethod();
                ^
  found   : @UnderInitialization(MyClass.class) @NonNull MyClass
  required: @Initialized @NonNull MyClass
1 error
</pre><p>
The reason is that even though the object under construction has had all
the fields declared in <span style="font-family:monospace">MyClass</span> initialized, there might be a subclass of
<span style="font-family:monospace">MyClass</span>. Thus, the receiver of <span style="font-family:monospace">helperMethod</span> should be declared as
<span style="font-family:monospace">@UnderInitialization(MyClass.class)</span>, which says that initialization has
completed for all the <span style="font-family:monospace">MyClass</span> fields but may not have been completed
overall. If <span style="font-family:monospace">helperMethod</span> had been a public method that could also be called after
initialization was actually complete, then the receiver should have type
<span style="font-family:monospace">@UnknownInitialization</span>, which is the supertype of
<span style="font-family:monospace">@UnknownInitialization</span> and <span style="font-family:monospace">@UnderInitialization</span>.
</p>
<!--TOC subsection id="initialization-checking" More details about initialization checking-->
<h3 id="initialization-checking" class="subsection">3.8.8&#XA0;&#XA0;More details about initialization checking <a href="#initialization-checking" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END -->
<!--TOC paragraph id="initialization-checking-suppressing-warnings" Suppressing warnings-->
<h5 id="initialization-checking-suppressing-warnings" class="paragraph">Suppressing warnings <a href="#initialization-checking-suppressing-warnings" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h5><!--SEC END --><p>
You can suppress warnings related to partially-initialized objects with
<span style="font-family:monospace">@SuppressWarnings("initialization")</span>.
This can be placed on a single field; on a constructor; or on a class to
suppress all initialization warnings for all constructors.
</p><p>To disable initialization checking, supply the command-line argument
<span style="font-family:monospace">-AsuppressWarnings=uninitialized</span>. Do <em>not</em> use
<span style="font-family:monospace">-AsuppressWarnings=initialization</span>, because doing so will disable all
nullness checking as well as all initialization checking. (That is because
of an implementation detail of the Nullness and Initialization Checkers:
they are actually the same checker, rather than being two separate checkers
that are aggregated together.)</p>
<!--TOC paragraph id="initialization-checking-method-annotations" Use of method annotations-->
<h5 id="initialization-checking-method-annotations" class="paragraph">Use of method annotations <a href="#initialization-checking-method-annotations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h5><!--SEC END --><p>A method with a non-initialized receiver may assume that a few fields (but not all
of them) are non-null, and it sometimes sets some more fields to non-null
values. To express these concepts, use the
<a href="../api/org/checkerframework/checker/nullness/qual/RequiresNonNull.html"><span style="font-family:monospace">@RequiresNonNull</span></a>,
<a href="../api/org/checkerframework/checker/nullness/qual/EnsuresNonNull.html"><span style="font-family:monospace">@EnsuresNonNull</span></a>, and
<a href="../api/org/checkerframework/checker/nullness/qual/EnsuresNonNullIf.html"><span style="font-family:monospace">@EnsuresNonNullIf</span></a> method annotations;
see Section&#XA0;<a href="#nullness-method-annotations">3.2.2</a>.</p>
<!--TOC paragraph id="initialization-checking-type-system" Source of the type system-->
<h5 id="initialization-checking-type-system" class="paragraph">Source of the type system <a href="#initialization-checking-type-system" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h5><!--SEC END --><p>The type system enforced by the Initialization Checker is known as
&#X201C;Freedom Before Commitment&#X201D;&#XA0;[<a href="#SummersM2011">SM11</a>]. Our implementation
changes its initialization modifiers (&#X201C;committed&#X201D;, &#X201C;free&#X201D;, and
&#X201C;unclassified&#X201D;) to &#X201C;initialized&#X201D;, &#X201C;unknown initialization&#X201D;, and
&#X201C;under initialization&#X201D;. Our implementation also has several
enhancements. For example, it supports partial initialization (the
argument to the <span style="font-family:monospace">@UnknownInitialization</span> and <span style="font-family:monospace">@UnderInitialization</span>
annotations).</p><hr>
<!--TOC chapter id="map-key-checker" Map Key Checker-->
<h1 id="map-key-checker" class="chapter">Chapter&#XA0;4&#XA0;&#XA0;Map Key Checker <a href="#map-key-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h1><!--SEC END --><p>The Map Key Checker tracks which values are keys for which maps. If variable
<span style="font-family:monospace">v</span> has type <span style="font-family:monospace">@KeyFor("m")...</span>, then the value of <span style="font-family:monospace">v</span> is a key
in Map <span style="font-family:monospace">m</span>. That is, the expression <span style="font-family:monospace">m.containsKey(v)</span> evaluates to
<span style="font-family:monospace">true</span>.</p><p>Section&#XA0;<a href="#map-key-qualifiers">3.2.4</a> describes how <span style="font-family:monospace">@KeyFor</span> annotations
enable the
Nullness Checker (Chapter&#XA0;<a href="#nullness-checker">3</a>) to treat calls to
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html#get-java.lang.Object-"><span style="font-family:monospace">Map.get</span></a>
more precisely by refining its result to <span style="font-family:monospace">@NonNull</span> in some cases.</p><p>You will not typically run the Map Key Checker. It is automatically run by
other checkers, in particular the Nullness Checker.</p><p>You can suppress warnings related to map keys with
<span style="font-family:monospace">@SuppressWarnings("keyfor")</span>; see Chapter&#XA0;<a href="#suppressing-warnings">27</a>.</p>
<!--TOC section id="map-key-annotations" Map key annotations-->
<h2 id="map-key-annotations" class="section">4.1&#XA0;&#XA0;Map key annotations <a href="#map-key-annotations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>These qualifiers are part of the Map Key type system:</p><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/nullness/qual/KeyFor.html"><span style="font-weight:bold"><span style="font-family:monospace">@KeyFor</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] maps)</span></span></dt><dd class="dd-description">
indicates that the value assigned to the annotated variable is a key for at
least the given maps.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/nullness/qual/UnknownKeyFor.html"><span style="font-weight:bold"><span style="font-family:monospace">@UnknownKeyFor</span></span></a></dt><dd class="dd-description">
is used internally by the type system but should never be written by a
programmer. It indicates that the value assigned to the annotated
variable is not known to be a key for any map. It is the default type
qualifier.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/nullness/qual/KeyForBottom.html"><span style="font-weight:bold"><span style="font-family:monospace">@KeyForBottom</span></span></a></dt><dd class="dd-description">
is used internally by the type system but should never be written by a
programmer. There are no values of this type (not even <span style="font-family:monospace">null</span>).</dd></dl><p>The following method annotations can be used to establish a method postcondition
that ensures that a certain expression is a key for a map:</p><dl class="description"><dt class="dt-description">
<a href="../api/org/checkerframework/checker/nullness/qual/EnsuresKeyFor.html"><span style="font-weight:bold"><span style="font-family:monospace">@EnsuresKeyFor</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] value, String[] map)</span></span></dt><dd class="dd-description">
When the method with this annotation returns, the expression (or all the
expressions) given in the <span style="font-family:monospace">value</span> element is a key for the given
maps. More precisely, the expression has the <span style="font-family:monospace">@KeyFor</span> qualifier
with the <span style="font-family:monospace">value</span> arguments taken from the <span style="font-family:monospace">targetValue</span> element
of this annotation.
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/nullness/qual/EnsuresKeyForIf.html"><span style="font-weight:bold"><span style="font-family:monospace">@EnsuresKeyForIf</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] expression, boolean result, String[] map)</span></span></dt><dd class="dd-description">
If the method with this annotation returns the given boolean value,
then the given expression (or all the given expressions)
is a key for the given maps.
</dd></dl><blockquote class="figure"><div class="center"><hr style="width:80%;height:2"></div>
<div class="center">
<img src="map-key-keyfor.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 4.1: The subtyping relationship of the Map Key Checker&#X2019;s qualifiers.
<span style="font-family:monospace">@KeyFor(A)</span> is a supertype of <span style="font-family:monospace">@KeyFor(B)</span> if and only if <span style="font-family:monospace">A</span> is a subset of
<span style="font-family:monospace">B</span>. Qualifiers in gray are used internally by the type system but should
never be written by a programmer.</td></tr>
</table></div>
<a id="fig-map-key-keyfor-hierarchy"></a>
<div class="center"><hr style="width:80%;height:2"></div></blockquote>
<!--TOC section id="map-key-defaults" Default annotations-->
<h2 id="map-key-defaults" class="section">4.2&#XA0;&#XA0;Default annotations <a href="#map-key-defaults" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The qualifier for the type of the <span style="font-family:monospace">null</span> literal is <span style="font-family:monospace">@UnknownKeyFor</span>.
If <span style="font-family:monospace">null</span> were <span style="font-family:monospace">@KeyForBottom</span>, that would mean that
<span style="font-family:monospace">null</span> is guaranteed to be a key for every map (which is not
necessarily true).</p>
<!--TOC subsection id="map-key-defaults-lowerbound" Default for lower bounds-->
<h3 id="map-key-defaults-lowerbound" class="subsection">4.2.1&#XA0;&#XA0;Default for lower bounds <a href="#map-key-defaults-lowerbound" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Lower bounds are defaulted to <span style="font-family:monospace">@UnknownKeyFor</span>.
However, in <span style="font-family:monospace">java.*</span> packages, the default for lower bounds is
<span style="font-family:monospace">@KeyForBottom</span>.</p><p>It is challenging to choose a default for lower bounds of type variables
and wildcards.</p><p>Here is a comparison of two choices for lower bounds:</p><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="text-align:left;white-space:nowrap" ><span style="font-family:monospace">@KeyForBottom</span> default</td><td style="text-align:left;white-space:nowrap" ><span style="font-family:monospace">@UnknownKeyFor</span> default (current choice) </td></tr>
<tr><td class="hbar" colspan=2></td></tr>
<tr><td style="text-align:left;white-space:nowrap" ><span style="font-family:monospace">class MyClass1&lt;@UnknownKeyFor T&gt; {</span></td><td style="text-align:left;white-space:nowrap" ><span style="font-family:monospace">class MyClass1&lt;T&gt; {</span> </td></tr>
<tr><td style="text-align:left;white-space:nowrap" ><span style="font-family:monospace">&#XA0;&#XA0;T var = null; // OK</span></td><td style="text-align:left;white-space:nowrap" ><span style="font-family:monospace">&#XA0;&#XA0;T var = null; // OK</span> </td></tr>
<tr><td class="hbar" colspan=2></td></tr>
<tr><td style="text-align:left;white-space:nowrap" ><span style="font-family:monospace">class MyClass2&lt;T&gt; {</span></td><td style="text-align:left;white-space:nowrap" >&nbsp;</td></tr>
<tr><td style="text-align:left;white-space:nowrap" ><span style="font-family:monospace">&#XA0;&#XA0;@UnknownKeyFor T var = null; // OK</span></td><td style="text-align:left;white-space:nowrap" >&nbsp;</td></tr>
<tr><td class="hbar" colspan=2></td></tr>
<tr><td style="text-align:left;white-space:nowrap" ><span style="font-family:monospace">class MyClass3&lt;T&gt; {</span></td><td style="text-align:left;white-space:nowrap" >&nbsp;</td></tr>
<tr><td style="text-align:left;white-space:nowrap" ><span style="font-family:monospace">&#XA0;&#XA0;T var = null; // ERROR</span></td><td style="text-align:left;white-space:nowrap" >&nbsp;</td></tr>
<tr><td class="hbar" colspan=2></td></tr>
<tr><td style="text-align:left;white-space:nowrap" >&nbsp;</td><td style="text-align:left;white-space:nowrap" ><span style="font-family:monospace">class MySet1&lt;T&gt; implements Set&lt;T&gt; { }</span> </td></tr>
<tr><td style="text-align:left;white-space:nowrap" >&nbsp;</td><td style="text-align:left;white-space:nowrap" ><span style="font-family:monospace">MySet1&lt;@KeyFor("m") String&gt; s1; // ERROR</span> </td></tr>
<tr><td class="hbar" colspan=2></td></tr>
<tr><td style="text-align:left;white-space:nowrap" ><span style="font-family:monospace">class Set&lt;E&gt; { }</span></td><td style="text-align:left;white-space:nowrap" >				<span style="font-family:monospace">class Set&lt;@KeyForBottom E&gt; { }</span> </td></tr>
<tr><td style="text-align:left;white-space:nowrap" ><span style="font-family:monospace">class MySet2&lt;T&gt; implements Set&lt;T&gt; { }</span></td><td style="text-align:left;white-space:nowrap" >				<span style="font-family:monospace">class MySet2&lt;@KeyForBottom T&gt; implements Set&lt;T&gt; { }</span> </td></tr>
<tr><td style="text-align:left;white-space:nowrap" ><span style="font-family:monospace">MySet2&lt;@KeyFor("m") String&gt; s2; // OK</span>
&#XA0;&#XA0;&#XA0;</td><td style="text-align:left;white-space:nowrap" >				<span style="font-family:monospace">MySet2&lt;@KeyFor("m") String&gt; s2; // OK</span> </td></tr>
</table><p>If lower bounds are defaulted to <span style="font-family:monospace">@KeyForBottom</span> (which is not
currently the case), then whenever <span style="font-family:monospace">null</span> is assigned to a variable whose
type is a type variable, programmers must write an <span style="font-family:monospace">@UnknownKeyFor</span>
annotation on either the type variable declaration or on variable
declarations, as shown in <span style="font-family:monospace">MyClass1</span> and
<span style="font-family:monospace">MyClass2</span>.
A disadvantage of this default is that the Map Key checker may issue
warnings in code that has nothing to do with map keys, and in which no map
key annotations are used.</p><p>If lower bounds are defaulted to <span style="font-family:monospace">@UnknownKeyFor</span> (which is currently
the case), then whenever a client might use a <span style="font-family:monospace">@KeyFor</span> type argument,
programmers must write a <span style="font-family:monospace">@KeyForBottom</span> annotation on the type parameter,
as in <span style="font-family:monospace">MySet2</span> (and <span style="font-family:monospace">Set</span>).</p>
<!--TOC subsection id="map-key-lowerbound-explicit" Diagnosing the need for explicit @KeyFor on lower bounds-->
<h3 id="map-key-lowerbound-explicit" class="subsection">4.2.2&#XA0;&#XA0;Diagnosing the need for explicit @KeyFor on lower bounds <a href="#map-key-lowerbound-explicit" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Under the current defaulting (lower bounds default to
<span style="font-family:monospace">@UnknownKeyFor</span>), suppose you write this code:</p><pre class="verbatim">public class Graph&lt;N&gt; {
  Map&lt;N, Integer&gt; nodes = new HashMap&lt;&gt;();
}

class Client {
  @Nullable Graph&lt;@KeyFor("g.nodes") String&gt; g;
}
</pre><p>The Nullness Checker issues this error message:</p><pre class="verbatim">Graph.java:14: error: [type.argument.type.incompatible] incompatible types in type argument.
  @Nullable Graph&lt;@KeyFor("g.nodes") String&gt; g;
                  ^
  found   : @KeyFor("this.g.nodes") String
  required: [extends @UnknownKeyFor Object super @UnknownKeyFor null]
</pre><p>Note that the upper and lower bounds are both <span style="font-family:monospace">@UnknownKeyFor</span>. You can
make the code type-check by writing a lower bound, which is written before
the type variable name (Section&#XA0;<a href="#generics-instantiation">25.1.2</a>):</p><pre class="verbatim">public class Graph&lt;@KeyForBottom N&gt; {
...
</pre>
<!--TOC section id="map-key-examples" Examples-->
<h2 id="map-key-examples" class="section">4.3&#XA0;&#XA0;Examples <a href="#map-key-examples" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The Map Key Checker keeps track of which variables reference keys to
which maps. A variable annotated with <span style="font-family:monospace">@KeyFor(</span><span style="font-family:monospace"><em>mapSet</em></span><span style="font-family:monospace">)</span> can only
contain a value that is a key for all the maps in <em>mapSet</em>. For example:</p><pre class="verbatim">Map&lt;String,Date&gt; m, n;
@KeyFor("m") String km;
@KeyFor("n") String kn;
@KeyFor({"m", "n"}) String kmn;
km = kmn;   // OK - a key for maps m and n is also a key for map m
km = kn;    // error: a key for map n is not necessarily a key for map m
</pre><p>As with any annotation, use of the <span style="font-family:monospace">@KeyFor</span> annotation may force you to
slightly refactor your code. For example, this would be illegal:</p><pre class="verbatim">Map&lt;String,Object&gt; m;
Collection&lt;@KeyFor("m") String&gt; coll;
coll.add(x);   // error: element type is @KeyFor("m") String, but x does not have that type
m.put(x, ...);
</pre><p>The example type-checks if you reorder the two calls:</p><pre class="verbatim">Map&lt;String,Object&gt; m;
Collection&lt;@KeyFor("m") String&gt; coll;
m.put(x, ...);    // after this statement, x has type @KeyFor("m") String
coll.add(x);      // OK
</pre>
<!--TOC section id="map-key-annotations-inference" Inference of @KeyFor annotations-->
<h2 id="map-key-annotations-inference" class="section">4.4&#XA0;&#XA0;Inference of @KeyFor annotations <a href="#map-key-annotations-inference" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>Within a method body, you usually do not have to write <span style="font-family:monospace">@KeyFor</span>
explicitly (except sometimes on type arguments),
because the checker infers it based on usage patterns. When the Map Key
Checker encounters a run-time check for map keys, such as
&#X201C;<span style="font-family:monospace">if (m.containsKey(k)) ...</span>&#X201D;, then the Map Key Checker refines the type of
<span style="font-family:monospace">k</span> to <span style="font-family:monospace">@KeyFor("m")</span> within the scope of the test (or until <span style="font-family:monospace">k</span> is
side-effected within that scope). The Map Key Checker also infers <span style="font-family:monospace">@KeyFor</span>
annotations based on iteration over a map&#X2019;s
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html#keySet--">key set</a> or calls to
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html#put-K-V-"><span style="font-family:monospace">put</span></a>
or
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Map.html#containsKey-java.lang.Object-"><span style="font-family:monospace">containsKey</span></a>.
For more details about type refinement, see Section&#XA0;<a href="#type-refinement">26.7</a>.</p><p>Suppose we have these declarations:</p><pre class="verbatim">Map&lt;String,Date&gt; m = new Map&lt;&gt;();
String k = "key";
@KeyFor("m") String km;
</pre><p>Ordinarily, the following assignment does not type-check:</p><pre class="verbatim">km = k;   // Error since k is not known to be a key for map m.
</pre><p>The following examples show cases where the Map Key Checker
infers a <span style="font-family:monospace">@KeyFor</span> annotation for variable <span style="font-family:monospace">k</span> based on usage patterns,
enabling the <span style="font-family:monospace">km = k</span> assignment to type-check.</p><pre class="verbatim">m.put(k, ...);
// At this point, the type of k is refined to @KeyFor("m") String.
km = k;   // OK


if (m.containsKey(k)) {
    // At this point, the type of k is refined to @KeyFor("m") String.
    km = k;   // OK
    ...
} else {
    km = k;   // Error since k is not known to be a key for map m.
    ...
}
</pre><p>The following example shows a case where the Map Key Checker resets its
assumption about the type of a field used as a key because that field may have
been side-effected.</p><pre class="verbatim">class MyClass {
    private Map&lt;String,Object&gt; m;
    private String k;   // The type of k defaults to @UnknownKeyFor String
    private @KeyFor("m") String km;

    public void myMethod() {
        if (m.containsKey(k)) {
            km = k;   // OK: the type of k is refined to @KeyFor("m") String

            sideEffectFreeMethod();
            km = k;   // OK: the type of k is not affected by the method call
                      // and remains @KeyFor("m") String

            otherMethod();
            km = k;   // error: At this point, the type of k is once again
                      // @UnknownKeyFor String, because otherMethod might have
                      // side-effected k such that it is no longer a key for map m.
        }
    }

    @SideEffectFree
    private void sideEffectFreeMethod() { ... }

    private void otherMethod() { ... }
}
</pre><hr>
<!--TOC chapter id="optional-checker" Optional Checker for possibly-present data-->
<h1 id="optional-checker" class="chapter">Chapter&#XA0;5&#XA0;&#XA0;Optional Checker for possibly-present data <a href="#optional-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h1><!--SEC END --><p>Java 8 introduced the <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html"><span style="font-family:monospace">Optional</span></a>
class, a container that is either empty or contains a non-null value.</p><p>Using <span style="font-family:monospace">Optional</span> is intended to help programmers remember to check whether
data is present or not. However, <span style="font-family:monospace">Optional</span> itself is prone to misuse.
The article
<a href="https://homes.cs.washington.edu/~mernst/advice/nothing-is-better-than-optional.html">Nothing
is better than the <span style="font-family:monospace">Optional</span> type</a> gives reasons to use
regular nullable references rather than <span style="font-family:monospace">Optional</span>. However, if you do use
<span style="font-family:monospace">Optional</span>, then the Optional Checker will help you avoid
<span style="font-family:monospace">Optional</span>&#X2019;s pitfalls.</p><p>Stuart Marks gave
<a href="https://stuartmarks.wordpress.com/2016/09/27/vjug24-session-on-optional/">7
rules</a> to avoid problems with Optional:
</p><ol class="enumerate" type=1><li class="li-enumerate">
Never, ever, use <span style="font-family:monospace">null</span> for an <span style="font-family:monospace">Optional</span> variable or return value.
</li><li class="li-enumerate">Never use <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html#get--"><span style="font-family:monospace">Optional.get()</span></a> unless you can prove that the Optional is present.
</li><li class="li-enumerate">Prefer alternative APIs over
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html#isPresent--"><span style="font-family:monospace">Optional.isPresent()</span></a>
and <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html#get--"><span style="font-family:monospace">Optional.get()</span></a>.
</li><li class="li-enumerate">It&#X2019;s generally a bad idea to create an <span style="font-family:monospace">Optional</span> for the specific
purpose of chaining methods from it to get a value.
</li><li class="li-enumerate">If an Optional chain has a nested <span style="font-family:monospace">Optional</span> chain, or has an
intermediate result of <span style="font-family:monospace">Optional</span>, it&#X2019;s probably too complex.
</li><li class="li-enumerate">Avoid using <span style="font-family:monospace">Optional</span> in fields, method parameters, and collections.
</li><li class="li-enumerate">Don&#X2019;t use an <span style="font-family:monospace">Optional</span> to wrap any collection type (<span style="font-family:monospace">List</span>, <span style="font-family:monospace">Set</span>,
<span style="font-family:monospace">Map</span>). Instead, use an empty collection to represent the absence of
values.
</li></ol><p>Rule #1 is guaranteed by the Nullness Checker
(Chapter&#XA0;<a href="#nullness-checker">3</a>).
Rules #2&#X2013;#7 are guaranteed by the Optional Checker, described in this chapter.
(Exception: Rule #5 is not yet implemented and will be checked by the
Optional Checker in the future.)
</p><p>Use of the Optional Checker guarantees that your program will not suffer a
<span style="font-family:monospace">NullPointerException</span> nor a <span style="font-family:monospace">NoSuchElementException</span> when calling
methods on an expression of <span style="font-family:monospace">Optional</span> type.</p>
<!--TOC section id="optional-run-checker" How to run the Optional Checker-->
<h2 id="optional-run-checker" class="section">5.1&#XA0;&#XA0;How to run the Optional Checker <a href="#optional-run-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><pre class="verbatim">javac -processor optional MyFile.java ...
</pre>
<!--TOC section id="optional-annotations" Optional annotations-->
<h2 id="optional-annotations" class="section">5.2&#XA0;&#XA0;Optional annotations <a href="#optional-annotations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>These qualifiers make up the Optional type system:</p><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/optional/qual/MaybePresent.html"><span style="font-weight:bold"><span style="font-family:monospace">@MaybePresent</span></span></a></dt><dd class="dd-description">
The annotated <span style="font-family:monospace">Optional</span> container may or may not contain a value.
This is the default type.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/optional/qual/Present.html"><span style="font-weight:bold"><span style="font-family:monospace">@Present</span></span></a></dt><dd class="dd-description">
The annotated <span style="font-family:monospace">Optional</span> container definitely contains a (non-null) value.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/optional/qual/PolyPresent.html"><span style="font-weight:bold"><span style="font-family:monospace">@PolyPresent</span></span></a></dt><dd class="dd-description">
indicates qualifier polymorphism (see Section&#XA0;<a href="#qualifier-polymorphism">25.2</a>).</dd></dl><p>The subtyping hierarchy of the Optional Checker&#X2019;s qualifiers is shown in
Figure&#XA0;<a href="#fig-optional-hierarchy">5.1</a>.</p><blockquote class="figure"><div class="center"><hr style="width:80%;height:2"></div>
<div class="center">
<img src="optional-subtyping.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 5.1: The subtyping relationship of the Optional Checker&#X2019;s qualifiers.</td></tr>
</table></div>
<a id="fig-optional-hierarchy"></a>
<div class="center"><hr style="width:80%;height:2"></div></blockquote>
<!--TOC section id="optional-guarantees" What the Optional Checker guarantees-->
<h2 id="optional-guarantees" class="section">5.3&#XA0;&#XA0;What the Optional Checker guarantees <a href="#optional-guarantees" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The Optional Checker guarantees that your code will not throw an exception
due to use of an absent <span style="font-family:monospace">Optional</span> where a present <span style="font-family:monospace">Optional</span> is needed.
More specifically, the Optional Checker will issue a warning if you call
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html#get--"><span style="font-family:monospace">get</span></a>
or
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html#orElseThrow-java.util.function.Supplier-"><span style="font-family:monospace">orElseThrow</span></a>
on a <span style="font-family:monospace">@MaybePresent Optional</span> receiver, because each of these methods
throws an exception if the receiver is an absent
<span style="font-family:monospace">Optional</span>.</p><p>The Optional Checker does not check nullness properties, such as requiring
that the argument to
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html#of-T-"><span style="font-family:monospace">of</span></a>
is non-null or guaranteeing that the result of
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html#get--"><span style="font-family:monospace">get</span></a>
is non-null. To obtain such a guarantee, run both the Optional Checker and
the Nullness Checker (Chapter&#XA0;<a href="#nullness-checker">3</a>).</p><p>As with any checker, the guarantee is subject to certain limitations (see
Section&#XA0;<a href="#checker-guarantees">2.3</a>).</p><hr>
<!--TOC chapter id="interning-checker" Interning Checker-->
<h1 id="interning-checker" class="chapter">Chapter&#XA0;6&#XA0;&#XA0;Interning Checker <a href="#interning-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h1><!--SEC END --><p>If the Interning Checker issues no errors for a given program, then all
reference equality tests (i.e., all uses of &#X201C;<span style="font-family:monospace">==</span>&#X201D;) are proper;
that is,
<span style="font-family:monospace">==</span> is not misused where <span style="font-family:monospace">equals()</span> should have been used instead.</p><p>Interning is a design pattern in which the same object is used whenever two
different objects would be considered equal. Interning is also known as
canonicalization or hash-consing, and it is related to the flyweight design
pattern.
Interning has two benefits: it can save memory, and it can speed up testing for
equality by permitting use of <span style="font-family:monospace">==</span>.</p><p>The Interning Checker prevents two types of errors in your code. First,
<span style="font-family:monospace">==</span> should be used
only on interned values; using <span style="font-family:monospace">==</span> on
non-interned values can result in subtle bugs. For example:</p><pre class="verbatim">  Integer x = new Integer(22);
  Integer y = new Integer(22);
  System.out.println(x == y);  // prints false!
</pre><p>The Interning Checker helps programmers to prevent such bugs.
Second,
the Interning Checker also helps to prevent performance problems that result
from failure to use interning.
(See Section&#XA0;<a href="#checker-guarantees">2.3</a> for caveats to the checker&#X2019;s guarantees.)</p><p>Interning is such an important design pattern that Java builds it in for
these types: <span style="font-family:monospace">String</span>, <span style="font-family:monospace">Boolean</span>, <span style="font-family:monospace">Byte</span>, <span style="font-family:monospace">Character</span>, <span style="font-family:monospace">Integer</span>,
<span style="font-family:monospace">Short</span>. Every string literal in the program is guaranteed to be interned
(<a href="https://docs.oracle.com/javase/specs/jls/se10/html/jls-3.html#jls-3.10.5">JLS
&#XA7;3.10.5</a>), and the
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html#intern--"><span style="font-family:monospace">String.intern()</span></a> method
performs interning for strings that are computed at run time.
The <span style="font-family:monospace">valueOf</span> methods in wrapper classes always (<span style="font-family:monospace">Boolean</span>, <span style="font-family:monospace">Byte</span>) or
sometimes (<span style="font-family:monospace">Character</span>, <span style="font-family:monospace">Integer</span>, <span style="font-family:monospace">Short</span>) return an interned result
(<a href="https://docs.oracle.com/javase/specs/jls/se10/html/jls-5.html#jls-5.1.7">JLS &#XA7;5.1.7</a>).
Users can also write their own interning methods for other types.</p><p>It is a proper optimization to use <span style="font-family:monospace">==</span>, rather than <span style="font-family:monospace">equals()</span>,
whenever the comparison is guaranteed to produce the same result &#X2014; that
is, whenever the comparison is never provided with two different objects
for which <span style="font-family:monospace">equals()</span> would return true. Here are three reasons that
this property could hold:</p><ol class="enumerate" type=1><li class="li-enumerate">
Interning. A factory method ensures that, globally, no two different
interned objects are <span style="font-family:monospace">equals()</span> to one another.
(Not every value of the given type is necessarily interned; it is
possible for two objects of the class to be
<span style="font-family:monospace">equals()</span> to one another, even if one of them is interned.)
Interned objects should always be immutable.
</li><li class="li-enumerate">Global control flow. The program&#X2019;s control flow is such that the
constructor for class <span style="font-style:italic">C</span> is called a limited number of times, and with
specific values that ensure the results are not <span style="font-family:monospace">equals()</span> to one
another. Objects of class <span style="font-style:italic">C</span> can always be compared with <span style="font-family:monospace">==</span>.
Such objects may be mutable or immutable.
</li><li class="li-enumerate">Local control flow. Even though not all objects of the given type may be
compared with <span style="font-family:monospace">==</span>, the specific objects that can reach a given
comparison may be. For example, suppose that an array contains no
duplicates. Then searching for the index of an element that is
known to be in the array can use <span style="font-family:monospace">==</span>.
</li></ol><p>To eliminate Interning Checker errors, you will need to annotate the
declarations of any expression used as an argument to <span style="font-family:monospace">==</span>.
Thus, the Interning Checker
could also have been called the Reference Equality Checker.
</p><p>
To run the Interning Checker, supply the
<span style="font-family:monospace">-processor org.checkerframework.checker.interning.InterningChecker</span>
command-line option to javac. For examples, see Section&#XA0;<a href="#interning-example">6.5</a>.
</p>
<!--TOC section id="interning-annotations" Interning annotations-->
<h2 id="interning-annotations" class="section">6.1&#XA0;&#XA0;Interning annotations <a href="#interning-annotations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END -->
<!--TOC subsection id="interning-qualifiers" Interning qualifiers-->
<h3 id="interning-qualifiers" class="subsection">6.1.1&#XA0;&#XA0;Interning qualifiers <a href="#interning-qualifiers" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>These qualifiers are part of the Interning type system:</p><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/interning/qual/Interned.html"><span style="font-weight:bold"><span style="font-family:monospace">@Interned</span></span></a></dt><dd class="dd-description">
indicates a type that includes only interned values (no non-interned
values).</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/interning/qual/InternedDistinct.html"><span style="font-weight:bold"><span style="font-family:monospace">@InternedDistinct</span></span></a></dt><dd class="dd-description">
indicates a type such that each value is not <span style="font-family:monospace">equals()</span> to any other
Java value. For details, see Section&#XA0;<a href="#interning-distinct">6.3.3</a>.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/interning/qual/UnknownInterned.html"><span style="font-weight:bold"><span style="font-family:monospace">@UnknownInterned</span></span></a></dt><dd class="dd-description">
indicates a type whose values might or might not be interned.
It is used internally by the type system and is not written by programmers.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/interning/qual/PolyInterned.html"><span style="font-weight:bold"><span style="font-family:monospace">@PolyInterned</span></span></a></dt><dd class="dd-description">
indicates qualifier polymorphism (see
Section&#XA0;<a href="#qualifier-polymorphism">25.2</a>).</dd></dl>
<!--TOC subsection id="interning-declaration-annotations" Interning method and class annotations-->
<h3 id="interning-declaration-annotations" class="subsection">6.1.2&#XA0;&#XA0;Interning method and class annotations <a href="#interning-declaration-annotations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/interning/qual/UsesObjectEquals.html"><span style="font-weight:bold"><span style="font-family:monospace">@UsesObjectEquals</span></span></a></dt><dd class="dd-description">
is a class annotation (not a type annotation) that indicates that this class&#X2019;s
<span style="font-family:monospace">equals</span> method is the same as that of <span style="font-family:monospace">Object</span>. In other words,
neither this class nor any of its superclasses overrides the <span style="font-family:monospace">equals</span>
method. Since <span style="font-family:monospace">Object.equals</span> uses reference equality, this means that
for such a class, <span style="font-family:monospace">==</span> and <span style="font-family:monospace">equals</span> are equivalent, and so the
Interning Checker does not issue errors or warnings for either one.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/interning/qual/InternMethod.html"><span style="font-weight:bold"><span style="font-family:monospace">@InternMethod</span></span></a></dt><dd class="dd-description">
is a method declaration annotation that indicates that this method returns an interned object and maybe be invoked
on an uninterned object. See Section&#XA0;<a href="#interning-intern-methods">6.3.1</a> for more details.
</dd></dl>
<!--TOC section id="interning-annotating" Annotating your code with <span style="font-family:monospace">@Interned</span>-->
<h2 id="interning-annotating" class="section">6.2&#XA0;&#XA0;Annotating your code with <span style="font-family:monospace">@Interned</span> <a href="#interning-annotating" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><blockquote class="figure"><div class="center"><hr style="width:80%;height:2"></div>
<div class="center">
<img src="interning.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 6.1: Type hierarchy for the Interning type system.</td></tr>
</table></div>
<a id="fig-interning-hierarchy"></a>
<div class="center"><hr style="width:80%;height:2"></div></blockquote><p>In order to perform checking, you must annotate your code with the <a href="../api/org/checkerframework/checker/interning/qual/Interned.html"><span style="font-family:monospace">@Interned</span></a>
type annotation. A type annotated with <span style="font-family:monospace">@Interned</span> contains the canonical
representation of an
object:</p><pre class="verbatim">            String s1 = ...;  // type is (uninterned) "String"
  @Interned String s2 = ...;  // type is "@Interned String"
</pre><p>The Interning Checker ensures that only interned
values can be assigned to <span style="font-family:monospace">s2</span>.</p>
<!--TOC section id="interning-interned-classes" Interned classes-->
<h2 id="interning-interned-classes" class="section">6.3&#XA0;&#XA0;Interned classes <a href="#interning-interned-classes" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>An interned annotation on a class declaration indicates that all objects of a
type are interned <span style="font-style:italic">except for newly created objects</span>. That means that
all uses of such types are <span style="font-family:monospace">@Interned</span> by default and the type <span style="font-family:monospace">@UnknownInterned
MyClass</span> is an invalid type.</p><p>An exception is <span style="font-style:italic">constructor results</span>. Constructor results and <span style="font-family:monospace">this</span> within the
body of the constructor are <span style="font-family:monospace">@UnknownInterned</span> by default. Although <span style="font-family:monospace">@UnknownInterned InternClass</span>
is not a legal type, no &#X201C;type.invalid&#X201D; error is issued at constructor declarations.
Instead, an &#X201C;interned.object.creation&#X201D;
error is issued at the invocation of the constructor. The user should inspect
this location and suppress the warning if the newly created object is interned.</p><p>For example:</p><pre class="verbatim">@Interned class InternedClass {
  @UnknownInterned InternedClass() {
  // error, "this" is @UnknownInterned.
  @Interned InternedClass that = this;
  }

  @SuppressWarnings("intern") // Only creation of an InternedClass object.
  static final InternedClass ONE = new InternedClass();
}
</pre>
<!--TOC subsection id="interning-intern-methods" The intern() methods-->
<h3 id="interning-intern-methods" class="subsection">6.3.1&#XA0;&#XA0;The intern() methods <a href="#interning-intern-methods" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>
Some interned classes use an <span style="font-family:monospace">intern()</span> method to look up the interned version of
the object. These methods must be annotated with the declaration annotation
<span style="font-family:monospace">@InternMethod</span>. This allows the checker to verify that a newly created object
is immediately interned and therefore not issue an interned object creation
error.</p><pre class="verbatim">new InternedClass().intern() // no error
</pre><p>Because an <span style="font-family:monospace">intern</span> method is expected to be called on uninterned objects, the
type of <span style="font-family:monospace">this</span> in <span style="font-family:monospace">intern</span> is implicitly <span style="font-family:monospace">@UnknownInterned</span>. This will cause an
error if <span style="font-family:monospace">this</span> is used someplace where an interned object is expected. Some
of these warnings will be false positives that should be suppressed by the
user.</p><pre class="verbatim">@InternMethod
public InternedClass intern() {
  // Type of "this" inside an @InternMethod is @UnknownInterned
  @Interned InternedClass that = this; // error

  if (!pool.contains(this)) {
    @SuppressWarning("interning:assignment.type.incompatible")
    @Interned InternedClass internedThis = this;
    pool.add(internedThis);
  }
  return pool.get(this);
}
</pre><p>Some interned classes do not use an intern method to ensure that every object
of that class is interned. For these classes, the user will have to manually
inspect every constructor invocation and suppress the &#X201C;interned.object.creation&#X201D;
error.</p><p>If every invocation of a constructor is guaranteed to be interned, then the
user should annotate the constructor result with <span style="font-family:monospace">@Interned</span> and suppress a
warning at the constructor.</p><pre class="verbatim">@Interned class AnotherInternedClass {
  // manually verified that all constructor invocations used such that all
  // new objects are interned
  @SuppressWarnings("super.invocation.invalid")
  @Interned AnotherInternedClass() {}
}
</pre>
<!--TOC subsection id="interning-implicit-qualifiers" Default qualifiers and qualifiers for literals-->
<h3 id="interning-implicit-qualifiers" class="subsection">6.3.2&#XA0;&#XA0;Default qualifiers and qualifiers for literals <a href="#interning-implicit-qualifiers" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The Interning Checker
adds qualifiers to unannotated types, reducing the number of annotations that must
appear in your code (see Section&#XA0;<a href="#effective-qualifier">26.4</a>).</p><p>For a complete description of all defaulting rules for interning qualifiers, see the
Javadoc for <a href="../api/org/checkerframework/checker/interning/InterningAnnotatedTypeFactory.html"><span style="font-family:monospace">InterningAnnotatedTypeFactory</span></a>.</p>
<!--TOC subsection id="interning-distinct" InternedDistinct: values not equals() to any other value-->
<h3 id="interning-distinct" class="subsection">6.3.3&#XA0;&#XA0;InternedDistinct: values not equals() to any other value <a href="#interning-distinct" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The <a href="../api/org/checkerframework/checker/interning/qual/InternedDistinct.html"><span style="font-family:monospace">@InternedDistinct</span></a> annotation
represents values that are not <span style="font-family:monospace">equals()</span> to any other value. Suppose
expression <span style="font-family:monospace">e</span> has type <span style="font-family:monospace">@InternedDistinct</span>. Then <span style="font-family:monospace">e.equals(x) == (e ==
x)</span>. Therefore, it is legal to use <span style="font-family:monospace">==</span> whenever at least one of the
operands has type <span style="font-family:monospace">@InternedDistinct</span>.</p><p><span style="font-family:monospace">@InternedDistinct</span> is stronger (more restrictive) than <span style="font-family:monospace">@Interned</span>.
For example, consider these variables:</p><pre class="verbatim">@Interned String i = "22";
          String s = new Integer(22).toString();
</pre><p>The variable <span style="font-family:monospace">i</span> is not <span style="font-family:monospace">@InternedDistinct</span> because <span style="font-family:monospace">i.equals(s)</span> is true.</p><p><span style="font-family:monospace">@InternedDistinct</span> is not as restrictive as stating that all objects of a
given Java type are interned.</p><p>The <span style="font-family:monospace">@InternedDistinct</span> annotation is rarely used, because it arises from
coding paradigms that are tricky to reason about.
One use is on static fields
that hold canonical values of a type.
Given this declaration:</p><pre class="verbatim">class MyType {
  final static @InternedDistinct MyType SPECIAL = new MyType(...);
  ...
}
</pre><p>it would be legal to write <span style="font-family:monospace">myValue == MyType.SPECIAL</span> rather than
<span style="font-family:monospace">myValue.equals(MyType.SPECIAL)</span>.</p><p>The <span style="font-family:monospace">@InternedDistinct</span> is trusted (not verified), because it would be too
complex to analyze the <span style="font-family:monospace">equals()</span> method to ensure that no other value is
<span style="font-family:monospace">equals()</span> to a <span style="font-family:monospace">@InternedDistinct</span> value. You will need to manually
verify that it is only written in locations where its contract is satisfied.
For example, here is one set of guidelines that you could check manually:
</p><ul class="itemize"><li class="li-itemize">
The constructor is private.
</li><li class="li-itemize">The factory method returns the canonical version for certain values.
</li><li class="li-itemize">The class is final, so that subclasses cannot violate these properties.
</li></ul>
<!--TOC section id="interning-checks" What the Interning Checker checks-->
<h2 id="interning-checks" class="section">6.4&#XA0;&#XA0;What the Interning Checker checks <a href="#interning-checks" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>Objects of an <a href="../api/org/checkerframework/checker/interning/qual/Interned.html"><span style="font-family:monospace">@Interned</span></a> type may be safely compared using the &#X201C;<span style="font-family:monospace">==</span>&#X201D;
operator.</p><p>The checker issues an error in two cases:</p><ol class="enumerate" type=1><li class="li-enumerate">When a reference (in)equality operator (&#X201C;<span style="font-family:monospace">==</span>&#X201D; or &#X201C;<span style="font-family:monospace">!=</span>&#X201D;)
has an operand of non-<a href="../api/org/checkerframework/checker/interning/qual/Interned.html"><span style="font-family:monospace">@Interned</span></a> type.
As a special case, the operation is permitted if either argument is of
<a href="../api/org/checkerframework/checker/interning/qual/InternedDistinct.html"><span style="font-family:monospace">@InternedDistinct</span></a> type</li><li class="li-enumerate">When a non-<a href="../api/org/checkerframework/checker/interning/qual/Interned.html"><span style="font-family:monospace">@Interned</span></a> type is used
where an <a href="../api/org/checkerframework/checker/interning/qual/Interned.html"><span style="font-family:monospace">@Interned</span></a> type
is expected.</li></ol><p>This example shows both sorts of problems:</p><pre class="verbatim">                    Date  date;
          @Interned Date idate;
  @InternedDistinct Date ddate;
  ...
  if (date == idate) ...  // error: reference equality test is unsafe
  idate = date;           // error: idate's referent might no longer be interned
  ddate = idate;          // error: idate's referent might be equals() to some other value
</pre><p><a id="lint-dotequals"></a></p><p>The checker also issues a warning when <span style="font-family:monospace">.equals</span> is used where
<span style="font-family:monospace">==</span> could be safely used. You can disable this behavior via the
javac <span style="font-family:monospace">-Alint=-dotequals</span> command-line option.</p><p>For a complete description of all checks performed by
the checker, see the Javadoc for
<a href="../api/org/checkerframework/checker/interning/InterningVisitor.html"><span style="font-family:monospace">InterningVisitor</span></a>.</p><p><a id="checking-class"></a>
You can also restrict which types the checker should examine and type-check,
using the <span style="font-family:monospace">-Acheckclass</span> option. For example, to find only the
interning errors related to uses of <span style="font-family:monospace">String</span>, you can pass
<span style="font-family:monospace">-Acheckclass=java.lang.String</span>. The Interning Checker always checks all
subclasses and superclasses of the given class.</p>
<!--TOC subsection id="interning-limitations" Limitations of the Interning Checker-->
<h3 id="interning-limitations" class="subsection">6.4.1&#XA0;&#XA0;Limitations of the Interning Checker <a href="#interning-limitations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The Interning Checker conservatively assumes that the <span style="font-family:monospace">Character</span>, <span style="font-family:monospace">Integer</span>,
and <span style="font-family:monospace">Short</span> <span style="font-family:monospace">valueOf</span> methods return a non-interned value. In fact, these
methods sometimes return an interned value and sometimes a non-interned
value, depending on the run-time argument (<a href="https://docs.oracle.com/javase/specs/jls/se10/html/jls-5.html#jls-5.1.7">JLS
&#XA7;5.1.7</a>). If you know that the run-time argument to <span style="font-family:monospace">valueOf</span> implies that
the result is interned, then you will need to suppress an error.
(The Interning Checker should make use of the Value Checker to estimate the upper
and lower bounds on char, int, and short values so that it can more
precisely determine whether the result of a given <span style="font-family:monospace">valueOf</span> call is
interned.)</p>
<!--TOC section id="interning-example" Examples-->
<h2 id="interning-example" class="section">6.5&#XA0;&#XA0;Examples <a href="#interning-example" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>To try the Interning Checker on a source file that uses the <a href="../api/org/checkerframework/checker/interning/qual/Interned.html"><span style="font-family:monospace">@Interned</span></a> qualifier,
use the following command:</p><div style="font-size:small;">
<pre class="verbatim">  javac -processor org.checkerframework.checker.interning.InterningChecker docs/examples/InterningExample.java
</pre></div><p>Compilation will complete without errors or warnings.</p><p>To see the checker warn about incorrect usage of annotations, use the following
command:</p><div style="font-size:small;">
<pre class="verbatim">  javac -processor org.checkerframework.checker.interning.InterningChecker docs/examples/InterningExampleWithWarnings.java
</pre></div><p>The compiler will issue an error regarding violation of the semantics of
<a href="../api/org/checkerframework/checker/interning/qual/Interned.html"><span style="font-family:monospace">@Interned</span></a>.
</p><p>The Daikon invariant detector
(<a href="http://plse.cs.washington.edu/daikon/"><span style="font-family:monospace">http://plse.cs.washington.edu/daikon/</span></a>) is also annotated with
<a href="../api/org/checkerframework/checker/interning/qual/Interned.html"><span style="font-family:monospace">@Interned</span></a>. From directory <span style="font-family:monospace">java/</span>,
run <span style="font-family:monospace">make check-interning</span>.</p>
<!--TOC section id="other-interning-annotations" Other interning annotations-->
<h2 id="other-interning-annotations" class="section">6.6&#XA0;&#XA0;Other interning annotations <a href="#other-interning-annotations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The Checker Framework&#X2019;s interning annotations are similar to annotations used
elsewhere.</p><p>If your code is already annotated with a different interning
annotation, the Checker Framework can type-check your code.
It treats annotations from other tools
as if you had written the corresponding annotation from the
Interning Checker, as described in Figure&#XA0;<a href="#fig-interning-refactoring">6.2</a>.
If the other annotation is a declaration annotation, it may be moved; see
Section&#XA0;<a href="#declaration-annotations-moved">28.1.1</a>.</p><blockquote class="figure"><div class="center"><hr style="width:80%;height:2"></div>
<div class="center">
<table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="text-align:left;white-space:nowrap" ><table border=1  style="border-spacing:0;" class="cellpadding1"><tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;com.sun.istack.internal.Interned&#XA0; </td></tr>
</table></td><td style="text-align:left;white-space:nowrap" >&#X21D2;
&#XA0;org.checkerframework.checker.interning.qual.Interned&#XA0;
</td></tr>
</table>
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 6.2: Correspondence between other interning annotations and the
Checker Framework&#X2019;s annotations.</td></tr>
</table></div>
<a id="fig-interning-refactoring"></a>
<div class="center"><hr style="width:80%;height:2"></div></blockquote><hr>
<!--TOC chapter id="lock-checker" Lock Checker-->
<h1 id="lock-checker" class="chapter">Chapter&#XA0;7&#XA0;&#XA0;Lock Checker <a href="#lock-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h1><!--SEC END --><p>The Lock Checker prevents certain concurrency errors by enforcing a
locking discipline. A locking discipline indicates which locks must be held
when a given operation occurs. You express the locking discipline by
declaring a variable&#X2019;s type to have the qualifier
<a href="../api/org/checkerframework/checker/lock/qual/GuardedBy.html"><span style="font-family:monospace">@GuardedBy</span></a><span style="font-family:monospace"><span style="font-size:small">("</span></span><span style="font-family:monospace"><span style="font-size:small"><em>lockexpr</em></span></span><span style="font-family:monospace"><span style="font-size:small">")</span></span>.
This indicates that the variable&#X2019;s value may
be dereferenced only if the given lock is held.</p><p>To run the Lock Checker, supply the
<span style="font-family:monospace">-processor org.checkerframework.checker.lock.LockChecker</span>
command-line option to javac. The <span style="font-family:monospace">-AconcurrentSemantics</span>
command-line option is always enabled for the Lock Checker (see Section&#XA0;<a href="#faq-concurrency">33.4.4</a>).</p>
<!--TOC section id="lock-guarantees" What the Lock Checker guarantees-->
<h2 id="lock-guarantees" class="section">7.1&#XA0;&#XA0;What the Lock Checker guarantees <a href="#lock-guarantees" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The Lock Checker gives the following guarantee.
Suppose that expression <span style="font-style:italic">e</span> has type
<a href="../api/org/checkerframework/checker/lock/qual/GuardedBy.html"><span style="font-family:monospace">@GuardedBy</span></a><span style="font-family:monospace">(</span><span style="font-family:monospace">{</span><span style="font-family:monospace">"x", "y.z"</span><span style="font-family:monospace">}</span><span style="font-family:monospace">)</span>.
Then the value computed for <span style="font-style:italic">e</span> is only dereferenced by a thread when the
thread holds locks <span style="font-family:monospace">x</span> and <span style="font-family:monospace">y.z</span>.
Dereferencing a value is reading or writing one of its fields.
The guarantee about <span style="font-style:italic">e</span>&#X2019;s value
holds not only if the expression <span style="font-style:italic">e</span> is dereferenced
directly, but also if the value was first copied into a variable,
returned as the
result of a method call, etc.
Copying a reference is always
permitted by the Lock Checker, regardless of which locks are held.</p><p>A lock is held if it has been acquired but not yet released.
Java has two types of locks.
A monitor lock is acquired upon entry to a <span style="font-family:monospace">synchronized</span> method or block,
and is released on exit from that method or block.
An explicit lock is acquired by a method call such as
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/locks/Lock.html#lock--"><span style="font-family:monospace">Lock.lock()</span></a>,
and is released by another method call such as
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/locks/Lock.html#unlock--"><span style="font-family:monospace">Lock.unlock()</span></a>.
The Lock Checker enforces that any expression whose type implements
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/locks/Lock.html"><span style="font-family:monospace">Lock</span></a> is used as an
explicit lock, and all other expressions are used as monitor locks.
</p><p>Ensuring that your program obeys its locking discipline is an easy and
effective way to eliminate a common and important class of errors.
If the Lock Checker issues no warnings, then your program obeys its locking discipline.
However, your program might still have other types of concurrency errors.
For example, you might have specified an inadequate locking discipline
because you forgot some <a href="../api/org/checkerframework/checker/lock/qual/GuardedBy.html"><span style="font-family:monospace">@GuardedBy</span></a>
annotations.
Your program might release and
re-acquire the lock, when correctness requires it to hold it throughout a
computation.
And, there are other concurrency errors that cannot, or
should not, be solved with locks.</p>
<!--TOC section id="lock-annotations" Lock annotations-->
<h2 id="lock-annotations" class="section">7.2&#XA0;&#XA0;Lock annotations <a href="#lock-annotations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>This section describes the lock annotations you can write on types and methods.</p>
<!--TOC subsection id="lock-type-qualifiers" Type qualifiers-->
<h3 id="lock-type-qualifiers" class="subsection">7.2.1&#XA0;&#XA0;Type qualifiers <a href="#lock-type-qualifiers" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/lock/qual/GuardedBy.html"><span style="font-weight:bold"><span style="font-family:monospace">@GuardedBy</span></span></a><span style="font-weight:bold"><span style="font-size:small">(</span></span><span style="font-weight:bold"><span style="font-size:small"><em>exprSet</em></span></span><span style="font-weight:bold"><span style="font-size:small">)</span></span></dt><dd class="dd-description">
If a variable <span style="font-family:monospace">x</span> has type <span style="font-family:monospace">@GuardedBy("</span><span style="font-family:monospace"><em>expr</em></span><span style="font-family:monospace">")</span>, then a thread may
dereference the value referred to by <span style="font-family:monospace">x</span> only when the thread holds the
lock that <em>expr</em> currently evaluates to.<p>The <span style="font-family:monospace">@GuardedBy</span> annotation can list multiple expressions, as in
<span style="font-family:monospace">@GuardedBy(</span><span style="font-family:monospace">{</span><span style="font-family:monospace">"</span><span style="font-family:monospace"><em>expr1</em></span><span style="font-family:monospace">", "</span><span style="font-family:monospace"><em>expr2</em></span><span style="font-family:monospace">"</span><span style="font-family:monospace">}</span><span style="font-family:monospace">)</span>, in which case
the dereference is
permitted only if the thread holds all the locks.</p><p>Section&#XA0;<a href="#java-expressions-as-arguments">26.8</a> explains which
expressions the Lock Checker is able to analyze as lock expressions.
These include <span style="font-family:monospace">&lt;self&gt;</span>, i.e. the value of the annotated reference
(non-primitive) variable. For example, <span style="font-family:monospace">@GuardedBy("&lt;self&gt;") Object o</span>
indicates that the value referenced by <span style="font-family:monospace">o</span> is guarded by the intrinsic
(monitor) lock of the value referenced by <span style="font-family:monospace">o</span>.</p><p><span style="font-family:monospace">@GuardedBy({})</span>, which means the value is always allowed to be
dereferenced, is the default type qualifier that is used for all locations
where the programmer does not
write an explicit locking type qualifier (except all CLIMB-to-top locations
other than upper bounds and exception parameters &#X2014; see Section&#XA0;<a href="#climb-to-top">26.5.3</a>).
(Section&#XA0;<a href="#lock-checker-default-qualifier">7.5.4</a> discusses this choice.)
It is also the conservative
default type qualifier for method parameters in unannotated libraries
(see Chapter&#XA0;<a href="#annotating-libraries">30</a>).</p></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/lock/qual/GuardedByUnknown.html"><span style="font-weight:bold"><span style="font-family:monospace">@GuardedByUnknown</span></span></a></dt><dd class="dd-description">
If a variable <span style="font-family:monospace">x</span> has type <span style="font-family:monospace">@GuardedByUnknown</span>, then
it is not known which locks protect <span style="font-family:monospace">x</span>&#X2019;s value. Those locks might
even be out of scope (inaccessible) and therefore unable to be written
in the annotation.
The practical consequence is that
the value referred to by <span style="font-family:monospace">x</span> can never be dereferenced.<p>Any value can be assigned to a variable of type
<span style="font-family:monospace">@GuardedByUnknown</span>. In particular, if it is written on a
formal parameter, then any value,
including one whose locks are not currently held,
may be passed as an argument.</p><p><span style="font-family:monospace">@GuardedByUnknown</span> is the conservative
default type qualifier for method receivers in unannotated libraries
(see Chapter&#XA0;<a href="#annotating-libraries">30</a>).</p></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/lock/qual/GuardedByBottom.html"><span style="font-weight:bold"><span style="font-family:monospace">@GuardedByBottom</span></span></a></dt><dd class="dd-description">
If a variable <span style="font-family:monospace">x</span> has type <span style="font-family:monospace">@GuardedByBottom</span>, then
the value referred to by <span style="font-family:monospace">x</span> is <span style="font-family:monospace">null</span> and can never
be dereferenced.</dd></dl><blockquote class="figure"><div class="center"><hr style="width:80%;height:2"></div>
<div class="center">
<img src="lock-guardedby.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 7.1: The subtyping relationship of the Lock Checker&#X2019;s qualifiers.
<span style="font-family:monospace">@GuardedBy({})</span> is the default type qualifier for unannotated
types (except all CLIMB-to-top locations other than upper bounds and exception
parameters &#X2014; see Section&#XA0;<a href="#climb-to-top">26.5.3</a>).
</td></tr>
</table></div>
<a id="fig-lock-guardedby-hierarchy"></a>
<div class="center"><hr style="width:80%;height:2"></div></blockquote><p>Figure&#XA0;<a href="#fig-lock-guardedby-hierarchy">7.1</a> shows the type hierarchy of these
qualifiers.
All <span style="font-family:monospace">@GuardedBy</span> annotations are incomparable:
if <em>exprSet1</em> &#X2260; <em>exprSet2</em>, then <span style="font-family:monospace">@GuardedBy(</span><span style="font-family:monospace"><em>exprSet1</em></span><span style="font-family:monospace">)</span> and
<span style="font-family:monospace">@GuardedBy(</span><span style="font-family:monospace"><em>exprSet2</em></span><span style="font-family:monospace">)</span> are siblings in the type hierarchy.
You might expect that
<span style="font-family:monospace">@GuardedBy({"x", "y"}) T</span> is a subtype of <span style="font-family:monospace">@GuardedBy({"x"}) T</span>. The
first type requires two locks to be held, and the second requires only one
lock to be held and so could be used in any situation where both locks are
held. The type system conservatively prohibits this in order to prevent
type-checking loopholes that would result from aliasing and side effects
&#X2014; that is, from having two mutable references, of different types, to the
same data. See
Section&#XA0;<a href="#lock-guardedby-invariant-subtyping">7.4.2</a> for an example
of a problem that would occur if this rule were relaxed.</p>
<!--TOC paragraph id="lock-polymorphic-type-qualifiers" Polymorphic type qualifiers-->
<h5 id="lock-polymorphic-type-qualifiers" class="paragraph">Polymorphic type qualifiers <a href="#lock-polymorphic-type-qualifiers" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h5><!--SEC END --><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/lock/qual/GuardSatisfied.html"><span style="font-weight:bold"><span style="font-family:monospace">@GuardSatisfied</span></span></a><span style="font-weight:bold"><span style="font-size:small">(</span></span><span style="font-weight:bold"><span style="font-size:small"><em>index</em></span></span><span style="font-weight:bold"><span style="font-size:small">)</span></span></dt><dd class="dd-description">
If a variable <span style="font-family:monospace">x</span> has type <span style="font-family:monospace">@GuardSatisfied</span>, then all
lock expressions for <span style="font-family:monospace">x</span>&#X2019;s value are held.<p>As with other qualifier-polymorphism annotations
(Section&#XA0;<a href="#qualifier-polymorphism">25.2</a>), the <em>index</em> argument
indicates when two values are guarded by the same (unknown) set of locks.</p><p><span style="font-family:monospace">@GuardSatisfied</span> is only allowed in method signatures: on
formal parameters (including the receiver) and return types.
It may not be written on fields. Also, it is a limitation of the
current design that <span style="font-family:monospace">@GuardSatisfied</span> may not be written on
array elements or on local variables.</p><p>A return type can only be annotated with <span style="font-family:monospace">@GuardSatisfied(index)</span>,
not <span style="font-family:monospace">@GuardSatisfied</span>.</p><p>See Section&#XA0;<a href="#lock-checker-polymorphism-example">7.4.6</a>
for an example of a use of <span style="font-family:monospace">@GuardSatisfied</span>.</p></dd></dl>
<!--TOC subsection id="lock-declaration-annotations" Declaration annotations-->
<h3 id="lock-declaration-annotations" class="subsection">7.2.2&#XA0;&#XA0;Declaration annotations <a href="#lock-declaration-annotations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The Lock Checker supports several annotations that specify method behavior.
These are declaration annotations, not type annotations: they apply to the
method itself rather than to some particular type.</p>
<!--TOC paragraph id="lock-method-pre-post-conditions" Method pre-conditions and post-conditions-->
<h5 id="lock-method-pre-post-conditions" class="paragraph">Method pre-conditions and post-conditions <a href="#lock-method-pre-post-conditions" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h5><!--SEC END --><dl class="description"><dt class="dt-description">
<a href="../api/org/checkerframework/checker/lock/qual/Holding.html"><span style="font-weight:bold"><span style="font-family:monospace">@Holding</span></span></a><span style="font-weight:bold"><span style="font-size:small">(String[] locks)</span></span></dt><dd class="dd-description">
All the given lock expressions
are held at the method call site.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/lock/qual/EnsuresLockHeld.html"><span style="font-weight:bold"><span style="font-family:monospace">@EnsuresLockHeld</span></span></a><span style="font-weight:bold"><span style="font-size:small">(String[] locks)</span></span></dt><dd class="dd-description">
The given lock
expressions are
locked upon method return if the method
terminates successfully. This is useful for annotating a
method that acquires a lock such as
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/locks/ReentrantLock.html#lock--"><span style="font-family:monospace">ReentrantLock.lock()</span></a>.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/lock/qual/EnsuresLockHeldIf.html"><span style="font-weight:bold"><span style="font-family:monospace">@EnsuresLockHeldIf</span></span></a><span style="font-weight:bold"><span style="font-size:small">(String[] locks, boolean result)</span></span></dt><dd class="dd-description">
If the annotated method returns the given
boolean value (true or false), the given lock
expressions are locked upon method return if the method
terminates successfully.
This is useful for annotating a
method that conditionally acquires a lock.
See Section&#XA0;<a href="#ensureslockheld-examples">7.4.4</a> for examples.</dd></dl>
<!--TOC paragraph id="lock-side-effect-specifications" Side effect specifications-->
<h5 id="lock-side-effect-specifications" class="paragraph">Side effect specifications <a href="#lock-side-effect-specifications" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h5><!--SEC END --><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/lock/qual/LockingFree.html"><span style="font-weight:bold"><span style="font-family:monospace">@LockingFree</span></span></a></dt><dd class="dd-description">
The method does not acquire or release locks,
directly or indirectly. The method is not <span style="font-family:monospace">synchronized</span>, it contains
no <span style="font-family:monospace">synchronized</span> blocks, it contains no calls to <span style="font-family:monospace">lock</span> or <span style="font-family:monospace">unlock</span>
methods, and it contains no calls to methods that are not themselves <span style="font-family:monospace">@LockingFree</span>.<p>Since
<span style="font-family:monospace">@SideEffectFree</span> implies <span style="font-family:monospace">@LockingFree</span>, if both are applicable
then you only need to write <span style="font-family:monospace">@SideEffectFree</span>.</p></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/lock/qual/ReleasesNoLocks.html"><span style="font-weight:bold"><span style="font-family:monospace">@ReleasesNoLocks</span></span></a></dt><dd class="dd-description">
The method maintains a strictly nondecreasing lock hold count on the
current thread for any locks that were held prior
to the method call. The method might acquire locks but then release
them, or might acquire locks but not release them (in which case it should
also be annotated with
<a href="../api/org/checkerframework/checker/lock/qual/EnsuresLockHeld.html"><span style="font-family:monospace">@EnsuresLockHeld</span></a> or
<a href="../api/org/checkerframework/checker/lock/qual/EnsuresLockHeldIf.html"><span style="font-family:monospace">@EnsuresLockHeldIf</span></a>).<p>This is the default for methods being type-checked that have no <span style="font-family:monospace">@LockingFree</span>,
<span style="font-family:monospace">@MayReleaseLocks</span>, <span style="font-family:monospace">@SideEffectFree</span>, or <span style="font-family:monospace">@Pure</span>
annotation.</p></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/lock/qual/MayReleaseLocks.html"><span style="font-weight:bold"><span style="font-family:monospace">@MayReleaseLocks</span></span></a></dt><dd class="dd-description">
The method may release locks that were held prior to the method being called.
You can write this when you are certain the method releases locks, or
when you don&#X2019;t know whether the method releases locks.
This is the conservative default for methods in unannotated libraries (see Chapter&#XA0;<a href="#annotating-libraries">30</a>).</dd></dl>
<!--TOC section id="lock-type-checking-rules" Type-checking rules-->
<h2 id="lock-type-checking-rules" class="section">7.3&#XA0;&#XA0;Type-checking rules <a href="#lock-type-checking-rules" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>In addition to the standard subtyping rules enforcing the subtyping relationship
described in Figure&#XA0;<a href="#fig-lock-guardedby-hierarchy">7.1</a>, the Lock Checker enforces
the following additional rules.</p>
<!--TOC subsection id="lock-type-checking-rules-polymorphic-qualifiers" Polymorphic qualifiers-->
<h3 id="lock-type-checking-rules-polymorphic-qualifiers" class="subsection">7.3.1&#XA0;&#XA0;Polymorphic qualifiers <a href="#lock-type-checking-rules-polymorphic-qualifiers" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><dl class="description"><dt class="dt-description"><span style="font-weight:bold"><span style="font-family:monospace">@GuardSatisfied</span></span></dt><dd class="dd-description"><p>The overall rules for polymorphic qualifiers are given in
Section&#XA0;<a href="#qualifier-polymorphism">25.2</a>.</p><p>Here are additional constraints for (pseudo-)assignments:</p><ul class="itemize"><li class="li-itemize">
If the left-hand side has type <span style="font-family:monospace">@GuardSatisfied</span> (with or without an index),
then all locks mentioned in the right-hand side&#X2019;s <span style="font-family:monospace">@GuardedBy</span> type
must be currently held.
</li><li class="li-itemize">A formal parameter with type qualifier <span style="font-family:monospace">@GuardSatisfied</span> without an
index cannot be assigned to.
</li><li class="li-itemize">If the left-hand side is a formal parameter with type
<span style="font-family:monospace">@GuardSatisfied(</span><span style="font-family:monospace"><em>index</em></span><span style="font-family:monospace">)</span>, the right-hand-side must have
identical <span style="font-family:monospace">@GuardSatisfied(</span><span style="font-family:monospace"><em>index</em></span><span style="font-family:monospace">)</span> type.
</li></ul><p>If a formal parameter type is
annotated with <span style="font-family:monospace">@GuardSatisfied</span> without an index, then that formal parameter
type is unrelated to every other type in the <span style="font-family:monospace">@GuardedBy</span> hierarchy,
including other occurrences of <span style="font-family:monospace">@GuardSatisfied</span> without an index.</p><p><span style="font-family:monospace">@GuardSatisfied</span> may not be used on formal parameters, receivers, or
return types of a method annotated with <span style="font-family:monospace">@MayReleaseLocks</span>.
</p></dd></dl>
<!--TOC subsection id="lock-type-checking-rules-dereferences" Dereferences-->
<h3 id="lock-type-checking-rules-dereferences" class="subsection">7.3.2&#XA0;&#XA0;Dereferences <a href="#lock-type-checking-rules-dereferences" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><dl class="description"><dt class="dt-description"><span style="font-weight:bold"><span style="font-family:monospace">@GuardedBy</span></span></dt><dd class="dd-description">
An expression of type <span style="font-family:monospace">@GuardedBy(</span><span style="font-family:monospace"><em>eset</em></span><span style="font-family:monospace">)</span> may be dereferenced only
if all locks in <em>eset</em> are held.</dd><dt class="dt-description"><span style="font-weight:bold"><span style="font-family:monospace">@GuardSatisfied</span></span></dt><dd class="dd-description">
An expression of type <span style="font-family:monospace">@GuardSatisfied</span> may be dereferenced.</dd><dt class="dt-description"><span style="font-weight:bold">Not </span><span style="font-weight:bold"><span style="font-family:monospace">@GuardedBy</span></span><span style="font-weight:bold"> or </span><span style="font-weight:bold"><span style="font-family:monospace">@GuardSatisfied</span></span></dt><dd class="dd-description">
An expression whose type is not annotated with <span style="font-family:monospace">@GuardedBy</span> or
<span style="font-family:monospace">@GuardSatisfied</span> may not be dereferenced.
</dd></dl>
<!--TOC subsection id="lock-type-checking-rules-primitives" Primitive types, boxed primitive types, and Strings-->
<h3 id="lock-type-checking-rules-primitives" class="subsection">7.3.3&#XA0;&#XA0;Primitive types, boxed primitive types, and Strings <a href="#lock-type-checking-rules-primitives" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Primitive types, boxed primitive types (such as <span style="font-family:monospace">java.lang.Integer</span>), and type <span style="font-family:monospace">java.lang.String</span>
are annotated with <span style="font-family:monospace">@GuardedBy({})</span>.
It is an error for the programmer to annotate any of these types with an annotation from
the <span style="font-family:monospace">@GuardedBy</span> type hierarchy, including <span style="font-family:monospace">@GuardedBy({})</span>.</p>
<!--TOC subsection id="lock-type-checking-rules-overriding" Overriding-->
<h3 id="lock-type-checking-rules-overriding" class="subsection">7.3.4&#XA0;&#XA0;Overriding <a href="#lock-type-checking-rules-overriding" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><dl class="description"><dt class="dt-description"><span style="font-weight:bold">Overriding methods annotated with </span><span style="font-weight:bold"><span style="font-family:monospace">@Holding</span></span></dt><dd class="dd-description">
If class <span style="font-style:italic">B</span> overrides method <span style="font-style:italic">m</span> from class <span style="font-style:italic">A</span>, then the expressions in
<span style="font-style:italic">B</span>&#X2019;s <span style="font-family:monospace">@Holding</span>
annotation must be a subset of or equal to that of <span style="font-style:italic">A</span>&#X2019;s <span style="font-family:monospace">@Holding</span>
annotation.</dd><dt class="dt-description"><span style="font-weight:bold">Overriding methods annotated with side effect annotations</span></dt><dd class="dd-description">
If class <span style="font-style:italic">B</span> overrides method <span style="font-style:italic">m</span> from class <span style="font-style:italic">A</span>, then
the side effect annotation on <span style="font-style:italic">B</span>&#X2019;s declaration of <span style="font-style:italic">m</span>
must be at least as strong as that in <span style="font-style:italic">A</span>&#X2019;s declaration of <span style="font-style:italic">m</span>.
From weakest to strongest, the side effect annotations
processed by the Lock Checker are:
<pre class="verbatim">  @MayReleaseLocks
  @ReleasesNoLocks
  @LockingFree
  @SideEffectFree
  @Pure
</pre></dd></dl>
<!--TOC subsection id="lock-type-checking-rules-polymorphic-side-effects" Side effects-->
<h3 id="lock-type-checking-rules-polymorphic-side-effects" class="subsection">7.3.5&#XA0;&#XA0;Side effects <a href="#lock-type-checking-rules-polymorphic-side-effects" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><dl class="description"><dt class="dt-description"><span style="font-weight:bold">Releasing explicit locks</span></dt><dd class="dd-description">
Any method that releases an explicit lock must be annotated
with <span style="font-family:monospace">@MayReleaseLocks</span>.
The Lock Checker issues a warning if it encounters a method declaration
annotated with <span style="font-family:monospace">@MayReleaseLocks</span> and having a formal parameter
or receiver annotated with <span style="font-family:monospace">@GuardSatisfied</span>. This is because
the Lock Checker cannot guarantee that the guard will be satisfied
throughout the body of a method if that method may release a lock.</dd><dt class="dt-description"><span style="font-weight:bold">No side effects on lock expressions</span></dt><dd class="dd-description">
If expression <em>expr</em> is used to acquire a lock, then
<em>expr</em> must evaluate to the same value, starting from when
<em>expr</em> is used to acquire a lock until <em>expr</em> is used to
release the lock.
An expression is used to acquire a lock if it is the receiver at a
call site of a <span style="font-family:monospace">synchronized</span> method, is the expression in a
<span style="font-family:monospace">synchronized</span> block, or is the argument to a <span style="font-family:monospace">lock</span> method.</dd><dt class="dt-description"><span style="font-weight:bold">Locks are released after possible side effects</span></dt><dd class="dd-description">
After a call to a method annotated with <span style="font-family:monospace">@LockingFree</span>,
<span style="font-family:monospace">@ReleasesNoLocks</span>, <span style="font-family:monospace">@SideEffectFree</span>, or <span style="font-family:monospace">@Pure</span>,
the Lock Checker&#X2019;s estimate of held locks
after a method call is the same as that prior to the method call.
After a call to a method annotated with <span style="font-family:monospace">@MayReleaseLocks</span>,
the estimate of held locks is conservatively reset to the empty set,
except for those locks specified to be held after the call
by an <span style="font-family:monospace">@EnsuresLockHeld</span> or <span style="font-family:monospace">@EnsuresLockHeldIf</span>
annotation on the method. Assignments to variables also
cause the estimate of held locks to be conservatively reduced
to a smaller set if the Checker Framework determines that the
assignment might have side-effected a lock expression.
For more information on side effects, please refer to
Section&#XA0;<a href="#type-refinement-purity">26.7.5</a>.</dd></dl>
<!--TOC section id="lock-examples" Examples-->
<h2 id="lock-examples" class="section">7.4&#XA0;&#XA0;Examples <a href="#lock-examples" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The Lock Checker guarantees that a value that was computed from an expression of <span style="font-family:monospace">@GuardedBy</span> type is
dereferenced only when the current thread holds all the expressions in the
<span style="font-family:monospace">@GuardedBy</span> annotation.</p>
<!--TOC subsection id="lock-examples-guardedby" Examples of @GuardedBy-->
<h3 id="lock-examples-guardedby" class="subsection">7.4.1&#XA0;&#XA0;Examples of @GuardedBy <a href="#lock-examples-guardedby" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The following example demonstrates the basic
type-checking rules.</p><pre class="verbatim">class MyClass {
  final ReentrantLock lock; // Initialized in the constructor

  @GuardedBy("lock") Object x = new Object();
  @GuardedBy("lock") Object y = x; // OK, since dereferences of y will require "lock" to be held.
  @GuardedBy({}) Object z = x; // ILLEGAL since dereferences of z don't require "lock" to be held.
  @GuardedBy("lock") Object myMethod() { // myMethod is implicitly annotated with @ReleasesNoLocks.
     return x; // OK because the return type is annotated with @GuardedBy("lock")
  }

  [...]

  void exampleMethod() {
     x.toString(); // ILLEGAL because the lock is not known to be held
     y.toString(); // ILLEGAL because the lock is not known to be held
     myMethod().toString(); // ILLEGAL because the lock is not known to be held
     lock.lock();
     x.toString();  // OK: the lock is known to be held
     y.toString();  // OK: the lock is known to be held, and toString() is annotated with @SideEffectFree.
     myMethod().toString(); // OK: the lock is known to be held, since myMethod
                            // is implicitly annotated with @ReleasesNoLocks.
  }
}
</pre><p>Note that the expression <span style="font-family:monospace">new Object()</span> is inferred to have type <span style="font-family:monospace">@GuardedBy("lock")</span>
because it is immediately assigned to a newly-declared
variable having type annotation <span style="font-family:monospace">@GuardedBy("lock")</span>. You could
explicitly write <span style="font-family:monospace">new @GuardedBy("lock") Object()</span> but it is not
required.</p><p>The following example demonstrates that using <span style="font-family:monospace">&lt;self&gt;</span> as a lock expression
allows a guarded value to be dereferenced even when the original
variable name the value was originally assigned to falls out of scope.</p><pre class="verbatim">class MyClass {
  private final @GuardedBy("&lt;self&gt;") Object x = new Object();
  void method() {
    x.toString(); // ILLEGAL because x is not known to be held.
    synchronized(x) {
      x.toString(); // OK: x is known to be held.
    }
  }

  public @GuardedBy("&lt;self&gt;") Object get_x() {
    return x; // OK, since the return type is @GuardedBy("&lt;self&gt;").
  }
}

class MyOtherClass {
  void method() {
    MyClass m = new MyClass();
    final @GuardedBy("&lt;self&gt;") Object o = m.get_x();
    o.toString(); // ILLEGAL because o is not known to be held.
    synchronized(o) {
      o.toString(); // OK: o is known to be held.
    }
  }
}
</pre>
<!--TOC subsection id="lock-guardedby-invariant-subtyping" @GuardedBy({&#X201C;a&#X201D;, &#X201C;b&#X201D;}) is not a subtype of @GuardedBy({&#X201C;a&#X201D;})-->
<h3 id="lock-guardedby-invariant-subtyping" class="subsection">7.4.2&#XA0;&#XA0;@GuardedBy({&#X201C;a&#X201D;, &#X201C;b&#X201D;}) is not a subtype of @GuardedBy({&#X201C;a&#X201D;}) <a href="#lock-guardedby-invariant-subtyping" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p><span style="font-weight:bold">@GuardedBy(exprSet)</span></p><p>The following example demonstrates the reason the Lock Checker enforces the
following rule: if <em>exprSet1</em> &#X2260; <em>exprSet2</em>, then
<span style="font-family:monospace">@GuardedBy(</span><span style="font-family:monospace"><em>exprSet1</em></span><span style="font-family:monospace">)</span> and <span style="font-family:monospace">@GuardedBy(</span><span style="font-family:monospace"><em>exprSet2</em></span><span style="font-family:monospace">)</span> are siblings in the type
hierarchy.</p><pre class="verbatim">class MyClass {
    final Object lockA = new Object();
    final Object lockB = new Object();
    @GuardedBy("lockA") Object x = new Object();
    @GuardedBy({"lockA", "lockB"}) Object y = new Object();
    void myMethod() {
        y = x;      // ILLEGAL; if legal, later statement x.toString() would cause trouble
        synchronized(lockA) {
          x.toString();  // dereferences y's value without holding lock lockB
        }
    }
}
</pre><p>If the Lock Checker permitted the assignment
<span style="font-family:monospace">y = x;</span>, then the undesired dereference would be possible.</p>
<!--TOC subsection id="lock-examples-holding" Examples of @Holding-->
<h3 id="lock-examples-holding" class="subsection">7.4.3&#XA0;&#XA0;Examples of @Holding <a href="#lock-examples-holding" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The following example shows the interaction between <span style="font-family:monospace">@GuardedBy</span> and
<span style="font-family:monospace">@Holding</span>:</p><pre class="verbatim">  void helper1(@GuardedBy("myLock") Object a) {
    a.toString(); // ILLEGAL: the lock is not held
    synchronized(myLock) {
      a.toString();  // OK: the lock is held
    }
  }
  @Holding("myLock")
  void helper2(@GuardedBy("myLock") Object b) {
    b.toString(); // OK: the lock is held
  }
  void helper3(@GuardedBy("myLock") Object d) {
    d.toString(); // ILLEGAL: the lock is not held
  }
  void myMethod2(@GuardedBy("myLock") Object e) {
    helper1(e);  // OK to pass to another routine without holding the lock
                 // (but helper1's body has an error)
    e.toString(); // ILLEGAL: the lock is not held
    synchronized (myLock) {
      helper2(e); // OK: the lock is held
      helper3(e); // OK, but helper3's body has an error
    }
  }
</pre>
<!--TOC subsection id="ensureslockheld-examples" Examples of @EnsuresLockHeld and @EnsuresLockHeldIf-->
<h3 id="ensureslockheld-examples" class="subsection">7.4.4&#XA0;&#XA0;Examples of @EnsuresLockHeld and @EnsuresLockHeldIf <a href="#ensureslockheld-examples" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p><span style="font-family:monospace">@EnsuresLockHeld</span> and <span style="font-family:monospace">@EnsuresLockHeldIf</span> are primarily intended
for annotating JDK locking methods, as in:</p><pre class="verbatim">package java.util.concurrent.locks;

class ReentrantLock {

    @EnsuresLockHeld("this")
    public void lock();

    @EnsuresLockHeldIf (expression="this", result=true)
    public boolean tryLock();

    ...
}
</pre><p>They can also be used to annotate user methods, particularly for
higher-level lock constructs such as a Monitor, as in this simplified example:</p><pre class="verbatim">public class Monitor {

    private final ReentrantLock lock; // Initialized in the constructor

    ...

    @EnsuresLockHeld("lock")
    public void enter() {
       lock.lock();
    }

    ...
}
</pre>
<!--TOC subsection id="lock-lockingfree-example" Example of @LockingFree, @ReleasesNoLocks, and @MayReleaseLocks-->
<h3 id="lock-lockingfree-example" class="subsection">7.4.5&#XA0;&#XA0;Example of @LockingFree, @ReleasesNoLocks, and @MayReleaseLocks <a href="#lock-lockingfree-example" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p><span style="font-family:monospace">@LockingFree</span> is useful when a method does not make any use of synchronization
or locks but causes other side effects (hence <span style="font-family:monospace">@SideEffectFree</span> is not appropriate).
<span style="font-family:monospace">@SideEffectFree</span> implies <span style="font-family:monospace">@LockingFree</span>, therefore if both are applicable,
you should only write <span style="font-family:monospace">@SideEffectFree</span>. <span style="font-family:monospace">@ReleasesNoLocks</span> has a weaker guarantee
than <span style="font-family:monospace">@LockingFree</span>, and <span style="font-family:monospace">@MayReleaseLocks</span> provides no guarantees.</p><pre class="verbatim">private Object myField;
private final ReentrantLock lock; // Initialized in the constructor
private @GuardedBy("lock") Object x; // Initialized in the constructor

[...]

// This method does not use locks or synchronization, but it cannot
// be annotated as @SideEffectFree since it alters myField.
@LockingFree
void myMethod() {
  myField = new Object();
}

@SideEffectFree
int mySideEffectFreeMethod() {
  return 0;
}

@MayReleaseLocks
void myUnlockingMethod() {
  lock.unlock();
}

@ReleasesNoLocks
void myLockingMethod() {
  lock.lock();
}

@MayReleaseLocks
void clientMethod() {
  if (lock.tryLock()) {
    x.toString(); // OK: the lock is held
    myMethod();
    x.toString(); // OK: the lock is still held since myMethod is locking-free
    mySideEffectFreeMethod();
    x.toString(); // OK: the lock is still held since mySideEffectFreeMethod is side-effect-free
    myUnlockingMethod();
    x.toString(); // ILLEGAL: myUnlockingMethod may have released a lock
  }
  if (lock.tryLock()) {
    x.toString(); // OK: the lock is held
    myLockingMethod();
    x.toString(); // OK: the lock is held
  }
  if (lock.isHeldByCurrentThread()) {
    x.toString(); // OK: the lock is known to be held
  }
}
</pre>
<!--TOC subsection id="lock-checker-polymorphism-example" Polymorphism and method formal parameters with unknown guards-->
<h3 id="lock-checker-polymorphism-example" class="subsection">7.4.6&#XA0;&#XA0;Polymorphism and method formal parameters with unknown guards <a href="#lock-checker-polymorphism-example" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The polymorphic <span style="font-family:monospace">@GuardSatisfied</span> type annotation allows a method body
to dereference the method&#X2019;s formal parameters even if the
<span style="font-family:monospace">@GuardedBy</span> annotations on the actual parameters are unknown at
the method declaration site.</p><p>The declaration of
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/StringBuffer.html#append-java.lang.String-"><span style="font-family:monospace">StringBuffer.append(String str)</span></a>
is annotated as:</p><pre class="verbatim">@LockingFree
public @GuardSatisfied(1) StringBuffer append(@GuardSatisfied(1) StringBuffer this,
                                              @GuardSatisfied(2) String str)
</pre><p>The method manipulates the values of its arguments, so all their locks must
be held. However, the declaration does not know what those are and they
might not even be in scope at the declaration. Therefore, the declaration
cannot use <span style="font-family:monospace">@GuardedBy</span> and must use <span style="font-family:monospace">@GuardSatisfied</span>. The arguments to
<span style="font-family:monospace">@GuardSatisfied</span> indicate that the receiver and result (which are the
same value) are guarded by the same (unknown, possibly empty) set of locks,
and the <span style="font-family:monospace">str</span> parameter may be guarded by a different set of locks.</p><p>The <span style="font-family:monospace">@LockingFree</span> annotation indicates that
this method makes no use of
locks or synchronization.</p><p>Given these annotations on <span style="font-family:monospace">append</span>, the following code type-checks:</p><pre class="verbatim">final ReentrantLock lock1, lock2; // Initialized in the constructor
@GuardedBy("lock1") StringBuffer filename;
@GuardedBy("lock2") StringBuffer extension;
...
lock1.lock();
lock2.lock();
filename = filename.append(extension);
</pre>
<!--TOC section id="lock-details" More locking details-->
<h2 id="lock-details" class="section">7.5&#XA0;&#XA0;More locking details <a href="#lock-details" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>This section gives some details that are helpful for understanding how Java
locking and the Lock Checker works.</p>
<!--TOC subsection id="lock-two-types" Two types of locking: monitor locks and explicit locks-->
<h3 id="lock-two-types" class="subsection">7.5.1&#XA0;&#XA0;Two types of locking: monitor locks and explicit locks <a href="#lock-two-types" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Java provides two types of locking: monitor locks and explicit locks.</p><ul class="itemize"><li class="li-itemize">
A <span style="font-family:monospace">synchronized(</span><span style="font-family:monospace"><em>E</em></span><span style="font-family:monospace">)</span> block acquires the lock on the value of
<em>E</em>; similarly, a method declared using the <span style="font-family:monospace">synchronized</span> method
modifier acquires the lock on the method receiver when called.
(More precisely,
the current thread locks the monitor associated with the value of
<em>E</em>; see <a href="https://docs.oracle.com/javase/specs/jls/se10/html/jls-17.html#jls-17.1">JLS &#XA7;17.1</a>.)
The lock is automatically released when execution exits the block or the
method body, respectively.
We use the term &#X201C;monitor lock&#X201D; for a lock acquired using a
<span style="font-family:monospace">synchronized</span> block or <span style="font-family:monospace">synchronized</span> method modifier.
</li><li class="li-itemize">A method call, such as
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/locks/Lock.html#lock--"><span style="font-family:monospace">Lock.lock()</span></a>,
acquires a lock that implements the
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/locks/Lock.html"><span style="font-family:monospace">Lock</span></a>
interface.
The lock is released by another method call, such as
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/locks/Lock.html#unlock--"><span style="font-family:monospace">Lock.unlock()</span></a>.
We use the term &#X201C;explicit lock&#X201D; for a lock expression acquired in this
way.
</li></ul><p>You should not mix the two varieties of locking, and the Lock Checker
enforces this. To prevent an object from being used both as a monitor and
an explicit lock, the Lock Checker issues a warning if a
<span style="font-family:monospace">synchronized(</span><span style="font-family:monospace"><em>E</em></span><span style="font-family:monospace">)</span> block&#X2019;s expression <span style="font-family:monospace"><em>E</em></span> has a type that
implements <a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/locks/Lock.html"><span style="font-family:monospace">Lock</span></a>.
</p>
<!--TOC subsection id="lock-aliasing" Held locks and held expressions; aliasing-->
<h3 id="lock-aliasing" class="subsection">7.5.2&#XA0;&#XA0;Held locks and held expressions; aliasing <a href="#lock-aliasing" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Whereas Java locking is defined in terms of values, Java programs are
written in terms of expressions.
We say that a lock expression is held if the value to which the expression
currently evaluates is held.</p><p>The Lock Checker conservatively estimates the expressions that are held at
each point in a program.
The Lock Checker does not track aliasing
(different expressions that evaluate to the same value); it only considers
the exact expression used to acquire a lock to be held. After any statement
that might side-effect a held expression or a lock expression, the Lock
Checker conservatively considers the expression to be no longer held.</p><p>Section&#XA0;<a href="#java-expressions-as-arguments">26.8</a> explains which Java
expressions the Lock Checker is able to analyze as lock expressions.</p><p>The <span style="font-family:monospace">@LockHeld</span> and <span style="font-family:monospace">@LockPossiblyHeld</span> type qualifiers are used internally by the Lock Checker
and should never be written by the programmer.
If you
see a warning mentioning <span style="font-family:monospace">@LockHeld</span> or <span style="font-family:monospace">@LockPossiblyHeld</span>,
please contact the Checker Framework developers as it is likely to
indicate a bug in the Checker Framework.</p>
<!--TOC subsection id="lock-runtime-checks" Run-time checks for locking-->
<h3 id="lock-runtime-checks" class="subsection">7.5.3&#XA0;&#XA0;Run-time checks for locking <a href="#lock-runtime-checks" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>When you perform a run-time check for locking, such as
<span style="font-family:monospace">if (explicitLock.isHeldByCurrentThread()){...}</span> or
<span style="font-family:monospace">if (Thread.holdsLock(monitorLock)){...}</span>,
then the Lock Checker considers the lock expression to be held
within the scope of the test. For more details, see
Section&#XA0;<a href="#type-refinement">26.7</a>.
</p>
<!--TOC subsection id="lock-checker-default-qualifier" Discussion of default qualifier-->
<h3 id="lock-checker-default-qualifier" class="subsection">7.5.4&#XA0;&#XA0;Discussion of default qualifier <a href="#lock-checker-default-qualifier" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The default qualifier for unannotated types is <span style="font-family:monospace">@GuardedBy({})</span>.
This default forces you to write explicit <span style="font-family:monospace">@GuardSatisfied</span> in method
signatures in the common case that clients ensure that all locks are held.</p><p>It might seem that <span style="font-family:monospace">@GuardSatisfied</span> would be a better default for
method signatures, but such a default would require even more annotations.
The reason is that <span style="font-family:monospace">@GuardSatisfied</span> cannot be used on fields. If
<span style="font-family:monospace">@GuardedBy({})</span> is the default for fields but <span style="font-family:monospace">@GuardSatisfied</span> is the
default for parameters and return types, then getters, setters, and many
other types of methods do not type-check without explicit lock qualifiers.</p>
<!--TOC subsection id="lock-checker-holding" Discussion of <span style="font-family:monospace">@Holding</span>-->
<h3 id="lock-checker-holding" class="subsection">7.5.5&#XA0;&#XA0;Discussion of <span style="font-family:monospace">@Holding</span> <a href="#lock-checker-holding" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>A programmer might choose to use the <span style="font-family:monospace">@Holding</span> method annotation in
two different ways: to specify correctness constraints for a
synchronization protocol, or to summarize intended usage. Both of these
approaches are useful, and the Lock Checker supports both.</p>
<!--TOC paragraph id="lock-checker-holding-synchronization-protocol" Synchronization protocol-->
<h5 id="lock-checker-holding-synchronization-protocol" class="paragraph">Synchronization protocol <a href="#lock-checker-holding-synchronization-protocol" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h5><!--SEC END --><p><span style="font-family:monospace">@Holding</span> can specify a synchronization protocol that
is not expressible as locks over the parameters to a method. For example, a global lock
or a lock on a different object might need to be held. By requiring locks to be
held, you can create protocol primitives without giving up
the benefits of the annotations and checking of them.</p>
<!--TOC paragraph id="lock-checker-holding-method-summary" Method summary that simplifies reasoning-->
<h5 id="lock-checker-holding-method-summary" class="paragraph">Method summary that simplifies reasoning <a href="#lock-checker-holding-method-summary" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h5><!--SEC END --><p><span style="font-family:monospace">@Holding</span> can be a method summary that simplifies reasoning. In
this case, the <span style="font-family:monospace">@Holding</span> doesn&#X2019;t necessarily introduce a new
correctness constraint; the program might be correct even if the lock
were not already acquired.</p><p>Rather, here <span style="font-family:monospace">@Holding</span> expresses a fact about execution: when
execution reaches this point, the following locks are known to be already held. This
fact enables people and tools to reason intra- rather than
inter-procedurally.</p><p>In Java, it is always legal to re-acquire a lock that is already held,
and the re-acquisition always works. Thus, whenever you write</p><pre class="verbatim">  @Holding("myLock")
  void myMethod() {
    ...
  }
</pre><p>it would be equivalent, from the point of view of which locks are held
during the body, to write</p><pre class="verbatim">  void myMethod() {
    synchronized (myLock) {   // no-op:  re-acquire a lock that is already held
      ...
    }
  }
</pre><p>It is better to write a <span style="font-family:monospace">@Holding</span> annotation rather than writing the
extra synchronized block. Here are reasons:</p><ul class="itemize"><li class="li-itemize">
The annotation documents the fact that the lock is intended to already be
held; that is, the method&#X2019;s contract requires that the lock be held when
the method is called.
</li><li class="li-itemize">The Lock Checker enforces that the lock is held when the method is
called, rather than masking a programmer error by silently re-acquiring
the lock.
</li><li class="li-itemize">The version with a synchronized statement can deadlock if, due to a programmer error,
the lock is not already held. The Lock Checker prevents this type of
error.
</li><li class="li-itemize">The annotation has no run-time overhead. The lock re-acquisition
consumes time, even if it succeeds.
</li></ul>
<!--TOC section id="lock-other-annotations" Other lock annotations-->
<h2 id="lock-other-annotations" class="section">7.6&#XA0;&#XA0;Other lock annotations <a href="#lock-other-annotations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The Checker Framework&#X2019;s lock annotations are similar to annotations used
elsewhere.</p><p>If your code is already annotated with a different lock
annotation, the Checker Framework can type-check your code.
It treats annotations from other tools
as if you had written the corresponding annotation from the
Lock Checker, as described in Figure&#XA0;<a href="#fig-lock-refactoring">7.2</a>.
If the other annotation is a declaration annotation, it may be moved; see
Section&#XA0;<a href="#declaration-annotations-moved">28.1.1</a>.</p><blockquote class="figure"><div class="center"><hr style="width:80%;height:2"></div>
<div class="center">
<table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="text-align:left;white-space:nowrap" ><table border=1  style="border-spacing:0;" class="cellpadding1"><tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;net.jcip.annotations.GuardedBy&#XA0; </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;javax.annotation.concurrent.GuardedBy&#XA0; </td></tr>
</table></td><td style="text-align:left;white-space:nowrap" >&#X21D2;
&#XA0;org.checkerframework.checker.lock.qual.GuardedBy (for fields) or &#X2026;Holding (for methods)&#XA0;
</td></tr>
</table></div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 7.2: Correspondence between other lock annotations and the
Checker Framework&#X2019;s annotations.</td></tr>
</table></div>
<a id="fig-lock-refactoring"></a>
<div class="center"><hr style="width:80%;height:2"></div></blockquote>
<!--TOC subsection id="lock-jcip-annotations" Relationship to annotations in <em>Java Concurrency in Practice</em>-->
<h3 id="lock-jcip-annotations" class="subsection">7.6.1&#XA0;&#XA0;Relationship to annotations in <em>Java Concurrency in Practice</em> <a href="#lock-jcip-annotations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The book <a href="http://jcip.net/"><em>Java Concurrency in Practice</em></a>&#XA0;[<a href="#Goetz2006">GPB+06</a>] defines a
<a href="http://jcip.net.s3-website-us-east-1.amazonaws.com/annotations/doc/net/jcip/annotations/GuardedBy.html"><span style="font-family:monospace">@GuardedBy</span></a> annotation that is the inspiration for ours. The book&#X2019;s
<span style="font-family:monospace">@GuardedBy</span> serves two related but distinct purposes:</p><ul class="itemize"><li class="li-itemize">
When applied to a field, it means that the given lock must be held when
accessing the field. The lock acquisition and the field access may occur
arbitrarily far in the future.
</li><li class="li-itemize">When applied to a method, it means that the given lock must be held by
the caller at the time that the method is called &#X2014; in other words, at
the time that execution passes the <span style="font-family:monospace">@GuardedBy</span> annotation.
</li></ul><p>The Lock Checker renames the method annotation to
<a href="../api/org/checkerframework/checker/lock/qual/Holding.html"><span style="font-family:monospace">@Holding</span></a>, and it generalizes the
<a href="../api/org/checkerframework/checker/lock/qual/GuardedBy.html"><span style="font-family:monospace">@GuardedBy</span></a> annotation into a type annotation
that can apply not just to a field but to an arbitrary type (including the
type of a parameter, return value, local variable, generic type parameter,
etc.). Another important distinction is that the Lock Checker&#X2019;s
annotations express and enforce a locking discipline over values, just like
the JLS expresses Java&#X2019;s locking semantics; by contrast, JCIP&#X2019;s annotations
express a locking discipline that protects variable names and does not
prevent race conditions.
This makes the annotations more expressive and also more amenable
to automated checking. It also accommodates the distinct
meanings of the two annotations, and resolves ambiguity when <span style="font-family:monospace">@GuardedBy</span>
is written in a location that might apply to either the method or the
return type.</p><p>(The JCIP book gives some rationales for reusing the annotation name for
two purposes. One rationale is
that there are fewer annotations to learn. Another rationale is
that both variables and methods are &#X201C;members&#X201D; that can be &#X201C;accessed&#X201D;
and <span style="font-family:monospace">@GuardedBy</span> creates preconditions for doing so.
Variables can be accessed by reading or writing them (putfield, getfield),
and methods can be accessed by calling them (invokevirtual,
invokeinterface). This informal intuition is
inappropriate for a tool that requires precise semantics.)</p>
<!--TOC section id="lock-extensions" Possible extensions-->
<h2 id="lock-extensions" class="section">7.7&#XA0;&#XA0;Possible extensions <a href="#lock-extensions" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The Lock Checker validates some uses of locks, but not all. It would be
possible to enrich it with additional annotations. This would increase the
programmer annotation burden, but would provide additional guarantees.</p><p>Lock ordering: Specify that one lock must be acquired before or after
another, or specify a global ordering for all locks. This would prevent
deadlock.</p><p>Not-holding: Specify that a method must not be called if any of the listed
locks are held.</p><p>These features are supported by
<a href="http://clang.llvm.org/docs/ThreadSafetyAnalysis.html">Clang&#X2019;s
thread-safety analysis</a>.</p><hr>
<!--TOC chapter id="index-checker" Index Checker for sequence bounds (arrays and strings)-->
<h1 id="index-checker" class="chapter">Chapter&#XA0;8&#XA0;&#XA0;Index Checker for sequence bounds (arrays and strings) <a href="#index-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h1><!--SEC END --><p>The Index Checker warns about potentially out-of-bounds accesses to sequence
data structures, such as arrays
and strings.</p><p>The Index Checker prevents <span style="font-family:monospace">IndexOutOfBoundsException</span>s that result from
an index expression that might be negative or might be equal to or larger
than the sequence&#X2019;s length.
It also prevents <span style="font-family:monospace">NegativeArraySizeException</span>s that result from a negative
array dimension in an array creation expression.
(A caveat: the Index Checker does not check for arithmetic overflow. If
an expression overflows, the Index Checker might fail to warn about a
possible exception. This is unlikely to be a problem in practice unless
you have an array whose length is <span style="font-family:monospace">Integer.MAX_VALUE</span>.)</p><p>The programmer can write annotations that indicate which expressions are
indices for which sequences. The Index Checker prohibits any operation that
may violate these properties, and the Index Checker takes advantage of
these properties when verifying indexing operations.
Typically, a programmer writes few annotations, because the Index Checker
infers properties of indexes from
the code around them. For example, it will infer that <span style="font-family:monospace">x</span> is positive
within the <span style="font-family:monospace">then</span> block of an <span style="font-family:monospace">if (x &gt; 0)</span> statement.
The programmer does need to write field types and method pre-conditions or post-conditions. For instance,
if a method&#X2019;s formal parameter is used as an index for
<span style="font-family:monospace">myArray</span>, the programmer might need to
write an <a href="../api/org/checkerframework/checker/index/qual/IndexFor.html"><span style="font-family:monospace">@IndexFor</span></a><span style="font-family:monospace">("myArray")</span>
annotation on the formal parameter&#X2019;s types.</p><p>The Index Checker checks fixed-size data structures, whose size is never
changed after creation. A fixed-size data structure has no <span style="font-family:monospace">add</span> or
<span style="font-family:monospace">remove</span> operation. Examples are strings and arrays, and you can add
support for other fixed-size data structures (see
Section&#XA0;<a href="#index-annotating-fixed-size">8.9</a>).</p><p>To run the Index Checker, run the command</p><pre>
  javac -processor index <em>MyJavaFile</em>.java
</pre><p>Recall that in Java, type annotations are written before the type;
in particular,
array annotations appear immediately before &#X201C;<span style="font-family:monospace">[]</span>&#X201D;.
Here is how to declare a length-9 array of positive integers:</p><pre class="verbatim">  @Positive int @ArrayLen(9) []
</pre><p>Multi-dimensional arrays are similar.
Here is how to declare a length-2 array of length-4 arrays:</p><pre class="verbatim">  String @ArrayLen(2) [] @ArrayLen(4) []
</pre>
<!--TOC section id="index-annotations" Index Checker structure and annotations-->
<h2 id="index-annotations" class="section">8.1&#XA0;&#XA0;Index Checker structure and annotations <a href="#index-annotations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>Internally, the Index Checker computes information about integers that
might be indices:
</p><ul class="itemize"><li class="li-itemize">
the lower bound on an integer, such as whether it is known to be positive
(Section&#XA0;<a href="#index-lowerbound">8.2</a>)
</li><li class="li-itemize">the upper bound on an integer, such as whether it is less than the length
of a given sequence (Section&#XA0;<a href="#index-upperbound">8.3</a>)
</li><li class="li-itemize">whether an integer came from calling the JDK&#X2019;s binary search routine on
an array (Section&#XA0;<a href="#index-searchindex">8.6</a>)
</li><li class="li-itemize">whether an integer came from calling a string search routine
(Section&#XA0;<a href="#index-substringindex">8.7</a>)
</li></ul><p>and about sequence lengths:
</p><ul class="itemize"><li class="li-itemize">
the minimum length of a sequence, such &#X201C;<span style="font-family:monospace">myArray</span> contains at least 3
elements&#X201D; (Section&#XA0;<a href="#index-minlen">8.4</a>)
</li><li class="li-itemize">whether two sequences have the same length (Section&#XA0;<a href="#index-samelen">8.5</a>)
</li></ul><p>The Index Checker checks of all these properties at once, but
this manual discusses each type system in a different section.
There are some annotations that are shorthand for writing multiple
annotations, each from a different type system:</p><dl class="description"><dt class="dt-description">
<a href="../api/org/checkerframework/checker/index/qual/IndexFor.html"><span style="font-weight:bold"><span style="font-family:monospace">@IndexFor</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] names)</span></span></dt><dd class="dd-description">
The value is a valid index for the named sequences. For example, the
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html#charAt-int-"><span style="font-family:monospace">String.charAt(int)</span></a>
method is declared as<pre class="verbatim">  class String {
    char charAt(@IndexFor("this") index) { ... }
  }
  </pre><p>More generally, a variable
declared as <span style="font-family:monospace">@IndexFor("someArray") int i</span> has type
<span style="font-family:monospace">@IndexFor("someArray") int</span> and its run-time value is guaranteed to be
non-negative and less than the length of <span style="font-family:monospace">someArray</span>. You could also
express this as
<a href="../api/org/checkerframework/checker/index/qual/NonNegative.html"><span style="font-family:monospace">@NonNegative</span></a><span style="font-family:monospace">
</span><a href="../api/org/checkerframework/checker/index/qual/LTLengthOf.html"><span style="font-family:monospace">@LTLengthOf</span></a><span style="font-family:monospace">("someArray")</span><span style="font-family:monospace">
int i</span>,
but <span style="font-family:monospace">@IndexFor("someArray") int i</span> is more concise.</p></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/IndexOrHigh.html"><span style="font-weight:bold"><span style="font-family:monospace">@IndexOrHigh</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] names)</span></span></dt><dd class="dd-description">
The value is non-negative and is less than or equal to the length of
each named sequence. This type combines
<a href="../api/org/checkerframework/checker/index/qual/NonNegative.html"><span style="font-family:monospace">@NonNegative</span></a> and
<a href="../api/org/checkerframework/checker/index/qual/LTEqLengthOf.html"><span style="font-family:monospace">@LTEqLengthOf</span></a>.<p>For example, the
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Arrays.html#fill-java.lang.Object:A-int-int-java.lang.Object-"><span style="font-family:monospace">Arrays.fill</span></a>
method is declared as</p><div style="font-size:small;">
<pre class="verbatim">  class Arrays {
    void fill(Object[] a, @IndexFor("#1") int fromIndex, @IndexOrHigh("#1") int toIndex, Object val)
  }
  </pre></div></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/LengthOf.html"><span style="font-weight:bold"><span style="font-family:monospace">@LengthOf</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] names)</span></span></dt><dd class="dd-description">
The value is exactly equal to the length of the named
sequences. In the implementation, this type aliases
<a href="../api/org/checkerframework/checker/index/qual/IndexOrHigh.html"><span style="font-family:monospace">@IndexOrHigh</span></a>, so writing it
only adds documentation (although future versions of the Index Checker
may use it to improve precision).</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/IndexOrLow.html"><span style="font-weight:bold"><span style="font-family:monospace">@IndexOrLow</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] names)</span></span></dt><dd class="dd-description">
The value is -1 or is a valid index for
each named sequence. This type combines
<a href="../api/org/checkerframework/checker/index/qual/GTENegativeOne.html"><span style="font-family:monospace">@GTENegativeOne</span></a> and
<a href="../api/org/checkerframework/checker/index/qual/LTLengthOf.html"><span style="font-family:monospace">@LTLengthOf</span></a>.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/PolyIndex.html"><span style="font-weight:bold"><span style="font-family:monospace">@PolyIndex</span></span></a></dt><dd class="dd-description">
indicates qualifier polymorphism. This type combines
<a href="../api/org/checkerframework/checker/index/qual/PolyLowerBound.html"><span style="font-family:monospace">@PolyLowerBound</span></a> and
<a href="../api/org/checkerframework/checker/index/qual/PolyUpperBound.html"><span style="font-family:monospace">@PolyUpperBound</span></a>.
For a description of qualifier polymorphism, see
Section&#XA0;<a href="#qualifier-polymorphism">25.2</a>.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/PolyLength.html"><span style="font-weight:bold"><span style="font-family:monospace">@PolyLength</span></span></a></dt><dd class="dd-description">
is a special polymorphic qualifier that combines
<a href="../api/org/checkerframework/checker/index/qual/PolySameLen.html"><span style="font-family:monospace">@PolySameLen</span></a> and
<a href="../api/org/checkerframework/common/value/qual/PolyValue.html"><span style="font-family:monospace">@PolyValue</span></a> from the
Constant Value Checker (see Chapter&#XA0;<a href="#constant-value-checker">21</a>).
<a href="../api/org/checkerframework/checker/index/qual/PolyLength.html"><span style="font-family:monospace">@PolyLength</span></a> exists
as a shorthand for these two annotations, since
they often appear together.</dd></dl>
<!--TOC section id="index-lowerbound" Lower bounds-->
<h2 id="index-lowerbound" class="section">8.2&#XA0;&#XA0;Lower bounds <a href="#index-lowerbound" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The Index Checker issues an error when
a sequence is indexed by an integer that might be negative.
The Lower Bound Checker uses a type system (Figure&#XA0;<a href="#fig-index-int-types">8.1</a>) with the following
qualifiers:</p><dl class="description"><dt class="dt-description">
<a href="../api/org/checkerframework/checker/index/qual/Positive.html"><span style="font-weight:bold"><span style="font-family:monospace">@Positive</span></span></a></dt><dd class="dd-description">
The value is 1 or greater, so it is not too low to be used as an index.
Note that this annotation is trusted by the Constant Value Checker,
so if the Constant Value Checker is run on code containing this annotation,
the Lower Bound Checker must be run on the same code in order to
guarantee soundness.
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/NonNegative.html"><span style="font-weight:bold"><span style="font-family:monospace">@NonNegative</span></span></a></dt><dd class="dd-description">
The value is 0 or greater, so it is not too low to be used as an index.
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/GTENegativeOne.html"><span style="font-weight:bold"><span style="font-family:monospace">@GTENegativeOne</span></span></a></dt><dd class="dd-description">
The value is -1 or greater.
It may not be used as an index for a sequence, because it might be too low.
(&#X201C;<span style="font-family:monospace">GTE</span>&#X201D; stands for &#X201C;Greater Than or Equal to&#X201D;.)
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/PolyLowerBound.html"><span style="font-weight:bold"><span style="font-family:monospace">@PolyLowerBound</span></span></a></dt><dd class="dd-description">
indicates qualifier polymorphism.
For a description of qualifier polymorphism, see
Section&#XA0;<a href="#qualifier-polymorphism">25.2</a>.
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/LowerBoundUnknown.html"><span style="font-weight:bold"><span style="font-family:monospace">@LowerBoundUnknown</span></span></a></dt><dd class="dd-description">
There is no information about the value.
It may not be used as an index for a sequence, because it might be too low.
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/LowerBoundBottom.html"><span style="font-weight:bold"><span style="font-family:monospace">@LowerBoundBottom</span></span></a></dt><dd class="dd-description">
The value cannot take on any integral types. The bottom type, which
should not need to be written by the programmer.
</dd></dl><blockquote class="figure"><div class="center"><hr style="width:80%;height:2"></div>
<div class="center">
<img src="lowerbound.svg">
&#XA0;&#XA0;&#XA0;&#XA0;&#XA0;&#XA0;&#XA0;&#XA0;
<img src="upperbound.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 8.1: The two type hierarchies for integer types used by the Index
Checker. On the left is a type system for lower bounds. On the right
is a type system for upper bounds. Qualifiers written in gray should
never be written in source code; they are used internally by the type
system. <span style="font-family:monospace">"myArray"</span> in the Upper Bound qualifiers is an example of
an array&#X2019;s name.</td></tr>
</table></div>
<a id="fig-index-int-types"></a>
<div class="center"><hr style="width:80%;height:2"></div></blockquote>
<!--TOC section id="index-upperbound" Upper bounds-->
<h2 id="index-upperbound" class="section">8.3&#XA0;&#XA0;Upper bounds <a href="#index-upperbound" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The Index Checker issues an error when a sequence index might be
too high. To do this, it maintains information about which expressions are
safe indices for which sequences.
The length of a sequence is <span style="font-family:monospace">arr.length</span> for arrays and
<span style="font-family:monospace">str.length()</span> for strings.
It uses a type system (Figure&#XA0;<a href="#fig-index-int-types">8.1</a>) with the following
qualifiers:</p><p>It issues an error when a sequence <span style="font-family:monospace">arr</span>
is indexed by an integer that is not of type <span style="font-family:monospace">@LTLengthOf("arr")</span>
or <span style="font-family:monospace">@LTOMLengthOf("arr")</span>.</p><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/LTLengthOf.html"><span style="font-weight:bold"><span style="font-family:monospace">@LTLengthOf</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] names, String[] offset)</span></span></dt><dd class="dd-description">
An expression with this type
has value less than the length of each sequence listed in <span style="font-family:monospace">names</span>.
The expression may be used as an index into any of those sequences,
if it is non-negative.
For example, an expression of type <span style="font-family:monospace">@LTLengthOf("a") int</span> might be
used as an index to <span style="font-family:monospace">a</span>.
The type <span style="font-family:monospace">@LTLengthOf({"a", "b"})</span> is a subtype of both
<span style="font-family:monospace">@LTLengthOf("a")</span> and <span style="font-family:monospace">@LTLengthOf("b")</span>.
(&#X201C;<span style="font-family:monospace">LT</span>&#X201D; stands for &#X201C;Less Than&#X201D;.)<p><span style="font-family:monospace">@LTLengthOf</span> takes an optional <span style="font-family:monospace">offset</span> element, meaning that the
annotated expression plus the offset is less than the length of the given
sequence. For example, suppose expression <span style="font-family:monospace">e</span> has type <span style="font-family:monospace">@LTLengthOf(value
= {"a", "b"}, offset = {"-1", "x"})</span>. Then <span style="font-family:monospace">e - 1</span> is less than
<span style="font-family:monospace">a.length</span>, and <span style="font-family:monospace">e + x</span> is less than <span style="font-family:monospace">b.length</span>. This helps to make
the checker more precise. Programmers rarely need to write the <span style="font-family:monospace">offset</span>
element.</p></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/LTEqLengthOf.html"><span style="font-weight:bold"><span style="font-family:monospace">@LTEqLengthOf</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] names)</span></span></dt><dd class="dd-description">
An expression with this type
has value less than or equal to the length of each sequence listed in <span style="font-family:monospace">names</span>.
It may not be used as an index for these sequences, because it might be too high.
<span style="font-family:monospace">@LTEqLengthOf({"a", "b"})</span> is a subtype of both
<span style="font-family:monospace">@LTEqLengthOf("a")</span> and <span style="font-family:monospace">@LTEqLengthOf("b")</span>.
(&#X201C;<span style="font-family:monospace">LTEq</span>&#X201D; stands for &#X201C;Less Than or Equal to&#X201D;.)</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/PolyUpperBound.html"><span style="font-weight:bold"><span style="font-family:monospace">@PolyUpperBound</span></span></a></dt><dd class="dd-description">
indicates qualifier polymorphism.
For a description of qualifier polymorphism, see
Section&#XA0;<a href="#qualifier-polymorphism">25.2</a>.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/LTOMLengthOf.html"><span style="font-weight:bold"><span style="font-family:monospace">@LTOMLengthOf</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] names)</span></span></dt><dd class="dd-description">
An expression with this type
has value at least 2 less than the length of each sequence listed in <span style="font-family:monospace">names</span>.
It may always used as an index for a sequence listed in <span style="font-family:monospace">names</span>, if it is
non-negative.<p>This type exists to allow the checker to infer the safety of loops of
the form:
</p><pre class="verbatim">  for (int i = 0; i &lt; array.length - 1; ++i) {
    arr[i] = arr[i+1];
  }
</pre><p>This annotation should rarely (if ever) be written by the programmer; usually
<a href="../api/org/checkerframework/checker/index/qual/LTLengthOf.html"><span style="font-family:monospace">@LTLengthOf</span></a><span style="font-family:monospace">(String[] names)</span>
should be written instead.
<span style="font-family:monospace">@LTOMLengthOf({"a", "b"})</span> is a subtype of both
<span style="font-family:monospace">@LTOMLengthOf("a")</span> and <span style="font-family:monospace">@LTOMLengthOf("b")</span>.
(&#X201C;<span style="font-family:monospace">LTOM</span>&#X201D; stands for &#X201C;Less Than One Minus&#X201D;, because another way of
saying &#X201C;at least 2 less than <span style="font-family:monospace">a.length</span>&#X201D; is &#X201C;less than <span style="font-family:monospace">a.length-1</span>&#X201D;.)</p></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/UpperBoundUnknown.html"><span style="font-weight:bold"><span style="font-family:monospace">@UpperBoundUnknown</span></span></a></dt><dd class="dd-description">
There is no information about the upper bound on the value of an expression with this type.
It may not be used as an index for a sequence, because it might be too high.
This type is the top type, and should never need to be written by the
programmer.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/UpperBoundBottom.html"><span style="font-weight:bold"><span style="font-family:monospace">@UpperBoundBottom</span></span></a></dt><dd class="dd-description">
This is the bottom type for the upper bound type system. It should
never need to be written by the programmer.</dd></dl><p>The following method annotations can be used to establish a method postcondition
that ensures that a certain expression is a valid index for a sequence:</p><dl class="description"><dt class="dt-description">
<a href="../api/org/checkerframework/checker/index/qual/EnsuresLTLengthOf.html"><span style="font-weight:bold"><span style="font-family:monospace">@EnsuresLTLengthOf</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] value, String[] targetValue, String[] offset)</span></span></dt><dd class="dd-description">
When the method with this annotation returns, the expression (or all the expressions) given in the <span style="font-family:monospace">value</span> element
is less than the length of the given sequences with the given offsets. More precisely, the expression
has the <span style="font-family:monospace">@LTLengthOf</span> qualifier with the <span style="font-family:monospace">value</span> and <span style="font-family:monospace">offset</span> arguments
taken from the <span style="font-family:monospace">targetValue</span> and <span style="font-family:monospace">offset</span> elements of this annotation.
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/EnsuresLTLengthOfIf.html"><span style="font-weight:bold"><span style="font-family:monospace">@EnsuresLTLengthOfIf</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] expression, boolean result, String[] targetValue, String[] offset)</span></span></dt><dd class="dd-description">
If the method with this annotation returns the given boolean value,
then the given expression (or all the given expressions)
is less than the length of the given sequences with the given offsets.
</dd></dl><p>There is one declaration annotation that indicates the relationship between
two sequences:</p><dl class="description"><dt class="dt-description">
<a href="../api/org/checkerframework/checker/index/qual/HasSubsequence.html"><span style="font-weight:bold"><span style="font-family:monospace">@HasSubsequence</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[]
value, String[] from, String[] to)</span></span></dt><dd class="dd-description">
indicates that a subsequence (from <span style="font-family:monospace">from</span> to <span style="font-family:monospace">to</span>) of the
annotated sequence is equal to some other sequence, named by
<span style="font-family:monospace">value</span>).<p>For example, to indicate that <span style="font-family:monospace">shorter</span> is a subsequence of <span style="font-family:monospace">longer</span>:</p><pre class="verbatim">  int startIndex;
  int endIndex;
  int[] shorter;
  @HasSubsequence(value="shorter", from="this.start", to="this.end")
  int[] longer;
</pre><p>Thus, a valid index into <span style="font-family:monospace">shorter</span> is also a valid index (between
<span style="font-family:monospace">start</span> and <span style="font-family:monospace">end-1</span> inclusive) into <span style="font-family:monospace">longer</span>. More generally,
if <span style="font-family:monospace">x</span> is <span style="font-family:monospace">@IndexFor("shorter")</span> in the example above, then
<span style="font-family:monospace">start + x</span> is <span style="font-family:monospace">@IndexFor("longer")</span>. If <span style="font-family:monospace">y</span> is
<span style="font-family:monospace">@IndexFor("longer")</span> and <span style="font-family:monospace">@LessThan("end")</span>, then <span style="font-family:monospace">y -
start</span> is <span style="font-family:monospace">@IndexFor("shorter")</span>. Finally, <span style="font-family:monospace">end - start</span> is
<span style="font-family:monospace">@IndexOrHigh("shorter")</span>.</p><p>This annotation is in part checked and in part trusted. When an array is
assigned to <span style="font-family:monospace">longer</span>, three facts are checked: that <span style="font-family:monospace">start</span> is
non-negative, that <span style="font-family:monospace">start</span> is less than or equal to <span style="font-family:monospace">end</span>, and
that <span style="font-family:monospace">end</span> is less than or equal to the length of <span style="font-family:monospace">longer</span>. This
ensures that the indices are valid. The programmer must manually verify
that the value of <span style="font-family:monospace">shorter</span> equals the subsequence that they describe.
</p></dd></dl>
<!--TOC section id="index-minlen" Sequence minimum lengths-->
<h2 id="index-minlen" class="section">8.4&#XA0;&#XA0;Sequence minimum lengths <a href="#index-minlen" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The Index Checker estimates, for each sequence expression, how long its value
might be at run time by computing a minimum length that
the sequence is guaranteed to have. This enables the Index Checker to
verify indices that are compile-time constants. For example, this code:</p><pre class="verbatim">  String getThirdElement(String[] arr) {
    return arr[2];
  }
</pre><p>is legal if <span style="font-family:monospace">arr</span> has at least three elements, which can be indicated
in this way:</p><pre class="verbatim">  String getThirdElement(String @MinLen(3) [] arr) {
    return arr[2];
  }
</pre><p>When the index is not a compile-time constant, as in <span style="font-family:monospace">arr[i]</span>, then the
Index Checker depends not on a <span style="font-family:monospace">@MinLen</span> annotation but on <span style="font-family:monospace">i</span> being
annotated as
<a href="../api/org/checkerframework/checker/index/qual/LTLengthOf.html"><span style="font-family:monospace">@LTLengthOf</span></a><span style="font-family:monospace">("arr")</span>.</p><p>The MinLen type qualifier is implemented in practice by the Constant Value Checker,
using <span style="font-family:monospace">@ArrayLenRange</span> annotations (see Chapter&#XA0;<a href="#constant-value-checker">21</a>).
This means that errors related to the minimum lengths of arrays must be suppressed using
the "value" argument to <span style="font-family:monospace">@SuppressWarnings</span>.
<a href="../api/org/checkerframework/common/value/qual/ArrayLenRange.html"><span style="font-family:monospace">@ArrayLenRange</span></a> and <a href="../api/org/checkerframework/common/value/qual/ArrayLen.html"><span style="font-family:monospace">@ArrayLen</span></a>
annotations can also be used to establish the minimum length of a sequence, if a
more precise estimate of length is known. For example,
if <span style="font-family:monospace">arr</span> is known to have exactly three elements:</p><pre class="verbatim">  String getThirdElement(String @ArrayLen(3) [] arr) {
    return arr[2];
  }
</pre><p>The following type qualifiers (from the Chapter&#XA0;<a href="#constant-value-checker">21</a>)
can establish the minimum length of a sequence:</p><dl class="description"><dt class="dt-description">
<a href="../api/org/checkerframework/common/value/qual/MinLen.html"><span style="font-weight:bold"><span style="font-family:monospace">@MinLen</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(int value)</span></span></dt><dd class="dd-description">
The value of an expression of this type is a sequence with at least
<span style="font-family:monospace">value</span> elements. The default annotation is
<span style="font-family:monospace">@MinLen(0)</span>, and it may be applied to non-sequences.
<span style="font-family:monospace">@MinLen(</span><span style="font-style:italic">x</span><span style="font-family:monospace">)</span> is a subtype of <span style="font-family:monospace">@MinLen(</span><span style="font-style:italic">x</span>&#X2212;1<span style="font-family:monospace">)</span>.
An <span style="font-family:monospace">@MinLen</span> annotation is treated internally as an
<a href="../api/org/checkerframework/common/value/qual/ArrayLenRange.html"><span style="font-family:monospace">@ArrayLenRange</span></a> with only its
<span style="font-family:monospace">from</span> field filled.
</dd><dt class="dt-description"><a href="../api/org/checkerframework/common/value/qual/ArrayLen.html"><span style="font-weight:bold"><span style="font-family:monospace">@ArrayLen</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(int[] value)</span></span></dt><dd class="dd-description">
The value of an expression of this type is a sequence whose
length is exactly one of the integers listed in its argument.
The argument can contain at most ten integers; larger collections of
integers are converted to <a href="../api/org/checkerframework/common/value/qual/ArrayLenRange.html"><span style="font-family:monospace">@ArrayLenRange</span></a>
annotations. The minimum length of a sequence with this annotation
is the smallest element of the argument.
</dd><dt class="dt-description"><a href="../api/org/checkerframework/common/value/qual/ArrayLenRange.html"><span style="font-weight:bold"><span style="font-family:monospace">@ArrayLenRange</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(int from, int to)</span></span></dt><dd class="dd-description">
The value of an expression of this type is a sequence whose
length is bounded by its arguments, inclusive.
The minimum length of a sequence with this annotation is its <span style="font-family:monospace">from</span> argument.
</dd></dl><blockquote class="figure"><div class="center"><hr style="width:80%;height:2"></div>
<div class="center">
<div class="center">
<img src="samelen.svg">
</div>
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 8.2: The type hierarchy for arrays of equal length ("a" and "b" are
assumed to be in-scope sequences). Qualifiers
written in gray should never be written in source code; they are used
internally by the type system.</td></tr>
</table></div>
<a id="fig-index-array-types"></a>
<div class="center"><hr style="width:80%;height:2"></div></blockquote><p>The following method annotation can be used to establish a method postcondition
that ensures that a certain sequence has a minimum length:</p><dl class="description"><dt class="dt-description">
<a href="../api/org/checkerframework/common/value/qual/EnsuresMinLenIf.html"><span style="font-weight:bold"><span style="font-family:monospace">@EnsuresMinLenIf</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] expression, boolean result, int targetValue)</span></span></dt><dd class="dd-description">
If the method with this annotation returns the given boolean value,
then the given expression (or all the given expressions) is a sequence
with at least <span style="font-family:monospace">targetValue</span> elements.
</dd></dl>
<!--TOC section id="index-samelen" Sequences of the same length-->
<h2 id="index-samelen" class="section">8.5&#XA0;&#XA0;Sequences of the same length <a href="#index-samelen" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The Index Checker determines whether two or more sequences have the same length.
This enables it to verify that all the indexing operations are safe in code
like the following:</p><pre class="verbatim">  boolean lessThan(double[] arr1, double @SameLen("#1") [] arr2) {
    for (int i = 0; i &lt; arr1.length; i++) {
      if (arr1[i] &lt; arr2[i]) {
        return true;
      } else if (arr1[i] &gt; arr2[i]) {
        return false;
      }
    }
    return false;
  }
</pre><p>When needed, you can specify which sequences have the same length using the following type qualifiers (Figure&#XA0;<a href="#fig-index-array-types">8.2</a>):</p><dl class="description"><dt class="dt-description">
<a href="../api/org/checkerframework/checker/index/qual/SameLen.html"><span style="font-weight:bold"><span style="font-family:monospace">@SameLen</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] names)</span></span></dt><dd class="dd-description">
An expression with this type represents a sequence that has the
same length as the other sequences named in <span style="font-family:monospace">names</span>. In general,
<span style="font-family:monospace">@SameLen</span> types that have non-intersecting sets of names
are <span style="font-style:italic">not</span> subtypes of each other. However, if at least one
sequence is named by both types, the types are actually the same,
because all the named sequences must have the same length.
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/PolySameLen.html"><span style="font-weight:bold"><span style="font-family:monospace">@PolySameLen</span></span></a></dt><dd class="dd-description">
indicates qualifier polymorphism.
For a description of qualifier polymorphism, see
Section&#XA0;<a href="#qualifier-polymorphism">25.2</a>.
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/SameLenUnknown.html"><span style="font-weight:bold"><span style="font-family:monospace">@SameLenUnknown</span></span></a></dt><dd class="dd-description">
No information is known about which other sequences have the same length
as this one.
This is the top type, and programmers should never need to write it.
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/SameLenBottom.html"><span style="font-weight:bold"><span style="font-family:monospace">@SameLenBottom</span></span></a></dt><dd class="dd-description">
This is the bottom type, and programmers should rarely need to write it.
<span style="font-family:monospace">null</span> has this type.
</dd></dl>
<!--TOC section id="index-searchindex" Binary search indices-->
<h2 id="index-searchindex" class="section">8.6&#XA0;&#XA0;Binary search indices <a href="#index-searchindex" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The JDK&#X2019;s
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Arrays.html#binarySearch-java.lang.Object:A-java.lang.Object-"><span style="font-family:monospace">Arrays.binarySearch</span></a>
method returns either where the value was found, or a negative value
indicating where the value could be inserted. The Search Index Checker
represents this concept.</p><blockquote class="figure"><div class="center"><hr style="width:80%;height:2"></div>
<div class="center">
<div class="center">
<img src="searchindex.svg">
</div>
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 8.3: The type hierarchy for the Index Checker&#X2019;s internal type system
that captures information about the results of calls to
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Arrays.html#binarySearch-java.lang.Object:A-java.lang.Object-"><span style="font-family:monospace">Arrays.binarySearch</span></a>.</td></tr>
</table></div>
<a id="fig-index-searchindex"></a>
<div class="center"><hr style="width:80%;height:2"></div></blockquote><p>The Search Index Checker&#X2019;s type hierarchy (Figure&#XA0;<a href="#fig-index-searchindex">8.3</a>) has four type qualifiers:
</p><dl class="description"><dt class="dt-description">
<a href="../api/org/checkerframework/checker/index/qual/SearchIndexFor.html"><span style="font-weight:bold"><span style="font-family:monospace">@SearchIndexFor</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] names)</span></span></dt><dd class="dd-description">
An expression with this type represents an integer that could have been
produced by calling
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Arrays.html#binarySearch-java.lang.Object:A-java.lang.Object-"><span style="font-family:monospace">Arrays.binarySearch</span></a>:
for each array <span style="font-family:monospace">a</span> specified in the annotation, the annotated integer is
between <span style="font-family:monospace">-a.length-1</span> and <span style="font-family:monospace">a.length-1</span>, inclusive
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/NegativeIndexFor.html"><span style="font-weight:bold"><span style="font-family:monospace">@NegativeIndexFor</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] names)</span></span></dt><dd class="dd-description">
An expression with this type represents a &#X201C;negative index&#X201D; that is
between <span style="font-family:monospace">a.length-1</span> and <span style="font-family:monospace">-1</span>, inclusive; that is, a value that is both
a <span style="font-family:monospace">@SearchIndex</span> and is negative. Applying the bitwise complement
operator (<code>~</code>) to an expression of this type produces an expression
of type <a href="../api/org/checkerframework/checker/index/qual/IndexOrHigh.html"><span style="font-family:monospace">@IndexOrHigh</span></a>.
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/SearchIndexBottom.html"><span style="font-weight:bold"><span style="font-family:monospace">@SearchIndexBottom</span></span></a></dt><dd class="dd-description">
This is the bottom type, and programmers should rarely need to write it.
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/SearchIndexUnknown.html"><span style="font-weight:bold"><span style="font-family:monospace">@SearchIndexUnknown</span></span></a></dt><dd class="dd-description">
No information is known about whether this integer is a search index.
This is the top type, and programmers should rarely need to write it.
</dd></dl>
<!--TOC section id="index-substringindex" Substring indices-->
<h2 id="index-substringindex" class="section">8.7&#XA0;&#XA0;Substring indices <a href="#index-substringindex" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The methods
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html#indexOf-java.lang.String-"><span style="font-family:monospace">String.indexOf</span></a>
and
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html#lastIndexOf-java.lang.String-"><span style="font-family:monospace">String.lastIndexOf</span></a>
return an index of a given substring within a given string, or -1 if no
such substring exists. The index <span style="font-family:monospace">i</span> returned from
<span style="font-family:monospace">receiver.indexOf(substring)</span> satisfies the following property, which is
stated here in three equivalent ways:
</p><pre class="verbatim"> i == -1 || ( i &gt;= 0       &amp;&amp; i &lt;= receiver.length() - substring.length()                  )
 i == -1 || ( @NonNegative &amp;&amp; @LTLengthOf(value="receiver", offset="substring.length()-1") )
 @SubstringIndexFor(value="receiver", offset="substring.length()-1")
</pre><p>The return type of methods <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html#indexOf-java.lang.String-"><span style="font-family:monospace">String.indexOf</span></a>
and <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html#lastIndexOf-java.lang.String-"><span style="font-family:monospace">String.lastIndexOf</span></a> has the annotation
<a href="../api/org/checkerframework/checker/index/qual/SubstringIndexFor.html"><span style="font-family:monospace">@SubstringIndexFor</span></a><span style="font-family:monospace">(value="this", offset="#1.length()-1"))</span>.
This allows writing code such as the following with no warnings from the
Index Checker:</p><pre class="verbatim">  public static String removeSubstring(String original, String removed) {
    int i = original.indexOf(removed);
    if (i != -1) {
      return original.substring(0, i) + original.substring(i + removed.length());
    }
    return original;
  }
</pre><blockquote class="figure"><div class="center"><hr style="width:80%;height:2"></div>
<div class="center">
<div class="center">
<img src="substringindex.svg">
</div>
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 8.4: The type hierarchy for the Substring Index Checker, which
captures information about the results of calls to
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html#indexOf-java.lang.String-"><span style="font-family:monospace">String.indexOf</span></a>
and
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html#lastIndexOf-java.lang.String-"><span style="font-family:monospace">String.lastIndexOf</span></a>.</td></tr>
</table></div>
<a id="fig-index-substringindex"></a>
<div class="center"><hr style="width:80%;height:2"></div></blockquote><p>The <span style="font-family:monospace">@SubstringIndexFor</span> annotation is implemented in a Substring Index
Checker that runs together with the Index Checker and has its own type
hierarchy (Figure&#XA0;<a href="#fig-index-substringindex">8.4</a>) with three type
qualifiers:
</p><dl class="description"><dt class="dt-description">
<a href="../api/org/checkerframework/checker/index/qual/SubstringIndexFor.html"><span style="font-weight:bold"><span style="font-family:monospace">@SubstringIndexFor</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] value, String[] offset)</span></span></dt><dd class="dd-description">
An expression with this type represents an integer that could have been
produced by calling
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html#indexOf-java.lang.String-"><span style="font-family:monospace">String.indexOf</span></a>:
the annotated integer is either -1, or it is non-negative and is less
than or equal to <span style="font-family:monospace">receiver.length - offset</span> (where the sequence
<span style="font-family:monospace">receiver</span> and the offset <span style="font-family:monospace">offset</span> are corresponding elements of the
annotation&#X2019;s arguments).
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/SubstringIndexBottom.html"><span style="font-weight:bold"><span style="font-family:monospace">@SubstringIndexBottom</span></span></a></dt><dd class="dd-description">
This is the bottom type, and programmers should rarely need to write it.
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/SubstringIndexUnknown.html"><span style="font-weight:bold"><span style="font-family:monospace">@SubstringIndexUnknown</span></span></a></dt><dd class="dd-description">
No information is known about whether this integer is a substring index.
This is the top type, and programmers should rarely need to write it.
</dd></dl>
<!--TOC subsection id="index-substringindex-justification" The need for the <span style="font-family:monospace">@SubstringIndexFor</span> annotation-->
<h3 id="index-substringindex-justification" class="subsection">8.7.1&#XA0;&#XA0;The need for the <span style="font-family:monospace">@SubstringIndexFor</span> annotation <a href="#index-substringindex-justification" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>No other annotation supported by the Index Checker precisely represents the
possible return values of methods
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html#indexOf-java.lang.String-"><span style="font-family:monospace">String.indexOf</span></a>
and
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html#lastIndexOf-java.lang.String-"><span style="font-family:monospace">String.lastIndexOf</span></a>.
The reason is the methods&#X2019; special cases for empty strings and for failed matches.</p><p>Consider the result <span style="font-family:monospace">i</span> of <span style="font-family:monospace">receiver.indexOf(substring)</span>:</p><ul class="itemize"><li class="li-itemize">
<span style="font-family:monospace">i</span> is <span style="font-family:monospace">@GTENegativeOne</span>, because <span style="font-family:monospace">i &gt;= -1</span>.
</li><li class="li-itemize"><span style="font-family:monospace">i</span> is <span style="font-family:monospace">@LTEqLengthOf("receiver")</span>, because <span style="font-family:monospace">i &lt;= receiver.length()</span>.
</li><li class="li-itemize"><span style="font-family:monospace">i</span> is not <span style="font-family:monospace">@IndexOrLow("receiver")</span>, because for
<span style="font-family:monospace">receiver = "", substring = "", i = 0</span>, the property
<span style="font-family:monospace">i &gt;= -1 &amp;&amp; i &lt; receiver.length()</span> does not hold.
</li><li class="li-itemize"><span style="font-family:monospace">i</span> is not <span style="font-family:monospace">@IndexOrHigh("receiver")</span>, because for
<span style="font-family:monospace">receiver = "", substring = "b", i = -1</span>, the property
<span style="font-family:monospace">i &gt;= 0 &amp;&amp; i &lt;= receiver.length()</span> does not hold.
</li><li class="li-itemize"><span style="font-family:monospace">i</span> is not
<span style="font-family:monospace">@LTLengthOf(value = "receiver", offset = "substring.length()-1")</span>,
because for <span style="font-family:monospace">receiver = "", substring = "abc", i = -1</span>, the property
<span style="font-family:monospace">i + substring.length() - 1 &lt; receiver.length()</span> does not hold.
</li></ul><p>The last annotation in the list above,
<span style="font-family:monospace">@LTLengthOf(value = "receiver", offset = "substring.length()-1")</span>,
is the correct and precise upper bound for all values of <span style="font-family:monospace">i</span> except -1.
The offset expresses the fact that we can add <span style="font-family:monospace">substring.length()</span> to this
index and still get a valid index for <span style="font-family:monospace">receiver</span>. That is useful for
type-checking code that adds the length of the substring to the found
index, in order to obtain the rest of the string. However, the upper bound
applies only after the index is explicitly checked not to be -1:</p><pre class="verbatim">  int i = receiver.indexOf(substring);
  // i is @GTENegativeOne and @LTEqLengthOf("receiver")
  // i is not @LTLengthOf(value = "receiver", offset = "substring.length()-1")
  if (i != -1) {
    // i is @NonNegative and @LTLengthOf(value = "receiver", offset = "substring.length()-1")
    int j = i + substring.length();
    // j is @IndexOrHigh("receiver")
    return receiver.substring(j); // this call is safe
  }
</pre><p>The property of the result of <span style="font-family:monospace">indexOf</span> cannot be expressed by any
combination of lower-bound (Section&#XA0;<a href="#index-lowerbound">8.2</a>) and upper-bound
(Section&#XA0;<a href="#index-upperbound">8.3</a>) annotations, because the upper-bound
annotations apply independently of the lower-bound annotations, but in this
case, the upper bound <span style="font-family:monospace">i &lt;= receiver.length() - substring.length()</span>
holds only if <span style="font-family:monospace">i &gt;= 0</span>. Therefore, to express this property and make
the example type-check without false positives, a new annotation such as
<span style="font-family:monospace">@SubstringIndexFor(value = "receiver", offset = "substring.length()-1")</span>
is necessary.</p>
<!--TOC section id="index-inequalities" Inequalities-->
<h2 id="index-inequalities" class="section">8.8&#XA0;&#XA0;Inequalities <a href="#index-inequalities" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The Index Checker estimates which expression&#X2019;s values are less than other expressions&#X2019; values.</p><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/LessThan.html"><span style="font-weight:bold"><span style="font-family:monospace">@LessThan</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] values)</span></span></dt><dd class="dd-description">
An expression with this type has a value that is less than the value of each
expression listed in <span style="font-family:monospace">values</span>. The expressions in values must be composed of
final or effectively final variables and constants.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/LessThanUnknown.html"><span style="font-weight:bold"><span style="font-family:monospace">@LessThanUnknown</span></span></a></dt><dd class="dd-description">
There is no information about the value of an expression this type relative to other expressions.
This is the top type, and should not be written by the programmer.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/index/qual/LessThanBottom.html"><span style="font-weight:bold"><span style="font-family:monospace">@LessThanBottom</span></span></a></dt><dd class="dd-description">
This is the bottom type for the less than type system. It should
never need to be written by the programmer.</dd></dl>
<!--TOC section id="index-annotating-fixed-size" Annotating fixed-size data structures-->
<h2 id="index-annotating-fixed-size" class="section">8.9&#XA0;&#XA0;Annotating fixed-size data structures <a href="#index-annotating-fixed-size" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The Index Checker has built-in support for Strings and arrays.
You can add support for additional fixed-size data structures by writing
annotations.
This allows the Index Checker to typecheck the data structure&#X2019;s
implementation and to typecheck uses of the class.</p><p>This section gives an example: a fixed-length collection.</p><pre class="verbatim">/** ArrayWrapper is a fixed-size generic collection. */
public class ArrayWrapper&lt;T&gt; {
    private final Object @SameLen("this") [] delegate;

    @SuppressWarnings("index") // constructor creates object of size @SameLen(this) by definition
    ArrayWrapper(@NonNegative int size) {
        delegate = new Object[size];
    }

    public @LengthOf("this") int size() {
        return delegate.length;
    }

    public void set(@IndexFor("this") int index, T obj) {
        delegate[index] = obj;
    }

    @SuppressWarnings("unchecked") // required for normal Java compilation due to unchecked cast
    public T get(@IndexFor("this") int index) {
        return (T) delegate[index];
    }
}
</pre><p>The Index Checker treats methods annotated with <span style="font-family:monospace">@LengthOf("this")</span> as
the length of a sequence like <span style="font-family:monospace">arr.length</span> for arrays and
<span style="font-family:monospace">str.length()</span> for strings.</p><p>With these annotations, client code like the following typechecks with no
warnings:
</p><pre class="verbatim">    public static void clearIndex1(ArrayWrapper&lt;? extends Object&gt; a, @IndexFor("#1") int i) {
        a.set(i, null);
    }

    public static void clearIndex2(ArrayWrapper&lt;? extends Object&gt; a, int i) {
        if (0 &lt;= i &amp;&amp; i &lt; a.size()) {
            a.set(i, null);
        }
    }
</pre><hr>
<!--TOC chapter id="fenum-checker" Fake Enum Checker for fake enumerations-->
<h1 id="fenum-checker" class="chapter">Chapter&#XA0;9&#XA0;&#XA0;Fake Enum Checker for fake enumerations <a href="#fenum-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h1><!--SEC END --><p>The Fake Enum Checker, or Fenum Checker, enables you to define a type alias
or typedef, in which two different sets of values have the same
representation (the same Java type) but are not allowed to be used
interchangeably. It is also possible to create a typedef using the
Subtyping Checker (Chapter&#XA0;<a href="#subtyping-checker">23</a>), and that approach
is sometimes more appropriate.</p><p>One common use for the Fake Enum Checker is the
<em>fake enumeration pattern</em> (Section&#XA0;<a href="#fenum-pattern">9.6</a>). For
example, consider this code adapted from Android&#X2019;s
<a href="https://developer.android.com/reference/android/support/annotation/IntDef"><span style="font-family:monospace">IntDef</span></a>
documentation:</p><pre class="verbatim">@NavigationMode int NAVIGATION_MODE_STANDARD = 0;
@NavigationMode int NAVIGATION_MODE_LIST = 1;
@NavigationMode int NAVIGATION_MODE_TABS = 2;

@NavigationMode int getNavigationMode();

void setNavigationMode(@NavigationMode int mode);
</pre><p>The Fake Enum Checker can issue a compile-time warning if the programmer
ever tries to call <span style="font-family:monospace">setNavigationMode</span> with an <span style="font-family:monospace">int</span> that is not a
<span style="font-family:monospace">@NavigationMode int</span>.</p><p>The Fake Enum Checker gives the same safety guarantees as a true enumeration
type or typedef, but retaining backward-compatibility with interfaces that
use existing Java types. You can apply fenum annotations to any Java type,
including all primitive types and also reference types. Thus, you could
use it (for example) to represent floating-point values between 0 and 1, or
<span style="font-family:monospace">String</span>s with some particular characteristic.
(Note that the Fake Enum Checker does not let you create a shorter alias
for a long type name, as a real typedef would if Java supported it.)</p><p>As explained in Section&#XA0;<a href="#fenum-annotations">9.1</a>, you can either define your
own fenum annotations, such as <span style="font-family:monospace">@NavigationMode</span> above, or you can use the
<a href="../api/org/checkerframework/checker/fenum/qual/Fenum.html"><span style="font-family:monospace">@Fenum</span></a> type qualifier with a string argument.
Figure&#XA0;<a href="#fig-fenum-hierarchy">9.1</a> shows part of the type hierarchy for the
Fenum type system.</p><blockquote class="figure"><div class="center"><hr style="width:80%;height:2"></div>
<div class="center">
<img src="fenum.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 9.1: Partial type hierarchy for the Fenum type system.
There are two forms of fake enumeration annotations &#X2014; above, illustrated
by <span style="font-family:monospace">@Fenum("A")</span> and <span style="font-family:monospace">@FenumC</span>.
See Section&#XA0;<a href="#fenum-annotations">9.1</a> for descriptions of how to
introduce both types of fenums. The type qualifiers in gray
(<span style="font-family:monospace">@FenumTop</span>, <span style="font-family:monospace">@FenumUnqualified</span>, and <span style="font-family:monospace">@FenumBottom</span>)
should never be written in
source code; they are used internally by the type system.
<span style="font-family:monospace">@FenumUnqualified</span> is the default qualifier for unannotated types, except
for upper bounds which default to <span style="font-family:monospace">@FenumTop</span>.
</td></tr>
</table></div>
<a id="fig-fenum-hierarchy"></a>
<div class="center"><hr style="width:80%;height:2"></div></blockquote>
<!--TOC section id="fenum-annotations" Fake enum annotations-->
<h2 id="fenum-annotations" class="section">9.1&#XA0;&#XA0;Fake enum annotations <a href="#fenum-annotations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The Fake Enum Checker supports two ways to introduce a new fake enum (fenum):</p><ol class="enumerate" type=1><li class="li-enumerate">
Introduce your own specialized fenum annotation with code like this in
file <span style="font-family:monospace"><em>MyFenum</em></span><span style="font-family:monospace">.java</span>:<pre>
package <span style="font-style:italic">myPackage</span>.qual;

import java.lang.annotation.Documented;
import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;
import org.checkerframework.checker.fenum.qual.FenumTop;
import org.checkerframework.framework.qual.SubtypeOf;

@Documented
@Retention(RetentionPolicy.RUNTIME)
@Target(<span style="font-family:monospace">{</span>ElementType.TYPE_USE, ElementType.TYPE_PARAMETER<span style="font-family:monospace">}</span>)
@SubtypeOf(FenumTop.class)
public @interface <span style="font-style:italic">MyFenum</span> <span style="font-family:monospace">{</span><span style="font-family:monospace">}</span>
</pre><p>You only need to adapt the italicized package, annotation, and file names in the example.</p><p>Note that all custom annotations must have the
<span style="font-family:monospace">@Target(</span><span style="font-family:monospace">{</span><span style="font-family:monospace">ElementType.TYPE_USE</span><span style="font-family:monospace">}</span><span style="font-family:monospace">)</span> meta-annotation. See section
<a href="#creating-define-type-qualifiers">31.4.1</a>.</p></li><li class="li-enumerate">Use the provided <a href="../api/org/checkerframework/checker/fenum/qual/Fenum.html"><span style="font-family:monospace">@Fenum</span></a> annotation, which takes a
<span style="font-family:monospace">String</span> argument to distinguish different fenums or type aliases.
For example, <span style="font-family:monospace">@Fenum("A")</span> and <span style="font-family:monospace">@Fenum("B")</span> are two distinct
type qualifiers.
</li></ol><p>The first approach allows you to define a short, meaningful name suitable for
your project, whereas the second approach allows quick prototyping.</p>
<!--TOC section id="fenum-checks" What the Fenum Checker checks-->
<h2 id="fenum-checks" class="section">9.2&#XA0;&#XA0;What the Fenum Checker checks <a href="#fenum-checks" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The Fenum Checker ensures that unrelated types are not mixed.
All types with a particular fenum annotation, or <span style="font-family:monospace">@Fenum(...)</span> with a
particular <span style="font-family:monospace">String</span> argument, are
disjoint from all unannotated types and from all types with a different fenum
annotation or <span style="font-family:monospace">String</span> argument.</p><p>The checker ensures that
only compatible fenum types are used in comparisons and arithmetic operations
(if applicable to the annotated type).</p><p>It is the programmer&#X2019;s responsibility to ensure that fields with a fenum type
are properly initialized before use. Otherwise, one might observe a <span style="font-family:monospace">null</span>
reference or zero value in the field of a fenum type. (The Nullness Checker
(Chapter&#XA0;<a href="#nullness-checker">3</a>) can prevent failure to initialize a
reference variable.)</p>
<!--TOC section id="fenum-running" Running the Fenum Checker-->
<h2 id="fenum-running" class="section">9.3&#XA0;&#XA0;Running the Fenum Checker <a href="#fenum-running" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The Fenum Checker can be invoked by running the following commands.</p><ul class="itemize"><li class="li-itemize">
If you define your own annotation(s), provide the name(s) of the annotation(s)
through the <span style="font-family:monospace">-Aquals</span> option, using a comma-no-space-separated notation:<pre>
  javac -classpath <span style="font-style:italic">/full/path/to/myProject/bin</span>:<span style="font-style:italic">/full/path/to/myLibrary/bin</span> <span style="font-family:monospace">\</span>
        -processor org.checkerframework.checker.fenum.FenumChecker <span style="font-family:monospace">\</span>
        -Aquals=<span style="font-style:italic">myPackage.qual.MyFenum</span> MyFile.java ...
</pre><p>The annotations listed in <span style="font-family:monospace">-Aquals</span> must be accessible to
the compiler during compilation in the classpath. In other words, they must
already be compiled (and, typically, be on the javac classpath)
before you run the Fenum Checker with <span style="font-family:monospace">javac</span>. It
is not sufficient to supply their source files on the command line.</p><p>You can also provide the fully-qualified paths to a set of directories
that contain the annotations through the <span style="font-family:monospace">-AqualDirs</span> option,
using a colon-no-space-separated notation. For example:</p><pre>
  javac -classpath <span style="font-style:italic">/full/path/to/myProject/bin</span>:<span style="font-style:italic">/full/path/to/myLibrary/bin</span> <span style="font-family:monospace">\</span>
        -processor org.checkerframework.checker.fenum.FenumChecker <span style="font-family:monospace">\</span>
        -AqualDirs=<span style="font-style:italic">/full/path/to/myProject/bin</span>:<span style="font-style:italic">/full/path/to/myLibrary/bin</span> MyFile.java ...
</pre><p>Note that in these two examples, the compiled class file of the
<span style="font-family:monospace">myPackage.qual.MyFenum</span> annotation must exist in either the <span style="font-family:monospace">myProject/bin</span>
directory or the <span style="font-family:monospace">myLibrary/bin</span> directory. The following placement of
the class file will work with the above commands:</p><pre>
  .../myProject/bin/myPackage/qual/MyFenum.class
</pre><p>The two options can be used at the same time to provide groups of annotations
from directories, and individually named annotations.</p></li><li class="li-itemize">If your code uses the <a href="../api/org/checkerframework/checker/fenum/qual/Fenum.html"><span style="font-family:monospace">@Fenum</span></a> annotation, you do
not need the <span style="font-family:monospace">-Aquals</span> or <span style="font-family:monospace">-AqualDirs</span> option:<pre class="verbatim">  javac -processor org.checkerframework.checker.fenum.FenumChecker MyFile.java ...
</pre></li></ul><p>For an example of running the Fake Enum Checker on Android code, see
<a href="https://github.com/karlicoss/checker-fenum-android-demo"><span style="font-family:monospace">https://github.com/karlicoss/checker-fenum-android-demo</span></a>.</p>
<!--TOC section id="fenum-suppressing" Suppressing warnings-->
<h2 id="fenum-suppressing" class="section">9.4&#XA0;&#XA0;Suppressing warnings <a href="#fenum-suppressing" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>One example of when you need to suppress warnings is when you initialize the
fenum constants to literal values.
To remove this warning message, add a <span style="font-family:monospace">@SuppressWarnings</span> annotation to either
the field or class declaration, for example:</p><pre class="verbatim">@SuppressWarnings("fenum:assignment.type.incompatible") // initialization of fake enums
class MyConsts {
  public static final @Fenum("A") int ACONST1 = 1;
  public static final @Fenum("A") int ACONST2 = 2;
}
</pre>
<!--TOC section id="fenum-example" Example-->
<h2 id="fenum-example" class="section">9.5&#XA0;&#XA0;Example <a href="#fenum-example" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The following example introduces two fenums in class <span style="font-family:monospace">TestStatic</span>
and then performs a few typical operations.</p><pre class="verbatim">@SuppressWarnings("fenum:assignment.type.incompatible")   // initialization of fake enums
public class TestStatic {
  public static final @Fenum("A") int ACONST1 = 1;
  public static final @Fenum("A") int ACONST2 = 2;

  public static final @Fenum("B") int BCONST1 = 4;
  public static final @Fenum("B") int BCONST2 = 5;
}

class FenumUser {
  @Fenum("A") int state1 = TestStatic.ACONST1;     // ok
  @Fenum("B") int state2 = TestStatic.ACONST1;     // Incompatible fenums forbidden!

  void fenumArg(@Fenum("A") int p) {}

  void foo() {
    state1 = 4;                     // Direct use of value forbidden!
    state1 = TestStatic.BCONST1;    // Incompatible fenums forbidden!
    state1 = TestStatic.ACONST2;    // ok

    fenumArg(5);                    // Direct use of value forbidden!
    fenumArg(TestStatic.BCONST1);   // Incompatible fenums forbidden!
    fenumArg(TestStatic.ACONST1);   // ok
  }
 }
</pre><p>Also, see the example project in the <span style="font-family:monospace">docs/examples/fenum-extension</span> directory.</p>
<!--TOC section id="fenum-pattern" The fake enumeration pattern-->
<h2 id="fenum-pattern" class="section">9.6&#XA0;&#XA0;The fake enumeration pattern <a href="#fenum-pattern" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>Java&#X2019;s
<a href="https://docs.oracle.com/javase/specs/jls/se10/html/jls-8.html#jls-8.9"><span style="font-family:monospace">enum</span></a>
keyword lets you define an enumeration type: a finite set of distinct values
that are related to one another but are disjoint from all other
types, including other enumerations.
Before enums were added to Java, there were two ways to encode an
enumeration, both of which are error-prone:</p><dl class="description"><dt class="dt-description">
<span style="font-weight:bold">the fake enum pattern</span></dt><dd class="dd-description"> a set of <span style="font-family:monospace">int</span> or <span style="font-family:monospace">String</span>
constants (as often found in older C code).</dd><dt class="dt-description"><span style="font-weight:bold">the typesafe enum pattern</span></dt><dd class="dd-description"> a class with private constructor.
</dd></dl><p>Sometimes you need to use the fake enum pattern,
rather than a real enum or the typesafe enum pattern.
One reason is backward-compatibility. A public API that predates Java&#X2019;s
enum keyword may use <span style="font-family:monospace">int</span> constants; it cannot be changed, because
doing so would break existing clients. For example, Java&#X2019;s JDK still uses
<span style="font-family:monospace">int</span> constants in the AWT and Swing frameworks, and Android also uses
<span style="font-family:monospace">int</span> constants rather than Java enums.
Another reason is performance, especially in environments with limited
resources. Use of an int instead of an object can
reduce code size, memory requirements, and run time.
</p><p>In cases when code has to use the fake enum pattern, the Fake Enum Checker,
or Fenum Checker, gives the same safety guarantees as a true enumeration type.
The developer can introduce new types that are distinct from all values of the
base type and from all other fake enums. Fenums can be introduced for
primitive types as well as for reference types.</p>
<!--TOC section id="fenum-references" References-->
<h2 id="fenum-references" class="section">9.7&#XA0;&#XA0;References <a href="#fenum-references" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><ul class="itemize"><li class="li-itemize">
Case studies of the Fake Enum Checker:<br>
 &#X201C;Building and using pluggable type-checkers&#X201D;&#XA0;[<a href="#DietlDEMS2011">DDE+11</a>]
(ICSE 2011, <a href="https://homes.cs.washington.edu/~mernst/pubs/pluggable-checkers-icse2011.pdf#page=3"><span style="font-family:monospace">https://homes.cs.washington.edu/~mernst/pubs/pluggable-checkers-icse2011.pdf#page=3</span></a>)</li><li class="li-itemize">Java Language Specification on enums:<br>
 <a href="https://docs.oracle.com/javase/specs/jls/se10/html/jls-8.html#jls-8.9"><span style="font-family:monospace">https://docs.oracle.com/javase/specs/jls/se10/html/jls-8.html#jls-8.9</span></a></li><li class="li-itemize">Tutorial trail on enums:<br>
 <a href="https://docs.oracle.com/javase/tutorial/java/javaOO/enum.html"><span style="font-family:monospace">https://docs.oracle.com/javase/tutorial/java/javaOO/enum.html</span></a></li><li class="li-itemize">Java Tip 122: Beware of Java typesafe enumerations:<br>
 <a href="https://www.javaworld.com/article/2077487/java-tip-122--beware-of-java-typesafe-enumerations.html"><span style="font-family:monospace">https://www.javaworld.com/article/2077487/java-tip-122--beware-of-java-typesafe-enumerations.html</span></a></li></ul><hr>
<!--TOC chapter id="tainting-checker" Tainting Checker-->
<h1 id="tainting-checker" class="chapter">Chapter&#XA0;10&#XA0;&#XA0;Tainting Checker <a href="#tainting-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h1><!--SEC END --><p>The Tainting Checker prevents certain kinds of trust errors.
A <em>tainted</em>, or untrusted, value is one that comes from an arbitrary,
possibly malicious source, such as user input or unvalidated data.
In certain parts of your application, using a tainted value can compromise
the application&#X2019;s integrity, causing it to crash, corrupt data, leak
private data, etc.</p><p>For example, a user-supplied pointer, handle, or map key should be
validated before being dereferenced.
As another example, a user-supplied string should not be concatenated into a
SQL query, lest the program be subject to a
<a href="https://en.wikipedia.org/wiki/Sql_injection">SQL injection</a> attack.
A location in your program where malicious data could do damage is
called a <em>sensitive sink</em>.</p><p>A program must &#X201C;sanitize&#X201D; or &#X201C;untaint&#X201D; an untrusted value before using
it at a sensitive sink. There are two general ways to untaint a value:
by checking
that it is innocuous/legal (e.g., it contains no characters that can be
interpreted as SQL commands when pasted into a string context), or by
transforming the value to be legal (e.g., quoting all the characters that
can be interpreted as SQL commands). A correct program must use one of
these two techniques so that tainted values never flow to a sensitive sink.
The Tainting Checker ensures that your program does so.</p><p>If the Tainting Checker issues no warning for a given program, then no
tainted value ever flows to a sensitive sink. However, your program is not
necessarily free from all trust errors. As a simple example, you might
have forgotten to annotate a sensitive sink as requiring an untainted type,
or you might have forgotten to annotate untrusted data as having a tainted
type.</p><p>To run the Tainting Checker, supply the
<span style="font-family:monospace">-processor TaintingChecker</span>
command-line option to javac.
</p>
<!--TOC section id="tainting-annotations" Tainting annotations-->
<h2 id="tainting-annotations" class="section">10.1&#XA0;&#XA0;Tainting annotations <a href="#tainting-annotations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The Tainting type system uses the following annotations:
</p><ul class="itemize"><li class="li-itemize">
<a href="../api/org/checkerframework/checker/tainting/qual/Untainted.html"><span style="font-family:monospace">@Untainted</span></a> indicates
a type that includes only untainted (trusted) values.
</li><li class="li-itemize"><a href="../api/org/checkerframework/checker/tainting/qual/Tainted.html"><span style="font-family:monospace">@Tainted</span></a> indicates
a type that may include tainted (untrusted) or untainted (trusted) values.
<span style="font-family:monospace">@Tainted</span> is a supertype of <span style="font-family:monospace">@Untainted</span>.
It is the default qualifier.
</li><li class="li-itemize"><a href="../api/org/checkerframework/checker/tainting/qual/PolyTainted.html"><span style="font-family:monospace">@PolyTainted</span></a> is a qualifier that is
polymorphic over tainting (see Section&#XA0;<a href="#qualifier-polymorphism">25.2</a>).
</li></ul>
<!--TOC section id="writing-untainted" Tips on writing <span style="font-family:monospace">@Untainted</span> annotations-->
<h2 id="writing-untainted" class="section">10.2&#XA0;&#XA0;Tips on writing <span style="font-family:monospace">@Untainted</span> annotations <a href="#writing-untainted" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>Most programs are designed with a boundary that surrounds sensitive
computations, separating them from untrusted values. Outside this
boundary, the program may manipulate malicious values, but no malicious
values ever pass the boundary to be operated upon by sensitive
computations.</p><p>In some programs, the area outside the boundary is very small: values are
sanitized as soon as they are received from an external source. In other
programs, the area inside the boundary is very small: values are sanitized
only immediately before being used at a sensitive sink. Either approach
can work, so long as every possibly-tainted value is sanitized before it
reaches a sensitive sink.</p><p>Once you determine the boundary, annotating your program is easy: put
<span style="font-family:monospace">@Tainted</span> outside the boundary, <span style="font-family:monospace">@Untainted</span> inside, and
<span style="font-family:monospace">@SuppressWarnings("tainting")</span> at the validation or
sanitization routines that are used at the boundary.
</p><p>The Tainting Checker&#X2019;s standard default qualifier is <span style="font-family:monospace">@Tainted</span> (see
Section&#XA0;<a href="#defaults">26.5</a> for overriding this default). This is the safest
default, and the one that should be used for all code outside the boundary
(for example, code that reads user input). You can set the default
qualifier to <span style="font-family:monospace">@Untainted</span> in code that may contain sensitive sinks.</p><p>The Tainting Checker does not know the intended semantics of your program,
so it cannot warn you if you mis-annotate a sensitive sink as taking
<span style="font-family:monospace">@Tainted</span> data, or if you mis-annotate external data as
<span style="font-family:monospace">@Untainted</span>. So long as you correctly annotate the sensitive sinks
and the places that untrusted data is read, the Tainting Checker will
ensure that all your other annotations are correct and that no undesired
information flows exist.</p><p>As an example, suppose that you wish to prevent SQL injection attacks. You
would start by annotating the
<a href="https://docs.oracle.com/javase/8/docs/api/java/sql/Statement.html"><span style="font-family:monospace">Statement</span></a> class to indicate that the
<span style="font-family:monospace">execute</span> operations may only operate on untainted queries
(Chapter&#XA0;<a href="#annotating-libraries">30</a> describes how to annotate external
libraries):</p><pre class="verbatim">  public boolean execute(@Untainted String sql) throws SQLException;
  public boolean executeUpdate(@Untainted String sql) throws SQLException;
</pre>
<!--TOC section id="tainting-many-uses" <span style="font-family:monospace">@Tainted</span> and <span style="font-family:monospace">@Untainted</span> can be used for many purposes-->
<h2 id="tainting-many-uses" class="section">10.3&#XA0;&#XA0;<span style="font-family:monospace">@Tainted</span> and <span style="font-family:monospace">@Untainted</span> can be used for many purposes <a href="#tainting-many-uses" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The <span style="font-family:monospace">@Tainted</span> and <span style="font-family:monospace">@Untainted</span> annotations have only minimal
built-in semantics. In fact, the Tainting Checker provides only a small
amount of functionality beyond the Subtyping Checker
(Chapter&#XA0;<a href="#subtyping-checker">23</a>). This lack of hard-coded behavior has
two consequences. The first consequence is that
the annotations can serve many different purposes, such as:</p><ul class="itemize"><li class="li-itemize">
Prevent SQL injection attacks: <span style="font-family:monospace">@Tainted</span> is external input,
<span style="font-family:monospace">@Untainted</span> has been checked for SQL syntax.
</li><li class="li-itemize">Prevent cross-site scripting attacks: <span style="font-family:monospace">@Tainted</span> is external input,
<span style="font-family:monospace">@Untainted</span> has been checked for JavaScript syntax.
</li><li class="li-itemize">Prevent information leakage: <span style="font-family:monospace">@Tainted</span> is secret data,
<span style="font-family:monospace">@Untainted</span> may be displayed to a user.
</li></ul><p>The second consequence is that the Tainting Checker is not useful unless
you annotate the appropriate sources, sinks, and untainting/sanitization
routines.
</p><p>If you want more specialized semantics, or you want to annotate multiple
types of tainting (for example, HTML and SQL) in a single program,
then you can copy the definition of
the Tainting Checker to create a new annotation and checker with a more
specific name and semantics. You will change the copy to rename the
annotations, and you will annotate libraries and/or your code to identify
sources, sinks, and validation/sanitization routines.
See Chapter&#XA0;<a href="#creating-a-checker">31</a> for more
details.</p>
<!--TOC section id="tainting-polymorphism-caution" A caution about polymorphism and side effects-->
<h2 id="tainting-polymorphism-caution" class="section">10.4&#XA0;&#XA0;A caution about polymorphism and side effects <a href="#tainting-polymorphism-caution" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>Misuse of polymorphism can lead to unsoundness with the Tainting Checker
and other similar information flow checkers. To understand the potential
problem, consider the <span style="font-family:monospace">append</span> function in
<span style="font-family:monospace">java.lang.StringBuffer</span>:</p><pre class="verbatim">  public StringBuffer append(StringBuffer this, String toAppend);
</pre><p>Given these declarations:</p><pre class="verbatim">  @Tainted StringBuffer tsb;
  @Tainted String ts;
  @Untainted StringBuffer usb;
  @Untainted String us;
</pre><p>both of these invocations should be legal:</p><pre class="verbatim">  tsb.append(ts);
  usb.append(us);
</pre><p>That suggests that perhaps the function should be annotated as polymorphic:</p><pre class="verbatim">  // UNSOUND annotation -- do not do this!
  public @PolyTainted StringBuffer append(@PolyTainted StringBuffer this, @PolyTainted String toAppend);
</pre><p>The problem with the above annotation is that it permits the undesirable
invocation:</p><pre class="verbatim">  usb.append(ts); // illegal invocation
</pre><p>This invocation is permitted because, in the expression, all
<span style="font-family:monospace">@PolyTainted</span> annotations on formal parameters are instantiated to
<span style="font-family:monospace">@Tainted</span>, the top annotation, and each argument is a subtype of the
corresponding formal parameter.</p><p>Beware this problem both in code you write, and also in annotated libraries
(such as stub files).</p><p>(Side note: if <span style="font-family:monospace">append</span> were purely functional (had no side effects
and returned a new <span style="font-family:monospace">StringBuffer</span>) the method call would be acceptable,
because the return type is instantiated to <span style="font-family:monospace">@Tainted StringBuffer</span> for the
expression <span style="font-family:monospace">usb.append(ts)</span>. However, the <span style="font-family:monospace">append</span> method works via
side-effect, and only returns a reference to the buffer as a convenience
for writing &#X201C;fluent&#X201D; client code.)</p><hr>
<!--TOC chapter id="regex-checker" Regex Checker for regular expression syntax-->
<h1 id="regex-checker" class="chapter">Chapter&#XA0;11&#XA0;&#XA0;Regex Checker for regular expression syntax <a href="#regex-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h1><!--SEC END --><p>The Regex Checker prevents, at compile-time, use of syntactically invalid
regular expressions and access of invalid capturing groups.</p><p>A regular expression, or regex, is a pattern for matching certain strings
of text. In Java, a programmer writes a regular expression as a string.
At run time, the string is &#X201C;compiled&#X201D; into an efficient internal form
(<a href="https://docs.oracle.com/javase/8/docs/api/java/util/regex/Pattern.html"><span style="font-family:monospace">Pattern</span></a>) that is used for
text-matching. Regular expression in Java also have capturing groups, which
are delimited by parentheses and allow for extraction from text.</p><p>The syntax of regular expressions is complex, so it is easy to make a
mistake. It is also easy to accidentally use a regex feature from another
language that is not supported by Java (see section &#X201C;Comparison to Perl
5&#X201D; in the <a href="https://docs.oracle.com/javase/8/docs/api/java/util/regex/Pattern.html"><span style="font-family:monospace">Pattern</span></a> Javadoc).
Ordinarily, the programmer does not learn of these errors until run time.
The Regex Checker warns about these problems at compile time.</p><p>For further details, including case studies, see a paper about the Regex
Checker&#XA0;[<a href="#SpishakDE2012">SDE12</a>].</p><p>To run the Regex Checker, supply the
<span style="font-family:monospace">-processor org.checkerframework.checker.regex.RegexChecker</span>
command-line option to javac.</p>
<!--TOC section id="regex-annotations" Regex annotations-->
<h2 id="regex-annotations" class="section">11.1&#XA0;&#XA0;Regex annotations <a href="#regex-annotations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>These qualifiers make up the Regex type system:</p><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/regex/qual/Regex.html"><span style="font-weight:bold"><span style="font-family:monospace">@Regex</span></span></a></dt><dd class="dd-description">
indicates that the run-time value is a valid regular expression
<span style="font-family:monospace">String</span>. If the optional parameter is supplied to the qualifier,
then the number of capturing groups in the regular expression is at least
that many. If not provided, the parameter defaults to 0.
For example, if an expression&#X2019;s type is <span style="font-family:monospace">@Regex(1) String</span>, then its
run-time value could be <span style="font-family:monospace">"colo(u?)r"</span> or <span style="font-family:monospace">"(brown|beige)"</span> but not
<span style="font-family:monospace">"colou?r"</span> nor a non-regex string such as <span style="font-family:monospace">"1) first point"</span>.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/regex/qual/PolyRegex.html"><span style="font-weight:bold"><span style="font-family:monospace">@PolyRegex</span></span></a></dt><dd class="dd-description">
indicates qualifier polymorphism (see Section&#XA0;<a href="#qualifier-polymorphism">25.2</a>).</dd></dl><p>The subtyping hierarchy of the Regex Checker&#X2019;s qualifiers is shown in
Figure&#XA0;<a href="#fig-regex-hierarchy">11.1</a>.</p><blockquote class="figure"><div class="center"><hr style="width:80%;height:2"></div>
<div class="center">
<img src="regex.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 11.1: The subtyping relationship of the Regex Checker&#X2019;s qualifiers.
The type qualifiers are applicable to <span style="font-family:monospace">CharSequence</span> and its subtypes.
Because the parameter to a <span style="font-family:monospace">@Regex</span> qualifier is at least the number of
capturing groups in a regular expression, a <span style="font-family:monospace">@Regex</span> qualifier with more
capturing groups is a subtype of a <span style="font-family:monospace">@Regex</span> qualifier with fewer capturing
groups. Qualifiers in gray are used internally by the type
system but should never be written by a programmer.</td></tr>
</table></div>
<a id="fig-regex-hierarchy"></a>
<div class="center"><hr style="width:80%;height:2"></div></blockquote>
<!--TOC section id="annotating-with-regex" Annotating your code with <span style="font-family:monospace">@Regex</span>-->
<h2 id="annotating-with-regex" class="section">11.2&#XA0;&#XA0;Annotating your code with <span style="font-family:monospace">@Regex</span> <a href="#annotating-with-regex" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END -->
<!--TOC subsection id="regex-implicit-qualifiers" Implicit qualifiers-->
<h3 id="regex-implicit-qualifiers" class="subsection">11.2.1&#XA0;&#XA0;Implicit qualifiers <a href="#regex-implicit-qualifiers" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The Regex Checker adds
implicit qualifiers, reducing the number of annotations that must appear
in your code (see Section&#XA0;<a href="#effective-qualifier">26.4</a>).
If a <span style="font-family:monospace">String</span> literal is a valid regex,
the checker implicitly adds the <span style="font-family:monospace">@Regex</span> qualifier with
the argument set to the correct number of capturing groups.
The Regex Checker allows
the <span style="font-family:monospace">null</span> literal to be assigned to any type qualified with the
<span style="font-family:monospace">Regex</span> qualifier.</p>
<!--TOC subsection id="regex-capturing-groups" Capturing groups-->
<h3 id="regex-capturing-groups" class="subsection">11.2.2&#XA0;&#XA0;Capturing groups <a href="#regex-capturing-groups" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The Regex Checker validates that a legal capturing group number is passed
to <a href="https://docs.oracle.com/javase/8/docs/api/java/util/regex/Matcher.html"><span style="font-family:monospace">Matcher</span></a>&#X2019;s
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/regex/Matcher.html#group-int-"><span style="font-family:monospace">group</span></a>,
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/regex/Matcher.html#start-int-"><span style="font-family:monospace">start</span></a> and
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/regex/Matcher.html#end-int-"><span style="font-family:monospace">end</span></a> methods. To do this,
the type of <span style="font-family:monospace">Matcher</span> must be qualified with a <span style="font-family:monospace">@Regex</span> annotation
with the number of capturing groups in the regular expression. This is
handled implicitly by the Regex Checker for local variables (see
Section&#XA0;<a href="#type-refinement">26.7</a>), but you may need to add <span style="font-family:monospace">@Regex</span> annotations
with a capturing group count to <span style="font-family:monospace">Pattern</span> and <span style="font-family:monospace">Matcher</span> fields and
parameters.</p>
<!--TOC subsection id="regex-partial-regex" Concatenation of partial regular expressions-->
<h3 id="regex-partial-regex" class="subsection">11.2.3&#XA0;&#XA0;Concatenation of partial regular expressions <a href="#regex-partial-regex" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><blockquote class="figure"><div class="center"><hr style="width:80%;height:2"></div>
<pre class="verbatim">public @Regex String parenthesize(@Regex String regex) {
    return "(" + regex + ")"; // Even though the parentheses are not @Regex Strings,
                              // the whole expression is a @Regex String
}
</pre><div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 11.2: An example of the Regex Checker&#X2019;s support for concatenation
of non-regular-expression Strings to produce valid regular expression Strings.</td></tr>
</table></div>
<a id="fig-regex-partial"></a>
<div class="center"><hr style="width:80%;height:2"></div></blockquote><p>In general, concatenating a non-regular-expression String with any other
string yields a non-regular-expression String. The Regex Checker can
sometimes determine that concatenation of non-regular-expression Strings
will produce valid regular expression Strings. For an example see
Figure&#XA0;<a href="#fig-regex-partial">11.2</a>.</p>
<!--TOC subsection id="regexutil-methods" Testing whether a string is a regular expression-->
<h3 id="regexutil-methods" class="subsection">11.2.4&#XA0;&#XA0;Testing whether a string is a regular expression <a href="#regexutil-methods" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Sometimes, the Regex Checker cannot infer whether a particular expression
is a regular expression &#X2014; and sometimes your code cannot either! In
these cases, you can use the <span style="font-family:monospace">isRegex</span> method to perform such a test, and
other helper methods to provide useful error messages. A
common use is for user-provided regular expressions (such as ones passed
on the command-line).
Figure&#XA0;<a href="#fig-regex-util-example">11.3</a> gives an
example of the intended use of the <span style="font-family:monospace">RegexUtil</span> methods.</p><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/regex/RegexUtil.html#isRegex-java.lang.String-"><span style="font-weight:bold"><span style="font-family:monospace">RegexUtil.isRegex</span></span></a></dt><dd class="dd-description">
returns <span style="font-family:monospace">true</span> if its argument is a valid regular expression.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/regex/RegexUtil.html#regexError-java.lang.String-"><span style="font-weight:bold"><span style="font-family:monospace">RegexUtil.regexError</span></span></a></dt><dd class="dd-description">
returns a <span style="font-family:monospace">String</span> error message if its argument is not a valid regular
expression, or <span style="font-family:monospace">null</span> if its argument is a valid regular expression.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/regex/RegexUtil.html#regexException-java.lang.String-"><span style="font-weight:bold"><span style="font-family:monospace">RegexUtil.regexException</span></span></a></dt><dd class="dd-description">
returns the
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/regex/PatternSyntaxException.html"><span style="font-family:monospace">PatternSyntaxException</span></a>
that <a href="https://docs.oracle.com/javase/8/docs/api/java/util/regex/Pattern.html#compile-java.lang.String-"><span style="font-family:monospace">Pattern.compile(String)</span></a>
throws when compiling an invalid regular expression. It returns <span style="font-family:monospace">null</span>
if its argument is a valid regular expression.</dd></dl><p>An additional version of each of these methods is also provided that takes
an additional group count parameter. The
<a href="../api/org/checkerframework/checker/regex/RegexUtil.html#isRegex-java.lang.String-int-"><span style="font-family:monospace">RegexUtil.isRegex</span></a> method
verifies that the argument has at least the given number of groups. The
<a href="../api/org/checkerframework/checker/regex/RegexUtil.html#regexError-java.lang.String-int-"><span style="font-family:monospace">RegexUtil.regexError</span></a> and
<a href="../api/org/checkerframework/checker/regex/RegexUtil.html#regexException-java.lang.String-int-"><span style="font-family:monospace">RegexUtil.regexException</span></a>
methods return a <span style="font-family:monospace">String</span> error message and <span style="font-family:monospace">PatternSyntaxException</span>,
respectively, detailing why the given String is not a syntactically valid
regular expression with at least the given number of capturing groups.</p><p>
If you detect that a <span style="font-family:monospace">String</span> is not a valid regular expression but would like
to report the error higher up the call stack (potentially where you can
provide a more detailed error message) you can throw a
<a href="../api/org/checkerframework/checker/regex/RegexUtil.CheckedPatternSyntaxException.html"><span style="font-family:monospace">RegexUtil.CheckedPatternSyntaxException</span></a>. This exception is
functionally the same as a
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/regex/PatternSyntaxException.html"><span style="font-family:monospace">PatternSyntaxException</span></a>
except it is checked to guarantee that the error will be handled up the
call stack. For more details, see the Javadoc for
<a href="../api/org/checkerframework/checker/regex/RegexUtil.CheckedPatternSyntaxException.html"><span style="font-family:monospace">RegexUtil.CheckedPatternSyntaxException</span></a>.
</p><p>To use the <span style="font-family:monospace">RegexUtil</span> class, the <span style="font-family:monospace">checker-qual.jar</span> file
must be on the classpath at run time.</p><blockquote class="figure"><div class="center"><hr style="width:80%;height:2"></div>
<pre class="verbatim">String regex = getRegexFromUser();
if (! RegexUtil.isRegex(regex)) {
   throw new RuntimeException("Error parsing regex " + regex, RegexUtil.regexException(regex));
}
Pattern p = Pattern.compile(regex);
</pre><div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 11.3: Example use of <span style="font-family:monospace">RegexUtil</span> methods.</td></tr>
</table></div>
<a id="fig-regex-util-example"></a>
<div class="center"><hr style="width:80%;height:2"></div></blockquote>
<!--TOC subsection id="regex-suppressing-warnings" Suppressing warnings-->
<h3 id="regex-suppressing-warnings" class="subsection">11.2.5&#XA0;&#XA0;Suppressing warnings <a href="#regex-suppressing-warnings" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>If you are positive that a particular string that is being used as a
regular expression is syntactically valid, but the Regex Checker cannot
conclude this and issues a warning about possible use of an invalid regular
expression, then you can use the
<a href="../api/org/checkerframework/checker/regex/RegexUtil.html#asRegex-java.lang.String-"><span style="font-family:monospace">RegexUtil.asRegex</span></a> method to suppress the
warning.</p><p>You can think of this method
as a cast: it returns its argument unchanged, but with the type
<span style="font-family:monospace">@Regex String</span> if it is a valid regular expression. It throws an
error if its argument is not a valid regular expression, but you should
only use it when you are sure it will not throw an error.</p><p>There is an additional <a href="../api/org/checkerframework/checker/regex/RegexUtil.html#asRegex-java.lang.String-int-"><span style="font-family:monospace">RegexUtil.asRegex</span></a>
method that takes a capturing group parameter. This method works the same as
described above, but returns a <span style="font-family:monospace">@Regex String</span> with the parameter on the
annotation set to the value of the capturing group parameter passed to the method.</p><p>The use case shown in Figure&#XA0;<a href="#fig-regex-util-example">11.3</a> should support most cases
so the <span style="font-family:monospace">asRegex</span> method should be used rarely.</p><hr>
<!--TOC chapter id="formatter-checker" Format String Checker-->
<h1 id="formatter-checker" class="chapter">Chapter&#XA0;12&#XA0;&#XA0;Format String Checker <a href="#formatter-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h1><!--SEC END --><p>
The Format String Checker
prevents use of incorrect format strings
in format methods such as
<a href="https://docs.oracle.com/javase/8/docs/api/java/io/PrintStream.html#printf-java.lang.String-java.lang.Object...-"><span style="font-family:monospace">System.out.printf</span></a>
and <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html#format-java.lang.String-java.lang.Object...-"><span style="font-family:monospace">String.format</span></a>.
</p><p>The Format String Checker warns you if you write an invalid format string,
and it warns you if the other arguments are not consistent with the format
string (in number of arguments or in their types).
Here are examples of errors that the
Format String Checker
detects at compile time.
Section&#XA0;<a href="#formatter-guarantees">12.3</a> provides more details.</p><pre class="verbatim">  String.format("%y", 7);           // error: invalid format string

  String.format("%d", "a string");  // error: invalid argument type for %d

  String.format("%d %s", 7);        // error: missing argument for %s
  String.format("%d", 7, 3);        // warning: unused argument 3
  String.format("{0}", 7);          // warning: unused argument 7, because {0} is wrong syntax
</pre><p>
To run the Format String Checker, supply the
<span style="font-family:monospace">-processor org.checkerframework.checker.formatter.FormatterChecker</span> command-line option to javac.
</p>
<!--TOC section id="formatter-terminology" Formatting terminology-->
<h2 id="formatter-terminology" class="section">12.1&#XA0;&#XA0;Formatting terminology <a href="#formatter-terminology" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>Printf-style formatting takes as an argument a <em>format string</em> and a
list of arguments. It produces a new string in which each <em>format
specifier</em> has been replaced by the corresponding argument.
The format specifier determines how the format argument is converted to a
string.
A format specifier is introduced by a <span style="font-family:monospace">%</span> character. For example,
<span style="font-family:monospace">String.format("The %s is %d.","answer",42)</span> yields
<span style="font-family:monospace">"The answer is 42."</span>. <span style="font-family:monospace">"The %s is %d."</span> is
the format string, <span style="font-family:monospace">"%s"</span> and <span style="font-family:monospace">"%d"</span> are the format specifiers;
<span style="font-family:monospace">"answer"</span> and <span style="font-family:monospace">42</span> are format arguments.</p>
<!--TOC section id="formatter-annotations" Format String Checker annotations-->
<h2 id="formatter-annotations" class="section">12.2&#XA0;&#XA0;Format String Checker annotations <a href="#formatter-annotations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The <a href="../api/org/checkerframework/checker/formatter/qual/Format.html"><span style="font-family:monospace">@Format</span></a> qualifier on a string type
indicates a <em>valid</em> format string. The JDK documentation for the
<span style="font-family:monospace">Formatter</span> class explains the requirements for a
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Formatter.html#syntax">valid format string</a>.
A programmer rarely writes the <span style="font-family:monospace">@Format</span> annotation, as it is inferred for
string literals. A programmer may need to write it on fields and on method
signatures.</p><p>The <a href="../api/org/checkerframework/checker/formatter/qual/Format.html"><span style="font-family:monospace">@Format</span></a> qualifier is parameterized with
a list of conversion categories that impose restrictions on the format arguments.
Conversion categories are explained in more detail in
Section&#XA0;<a href="#formatter-categories">12.2.1</a>. The type qualifier for <span style="font-family:monospace">"%d %f"</span> is
for example <span style="font-family:monospace">@Format({INT, FLOAT})</span>.</p><p>Consider the below <span style="font-family:monospace">printFloatAndInt</span> method. Its parameter must be a
format string that can be used in a format method, where the first format
argument is &#X201C;float-like&#X201D; and the second format argument is
&#X201C;integer-like&#X201D;. The type of its parameter, <span style="font-family:monospace">@Format({FLOAT, INT})
String</span>, expresses that contract.</p><pre class="verbatim">    void printFloatAndInt(@Format({FLOAT, INT}) String fs) {
        System.out.printf(fs, 3.1415, 42);
    }

    printFloatAndInt("Float %f, Number %d");  // OK
    printFloatAndInt("Float %f");             // error
</pre><blockquote class="figure"><div class="center"><hr style="width:80%;height:2"></div>
<div class="center">
<img src="formatter-hierarchy.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 12.1: The
Format String Checker type qualifier hierarchy.
The type qualifiers are applicable to <span style="font-family:monospace">CharSequence</span> and its subtypes.
The figure does not show the subtyping rules among different
<span style="font-family:monospace">@Format(...)</span>
qualifiers; see
Section&#XA0;<a href="#formatter-format-subtyping">12.2.2</a>.
</td></tr>
</table></div>
<a id="fig-formatter-hierarchy"></a>
<div class="center"><hr style="width:80%;height:2"></div></blockquote><p>Figure&#XA0;<a href="#fig-formatter-hierarchy">12.1</a> shows all the type qualifiers.
The annotations other than <span style="font-family:monospace">@Format</span> are only used
internally and cannot be written in your code.
<a href="../api/org/checkerframework/checker/formatter/qual/InvalidFormat.html"><span style="font-family:monospace">@InvalidFormat</span></a> indicates an invalid format
string &#X2014; that is, a string that cannot be used as a format string. For
example, the type of <span style="font-family:monospace">"%y"</span> is <span style="font-family:monospace">@InvalidFormat String</span>.
<a href="../api/org/checkerframework/checker/formatter/qual/FormatBottom.html"><span style="font-family:monospace">@FormatBottom</span></a> is the type of the
<span style="font-family:monospace">null</span> literal.
<a href="../api/org/checkerframework/checker/formatter/qual/UnknownFormat.html"><span style="font-family:monospace">@UnknownFormat</span></a> is the default that is
applied to strings that are not literals and on which the user has not
written a <span style="font-family:monospace">@Format</span> annotation.</p><p>There is also a <a href="../api/org/checkerframework/checker/formatter/qual/FormatMethod.html"><span style="font-family:monospace">@FormatMethod</span></a>
annotation; see Section&#XA0;<a href="#formatter-FormatMethod">12.5</a>.</p>
<!--TOC subsection id="formatter-categories" Conversion Categories-->
<h3 id="formatter-categories" class="subsection">12.2.1&#XA0;&#XA0;Conversion Categories <a href="#formatter-categories" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Given a format specifier, only certain format arguments are compatible with
it, depending on its &#X201C;conversion&#X201D; &#X2014; its last, or last two,
characters. For example, in the format specifier <span style="font-family:monospace">"%d"</span>, the
conversion <span style="font-family:monospace">d</span> restricts the corresponding format argument
to be &#X201C;integer-like&#X201D;:</p><pre class="verbatim">    String.format("%d", 5);         // OK
    String.format("%d", "hello");   // error
</pre><p>Many conversions enforce the same restrictions. A set of
restrictions is represented as a <em>conversion
category</em>. The &#X201C;integer like&#X201D; restriction is for example the conversion
category <a href="../api/org/checkerframework/checker/formatter/qual/ConversionCategory.html#INT"><span style="font-family:monospace">INT</span></a>. The following conversion categories are defined in the
<a href="../api/org/checkerframework/checker/formatter/qual/ConversionCategory.html"><span style="font-family:monospace">ConversionCategory</span></a> enumeration:</p><dl class="description"><dt class="dt-description">
</dt><dd class="dd-description"><a href="../api/org/checkerframework/checker/formatter/qual/ConversionCategory.html#GENERAL"><span style="font-family:monospace">GENERAL</span></a> imposes no restrictions on a format argument&#X2019;s type. Applicable for
conversions b, B, h, H, s, S.</dd><dt class="dt-description"></dt><dd class="dd-description"><a href="../api/org/checkerframework/checker/formatter/qual/ConversionCategory.html#CHAR"><span style="font-family:monospace">CHAR</span></a> requires that a format argument represents a Unicode character.
Specifically, <span style="font-family:monospace">char</span>, <span style="font-family:monospace">Character</span>, <span style="font-family:monospace">byte</span>,
<span style="font-family:monospace">Byte</span>, <span style="font-family:monospace">short</span>, and <span style="font-family:monospace">Short</span> are allowed.
<span style="font-family:monospace">int</span> or <span style="font-family:monospace">Integer</span> are allowed if
<span style="font-family:monospace">Character.isValidCodePoint(argument)</span> would return <span style="font-family:monospace">true</span>
for the format argument. (The Format String Checker permits any <span style="font-family:monospace">int</span>
or <span style="font-family:monospace">Integer</span> without issuing a warning or error &#X2014; see
Section&#XA0;<a href="#formatter-missed-alarms">12.3.2</a>.)
Applicable for conversions c, C.</dd><dt class="dt-description"></dt><dd class="dd-description"><a href="../api/org/checkerframework/checker/formatter/qual/ConversionCategory.html#INT"><span style="font-family:monospace">INT</span></a> requires that a format argument represents an integral type. Specifically,
<span style="font-family:monospace">byte</span>, <span style="font-family:monospace">Byte</span>, <span style="font-family:monospace">short</span>, <span style="font-family:monospace">Short</span>,
<span style="font-family:monospace">int</span> and <span style="font-family:monospace">Integer</span>, <span style="font-family:monospace">long</span>,
<span style="font-family:monospace">Long</span>, and <span style="font-family:monospace">BigInteger</span> are allowed. Applicable for
conversions d, o, x, X.</dd><dt class="dt-description"></dt><dd class="dd-description"><a href="../api/org/checkerframework/checker/formatter/qual/ConversionCategory.html#FLOAT"><span style="font-family:monospace">FLOAT</span></a> requires that a format argument represents a floating-point type. Specifically,
<span style="font-family:monospace">float</span>, <span style="font-family:monospace">Float</span>, <span style="font-family:monospace">double</span>,
<span style="font-family:monospace">Double</span>, and <span style="font-family:monospace">BigDecimal</span> are allowed. Surprisingly, integer
values are not allowed. Applicable for
conversions e, E, f, g, G, a, A.</dd><dt class="dt-description"></dt><dd class="dd-description"><a href="../api/org/checkerframework/checker/formatter/qual/ConversionCategory.html#TIME"><span style="font-family:monospace">TIME</span></a> requires that a format argument represents a date or time.
Specifically, <span style="font-family:monospace">long</span>, <span style="font-family:monospace">Long</span>, <span style="font-family:monospace">Calendar</span>, and
<span style="font-family:monospace">Date</span> are allowed. Applicable for conversions t, T.</dd><dt class="dt-description"></dt><dd class="dd-description"><a href="../api/org/checkerframework/checker/formatter/qual/ConversionCategory.html#UNUSED"><span style="font-family:monospace">UNUSED</span></a> imposes no restrictions on a format argument. This is the case if a
format argument is not used as replacement for any format specifier.
<span style="font-family:monospace">"%2$s"</span> for example ignores the first format argument.
</dd></dl><p>Further, all conversion categories accept <span style="font-family:monospace">null</span>.
</p><p>The same format argument may serve as a replacement for multiple format specifiers.
Until now, we have assumed that the format specifiers simply consume format arguments left to right.
But there are two other ways for a format specifier to select a format argument:</p><ul class="itemize"><li class="li-itemize">
<span style="font-style:italic">n</span><span style="font-family:monospace">$</span> specifies a one-based index <span style="font-style:italic">n</span>. In the
format string <span style="font-family:monospace">"%2$s"</span>, the format specifier selects the
second format argument.
</li><li class="li-itemize">The <span style="font-family:monospace">&lt;</span> <em>flag</em> references the format argument
that was used by the previous format specifier. In the format string
<span style="font-family:monospace">"%d %&lt;d"</span> for example, both format specifiers select the first
format argument.
</li></ul><p>In the following example,
the format argument must be compatible with both conversion
categories, and can therefore be neither a <span style="font-family:monospace">Character</span> nor a <span style="font-family:monospace">long</span>.</p><pre class="verbatim">    format("Char %1$c, Int %1$d", (int)42);            // OK
    format("Char %1$c, Int %1$d", new Character(42));  // error
    format("Char %1$c, Int %1$d", (long)42);           // error
</pre><p>Only three additional conversion categories are needed represent all possible
intersections of previously-mentioned conversion categories:</p><dl class="description"><dt class="dt-description">
</dt><dd class="dd-description"><a href="../api/org/checkerframework/checker/formatter/qual/ConversionCategory.html#NULL"><span style="font-family:monospace">NULL</span></a> is used if no object of any type can be
passed as parameter. In this case, the only legal value is <span style="font-family:monospace">null</span>.
The format string <span style="font-family:monospace">"%1$f %1$c"</span>, for example requires that the first
format argument be <span style="font-family:monospace">null</span>. Passing a value such as <span style="font-family:monospace">4</span> or
<span style="font-family:monospace">4.2</span> would lead to an exception.
</dd><dt class="dt-description"></dt><dd class="dd-description"><a href="../api/org/checkerframework/checker/formatter/qual/ConversionCategory.html#CHAR_AND_INT"><span style="font-family:monospace">CHAR_AND_INT</span></a> is used if a format argument is restricted by a <a href="../api/org/checkerframework/checker/formatter/qual/ConversionCategory.html#CHAR"><span style="font-family:monospace">CHAR</span></a> and a <a href="../api/org/checkerframework/checker/formatter/qual/ConversionCategory.html#INT"><span style="font-family:monospace">INT</span></a> conversion category (<span style="font-family:monospace">CHAR</span> &#X2229; <span style="font-family:monospace">INT</span>).
</dd><dt class="dt-description"></dt><dd class="dd-description"><a href="../api/org/checkerframework/checker/formatter/qual/ConversionCategory.html#INT_AND_TIME"><span style="font-family:monospace">INT_AND_TIME</span></a> is used if a format argument is restricted by an <a href="../api/org/checkerframework/checker/formatter/qual/ConversionCategory.html#INT"><span style="font-family:monospace">INT</span></a> and a <a href="../api/org/checkerframework/checker/formatter/qual/ConversionCategory.html#TIME"><span style="font-family:monospace">TIME</span></a> conversion category (<span style="font-family:monospace">INT</span> &#X2229; <span style="font-family:monospace">TIME</span>).
</dd></dl><p>All other intersections lead to already existing conversion categories.
For example, <span style="font-family:monospace">GENERAL</span> &#X2229; <span style="font-family:monospace">CHAR</span> = <span style="font-family:monospace">CHAR</span> and
<span style="font-family:monospace">UNUSED</span> &#X2229; <span style="font-family:monospace">GENERAL</span> = <span style="font-family:monospace">GENERAL</span>.</p><p>Figure&#XA0;<a href="#fig-formatter-cat">12.2</a> summarizes the subset
relationship among all conversion categories.</p><blockquote class="figure"><div class="center"><hr style="width:80%;height:2"></div>
<div class="center">
<img src="formatter-categories.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 12.2: The subset relationship
among conversion categories.</td></tr>
</table></div>
<a id="fig-formatter-cat"></a>
<div class="center"><hr style="width:80%;height:2"></div></blockquote>
<!--TOC subsection id="formatter-format-subtyping" Subtyping rules for <span style="font-family:monospace">@Format</span>-->
<h3 id="formatter-format-subtyping" class="subsection">12.2.2&#XA0;&#XA0;Subtyping rules for <span style="font-family:monospace">@Format</span> <a href="#formatter-format-subtyping" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Here are the subtyping rules among different
<a href="../api/org/checkerframework/checker/formatter/qual/Format.html"><span style="font-family:monospace">@Format</span></a>
qualifiers.
It is legal to:</p><ul class="itemize"><li class="li-itemize">
use a format string with a weaker (less restrictive) conversion category than required.
</li><li class="li-itemize">use a format string with fewer format specifiers than required.
Although this is legal a warning is issued because most occurrences of
this are due to programmer error.
</li></ul><p>The following example shows the subtyping rules in action:</p><pre class="verbatim">    @Format({FLOAT, INT}) String f;

    f = "%f %d";       // OK
    f = "%s %d";       // OK, %s is weaker than %f
    f = "%f";          // warning: last argument is ignored
    f = "%f %d %s";    // error: too many arguments
    f = "%d %d";       // error: %d is not weaker than %f

    String.format(f, 0.8, 42);
</pre>
<!--TOC section id="formatter-guarantees" What the Format String Checker checks-->
<h2 id="formatter-guarantees" class="section">12.3&#XA0;&#XA0;What the Format String Checker checks <a href="#formatter-guarantees" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>If the Format String Checker issues no errors, it provides the following guarantees:</p><ol class="enumerate" type=1><li class="li-enumerate">
The following guarantees hold for every format method invocation:<ol class="enumerate" type=a><li class="li-enumerate">
The format method&#X2019;s first parameter (or second if a <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Locale.html"><span style="font-family:monospace">Locale</span></a> is provided) is a valid
format string (or <span style="font-family:monospace">null</span>).</li><li class="li-enumerate">A warning is issued if one of the format string&#X2019;s conversion categories is <span style="font-family:monospace">UNUSED</span>.
<a id="formatter-unused-category-warning"></a>
</li><li class="li-enumerate">None of the format string&#X2019;s conversion categories is <span style="font-family:monospace">NULL</span>.
<a id="formatter-null-category-error"></a>
</li></ol></li><li class="li-enumerate">If the format arguments are passed to the format method as varargs, the
Format String Checker guarantees the following additional properties:<ol class="enumerate" type=a><li class="li-enumerate">
No fewer format arguments are passed than required by the format string.
</li><li class="li-enumerate">A warning is issued if more format arguments are passed than required by the format string.
</li><li class="li-enumerate">Every format argument&#X2019;s type satisfies its conversion category&#X2019;s restrictions.
</li></ol></li><li class="li-enumerate">If the format arguments are passed to the format method as an array,
a warning is issued by the Format String Checker.
<a id="formatter-array-warning"></a>
</li></ol><p>Following are examples for every guarantee:</p><pre class="verbatim">    String.format("%d", 42);                      // OK
    String.format(Locale.GERMAN, "%d", 42);       // OK
    String.format(new Object());                  // error (1a)
    String.format("%y");                          // error (1a)
    String.format("%2$s", "unused", "used");      // warning (1b)
    String.format("%1$d %1$f", 5.5);              // error (1c)
    String.format("%1$d %1$f %d", null, 6);       // error (1c)
    String.format("%s");                          // error (2a)
    String.format("%s", "used", "ignored");       // warning (2b)
    String.format("%c",4.2);                      // error (2c)
    String.format("%c", (String)null);            // error (2c)
    String.format("%1$d %1$f", new Object[]{1});  // warning (3)
    String.format("%s", new Object[]{"hello"});   // warning (3)
</pre>
<!--TOC subsection id="formatter-false-alarms" Possible false alarms-->
<h3 id="formatter-false-alarms" class="subsection">12.3.1&#XA0;&#XA0;Possible false alarms <a href="#formatter-false-alarms" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>There are three cases in which the Format String Checker may issue a
warning or error, even though the code cannot fail at run time.
(These are in addition to the general conservatism of a type system: code
may be correct because of application invariants that are not captured by
the type system.)
In each of these cases, you can rewrite the code, or you can manually check
it and write a <span style="font-family:monospace">@SuppressWarnings</span> annotation if you can reason that
the code is correct.</p><p>Case <a href="#formatter-unused-category-warning">1(b)</a>:
Unused format arguments. It is legal to provide more arguments than are
required by the format string; Java ignores the extras. However, this is
an uncommon case. In practice, a mismatch between the number of format
specifiers and the number of format arguments is usually an error.</p><p>Case <a href="#formatter-null-category-error">1(c)</a>:
Format arguments that can only be <span style="font-family:monospace">null</span>.
It is legal to write a format string that permits only null arguments and
throws an exception for any other argument. An example is
<span style="font-family:monospace">String.format("%1$d %1$f", null)</span>.
The Format String Checker forbids such a format string.
If you should ever need such a format string, simply replace the problematic
format specifier with <span style="font-family:monospace">"null"</span>. For example, you would replace the
call above by <span style="font-family:monospace">String.format("null null")</span>.</p><p>Case <a href="#formatter-array-warning">3</a>:
Array format arguments.
The Format String Checker performs no analysis of
arrays, only of varargs invocations. It is better style to use varargs
when possible.</p>
<!--TOC subsection id="formatter-missed-alarms" Possible missed alarms-->
<h3 id="formatter-missed-alarms" class="subsection">12.3.2&#XA0;&#XA0;Possible missed alarms <a href="#formatter-missed-alarms" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The Format String Checker helps prevent bugs by detecting, at compile time,
which invocations of format methods will fail. While the Format String Checker
finds most of these invocations, there are cases in which a format method call
will fail even though the Format String Checker issued neither errors nor
warnings. These cases are:</p><ol class="enumerate" type=1><li class="li-enumerate">
The format string is <span style="font-family:monospace">null</span>. Use the <a href="#nullness-checker">Nullness Checker</a> to prevent this.
</li><li class="li-enumerate">A format argument&#X2019;s <span style="font-family:monospace">toString</span> method throws an exception.
</li><li class="li-enumerate">A format argument implements the <span style="font-family:monospace">Formattable</span> interface and throws an
exception in the <span style="font-family:monospace">formatTo</span> method.
</li><li class="li-enumerate">A format argument&#X2019;s conversion category is <span style="font-family:monospace">CHAR</span> or <span style="font-family:monospace">CHAR_AND_INT</span>,
and the passed value is an <span style="font-family:monospace">int</span> or <span style="font-family:monospace">Integer</span>, and
<span style="font-family:monospace">Character.isValidCodePoint(argument)</span> returns <span style="font-family:monospace">false</span>.
</li></ol><p>The following examples illustrate these limitations:</p><pre class="verbatim">    class A {
        public String toString() {
            throw new Error();
        }
    }

    class B implements Formattable {
        public void formatTo(Formatter fmt, int f,
                int width, int precision) {
            throw new Error();
        }
    }

    // The checker issues no errors or warnings for the
    // following illegal invocations of format methods.
    String.format(null);          // NullPointerException (1)
    String.format("%s", new A()); // Error (2)
    String.format("%s", new B()); // Error (3)
    String.format("%c", (int)-1); // IllegalFormatCodePointException (4)
</pre>
<!--TOC section id="formatter-implicit" Implicit qualifiers-->
<h2 id="formatter-implicit" class="section">12.4&#XA0;&#XA0;Implicit qualifiers <a href="#formatter-implicit" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The Format String Checker adds implicit
qualifiers, reducing the number of annotations that must appear in your code
(see Section&#XA0;<a href="#effective-qualifier">26.4</a>).
The checker implicitly adds the <span style="font-family:monospace">@Format</span> qualifier with the appropriate
conversion categories to any String literal that is a valid format string.</p>
<!--TOC section id="formatter-FormatMethod" @FormatMethod-->
<h2 id="formatter-FormatMethod" class="section">12.5&#XA0;&#XA0;@FormatMethod <a href="#formatter-FormatMethod" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>Your project may contain methods that forward their arguments to a format method.
Consider for example the following <span style="font-family:monospace">log</span> method:</p><pre class="verbatim">@FormatMethod
void log(String format, Object... args) {
    if (enabled) {
        logfile.print(indent_str);
        logfile.printf(format , args);
    }
}
</pre><p>You should annotate such a method with the
<a href="../api/org/checkerframework/checker/formatter/qual/FormatMethod.html"><span style="font-family:monospace">@FormatMethod</span></a> annotation,
which indicates that the <span style="font-family:monospace">String</span> argument is a format string for the
remaining arguments.</p>
<!--TOC section id="formatter-run-time-tests" Testing whether a format string is valid-->
<h2 id="formatter-run-time-tests" class="section">12.6&#XA0;&#XA0;Testing whether a format string is valid <a href="#formatter-run-time-tests" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The Format String Checker automatically determines whether each <span style="font-family:monospace">String</span>
literal is a valid format string or not. When a string is computed or is
obtained from an external resource, then the string must be trusted or tested.</p><p>One way to test a string is to call the
<a href="../api/org/checkerframework/checker/formatter/FormatUtil.html#asFormat-java.lang.String-org.checkerframework.checker.formatter.qual.ConversionCategory...-"><span style="font-family:monospace">FormatUtil.asFormat</span></a>
method to check whether the format string is valid and its format
specifiers match certain conversion categories.
If this is not the case, <span style="font-family:monospace">asFormat</span> raises an exception. Your code should
catch this exception and handle it gracefully.</p><p>The following code examples may fail at run time, and therefore they do not
type check. The type-checking errors are indicated by comments.</p><pre class="verbatim">Scanner s = new Scanner(System.in);
String fs = s.next();
System.out.printf(fs, "hello", 1337);          // error: fs is not known to be a format string
</pre><pre class="verbatim">Scanner s = new Scanner(System.in);
@Format({GENERAL, INT}) String fs = s.next();  // error: fs is not known to have the given type
System.out.printf(fs, "hello", 1337);          // OK
</pre><p>The following variant does not throw a run-time error, and
therefore passes the type-checker:</p><pre class="verbatim">Scanner s = new Scanner(System.in);
String format = s.next()
try {
    format = FormatUtil.asFormat(format, GENERAL, INT);
} catch (IllegalFormatException e) {
    // Replace this by your own error handling.
    System.err.println("The user entered the following invalid format string: " + format);
    System.exit(2);
}
// fs is now known to be of type: @Format({GENERAL, INT}) String
System.out.printf(format, "hello", 1337);
</pre><p>To use the <span style="font-family:monospace">FormatUtil</span> class, the <span style="font-family:monospace">checker-qual.jar</span> file
must be on the classpath at run time.</p><hr>
<!--TOC chapter id="i18n-formatter-checker" Internationalization Format String Checker (I18n Format String Checker)-->
<h1 id="i18n-formatter-checker" class="chapter">Chapter&#XA0;13&#XA0;&#XA0;Internationalization Format String Checker (I18n Format String Checker) <a href="#i18n-formatter-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h1><!--SEC END --><p>The Internationalization Format String Checker, or I18n Format String Checker,
prevents use of incorrect i18n format strings.</p><p>If the I18n Format String Checker issues no warnings or errors, then
<a href="https://docs.oracle.com/javase/8/docs/api/java/text/MessageFormat.html#format-java.lang.String-java.lang.Object...-"><span style="font-family:monospace">MessageFormat.format</span></a>
will raise no error at run time.
&#X201C;I18n&#X201D; is short for
&#X201C;internationalization&#X201D; because there are 18 characters between the &#X201C;i&#X201D; and
the &#X201C;n&#X201D;.</p><p>Here are the examples of errors that the
I18n Format Checker
detects at compile time.</p><pre class="verbatim">  // Warning: the second argument is missing.
  MessageFormat.format("{0} {1}", 3.1415);
  // String argument cannot be formatted as Time type.
  MessageFormat.format("{0, time}", "my string");
  // Invalid format string: unknown format type: thyme.
  MessageFormat.format("{0, thyme}", new Date());
  // Invalid format string: missing the right brace.
  MessageFormat.format("{0", new Date());
  // Invalid format string: the argument index is not an integer.
  MessageFormat.format("{0.2, time}", new Date());
  // Invalid format string: "#.#.#" subformat is invalid.
  MessageFormat.format("{0, number, #.#.#}", 3.1415);
</pre><p>For instructions on how to run the Internationalization Format String
Checker, see Section&#XA0;<a href="#i18n-format-running">13.6</a>.</p><p>The Internationalization Checker or I18n Checker (Chapter&#XA0;<a href="#i18n-checker">14.2</a>)
has a different purpose. It verifies that your code is properly
internationalized: any user-visible text should be obtained from a
localization resource and all keys exist in that resource.</p>
<!--TOC section id="i18n-format-annotation" Internationalization Format String Checker annotations-->
<h2 id="i18n-format-annotation" class="section">13.1&#XA0;&#XA0;Internationalization Format String Checker annotations <a href="#i18n-format-annotation" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><blockquote class="figure"><div class="center"><hr style="width:80%;height:2"></div>
<div class="center">
<img src="i18n-format-type-hierarchy.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 13.1: The
Internationalization
Format String Checker type qualifier hierarchy.
The type qualifiers are applicable te <span style="font-family:monospace">CharSequence</span> and its subtypes.
The figure does not show the subtyping rules among different
<a href="../api/org/checkerframework/checker/i18nformatter/qual/I18nFormat.html"><span style="font-family:monospace">@I18nFormat</span></a><span style="font-family:monospace">(...)</span>
qualifiers; see
Section&#XA0;<a href="#i18n-format-conversion-catgeories">13.2</a>.
All <a href="../api/org/checkerframework/checker/i18nformatter/qual/I18nFormatFor.html"><span style="font-family:monospace">@I18nFormatFor</span></a> annotations are unrelated by subtyping.
The qualifiers in gray are used internally by
the checker and should never be written by a programmer.
</td></tr>
</table></div>
<a id="i18n-format-type-hierarchy"></a>
<div class="center"><hr style="width:80%;height:2"></div></blockquote><p>The <a href="https://docs.oracle.com/javase/8/docs/api/java/text/MessageFormat.html"><span style="font-family:monospace">MessageFormat</span></a> documentation
specifies the syntax of the i18n format string.</p><p>These are the qualifiers that make up the I18n Format String type system.
Figure&#XA0;<a href="#i18n-format-type-hierarchy">13.1</a> shows their subtyping relationships.</p><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/i18nformatter/qual/I18nFormat.html"><span style="font-weight:bold"><span style="font-family:monospace">@I18nFormat</span></span></a></dt><dd class="dd-description">
represents a valid i18n format string. For example,
<span style="font-family:monospace">@I18nFormat({GENERAL, NUMBER, UNUSED, DATE})</span> is a legal type for
<span style="font-family:monospace">"{0}{1, number} {3, date}"</span>, indicating that when the format
string is used,
the first argument should be of <span style="font-family:monospace">GENERAL</span> conversion category,
the second argument should be of <span style="font-family:monospace">NUMBER</span> conversion category, and so on.
Conversion categories such as <span style="font-family:monospace">GENERAL</span> are described in
Section&#XA0;<a href="#i18n-format-conversion-catgeories">13.2</a>.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/i18nformatter/qual/I18nFormatFor.html"><span style="font-weight:bold"><span style="font-family:monospace">@I18nFormatFor</span></span></a></dt><dd class="dd-description">
indicates that the qualified type is a valid i18n format string for use
with some array of values. For example,
<span style="font-family:monospace">@I18nFormatFor("#2")</span> indicates that the string can be used to
format the contents of the second parameter array.
The argument is a Java expression whose syntax
is explained in Section&#XA0;<a href="#java-expressions-as-arguments">26.8</a>.
An example of its use is:<pre class="verbatim">  static void method(@I18nFormatFor("#2") String format, Object... args) {
    // the body may use the parameters like this:
    MessageFormat.format(format, args);
  }

  method("{0, number} {1}", 3.1415, "A string");  // OK
  // error: The string "hello" cannot be formatted as a Number.
  method("{0, number} {1}", "hello", "goodbye");
</pre></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/i18nformatter/qual/I18nInvalidFormat.html"><span style="font-weight:bold"><span style="font-family:monospace">@I18nInvalidFormat</span></span></a></dt><dd class="dd-description">
represents an invalid i18n format string. Programmers are not allowed to
write this annotation. It is only used internally by the type checker.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/i18nformatter/qual/I18nUnknownFormat.html"><span style="font-weight:bold"><span style="font-family:monospace">@I18nUnknownFormat</span></span></a></dt><dd class="dd-description">
represents any string. The string might or might not be a valid i18n
format string. Programmers are not allowed to write this annotation.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/i18nformatter/qual/I18nFormatBottom.html"><span style="font-weight:bold"><span style="font-family:monospace">@I18nFormatBottom</span></span></a></dt><dd class="dd-description">
indicates that the value is definitely <span style="font-family:monospace">null</span>. Programmers are not allowed
to write this annotation.
</dd></dl>
<!--TOC section id="i18n-format-conversion-catgeories" Conversion categories-->
<h2 id="i18n-format-conversion-catgeories" class="section">13.2&#XA0;&#XA0;Conversion categories <a href="#i18n-format-conversion-catgeories" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>In a message string, the optional second element within the curly braces is
called a <em>format type</em> and must be one of <span style="font-family:monospace">number</span>, <span style="font-family:monospace">date</span>,
<span style="font-family:monospace">time</span>, and <span style="font-family:monospace">choice</span>. These four format types correspoond to different
conversion categories. <span style="font-family:monospace">date</span> and <span style="font-family:monospace">time</span> correspond to <em>DATE</em> in the
conversion categories figure. <span style="font-family:monospace">choice</span> corresponds to <em>NUMBER</em>.
The format type restricts what arguments are legal.
For example, a date argument is not compatible with
the <span style="font-family:monospace">number</span> format type, i.e., <span style="font-family:monospace">MessageFormat.format("{0, number}",
new Date())</span> will throw an exception.</p><p>The I18n Checker represents the possible arguments via <em>conversion
categories</em>. A conversion category defines a set of restrictions or a
subtyping rule.</p><p>Figure&#XA0;<a href="#i18n-format-category">13.2</a> summarizes the subset
relationship among all conversion categories.</p><blockquote class="figure"><div class="center"><hr style="width:80%;height:2"></div>
<div class="center">
<img src="i18n-format-category.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 13.2: The subset relationship among
i18n
conversion categories.</td></tr>
</table></div>
<a id="i18n-format-category"></a>
<div class="center"><hr style="width:80%;height:2"></div></blockquote>
<!--TOC section id="i18n-formatter-format-subtyping" Subtyping rules for <span style="font-family:monospace">@I18nFormat</span>-->
<h2 id="i18n-formatter-format-subtyping" class="section">13.3&#XA0;&#XA0;Subtyping rules for <span style="font-family:monospace">@I18nFormat</span> <a href="#i18n-formatter-format-subtyping" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>Here are the subtyping rules among different
<span style="font-family:monospace">@I18nFormat</span>
qualifiers.
It is legal to:</p><ul class="itemize"><li class="li-itemize">
use a format string with a weaker (less restrictive) conversion category than required.
</li><li class="li-itemize">use a format string with fewer format specifiers than required.
Although this is legal a warning is issued because most occurrences of
this are due to programmer error.
</li></ul><p>The following example shows the subtyping rules in action:</p><pre class="verbatim">  @I18nFormat({NUMBER, DATE}) String f;

  f = "{0, number, #.#} {1, date}"; // OK
  f = "{0, number} {1}";            // OK, GENERAL is weaker (less restrictive) than DATE
  f = "{0} {1, date}";              // OK, GENERAL is weaker (less restrictive) than NUMBER
  f = "{0, number}";                // warning: last argument is ignored
  f = "{0}";                        // warning: last argument is ignored
  f = "{0, number} {1, number}";    // error: NUMBER is stronger (more restrictive) than DATE
  f = "{0} {1} {2}";                // error: too many arguments
</pre><p>The conversion categories are:</p><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/i18nformatter/qual/I18nConversionCategory.html#UNUSED"><span style="font-weight:bold"><span style="font-family:monospace">UNUSED</span></span></a></dt><dd class="dd-description">
indicates an unused argument. For example, in
<span style="font-family:monospace">MessageFormat.format("{0, number} {2, number}", 3.14, "Hello", 2.718)</span>
, the second argument <span style="font-family:monospace">Hello</span> is unused. Thus, the conversion
categories for the format, <span style="font-family:monospace">0, number</span><span style="font-family:monospace"> </span><span style="font-family:monospace">2, number</span>, is
<span style="font-family:monospace">(NUMBER, UNUSED, NUMBER)</span>.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/i18nformatter/qual/I18nConversionCategory.html#GENERAL"><span style="font-weight:bold"><span style="font-family:monospace">GENERAL</span></span></a></dt><dd class="dd-description">
means that any value can be supplied as an argument.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/i18nformatter/qual/I18nConversionCategory.html#DATE"><span style="font-weight:bold"><span style="font-family:monospace">DATE</span></span></a></dt><dd class="dd-description">
is applicable for date, time, and number types. An argument needs to be
of <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/Date.html"><span style="font-family:monospace">Date</span></a>, <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/Time.html"><span style="font-family:monospace">Time</span></a>, or <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Number.html"><span style="font-family:monospace">Number</span></a> type or a subclass of them,
including <a href="https://docs.oracle.com/javase/8/docs/api/java/sql/Timestamp.html"><span style="font-family:monospace">Timestamp</span></a> and the classes
listed immediately below.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/i18nformatter/qual/I18nConversionCategory.html#NUMBER"><span style="font-weight:bold"><span style="font-family:monospace">NUMBER</span></span></a></dt><dd class="dd-description">
means that the argument needs to be of <span style="font-family:monospace">Number</span>
type or a subclass:
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Number.html"><span style="font-family:monospace">Number</span></a>,
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/atomic/AtomicInteger.html"><span style="font-family:monospace">AtomicInteger</span></a>,
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/concurrent/atomic/AtomicLong.html"><span style="font-family:monospace">AtomicLong</span></a>,
<a href="https://docs.oracle.com/javase/8/docs/api/java/math/BigDecimal.html"><span style="font-family:monospace">BigDecimal</span></a>,
<a href="https://docs.oracle.com/javase/8/docs/api/java/math/BigInteger.html"><span style="font-family:monospace">BigInteger</span></a>,
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Byte.html"><span style="font-family:monospace">Byte</span></a>,
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Double.html"><span style="font-family:monospace">Double</span></a>,
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Float.html"><span style="font-family:monospace">Float</span></a>,
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Integer.html"><span style="font-family:monospace">Integer</span></a>,
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Long.html"><span style="font-family:monospace">Long</span></a>,
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Short.html"><span style="font-family:monospace">Short</span></a>.</dd></dl>
<!--TOC section id="i18n-format-checks" What the Internationalization Format String Checker checks-->
<h2 id="i18n-format-checks" class="section">13.4&#XA0;&#XA0;What the Internationalization Format String Checker checks <a href="#i18n-format-checks" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The Internationalization Format String Checker checks calls to the i18n
formatting method <a href="https://docs.oracle.com/javase/8/docs/api/java/text/MessageFormat.html#format-java.lang.String-java.lang.Object...-"><span style="font-family:monospace">MessageFormat.format</span></a>
and guarantees the following:</p><ol class="enumerate" type=1><li class="li-enumerate">
The checker issues a warning for the following cases:
<ol class="enumerate" type=a><li class="li-enumerate">
There are missing arguments from what is required by the format string.<p><span style="font-family:monospace">MessageFormat.format("{0, number} {1, number}", 3.14); // Output: 3.14 {1}</span></p></li><li class="li-enumerate">More arguments are passed than what is required by the format string.<p><span style="font-family:monospace">MessageFormat.format("{0, number}", 1, new Date());</span></p><p><span style="font-family:monospace">MessageFormat.format("{0, number} {0, number}", 3.14, 3.14);</span></p><p>This does not cause an error at run time, but it often indicates a
programmer mistake. If it is intentional, then you should suppress
the warning (see Chapter&#XA0;<a href="#suppressing-warnings">27</a>).</p></li><li class="li-enumerate">Some argument is an array of objects.<p><span style="font-family:monospace">MessageFormat.format("{0, number} {1}", array);</span></p><p>The checker cannot verify whether the format string is valid, so
the checker conservatively issues a warning. This is a limitation of
the Internationalization Format String Checker.</p></li></ol>
</li><li class="li-enumerate">The checker issues an error for the following cases:
<ol class="enumerate" type=a><li class="li-enumerate">
The format string is invalid.<ul class="itemize"><li class="li-itemize">
Unmatched braces.<p><span style="font-family:monospace">MessageFormat.format("{0, time", new Date());</span></p></li><li class="li-itemize">The argument index is not an integer or is negative.<p><span style="font-family:monospace">MessageFormat.format("{0.2, time}", new Date());</span></p><p><span style="font-family:monospace">MessageFormat.format("{-1, time}", new Date());</span></p></li><li class="li-itemize">Unknown format type.<p><span style="font-family:monospace">MessageFormat.format("{0, foo}", 3.14);</span></p></li><li class="li-itemize">Missing a format style required for <span style="font-family:monospace">choice</span> format.<p><span style="font-family:monospace">MessageFormat.format("{0, choice}", 3.14);</span></p></li><li class="li-itemize">Wrong format style.<p><span style="font-family:monospace">MessageFormat.format("{0, time, number}", 3.14);</span></p></li><li class="li-itemize">Invalid subformats.<p><span style="font-family:monospace">MessageFormat.format("{0, number, #.#.#}", 3.14)</span>
</p></li></ul></li><li class="li-enumerate">Some argument&#X2019;s type doesn&#X2019;t satisfy its conversion category.<p><span style="font-family:monospace">MessageFormat.format("{0, number}", new Date());</span>
</p></li></ol>
</li></ol><p>The Checker also detects illegal assignments: assigning a non-format-string
or an incompatible format string to a variable declared as containing a
specific type of format string. For example,</p><pre class="verbatim">  @I18nFormat({GENERAL, NUMBER}) String format;
  // OK.
  format = "{0} {1, number}";
  // OK, GENERAL is weaker (less restrictive) than NUMBER.
  format = "{0} {1}";
  // OK, it is legal to have fewer arguments than required (less restrictive).
  // But the warning will be issued instead.
  format = "{0}";

  // Error, the format string is stronger (more restrictive) than the specifiers.
  format = "{0} {1} {2}";
  // Error, the format string is more restrictive. NUMBER is a subtype of GENERAL.
  format = "{0, number} {1, number}";
</pre>
<!--TOC section id="i18n-format-resource-files" Resource files-->
<h2 id="i18n-format-resource-files" class="section">13.5&#XA0;&#XA0;Resource files <a href="#i18n-format-resource-files" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>A programmer rarely writes an i18n format string literally. (The examples
in this chapter show that for simplicity.) Rather, the i18n format strings are
read from a resource file. The program chooses a resource file at run time
depending on the locale (for example, different resource files for English
and Spanish users).</p><p>For example, suppose that the <span style="font-family:monospace">resource1.properties</span> file contains</p><pre class="verbatim">  key1 = The number is {0, number}.
</pre><p>Then code such as the following:</p><pre class="verbatim">  String formatPattern = ResourceBundle.getBundle("resource1").getString("key1");
  System.out.println(MessageFormat.format(formatPattern, 2.2361));
</pre><p>will output &#X201C;The number is 2.2361.&#X201D; A different resource file would contain
<span style="font-family:monospace">key1 = El n&#XFA;mero es {0, number}.</span></p><p>When you run the I18n Format String Checker, you need to indicate which resource file it
should check. If you change the resource file or use a different resource
file, you should re-run the checker
to ensure that you did not make an error. The I18n Format String Checker supports two types of
resource files: ResourceBundles and property files. The example above shows use of
resource bundles.
For more about checking property files, see Chapter&#XA0;<a href="#propkey-checker">14</a>.</p>
<!--TOC section id="i18n-format-running" Running the Internationalization Format Checker-->
<h2 id="i18n-format-running" class="section">13.6&#XA0;&#XA0;Running the Internationalization Format Checker <a href="#i18n-format-running" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The checker can be invoked by running one of the following commands (with
the whole command on one line).</p><ul class="itemize"><li class="li-itemize">
Using ResourceBundles:<p>
<span style="font-family:monospace">javac -processor
org.checkerframework.checker.i18nformatter.I18nFormatterChecker
-Abundlenames=MyResource MyFile.java</span>
</p></li><li class="li-itemize">Using property files:<p>
<span style="font-family:monospace">javac -processor
org.checkerframework.checker.i18nformatter.I18nFormatterChecker
-Apropfiles=MyResource.properties MyFile.java</span>
</p></li><li class="li-itemize">Not using a property file. Use this if the programmer hard-coded the
format patterns without loading them from a property file.<p>
<span style="font-family:monospace">javac -processor
org.checkerframework.checker.i18nformatter.I18nFormatterChecker MyFile.java</span>

</p></li></ul>
<!--TOC section id="i18n-format-testing" Testing whether a string has an i18n format type-->
<h2 id="i18n-format-testing" class="section">13.7&#XA0;&#XA0;Testing whether a string has an i18n format type <a href="#i18n-format-testing" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>In the case that the checker cannot infer the i18n format type of a string,
you can use the <a href="../api/org/checkerframework/checker/i18nformatter/I18nFormatUtil.html#hasFormat-java.lang.String-org.checkerframework.checker.i18nformatter.qual.I18nConversionCategory...-"><span style="font-family:monospace">I18nFormatUtil.hasFormat</span></a>
method to define the type of the string in the scope of a conditional statement.</p><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/i18nformatter/I18nFormatUtil.html#hasFormat-java.lang.String-org.checkerframework.checker.i18nformatter.qual.I18nConversionCategory...-"><span style="font-weight:bold"><span style="font-family:monospace">I18nFormatUtil.hasFormat</span></span></a></dt><dd class="dd-description">
returns <span style="font-family:monospace">true</span> if the given string has the given i18n format type.</dd></dl><p>For an example, see Section&#XA0;<a href="#i18n-format-examples">13.8</a>.</p>
<!--TOC section id="i18n-format-examples" Examples of using the Internationalization Format Checker-->
<h2 id="i18n-format-examples" class="section">13.8&#XA0;&#XA0;Examples of using the Internationalization Format Checker <a href="#i18n-format-examples" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><ul class="itemize"><li class="li-itemize">
Using <a href="https://docs.oracle.com/javase/8/docs/api/java/text/MessageFormat.html#format-java.lang.String-java.lang.Object...-"><span style="font-family:monospace">MessageFormat.format</span></a>.
<pre class="verbatim">      // suppose the bundle "MyResource" contains:  key1={0, number} {1, date}
      String value = ResourceBundle.getBundle("MyResource").getString("key1");
      MessageFormat.format(value, 3.14, new Date());  // OK
      // error: incompatible types in argument; found String, expected number
      MessageFormat.format(value, "Text", new Date());
</pre></li><li class="li-itemize">Using the
<a href="../api/org/checkerframework/checker/i18nformatter/I18nFormatUtil.html#hasFormat-java.lang.String-org.checkerframework.checker.i18nformatter.qual.I18nConversionCategory...-"><span style="font-family:monospace">I18nFormatUtil.hasFormat</span></a>
method to check whether a format
string has particular conversion categories.
<pre class="verbatim">      void test1(String format) {
        if (I18nFormatUtil.hasFormat(format, I18nConversionCategory.GENERAL,
                                             I18nConversionCategory.NUMBER)) {
          MessageFormat.format(format, "Hello", 3.14);  // OK
          // error: incompatible types in argument; found String, expected number
          MessageFormat.format(format, "Hello", "Bye");
          // error: missing arguments; expected 2 but 1 given
          MessageFormat.format(format, "Bye");
          // error: too many arguments; expected 2 but 3 given
          MessageFormat.format(format, "A String", 3.14, 3.14);
        }
      }
</pre></li><li class="li-itemize">Using <a href="../api/org/checkerframework/checker/i18nformatter/qual/I18nFormatFor.html"><span style="font-family:monospace">@I18nFormatFor</span></a>
to ensure that an argument is a particular type of format string.
<pre class="verbatim">      static void method(@I18nFormatFor("#2") String f, Object... args) {...}

      // OK, MessageFormat.format(...) would return "3.14 Hello greater than one"
      method("{0, number} {1} {2, choice,0#zero|1#one|1&lt;greater than one}",
             3.14, "Hello", 100);

      // error: incompatible types in argument; found String, expected number
      method("{0, number} {1}", "Bye", "Bye");
</pre></li><li class="li-itemize">Annotating a string with
<a href="../api/org/checkerframework/checker/i18nformatter/qual/I18nFormat.html"><span style="font-family:monospace">@I18nFormat</span></a>.
<pre class="verbatim">      @I18nFormat({I18nConversionCategory.DATE}) String;
      s1 = "{0}";
      s1 = "{0, number}";        // error: incompatible types in assignment
</pre></li></ul><hr>
<!--TOC chapter id="propkey-checker" Property File Checker-->
<h1 id="propkey-checker" class="chapter">Chapter&#XA0;14&#XA0;&#XA0;Property File Checker <a href="#propkey-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h1><!--SEC END --><p>The Property File Checker ensures that a property file or resource bundle (both
of which act like maps from keys to values) is only accessed with valid keys.
Accesses without a valid key either return <span style="font-family:monospace">null</span> or a default value, which
can lead to a <span style="font-family:monospace">NullPointerException</span> or hard-to-trace behavior.
The Property File Checker (Section <a href="#genpropkey-checker">14.1</a>) ensures
that the used keys are found in the corresponding property file or resource
bundle.</p><p>We also provide two specialized checkers.
An Internationalization Checker (Section <a href="#i18n-checker">14.2</a>)
verifies that code is properly internationalized.
A Compiler Message Key Checker (Section <a href="#compilermsgs-checker">14.3</a>)
verifies that compiler message keys used in the Checker Framework are
declared in a property file.
This is an example of a simple specialization of the property
file checker, and the Checker Framework source code shows how it is used.</p><p>It is easy to customize the property key checker for other related purposes.
Take a look at the source code of the Compiler Message Key Checker and adapt it for
your purposes.</p>
<!--TOC section id="genpropkey-checker" General Property File Checker-->
<h2 id="genpropkey-checker" class="section">14.1&#XA0;&#XA0;General Property File Checker <a href="#genpropkey-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The general Property File Checker ensures that a resource key is located
in a specified property file or resource bundle.</p><p>The annotation <a href="../api/org/checkerframework/checker/propkey/qual/PropertyKey.html"><span style="font-family:monospace">@PropertyKey</span></a>
indicates that the qualified <span style="font-family:monospace">CharSequence</span> is a valid key
found in the property file or resource bundle.
You do not need to annotate <span style="font-family:monospace">String</span> literals.
The checker looks up every <span style="font-family:monospace">String</span> literal in the specified
property file or resource bundle, and adds annotations as appropriate.</p><p>If you pass a <span style="font-family:monospace">CharSequence</span> (including <span style="font-family:monospace">String</span>) variable to be
eventually used as a key, you
also need to annotate all these variables with <span style="font-family:monospace">@PropertyKey</span>.</p><p>The checker can be invoked by running the following
command:</p><pre class="verbatim">  javac -processor org.checkerframework.checker.propkey.PropertyKeyChecker
        -Abundlenames=MyResource MyFile.java ...
</pre><p>You must specify the resources, which map keys to strings.
The checker supports two types of resource:
resource bundles and property files. You can specify one or both of the
following two command-line options:</p><ol class="enumerate" type=1><li class="li-enumerate"><span style="font-family:monospace">-Abundlenames=</span><span style="font-family:monospace"><em>resource_name</em></span><p><em>resource_name</em> is the name of the resource to be used with
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/ResourceBundle.html#getBundle-java.lang.String-java.util.Locale-java.lang.ClassLoader-"><span style="font-family:monospace">ResourceBundle.getBundle()</span></a>.
The checker uses the default <span style="font-family:monospace">Locale</span> and <span style="font-family:monospace">ClassLoader</span> in the
compilation system.
(For a tutorial about <span style="font-family:monospace">ResourceBundle</span>s, see
<a href="https://docs.oracle.com/javase/tutorial/i18n/resbundle/concept.html"><span style="font-family:monospace">https://docs.oracle.com/javase/tutorial/i18n/resbundle/concept.html</span></a>.)
Multiple resource bundle names are separated by colons &#X2019;<span style="font-family:monospace">:</span>&#X2019;.</p></li><li class="li-enumerate"><span style="font-family:monospace">-Apropfiles=</span><span style="font-family:monospace"><em>prop_file</em></span><p><em>prop_file</em> is the name of a properties file that maps
keys to values. The file format is described in
the Javadoc for
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Properties.html#load-java.io.Reader-"><span style="font-family:monospace">Properties.load()</span></a>.
Multiple files are separated by colons &#X2019;<span style="font-family:monospace">:</span>&#X2019;.</p></li></ol>
<!--TOC section id="i18n-checker" Internationalization Checker (I18n Checker)-->
<h2 id="i18n-checker" class="section">14.2&#XA0;&#XA0;Internationalization Checker (I18n Checker) <a href="#i18n-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The Internationalization Checker, or I18n Checker, verifies that your code is properly
internationalized. Internationalization is the process of designing software so that
it can be adapted to different languages and locales without needing to change the code.
Localization is the process of adapting internationalized software to specific languages
and locales.</p><p>Internationalization is sometimes called i18n, because the word starts with &#X201C;i&#X201D;,
ends with &#X201C;n&#X201D;, and has 18 characters in between. Localization is similarly
sometimes abbreviated as l10n.</p><p>The checker focuses on one aspect of internationalization: user-visible text
should be presented in the user&#X2019;s own language, such as English, French, or
German. This is achieved by looking up keys in a localization resource,
which maps keys to user-visible text. For instance, one version of a
resource might map <span style="font-family:monospace">"CANCEL_STRING"</span> to
<span style="font-family:monospace">"Cancel"</span>, and another version of the same resource might map
<span style="font-family:monospace">"CANCEL_STRING"</span> to <span style="font-family:monospace">"Abbrechen"</span>.</p><p>There are other aspects to localization, such as formatting of dates (3/5
vs.&#XA0;5/3 for March 5), that the checker does not check.</p><p>The Internationalization Checker verifies these two properties:</p><ol class="enumerate" type=1><li class="li-enumerate">Any user-visible text should be obtained from a localization resource.
For example, <span style="font-family:monospace">String</span> literals should not be output to the user.</li><li class="li-enumerate">When looking up keys in a localization resource, the key should exist in
that resource. This check catches incorrect or misspelled localization
keys.</li></ol><p>If you use the Internationalization Checker, you may want to also use the
Internationalization Format String Checker, or I18n Format String Checker
(Chapter&#XA0;<a href="#i18n-formatter-checker">13</a>).
It verifies that internationalization format strings are well-formed and
used with arguments of the proper type, so that
<a href="https://docs.oracle.com/javase/8/docs/api/java/text/MessageFormat.html#format-java.lang.String-java.lang.Object...-"><span style="font-family:monospace">MessageFormat.format</span></a>
does not fail at run time.</p>
<!--TOC subsection id="i18n-annotations" Internationalization annotations-->
<h3 id="i18n-annotations" class="subsection">14.2.1&#XA0;&#XA0;Internationalization annotations <a href="#i18n-annotations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The Internationalization Checker supports two annotations:</p><ol class="enumerate" type=1><li class="li-enumerate">
<a href="../api/org/checkerframework/checker/i18n/qual/Localized.html"><span style="font-family:monospace">@Localized</span></a>: indicates that the qualified
<span style="font-family:monospace">CharSequence</span> is a message that has been localized and/or formatted with
respect to the used locale.</li><li class="li-enumerate"><a href="../api/org/checkerframework/checker/i18n/qual/LocalizableKey.html"><span style="font-family:monospace">@LocalizableKey</span></a>: indicates that the
qualified <span style="font-family:monospace">CharSequence</span> or <span style="font-family:monospace">Object</span> is a valid key found in the
localization resource.
This annotation is a specialization of the <span style="font-family:monospace">@PropertyKey</span> annotation, that
gets checked by the general Property Key Checker.
</li></ol><p>You may need to add the <span style="font-family:monospace">@Localized</span> annotation to more methods in the
JDK or other libraries, or in your own code.</p>
<!--TOC subsection id="i18n-running" Running the Internationalization Checker-->
<h3 id="i18n-running" class="subsection">14.2.2&#XA0;&#XA0;Running the Internationalization Checker <a href="#i18n-running" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The Internationalization Checker can be invoked by running the following
command:</p><pre class="verbatim">  javac -processor org.checkerframework.checker.i18n.I18nChecker -Abundlenames=MyResource MyFile.java ...
</pre><p>You must specify the localization resource, which maps keys to user-visible
text. Like the general Property Key Checker, the Internationalization Checker
supports two types of localization resource:
<span style="font-family:monospace">ResourceBundle</span>s using the
<span style="font-family:monospace">-Abundlenames=</span><span style="font-family:monospace"><em>resource_name</em></span> option
or property files using the
<span style="font-family:monospace">-Apropfiles=</span><span style="font-family:monospace"><em>prop_file</em></span> option.</p>
<!--TOC section id="compilermsgs-checker" Compiler Message Key Checker-->
<h2 id="compilermsgs-checker" class="section">14.3&#XA0;&#XA0;Compiler Message Key Checker <a href="#compilermsgs-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The Checker Framework uses compiler message keys to output error messages.
These keys are substituted by localized strings for user-visible error messages.
Using keys instead of the localized strings in the source code enables easier
testing, as the expected error keys can stay unchanged while the localized
strings can still be modified.
We use the Compiler Message Key Checker to ensure that all internal
keys are correctly localized.
Instead of using the Property File Checker, we use a specialized checker,
giving us more precise documentation of the intended use of <span style="font-family:monospace">String</span>s.</p><p>The single annotation used by this checker is
<a href="../api/org/checkerframework/checker/compilermsgs/qual/CompilerMessageKey.html"><span style="font-family:monospace">@CompilerMessageKey</span></a>.
The Checker Framework is completely annotated;
for example, class <span style="font-family:monospace">org.checkerframework.framework.source.Result</span>
uses <span style="font-family:monospace">@CompilerMessageKey</span> in methods <span style="font-family:monospace">failure</span> and <span style="font-family:monospace">warning</span>.
For most users of the Checker Framework there will be no need to annotate any
<span style="font-family:monospace">String</span>s, as the checker looks up all <span style="font-family:monospace">String</span> literals and adds
annotations as appropriate.</p><p>The Compiler Message Key Checker can be invoked by running the following
command:</p><pre class="verbatim">  javac -processor org.checkerframework.checker.compilermsgs.CompilerMessagesChecker
        -Apropfiles=messages.properties MyFile.java ...
</pre><p>You must specify the resource, which maps compiler message keys to user-visible
text. The checker supports the same options as the general property key checker.
Within the Checker Framework we only use property files,
so the <span style="font-family:monospace">-Apropfiles=</span><span style="font-family:monospace"><em>prop_file</em></span> option should be used.</p><hr>
<!--TOC chapter id="signature-checker" Signature String Checker for string representations of types-->
<h1 id="signature-checker" class="chapter">Chapter&#XA0;15&#XA0;&#XA0;Signature String Checker for string representations of types <a href="#signature-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h1><!--SEC END --><p>The Signature String Checker, or Signature Checker for short, verifies that
string representations of types and signatures are used correctly.</p><p>Java defines multiple different string representations for types (see
Section&#XA0;<a href="#signature-annotations">15.1</a>), and it is easy to
misuse them or to miss bugs during testing. Using the wrong string format
leads to a run-time exception or an incorrect result. This is a particular
problem for fully qualified and binary names, which are nearly the same &#X2014;
they differ only for nested classes and arrays.</p>
<!--TOC section id="signature-annotations" Signature annotations-->
<h2 id="signature-annotations" class="section">15.1&#XA0;&#XA0;Signature annotations <a href="#signature-annotations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>Java defines six formats for the string representation of a type.
There is an annotation for each of these representations.
Figure&#XA0;<a href="#fig-signature-hierarchy">15.1</a> shows how they are related;
examples appear in a table below.</p><blockquote class="figure"><div class="center"><hr style="width:80%;height:2"></div>
<div class="center">
<img src="signature-types.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 15.1: Partial type hierarchy for the Signature type system, showing
string representations of a Java type.
The type qualifiers are applicable to <span style="font-family:monospace">CharSequence</span> and its subtypes.
Programmers only need to write
the boldfaced qualifiers; other qualifiers are
included to improve the internal handling of String literals.</td></tr>
</table></div>
<a id="fig-signature-hierarchy"></a>
<div class="center"><hr style="width:80%;height:2"></div></blockquote><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/signature/qual/FullyQualifiedName.html"><span style="font-weight:bold"><span style="font-family:monospace">@FullyQualifiedName</span></span></a></dt><dd class="dd-description">
A <em>fully qualified name</em> (<a href="https://docs.oracle.com/javase/specs/jls/se10/html/jls-6.html#jls-6.7">JLS &#XA7;6.7</a>), such as
<span style="font-family:monospace">package.Outer.Inner</span>, is used in Java code and in messages to
the user.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/signature/qual/ClassGetName.html"><span style="font-weight:bold"><span style="font-family:monospace">@ClassGetName</span></span></a></dt><dd class="dd-description">

The type representation used by the
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Class.html#getName--"><span style="font-family:monospace">Class.getName()</span></a>, <span style="font-family:monospace">Class.forName(String)</span>,
and <span style="font-family:monospace">Class.forName(String, boolean, ClassLoader)</span> methods. This format
is: for any non-array type, the binary name; and for any array type, a
format like the
<a href="https://docs.oracle.com/javase/specs/jvms/se10/html/jvms-4.html#jvms-4.3.2">FieldDescriptor
field descriptor</a>, but using
&#X201C;<span style="font-family:monospace">.</span>&#X201D;&#XA0;where the field descriptor uses &#X201C;<span style="font-family:monospace">/</span>&#X201D;. See examples below.
</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/signature/qual/FieldDescriptor.html"><span style="font-weight:bold"><span style="font-family:monospace">@FieldDescriptor</span></span></a></dt><dd class="dd-description">
A <em>field descriptor</em> (<a href="https://docs.oracle.com/javase/specs/jvms/se10/html/jvms-4.html#jvms-4.3.2">JVMS &#XA7;4.3.2</a>), such as
<span style="font-family:monospace">Lpackage/Outer$Inner;</span>, is used in a <span style="font-family:monospace">.class</span> file&#X2019;s constant pool,
for example to refer to other types. It abbreviates primitive types and
array types. It uses internal form (binary names, but with <span style="font-family:monospace">/</span> instead of
<span style="font-family:monospace">.</span>; see
<a href="https://docs.oracle.com/javase/specs/jvms/se10/html/jvms-4.html#jvms-4.2.1">JVMS
&#XA7;4.2</a>) for class names. See examples below.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/signature/qual/BinaryName.html"><span style="font-weight:bold"><span style="font-family:monospace">@BinaryName</span></span></a></dt><dd class="dd-description">
A <em>binary name</em> (<a href="https://docs.oracle.com/javase/specs/jls/se10/html/jls-13.html#jls-13.1">JLS &#XA7;13.1</a>), such as
<span style="font-family:monospace">package.Outer$Inner</span>, is
the conceptual name of a type in its own <span style="font-family:monospace">.class</span> file.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/signature/qual/InternalForm.html"><span style="font-weight:bold"><span style="font-family:monospace">@InternalForm</span></span></a></dt><dd class="dd-description">
The <em>internal form</em>
(<a href="https://docs.oracle.com/javase/specs/jvms/se10/html/jvms-4.html#jvms-4.2">JVMS
&#XA7;4.2</a>), such as <span style="font-family:monospace">package/Outer$Inner</span>, is how a class name is
actually represented in its own <span style="font-family:monospace">.class</span> file. It is also known as the
&#X201C;syntax of binary names that appear in class file structures&#X201D;. It is
the same as the binary name, but with periods (<span style="font-family:monospace">.</span>) replaced by slashes
(<span style="font-family:monospace">/</span>). Programmers more often use the binary name, leaving the internal
form as a JVM implementation detail.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/signature/qual/ClassGetSimpleName.html"><span style="font-weight:bold"><span style="font-family:monospace">@ClassGetSimpleName</span></span></a></dt><dd class="dd-description">
The type representation returned by the
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Class.html#getSimpleName--"><span style="font-family:monospace">Class.getSimpleName()</span></a>
method. This format is not required by any method in the JDK, so you
will rarely write it in source code. The string can be empty. This
is not the same as the &#X201C;simple name&#X201D; defined in
(<a href="https://docs.oracle.com/javase/specs/jls/se10/html/jls-6.html#jls-6.2">JLS
&#XA7;6.2</a>), which is the same as
<a href="../api/org/checkerframework/checker/signature/qual/Identifier.html"><span style="font-family:monospace">@Identifier</span></a>.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/signature/qual/FqBinaryName.html"><span style="font-weight:bold"><span style="font-family:monospace">@FqBinaryName</span></span></a></dt><dd class="dd-description">
Like <a href="../api/org/checkerframework/checker/signature/qual/FullyQualifiedName.html"><span style="font-family:monospace">@FullyQualifiedName</span></a>, but using
&#X201C;<span style="font-family:monospace">$</span>&#X201D; instead of &#X201C;<span style="font-family:monospace">.</span>&#X201D; to separate nested classes from their
containing classes. For example, <span style="font-family:monospace">"pkg.Outer$Inner"</span>.</dd></dl><p>Other type qualifiers are the intersection of two or more qualifiers listed
above; for example, a
<a href="../api/org/checkerframework/checker/signature/qual/BinaryNameInUnnamedPackage.html"><span style="font-family:monospace">@BinaryNameInUnnamedPackage</span></a> is a string
that is a valid internal form <em>and</em> a valid binary name. A
programmer should never or rarely use these qualifiers, and you can ignore
them as implementation details of the Signature Checker, though you might
occasionally see them in an error message. These qualifiers exist to give
literals sufficiently precise types that they can be used in any
appropriate context.</p><p>Java also defines other string formats for a type: qualified names
(<a href="https://docs.oracle.com/javase/specs/jls/se10/html/jls-6.html#jls-6.2">JLS
&#XA7;6.2</a>) and canonical names
(<a href="https://docs.oracle.com/javase/specs/jls/se10/html/jls-6.html#jls-6.7">JLS
&#XA7;6.7</a>). The Signature Checker does not include annotations for these.</p><p>Here are examples of the supported formats:
<a id="signature-annotations-examples"></a></p><div class="center"><span style="font-size:small">
</span><table border=1  style="border-spacing:0;" class="cellpadding1"><tr><td style="text-align:center;border:solid 1px;white-space:nowrap" ><span style="font-size:small">fully qualified name</span></td><td style="text-align:center;border:solid 1px;white-space:nowrap" ><span style="font-size:small">Class.getName</span></td><td style="text-align:center;border:solid 1px;white-space:nowrap" ><span style="font-size:small">field descriptor</span></td><td style="text-align:center;border:solid 1px;white-space:nowrap" ><span style="font-size:small">binary name</span></td><td style="text-align:center;border:solid 1px;white-space:nowrap" ><span style="font-size:small">internal form</span></td><td style="text-align:center;border:solid 1px;white-space:nowrap" ><span style="font-size:small">Class.getSimpleName</span><span style="font-size:small"> </span></td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">int</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">int</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">I</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"><em>n/a </em></span><span style="font-size:small"><em>for primitive type</em></span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"><em>n/a </em></span><span style="font-size:small"><em>for primitive type</em></span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">int </span></td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">int[][]</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">[[I</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">[[I</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"><em>n/a </em></span><span style="font-size:small"><em>for array type</em></span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"><em>n/a </em></span><span style="font-size:small"><em>for array type</em></span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">int[][] </span></td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">MyClass</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">MyClass</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">LMyClass;</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">MyClass</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">MyClass</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">MyClass </span></td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">MyClass[]</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">[LMyClass;</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">[LMyClass;</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"><em>n/a </em></span><span style="font-size:small"><em>for array type</em></span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"><em>n/a </em></span><span style="font-size:small"><em>for array type</em></span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">MyClass[] </span></td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"><em>n/a </em></span><span style="font-size:small"><em>for anonymous class</em></span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">MyClass$22</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">LMyClass$22;</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">MyClass$22</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">MyClass$22</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"><em>(empty string)</em></span></td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"><em>n/a </em></span><span style="font-size:small"><em>for array of anon.&#XA0;class</em></span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">[LMyClass$22;</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">[LMyClass$22;</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"><em>n/a </em></span><span style="font-size:small"><em>for array type</em></span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"><em>n/a </em></span><span style="font-size:small"><em>for array type</em></span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">[] </span></td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">java.lang.Integer</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">java.lang.Integer</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">Ljava/lang/Integer;</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">java.lang.Integer</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">java/lang/Integer</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">Integer </span></td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">java.lang.Integer[]</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">[Ljava.lang.Integer;</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">[Ljava/lang/Integer;</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"><em>n/a </em></span><span style="font-size:small"><em>for array type</em></span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"><em>n/a </em></span><span style="font-size:small"><em>for array type</em></span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">Integer[] </span></td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">pkg.Outer.Inner</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">pkg.Outer$Inner</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">Lpkg/Outer$Inner;</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">pkg.Outer$Inner</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">pkg/Outer$Inner</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">Inner </span></td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">pkg.Outer.Inner[]</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">[Lpkg.Outer$Inner;</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">[Lpkg/Outer$Inner;</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"><em>n/a </em></span><span style="font-size:small"><em>for array type</em></span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"><em>n/a </em></span><span style="font-size:small"><em>for array type</em></span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">Inner[] </span></td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"><em>n/a </em></span><span style="font-size:small"><em>for anonymous class</em></span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">pkg.Outer$22</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">Lpkg/Outer$22;</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">pkg.Outer$22</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">pkg/Outer$22</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"><em>(empty string)</em></span></td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"><em>n/a </em></span><span style="font-size:small"><em>for array of anon.&#XA0;class</em></span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">[Lpkg.Outer$22;</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">[Lpkg/Outer$22;</span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"><em>n/a </em></span><span style="font-size:small"><em>for array type</em></span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small"><em>n/a </em></span><span style="font-size:small"><em>for array type</em></span></td><td style="text-align:left;border:solid 1px;white-space:nowrap" ><span style="font-size:small">[] </span></td></tr>
</table><span style="font-size:small">
</span></div><p>Java defines one format for the string representation of a method signature:</p><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/signature/qual/MethodDescriptor.html"><span style="font-weight:bold"><span style="font-family:monospace">@MethodDescriptor</span></span></a></dt><dd class="dd-description">
A <em>method descriptor</em> (<a href="https://docs.oracle.com/javase/specs/jvms/se10/html/jvms-4.html#jvms-4.3.3">JVMS &#XA7;4.3.3</a>) identifies a method&#X2019;s signature (its parameter and return
types), just as a field descriptor identifies a
type. The method descriptor for the method
<pre class="verbatim">    Object mymethod(int i, double d, Thread t)
</pre>is
<pre class="verbatim">    (IDLjava/lang/Thread;)Ljava/lang/Object;
</pre></dd></dl>
<!--TOC section id="signature-checks" What the Signature Checker checks-->
<h2 id="signature-checks" class="section">15.2&#XA0;&#XA0;What the Signature Checker checks <a href="#signature-checks" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>Certain methods in the JDK, such as <span style="font-family:monospace">Class.forName</span>, are annotated
indicating the type they require. The Signature Checker ensures that
clients call them with the proper arguments. The Signature Checker does
not reason about string operations such as concatenation, substring,
parsing, etc.</p><p>
To run the Signature Checker, supply the
<span style="font-family:monospace">-processor org.checkerframework.checker.signature.SignatureChecker</span>
command-line option to javac.
</p><hr>
<!--TOC chapter id="guieffect-checker" GUI Effect Checker-->
<h1 id="guieffect-checker" class="chapter">Chapter&#XA0;16&#XA0;&#XA0;GUI Effect Checker <a href="#guieffect-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h1><!--SEC END --><p>One of the most prevalent GUI-related bugs is <em>invalid UI update</em> or <em>invalid thread access</em>: accessing the UI directly from a
background thread.</p><p>Most GUI frameworks (including Android, AWT, Swing, and SWT) create
a single distinguished thread &#X2014; the UI event thread
&#X2014; that handles all GUI events and updates.
To keep the interface responsive, any expensive computation should be
offloaded to <em>background threads</em> (also called <em>worker threads</em>).
If a background thread accesses a UI
element such as a JPanel (by calling a JPanel method or reading/writing a
field of JPanel),
the GUI framework raises an exception that terminates the program.
To fix the bug, the background thread should send a request to the
UI thread to perform the access on its behalf.</p><p>It is difficult for a programmer to remember which methods may be called on
which thread(s).
The GUI Effect Checker solves this problem.
The programmer annotates each method to indicate whether:
</p><ul class="itemize"><li class="li-itemize">
It accesses no UI elements (and may run on any thread);
such a method is said to have the &#X201C;safe effect&#X201D;.
</li><li class="li-itemize">It may access UI elements (and must run on the UI thread);
such a method is said to have the &#X201C;UI effect&#X201D;.
</li></ul><p>The GUI Effect Checker verifies these effects and statically enforces that UI methods are only
called from the correct thread. A method with the safe effect is prohibited from calling a method
with the UI effect.
</p><p>For example, the effect system can reason about when method calls must be dispatched to the UI
thread via a message such as <span style="font-family:monospace">Display.syncExec</span>.
</p><pre>
@SafeEffect
public void calledFromBackgroundThreads(JLabel l) {
    l.setText("Foo");       // Error: calling a @UIEffect method from a @SafeEffect method
    Display.syncExec(new Runnable {
        @UIEffect // inferred by default
        public void run() {
            l.setText("Bar");  // OK: accessing JLabel from code run on the UI thread
        }
    });

}
</pre><p>The GUI Effect Checker&#X2019;s annotations fall into three categories:</p><ul class="itemize"><li class="li-itemize">
effect annotations on methods (Section&#XA0;<a href="#guieffect-annotations">16.1</a>),
</li><li class="li-itemize">class or package annotations controlling the default effect (Section&#XA0;<a href="#guieffect-defaults">16.4</a>), and
</li><li class="li-itemize"><em>effect-polymorphism</em>: code that works for both the safe effect and
the UI effect (Section&#XA0;<a href="#guieffect-polymorphism">16.5</a>).
</li></ul>
<!--TOC section id="guieffect-annotations" GUI effect annotations-->
<h2 id="guieffect-annotations" class="section">16.1&#XA0;&#XA0;GUI effect annotations <a href="#guieffect-annotations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>There are two primary GUI effect annotations:
</p><ul class="itemize"><li class="li-itemize">
<a href="../api/org/checkerframework/checker/guieffect/qual/SafeEffect.html"><span style="font-family:monospace">@SafeEffect</span></a>
is a method annotation marking code that must not
access UI objects.
</li><li class="li-itemize"><a href="../api/org/checkerframework/checker/guieffect/qual/UIEffect.html"><span style="font-family:monospace">@UIEffect</span></a>
is a method annotation marking code that may access
UI objects. Most UI object methods (e.g., methods of <span style="font-family:monospace">JPanel</span>) are
annotated as <span style="font-family:monospace">@UIEffect</span>.
</li></ul><p><span style="font-family:monospace">@SafeEffect</span> is a sub-effect of <span style="font-family:monospace">@UIEffect</span>, in that it is always safe to
call a <span style="font-family:monospace">@SafeEffect</span> method anywhere it is permitted to call a
<span style="font-family:monospace">@UIEffect</span> method. We write this relationship as</p><div class="center"><span style="font-family:monospace">@SafeEffect</span> &#X227A; <span style="font-family:monospace">@UIEffect</span></div>
<!--TOC section id="guieffect-checks" What the GUI Effect Checker checks-->
<h2 id="guieffect-checks" class="section">16.2&#XA0;&#XA0;What the GUI Effect Checker checks <a href="#guieffect-checks" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The GUI Effect Checker ensures that only the UI thread accesses UI objects.
This prevents GUI errors such
as invalid UI update and invalid thread access.</p><p>The GUI Effect Checker issues errors in the following cases:</p><ul class="itemize"><li class="li-itemize">
A <span style="font-family:monospace">@UIEffect</span> method is invoked by a <span style="font-family:monospace">@SafeEffect</span> method.</li><li class="li-itemize">Method declarations violate subtyping restrictions: a supertype declares
a <span style="font-family:monospace">@SafeEffect</span> method, and a subtype annotates an overriding
version as <span style="font-family:monospace">@UIEffect</span>.</li></ul><p>Additionally, if a method implements or overrides a method in two
supertypes (two interfaces, or an interface and parent class), and those
supertypes give different effects for the methods, the GUI Effect Checker
issues a warning (not an error).</p>
<!--TOC section id="guieffect-running" Running the GUI Effect Checker-->
<h2 id="guieffect-running" class="section">16.3&#XA0;&#XA0;Running the GUI Effect Checker <a href="#guieffect-running" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The GUI Effect Checker can be invoked by running the following command:
</p><pre class="verbatim">  javac -processor org.checkerframework.checker.guieffect.GuiEffectChecker MyFile.java ...
</pre>
<!--TOC section id="guieffect-defaults" Annotation defaults-->
<h2 id="guieffect-defaults" class="section">16.4&#XA0;&#XA0;Annotation defaults <a href="#guieffect-defaults" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The default method annotation is <span style="font-family:monospace">@SafeEffect</span>, since most code in most programs is not related
to the UI. This also means that typically, code that is unrelated to the UI need not be annotated
at all.</p><p>The GUI Effect Checker provides three primary ways to change the default method effect for a class
or package:
</p><ul class="itemize"><li class="li-itemize">
<a href="../api/org/checkerframework/checker/guieffect/qual/UIType.html"><span style="font-family:monospace">@UIType</span></a>
is a class annotation that makes the effect for unannotated methods in that
class default to
<span style="font-family:monospace">@UIEffect</span>. (See also <span style="font-family:monospace">@UI</span> in Section&#XA0;<a href="#guieffect-polymorphism-using">16.5.2</a>.)
</li><li class="li-itemize"><a href="../api/org/checkerframework/checker/guieffect/qual/UIPackage.html"><span style="font-family:monospace">@UIPackage</span></a>
is a <em>package</em> annotation, that makes the effect for unannotated
methods in that package default to <span style="font-family:monospace">@UIEffect</span>. It is not transitive; a package nested inside
a package marked <span style="font-family:monospace">@UIPackage</span> does not inherit the changed default.
</li><li class="li-itemize"><a href="../api/org/checkerframework/checker/guieffect/qual/SafeType.html"><span style="font-family:monospace">@SafeType</span></a> is a class annotation that makes the effect for unannotated methods in that
class default to <span style="font-family:monospace">@SafeEffect</span>. Because <span style="font-family:monospace">@SafeEffect</span> is already the default
effect, <span style="font-family:monospace">@SafeType</span> is only useful for class types inside a package marked <span style="font-family:monospace">@UIPackage</span>.
</li></ul><p>There is one other place where the default annotation is not automatically <span style="font-family:monospace">@SafeEffect</span>:
anonymous inner classes. Since anonymous inner classes exist primarily for brevity, it would be
unfortunate to spoil that brevity with extra annotations. By default, an anonymous inner class
method that overrides or implements a method of the parent type inherits that method&#X2019;s effect.
For example, an anonymous inner class implementing an interface with method <span style="font-family:monospace">@UIEffect void
m()</span> need not explicitly annotate its implementation of <span style="font-family:monospace">m()</span>; the implementation will inherit
the parent&#X2019;s effect. Methods of the anonymous inner class that are not inherited from a parent type
follow the standard defaulting rules.</p>
<!--TOC section id="guieffect-polymorphism" Polymorphic effects-->
<h2 id="guieffect-polymorphism" class="section">16.5&#XA0;&#XA0;Polymorphic effects <a href="#guieffect-polymorphism" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>Sometimes a type is reused for both UI-specific and background-thread work. A good example is the
<span style="font-family:monospace">Runnable</span> interface, which is used both for creating new background threads (in which case the
<span style="font-family:monospace">run()</span> method must have the <span style="font-family:monospace">@SafeEffect</span>) and for sending code to the UI thread to
execute (in which case the <span style="font-family:monospace">run()</span> method may have the
<span style="font-family:monospace">@UIEffect</span>). But the declaration of
<span style="font-family:monospace">Runnable.run()</span> may have only one effect annotation in the source code.
How do we reconcile these
conflicting use cases?</p><p><em>Effect-polymorphism</em> permits a type to be used for both UI and non-UI
purposes. It is similar to Java&#X2019;s generics in that you define, then use, the
effect-polymorphic type.
Recall that to <em>define</em> a generic type, you write a type parameter such as
<span style="font-family:monospace">&lt;T&gt;</span> and use it in the body of the type definition; for example,
<span style="font-family:monospace">class List&lt;T&gt; </span><span style="font-family:monospace">{</span><span style="font-family:monospace"> ...  T get() </span><span style="font-family:monospace">{</span><span style="font-family:monospace">...</span><span style="font-family:monospace">}</span><span style="font-family:monospace">  ...  </span><span style="font-family:monospace">}</span>.
To <em>instantiate</em> a generic type, you write its name along with a type
argument; for example, <span style="font-family:monospace">List&lt;Date&gt; myDates;</span>.</p>
<!--TOC subsection id="guieffect-polymorphism-defining" Defining an effect-polymorphic type-->
<h3 id="guieffect-polymorphism-defining" class="subsection">16.5.1&#XA0;&#XA0;Defining an effect-polymorphic type <a href="#guieffect-polymorphism-defining" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>To declare that a class is effect-polymorphic, annotate its definition with
<a href="../api/org/checkerframework/checker/guieffect/qual/PolyUIType.html"><span style="font-family:monospace">@PolyUIType</span></a>.
To use the effect variable in the class body, annotate a method with <a href="../api/org/checkerframework/checker/guieffect/qual/PolyUIEffect.html"><span style="font-family:monospace">@PolyUIEffect</span></a>.
It is an error to use <span style="font-family:monospace">@PolyUIEffect</span> in a class that is not
effect-polymorphic.</p><p>Consider the following example:</p><pre>
@PolyUIType
public interface Runnable {
    @PolyUIEffect
    void run();
}
</pre><p>This declares that class <span style="font-family:monospace">Runnable</span> is parameterized over one
generic effect, and that when <span style="font-family:monospace">Runnable</span> is instantiated, the effect
argument will be used as the effect for the <span style="font-family:monospace">run</span> method.</p>
<!--TOC subsection id="guieffect-polymorphism-using" Using an effect-polymorphic type-->
<h3 id="guieffect-polymorphism-using" class="subsection">16.5.2&#XA0;&#XA0;Using an effect-polymorphic type <a href="#guieffect-polymorphism-using" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>To instantiate an effect-polymorphic type, write one of these three type
qualifiers before a use of the type:
</p><ul class="itemize"><li class="li-itemize">
<a href="../api/org/checkerframework/checker/guieffect/qual/AlwaysSafe.html"><span style="font-family:monospace">@AlwaysSafe</span></a>
instantiates the type&#X2019;s effect to <span style="font-family:monospace">@SafeEffect</span>.
</li><li class="li-itemize"><a href="../api/org/checkerframework/checker/guieffect/qual/UI.html"><span style="font-family:monospace">@UI</span></a>
instantiates the type&#X2019;s effect to <span style="font-family:monospace">@UIEffect</span>.
<em>Additionally</em>, it changes the
default method effect for the class to <span style="font-family:monospace">@UIEffect</span>.
</li><li class="li-itemize"><a href="../api/org/checkerframework/checker/guieffect/qual/PolyUI.html"><span style="font-family:monospace">@PolyUI</span></a> instantiates the type&#X2019;s
effect to <span style="font-family:monospace">@PolyUIEffect</span> for the same instantiation as the current
(containing) class. For example, this is the qualifier of the receiver
<span style="font-family:monospace">this</span> inside a method of a <span style="font-family:monospace">@PolyUIType</span> class, which is how
one method of an effect-polymorphic class may call an effect-polymorphic
method of the same class.
</li></ul><p>As an example:</p><pre>
@AlwaysSafe Runnable s = ...;    s.run();    // s.run() is @SafeEffect
@PolyUI Runnable p = ...;        p.run();    // p.run() is @PolyUIEffect (context-dependent)
@UI Runnable u = ...;            u.run();    // u.run() is @UIEffect
</pre><p>It is an error to apply an effect instantiation qualifier to a type that is not effect-polymorphic.</p><p>Note that no annotation is required on the anonymous class declaration itself (e.g. <span style="font-family:monospace">new Runnable(){...}</span>
does not require a type use annotation, although the variable, field, or argument it ends up being assigned to might).
Instead, the GUI Effect Checker will infer the effect qualifier based on the method being called from within the
members of that specific anonymous class.</p>
<!--TOC subsection id="guieffect-subclassing" Subclassing a specific instantiation of an effect-polymorphic type-->
<h3 id="guieffect-subclassing" class="subsection">16.5.3&#XA0;&#XA0;Subclassing a specific instantiation of an effect-polymorphic type <a href="#guieffect-subclassing" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Sometimes you may wish to subclass a specific instantiation of an effect-polymorphic type, just as
you may extend <span style="font-family:monospace">List&lt;String&gt;</span>.</p><p>To do this, simply place the effect instantiation qualifier by the name of the type you are
defining, e.g.:</p><pre>
@UI
public class UIRunnable extends Runnable {...}
@AlwaysSafe
public class SafeRunnable extends Runnable {...}
</pre><p>
The GUI Effect Checker will automatically apply the qualifier to all classes and interfaces the class
being defined extends or implements. (This means you cannot write a class that is a subtype of a
<span style="font-family:monospace">@AlwaysSafe Foo</span> and a <span style="font-family:monospace">@UI Bar</span>, but this has not been a problem in our experience.)</p>
<!--TOC subsection id="guieffect-subtyping" Subtyping with polymorphic effects-->
<h3 id="guieffect-subtyping" class="subsection">16.5.4&#XA0;&#XA0;Subtyping with polymorphic effects <a href="#guieffect-subtyping" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>With three effect annotations, we must extend the static sub-effecting relationship:</p><div class="center"><span style="font-family:monospace">@SafeEffect</span> &#X227A; <span style="font-family:monospace">@PolyUIEffect</span> &#X227A; <span style="font-family:monospace">@UIEffect</span></div><p>This is the correct sub-effecting relation because it is always safe to
call a <span style="font-family:monospace">@SafeEffect</span>
method (whether from an effect-polymorphic method or a UI method), and a <span style="font-family:monospace">@UIEffect</span> method
may safely call any other method.
</p><p>This induces a subtyping hierarchy on type qualifiers:</p><div class="center"><span style="font-family:monospace">@AlwaysSafe</span> &#X227A; <span style="font-family:monospace">@PolyUI</span> &#X227A; <span style="font-family:monospace">@UI</span></div><p>This is sound because a method instantiated according to any qualifier will always be
safe to call in place of a method instantiated according to one of its super-qualifiers.
This allows clients to pass &#X201C;safer&#X201D; instances of some object type to a given method.</p>
<!--TOC subsubsection id="guieffect-overrides" Effect polymorphism and arguments-->
<h4 id="guieffect-overrides" class="subsubsection">Effect polymorphism and arguments <a href="#guieffect-overrides" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h4><!--SEC END --><p>Sometimes it is useful to have <span style="font-family:monospace">@PolyUI</span> parameters on a method. As a trivial example, this
permits us to specify an identity method that works for both <span style="font-family:monospace">@UI Runnable</span> and
<span style="font-family:monospace">@AlwaysSafe Runnable</span>:</p><pre>
public @PolyUI Runnable id(@PolyUI Runnable r) {
    return r;
}
</pre><p>This use of <span style="font-family:monospace">@PolyUI</span> will be handled as is standard for polymorphic qualifiers in the Checker
Framework (see Section <a href="#qualifier-polymorphism">25.2</a>).</p><p><span style="font-family:monospace">@PolyUIEffect</span> methods should generally not use <span style="font-family:monospace">@PolyUI</span> arguments: it is permitted by
the framework, but its interaction with inheritance is subtle, and may not behave as you would
hope.</p><p>The shortest explanation is this: <span style="font-family:monospace">@PolyUI</span> arguments may only be overridden by <span style="font-family:monospace">@PolyUI</span>
arguments, even though the implicitly <span style="font-family:monospace">@PolyUI</span> <em>receiver</em> may be overridden with a
<span style="font-family:monospace">@AlwaysSafe</span> receiver.</p><p>As noted earlier (Section <a href="#covariant-type-parameters">25.1.6</a>), Java&#X2019;s generics are invariant &#X2014;
<span style="font-family:monospace">A&lt;X&gt;</span> is a subtype of <span style="font-family:monospace">B&lt;Y&gt;</span> only if <span style="font-family:monospace">X</span> is identical to <span style="font-family:monospace">Y</span>.
Class-level use of <span style="font-family:monospace">@PolyUI</span> behaves slightly differently.
Marking a type declaration <span style="font-family:monospace">@PolyUIType</span> is conceptually
equivalent to parameterizing the type by some <span style="font-family:monospace">E extends Effect</span>. But in this view,
<span style="font-family:monospace">Runnable&lt;SafeEffect&gt;</span> (really <span style="font-family:monospace">@AlwaysSafe Runnable</span>) would be considered a subtype of
<span style="font-family:monospace">Runnable&lt;UIEffect&gt;</span> (really <span style="font-family:monospace">@UI Runnable</span>), as explained earlier in this section. Java&#X2019;s
generics do not permit this, which is called <em>covariant</em> subtyping in the effect parameter.
Permitting it for all generics leads to problems where a type system can miss errors. Java solves
this by making all generics invariant, which rejects more programs than strictly necessary, but
leads to an easy-to-explain limitation. For this checker, covariant subtyping of effect parameters
is very important: being able to pass an <span style="font-family:monospace">@AlwaysSafe
Runnable</span> in place of a <span style="font-family:monospace">@UI Runnable</span> is extremely useful. Since we need to allow some
cases for flexibility, but need to reject other cases to avoid missing errors, the distinction is a
bit more subtle for this checker.</p><p>Consider this small example (warning: the following is rejected by the GUI Effect Checker):</p><pre>
@PolyUIType
public interface Dispatcher {
    @PolyUIEffect
    void dispatch(@PolyUI Runnable toRun);
}
@SafeType
public class SafeDispatcher implements Dispatcher {
    @Override
    public void dispatch(@AlwaysSafe Runnable toRun) {
        runOnBackgroundThread(toRun);
    }
}
</pre><p>This may initially seem like harmless code to write, which simply specializes the implicit effect
parameter from <span style="font-family:monospace">Dispatcher</span> in the <span style="font-family:monospace">SafeDispatcher</span> implementation. However, the way
method effect polymorphism is implemented is by implicitly making the receiver of a
<span style="font-family:monospace">@PolyUIEffect</span> method &#X2014; the object on which the method is invoked &#X2014; <span style="font-family:monospace">@PolyUI</span>. So
if the definitions above were permitted, the following client code would be possible:</p><pre>
@AlwaysSafe SafeDispatcher s = ...;
@UI Runnable uitask = ...;
s.dispatch(uitask);
</pre><p>At the call to <span style="font-family:monospace">dispatch</span>, the Checker Framework is free to consider <span style="font-family:monospace">s</span> as its
supertype, <span style="font-family:monospace">@UI SafeDispatcher</span>. This permits the framework to choose the same qualifier for
both the (implicit) receiver use of <span style="font-family:monospace">@PolyUI</span> and the <span style="font-family:monospace">toRun</span> argument to
<span style="font-family:monospace">Dispatcher.dispatch</span>, passing the checker. But this code would then pass a UI-thread-only
task to a method which should only accept background thread tasks &#X2014; exactly what the checker
should prevent!</p><p>To resolve this, the GUI Effect Checker rejects the definitions above, specifically the
<span style="font-family:monospace">@AlwaysSafe</span> on <span style="font-family:monospace">SafeDispatcher.dispatch</span>&#X2019;s parameter, which would need to remain
<span style="font-family:monospace">@PolyUI</span>.</p><p>A subtlety of the code above is that the receiver for <span style="font-family:monospace">SafeDispatcher.dispatch</span> is also
overridden, switching from a <span style="font-family:monospace">@PolyUI</span> receiver to a <span style="font-family:monospace">@Safe</span> receiver. That change is
permissible. But when that is done, the polymorphic arguments may no longer be interchangeable
with the receiver.</p>
<!--TOC section id="guieffect-references" References-->
<h2 id="guieffect-references" class="section">16.6&#XA0;&#XA0;References <a href="#guieffect-references" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The ECOOP 2013 paper &#X201C;JavaUI: Effects for Controlling UI Object Access&#X201D;
includes some case
studies on the checker&#X2019;s efficacy, including descriptions of the relatively few false warnings
we encountered.
It also contains a more formal description of the effect system.
You can obtain the paper at: <br>
 <a href="https://homes.cs.washington.edu/~mernst/pubs/gui-thread-ecoop2013-abstract.html"><span style="font-family:monospace">https://homes.cs.washington.edu/~mernst/pubs/gui-thread-ecoop2013-abstract.html</span></a></p><hr>
<!--TOC chapter id="units-checker" Units Checker-->
<h1 id="units-checker" class="chapter">Chapter&#XA0;17&#XA0;&#XA0;Units Checker <a href="#units-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h1><!--SEC END --><p>For many applications, it is important to use the correct units of
measurement for primitive types. For example, NASA&#X2019;s Mars Climate Orbiter
(cost: $327 million) was lost because of a discrepancy between use
of the metric unit Newtons and the imperial measure Pound-force.</p><p>The <em>Units Checker</em> ensures consistent usage of units.
For example, consider the following code:</p><pre>
@m int meters = 5 * UnitsTools.m;
@s int secs = 2 * UnitsTools.s;
@mPERs int speed = meters / secs;
</pre><p>Due to the annotations <span style="font-family:monospace">@m</span> and <span style="font-family:monospace">@s</span>, the variables <span style="font-family:monospace">meters</span> and <span style="font-family:monospace">secs</span> are guaranteed to contain
only values with meters and seconds as units of measurement.
Utility class <span style="font-family:monospace">UnitsTools</span> provides constants with which
unqualified integer are multiplied to get values of the corresponding unit.
The assignment of an unqualified value to <span style="font-family:monospace">meters</span>, as in
<span style="font-family:monospace">meters = 99</span>, will be flagged as an error by the Units Checker.</p><p>The division <span style="font-family:monospace">meters/secs</span> takes the types of the two operands
into account and determines that the result is of type
meters per second, signified by the <span style="font-family:monospace">@mPERs</span> qualifier.
We provide an extensible framework to define the result of operations
on units.</p>
<!--TOC section id="units-annotations" Units annotations-->
<h2 id="units-annotations" class="section">17.1&#XA0;&#XA0;Units annotations <a href="#units-annotations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The checker currently supports three varieties of units annotations:
kind annotations (<a href="../api/org/checkerframework/checker/units/qual/Length.html"><span style="font-family:monospace">@Length</span></a>,
<a href="../api/org/checkerframework/checker/units/qual/Mass.html"><span style="font-family:monospace">@Mass</span></a>, &#X2026;),
the SI units (<a href="../api/org/checkerframework/checker/units/qual/m.html"><span style="font-family:monospace">@m</span></a>, <a href="../api/org/checkerframework/checker/units/qual/kg.html"><span style="font-family:monospace">@kg</span></a>, &#X2026;), and polymorphic annotations
(<a href="../api/org/checkerframework/checker/units/qual/PolyUnit.html"><span style="font-family:monospace">@PolyUnit</span></a>).</p><p>Kind annotations can be used to declare what the expected unit of
measurement is, without fixing the particular unit used.
For example, one could write a method taking a <span style="font-family:monospace">@Length</span> value,
without specifying whether it will take meters or kilometers.
The following kind annotations are defined:</p><dl class="description"><dt class="dt-description">
<a href="../api/org/checkerframework/checker/units/qual/Acceleration.html"><span style="font-weight:bold"><span style="font-family:monospace">@Acceleration</span></span></a></dt><dd class="dd-description"></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/units/qual/Angle.html"><span style="font-weight:bold"><span style="font-family:monospace">@Angle</span></span></a></dt><dd class="dd-description"></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/units/qual/Area.html"><span style="font-weight:bold"><span style="font-family:monospace">@Area</span></span></a></dt><dd class="dd-description"></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/units/qual/Current.html"><span style="font-weight:bold"><span style="font-family:monospace">@Current</span></span></a></dt><dd class="dd-description"></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/units/qual/Length.html"><span style="font-weight:bold"><span style="font-family:monospace">@Length</span></span></a></dt><dd class="dd-description"></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/units/qual/Luminance.html"><span style="font-weight:bold"><span style="font-family:monospace">@Luminance</span></span></a></dt><dd class="dd-description"></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/units/qual/Mass.html"><span style="font-weight:bold"><span style="font-family:monospace">@Mass</span></span></a></dt><dd class="dd-description"></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/units/qual/Speed.html"><span style="font-weight:bold"><span style="font-family:monospace">@Speed</span></span></a></dt><dd class="dd-description"></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/units/qual/Substance.html"><span style="font-weight:bold"><span style="font-family:monospace">@Substance</span></span></a></dt><dd class="dd-description"></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/units/qual/Temperature.html"><span style="font-weight:bold"><span style="font-family:monospace">@Temperature</span></span></a></dt><dd class="dd-description"></dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/units/qual/Time.html"><span style="font-weight:bold"><span style="font-family:monospace">@Time</span></span></a></dt><dd class="dd-description">
</dd></dl><p>For each kind of unit, the corresponding SI unit of
measurement is defined:</p><ol class="enumerate" type=1><li class="li-enumerate">
For <span style="font-family:monospace">@Acceleration</span>:
Meter Per Second Square <a href="../api/org/checkerframework/checker/units/qual/mPERs2.html"><span style="font-family:monospace">@mPERs2</span></a></li><li class="li-enumerate">For <span style="font-family:monospace">@Angle</span>:
Radians <a href="../api/org/checkerframework/checker/units/qual/radians.html"><span style="font-family:monospace">@radians</span></a>,
and the derived unit
Degrees <a href="../api/org/checkerframework/checker/units/qual/degrees.html"><span style="font-family:monospace">@degrees</span></a></li><li class="li-enumerate">For <span style="font-family:monospace">@Area</span>:
the derived units
square millimeters <a href="../api/org/checkerframework/checker/units/qual/mm2.html"><span style="font-family:monospace">@mm2</span></a>,
square meters <a href="../api/org/checkerframework/checker/units/qual/m2.html"><span style="font-family:monospace">@m2</span></a>, and
square kilometers <a href="../api/org/checkerframework/checker/units/qual/km2.html"><span style="font-family:monospace">@km2</span></a></li><li class="li-enumerate">For <span style="font-family:monospace">@Current</span>:
Ampere <a href="../api/org/checkerframework/checker/units/qual/A.html"><span style="font-family:monospace">@A</span></a></li><li class="li-enumerate">For <span style="font-family:monospace">@Length</span>:
Meters <a href="../api/org/checkerframework/checker/units/qual/m.html"><span style="font-family:monospace">@m</span></a>
and the derived units
millimeters <a href="../api/org/checkerframework/checker/units/qual/mm.html"><span style="font-family:monospace">@mm</span></a> and
kilometers <a href="../api/org/checkerframework/checker/units/qual/km.html"><span style="font-family:monospace">@km</span></a></li><li class="li-enumerate">For <span style="font-family:monospace">@Luminance</span>:
Candela <a href="../api/org/checkerframework/checker/units/qual/cd.html"><span style="font-family:monospace">@cd</span></a></li><li class="li-enumerate">For <span style="font-family:monospace">@Mass</span>:
kilograms <a href="../api/org/checkerframework/checker/units/qual/kg.html"><span style="font-family:monospace">@kg</span></a>
and the derived unit
grams <a href="../api/org/checkerframework/checker/units/qual/g.html"><span style="font-family:monospace">@g</span></a></li><li class="li-enumerate">For <span style="font-family:monospace">@Speed</span>:
meters per second <a href="../api/org/checkerframework/checker/units/qual/mPERs.html"><span style="font-family:monospace">@mPERs</span></a> and
kilometers per hour <a href="../api/org/checkerframework/checker/units/qual/kmPERh.html"><span style="font-family:monospace">@kmPERh</span></a></li><li class="li-enumerate">For <span style="font-family:monospace">@Substance</span>:
Mole <a href="../api/org/checkerframework/checker/units/qual/mol.html"><span style="font-family:monospace">@mol</span></a></li><li class="li-enumerate">For <span style="font-family:monospace">@Temperature</span>:
Kelvin <a href="../api/org/checkerframework/checker/units/qual/K.html"><span style="font-family:monospace">@K</span></a>
and the derived unit
Celsius <a href="../api/org/checkerframework/checker/units/qual/C.html"><span style="font-family:monospace">@C</span></a></li><li class="li-enumerate">For <span style="font-family:monospace">@Time</span>:
seconds <a href="../api/org/checkerframework/checker/units/qual/s.html"><span style="font-family:monospace">@s</span></a>
and the derived units
minutes <a href="../api/org/checkerframework/checker/units/qual/min.html"><span style="font-family:monospace">@min</span></a> and
hours <a href="../api/org/checkerframework/checker/units/qual/h.html"><span style="font-family:monospace">@h</span></a>
</li></ol><p>You may specify SI unit prefixes, using enumeration <a href="../api/org/checkerframework/checker/units/qual/Prefix.html"><span style="font-family:monospace">Prefix</span></a>.
The basic SI units
(<span style="font-family:monospace">@s</span>, <span style="font-family:monospace">@m</span>, <span style="font-family:monospace">@g</span>, <span style="font-family:monospace">@A</span>, <span style="font-family:monospace">@K</span>,
<span style="font-family:monospace">@mol</span>, <span style="font-family:monospace">@cd</span>)
take an optional <span style="font-family:monospace">Prefix</span> enum as argument.
For example, to use nanoseconds as unit, you could use
<span style="font-family:monospace">@s(Prefix.nano)</span> as a unit type.
You can sometimes use a different annotation instead of a prefix;
for example, <span style="font-family:monospace">@mm</span> is equivalent to <span style="font-family:monospace">@m(Prefix.milli)</span>.</p><p>Class <span style="font-family:monospace">UnitsTools</span> contains a constant for each SI unit.
To create a value of the particular unit, multiply an unqualified
value with one of these constants.
By using static imports, this allows very natural notation; for
example, after statically importing <span style="font-family:monospace">UnitsTools.m</span>,
the expression <span style="font-family:monospace">5 * m</span> represents five meters.
As all these unit constants are public, static, and final with value
one, the compiler will optimize away these multiplications.</p><p>The polymorphic annotation <a href="../api/org/checkerframework/checker/units/qual/PolyUnit.html"><span style="font-family:monospace">@PolyUnit</span></a>
enables you to write a method that takes an argument of any unit type and
returns a result of that same type. For more about polymorphic qualifiers,
see Section&#XA0;<a href="#qualifier-polymorphism">25.2</a>. For an example of its use, see
the
<a href="../api/org/checkerframework/checker/units/qual/PolyUnit.html"><span style="font-family:monospace">@PolyUnit</span>
Javadoc</a>.</p>
<!--TOC section id="extending-units" Extending the Units Checker-->
<h2 id="extending-units" class="section">17.2&#XA0;&#XA0;Extending the Units Checker <a href="#extending-units" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>You can create new kind annotations and unit annotations that are specific
to the particular needs of your project. An easy way to do this is by
copying and adapting an existing annotation. (In addition, search for all
uses of the annotation&#X2019;s name throughout the Units Checker implementation,
to find other code to adapt; read on for details.)</p><p>Here is an example of a new unit annotation.</p><pre>
@Documented
@Retention(RetentionPolicy.RUNTIME)
@SubtypeOf(<span style="font-family:monospace">{</span>Time.class<span style="font-family:monospace">}</span>)
@UnitsMultiple(quantity=s.class, prefix=Prefix.nano)
@Target({ElementType.TYPE_USE, ElementType.TYPE_PARAMETER})
public @interface ns <span style="font-family:monospace">{</span><span style="font-family:monospace">}</span>
</pre><p>The <span style="font-family:monospace">@SubtypeOf</span> meta-annotation specifies that this annotation
introduces an additional unit of time.
The <span style="font-family:monospace">@UnitsMultiple</span> meta-annotation specifies that this annotation
should be a nano multiple of the basic unit <span style="font-family:monospace">@s</span>: <span style="font-family:monospace">@ns</span> and
<span style="font-family:monospace">@s(Prefix.nano)</span>
behave equivalently and interchangeably.
Most annotation definitions do not have a <span style="font-family:monospace">@UnitsMultiple</span> meta-annotation.</p><p>Note that all custom annotations must have the
<span style="font-family:monospace">@Target(ElementType.TYPE_USE)</span> meta-annotation. See section
<a href="#creating-define-type-qualifiers">31.4.1</a>.</p><p>To take full advantage of the additional unit qualifier, you need to
do two additional steps.
(1)&#XA0;Provide constants that convert from unqualified types to types that use
the new unit.
See class <span style="font-family:monospace">UnitsTools</span> for examples (you will need to suppress a
checker warning in just those few locations).
(2)&#XA0;Put the new unit in relation to existing units.
Provide an
implementation of the <span style="font-family:monospace">UnitsRelations</span> interface as a
meta-annotation to one of the units.</p><p>See demonstration <span style="font-family:monospace">docs/examples/units-extension/</span> for an example
extension that defines Hertz (hz) as scalar per second, and defines an
implementation of <span style="font-family:monospace">UnitsRelations</span> to enforce it.</p>
<!--TOC section id="units-checks" What the Units Checker checks-->
<h2 id="units-checks" class="section">17.3&#XA0;&#XA0;What the Units Checker checks <a href="#units-checks" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The Units Checker ensures that unrelated types are not mixed.</p><p>All types with a particular unit annotation are
disjoint from all unannotated types, from all types with a different unit
annotation, and from all types with the same unit annotation but a
different prefix.</p><p>Subtyping between the units and the unit kinds is taken into account,
as is the <span style="font-family:monospace">@UnitsMultiple</span> meta-annotation.</p><p>Multiplying a scalar with a unit type results in the same unit type.</p><p>The division of a unit type by the same unit type
results in the unqualified type.</p><p>Multiplying or dividing different unit types, for which no unit
relation is known to the system, will result in a <span style="font-family:monospace">MixedUnits</span>
type, which is separate from all other units.
If you encounter a <span style="font-family:monospace">MixedUnits</span> annotation in an error message,
ensure that your operations are performed on correct units or refine
your <span style="font-family:monospace">UnitsRelations</span> implementation.</p><p>The Units Checker does <em>not</em> change units based on multiplication; for
example, if variable <span style="font-family:monospace">mass</span> has the type <span style="font-family:monospace">@kg double</span>, then <span style="font-family:monospace">mass *
1000</span> has that same type rather than the type <span style="font-family:monospace">@g double</span>. (The Units
Checker has no way of knowing whether you intended a conversion, or you
were computing the mass of 1000 items. You need to make all conversions
explicit in your code, and it&#X2019;s good style to minimize the number of
conversions.)</p>
<!--TOC section id="units-running" Running the Units Checker-->
<h2 id="units-running" class="section">17.4&#XA0;&#XA0;Running the Units Checker <a href="#units-running" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The Units Checker can be invoked by running the following commands.</p><ul class="itemize"><li class="li-itemize">
If your code uses only the SI units that are provided by the
framework, simply invoke the checker:<pre class="verbatim">  javac -processor org.checkerframework.checker.units.UnitsChecker MyFile.java ...
</pre></li><li class="li-itemize">If you define your own units, provide the fully-qualified class names of the
annotations through the <span style="font-family:monospace">-Aunits</span> option, using a comma-no-space-separated
notation:<pre>
  javac -classpath <span style="font-style:italic">/full/path/to/myProject/bin</span>:<span style="font-style:italic">/full/path/to/myLibrary/bin</span> <span style="font-family:monospace">\</span>
        -processor org.checkerframework.checker.units.UnitsChecker <span style="font-family:monospace">\</span>
        -Aunits=<span style="font-style:italic">myPackage.qual.MyUnit</span>,<span style="font-style:italic">myPackage.qual.MyOtherUnit</span> MyFile.java ...
</pre><p>The annotations listed in <span style="font-family:monospace">-Aunits</span> must be accessible to
the compiler during compilation in the classpath. In other words, they must
already be compiled (and, typically, be on the javac classpath)
before you run the Units Checker with <span style="font-family:monospace">javac</span>. It
is not sufficient to supply their source files on the command line.</p></li><li class="li-itemize">You can also provide the fully-qualified paths to a set of directories
that contain units qualifiers through the <span style="font-family:monospace">-AunitsDirs</span> option,
using a colon-no-space-separated notation. For example:<pre>
  javac -classpath <span style="font-style:italic">/full/path/to/myProject/bin</span>:<span style="font-style:italic">/full/path/to/myLibrary/bin</span> <span style="font-family:monospace">\</span>
        -processor org.checkerframework.checker.units.UnitsChecker <span style="font-family:monospace">\</span>
        -AunitsDirs=<span style="font-style:italic">/full/path/to/myProject/bin</span>:<span style="font-style:italic">/full/path/to/myLibrary/bin</span> MyFile.java ...
</pre><p>Note that in these two examples, the compiled class file of the
<span style="font-family:monospace">myPackage.qual.MyUnit</span> and <span style="font-family:monospace">myPackage.qual.MyOtherUnit</span> annotations
must exist in either the <span style="font-family:monospace">myProject/bin</span> directory or the
<span style="font-family:monospace">myLibrary/bin</span> directory. The following placement of the class files
will work with the above commands:</p><pre>
  .../myProject/bin/myPackage/qual/MyUnit.class
  .../myProject/bin/myPackage/qual/MyOtherUnit.class
</pre><p>The two options can be used at the same time to provide groups of annotations
from directories, and individually named annotations.</p></li></ul><p>Also, see the example project in the <span style="font-family:monospace">docs/examples/units-extension</span> directory.</p>
<!--TOC section id="units-suppressing" Suppressing warnings-->
<h2 id="units-suppressing" class="section">17.5&#XA0;&#XA0;Suppressing warnings <a href="#units-suppressing" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>One example of when you need to suppress warnings is when you
initialize a variable with a unit type by a literal value.
To remove this warning message, it is best to introduce a
constant that represents the unit and to
add a <span style="font-family:monospace">@SuppressWarnings</span>
annotation to that constant.
For examples, see class <span style="font-family:monospace">UnitsTools</span>.</p>
<!--TOC section id="units-references" References-->
<h2 id="units-references" class="section">17.6&#XA0;&#XA0;References <a href="#units-references" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><ul class="itemize"><li class="li-itemize">
The GNU Units tool provides a comprehensive list of units:<br>
 <a href="http://www.gnu.org/software/units/"><span style="font-family:monospace">http://www.gnu.org/software/units/</span></a></li><li class="li-itemize">The F# units of measurement system inspired some of our syntax:<br>
 <a href="https://en.wikibooks.org/wiki/F_Sharp_Programming/Units_of_Measure"><span style="font-family:monospace">https://en.wikibooks.org/wiki/F_Sharp_Programming/Units_of_Measure</span></a></li></ul><hr>
<!--TOC chapter id="signedness-checker" Signedness Checker-->
<h1 id="signedness-checker" class="chapter">Chapter&#XA0;18&#XA0;&#XA0;Signedness Checker <a href="#signedness-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h1><!--SEC END --><p>The Signedness Checker guarantees that signed and unsigned integral values are not mixed
together in a computation. In addition, it prohibits meaningless operations, such
as division on an unsigned value.</p><p>Recall that a computer represents a number as a sequence of bits.
Signedness indicates how to interpret the most significant bit. For
example, the bits <span style="font-family:monospace">10000010</span> ordinarily represent the value -126, but when
interpreted as unsigned, those bits represent the value 130. The bits
<span style="font-family:monospace">01111110</span> represent the value 126 in signed and in unsigned interpretation.
The range of signed byte values is -128 to 127. The range of unsigned byte
values is 0 to 255.</p><p>Signedness is only applicable to integral types: <span style="font-family:monospace">bype</span>, <span style="font-family:monospace">char</span>,
<span style="font-family:monospace">short</span>, <span style="font-family:monospace">int</span>, and <span style="font-family:monospace">long</span>. Floating-point types (<span style="font-family:monospace">float</span> and
<span style="font-family:monospace">double</span>) do not have operations that interpret the bits as unsigned.</p><p>Signedness is primarily about how the bits of the representation are
interpreted, not about the values that it can represent. An unsigned value
is always positive, but just because a variable&#X2019;s value is positive does
not mean that it should be marked as <span style="font-family:monospace">@Unsigned</span>. If variable <span style="font-style:italic">v</span> will be
compared to a signed value, or used in arithmetic operations with a signed
value, then <span style="font-style:italic">v</span> should have signed type.
To indicate the range of possible values for a variable, use the
<a href="../api/org/checkerframework/checker/index/qual/NonNegative.html"><span style="font-family:monospace">@NonNegative</span></a> annotation of the Index
Checker (see Chapter&#XA0;<a href="#index-checker">8</a>) or the
<a href="../api/org/checkerframework/common/value/qual/IntRange.html"><span style="font-family:monospace">@IntRange</span></a> annotation of the Constant Value
Checker (see Chapter&#XA0;<a href="#constant-value-checker">21</a>).</p>
<!--TOC section id="signedness-checker-annotations" Annotations-->
<h2 id="signedness-checker-annotations" class="section">18.1&#XA0;&#XA0;Annotations <a href="#signedness-checker-annotations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The Signedness Checker uses type annotations to indicate the signedness that the programmer intends an expression to have.</p><blockquote class="figure"><div class="center"><hr style="width:80%;height:2"></div>
<div class="center">
<img src="signedness.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 18.1: The type qualifier hierarchy of the signedness annotations.
Qualifiers in gray are used internally by the type system but should never be written by a programmer.</td></tr>
</table></div>
<a id="fig-signedness-hierarchy"></a>
<div class="center"><hr style="width:80%;height:2"></div></blockquote><p>These are the qualifiers in the signedness type system:</p><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/checker/signedness/qual/Unsigned.html"><span style="font-weight:bold"><span style="font-family:monospace">@Unsigned</span></span></a></dt><dd class="dd-description">
indicates that the programmer intends the value to be
interpreted as unsigned.
That is, if the most significant bit in the bitwise representation is
set, then the bits should be interpreted as a large positive value.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/signedness/qual/Signed.html"><span style="font-weight:bold"><span style="font-family:monospace">@Signed</span></span></a></dt><dd class="dd-description">
indicates that the programmer intends the value to be
interpreted as signed.
That is, if the most significant bit in the bitwise representation is
set, then the bits should be interpreted as a negative value.
This is the default annotation.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/signedness/qual/SignedPositive.html"><span style="font-weight:bold"><span style="font-family:monospace">@SignedPositive</span></span></a></dt><dd class="dd-description">
indicates that a value is known at compile time to be in the positive
signed range, so it has the same interpretation as signed or unsigned
and may be used with either interpretation. Programmers should usually
write <a href="../api/org/checkerframework/checker/signedness/qual/Signed.html"><span style="font-family:monospace">@Signed</span></a> or
<a href="../api/org/checkerframework/checker/signedness/qual/Unsigned.html"><span style="font-family:monospace">@Unsigned</span></a> instead.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/signedness/qual/SignednessGlb.html"><span style="font-weight:bold"><span style="font-family:monospace">@SignednessGlb</span></span></a></dt><dd class="dd-description">
indicates that a value may be interpreted as unsigned or signed. It
covers the same cases as
<a href="../api/org/checkerframework/checker/signedness/qual/SignedPositive.html"><span style="font-family:monospace">@SignedPositive</span></a>, plus manifest literals, to
prevent the programmer from having to annotate them all explicitly.
This annotation should almost never be written by the
programmer.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/signedness/qual/PolySigned.html"><span style="font-weight:bold"><span style="font-family:monospace">@PolySigned</span></span></a></dt><dd class="dd-description">
indicates qualifier polymorphism.
For a description of qualifier polymorphism, see
Section&#XA0;<a href="#qualifier-polymorphism">25.2</a>.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/signedness/qual/UnknownSignedness.html"><span style="font-weight:bold"><span style="font-family:monospace">@UnknownSignedness</span></span></a></dt><dd class="dd-description">
indicates that a value&#X2019;s type is not relevant or known to this checker.
This annotation is used internally, and should not be
written by the programmer.</dd><dt class="dt-description"><a href="../api/org/checkerframework/checker/signedness/qual/SignednessBottom.html"><span style="font-weight:bold"><span style="font-family:monospace">@SignednessBottom</span></span></a></dt><dd class="dd-description">
indicates that the value is <span style="font-family:monospace">null</span>.
This annotation is used internally, and should not
be written by the programmer.</dd></dl>
<!--TOC subsection id="signedness-checker-annotations-default-qualifiers" Default qualifiers-->
<h3 id="signedness-checker-annotations-default-qualifiers" class="subsection">18.1.1&#XA0;&#XA0;Default qualifiers <a href="#signedness-checker-annotations-default-qualifiers" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The only type qualifier that the programmer should need to write is
<a href="../api/org/checkerframework/checker/signedness/qual/Unsigned.html"><span style="font-family:monospace">@Unsigned</span></a>.
When a programmer leaves an expression unannotated, the
Signedness Checker treats it in one of the following ways:</p><ul class="itemize"><li class="li-itemize">All <span style="font-family:monospace">byte</span>, <span style="font-family:monospace">short</span>, <span style="font-family:monospace">int</span>, and <span style="font-family:monospace">long</span> literals default
to <a href="../api/org/checkerframework/checker/signedness/qual/SignednessGlb.html"><span style="font-family:monospace">@SignednessGlb</span></a>.
</li><li class="li-itemize">All <span style="font-family:monospace">byte</span>, <span style="font-family:monospace">short</span>, <span style="font-family:monospace">int</span>, and <span style="font-family:monospace">long</span> variables default
to <a href="../api/org/checkerframework/checker/signedness/qual/Signed.html"><span style="font-family:monospace">@Signed</span></a>.
</li><li class="li-itemize">All other expressions default to <a href="../api/org/checkerframework/checker/signedness/qual/UnknownSignedness.html"><span style="font-family:monospace">@UnknownSignedness</span></a>.</li></ul>
<!--TOC section id="signedness-checker-prohibited-operations" Prohibited operations-->
<h2 id="signedness-checker-prohibited-operations" class="section">18.2&#XA0;&#XA0;Prohibited operations <a href="#signedness-checker-prohibited-operations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The Signedness Checker prohibits the following uses of operators:</p><ul class="itemize"><li class="li-itemize">Division (<span style="font-family:monospace">/</span>) or modulus (<span style="font-family:monospace">%</span>) with an <span style="font-family:monospace">@Unsigned</span>
operand.
</li><li class="li-itemize">Signed right shift (<code>&gt;&gt;</code>) with an <span style="font-family:monospace">@Unsigned</span> left operand.
</li><li class="li-itemize">Unsigned right shift (<code>&gt;&gt;&gt;</code>) with a <span style="font-family:monospace">@Signed</span> left operand.
</li><li class="li-itemize">Greater/less than (or equal) comparators
(<span style="font-family:monospace">&lt;</span>, <span style="font-family:monospace">&lt;=</span>, <span style="font-family:monospace">&gt;</span>, <span style="font-family:monospace">&gt;=</span>) with an <span style="font-family:monospace">@Unsigned</span>
operand.
</li><li class="li-itemize">Any other binary operator with one <span style="font-family:monospace">@Unsigned</span> operand and one
<span style="font-family:monospace">@Signed</span> operand, with the exception of left shift (<code>&lt;&lt;</code>).</li></ul><p>Like every type-checker built with the Checker Framework, the Signedness
Checker ensures that assignments and pseudo-assignments have consistent types.
For example, it is not permitted to assign a <span style="font-family:monospace">@Signed</span> expression to an
<span style="font-family:monospace">@Unsigned</span> variable or vice versa.</p>
<!--TOC section id="signedness-checker-rationale" Rationale-->
<h2 id="signedness-checker-rationale" class="section">18.3&#XA0;&#XA0;Rationale <a href="#signedness-checker-rationale" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The Signedness Checker prevents misuse of unsigned values in Java code.
Most Java operations interpret operands as signed. If applied to unsigned
values, those operations would produce unexpected, incorrect results.</p><p>Consider the following Java code:</p><pre class="verbatim">public class SignednessManualExample {

    int s1 = -2;
    int s2 = -1;

    @Unsigned int u1 = 2147483646; // unsigned: 2^32 - 2, signed: -2
    @Unsigned int u2 = 2147483647; // unsigned: 2^32 - 1, signed: -1

    void m() {
        int w = s1 / s2; // OK: result is 2, which is correct for -2 / -1
        int x = u1 / u2; // ERROR: result is 2, which is incorrect for (2^32 - 2) / (2^32 - 1)
    }

    int s3 = -1;
    int s4 = 5;

    @Unsigned int u3 = 2147483647; // unsigned: 2^32 - 1, signed: -1
    @Unsigned int u4 = 5;

    void m2() {
        int y = s3 % s4; // OK: result is -1, which is correct for -1 % 5
        int z = u3 % u4; // ERROR: result is -1, which is incorrect for (2^32 - 1) % 5 = 2
    }
}
</pre><p>These examples illustrate why division and modulus with an unsigned operand
are illegal. Other uses of operators are prohibited for similar reasons.</p>
<!--TOC section id="signedness-utilities" Utility routines for manipulating unsigned values-->
<h2 id="signedness-utilities" class="section">18.4&#XA0;&#XA0;Utility routines for manipulating unsigned values <a href="#signedness-utilities" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>Class <a href="../api/org/checkerframework/checker/signedness/SignednessUtil.html"><span style="font-family:monospace">SignednessUtil</span></a> provides static
utility methods for working with unsigned values. Some of these
re-implement functionality in JDK 8, making it available in earlier
versions of Java. Others provide new functionality. All of them are
properly annotated with <a href="../api/org/checkerframework/checker/signedness/qual/Unsigned.html"><span style="font-family:monospace">@Unsigned</span></a>
where appropriate, so using them may reduce the number of annotations that
you need to write.</p><p>Class <a href="../api/org/checkerframework/checker/signedness/SignednessUtilExtra.html"><span style="font-family:monospace">SignednessUtilExtra</span></a> contains more utility
methods that reference packages not included in Android. This class is not
included in <span style="font-family:monospace">checker-qual.jar</span>, so you may want to copy the methods to your code.</p>
<!--TOC section id="signedness-refinement" Local type refinement-->
<h2 id="signedness-refinement" class="section">18.5&#XA0;&#XA0;Local type refinement <a href="#signedness-refinement" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>Local type refinment/inference (Section&#XA0;<a href="#type-refinement">26.7</a>) may be
surprising for the Signedness type system. Ordinarily, an expression with
unsigned type may not participate in a division, as shown in
Sections&#XA0;<a href="#signedness-checker-prohibited-operations">18.2</a>
and&#XA0;<a href="#signedness-checker-rationale">18.3</a>. However, if a constant is assigned
to a variable that was declared with <span style="font-family:monospace">@Unsigned</span> type, then&#X2014;just like
the constant&#X2014;the variable may be treated as either signed or unsigned.
For example, it can participate in division. Since the result of the
division is signed, you cannot accidentally assign the division result to
an <span style="font-family:monospace">@Unsigned</span> variable.</p><pre class="verbatim">    void useLocalVariables() {

        int s1 = -2;
        int s2 = -1;

        @Unsigned int u1 = 2147483646; // unsigned: 2^32 - 2, signed: -2
        @Unsigned int u2 = 2147483647; // unsigned: 2^32 - 1, signed: -1

        int w = s1 / s2; // OK: result is 2, which is correct for -2 / -1
        int x = u1 / u2; // OK; computation over constants, interpreted as signed; result is signed
    }
</pre><hr>
<!--TOC chapter id="aliasing-checker" Aliasing Checker-->
<h1 id="aliasing-checker" class="chapter">Chapter&#XA0;19&#XA0;&#XA0;Aliasing Checker <a href="#aliasing-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h1><!--SEC END --><p>The Aliasing Checker identifies expressions that definitely have no
aliases.</p><p>Two expressions are aliased when they have the same non-primitive value;
that is, they are references to the identical Java object
in the heap. Another way of saying this is that two expressions,
<span style="font-style:italic">exprA</span> and <span style="font-style:italic">exprB</span>, are aliases of each other when
<span style="font-style:italic">exprA</span> <span style="font-family:monospace">==</span> <span style="font-style:italic">exprB</span> at the same program point.</p><p>Assigning to a variable or field typically creates an alias. For example,
after the statement <span style="font-family:monospace">a = b;</span>, the variables <span style="font-family:monospace">a</span> and <span style="font-family:monospace">b</span> are aliased.</p><p>Knowing that an expression is not aliased permits more accurate reasoning
about how side effects modify the expression&#X2019;s value.</p><p>To run the Aliasing Checker, supply the
<span style="font-family:monospace">-processor org.checkerframework.common.aliasing.AliasingChecker</span>
command-line option to javac.
However, a user rarely runs the Aliasing Checker directly.
This type system is mainly intended to be used together with other type systems.
For example, the SPARTA information flow type-checker
(Section&#XA0;<a href="#sparta-checker">24.8</a>) uses the Aliasing Checker to improve its
type refinement &#X2014; if an expression has no aliases, a more refined type
can often be inferred, otherwise the type-checker makes conservative
assumptions.</p>
<!--TOC section id="aliasing-annotations" Aliasing annotations-->
<h2 id="aliasing-annotations" class="section">19.1&#XA0;&#XA0;Aliasing annotations <a href="#aliasing-annotations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><blockquote class="figure"><div class="center"><hr style="width:80%;height:2"></div>
<div class="center">
<img src="aliasing.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 19.1: Type hierarchy for the Aliasing type system.
These qualifiers are applicable to any reference (non-primitive) type.</td></tr>
</table></div>
<a id="fig-aliasing-hierarchy"></a>
<div class="center"><hr style="width:80%;height:2"></div></blockquote><p>There are two possible types for an expression:</p><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/common/aliasing/qual/MaybeAliased.html"><span style="font-weight:bold"><span style="font-family:monospace">@MaybeAliased</span></span></a></dt><dd class="dd-description">
is the type of an expression that might have an alias.
This is the default, so every unannotated type is
<span style="font-family:monospace">@MaybeAliased</span>. (This includes the type of <span style="font-family:monospace">null</span>.)</dd><dt class="dt-description"><a href="../api/org/checkerframework/common/aliasing/qual/Unique.html"><span style="font-weight:bold"><span style="font-family:monospace">@Unique</span></span></a></dt><dd class="dd-description">
is the type of an expression that has no aliases.<p>The <span style="font-family:monospace">@Unique</span> annotation is only allowed at local variables, method
parameters, constructor results, and method returns.
A constructor&#X2019;s result should be annotated with <span style="font-family:monospace">@Unique</span> only if the
constructor&#X2019;s body does not creates an alias to the constructed object.</p></dd></dl><p>There are also two annotations, which are currently trusted instead of verified,
that can be used on formal parameters (including
the receiver parameter, <span style="font-family:monospace">this</span>):</p><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/common/aliasing/qual/NonLeaked.html"><span style="font-weight:bold"><span style="font-family:monospace">@NonLeaked</span></span></a></dt><dd class="dd-description">
identifies a formal parameter that is not leaked nor
returned by the method body.
For example, the formal parameter of the String copy constructor,
<span style="font-family:monospace">String(String s)</span>, is <span style="font-family:monospace">@NonLeaked</span> because the body of the method
only makes a copy of the parameter.</dd><dt class="dt-description"><a href="../api/org/checkerframework/common/aliasing/qual/LeakedToResult.html"><span style="font-weight:bold"><span style="font-family:monospace">@LeakedToResult</span></span></a></dt><dd class="dd-description">
is used when the parameter may be returned, but it is not
otherwise leaked.
For example, the receiver parameter of <span style="font-family:monospace">StringBuffer.append(StringBuffer
this, String s)</span> is
<span style="font-family:monospace">@LeakedToResult</span>, because the method returns the updated receiver.</dd></dl>
<!--TOC section id="aliasing-leaking-contexts" Leaking contexts-->
<h2 id="aliasing-leaking-contexts" class="section">19.2&#XA0;&#XA0;Leaking contexts <a href="#aliasing-leaking-contexts" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>
This section lists the expressions that create aliases. These are also
called &#X201C;leaking contexts&#X201D;.</p><dl class="description"><dt class="dt-description">
<span style="font-weight:bold">Assignments</span></dt><dd class="dd-description">
After an assignment, the left-hand side and the right-hand side are
typically aliased. (The only counterexample is when the right-hand side is
a fresh expression; see Section&#XA0;<a href="#aliasing-refinement">19.4</a>.)<pre class="verbatim">  @Unique Object u = ...;
  Object o = u;                    // (not.unique) type-checking error!
</pre><p>If this example type-checked, then <span style="font-family:monospace">u</span> and <span style="font-family:monospace">o</span> would be aliased.
For this example to type-check, either the <span style="font-family:monospace">@Unique</span> annotation on the
type of <span style="font-family:monospace">u</span>, or the <span style="font-family:monospace">o = u;</span> assignment, must be removed.</p></dd><dt class="dt-description"><span style="font-weight:bold">Method calls and returns (pseudo-assignments)</span></dt><dd class="dd-description">
Passing an argument to a method is a &#X201C;pseudo-assignment&#X201D; because it effectively
assigns the argument to the formal parameter. Return statements are also
pseudo-assignments.
As with assignments, the left-hand side and right-hand side of
pseudo-assignments are typically aliased.<p>Here is an example for argument-passing:</p><pre class="verbatim">  void foo(Object o) { ... }

  @Unique Object u = ...;
  foo(u);   // type-checking error, because foo may create an alias of the passed argument
</pre><p>Passing a non-aliased
reference to a method does not necessarily create an alias.
However, the body of the method might create an alias or leak the
reference. Thus, the Aliasing Checker always treats a method call as
creating aliases for each argument unless the corresponding formal
parameter is marked as
@<a href="../api/org/checkerframework/common/aliasing/qual/NonLeaked.html"><span style="font-family:monospace">@NonLeaked</span></a> or
@<a href="../api/org/checkerframework/common/aliasing/qual/LeakedToResult.html"><span style="font-family:monospace">@LeakedToResult</span></a>.</p><p>Here is an example for a return statement:</p><pre class="verbatim">Object id(@Unique Object p) {
    return p;     // (not.unique) type-checking error!
}
</pre><p>If this code type-checked, then it would be possible for clients to write
code like this:</p><pre class="verbatim">@Unique Object u = ...;
Object o = id(u);
</pre><p>after which there is an alias to <span style="font-family:monospace">u</span> even though it is declared as <span style="font-family:monospace">@Unique</span>.</p><p>However, it is permitted to write</p><pre class="verbatim">Object id(@LeakedToResult Object p) {
    return p;
}
</pre><p>after which the following code type-checks:</p><pre class="verbatim">@Unique Object u = ...;
id(u);                   // method call result is not used
Object o1 = ...;
Object o2 = id(o1);      // argument is not @Unique
</pre></dd><dt class="dt-description"><span style="font-weight:bold">Throws</span></dt><dd class="dd-description">
A thrown exception can be captured by a catch block, which creates an
alias of the thrown exception.<pre class="verbatim">void foo() {
    @Unique Exception uex = new Exception();
    try {
        throw uex;    // (not.unique) type-checking error!
    } catch (Exception ex) {
        // uex and ex refer to the same object here.
    }
}
</pre></dd><dt class="dt-description"><span style="font-weight:bold">Array initializers</span></dt><dd class="dd-description"><p>Array initializers assign the elements in the initializers to corresponding
indexes in the array, therefore expressions in an array initializer are leaked.</p><pre class="verbatim">void foo() {
    @Unique Object o = new Object();
    Object[] ar = new Object[] { o };  // (not.unique) type-checking error!
    // The expressions o and ar[0] are now aliased.
}
</pre></dd></dl>
<!--TOC section id="aliasing-unique-restrictions" Restrictions on where <span style="font-family:monospace">@Unique</span> may be written-->
<h2 id="aliasing-unique-restrictions" class="section">19.3&#XA0;&#XA0;Restrictions on where <span style="font-family:monospace">@Unique</span> may be written <a href="#aliasing-unique-restrictions" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The <span style="font-family:monospace">@Unique</span> qualifier may not be written on locations such as fields,
array elements, and type parameters.</p><p>As an example of why <span style="font-family:monospace">@Unique</span> may not be written on a field&#X2019;s type,
consider the following code:</p><pre class="verbatim">class MyClass {
    @Unique Object field;
    void foo() {
        MyClass myClass2 = this;
        // this.field is now an alias of myClass2.field
    }
}
</pre><p>That code must not type-check, because <span style="font-family:monospace">field</span> is declared as <span style="font-family:monospace">@Unique</span>
but has an alias. The Aliasing Checker solves the problem by forbidding
the <span style="font-family:monospace">@Unique</span> qualifier on subcomponents of a structure, such as fields.
Other solutions might be possible; they would be more complicated but would
permit more code to type-check.</p><p><span style="font-family:monospace">@Unique</span> may not be written on a type parameter for similar reasons.
The assignment</p><pre class="verbatim">List&lt;@Unique Object&gt; l1 = ...;
List&lt;@Unique Object&gt; l2 = l1;
</pre><p>must be forbidden because it would alias <span style="font-family:monospace">l1.get(0)</span> with <span style="font-family:monospace">l2.get(0)</span>
even though both have type <span style="font-family:monospace">@Unique</span>. The Aliasing Checker forbids this
code by rejecting the type <span style="font-family:monospace">List&lt;@Unique Object&gt;</span>.</p>
<!--TOC section id="aliasing-refinement" Aliasing type refinement-->
<h2 id="aliasing-refinement" class="section">19.4&#XA0;&#XA0;Aliasing type refinement <a href="#aliasing-refinement" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>Type refinement enables a type checker to treat an expression as a subtype
of its declared type. For example, even if you declare a local variable as
<span style="font-family:monospace">@MaybeAliased</span> (or don&#X2019;t write anything, since <span style="font-family:monospace">@MaybeAliased</span> is the
default), sometimes the Aliasing Checker can determine that it is actually
<span style="font-family:monospace">@Unique</span>.
For more details, see Section&#XA0;<a href="#type-refinement">26.7</a>.</p><p>The Aliasing Checker treats type refinement in the usual way,
except that at (pseudo-)assignments
the right-hand-side (RHS) may lose its type refinement, before the
left-hand-side (LHS) is type-refined.
The RHS always loses its type refinement (it is widened to
<span style="font-family:monospace">@MaybeAliased</span>, and its declared type must have been
<span style="font-family:monospace">@MaybeAliased</span>) except in the following cases:</p><ul class="itemize"><li class="li-itemize">
The RHS is a fresh expression &#X2014; an expression that returns a different value
each time it is evaluated. In practice, this is only method/constructor calls
with <span style="font-family:monospace">@Unique</span> return type. A variable/field is not fresh because it can
return the same value when evaluated twice.
</li><li class="li-itemize">The LHS is a <span style="font-family:monospace">@NonLeaked</span> formal parameter and the RHS is an argument in a
method call or constructor invocation.
</li><li class="li-itemize">The LHS is a <span style="font-family:monospace">@LeakedToResult</span> formal parameter, the RHS is an argument in
a method call or constructor invocation, and the method&#X2019;s return value is
discarded &#X2014; that is, the method call or constructor invocation is written
syntactically as a statement rather than as a part of a larger expression or
statement.
</li></ul><p>A consequence of the above rules is that most method calls are treated conservatively.
If a variable with declared type <span style="font-family:monospace">@MaybeAliased</span> has been refined
to <span style="font-family:monospace">@Unique</span> and is used as an argument of a method call, it usually loses its
<span style="font-family:monospace">@Unique</span> refined type.</p><p>Figure&#XA0;<a href="#fig-aliasing-refinement-example">19.2</a> gives an example of the Aliasing Checker&#X2019;s
type refinement rules.</p><blockquote class="figure"><div class="center"><hr style="width:80%;height:2"></div>
<pre class="verbatim">// Annotations on the StringBuffer class, used in the examples below.
// class StringBuffer {
//  @Unique StringBuffer();
//  StringBuffer append(@LeakedToResult StringBuffer this, @NonLeaked String s);
// }

void foo() {
    StringBuffer sb = new StringBuffer();    // sb is refined to @Unique.

    StringBuffer sb2 = sb;                   // sb loses its refinement.
    // Both sb and sb2 have aliases and because of that have type @MaybeAliased.
}

void bar() {
    StringBuffer sb = new StringBuffer();     // sb is refined to @Unique.

    sb.append("someString");
    // sb stays @Unique, as no aliases are created.

    StringBuffer sb2 = sb.append("someString");
    // sb is leaked and becomes @MaybeAliased.

    // Both sb and sb2 have aliases and because of that have type @MaybeAliased.
}

</pre><div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 19.2: Example of the Aliasing Checker&#X2019;s type refinement rules.</td></tr>
</table></div>
<a id="fig-aliasing-refinement-example"></a>
<div class="center"><hr style="width:80%;height:2"></div></blockquote><hr>
<!--TOC chapter id="purity-checker" Purity Checker-->
<h1 id="purity-checker" class="chapter">Chapter&#XA0;20&#XA0;&#XA0;Purity Checker <a href="#purity-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h1><!--SEC END --><p>The Purity Checker identifies methods that have no side effects, that
return the same value each time they are called on the same argument, or both.</p><p>Purity analysis aids type refinement (Section&#XA0;<a href="#type-refinement">26.7</a>).</p><p>All checkers utilize purity annotations on called methods.
You do not need to run the Purity Checker directly.
However you may run just the Purity Checker by
supplying the following command-line options to javac:
<span style="font-family:monospace">-processor org.checkerframework.util.PurityChecker</span>.</p>
<!--TOC section id="purity-annotations" Purity annotations-->
<h2 id="purity-annotations" class="section">20.1&#XA0;&#XA0;Purity annotations <a href="#purity-annotations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><dl class="description"><dt class="dt-description"><a href="../api/org/checkerframework/dataflow/qual/SideEffectFree.html"><span style="font-weight:bold"><span style="font-family:monospace">@SideEffectFree</span></span></a></dt><dd class="dd-description">
indicates that the method has no externally-visible side effects.</dd><dt class="dt-description"><a href="../api/org/checkerframework/dataflow/qual/Deterministic.html"><span style="font-weight:bold"><span style="font-family:monospace">@Deterministic</span></span></a></dt><dd class="dd-description">
indicates that if the method is called multiple times with identical
arguments, then it returns the identical result according to <span style="font-family:monospace">==</span>
(not just according to <span style="font-family:monospace">equals()</span>).</dd><dt class="dt-description"><a href="../api/org/checkerframework/dataflow/qual/Pure.html"><span style="font-weight:bold"><span style="font-family:monospace">@Pure</span></span></a></dt><dd class="dd-description">
indicates that the method is both <span style="font-family:monospace">@SideEffectFree</span> and <span style="font-family:monospace">@Deterministic</span>.</dd></dl><p>If you supply the command-line option <span style="font-family:monospace">-AsuggestPureMethods</span>, then the
Checker Framework will suggest methods that can be marked as
<span style="font-family:monospace">@SideEffectFree</span>, <span style="font-family:monospace">@Deterministic</span>, or <span style="font-family:monospace">@Pure</span>.</p>
<!--TOC section id="purity-trusted" Purity annotations are trusted-->
<h2 id="purity-trusted" class="section">20.2&#XA0;&#XA0;Purity annotations are trusted <a href="#purity-trusted" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>Currently, purity annotations are trusted. Purity annotations on called
methods affect type-checking of client code. However, you can make a
mistake by writing <span style="font-family:monospace">@SideEffectFree</span> on the declaration of a method that
is not actually side-effect-free or by writing <span style="font-family:monospace">@Deterministic</span> on the
declaration of a method that is not actually deterministic.</p><p>To enable
checking of the annotations, supply the command-line option
<span style="font-family:monospace">-AcheckPurityAnnotations</span>. It is not enabled by default because of a high false
positive rate. In the future, after a new purity-checking analysis is
implemented, the Checker Framework will default to checking purity
annotations.</p>
<!--TOC section id="purity-override" Overriding methods must respect specifications in superclasses-->
<h2 id="purity-override" class="section">20.3&#XA0;&#XA0;Overriding methods must respect specifications in superclasses <a href="#purity-override" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>If a method in a superclass has a purity annotation, then every overriding
definition must also have that purity annotation (or a stronger one).</p><p>Here is an example error if this requirement is violated:</p><div style="font-size:small;">
<pre class="verbatim">MyClass.java:1465: error: int hashCode() in MyClass cannot override int hashCode(Object this) in java.lang.Object;
attempting to use an incompatible purity declaration
    public int hashCode() {
               ^
  found   : []
  required: [SIDE_EFFECT_FREE, DETERMINISTIC]
</pre></div><p>The reason for the error is that the <span style="font-family:monospace">Object</span> class is annotated as:</p><pre class="verbatim">class Object {
  ...
  @Pure int hashCode() { ... }
}
</pre><p>(where <a href="../api/org/checkerframework/dataflow/qual/Pure.html"><span style="font-family:monospace">@Pure</span></a> means both
<a href="../api/org/checkerframework/dataflow/qual/SideEffectFree.html"><span style="font-family:monospace">@SideEffectFree</span></a> and
<a href="../api/org/checkerframework/dataflow/qual/Deterministic.html"><span style="font-family:monospace">@Deterministic</span></a>). Every overriding
definition, including those in your program, must use be at least as strong
a specification. For <span style="font-family:monospace">hashCode</span>, every overriding definition must be
annotated as <span style="font-family:monospace">@Pure</span>.</p><p>You can fix the definition by adding <span style="font-family:monospace">@Pure</span> to your method definition.
Alternately, you can suppress the warning.
You can suppress each such warning individually using
<span style="font-family:monospace">@SuppressWarnings("purity.invalid.overriding")</span>,
or you can use the <span style="font-family:monospace">-AsuppressWarnings=purity.invalid.overriding</span>
command-line argument to suppress all such warnings.
In the future, the Checker Framework will support inheriting annotations
from superclass definitions.</p>
<!--TOC section id="purity-suppress-warnings" Suppressing warnings-->
<h2 id="purity-suppress-warnings" class="section">20.4&#XA0;&#XA0;Suppressing warnings <a href="#purity-suppress-warnings" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The command-line option
<span style="font-family:monospace">-AassumeSideEffectFree</span> makes the Checker Framework unsoundly
assume that <em>every</em> called method is side-effect-free. This can make
flow-sensitive type refinement much more effective, since method calls will
not cause the analysis to discard information that it has learned.
However, this option can mask real errors. It is most appropriate when you
are starting out annotating a project, or if you are using the Checker
Framework to find some bugs but not to give a guarantee that no more errors
exist of the given type.</p><hr>
<!--TOC chapter id="constant-value-checker" Constant Value Checker-->
<h1 id="constant-value-checker" class="chapter">Chapter&#XA0;21&#XA0;&#XA0;Constant Value Checker <a href="#constant-value-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h1><!--SEC END --><p>The Constant Value Checker is a constant propagation analysis: for
each variable, it determines whether that variable&#X2019;s value can be
known at compile time.</p><p>There are two ways to run the Constant Value Checker.
</p><ul class="itemize"><li class="li-itemize">
Typically, it is automatically run by another type checker.
</li><li class="li-itemize">Alternately, you can run just the Constant Value Checker, by
supplying the following command-line options to javac:
<span style="font-family:monospace">-processor org.checkerframework.common.value.ValueChecker -Astubs=statically-executable.astub</span>
</li></ul>
<!--TOC section id="constant-value-checker-annotations" Annotations-->
<h2 id="constant-value-checker-annotations" class="section">21.1&#XA0;&#XA0;Annotations <a href="#constant-value-checker-annotations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The Constant Value Checker uses type annotations to indicate the value of
an expression (Section&#XA0;<a href="#constant-value-checker-type-annotations">21.1.1</a>), and
it uses method annotations to indicate methods that the Constant Value
Checker can execute at compile time
(Section&#XA0;<a href="#constant-value-staticallyexecutable-annotation">21.2.2</a>).</p>
<!--TOC subsection id="constant-value-checker-type-annotations" Type Annotations-->
<h3 id="constant-value-checker-type-annotations" class="subsection">21.1.1&#XA0;&#XA0;Type Annotations <a href="#constant-value-checker-type-annotations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Typically, the programmer does not write any type annotations. Rather, the
type annotations are inferred by the Constant Value Checker.
The programmer is also permitted to write type annotations. This is only necessary in
locations where the Constant Value Checker does not infer annotations: on fields
and method signatures.</p><p>The main type annotations are
<a href="../api/org/checkerframework/common/value/qual/BoolVal.html"><span style="font-family:monospace">@BoolVal</span></a>,
<a href="../api/org/checkerframework/common/value/qual/IntVal.html"><span style="font-family:monospace">@IntVal</span></a>,
<a href="../api/org/checkerframework/common/value/qual/IntRange.html"><span style="font-family:monospace">@IntRange</span></a>,
<a href="../api/org/checkerframework/common/value/qual/DoubleVal.html"><span style="font-family:monospace">@DoubleVal</span></a>, and
<a href="../api/org/checkerframework/common/value/qual/StringVal.html"><span style="font-family:monospace">@StringVal</span></a>.
Additional type annotations for arrays and strings are
<a href="../api/org/checkerframework/common/value/qual/ArrayLen.html"><span style="font-family:monospace">@ArrayLen</span></a>,
<a href="../api/org/checkerframework/common/value/qual/ArrayLenRange.html"><span style="font-family:monospace">@ArrayLenRange</span></a>,
and <a href="../api/org/checkerframework/common/value/qual/MinLen.html"><span style="font-family:monospace">@MinLen</span></a>.
A polymorphic qualifier (<a href="../api/org/checkerframework/common/value/qual/PolyValue.html"><span style="font-family:monospace">@PolyValue</span></a>)
is also supported (see Section&#XA0;<a href="#qualifier-polymorphism">25.2</a>).</p><p>Each <span style="font-family:monospace">*Val</span> type annotation takes as an argument a set of values, and its
meaning is that at run time, the expression evaluates to one of the values. For
example, an expression of type
<a href="../api/org/checkerframework/common/value/qual/StringVal.html"><span style="font-family:monospace">@StringVal</span></a><span style="font-family:monospace">("a", "b")</span> evaluates to
one of the values <span style="font-family:monospace">"a"</span>, <span style="font-family:monospace">"b"</span>, or <span style="font-family:monospace">null</span>.
The set is limited to 10 entries; if a variable
could be more than 10 different values, the Constant Value
Checker gives up and its type becomes
<a href="../api/org/checkerframework/common/value/qual/IntRange.html"><span style="font-family:monospace">@IntRange</span></a> for integral types,
<a href="../api/org/checkerframework/common/value/qual/ArrayLenRange.html"><span style="font-family:monospace">@ArrayLenRange</span></a> for array types,
<a href="../api/org/checkerframework/common/value/qual/ArrayLen.html"><span style="font-family:monospace">@ArrayLen</span></a> or <a href="../api/org/checkerframework/common/value/qual/ArrayLenRange.html"><span style="font-family:monospace">@ArrayLenRange</span></a> for <span style="font-family:monospace">String</span>, and
<a href="../api/org/checkerframework/common/value/qual/UnknownVal.html"><span style="font-family:monospace">@UnknownVal</span></a> for all other types.
The <span style="font-family:monospace">@ArrayLen</span> annotation means that at run time, the expression
evaluates to an array or a string whose length is one of the annotation&#X2019;s arguments.</p><p>In the case of too many strings in <span style="font-family:monospace">@StringVal</span>, the values are forgotten
and just the lengths are used in <span style="font-family:monospace">@ArrayLen</span>.
If this would result in too many lengths,
only the minimum and maximum lengths are used in <span style="font-family:monospace">@ArrayLenRange</span>,
giving a range of possible lengths of the string.</p><p>The <span style="font-family:monospace">@StringVal</span> annotation may be applied to a char array. Although byte
arrays are often converted to/from strings, the <span style="font-family:monospace">@StringVal</span> annotation may
not be applied to them. This is because the conversion depends on the
platform&#X2019;s character set.</p><p><a href="../api/org/checkerframework/common/value/qual/IntRange.html"><span style="font-family:monospace">@IntRange</span></a> takes two arguments &#X2014; a lower
bound and an upper bound. Its meaning is that at run time, the expression
evaluates to a value between the bounds (inclusive). For example, an
expression of type <span style="font-family:monospace">@IntRange(from=0, to=255)</span> evaluates to
0, 1, 2, &#X2026;, 254, or 255.
An <a href="../api/org/checkerframework/common/value/qual/IntVal.html"><span style="font-family:monospace">@IntVal</span></a> and
<a href="../api/org/checkerframework/common/value/qual/IntRange.html"><span style="font-family:monospace">@IntRange</span></a> annotation that represent the
same set of values are semantically identical and interchangeable: they
have exactly the same meaning, and using either one has the same effect.
<a href="../api/org/checkerframework/common/value/qual/ArrayLenRange.html"><span style="font-family:monospace">@ArrayLenRange</span></a> has the same relationship
to <a href="../api/org/checkerframework/common/value/qual/ArrayLen.html"><span style="font-family:monospace">@ArrayLen</span></a> that
<a href="../api/org/checkerframework/common/value/qual/IntRange.html"><span style="font-family:monospace">@IntRange</span></a> has to
<a href="../api/org/checkerframework/common/value/qual/IntVal.html"><span style="font-family:monospace">@IntVal</span></a>.
The <span style="font-family:monospace">@MinLen</span> annotation is an alias for <span style="font-family:monospace">@ArrayLenRange</span> (meaning that every <span style="font-family:monospace">@MinLen</span> annotation
is automatically converted to an <span style="font-family:monospace">@ArrayLenRange</span> annotation) that only takes
one argument, which is the lower bound of the range. The upper bound of the
range is the maximum integer value.</p><p>Figure&#XA0;<a href="#fig-value-hierarchy">21.1</a> shows the
subtyping relationship among the type annotations.
For two annotations of the same type, subtypes have a smaller set of
possible values, as also shown in the figure.
Because <span style="font-family:monospace">int</span> can be casted to <span style="font-family:monospace">double</span>, an <span style="font-family:monospace">@IntVal</span> annotation is a
subtype of a <span style="font-family:monospace">@DoubleVal</span> annotation with the same values.</p><blockquote class="figure"><div class="center"><hr style="width:80%;height:2"></div>
<div class="center">
<img src="value-subtyping.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 21.1: At the top, the type qualifier hierarchy of the Constant Value Checker
annotations.
The first four qualifiers are applicable to primitives and their
wrappers; the next to <span style="font-family:monospace">String</span>s, and the final two to arrays.
Qualifiers in gray are used
internally by the type system but should never be written by a
programmer. At the bottom are examples of additional subtyping
relationships that depend on the annotations&#X2019; arguments.</td></tr>
</table></div>
<a id="fig-value-hierarchy"></a>
<div class="center"><hr style="width:80%;height:2"></div></blockquote><p>Figure&#XA0;<a href="#fig-value-multivalue">21.2</a> illustrates how the Constant Value Checker
infers type annotations (using flow-sensitive type qualifier refinement, Section&#XA0;<a href="#type-refinement">26.7</a>).</p><blockquote class="figure"><div class="center"><hr style="width:80%;height:2"></div>
<pre class="verbatim">public void foo(boolean b) {
    int i = 1;     // i has type:  @IntVal({1}) int
    if (b) {
        i = 2;     // i now has type:  @IntVal({2}) int
    }
                   // i now has type:  @IntVal({1,2}) int
    i = i + 1;     // i now has type:  @IntVal({2,3}) int
}
</pre><div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 21.2: The Constant Value Checker infers different types
for a variable on different lines of the program.</td></tr>
</table></div>
<a id="fig-value-multivalue"></a>
<div class="center"><hr style="width:80%;height:2"></div></blockquote>
<!--TOC section id="other-constant-value-annotations" Other constant value annotations-->
<h2 id="other-constant-value-annotations" class="section">21.2&#XA0;&#XA0;Other constant value annotations <a href="#other-constant-value-annotations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The Checker Framework&#X2019;s constant value annotations are similar to annotations used
elsewhere.</p><p>If your code is already annotated with a different constant value or range
annotation, the Checker Framework can type-check your code.
It treats annotations from other tools
as if you had written the corresponding annotation from the
Constant Value Checker, as described in Figure&#XA0;<a href="#fig-constant-value-refactoring">21.3</a>.
If the other annotation is a declaration annotation, it may be moved; see
Section&#XA0;<a href="#declaration-annotations-moved">28.1.1</a>.</p><blockquote class="figure"><div class="center"><hr style="width:80%;height:2"></div>
<div class="center">
<table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="text-align:left;white-space:nowrap" ><table border=1  style="border-spacing:0;" class="cellpadding1"><tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > &#XA0;android.support.annotation.IntRange&#XA0; </td></tr>
</table></td><td style="text-align:left;white-space:nowrap" >&#X21D2;
&#XA0;org.checkerframework.checker.common.value.qual.IntRange&#XA0;
</td></tr>
</table>
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 21.3: Correspondence between other constant value and range annotations
and the Checker Framework&#X2019;s annotations.</td></tr>
</table></div>
<a id="fig-constant-value-refactoring"></a>
<div class="center"><hr style="width:80%;height:2"></div></blockquote>
<!--TOC subsection id="constant-value-compile-time-execution" Compile-time execution of expressions-->
<h3 id="constant-value-compile-time-execution" class="subsection">21.2.1&#XA0;&#XA0;Compile-time execution of expressions <a href="#constant-value-compile-time-execution" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Whenever all the operands of an expression are compile-time constants (that
is, their types have constant-value type annotations), the Constant Value
Checker attempts to execute the expression. This is independent of any
optimizations performed by the compiler and does not affect the code that
is generated.</p><p>The Constant Value Checker statically executes operators that do
not throw exceptions (e.g., <span style="font-family:monospace">+</span>, <span style="font-family:monospace">-</span>, <span style="font-family:monospace">&lt;&lt;</span>, <span style="font-family:monospace">!=</span>).</p>
<!--TOC subsection id="constant-value-staticallyexecutable-annotation" <span style="font-family:monospace">@StaticallyExecutable</span> methods and the classpath-->
<h3 id="constant-value-staticallyexecutable-annotation" class="subsection">21.2.2&#XA0;&#XA0;<span style="font-family:monospace">@StaticallyExecutable</span> methods and the classpath <a href="#constant-value-staticallyexecutable-annotation" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The Constant Value Checker statically executes methods annotated with
<a href="../api/org/checkerframework/common/value/qual/StaticallyExecutable.html"><span style="font-family:monospace">@StaticallyExecutable</span></a>, <em>if the
method has already been compiled and is on the classpath</em>.</p><blockquote class="figure"><div class="center"><hr style="width:80%;height:2"></div>
<pre class="verbatim">@StaticallyExecutable @Pure
public int foo(int a, int b) {
    return a + b;
}

public void bar() {
    int a = 5;          // a has type:  @IntVal({5}) int
    int b = 4;          // b has type:  @IntVal({4}) int
    int c = foo(a, b);  // c has type:  @IntVal({9}) int
}
</pre><div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 21.4: The
<a href="../api/org/checkerframework/common/value/qual/StaticallyExecutable.html"><span style="font-family:monospace">@StaticallyExecutable</span></a> annotation enables
constant propagation through method calls.</td></tr>
</table></div>
<a id="fig-staticallyexecutable"></a>
<div class="center"><hr style="width:80%;height:2"></div></blockquote><p>A <span style="font-family:monospace">@StaticallyExecutable</span> method must
be <a href="../api/org/checkerframework/dataflow/qual/Pure.html"><span style="font-family:monospace">@Pure</span></a> (side-effect-free and
deterministic).</p><p>Additionally, a <span style="font-family:monospace">@StaticallyExecutable</span> method and any method it calls must be on
the classpath for the compiler, because they are reflectively called at
compile-time to perform the constant value analysis.
To use <span style="font-family:monospace">@StaticallyExecutable</span> on methods in your own code, you should
first compile the code without the Constant Value Checker and then add
the location of the resulting <span style="font-family:monospace">.class</span> files to the
classpath. For example, the command-line arguments to the Checker Framework
might include:
</p><pre class="verbatim">  -processor org.checkerframework.common.value.ValueChecker
  -Astubs=statically-executable.astub
  -classpath $CLASSPATH:MY_PROJECT/build/
</pre>
<!--TOC section id="value-checker-warnings" Warnings-->
<h2 id="value-checker-warnings" class="section">21.3&#XA0;&#XA0;Warnings <a href="#value-checker-warnings" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>If the option <span style="font-family:monospace">-AreportEvalWarns</span> options is used, the Constant Value Checker issues a warning if it cannot load and run, at
compile time, a method marked as <span style="font-family:monospace">@StaticallyExecutable</span>. If it issues
such a warning, then the return value of the method will be <span style="font-family:monospace">@UnknownVal</span>
instead of being able to be resolved to a specific value annotation.
Some examples of these:
</p><ul class="itemize"><li class="li-itemize">
<span style="font-family:monospace">[class.find.failed] Failed to find class named Test.</span><p>The checker could not find the class
specified for resolving a <span style="font-family:monospace">@StaticallyExecutable</span> method. Typically
this is caused by not providing the path of a class-file needed to
the classpath.</p></li><li class="li-itemize"><span style="font-family:monospace">[method.find.failed] Failed to find a method named foo with argument types [@IntVal(3) int].</span><p>The checker could not find the method <span style="font-family:monospace">foo(int)</span> specified for
resolving a <span style="font-family:monospace">@StaticallyExecutable</span> method, but could find the
class. This is usually due to providing an outdated version of the
class-file that does not contain the
method that was annotated as <span style="font-family:monospace">@StaticallyExecutable</span>.</p></li><li class="li-itemize"><span style="font-family:monospace">[method.evaluation.exception] Failed to evaluate method public static int Test.foo(int) because it threw an exception: java.lang.ArithmeticException: / by zero.</span><p>An exception was thrown when trying to statically execute the
method. In this case it was a divide-by-zero exception. If the
arguments to the method each only had one value in their annotations
then this exception will always occur when the program is actually
run as well. If there are multiple possible values then the exception
might not be thrown on every execution, depending on the run-time values.</p></li></ul><p>There are some other situations in which the Constant Value Checker produces a
warning message:</p><ul class="itemize"><li class="li-itemize">
<span style="font-family:monospace">[too.many.values.given] The maximum number of arguments permitted is 10.</span><p>The Constant Value Checker only tracks up to 10 possible values for an
expression. If you write an annotation with more values than will be
tracked, the annotation is replaced with <span style="font-family:monospace">@IntRange</span>, <span style="font-family:monospace">@ArrayLen</span>, <span style="font-family:monospace">@ArrayLenRange</span>, or <span style="font-family:monospace">@UnknownVal</span>.</p></li></ul>
<!--TOC section id="value-checker-overflow" Unsoundly ignoring overflow-->
<h2 id="value-checker-overflow" class="section">21.4&#XA0;&#XA0;Unsoundly ignoring overflow <a href="#value-checker-overflow" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The Constant Value Checker takes Java&#X2019;s overflow rules into account when
computing the possible values of expressions.
The <span style="font-family:monospace">-AignoreRangeOverflow</span> command-line option makes it ignore the
possibility of overflow for range annotations
<a href="../api/org/checkerframework/common/value/qual/IntRange.html"><span style="font-family:monospace">@IntRange</span></a> and
<a href="../api/org/checkerframework/common/value/qual/ArrayLenRange.html"><span style="font-family:monospace">@ArrayLenRange</span></a>.
Figure&#XA0;<a href="#fig-value-ignore-overflow">21.5</a> gives an example of behavior with
and without the <span style="font-family:monospace">-AignoreRangeOverflow</span> command-line option.</p><blockquote class="figure"><div class="center"><hr style="width:80%;height:2"></div>
<pre class="verbatim">  ...
  if (i &gt; 5) {
    // i now has type:  @IntRange(from=5, to=Integer.MAX_VALUE)
    i = i + 1;
    // If i started out as Integer.MAX_VALUE, then i is now Integer.MIN_VALUE.
    // i's type is now @IntRange(from=Integer.MIN_VALUE, to=Integer.MAX_VALUE).
    // When ignoring overflow, i's type is now @IntRange(from=6, to=Integer.MAX_VALUE).
  }
</pre><div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 21.5: With the <span style="font-family:monospace">-AignoreRangeOverflow</span> command-line option,
the Constant Value Checker ignores overflow
for range types, which gives smaller ranges to range types.</td></tr>
</table></div>
<a id="fig-value-ignore-overflow"></a>
<div class="center"><hr style="width:80%;height:2"></div></blockquote><p>As with any unsound behavior in the Checker Framework, this option reduces
the number of warnings and errors produced, and may reduce the number of
<span style="font-family:monospace">@IntRange</span> qualifiers that you need to write in the source code.
However, it is possible that at run time, an expression might evaluate to a
value that is not in its <span style="font-family:monospace">@IntRange</span> qualifier. You should either accept
that possibility, or verify the lack of overflow using some other tool or
manual analysis.</p><hr>
<!--TOC chapter id="reflection-resolution" Reflection resolution-->
<h1 id="reflection-resolution" class="chapter">Chapter&#XA0;22&#XA0;&#XA0;Reflection resolution <a href="#reflection-resolution" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h1><!--SEC END --><p>A call to
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/reflect/Method.html#invoke-java.lang.Object-java.lang.Object...-"><span style="font-family:monospace">Method.invoke</span></a>
might reflectively invoke any method. That method might place requirements
on its formal parameters, and it might return any value. To reflect these
facts, the annotated JDK contains
conservative annotations for <span style="font-family:monospace">Method.invoke</span>.
These conservative library annotations often cause a checker to issue false
positive warnings when type-checking code that uses reflection.</p><p>If you supply the <span style="font-family:monospace">-AresolveReflection</span> command-line option, the Checker
Framework attempts to resolve reflection. At each call to <span style="font-family:monospace">Method.invoke</span>
or <span style="font-family:monospace">Constructor.newInstance</span>, the Checker Framework first soundly estimates
which methods might be invoked at run time. When type-checking the call, the
Checker Framework uses the library annotations for the possibly-invoked
methods, rather than the imprecise one for <span style="font-family:monospace">Method.invoke</span>.</p><p>If the estimate of invoked methods is small,
the checker issues fewer false positive warnings.
If the estimate of invoked methods is large, these types may be no better than the
conservative library annotations.</p><p>Reflection resolution is disabled by default, because it increases the time
to type-check a program.
You should enable reflection resolution with the <span style="font-family:monospace">-AresolveReflection</span>
command-line option if, for some call site of <span style="font-family:monospace">Method.invoke</span> or
<span style="font-family:monospace">Constructor.newInstance</span> in your program:
</p><ol class="enumerate" type=1><li class="li-enumerate">
the conservative library annotations on <span style="font-family:monospace">Method.invoke</span> or
<span style="font-family:monospace">Constructor.newInstance</span> cause false positive warnings,
</li><li class="li-enumerate">the set of possibly-invoked methods or constructors can be known at
compile time,
and
</li><li class="li-enumerate">the reflectively invoked methods/constructors are on the class path at
compile time.
</li></ol><p>Reflection resolution does not change your source code or generated code.
In particular, it does not replace the <span style="font-family:monospace">Method.invoke</span> or
<span style="font-family:monospace">Constructor.newInstance</span> calls.</p><p>The command-line option <span style="font-family:monospace">-AresolveReflection=debug</span> outputs verbose
information about the reflection resolution process, which may be useful
for debugging.</p><p>Section&#XA0;<a href="#reflection-examples">22.1</a> gives an example of reflection resolution.
Then,
Section&#XA0;<a href="#methodval-and-classval-checkers">22.2</a> describes the MethodVal
and ClassVal Checkers, which reflection resolution uses internally.</p>
<!--TOC section id="reflection-examples" Reflection resolution example-->
<h2 id="reflection-examples" class="section">22.1&#XA0;&#XA0;Reflection resolution example <a href="#reflection-examples" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>Consider the following example, in which the Nullness Checker employs
reflection resolution to avoid issuing a false positive warning.</p><pre class="verbatim">public class LocationInfo {
    @NonNull Location getCurrentLocation() {  ...  }
}

public class Example {
    LocationInfo privateLocation = ... ;
    String getCurrentCity() throws Exception {
        Method getCurrentLocationObj = LocationInfo.class.getMethod("getCurrentLocation");
        Location currentLocation = (Location) getCurrentLocationObj.invoke(privateLocation);
        return currentLocation.nameOfCity();
    }
}
</pre><p>When reflection resolution is not enabled, the Nullness Checker uses conservative
annotations on the <span style="font-family:monospace">Method.invoke</span> method signature:</p><p>&#XA0;&#XA0;<span style="font-family:monospace"><span style="font-weight:bold">@Nullable</span></span><span style="font-family:monospace"> Object invoke(</span><span style="font-family:monospace"><span style="font-weight:bold">@NonNull</span></span><span style="font-family:monospace"> Object recv, </span><span style="font-family:monospace"><span style="font-weight:bold">@NonNull</span></span><span style="font-family:monospace"> Object ... args)</span></p><p>This causes the Nullness Checker to issue the following warning even though
<span style="font-family:monospace">currentLocation</span> cannot be null.</p><pre class="verbatim">error: [dereference.of.nullable] dereference of possibly-null reference currentLocation
        return currentLocation.nameOfCity();
               ^
1 error
</pre><p>
When reflection resolution is enabled, the MethodVal Checker infers that the <span style="font-family:monospace">@MethodVal</span> annotation for <span style="font-family:monospace">getCurrentLocationObj</span> is:
</p><p>&#XA0;&#XA0;<span style="font-family:monospace">@MethodVal(className="LocationInfo", methodName="getCurrentLocation", params=0)</span></p><p>Based on this <span style="font-family:monospace">@MethodVal</span> annotation, the reflection resolver determines that
the reflective method call represents a call to <span style="font-family:monospace">getCurrentLocation</span> in class
<span style="font-family:monospace">LocationInfo</span>.
The reflection resolver uses this information to provide the
following precise procedure summary to the Nullness Checker, for this
call site only:</p><p>&#XA0;&#XA0;<span style="font-family:monospace"><span style="font-weight:bold">@NonNull</span></span><span style="font-family:monospace"> Object invoke(</span><span style="font-family:monospace"><span style="font-weight:bold">@NonNull</span></span><span style="font-family:monospace"> Object recv, </span><span style="font-family:monospace"><span style="font-weight:bold">@Nullable</span></span><span style="font-family:monospace"> Object ... args)</span></p><p>Using this more precise signature, the Nullness Checker does not issue the false positive warning shown above.</p>
<!--TOC section id="methodval-and-classval-checkers" MethodVal and ClassVal Checkers-->
<h2 id="methodval-and-classval-checkers" class="section">22.2&#XA0;&#XA0;MethodVal and ClassVal Checkers <a href="#methodval-and-classval-checkers" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The implementation of reflection resolution internally uses the ClassVal
Checker (Section&#XA0;<a href="#classval-checker">22.2.1</a>) and the MethodVal Checker
(Section&#XA0;<a href="#methodval-checker">22.2.2</a>). They are similar to the Constant
Value Checker (Section&#XA0;<a href="#constant-value-checker">21</a>) in that their
annotations estimate the run-time value of an expression.</p><p>In some cases, you may need to write annotations such as
<a href="../api/org/checkerframework/common/reflection/qual/ClassVal.html"><span style="font-family:monospace">@ClassVal</span></a>,
<a href="../api/org/checkerframework/common/reflection/qual/MethodVal.html"><span style="font-family:monospace">@MethodVal</span></a>,
<a href="../api/org/checkerframework/common/value/qual/StringVal.html"><span style="font-family:monospace">@StringVal</span></a>, and
<a href="../api/org/checkerframework/common/value/qual/ArrayLen.html"><span style="font-family:monospace">@ArrayLen</span></a> to aid in reflection
resolution.
Often, though, these annotations can be inferred
(Section&#XA0;<a href="#methodval-and-classval-inference">22.2.3</a>).</p>
<!--TOC subsection id="classval-checker" ClassVal Checker-->
<h3 id="classval-checker" class="subsection">22.2.1&#XA0;&#XA0;ClassVal Checker <a href="#classval-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The ClassVal Checker defines the following annotations:</p><dl class="description"><dt class="dt-description">
<a href="../api/org/checkerframework/common/reflection/qual/ClassVal.html"><span style="font-weight:bold"><span style="font-family:monospace">@ClassVal</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] value)</span></span></dt><dd class="dd-description">
If an expression has <span style="font-family:monospace">@ClassVal</span> type with a single argument,
then its exact run-time value is known at compile time.
For example, <span style="font-family:monospace">@ClassVal("java.util.HashMap")</span>
indicates that the <span style="font-family:monospace">Class</span> object represents the <span style="font-family:monospace">java.util.HashMap</span> class.<p>If multiple arguments are given, then the expression&#X2019;s run-time value is
known to be in that set.</p><p>The arguments are binary names
(<a href="https://docs.oracle.com/javase/specs/jls/se10/html/jls-13.html#jls-13.1">JLS &#XA7;13.1</a>).</p></dd><dt class="dt-description"><a href="../api/org/checkerframework/common/reflection/qual/ClassBound.html"><span style="font-weight:bold"><span style="font-family:monospace">@ClassBound</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] value)</span></span></dt><dd class="dd-description">
If an expression has <span style="font-family:monospace">@ClassBound</span> type, then its run-time value is known
to be upper-bounded by that type.
For example,
<span style="font-family:monospace">@ClassBound("java.util.HashMap")</span> indicates that the <span style="font-family:monospace">Class</span> object
represents <span style="font-family:monospace">java.util.HashMap</span> or a subclass of it.<p>If multiple arguments are given, then the run-time value is equal to or a
subclass of some class in that set.</p><p>The arguments are binary names
(<a href="https://docs.oracle.com/javase/specs/jls/se10/html/jls-13.html#jls-13.1">JLS &#XA7;13.1</a>).</p></dd><dt class="dt-description"><a href="../api/org/checkerframework/common/reflection/qual/UnknownClass.html"><span style="font-weight:bold"><span style="font-family:monospace">@UnknownClass</span></span></a></dt><dd class="dd-description"> Indicates that there is no
compile-time information about the run-time value of the class &#X2014; or
that the Java type is not <span style="font-family:monospace">Class</span>.
This is the default qualifier, and it may not be written in source code.</dd><dt class="dt-description"><a href="../api/org/checkerframework/common/reflection/qual/ClassValBottom.html"><span style="font-weight:bold"><span style="font-family:monospace">@ClassValBottom</span></span></a></dt><dd class="dd-description"> Type given to the <span style="font-family:monospace">null</span> literal.
It may not be written in source code.
</dd></dl><blockquote class="figure"><div class="center"><hr style="width:80%;height:2"></div>
<div class="center">
<img src="classval.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 22.1: Partial type hierarchy for the ClassVal type system. The type qualifiers in gray (<span style="font-family:monospace">@UnknownClass</span>
and <span style="font-family:monospace">@ClassValBottom</span>) should never be written in source code; they are used internally by the type system.</td></tr>
</table></div>
<a id="fig-classval-hierarchy"></a>
<div class="center"><hr style="width:80%;height:2"></div></blockquote>
<!--TOC subsubsection id="classval-subtyping-rules" Subtyping rules-->
<h4 id="classval-subtyping-rules" class="subsubsection">Subtyping rules <a href="#classval-subtyping-rules" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h4><!--SEC END --><p>
Figure&#XA0;<a href="#fig-classval-hierarchy">22.1</a> shows part of the type hierarchy of the
ClassVal type system.
<span style="font-family:monospace">@ClassVal(A)</span> is a subtype of <span style="font-family:monospace">@ClassVal(B)</span> if A is a subset of B.
<span style="font-family:monospace">@ClassBound(A)</span> is a subtype of <span style="font-family:monospace">@ClassBound(B)</span> if A is a subset of B.
<span style="font-family:monospace">@ClassVal(A)</span> is a subtype of <span style="font-family:monospace">@ClassBound(B)</span> if A is a subset of B.</p>
<!--TOC subsection id="methodval-checker" MethodVal Checker-->
<h3 id="methodval-checker" class="subsection">22.2.2&#XA0;&#XA0;MethodVal Checker <a href="#methodval-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The MethodVal Checker defines the following annotations:</p><dl class="description"><dt class="dt-description">
<a href="../api/org/checkerframework/common/reflection/qual/MethodVal.html"><span style="font-weight:bold"><span style="font-family:monospace">@MethodVal</span></span></a><span style="font-weight:bold"><span style="font-family:monospace">(String[] className, String[] methodName, int[] params)</span></span></dt><dd class="dd-description">
Indicates that an expression of type <span style="font-family:monospace">Method</span> or <span style="font-family:monospace">Constructor</span> has a
run-time value in a given set. If the set has size <span style="font-style:italic">n</span>, then each of
<span style="font-family:monospace">@MethodVal</span>&#X2019;s arguments is an array of size <span style="font-style:italic">n</span>, and the <span style="font-style:italic">i</span>th method in the set is
represented by { className[i], methodName[i], params[i] }.
For a constructor, the method name is &#X201C;<span style="font-family:monospace">&lt;init&gt;</span>&#X201D;.
<p>Consider the following example:</p><pre class="verbatim">@MethodVal(className={"java.util.HashMap", "java.util.HashMap"},
           methodName={"containsKey", "containsValue"},
           params={1, 1})
</pre><p>This <span style="font-family:monospace">@MethodVal</span> annotation indicates that the <span style="font-family:monospace">Method</span>
is either <span style="font-family:monospace">HashMap.containsKey</span> with 1 formal parameter or
<span style="font-family:monospace">HashMap.containsValue</span> with 1 formal parameter.</p><p>The <span style="font-family:monospace">@MethodVal</span> type qualifier indicates the number of
parameters that the method takes, but not their type. This means that the
Checker Framework&#X2019;s reflection resolution cannot distinguish among
overloaded methods.</p></dd><dt class="dt-description"><a href="../api/org/checkerframework/common/reflection/qual/UnknownMethod.html"><span style="font-weight:bold"><span style="font-family:monospace">@UnknownMethod</span></span></a></dt><dd class="dd-description"> Indicates that there is no
compile-time information about the run-time value of the method &#X2014; or
that the Java type is not <span style="font-family:monospace">Method</span> or <span style="font-family:monospace">Constructor</span>.
This is the default qualifier, and it may not be written in source code.</dd><dt class="dt-description"><a href="../api/org/checkerframework/common/reflection/qual/MethodValBottom.html"><span style="font-weight:bold"><span style="font-family:monospace">@MethodValBottom</span></span></a></dt><dd class="dd-description"> Type given to the <span style="font-family:monospace">null</span> literal.
It may not be written in source code.
</dd></dl><blockquote class="figure"><div class="center"><hr style="width:80%;height:2"></div>
<div class="center">
<img src="methodval.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 22.2: Partial type hierarchy for the MethodVal type system. The type qualifiers in gray (<span style="font-family:monospace">@UnknownMethod</span>
and <span style="font-family:monospace">@MethodValBottom</span>) should never be written in source code; they are used internally by the type system.</td></tr>
</table></div>
<a id="fig-methodval-hierarchy"></a>
<div class="center"><hr style="width:80%;height:2"></div></blockquote>
<!--TOC subsubsection id="methodval-subtyping-rules" Subtyping rules-->
<h4 id="methodval-subtyping-rules" class="subsubsection">Subtyping rules <a href="#methodval-subtyping-rules" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h4><!--SEC END --><p>
Figure&#XA0;<a href="#fig-methodval-hierarchy">22.2</a> shows part of the type hierarchy of the
MethodVal type system. <span style="font-family:monospace">@MethodVal(classname=CA, methodname=MA, params=PA)</span> is a subtype of
<span style="font-family:monospace">@MethodVal(classname=CB, methodname=MB, params=PB)</span> if</p><table class="display dcenter"><tr style="vertical-align:middle"><td class="dcell">&#X2200;&#XA0;indexes&#XA0;<span style="font-style:italic">i</span>&#XA0;&#X2203;&#XA0;an index&#XA0;<span style="font-style:italic">j</span>:&#XA0;&#XA0;<span style="font-style:italic">CA</span>[<span style="font-style:italic">i</span>]&#XA0;=&#XA0;<span style="font-style:italic">CB</span>[<span style="font-style:italic">j</span>],&#XA0;<span style="font-style:italic">MA</span>[<span style="font-style:italic">i</span>]&#XA0;=&#XA0;<span style="font-style:italic">MA</span>[<span style="font-style:italic">j</span>],&#XA0;<span style="font-style:italic">and</span>&#XA0;<span style="font-style:italic">PA</span>[<span style="font-style:italic">i</span>]&#XA0;=&#XA0;<span style="font-style:italic">PB</span>[<span style="font-style:italic">j</span>]</td></tr>
</table><p>where CA, MA, and PA are lists of equal size and CB, MB, and PB are lists of equal size.</p>
<!--TOC subsection id="methodval-and-classval-inference" MethodVal and ClassVal inference-->
<h3 id="methodval-and-classval-inference" class="subsection">22.2.3&#XA0;&#XA0;MethodVal and ClassVal inference <a href="#methodval-and-classval-inference" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The developer rarely has to write <span style="font-family:monospace">@ClassVal</span> or <span style="font-family:monospace">@MethodVal</span>
annotations, because the Checker Framework infers them according to
Figure&#XA0;<a href="#fig%3Areflection-inference">22.3</a>. Most readers can skip this
section, which explains the inference rules.</p><blockquote class="figure"><div class="center"><hr style="width:80%;height:2"></div><div class="center">
<span style="font-size:small">
<img src="manual001.png"></span>
</div><div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 22.3: <a id="fig:reflection-inference"></a>Example inference rules for @ClassVal, @ClassBound, and @MethodVal.
Additional rules exist for expressions with similar semantics but that call
methods with different names or signatures.
</td></tr>
</table></div><div class="center"><hr style="width:80%;height:2"></div></blockquote><p>The ClassVal Checker infers the exact class name (<span style="font-family:monospace">@ClassVal</span>) for a
<span style="font-family:monospace">Class</span> literal (<span style="font-family:monospace">C.class</span>), and for a static method call (e.g.,
<span style="font-family:monospace">Class.forName(arg)</span>, <span style="font-family:monospace">ClassLoader.loadClass(arg)</span>, ...) if the argument is a
statically computable expression. In contrast, it infers an upper bound
(<span style="font-family:monospace">@ClassBound</span>) for instance method calls (e.g., <span style="font-family:monospace">obj.getClass()</span>).</p><p>The MethodVal Checker infers <span style="font-family:monospace">@MethodVal</span> annotations for <span style="font-family:monospace">Method</span> and
<span style="font-family:monospace">Constructor</span> types that have been created using a method call to Java&#X2019;s Reflection
API:
</p><ul class="itemize"><li class="li-itemize">
<span style="font-family:monospace">Class.getMethod(String name, Class&lt;?&gt;...&#XA0;paramTypes)</span>
</li><li class="li-itemize"><span style="font-family:monospace">Class.getConstructor(Class&lt;?&gt;...&#XA0;paramTypes)</span>
</li></ul><p>Note that an exact class name is necessary to precisely resolve
reflectively-invoked constructors since a constructor in a subclass does not
override a constructor in its superclass. This means that the MethodVal Checker
does not infer a <span style="font-family:monospace">@MethodVal</span> annotation for <span style="font-family:monospace">Class.getConstructor</span> if the
type of that class is <span style="font-family:monospace">@ClassBound</span>. In contrast, either an exact class name or a bound
is adequate to resolve reflectively-invoked methods because of the subtyping
rules for overridden methods.</p><hr>
<!--TOC chapter id="subtyping-checker" Subtyping Checker-->
<h1 id="subtyping-checker" class="chapter">Chapter&#XA0;23&#XA0;&#XA0;Subtyping Checker <a href="#subtyping-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h1><!--SEC END --><p>The Subtyping Checker enforces only subtyping rules. It operates over
annotations specified by a user on the command line. Thus, users can
create a simple type-checker without writing any code beyond definitions of
the type qualifier annotations.</p><p>The Subtyping Checker can accommodate all of the type system enhancements that
can be declaratively specified (see Chapter&#XA0;<a href="#creating-a-checker">31</a>).
This includes type introduction rules via the
<a href="../api/org/checkerframework/framework/qual/QualifierForLiterals.html"><span style="font-family:monospace">@QualifierForLiterals</span></a> meta-annotation , and other features such as
type refinement (Section&#XA0;<a href="#type-refinement">26.7</a>) and
qualifier polymorphism (Section&#XA0;<a href="#qualifier-polymorphism">25.2</a>).</p><p>The Subtyping Checker is also useful to type system designers who wish to
experiment with a checker before writing code; the Subtyping Checker
demonstrates the functionality that a checker inherits from the Checker
Framework.</p><p>If you need typestate analysis, then you can extend a typestate checker.
For more details (including a definition of &#X201C;typestate&#X201D;), see
Chapter&#XA0;<a href="#typestate-checker">24.1</a>.
See Section&#XA0;<a href="#faq-typestate">33.7.1</a> for a simpler alternative.</p><p>For type systems that require special checks (e.g., warning about
dereferences of possibly-null values), you will need to write code and
extend the framework as discussed in Chapter&#XA0;<a href="#creating-a-checker">31</a>.</p>
<!--TOC section id="subtyping-using" Using the Subtyping Checker-->
<h2 id="subtyping-using" class="section">23.1&#XA0;&#XA0;Using the Subtyping Checker <a href="#subtyping-using" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>
The Subtyping Checker is used in the same way as other checkers (using the
<span style="font-family:monospace">-processor org.checkerframework.common.subtyping.SubtypingChecker</span> option; see Chapter&#XA0;<a href="#using-a-checker">2</a>), except that it
requires an additional annotation processor argument via the standard
&#X201C;<span style="font-family:monospace">-A</span>&#X201D; switch. You must provide one or both of the two following
command-line arguments:
</p><ul class="itemize"><li class="li-itemize">Provide the fully-qualified class name(s) of the annotation(s) in the custom
type system through the <span style="font-family:monospace">-Aquals</span> option, using a comma-no-space-separated
notation:<pre>
  javac -classpath <span style="font-style:italic">/full/path/to/myProject/bin</span>:<span style="font-style:italic">/full/path/to/myLibrary/bin</span> <span style="font-family:monospace">\</span>
        -processor org.checkerframework.common.subtyping.SubtypingChecker <span style="font-family:monospace">\</span>
        -Aquals=<span style="font-style:italic">myPackage.qual.MyQual</span>,<span style="font-style:italic">myPackage.qual.OtherQual</span> MyFile.java ...
</pre></li><li class="li-itemize">Provide the fully-qualified paths to a set of directories that contain the
annotations in the custom type system through the <span style="font-family:monospace">-AqualDirs</span> option,
using a colon-no-space-separated notation. For example:<pre>
  javac -classpath <span style="font-style:italic">/full/path/to/myProject/bin</span>:<span style="font-style:italic">/full/path/to/myLibrary/bin</span> <span style="font-family:monospace">\</span>
        -processor org.checkerframework.common.subtyping.SubtypingChecker <span style="font-family:monospace">\</span>
        -AqualDirs=<span style="font-style:italic">/full/path/to/myProject/bin</span>:<span style="font-style:italic">/full/path/to/myLibrary/bin</span> MyFile.java
</pre></li></ul><p>The annotations listed in <span style="font-family:monospace">-Aquals</span> or <span style="font-family:monospace">-AqualDirs</span> must be accessible to
the compiler during compilation in the classpath. In other words, they must
already be compiled (and, typically, be on the javac classpath)
before you run the Subtyping Checker with <span style="font-family:monospace">javac</span>. It
is not sufficient to supply their source files on the command line.</p><p><br>
</p><p>To suppress a warning issued by the Subtyping Checker, use a
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/SuppressWarnings.html"><span style="font-family:monospace">@SuppressWarnings</span></a>
annotation, with the argument being the unqualified, uncapitalized name of
any of the annotations passed to <span style="font-family:monospace">-Aquals</span>. This will suppress all
warnings, regardless of which of the annotations is involved in the
warning. (As a matter of style, you should choose one of the annotations
as your <span style="font-family:monospace">@SuppressWarnings</span> key and stick with it.)</p>
<!--TOC section id="encrypted-example" Subtyping Checker example-->
<h2 id="encrypted-example" class="section">23.2&#XA0;&#XA0;Subtyping Checker example<a id="subtyping-example"></a> <a href="#subtyping-example" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>Consider a hypothetical <span style="font-family:monospace">Encrypted</span> type qualifier, which denotes that the
representation of an object (such as a <span style="font-family:monospace">String</span>, <span style="font-family:monospace">CharSequence</span>, or
<span style="font-family:monospace">byte[]</span>) is encrypted. To use the Subtyping Checker for the <span style="font-family:monospace">Encrypted</span>
type system, follow three steps.</p><ol class="enumerate" type=1><li class="li-enumerate">
Define two annotations for the <span style="font-family:monospace">Encrypted</span> and <span style="font-family:monospace">PossiblyUnencrypted</span> qualifiers:<pre>
package <span style="font-style:italic">myPackage</span>.qual;

import java.lang.annotation.ElementType;
import java.lang.annotation.Target;

/**
 * Denotes that the representation of an object is encrypted.
 */
@SubtypeOf(PossiblyUnencrypted.class)
@DefaultFor({TypeUseLocation.LOWER_BOUND})
@Target({ElementType.TYPE_USE, ElementType.TYPE_PARAMETER})
public @interface Encrypted {}
</pre><pre>
package <span style="font-style:italic">myPackage</span>.qual;

import org.checkerframework.framework.qual.DefaultQualifierInHierarchy;
import org.checkerframework.framework.qual.SubtypeOf;
import java.lang.annotation.ElementType;
import java.lang.annotation.Target;

/**
 * Denotes that the representation of an object might not be encrypted.
 */
@DefaultQualifierInHierarchy
@SubtypeOf({})
@Target({ElementType.TYPE_USE, ElementType.TYPE_PARAMETER})
public @interface PossiblyUnencrypted {}
</pre><p>Note that all custom annotations must have the
<span style="font-family:monospace">@Target(ElementType.TYPE_USE)</span> meta-annotation.
See Section&#XA0;<a href="#creating-define-type-qualifiers">31.4.1</a>.</p><p>Don&#X2019;t forget to compile these classes:</p><pre class="verbatim">$ javac myPackage/qual/Encrypted.java myPackage/qual/PossiblyUnencrypted.java
</pre><p>The resulting <span style="font-family:monospace">.class</span> files should either be on your classpath, or on the
processor path (set via the <span style="font-family:monospace">-processorpath</span> command-line option to javac).</p></li><li class="li-enumerate">Write <span style="font-family:monospace">@Encrypted</span> annotations in your program (say, in file
<span style="font-family:monospace">YourProgram.java</span>):<pre>
import <span style="font-style:italic">myPackage</span>.qual.Encrypted;

...

public @Encrypted String encrypt(String text) {
    // ...
}

// Only send encrypted data!
public void sendOverInternet(@Encrypted String msg) {
    // ...
}

void sendText() {
    // ...
    @Encrypted String ciphertext = encrypt(plaintext);
    sendOverInternet(ciphertext);
    // ...
}

void sendPassword() {
    String password = getUserPassword();
    sendOverInternet(password);
}
</pre><p>You may also need to add <span style="font-family:monospace">@SuppressWarnings</span> annotations to the
<span style="font-family:monospace">encrypt</span> and <span style="font-family:monospace">decrypt</span> methods. Analyzing them is beyond the
capability of any realistic type system.</p></li><li class="li-enumerate">Invoke the compiler with the Subtyping Checker, specifying the
<span style="font-family:monospace">@Encrypted</span> annotation using the <span style="font-family:monospace">-Aquals</span> option.
You should add the <span style="font-family:monospace">Encrypted</span> classfile to the processor classpath:<pre>
  javac -processorpath <span style="font-style:italic">myqualpath</span> -processor org.checkerframework.common.subtyping.SubtypingChecker 
        -Aquals=<span style="font-style:italic">myPackage.qual.Encrypted</span>,<span style="font-style:italic">myPackage.qual.PossiblyUnencrypted</span> YourProgram.java

YourProgram.java:42: incompatible types.
found   : @myPackage.qual.PossiblyUnencrypted java.lang.String
required: @myPackage.qual.Encrypted java.lang.String
    sendOverInternet(password);
                     ^
</pre></li><li class="li-enumerate">You can also provide the fully-qualified paths to a set of directories
that contain the qualifiers using the <span style="font-family:monospace">-AqualDirs</span> option, and add
the directories to the boot classpath, for example:<pre>
  javac -classpath <span style="font-style:italic">/full/path/to/myProject/bin</span>:<span style="font-style:italic">/full/path/to/myLibrary/bin</span> <span style="font-family:monospace">\</span>
        -processor org.checkerframework.common.subtyping.SubtypingChecker <span style="font-family:monospace">\</span>
        -AqualDirs=<span style="font-style:italic">/full/path/to/myProject/bin</span>:<span style="font-style:italic">/full/path/to/myLibrary/bin</span> YourProgram.java
</pre><p>
Note that in these two examples, the compiled class file of the
<span style="font-family:monospace">myPackage.qual.Encrypted</span> and <span style="font-family:monospace">myPackage.qual.PossiblyUnencrypted</span> annotations
must exist in either the <span style="font-family:monospace">myProject/bin</span> directory or the <span style="font-family:monospace">myLibrary/bin</span>
directory. The following placement of the class files will work with the above
commands:
</p><pre>
  .../myProject/bin/myPackage/qual/Encrypted.class
  .../myProject/bin/myPackage/qual/PossiblyUnencrypted.class
</pre></li></ol><p>Also, see the example project in the <span style="font-family:monospace">docs/examples/subtyping-extension</span> directory.</p>
<!--TOC section id="subtyping-type-alias" Type aliases and typedefs-->
<h2 id="subtyping-type-alias" class="section">23.3&#XA0;&#XA0;Type aliases and typedefs <a href="#subtyping-type-alias" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>A type alias or typedef is a type that shares the same representation as
another type but is conceptually distinct from it. For example, some
strings in your program may be street addresses; others may be passwords;
and so on. You wish to indicate, for each string, which one it is, and to
avoid mixing up the different types of strings. Likewise, you could
distinguish integers that are offsets from those that are absolute values.</p><p>Creating a new type makes your code easier to understand by conveying the
intended use of each variable. It also prevents errors that come from
using the wrong type or from mixing incompatible types in an operation.</p><p>If you want to create a type alias or typedef, you have multiple options:
a regular Java subtype,
the Units Checker (Chapter&#XA0;<a href="#units-checker">17</a>),
the Fake Enum Checker (Chapter&#XA0;<a href="#fenum-checker">9</a>), or
the Subtyping Checker.</p><p>A Java subtype is easy to create and does not require a tool such as the
Checker Framework; for instance, you would declare <span style="font-family:monospace">class Address extends
String</span>. There are a number of limitations to this &#X201C;pseudo-typedef&#X201D;,
however&#XA0;[<a href="#Goetz2006%3Atypedef">Goe06</a>].
Primitive types and final types (including <span style="font-family:monospace">String</span>) cannot be extended.
Equality and identity tests can return incorrect results when a wrapper
object is used. Existing return types in code would need to be changed,
which is easy with an annotation but disruptive to change the Java type.
Therefore, it is best to avoid the pseudo-typedef antipattern.</p><p>The Units Checker (Chapter&#XA0;<a href="#units-checker">17</a>) is useful for the
particular case of units of measurement, such as kilometers verses miles.</p><p>The Fake Enum Checker (Chapter&#XA0;<a href="#fenum-checker">9</a>)
builds in a set of assumptions. If those fit your
use case, then it&#X2019;s easiest to use the Fake Enum Checker (though you can
achieve them using the Subtyping Checker). The Fake Enum Checker forbids
mixing of fenums of different types, or fenums and unannotated types. For
instance, binary operations other than string concatenations are forbidden,
such as <span style="font-family:monospace">NORTH+1</span>, <span style="font-family:monospace">NORTH+MONDAY</span>, and <span style="font-family:monospace">NORTH==MONDAY</span>. However,
<span style="font-family:monospace">NORTH+SOUTH</span> is permitted.</p><p>By default, the Subtyping Checker does not forbid any operations.</p><p>If you choose to use the Subtyping Checker, then you have an additional
design choice to make about the type system. In the general case, your
type system will look something like Figure&#XA0;<a href="#fig-typedef-hierarchy">23.1</a>.</p><blockquote class="figure"><div class="center"><hr style="width:80%;height:2"></div>
<div class="center">
<img src="typedef.svg">
</div>
<div class="caption"><table style="border-spacing:6px;border-collapse:separate;" class="cellpading0"><tr><td style="vertical-align:top;text-align:left;" >Figure 23.1: Type system for a type alias or typedef type system.
The type system designer may choose to omit some of these types, but
this is the general case.
The type system designer&#X2019;s choice of defaults affects the interpretation
of unannotated code, which affects the guarantees given for unannotated code.
<a id="fig-typedef-hierarchy"></a></td></tr>
</table></div>
<div class="center"><hr style="width:80%;height:2"></div></blockquote><p>References whose type is <span style="font-family:monospace">@MyType</span> are known to store only values from
your new type. There is no such guarantee for <span style="font-family:monospace">@MyTypeUnknown</span> and
<span style="font-family:monospace">@NotMyType</span>, but those types mean different things. An expression of type
<span style="font-family:monospace">@NotMyType</span> is guaranteed never to evaluate to a value of your new type.
An expression of type <span style="font-family:monospace">@MyTypeUnknown</span> may evaluate to any value &#X2014;
including values of your new type and values not of your new type.
(<span style="font-family:monospace">@MyTypeBottom</span> is the type of <span style="font-family:monospace">null</span> and is also used for dead code and
erroneous situations; it can be ignored for this
discussion.)</p><p>A key choice for the type system designer is which type is the default.
That is, if a programmer does not write <span style="font-family:monospace">@MyType</span> on a given type use,
should that type use be interpreted as <span style="font-family:monospace">@MyTypeUnknown</span> or as
<span style="font-family:monospace">@NotMyType</span>?</p><ul class="itemize"><li class="li-itemize">
If unannotated types are interpreted as <span style="font-family:monospace">@NotMyType</span>, then the type system
enforces very strong separation between your new type and all other types.
Values of your type will never mix with values of other types. If you
don&#X2019;t see <span style="font-family:monospace">@MyType</span> written explicitly on a type, you will know that
it does not contain values of your type.</li><li class="li-itemize">If unannotated types are interpreted as <span style="font-family:monospace">@MyTypeUnknown</span>, then
a generic, unannotated type may contain a value of your new type.
In this case, <span style="font-family:monospace">@NotMyType</span> does not need to exist, and <span style="font-family:monospace">@MyTypeBottom</span>
may or may not exist in your type system.
</li></ul><p>A downside of the stronger guarantee that comes from using <span style="font-family:monospace">@NotMyType</span> as
the default is the need to write additional annotations.
For example, if <span style="font-family:monospace">@NotMyType</span> is the default, this code does not typecheck:</p><pre class="verbatim">void method(Object o) { ... }
&lt;U&gt; void use(List&lt;U&gt; list) {
  method(list.get(0));
}
</pre><p>Because (implicit) upper bounds are interpreted as the top type (see
Section&#XA0;<a href="#generics-defaults">25.1.2</a>), this is interpreted as</p><pre class="verbatim">void method(@NotMyType Object o) { ... }
&lt;@U extends @MyTypeUnknown Object&gt; void use(List&lt;U&gt; list) {
  // type error: list.get(0) has type @MyTypeUnknown, method expects @NotMyType
  method(list.get(0));
}
</pre><p>To make the code type-check, it is necessary to write an explicit
annotation, either to restrict <span style="font-family:monospace">use</span>&#X2019;s argument or to expand <span style="font-family:monospace">method</span>&#X2019;s
parameter type.</p><hr>
<!--TOC chapter id="external-checkers" Third-party checkers-->
<h1 id="external-checkers" class="chapter">Chapter&#XA0;24&#XA0;&#XA0;Third-party checkers<a id="third-party-checkers"></a> <a href="#third-party-checkers" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h1><!--SEC END --><p>The Checker Framework has been used to build other checkers that are not
distributed together with the framework. This chapter mentions just a few
of them. They are listed in chronological order; older ones appear first
and newer ones appear last.</p><p>They are externally-maintained, so if you have problems or questions, you
should contact their maintainers rather than the Checker Framework
maintainers.</p><p>If you want this chapter to reference your checker,
please send us a link and a short description.</p>
<!--TOC section id="typestate-checker" Typestate checkers-->
<h2 id="typestate-checker" class="section">24.1&#XA0;&#XA0;Typestate checkers <a href="#typestate-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>In a regular type system, a variable has the same type throughout its
scope.
In a typestate system, a variable&#X2019;s type can change as operations
are performed on it.</p><p>The most common example of typestate is for a <span style="font-family:monospace">File</span> object. Assume a file
can be in two states, <span style="font-family:monospace">@Open</span> and <span style="font-family:monospace">@Closed</span>. Calling the <span style="font-family:monospace">close()</span> method
changes the file&#X2019;s state. Any subsequent attempt to read, write, or close
the file will lead to a run-time error. It would be better for the type
system to warn about such problems, or guarantee their absence, at compile
time.</p><p>Just as you can extend the Subtyping Checker to create a type-checker, you can
extend a typestate checker to create a type-checker that supports typestate
analysis. An extensible typestate analysis by Adam Warski that builds on
the Checker Framework is available at
<a href="http://www.warski.org/typestate.html"><span style="font-family:monospace">http://www.warski.org/typestate.html</span></a>.</p>
<!--TOC subsection id="typestate-vs-type-refinement" Comparison to flow-sensitive type refinement-->
<h3 id="typestate-vs-type-refinement" class="subsection">24.1.1&#XA0;&#XA0;Comparison to flow-sensitive type refinement <a href="#typestate-vs-type-refinement" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The Checker Framework&#X2019;s flow-sensitive type refinement
(Section&#XA0;<a href="#type-refinement">26.7</a>) implements a form of typestate analysis.
For example, after code that tests a variable against null, the Nullness
Checker (Chapter&#XA0;<a href="#nullness-checker">3</a>) treats the variable&#X2019;s type as
<span style="font-family:monospace">@NonNull </span><span style="font-family:monospace"><em>T</em></span>, for some <span style="font-family:monospace"><em>T</em></span>.</p><p>For many type systems, flow-sensitive type refinement is sufficient. But
sometimes, you need full typestate analysis. This section compares the
two.
(Unused variables
(Section&#XA0;<a href="#unused-fields">26.10</a>)
also have similarities
with typestate analysis and can occasionally substitute for it. For
brevity, this discussion omits them.)</p><p>A typestate analysis is easier for a user to create or extend.
Flow-sensitive type refinement is built into the Checker Framework and is
optionally extended by each checker. Modifying the rules requires writing
Java code in your checker. By contrast, it is possible to write a simple
typestate checker declaratively, by writing annotations on the methods
(such as <span style="font-family:monospace">close()</span>) that change a reference&#X2019;s typestate.</p><p>A typestate analysis can change a reference&#X2019;s type to something that is not
consistent with its original definition. For example, suppose that a
programmer decides that the <span style="font-family:monospace">@Open</span> and <span style="font-family:monospace">@Closed</span> qualifiers are
incomparable &#X2014; neither is a subtype of the other. A typestate analysis
can specify that the <span style="font-family:monospace">close()</span> operation converts an <span style="font-family:monospace">@Open File</span> into a
<span style="font-family:monospace">@Closed File</span>. By contrast, flow-sensitive type refinement can only give
a new type that is a subtype of the declared type &#X2014; for flow-sensitive
type refinement to be effective, <span style="font-family:monospace">@Closed</span> would need to be a child of
<span style="font-family:monospace">@Open</span> in the qualifier hierarchy (and <span style="font-family:monospace">close()</span> would need to be
treated specially by the checker).
</p>
<!--TOC section id="units-and-dimensions-checker" Units and dimensions checker-->
<h2 id="units-and-dimensions-checker" class="section">24.2&#XA0;&#XA0;Units and dimensions checker <a href="#units-and-dimensions-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>A checker for units and dimensions is available at
<a href="https://www.lexspoon.org/expannots/"><span style="font-family:monospace">https://www.lexspoon.org/expannots/</span></a>.</p><p>Unlike the Units Checker that is distributed with the Checker Framework
(see Section&#XA0;<a href="#units-checker">17</a>), this checker includes dynamic checks and
permits annotation arguments that are Java expressions. This added
flexibility, however, requires that you use a special version both of the
Checker Framework and of the javac compiler.</p>
<!--TOC section id="loci-thread-locality-checker" Thread locality checker-->
<h2 id="loci-thread-locality-checker" class="section">24.3&#XA0;&#XA0;Thread locality checker <a href="#loci-thread-locality-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>Loci&#XA0;[<a href="#WrigstadPMZV2009">WPM+09</a>], a checker for thread locality, is available at
<a href="http://www.it.uu.se/research/upmarc/loci/"><span style="font-family:monospace">http://www.it.uu.se/research/upmarc/loci/</span></a>.
</p>
<!--TOC section id="safety-critical-java-checker" Safety-Critical Java checker-->
<h2 id="safety-critical-java-checker" class="section">24.4&#XA0;&#XA0;Safety-Critical Java checker <a href="#safety-critical-java-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>A checker for Safety-Critical Java (SCJ, JSR 302)&#XA0;[<a href="#TangPJ2010">TPV10</a>] is available at
<a href="https://www.cs.purdue.edu/sss/projects/oscj/checker/checker.html"><span style="font-family:monospace">https://www.cs.purdue.edu/sss/projects/oscj/checker/checker.html</span></a>.
Developer resources are available at the project page
<a href="https://code.google.com/archive/p/scj-jsr302/"><span style="font-family:monospace">https://code.google.com/archive/p/scj-jsr302/</span></a>.</p>
<!--TOC section id="gut-checker" Generic Universe Types checker-->
<h2 id="gut-checker" class="section">24.5&#XA0;&#XA0;Generic Universe Types checker <a href="#gut-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>A checker for Generic Universe Types&#XA0;[<a href="#DietlEM2011">DEM11</a>], a lightweight ownership type
system, is available from
<a href="https://ece.uwaterloo.ca/~wdietl/ownership/"><span style="font-family:monospace">https://ece.uwaterloo.ca/~wdietl/ownership/</span></a>.</p>
<!--TOC section id="enerj-checker" EnerJ checker-->
<h2 id="enerj-checker" class="section">24.6&#XA0;&#XA0;EnerJ checker <a href="#enerj-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>A checker for EnerJ&#XA0;[<a href="#SampsonDFGCG2011">SDF+11</a>], an extension to Java that exposes hardware faults
in a safe, principled manner to save energy with only
slight sacrifices to the quality of service, is available from
<a href="http://sampa.cs.washington.edu/research/approximation/enerj.html"><span style="font-family:monospace">http://sampa.cs.washington.edu/research/approximation/enerj.html</span></a>.</p>
<!--TOC section id="checklt-checker" CheckLT taint checker-->
<h2 id="checklt-checker" class="section">24.7&#XA0;&#XA0;CheckLT taint checker <a href="#checklt-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>CheckLT uses taint tracking to detect illegal information flows, such as
unsanitized data that could result in a SQL injection attack.
CheckLT is available from <a href="http://checklt.github.io/"><span style="font-family:monospace">http://checklt.github.io/</span></a>.</p>
<!--TOC section id="sparta-checker" SPARTA information flow type-checker for Android-->
<h2 id="sparta-checker" class="section">24.8&#XA0;&#XA0;SPARTA information flow type-checker for Android <a href="#sparta-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>SPARTA is a security toolset aimed at preventing malware from appearing in
an app store. SPARTA provides an information-flow type-checker that is
customized to Android but can also be applied to other domains.
The SPARTA toolset is available from
<a href="https://checkerframework.org/sparta/"><span style="font-family:monospace">https://checkerframework.org/sparta/</span></a>.
The paper
<a href="https://homes.cs.washington.edu/~mernst/pubs/infoflow-ccs2014.pdf">&#X201C;Collaborative
verification of information flow for a high-assurance app store&#X201D;</a>
appeared in CCS 2014.</p>
<!--TOC section id="javari-checker" Immutability checkers: IGJ, OIGJ, and Javari-->
<h2 id="javari-checker" class="section">24.9&#XA0;&#XA0;Immutability checkers: IGJ, OIGJ, and Javari<a id="igj-checker"></a> <a href="#igj-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>Javari&#XA0;[<a href="#TschantzE2005">TE05</a>], IGJ&#XA0;[<a href="#ZibinPAAKE2007">ZPA+07</a>], and
OIGJ&#XA0;[<a href="#ZibinPLAE2010">ZPL+10</a>] are type systems that enforce immutability
constraints. Type-checkers for all three type systems were distributed
with the Checker Framework through release 1.9.13 (dated 1 April 2016).
If you wish to use them, install
<a href="https://checkerframework.org/releases/1.9.13/">Checker
Framework version 1.9.13</a>.</p><p>They were removed from the main distribution on June 1, 2016 because the
implementations were not being maintained as the Checker Framework evolved.
The type systems are valuable, and some people found the type-checkers
useful. However,
we wanted
to focus on distributing checkers that are currently being maintained.</p>
<!--TOC section id="initialization-rawness-checker" Nullness Rawness Checker-->
<h2 id="initialization-rawness-checker" class="section">24.10&#XA0;&#XA0;Nullness Rawness Checker <a href="#initialization-rawness-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The Nullness Rawness Checker is a nullness checker that uses a different type system for initialization.
It was distributed with the Checker Framework through release 2.9.0 (dated 3 July 2019). If you wish
to use them, install <a href="https://checkerframework.org/releases/2.9.0/">Checker Framework version 2.9.0</a>.</p>
<!--TOC section id="read-checker" Read Checker for CERT FIO08-J-->
<h2 id="read-checker" class="section">24.11&#XA0;&#XA0;Read Checker for CERT FIO08-J <a href="#read-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>CERT
rule <a href="https://www.securecoding.cert.org/confluence/display/java/FIO08-J.+Distinguish+between+characters+or+bytes+read+from+a+stream+and+-1">FIO08-J</a>
describes a rule for the correct handling of characters/bytes read
from a stream.</p><p>The Read Checker enforces this rule.
It is available from
<a href="https://github.com/opprop/ReadChecker"><span style="font-family:monospace">https://github.com/opprop/ReadChecker</span></a>.</p>
<!--TOC section id="sql-schecker" SQL checker that supports multiple dialects-->
<h2 id="sql-schecker" class="section">24.12&#XA0;&#XA0;SQL checker that supports multiple dialects <a href="#sql-schecker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p><a href="http://www.jooq.org/">jOOQ</a> is a database API that lets you build
typesafe SQL queries. jOOQ version 3.0.9 and later ships with a SQL
checker that provides even more safety: it ensures that you don&#X2019;t
use SQL features that are not supported by your database
implementation. You can learn about the SQL checker at
<a href="https://blog.jooq.org/2016/05/09/jsr-308-and-the-checker-framework-add-even-more-typesafety-to-jooq-3-9/"><span style="font-family:monospace">https://blog.jooq.org/2016/05/09/jsr-308-and-the-checker-framework-add-even-more-typesafety-to-jooq-3-9/</span></a>.</p>
<!--TOC section id="glacier-immutability-checker" Glacier: Class immutability-->
<h2 id="glacier-immutability-checker" class="section">24.13&#XA0;&#XA0;Glacier: Class immutability <a href="#glacier-immutability-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p><a href="http://mcoblenz.github.io/Glacier/">Glacier</a>&#XA0;[<a href="#CoblenzNAMS2017">CNA+17</a>]
enforces transitive class immutability in Java. According to its webpage:</p><ul class="itemize"><li class="li-itemize">
Transitive: if a class is immutable, then every field must be
immutable. This means that all reachable state from an immutable object&#X2019;s
fields is immutable.
</li><li class="li-itemize">Class: the immutability of an object depends only on its class&#X2019;s
immutability declaration.
</li><li class="li-itemize">Immutability: state in an object is not changable through any reference to
the object.
</li></ul>
<!--TOC section id="rx-thread-checker" UI Thread Checker for ReactiveX-->
<h2 id="rx-thread-checker" class="section">24.14&#XA0;&#XA0;UI Thread Checker for ReactiveX <a href="#rx-thread-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The <a href="https://plv.colorado.edu/benno/ase18.pdf">Rx Thread &amp; Effect Checker</a>&#XA0;[<a href="#SteinCSC2018">SCSC18</a>] enforces
UI Thread safety properties for stream-based Android applications and is available at
<a href="https://github.com/uber-research/RxThreadEffectChecker"><span style="font-family:monospace">https://github.com/uber-research/RxThreadEffectChecker</span></a>.</p>
<!--TOC section id="kms-compliance-checker" AWS KMS compliance checker-->
<h2 id="kms-compliance-checker" class="section">24.15&#XA0;&#XA0;AWS KMS compliance checker <a href="#kms-compliance-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The <a href="https://github.com/awslabs/aws-kms-compliance-checker">AWS KMS
compliance checker</a> extends the Constant Value Checker (see
Chapter&#XA0;<a href="#constant-value-checker">21</a>) to enforce that calls to Amazon
Web Services&#X2019; Key Management System only request 256-bit (or longer) data
keys. This checker can be used to help enforce a compliance requirement
(such as from SOC or PCI-DSS) that customer data is always encrypted with
256-bit keys.</p><p>The KMS compliance checker is available in Maven Central. To use it in
<span style="font-family:monospace">build.gradle</span>, add the following dependency:</p><pre class="verbatim">compile group: 'software.amazon.checkerframework', name: 'aws-kms-compliance-checker', version: '1.0.2'
</pre><p><a href="https://mvnrepository.com/artifact/software.amazon.checkerframework/aws-kms-compliance-checker/1.0.2">Other build systems</a> are similar.</p>
<!--TOC section id="crypto-policy-compliance-checker" AWS crypto policy compliance checker-->
<h2 id="crypto-policy-compliance-checker" class="section">24.16&#XA0;&#XA0;AWS crypto policy compliance checker <a href="#crypto-policy-compliance-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The
<a href="https://github.com/awslabs/aws-crypto-policy-compliance-checker">AWS
crypto policy compliance checker</a> checks that no weak cipher algorithms
are used with the Java crypto API.</p><hr>
<!--TOC chapter id="polymorphism" Generics and polymorphism-->
<h1 id="polymorphism" class="chapter">Chapter&#XA0;25&#XA0;&#XA0;Generics and polymorphism <a href="#polymorphism" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h1><!--SEC END --><p>This chapter describes support for Java generics (also known as
&#X201C;parametric polymorphism&#X201D;) and polymorphism over type qualifiers.</p><p>Section&#XA0;<a href="#qualifier-polymorphism">25.2</a> describes support for polymorphism over
type qualifiers.</p>
<!--TOC section id="generics" Generics (parametric polymorphism or type polymorphism)-->
<h2 id="generics" class="section">25.1&#XA0;&#XA0;Generics (parametric polymorphism or type polymorphism) <a href="#generics" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The Checker Framework fully supports
type-qualified Java generic types and methods (also known as &#X201C;parametric
polymorphism&#X201D;).
When instantiating a generic type,
clients supply the qualifier along with the type argument, as in
<span style="font-family:monospace">List&lt;@NonNull String&gt;</span>.
When using a type variable <span style="font-family:monospace">T</span> within the implementation of a generic type,
typically no type qualifier is written (see Section&#XA0;<a href="#type-variable-use">25.1.3</a>);
rather, the instantiation of the type parameter is restricted (see
Section&#XA0;<a href="#generics-instantiation">25.1.2</a>).</p>
<!--TOC subsection id="generics-raw-types" Raw types-->
<h3 id="generics-raw-types" class="subsection">25.1.1&#XA0;&#XA0;Raw types <a href="#generics-raw-types" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Before running any pluggable type-checker, we recommend that you eliminate
raw types from your code (e.g., your code should use <span style="font-family:monospace">List&lt;...&gt;</span> as
opposed to <span style="font-family:monospace">List</span>).
Your code should compile without warnings when using the standard Java
compiler and the <span style="font-family:monospace">-Xlint:unchecked -Xlint:rawtypes</span> command-line options.
Using generics helps prevent type errors just as using a pluggable
type-checker does, and makes the Checker Framework&#X2019;s warnings easier to
understand.</p><p>If your code uses raw types, then the Checker Framework will do its best to
infer the Java type parameters and the type qualifiers. If it infers
imprecise types that lead to type-checking warnings elsewhere, then you have
two options. You can convert the raw types such as <span style="font-family:monospace">List</span> to
parameterized types such as <span style="font-family:monospace">List&lt;String&gt;</span>, or you can supply the
<span style="font-family:monospace">-AignoreRawTypeArguments</span> command-line option. That option causes the
Checker Framework to ignore all subtype tests for type arguments that
were inferred for a raw type.</p>
<!--TOC subsection id="generics-instantiation" Restricting instantiation of a generic class-->
<h3 id="generics-instantiation" class="subsection">25.1.2&#XA0;&#XA0;Restricting instantiation of a generic class <a href="#generics-instantiation" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>When you define a generic class in Java, the <span style="font-family:monospace">extends</span> clause
of the generic type parameter (known as the &#X201C;upper bound&#X201D;) requires that
the corresponding type argument must be a subtype of the bound.
For example, given the definition
<code>class G&lt;T extends Number&gt; {...}</code>,
the upper bound is <span style="font-family:monospace">Number</span>
and a client can instantiate it as <span style="font-family:monospace">G&lt;Number&gt;</span> or <span style="font-family:monospace">G&lt;Integer&gt;</span>
but not <span style="font-family:monospace">G&lt;Date&gt;</span>.</p><p>You can write a type qualifier on the <span style="font-family:monospace">extends</span> clause to make the upper
bound a qualified type. For example, you can declare that a generic list class can hold only non-null values:
</p><pre class="verbatim">  class MyList&lt;T extends @NonNull Object&gt; {...}

  MyList&lt;@NonNull String&gt; m1;       // OK
  MyList&lt;@Nullable String&gt; m2;      // error
</pre><p>That is, in the above example, all
arguments that replace <span style="font-family:monospace">T</span> in <span style="font-family:monospace">MyList&lt;T&gt;</span> must be subtypes of
<span style="font-family:monospace">@NonNull Object</span>.</p>
<!--TOC subsubsection id="generics-bounds-syntax" Syntax for upper and lower bounds-->
<h4 id="generics-bounds-syntax" class="subsubsection">Syntax for upper and lower bounds <a href="#generics-bounds-syntax" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h4><!--SEC END --><p>Conceptually, each generic type parameter has two bounds &#X2014; a lower bound
and an upper bound &#X2014; and at instantiation, the type argument must be
within the bounds. Java only allows you to specify the upper bound; the
lower bound is implicitly the bottom type <span style="font-family:monospace">void</span>. The Checker Framework
gives you more power: you can specify both an upper and lower bound for
type parameters.
Write the upper bound on the <span style="font-family:monospace">extends</span> clause, and
write the lower bound on the type variable.</p><pre class="verbatim">  class MyList&lt;@LowerBound T extends @UpperBound Object&gt; { ... }
</pre><p>You may omit either the upper or the lower bound, and the Checker Framework
will use a default.</p><p>For a discussion of wildcards, see Section&#XA0;<a href="#annotations-on-wildcards">25.1.4</a>.</p><p>For a concrete example, recall the type system of the Regex Checker (see
Figure&#XA0;<a href="#fig-regex-hierarchy">11.1</a>) in which
<span style="font-family:monospace">@Regex(0)</span> :&gt;
<span style="font-family:monospace">@Regex(1)</span> :&gt;
<span style="font-family:monospace">@Regex(2)</span> :&gt;
<span style="font-family:monospace">@Regex(3)</span> :&gt; &#X2026;.</p><pre class="verbatim">  class MyRegexes&lt;@Regex(5) T extends @Regex(1) String&gt; { ... }

  MyRegexes&lt;@Regex(0) String&gt; mu;   // error - @Regex(0) is not a subtype of @Regex(1)
  MyRegexes&lt;@Regex(1) String&gt; m1;   // OK
  MyRegexes&lt;@Regex(3) String&gt; m3;   // OK
  MyRegexes&lt;@Regex(5) String&gt; m5;   // OK
  MyRegexes&lt;@Regex(6) String&gt; m6;   // error - @Regex(6) is not a supertype of @Regex(5)
</pre><p>The above declaration states that the upper bound of the type variable
is <span style="font-family:monospace">@Regex(1) String</span> and the lower bound is <span style="font-family:monospace">@Regex(5) void</span>. That is,
arguments that replace <span style="font-family:monospace">T</span> in <span style="font-family:monospace">MyList&lt;T&gt;</span> must be subtypes of
<span style="font-family:monospace">@Regex(1) String</span> and supertypes of <span style="font-family:monospace">@Regex(5) void</span>.
Since <span style="font-family:monospace">void</span> cannot be used to instantiate a generic class, <span style="font-family:monospace">MyList</span> may
be instantiated with <span style="font-family:monospace">@Regex(1) String</span> through <span style="font-family:monospace">@Regex(5) String</span>.</p><p>To specify an exact bound, place the same annotation on both bounds. For example:</p><pre class="verbatim">  class MyListOfNonNulls&lt;@NonNull T extends @NonNull Object&gt; { ... }
  class MyListOfNullables&lt;@Nullable T extends @Nullable Object&gt; { ... }

  MyListOfNonNulls&lt;@NonNull Number&gt; v1;      // OK
  MyListOfNonNulls&lt;@Nullable Number&gt; v2;     // error
  MyListOfNullables&lt;@NonNull Number&gt; v4;     // error
  MyListOfNullables&lt;@Nullable Number&gt; v3;    // OK
</pre><p>It is an error if the lower bound is not a subtype of the upper bound.</p><pre class="verbatim">  class MyClass&lt;@Nullable T extends @NonNull Object&gt;  // error: @Nullable is not a supertype of @NonNull
</pre>
<!--TOC subsubsection id="generics-defaults" Defaults-->
<h4 id="generics-defaults" class="subsubsection">Defaults <a href="#generics-defaults" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h4><!--SEC END --><p>A generic type parameter or wildcard is written as <span style="font-family:monospace">class
MyClass&lt;</span><span style="font-family:monospace"><em>@LowerBound</em></span><span style="font-family:monospace"> T extends </span><span style="font-family:monospace"><em>@UpperBound</em></span><span style="font-family:monospace"> JavaUpperBound&gt;</span> or as
<span style="font-family:monospace">MyClass&lt;</span><span style="font-family:monospace"><em>@UpperBound</em></span><span style="font-family:monospace"> ? super </span><span style="font-family:monospace"><em>@LowerBound</em></span><span style="font-family:monospace"> JavaLowerBound&gt;</span>, where
&#X201C;<span style="font-family:monospace"><em>@LowerBound</em></span>&#X201D; and &#X201C;<span style="font-family:monospace"><em>@UpperBound</em></span>&#X201D; are type qualifiers.</p><p>For lower bounds:
If no type annotation is written in front of <span style="font-family:monospace">?</span>,
then the lower bound defaults to <span style="font-family:monospace">@</span><span style="font-family:monospace"><em>BottomType</em></span><span style="font-family:monospace"> void</span>.</p><p>For upper bounds:
</p><ul class="itemize"><li class="li-itemize">
If the <span style="font-family:monospace">extends</span> clause is omitted,
then the upper bound defaults to <span style="font-family:monospace">@</span><span style="font-family:monospace"><em>TopType</em></span><span style="font-family:monospace"> Object</span>.
</li><li class="li-itemize">If the <span style="font-family:monospace">extends</span> clause is written but contains no type qualifier,
then the normal defaulting rules apply to the type in the <span style="font-family:monospace">extends</span>
clause (see Section&#XA0;<a href="#climb-to-top">26.5.3</a>).
</li></ul><p>The upper-bound rules mean that even though in Java the following two
declarations are equivalent:</p><pre class="verbatim">  class MyClass&lt;T&gt;
  class MyClass&lt;T extends Object&gt;
</pre><p>they specify different type qualifiers on the upper bound,
if the type system&#X2019;s default annotation is not its top annotation.</p><p>The Nullness type system is an example.</p><pre class="verbatim">  class MyClass&lt;T&gt;                 ==  class MyClass&lt;T extends @Nullable Object&gt;
  class MyClass&lt;T extends Object&gt;  ==  class MyClass&lt;T extends @NonNull Object&gt;
</pre><p>The rationale for this choice is:
</p><ul class="itemize"><li class="li-itemize">
The &#X201C;<span style="font-family:monospace">&lt;T&gt;</span>&#X201D; in <span style="font-family:monospace">MyClass&lt;T&gt;</span> means &#X201C;fully unconstrained&#X201D;,
and the rules maintain that, without the need for a programmer to
change existing code.
</li><li class="li-itemize">The &#X201C;<span style="font-family:monospace">Object</span>&#X201D; in <span style="font-family:monospace">MyClass&lt;T extends Object&gt;</span> is treated
exactly like every other occurrence of <span style="font-family:monospace">Object</span> in the program &#X2014;
it would be confusing for different occurrences of <span style="font-family:monospace">Object</span> to mean
different annotated types.
</li></ul><p>Because of these rules, the recommended style is:
</p><ul class="itemize"><li class="li-itemize">
Use &#X201C;<span style="font-family:monospace">&lt;T&gt;</span>&#X201D; when there are no constraints on the type qualifiers.
This is short and is what already appears in source code.
</li><li class="li-itemize">Whenever you write an <span style="font-family:monospace">extends</span> clause, write an explicit type
annotation on it. For example, for the Nullness Checker, write
<span style="font-family:monospace">class MyClass&lt;T&gt;</span> rather than <span style="font-family:monospace">class MyClass&lt;T extends
@Nullable Object&gt;</span>, and write <span style="font-family:monospace">class MyClass&lt;T extends @NonNull
Object&gt;</span> rather than <span style="font-family:monospace">class MyClass&lt;T extends Object&gt;</span>.
</li></ul><p>For further discussion, see Section&#XA0;<a href="#faq-implicit-bounds">33.7.2</a>.</p>
<!--TOC subsection id="type-variable-use" Type annotations on a use of a generic type variable-->
<h3 id="type-variable-use" class="subsection">25.1.3&#XA0;&#XA0;Type annotations on a use of a generic type variable <a href="#type-variable-use" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>A type annotation on a use of a generic type variable overrides/ignores any type
qualifier (in the same type hierarchy) on the corresponding actual type
argument. For example, suppose that <span style="font-family:monospace">T</span> is a formal type parameter.
Then using <span style="font-family:monospace">@Nullable T</span> within the scope of <span style="font-family:monospace">T</span> applies the type
qualifier <span style="font-family:monospace">@Nullable</span> to the (unqualified) Java type of <span style="font-family:monospace">T</span>.
This feature is sometimes useful, but more often the implementation of a
generic type just uses the type variable <span style="font-family:monospace">T</span>, whose instantiation is
restricted (see Section&#XA0;<a href="#generics-instantiation">25.1.2</a>).</p><p>Here is an example of applying a type annotation to a generic type
variable:</p><pre class="verbatim">  class MyClass2&lt;T&gt; {
    ...
    @Nullable T myField = null;
    ...
  }
</pre><p>The type annotation does not restrict how <span style="font-family:monospace">MyClass2</span> may be
instantiated. In other words, both
<span style="font-family:monospace">MyClass2&lt;@NonNull String&gt;</span> and <span style="font-family:monospace">MyClass2&lt;@Nullable String&gt;</span> are
legal, and in both cases <span style="font-family:monospace">@Nullable T</span> means <span style="font-family:monospace">@Nullable String</span>.
In <span style="font-family:monospace">MyClass2&lt;@Interned String&gt;</span>,
<span style="font-family:monospace">@Nullable T</span> means <span style="font-family:monospace">@Nullable @Interned String</span>.</p><p>Defaulting never affects a use of a type variable, even if the type
variable use has no explicit annotation. Defaulting helps to choose a
single type qualifier for a concrete Java class or interface. By contrast,
a type variable use represents a set of possible types.</p>
<!--TOC subsection id="annotations-on-wildcards" Annotations on wildcards-->
<h3 id="annotations-on-wildcards" class="subsection">25.1.4&#XA0;&#XA0;Annotations on wildcards <a href="#annotations-on-wildcards" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>At an instantiation of a generic type, a Java wildcard indicates that some
constraints are known on the type argument, but the type argument is not known
exactly.
For example, you can indicate that the type parameter for variable <span style="font-family:monospace">ls</span> is
some unknown subtype of <span style="font-family:monospace">CharSequence</span>:</p><pre class="verbatim">  List&lt;? extends CharSequence&gt; ls;
  ls = new ArrayList&lt;String&gt;();      // OK
  ls = new ArrayList&lt;Integer&gt;();     // error: Integer is not a subtype of CharSequence
</pre><p>For more details about wildcards, see the
<a href="https://docs.oracle.com/javase/tutorial/java/generics/wildcards.html">Java
tutorial on wildcards</a> or
<a href="https://docs.oracle.com/javase/specs/jls/se10/html/jls-4.html#jls-4.5.1">JLS
&#XA7;4.5.1</a>.</p><p>You can write a type annotation on the bound of a wildcard:</p><pre class="verbatim">  List&lt;? extends @NonNull CharSequence&gt; ls;
  ls = new ArrayList&lt;@NonNull String&gt;();    // OK
  ls = new ArrayList&lt;@Nullable String&gt;();   // error: @Nullable is not a subtype of @NonNull
</pre><p>Conceptually, every wildcard has two bounds &#X2014; an upper bound and a lower
bound. Java only permits you to write one bound.
You can specify the upper bound with <span style="font-family:monospace">&lt;? extends SomeType&gt;</span>, in which
case the lower bound is implicitly the bottom type <span style="font-family:monospace">void</span>.
You can specify the lower bound (with <span style="font-family:monospace">&lt;? super OtherType&gt;</span>), in
which case the upper bound is implicitly the top type <span style="font-family:monospace">Object</span>.
The Checker Framework is more flexible: it lets you similarly write
annotations on both the upper and lower bound.</p><p>To annotate the <em>implicit</em> bound, write the type annotation
before the <span style="font-family:monospace">?</span>. For example:</p><pre class="verbatim">  List&lt;@LowerBound ? extends @UpperBound CharSequence&gt; lo;
  List&lt;@UpperBound ? super @NonNull Number&gt; ls;
</pre><p>For an unbounded wildcard (<span style="font-family:monospace">&lt;?&gt;</span>, with neither
bound specified), the annotation in front of a wildcard applies
to both bounds. The following three declarations are equivalent (except
that you cannot write the bottom type <span style="font-family:monospace">void</span>; note that
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Void.html"><span style="font-family:monospace">Void</span></a> does not denote the bottom type):</p><pre class="verbatim">  List&lt;@NonNull ?&gt; lnn;
  List&lt;@NonNull ? extends @NonNull Object&gt; lnn;
  List&lt;@NonNull ? super @NonNull void&gt; lnn;
</pre><p>Note that the annotation in front of a type parameter always applies to its
lower bound, because type parameters can only be written with <span style="font-family:monospace">extends</span>
and never <span style="font-family:monospace">super</span>.</p><p>The defaulting rules for
wildcards also differ from those of type parameters (see
Section&#XA0;<a href="#inherited-wildcard-annotations">26.5.5</a>).</p>
<!--TOC subsection id="type-parameter-qualifier-examples" Examples of qualifiers on a type parameter-->
<h3 id="type-parameter-qualifier-examples" class="subsection">25.1.5&#XA0;&#XA0;Examples of qualifiers on a type parameter <a href="#type-parameter-qualifier-examples" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Recall that <span style="font-family:monospace">@Nullable </span><span style="font-family:monospace"><em>X</em></span> is a supertype of <span style="font-family:monospace">@NonNull </span><span style="font-family:monospace"><em>X</em></span>,
for any <em>X</em>.
Most of the following types mean different things:</p><pre class="verbatim">  class MyList1&lt;@Nullable T&gt; { ... }
  class MyList1a&lt;@Nullable T extends @Nullable Object&gt; { ... } // same as MyList1
  class MyList2&lt;@NonNull T extends @NonNull Object&gt; { ... }
  class MyList2a&lt;T extends @NonNull Object&gt; { ... } // same as MyList2
  class MyList3&lt;T extends @Nullable Object&gt; { ... }
</pre><p><span style="font-family:monospace">MyList1</span> and <span style="font-family:monospace">MyList1a</span> must be instantiated with a nullable type.
The implementation of <span style="font-family:monospace">MyList1</span> must be able to consume (store) a null
value and produce (retrieve) a null value.</p><p><span style="font-family:monospace">MyList2</span> and <span style="font-family:monospace">MyList2a</span> must be instantiated with non-null type.
The implementation of <span style="font-family:monospace">MyList2</span> has to account for only non-null values &#X2014; it
does not have to account for consuming or producing null.</p><p><span style="font-family:monospace">MyList3</span> may be instantiated either way:
with a nullable type or a non-null type. The implementation of <span style="font-family:monospace">MyList3</span> must consider
that it may be instantiated either way &#X2014; flexible enough to support either
instantiation, yet rigorous enough to impose the correct constraints of the
specific instantiation. It must also itself comply with the constraints of
the potential instantiations.</p><p>One way to express the difference among <span style="font-family:monospace">MyList1</span>, <span style="font-family:monospace">MyList2</span>, and
<span style="font-family:monospace">MyList3</span> is by comparing what expressions are legal in the implementation
of the list &#X2014; that is, what expressions may appear in the ellipsis in the
declarations above, such as inside a method&#X2019;s body. Suppose each class
has, in the ellipsis, these declarations:</p><pre class="verbatim">  T t;
  @Nullable T nble;      // Section "Type annotations on a use of a generic type variable", below,
  @NonNull T nn;         // further explains the meaning of "@Nullable T" and "@NonNull T".
  void add(T arg) {}
  T get(int i) {}
</pre><p>Then the following expressions would be legal, inside a given
implementation &#X2014; that is, also within the ellipses.
(Compilable source code appears as file
<span style="font-family:monospace">checker-framework/checker/tests/nullness/generics/GenericsExample.java</span>.)</p><table border=1  style="border-spacing:0;" class="cellpadding1"><tr><td style="text-align:left;border:solid 1px;white-space:nowrap" >&nbsp;</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >MyList1</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >MyList2</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >MyList3 </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > t = null;</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >OK</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >error</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >error </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > t = nble;</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >OK</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >error</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >error </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > nble = null;</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >OK</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >OK</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >OK </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > nn = null;</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >error</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >error</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >error </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > t = this.get(0);</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >OK</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >OK</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >OK </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > nble = this.get(0);</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >OK</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >OK</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >OK </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > nn = this.get(0);</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >error</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >OK</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >error </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > this.add(t);</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >OK</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >OK</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >OK </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > this.add(nble);</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >OK</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >error</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >error </td></tr>
<tr><td style="text-align:left;border:solid 1px;white-space:nowrap" > this.add(nn);</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >OK</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >OK</td><td style="text-align:center;border:solid 1px;white-space:nowrap" >OK </td></tr>
</table><p>The differences are more
significant when the qualifier hierarchy is more complicated than just
<span style="font-family:monospace">@Nullable</span> and <span style="font-family:monospace">@NonNull</span>.</p>
<!--TOC subsection id="covariant-type-parameters" Covariant type parameters-->
<h3 id="covariant-type-parameters" class="subsection">25.1.6&#XA0;&#XA0;Covariant type parameters <a href="#covariant-type-parameters" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Java types are <em>invariant</em> in their type parameter. This means that
<span style="font-family:monospace">A&lt;X&gt;</span> is a subtype of <span style="font-family:monospace">B&lt;Y&gt;</span> only if <span style="font-family:monospace">X</span> is identical to <span style="font-family:monospace">Y</span>. For
example, <span style="font-family:monospace">ArrayList&lt;Number&gt;</span> is a subtype of <span style="font-family:monospace">List&lt;Number&gt;</span>, but
neither <span style="font-family:monospace">ArrayList&lt;Integer&gt;</span> nor <span style="font-family:monospace">List&lt;Integer&gt;</span> is a subtype of
<span style="font-family:monospace">List&lt;Number&gt;</span>. (If they were, there would be a loophole in the Java
type system.) For the same reason, type parameter annotations are treated
invariantly. For example, <span style="font-family:monospace">List&lt;@Nullable String&gt;</span> is not a subtype
of <span style="font-family:monospace">List&lt;String&gt;</span>.</p><p>When a type parameter is used in a read-only way &#X2014; that is, when values
of that type are read but are never assigned &#X2014; then it is safe for the
type to be <em>covariant</em> in the type parameter. Use the
<a href="../api/org/checkerframework/framework/qual/Covariant.html"><span style="font-family:monospace">@Covariant</span></a> annotation to indicate this.
When a type parameter is covariant, two instantiations of the class with
different type arguments have the same subtyping relationship as the type
arguments do.</p><p>For example, consider <span style="font-family:monospace">Iterator</span>. Its elements can be read but not
written, so <span style="font-family:monospace">Iterator&lt;@Nullable String&gt;</span> can be a subtype of
<span style="font-family:monospace">Iterator&lt;String&gt;</span> without introducing a hole in the type system.
Therefore, its type parameter is annotated with
<a href="../api/org/checkerframework/framework/qual/Covariant.html"><span style="font-family:monospace">@Covariant</span></a>.
The first type parameter of <span style="font-family:monospace">Map.Entry</span> is also covariant.
Another example would be the type parameter of a hypothetical class
<span style="font-family:monospace">ImmutableList</span>.</p><p>The <span style="font-family:monospace">@Covariant</span> annotation is trusted but not checked.
If you incorrectly specify as covariant a type parameter that can be
written (say, the class performs a
<span style="font-family:monospace">set</span> operation or some other mutation on an object of that type), then
you have created an unsoundness in the type system.
For example, it would be incorrect to annotate the type parameter of
<span style="font-family:monospace">ListIterator</span> as covariant, because <span style="font-family:monospace">ListIterator</span> supports a <span style="font-family:monospace">set</span>
operation.</p>
<!--TOC subsection id="infer-method-type-qualifiers" Method type argument inference and type qualifiers-->
<h3 id="infer-method-type-qualifiers" class="subsection">25.1.7&#XA0;&#XA0;Method type argument inference and type qualifiers <a href="#infer-method-type-qualifiers" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Sometimes method type argument inference does not interact well with
type qualifiers. In such situations, you might need to provide
explicit method type arguments, for which the syntax is as follows:</p><pre>
    Collections.&lt;@MyTypeAnnotation Object&gt;sort(l, c);
</pre><p>This uses Java&#X2019;s existing syntax for specifying a method call&#X2019;s type arguments.</p>
<!--TOC subsection id="bottom-type" The Bottom type-->
<h3 id="bottom-type" class="subsection">25.1.8&#XA0;&#XA0;The Bottom type <a href="#bottom-type" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Many type systems have a <span style="font-family:monospace">*Bottom</span> type that is used only for the <span style="font-family:monospace">null</span>
value, dead code, and some erroneous situations. A programmer should
rarely write the bottom type.</p><p>One use is on a lower bound, to indicate that any type qualifier is
permitted. A lower-bounded wildcard indicates that a consumer method can
accept a collection containing any Java type above some Java type, and you
can add the bottom type qualifier as well:</p><pre class="verbatim">public static void addNumbers(List&lt;? super @SignednessBottom Integer&gt; list) { ... }
</pre>
<!--TOC section id="qualifier-polymorphism" Qualifier polymorphism-->
<h2 id="qualifier-polymorphism" class="section">25.2&#XA0;&#XA0;Qualifier polymorphism <a href="#qualifier-polymorphism" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The Checker Framework supports type <em>qualifier</em> polymorphism for
methods, which permits a single method to have multiple different qualified
type signatures. This is similar to Java&#X2019;s generics, but is used in
situations where you cannot use Java generics. If you can use generics,
you typically do not need to use a polymorphic qualifier such as <span style="font-family:monospace">@PolyNull</span>.</p><p>To <em>use</em> a polymorphic qualifier, just write it on a type.
For example, you can write <span style="font-family:monospace">@PolyNull</span> anywhere in a method that you would write
<span style="font-family:monospace">@NonNull</span> or <span style="font-family:monospace">@Nullable</span>.
A polymorphic qualifier can be used in a method signature or body.
It may not be used on a class or field.</p><p>A method written using a polymorphic qualifier conceptually has multiple
versions, somewhat like the generics feature of Java or a template in C++.
In each version, each instance of the polymorphic qualifier has been
replaced by the same other qualifier from the hierarchy. See the examples
below in Section&#XA0;<a href="#qualifier-polymorphism-examples">25.2.1</a>.</p><p>The method body must type-check with all signatures. A method call is
type-correct if it type-checks under any one of the signatures. If a call
matches multiple signatures, then the compiler uses the most specific
matching signature for the purpose of type-checking. This is the same as
Java&#X2019;s rule for resolving overloaded methods.</p><p>To <em>define</em> a polymorphic qualifier, mark the definition with
<a href="../api/org/checkerframework/framework/qual/PolymorphicQualifier.html"><span style="font-family:monospace">@PolymorphicQualifier</span></a>. For example,
<a href="../api/org/checkerframework/checker/nullness/qual/PolyNull.html"><span style="font-family:monospace">@PolyNull</span></a> is a polymorphic type
qualifier for the Nullness type system:</p><pre class="verbatim">  import java.lang.annotation.ElementType;
  import java.lang.annotation.Target;
  import org.checkerframework.framework.qual.PolymorphicQualifier;

  @PolymorphicQualifier
  @Target({ElementType.TYPE_USE, ElementType.TYPE_PARAMETER})
  public @interface PolyNull {}
</pre><p>See Section&#XA0;<a href="#polyall">25.2.3</a> for a way you can sometimes avoid defining a new
polymorphic qualifier.</p>
<!--TOC subsection id="qualifier-polymorphism-examples" Examples of using polymorphic qualifiers-->
<h3 id="qualifier-polymorphism-examples" class="subsection">25.2.1&#XA0;&#XA0;Examples of using polymorphic qualifiers <a href="#qualifier-polymorphism-examples" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>As an example of the use of <span style="font-family:monospace">@PolyNull</span>, method
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Class.html#cast-java.lang.Object-"><span style="font-family:monospace">Class.cast</span></a>
returns null if and only if its argument is <span style="font-family:monospace">null</span>:</p><pre class="verbatim">  @PolyNull T cast(@PolyNull Object obj) { ... }
</pre><p>This is like writing:</p><pre class="verbatim">   @NonNull T cast( @NonNull Object obj) { ... }
  @Nullable T cast(@Nullable Object obj) { ... }
</pre><p>except that the latter is not legal Java, since it defines two
methods with the same Java signature.</p><p>As another example, consider</p><pre class="verbatim">  // Returns null if either argument is null.
  @PolyNull T max(@PolyNull T x, @PolyNull T y);
</pre><p>which is like writing</p><pre class="verbatim">   @NonNull T max( @NonNull T x,  @NonNull T y);
  @Nullable T max(@Nullable T x, @Nullable T y);
</pre><p>At a call site, the most specific applicable signature is selected.</p><p>Another way of thinking about which one of the two <span style="font-family:monospace">max</span> variants is
selected is that the nullness annotations of (the declared types of) both
arguments are <em>unified</em> to a type that is a supertype of both, also
known as the <em>least upper bound</em> or lub. If both
arguments are <span style="font-family:monospace">@NonNull</span>, their unification (lub) is <span style="font-family:monospace">@NonNull</span>, and the
method return type is <span style="font-family:monospace">@NonNull</span>. But if even one of the arguments is <span style="font-family:monospace">@Nullable</span>,
then the unification (lub) is <span style="font-family:monospace">@Nullable</span>, and so is the return type.</p>
<!--TOC subsection id="qualifier-polymorhism-vs-subtyping" Relationship to subtyping and generics-->
<h3 id="qualifier-polymorhism-vs-subtyping" class="subsection">25.2.2&#XA0;&#XA0;Relationship to subtyping and generics <a href="#qualifier-polymorhism-vs-subtyping" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Qualifier polymorphism has the same purpose and plays the same role as
Java&#X2019;s generics. You use them in the same cases, such as:
</p><ul class="itemize"><li class="li-itemize">
A method operates on collections with different types of
elements.
</li><li class="li-itemize">Two different arguments have the same type, without constraining them to
be one specific type.
</li><li class="li-itemize">A method returns a value of the same type as its argument.
</li></ul><p>If a method is written using Java generics, it usually does not need
qualifier polymorphism. If you can use Java&#X2019;s generics, then that is often
better. On the other hand, if you have legacy code that is not
written generically, and you cannot change it to use generics, then you can
use qualifier polymorphism to achieve a similar effect, with respect to
type qualifiers only. The Java compiler still treats the base Java types
non-generically.</p><p>In some cases, you don&#X2019;t need qualifier polymorphism because subtyping
already provides the needed functionality.
<span style="font-family:monospace">String</span> is a supertype of <span style="font-family:monospace">@Interned String</span>, so a method <span style="font-family:monospace">toUpperCase</span>
that is declared to take a <span style="font-family:monospace">String</span> parameter can also be called on an
<span style="font-family:monospace">@Interned String</span> argument.</p>
<!--TOC subsection id="polyall" The <span style="font-family:monospace">@PolyAll</span> qualifier applies to every type system-->
<h3 id="polyall" class="subsection">25.2.3&#XA0;&#XA0;The <span style="font-family:monospace">@PolyAll</span> qualifier applies to every type system <a href="#polyall" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Each type system may have its own polymorphic type qualifier.
If some method is qualifier-polymorphic over every type qualifier
hierarchy, then you can use <a href="../api/org/checkerframework/framework/qual/PolyAll.html"><span style="font-family:monospace">@PolyAll</span></a>.
This is better than trying to write every <span style="font-family:monospace">@Poly*</span> qualifier on that method.</p><p>For example, a method that only performs <span style="font-family:monospace">==</span> on array elements will work
no matter what the array&#X2019;s element types are:</p><pre class="verbatim">  /**
   * Searches for the first occurrence of the given element in the array,
   * testing for equality using == (not the equals method).
   */
  public static int indexOfEq(@PolyAll Object[] a, @Nullable Object elt) {
    for (int i=0; i&lt;a.length; i++) {
      if (elt == a[i]) {
        return i;
      }
    }
    return -1;
  }
</pre>
<!--TOC subsection id="qualifier-polymorphism-multiple-qualifiers" Using multiple polymorphic qualifiers in a method signature-->
<h3 id="qualifier-polymorphism-multiple-qualifiers" class="subsection">25.2.4&#XA0;&#XA0;Using multiple polymorphic qualifiers in a method signature <a href="#qualifier-polymorphism-multiple-qualifiers" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Usually, it does not make sense to write only a single instance of a polymorphic
qualifier in a method definition: if you write one instance of (say)
<span style="font-family:monospace">@PolyNull</span>, then you should use at least two.
The main benefit of polymorphic qualifiers comes when one is used multiple times
in a method, since then each instance turns into the same type qualifier.
(Section&#XA0;<a href="#qualifier-polymorphism-single-qualifier">25.2.5</a> describes some
exceptions to this rule: times when it makes sense to write a single
polymorphic qualifier in a signature.)</p><p>Most frequently, the polymorphic qualifier appears on at least one formal
parameter and also on the return type.</p><p>It can also be useful to have
polymorphic qualifiers on (only) multiple formal parameters, especially if
the method side-effects one of its arguments.
For example, consider</p><pre class="verbatim">void moveBetweenStacks(Stack&lt;@PolyNull Object&gt; s1, Stack&lt;@PolyNull Object&gt; s2) {
  s1.push(s2.pop());
}
</pre><p>In this particular example, it would be cleaner to rewrite your code to use
Java generics, if you can do so:</p><pre class="verbatim">&lt;T&gt; void moveBetweenStacks(Stack&lt;T&gt; s1, Stack&lt;T&gt; s2) {
  s1.push(s2.pop());
}
</pre>
<!--TOC subsection id="qualifier-polymorphism-single-qualifier" Using a single polymorphic qualifier in a method signature-->
<h3 id="qualifier-polymorphism-single-qualifier" class="subsection">25.2.5&#XA0;&#XA0;Using a single polymorphic qualifier in a method signature <a href="#qualifier-polymorphism-single-qualifier" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>As explained in Section&#XA0;<a href="#qualifier-polymorphism-multiple-qualifiers">25.2.4</a>,
you will usually use a polymorphic qualifier
multiple times in a signature.
This section describes situations when it makes sense to write just one
polymorphic qualifier in a method signature.
Some of these situations can be avoided by writing a generic method,
but in legacy code it may not be possible for you to change a method to be
generic.</p>
<!--TOC subsubsection id="qualifier-polymorphism-return-type" Using a single polymorphic qualifier on a return type-->
<h4 id="qualifier-polymorphism-return-type" class="subsubsection">Using a single polymorphic qualifier on a return type <a href="#qualifier-polymorphism-return-type" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h4><!--SEC END --><p>It is unusual, but permitted, to write just one polymorphic qualifier, on a return type.</p><p>This is just like it is unusual, but permitted, to write just one
occurrence of a generic type parameter, on a return type. An example of
such a method is
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Collections.html#emptyList--"><span style="font-family:monospace">Collections.emptyList()</span></a>.</p>
<!--TOC subsubsection id="qualifier-polymorphism-element-types" Using a single polymorphic qualifier on an element type-->
<h4 id="qualifier-polymorphism-element-types" class="subsubsection">Using a single polymorphic qualifier on an element type <a href="#qualifier-polymorphism-element-types" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h4><!--SEC END --><p>It can make sense to use a polymorphic qualifier just once, on an array or
generic element type.</p><p>For example, consider a routine that returns the index, in an array, of a
given element:</p><pre class="verbatim">  public static int indexOf(@PolyNull Object[] a, @Nullable Object elt) { ... }
</pre><p>If <span style="font-family:monospace">@PolyNull</span> were replaced with either <span style="font-family:monospace">@Nullable</span> or <span style="font-family:monospace">@NonNull</span>, then
one of these safe client calls would be rejected:</p><pre class="verbatim">  @Nullable Object[] a1;
  @NonNull Object[] a2;

  indexOf(a1, someObject);
  indexOf(a2, someObject);
</pre><p>Of course, it would be better style to use a generic method, as in either
of these signatures:</p><pre class="verbatim"> public static &lt;T extends @Nullable Object&gt; int indexOf(T[] a, @Nullable Object elt) { ... }
 public static &lt;T extends @Nullable Object&gt; int indexOf(T[] a, T elt) { ... }
</pre><p>Another example is a method that writes bytes to a file. It accepts an
array of signed or unsigned bytes, and it behaves identically for both:</p><pre class="verbatim">  void write(@PolySigned byte[] b) { ... }
</pre><p>These examples use arrays, but there are similar examples that
use collections.</p>
<!--TOC subsubsection id="qualifier-polymorphism-formal-parameter" Don&#X2019;t use a single polymorphic qualifier on a formal parameter type-->
<h4 id="qualifier-polymorphism-formal-parameter" class="subsubsection">Don&#X2019;t use a single polymorphic qualifier on a formal parameter type <a href="#qualifier-polymorphism-formal-parameter" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h4><!--SEC END --><p>There is no point to writing</p><pre class="verbatim">  void m(@PolyNull Object obj)
</pre><p>which expands to</p><pre class="verbatim">  void m(@NonNull Object obj)
  void m(@Nullable Object obj)
</pre><p>This is no different (in terms of which calls to the method will
type-check) than writing just</p><pre class="verbatim">  void m(@Nullable Object obj)
</pre>
<!--TOC subsubsection id="qualifier-polymorphism-top-type" Using a single <span style="font-family:monospace">@PolyAll</span> qualifier to indicate all arguments are legal-->
<h4 id="qualifier-polymorphism-top-type" class="subsubsection">Using a single <span style="font-family:monospace">@PolyAll</span> qualifier to indicate all arguments are legal <a href="#qualifier-polymorphism-top-type" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h4><!--SEC END --><p>A single <span style="font-family:monospace">@PolyAll</span> annotation can indicate that any possible value is
permitted to be passed. For example:</p><pre class="verbatim">  boolean eq(@PolyAll Object other) {
    return this == other;
  }
</pre><p>The <span style="font-family:monospace">@PolyAll</span> annotation applies to all type systems.
It would be infeasible to write the top qualifier for every possible type
system and to update this method&#X2019;s annotation whenever a new type system is
defined.</p><p>By contrast, a declaration of <span style="font-family:monospace">eq</span> without <span style="font-family:monospace">@PolyAll</span>:</p><pre class="verbatim">  boolean eq(Object other) {
    return this == other;
  }
</pre><p>would reject some calls, in type systems where the default type qualifier
applied to <span style="font-family:monospace">Object</span> is not the top type.</p><p>A related use of a single polymorphic qualifier is to override a generic
type. For example, the annotation on
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Comparable.html#compareTo-T-"><span style="font-family:monospace">Comparable.compareTo()</span></a>
is:</p><pre class="verbatim">  public interface Comparable&lt;T extends @NonNull Object&gt; {
    @Pure int compareTo(@PolyAll @NonNull T a1);
  }
</pre><p>which indicates that, for every type system other than the nullness type
system, every value is permitted as an argument, regardless of how the
<span style="font-family:monospace">Comparable</span> type was instantiated. For example, this call is legal:</p><pre class="verbatim">  Comparable&lt;@MyBottom String&gt; cble;
  @MyTop String s;
  ...
  cble.compareTo(s);
</pre><hr>
<!--TOC chapter id="advanced-type-system-features" Advanced type system features-->
<h1 id="advanced-type-system-features" class="chapter">Chapter&#XA0;26&#XA0;&#XA0;Advanced type system features <a href="#advanced-type-system-features" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h1><!--SEC END --><p>This chapter describes features that are automatically supported by every
checker written with the Checker Framework.
You may wish to skim or skip this chapter on first reading. After you have
used a checker for a little while and want to be able to express more
sophisticated and useful types, or to understand more about how the Checker
Framework works, you can return to it.</p>
<!--TOC section id="invariant-arrays" Invariant array types-->
<h2 id="invariant-arrays" class="section">26.1&#XA0;&#XA0;Invariant array types <a href="#invariant-arrays" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>Java&#X2019;s type system is unsound with respect to arrays. That is, the Java
type-checker approves code that is unsafe and will cause a run-time crash.
Technically, the problem is that Java has &#X201C;covariant array types&#X201D;, such
as treating <span style="font-family:monospace">String[]</span> as a subtype of <span style="font-family:monospace">Object[]</span>. Consider the
following example:</p><pre class="verbatim">  String[] strings = new String[] {"hello"};
  Object[] objects = strings;
  objects[0] = new Object();
  String myString = strs[0];
</pre><p>The above code puts an <span style="font-family:monospace">Object</span> in the array <span style="font-family:monospace">strings</span> and thence in
<span style="font-family:monospace">myString</span>, even though <span style="font-family:monospace">myString = new Object()</span> should be, and is,
rejected by the Java type system. Java prevents corruption of the JVM by
doing a costly run-time check at every array assignment; nonetheless, it is
undesirable to learn about a type error only via a run-time crash rather
than at compile time.</p><p>When you pass the <span style="font-family:monospace">-AinvariantArrays</span> command-line option,
the Checker Framework is stricter than Java, in the sense that it treats
arrays invariantly rather than covariantly. This means that a type system
built upon the Checker Framework is sound: you get a compile-time
guarantee without the need for any run-time checks. But it also means that
the Checker Framework rejects code that is similar to what Java unsoundly
accepts. The guarantee and the compile-time checks are about your
extended type system. The Checker Framework does not reject the example
code above, which contains no type annotations.</p><p>Java&#X2019;s covariant array typing is sound if the array is used in a read-only
fashion: that is, if the array&#X2019;s elements are accessed but the array is
not modified. However, facts about read-only usage are not built into any of
the type-checkers. Therefore, when using type systems
along with <span style="font-family:monospace">-AinvariantArrays</span>, you will need to suppress any warnings that
are false positives because the array is treated in a read-only way.</p>
<!--TOC section id="array-context-sensitive" Context-sensitive type inference for array constructors-->
<h2 id="array-context-sensitive" class="section">26.2&#XA0;&#XA0;Context-sensitive type inference for array constructors <a href="#array-context-sensitive" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>When you write an expression, the Checker Framework gives it the most
precise possible type, depending on the particular expression or value.
For example, when using the Regex Checker (Chapter&#XA0;<a href="#regex-checker">11</a>),
the string <span style="font-family:monospace">"hello"</span> is given type <span style="font-family:monospace">@Regex String</span> because it is a legal
regular expression (whether it is meant to be used as one or not) and the
string <span style="font-family:monospace">"(foo"</span> is given the type <span style="font-family:monospace">@RegexBottom String</span> because it is not
a legal regular expression.</p><p>Array constructors work differently. When you create an array with the
array constructor syntax, such as the right-hand side of this assignment:</p><pre class="verbatim">String[] myStrings = {"hello"};
</pre><p>then the expression does not get the most precise possible type, because
doing so could cause inconvenience. Rather, its type is determined by the
context in which it is used: the left-hand side if it is in an assignment,
the declared formal parameter type if it is in a method call, etc.</p><p>In particular, if the expression <code>{"hello"}</code> were given the type
<span style="font-family:monospace">@Regex String[]</span>, then the assignment would be illegal! But the Checker
Framework gives the type <span style="font-family:monospace">String[]</span> based on the assignment context, so the code
type-checks.</p><p>If you prefer a specific type for a constructed array, you can indicate
that either in the context (change the declaration of <span style="font-family:monospace">myStrings</span>) or in a
<span style="font-family:monospace">new</span> construct (change the expression to <span style="font-family:monospace">new @Regex String[] </span><code>{"hello"}</code>).</p>
<!--TOC section id="upper-bound-for-use" Upper bound of qualifiers on uses of a given type-->
<h2 id="upper-bound-for-use" class="section">26.3&#XA0;&#XA0;Upper bound of qualifiers on uses of a given type <a href="#upper-bound-for-use" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>
The examples in this section use the type qualifier hierarchy <span style="font-family:monospace">@A :&gt; @B :&gt; @C</span>.</p><p>A qualifier on a use of a certain type must be a subtype or equal to the upper bound for that type.
The upper bound of qualifiers used on a given type is specified by annotating the type declaration
with some qualifier.
</p><pre class="verbatim">  @C class MyClass {}
</pre><p>This means that <span style="font-family:monospace">@B MyClass</span> is an invalid type. (Annotations on class declarations may also specify
default annotations for uses of the type; see Section&#XA0;<a href="#default-for-use">26.5.1</a>)</p><p>An upper bound can also be specified by the type-system designer using the meta-annotation
<a href="../api/org/checkerframework/framework/qual/UpperBoundFor.html"><span style="font-family:monospace">@UpperBoundFor</span></a>.</p><p>If no annotation is present on a type declaration and if no <span style="font-family:monospace">@UpperBoundFor</span> mentions the type, then
the bound is top. This can be changed by overriding
<a href="../api/org/checkerframework/framework/type/AnnotatedTypeFactory.html#getTypeDeclarationBounds-javax.lang.model.type.TypeMirror-"><span style="font-family:monospace">AnnotatedTypeFactory#getTypeDeclarationBounds</span></a>.</p><p>There are two exceptions.
</p><ul class="itemize"><li class="li-itemize">
An expression can have a supertype of the upper bound; that is, some expression could
have type <span style="font-family:monospace">@B MyClass</span>. This type is not written explicitly, but results from viewpoint adaptation.
</li><li class="li-itemize">Using usual CLIMB-to-top rules, local variables of type MyClass default to <span style="font-family:monospace">@A MyClass</span>.
It is legal for <span style="font-family:monospace">@A MyClass</span> to be the type of a local variable.
For consistency, users are allowed to write such a type on a local variable declaration.
</li></ul><p>Due to existing type rules, an expression of type <span style="font-family:monospace">A MyClass</span> can only be used in limited ways.
</p><ul class="itemize"><li class="li-itemize">
Since every field, formal parameter, and return type of type MyClass (or lower) is annotated as
<span style="font-family:monospace">@B</span> (or lower), it cannot be assigned to a field, passed to a method, or returned from a method.
</li><li class="li-itemize">It can be used in a context that requires <span style="font-family:monospace">@A Object</span> (or whatever the least supertype is of MyClass
for which the <span style="font-family:monospace">@A</span> qualifier is permitted). Examples include being tested against <span style="font-family:monospace">null</span> or
(for most type systems) being passed to polymorphic routines such as <span style="font-family:monospace">System.out.println</span> or <span style="font-family:monospace">System.identityHashCode</span>.
</li></ul><p>These operations might refine its type. If a user wishes to annotate a method that does type refinement,
its formal parameter must be of illegal type <span style="font-family:monospace">@A MyClass</span>, which requires a warning suppression.</p><p>If the framework forbid expressions and local variables from having types inconsistent with the class annotation,
then important APIs and common coding paradigms will no longer type-check.</p><p>Consider the annotation
</p><pre class="verbatim">  @NonNull class Optional { ... }
</pre><p>and the client code</p><pre class="verbatim">  Map&lt;String, Optional&gt; m;
  String key = ...;
  Optional value = m.get(key);
  if (value != null) {
  ...;
  }
</pre><p>The type of <span style="font-family:monospace">m.get(key)</span> is <span style="font-family:monospace">@Nullable Optional</span>, which is an illegal type.
However, this is a very common paradigm. Programmers should not need to rewrite the code to test
<span style="font-family:monospace">m.containsKey(key)</span> nor suppress a warning in this safe code.</p>
<!--TOC section id="effective-qualifier" The effective qualifier on a type (defaults and inference)-->
<h2 id="effective-qualifier" class="section">26.4&#XA0;&#XA0;The effective qualifier on a type (defaults and inference) <a href="#effective-qualifier" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>A checker sometimes treats a type as having a slightly different qualifier
than what is written on the type &#X2014; especially if the programmer wrote no
qualifier at all.
Most readers can skip this section on first reading, because you will
probably find the system simply &#X201C;does what you mean&#X201D;, without forcing
you to write too many qualifiers in your program.
In particular, qualifiers in method bodies are rare (except occasionally on
type arguments and array component types).</p><p>The following steps determine the effective
qualifier on a type &#X2014; the qualifier that the checkers treat as being present.</p><ol class="enumerate" type=1><li class="li-enumerate">
If a type qualifier is present in the source code, that qualifier is used.</li><li class="li-enumerate">If there is no explicit qualifier on a type, then a default
qualifier
is applied; see Section&#XA0;<a href="#defaults">26.5</a>. Defaulted qualifiers are treated by checkers
exactly as if the programmer had written them explicitly.</li><li class="li-enumerate">The type system may refine a qualified type on a local variable &#X2014; that
is, treat it as a subtype of how it was declared or defaulted. This
refinement is always sound and has the effect of eliminating false
positive error messages. See Section&#XA0;<a href="#type-refinement">26.7</a>.</li></ol>
<!--TOC section id="defaults" Default qualifier for unannotated types-->
<h2 id="defaults" class="section">26.5&#XA0;&#XA0;Default qualifier for unannotated types <a href="#defaults" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>An unannotated
Java type is treated as if it had a default annotation.
Both the type system designer and an end-user programmer can control the defaulting.
Defaulting never applies to uses of type variables, even if they do not
have an explicit type annotation.
Most of this section is about defaults for source code that is read by
the compiler. When the compiler reads a <span style="font-family:monospace">.class</span> file, different
defaulting rules apply.
See Section&#XA0;<a href="#defaults-classfile">26.5.6</a> for these rules.</p><p>There are several defaulting mechanisms, for convenience and flexibility.
When determining the default qualifier for a use of an unannotated type, <span style="font-family:monospace">MyClass</span>, the following
rules are used in order, until one applies.
</p><ol class="enumerate" type=1><li class="li-enumerate">
The qualifier specified via <span style="font-family:monospace">@DefaultQualifierForUse</span> on the declaration of the <span style="font-family:monospace">MyClass</span>.
(Section&#XA0;<a href="#default-for-use">26.5.1</a>)
</li><li class="li-enumerate">If no <span style="font-family:monospace">@NoDefaultQualifierForUse</span> is written on the declaration of <span style="font-family:monospace">MyClass</span>, the qualifier
explicitly written on the declaration of <span style="font-family:monospace">MyClass</span>. (Section&#XA0;<a href="#default-for-use">26.5.1</a>)
</li><li class="li-enumerate">The qualifier with a meta-annotation <span style="font-family:monospace">@DefaultFor(types = MyClass.class)</span>. (Section&#XA0;<a href="#default-for-use">26.5.1</a>)
</li><li class="li-enumerate">The qualifier with a meta-annotation <span style="font-family:monospace">@DefaultFor(typeKinds = KIND)</span>, where <span style="font-family:monospace">KIND</span> is the
<span style="font-family:monospace">TypeKind</span> of <span style="font-family:monospace">MyClass</span>. (Section&#XA0;<a href="#default-for-use">26.5.1</a>)
</li><li class="li-enumerate">The qualifier in the innermost user-written <span style="font-family:monospace">@DefaultQualifier</span> for the location of the use of <span style="font-family:monospace">MyClass</span>.
(Section&#XA0;<a href="#default-qualifier">26.5.2</a>)
</li><li class="li-enumerate">The qualifier in the meta-annotation <span style="font-family:monospace">@DefaultFor</span> for the location of the use of <span style="font-family:monospace">MyClass</span>.
These are defaults specified by the type system designer (Section&#XA0;<a href="#creating-typesystem-defaults">31.4.4</a>);
this is usually CLIMB-to-top (Section&#XA0;<a href="#climb-to-top">26.5.3</a>).
</li><li class="li-enumerate">The qualifier with the meta-annotation <span style="font-family:monospace">@DefaultQualifierInHierarchy</span>
</li></ol><p>If the unannotated type is the type of a local variable, then the first 5 rules are skipped and only
rules 6 and 7 apply. This makes the type local variables top so they can be refined.</p>
<!--TOC subsection id="default-for-use" Default for use of a type-->
<h3 id="default-for-use" class="subsection">26.5.1&#XA0;&#XA0;Default for use of a type <a href="#default-for-use" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>
The type declaration annotation <a href="../api/org/checkerframework/framework/qual/DefaultQualifierForUse.html"><span style="font-family:monospace">@DefaultQualifierForUse</span></a>
indicates that the specified qualifier should be added to all unannotated uses of the type.</p><p>For example:
</p><pre class="verbatim">@DefaultQualifierForUse(B.class)
class MyClass {}
</pre><p>This means any unannotated use of <span style="font-family:monospace">MyClass</span> is treated as <span style="font-family:monospace">@B MyClass</span> by the checker.
(Except for locals, which can be refined.)</p><p>Similarly, the meta-annotation <a href="../api/org/checkerframework/framework/qual/DefaultFor.html"><span style="font-family:monospace">@DefaultFor</span></a> can be used to specify defaults
for uses of of types, using the <span style="font-family:monospace">types</span> element, or type kinds, using the <span style="font-family:monospace">typeKinds</span> elements.</p><p>Interaction between qualifier bounds and <span style="font-family:monospace">DefaultQualifierForUse</span>:
</p><ul class="itemize"><li class="li-itemize">
If a type declaration is annotated with a qualifier bound, but not a <span style="font-family:monospace">@DefaultQualifierForUse</span>,
then the qualifier bound is added to all unannotated uses of that type (except locals).
For example, <span style="font-family:monospace">@C class MyClass </span> is equivalent to
<pre class="verbatim">@DefaultQualifierForUse(C.class)
@C class MyClass {}
</pre></li><li class="li-itemize">If the qualifier bound should not be added to all unannotated uses, then
<a href="../api/org/checkerframework/framework/qual/NoDefaultQualifierForUse.html"><span style="font-family:monospace">@NoDefaultQualifierForUse</span></a> should be written on the declaration:
<pre class="verbatim">@NoDefaultQualifierForUse
@C class MyClass {}
</pre>This means that unannotated uses of MyClass are defaulted normally.
</li><li class="li-itemize">If neither <span style="font-family:monospace">@DefaultQualifierForUse</span> nor a qualifier bound is present on a type declaration, that
is equivalent to writing <span style="font-family:monospace">@NoDefaultQualifierForUse</span>.</li></ul>
<!--TOC subsection id="default-qualifier" Controlling defaults in source code-->
<h3 id="default-qualifier" class="subsection">26.5.2&#XA0;&#XA0;Controlling defaults in source code <a href="#default-qualifier" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>
The end-user programmer specifies a default qualifier by writing the
<a href="../api/org/checkerframework/framework/qual/DefaultQualifier.html"><span style="font-family:monospace">@DefaultQualifier</span></a><span style="font-family:monospace">(</span><span style="font-family:monospace"><em>ClassName</em></span><span style="font-family:monospace">, </span>[<em>locations</em>]<span style="font-family:monospace">)</span>
annotation on a package, class, method, or variable declaration. The
argument to <a href="../api/org/checkerframework/framework/qual/DefaultQualifier.html"><span style="font-family:monospace">@DefaultQualifier</span></a> is the <span style="font-family:monospace">Class</span>
name of an annotation.
The optional second argument indicates where the default
applies. If the second argument is omitted, the specified annotation is
the default in all locations. See the Javadoc of <a href="../api/org/checkerframework/framework/qual/DefaultQualifier.html"><span style="font-family:monospace">DefaultQualifier</span></a> for details.</p><p>For example, using the Nullness type system (Chapter&#XA0;<a href="#nullness-checker">3</a>):</p><pre class="verbatim">import org.checkerframework.framework.qual.DefaultQualifier;
import org.checkerframework.checker.nullness.qual.NonNull;

@DefaultQualifier(NonNull.class)
class MyClass {

  public boolean compile(File myFile) { // myFile has type "@NonNull File"
    if (!myFile.exists())          // no warning: myFile is non-null
      ...
    @Nullable File srcPath = ...;  // must annotate to specify "@Nullable File"
    if (srcPath.exists())          // warning: srcPath might be null
      ...
  }

  @DefaultQualifier(Tainted.class)
  public boolean isJavaFile(File myfile) {  // myFile has type "@Tainted File"
    ...
  }
}
</pre><p>You may write multiple
<a href="../api/org/checkerframework/framework/qual/DefaultQualifier.html"><span style="font-family:monospace">@DefaultQualifier</span></a> annotations at a single location.</p><p>If <span style="font-family:monospace">@DefaultQualifier</span>[<span style="font-family:monospace">s</span>] is placed on a package (via the
<span style="font-family:monospace">package-info.java</span> file), then it applies to the given package <em>and</em>
all subpackages.
</p>
<!--TOC subsection id="climb-to-top" Defaulting rules and CLIMB-to-top-->
<h3 id="climb-to-top" class="subsection">26.5.3&#XA0;&#XA0;Defaulting rules and CLIMB-to-top <a href="#climb-to-top" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Each type system defines a default qualifier (see
Section&#XA0;<a href="#creating-typesystem-defaults">31.4.4</a>). For example, the default
qualifier for the Nullness Checker is
<a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a>. When a user
writes an unqualified type such as <span style="font-family:monospace">Date</span>, the Nullness Checker interprets it as
<span style="font-family:monospace">@NonNull Date</span>.</p><p>The type system applies that default qualifier to most but
not all type uses. In particular, unless otherwise stated, every type system
uses the CLIMB-to-top rule. This
rule states that the <em>top</em> qualifier in the hierarchy is the default for
the CLIMB locations: <span style="font-weight:bold">C</span>asts, <span style="font-weight:bold">L</span>ocals, <span style="font-weight:bold">I</span>nstanceof,
and (some) i<span style="font-weight:bold">M</span>plicit <span style="font-weight:bold">B</span>ounds.
For example, when the user writes an unqualified type such as <span style="font-family:monospace">Date</span> in such a
location, the Nullness Checker interprets it as <span style="font-family:monospace">@Nullable Date</span> (because
<a href="../api/org/checkerframework/checker/nullness/qual/Nullable.html"><span style="font-family:monospace">@Nullable</span></a> is the top qualifier in the
hierarchy, see Figure&#XA0;<a href="#fig-nullness-hierarchy">3.1</a>).</p><p>The CLIMB-to-top rule is used only for unannotated source code that is
being processed by a checker. For unannotated libraries (code read by the
compiler in <span style="font-family:monospace">.class</span> or <span style="font-family:monospace">.jar</span> form), see Section&#XA0;<a href="#defaults-classfile">26.5.6</a>.</p><p>The rest of this section explains the rationale and implementation of
CLIMB-to-top.</p><p>Here is the rationale for CLIMB-to-top:</p><ul class="itemize"><li class="li-itemize">
Local variables are defaulted to top because type refinement
(Section&#XA0;<a href="#type-refinement">26.7</a>) is applied to local variables. If a local
variable starts as the top type, then the Checker Framework refines it to
the best (most specific) possible type based on assignments to it. As a
result, a programmer rarely writes an explicit annotation on any of those
locations.<p>Variables defaulted to top include local variables, resource variables in the
try-with-resources construct, variables in <span style="font-family:monospace">for</span> statements, and <span style="font-family:monospace">catch</span>
arguments (known as exception parameters in the Java Language Specification).
Exception parameters need to have the top type because
exceptions of arbitrary qualified types can be thrown and the Checker Framework
does not provide run-time checks.</p></li><li class="li-itemize">Cast and instanceof types
are given the same type as their argument expression. This has the same
effect as if they were given the
top type and then flow-sensitively refined to the type of their argument.
However, note that programmer-written type qualifiers are <em>not</em>
refined.
</li><li class="li-itemize">Implicit upper bounds are defaulted to top to allow them to be instantiated
in any way. If a user declared <span style="font-family:monospace">class C&lt;T&gt; </span><span style="font-family:monospace">{</span><span style="font-family:monospace"> ... </span><span style="font-family:monospace">}</span>, then
the Checker Framework assumes that the user intended to allow any instantiation of the class,
and the declaration is interpreted as <span style="font-family:monospace">class C&lt;T extends @Nullable
Object&gt; </span><span style="font-family:monospace">{</span><span style="font-family:monospace"> ... </span><span style="font-family:monospace">}</span> rather than as <span style="font-family:monospace">class C&lt;T extends
@NonNull Object&gt; </span><span style="font-family:monospace">{</span><span style="font-family:monospace"> ... </span><span style="font-family:monospace">}</span>. The latter would forbid
instantiations such as <span style="font-family:monospace">C&lt;@Nullable String&gt;</span>, or would require
rewriting of code. On the other hand, if a user writes an explicit bound
such as <span style="font-family:monospace">class C&lt;T extends D&gt; </span><span style="font-family:monospace">{</span><span style="font-family:monospace"> ... </span><span style="font-family:monospace">}</span>, then the user
intends some restriction on instantiation and can write a qualifier on the
upper bound as desired.<p>This rule means that the upper bound of <span style="font-family:monospace">class C&lt;T&gt;</span> is defaulted
differently than the upper bound of <span style="font-family:monospace">class C&lt;T extends Object&gt;</span>.
This may seem confusing, but it is the least bad option. The
more confusing alternative would be for &#X201C;<span style="font-family:monospace">Object</span>&#X201D; to be defaulted
differently in <span style="font-family:monospace">class C&lt;T extends Object&gt;</span> and in an
instantiation <span style="font-family:monospace">C&lt;Object&gt;</span>, and for the upper bounds to be defaulted
differently in <span style="font-family:monospace">class C&lt;T extends Object&gt;</span>
and <span style="font-family:monospace">class C&lt;T extends Date&gt;</span>.</p></li><li class="li-itemize">Implicit <em>lower</em> bounds are defaulted to the bottom type, again to allow
maximal instantiation. Note that Java does not allow a programmer to
express both the upper and lower bounds of a type, but the Checker
Framework allows the programmer to specify either or both;
see Section&#XA0;<a href="#generics-defaults">25.1.2</a>.</li></ul><p>A <a href="../api/org/checkerframework/framework/qual/DefaultQualifier.html"><span style="font-family:monospace">@DefaultQualifier</span></a> that specifies a
CLIMB-to-top location takes precedence over the CLIMB-to-top rule.</p><p>Here is how the Nullness Checker overrides part of the CLIMB-to-top rule:</p><pre class="verbatim">@DefaultQualifierInHierarchy
@DefaultFor({ TypeUseLocation.EXCEPTION_PARAMETER })
public @interface NonNull {}

public @interface Nullable {}
</pre><p>As mentioned above, the exception parameters are always non-null, so
<span style="font-family:monospace">@DefaultFor({ TypeUseLocation.EXCEPTION_PARAMETER })</span> on <span style="font-family:monospace">@NonNull</span> overrides
the CLIMB-to-top rule.</p>
<!--TOC subsection id="inherited-defaults" Inherited defaults-->
<h3 id="inherited-defaults" class="subsection">26.5.4&#XA0;&#XA0;Inherited defaults <a href="#inherited-defaults" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>In certain situations, it would be convenient for an annotation on a
superclass member to be automatically inherited by subclasses that override
it. This feature would reduce both annotation effort and program
comprehensibility. In general, a program is read more often than it is
edited/annotated, so the Checker Framework does not currently support this
feature.</p><p>Currently, a user can determine the annotation on a parameter or return
value by looking at a single file. If annotations could be inherited from
supertypes, then a user would have to examine all supertypes, and do
computations over them, to understand the meaning of an unannotated type in
a given file.</p><p>Computation is necessary because different annotations might be inherited
from a supertype and an interface, or from two interfaces. For return
types, the inherited type should be the least upper bound of all
annotations on overridden implementations in supertypes. For method
parameters, the inherited type should be the greatest lower bound of all
annotations on overridden implementations in supertypes. In each case, an
error would be thrown if no such annotations existed.</p><p>In the future, this feature may be added optionally, and each type-checker
implementation can enable it if desired.</p>
<!--TOC subsection id="inherited-wildcard-annotations" Inherited wildcard annotations-->
<h3 id="inherited-wildcard-annotations" class="subsection">26.5.5&#XA0;&#XA0;Inherited wildcard annotations <a href="#inherited-wildcard-annotations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>If a wildcard is unbounded and has no annotation (e.g. <span style="font-family:monospace">List&lt;?&gt;</span>),
the annotations on the wildcard&#X2019;s bounds are copied from the type parameter
to which the wildcard is an argument.</p><p>For example, the two wildcards in
the declarations below are equivalent.</p><pre class="verbatim">class MyList&lt;@Nullable T extends @Nullable Object&gt; {}

MyList&lt;?&gt; listOfNullables;
MyList&lt;@Nullable ? extends @Nullable Object&gt; listOfNullables;
</pre><p>The Checker Framework copies
these annotations because wildcards must be within the bounds of their
corresponding type parameter.
By contrast, if the bounds of a wildcard
were defaulted differently from the bounds of its corresponding type
parameter, then there would be many false positive
<span style="font-family:monospace">type.argument.type.incompatible</span> warnings.</p><p>Here is another example of two equivalent wildcard declarations:</p><pre class="verbatim">class MyList&lt;@Regex(5) T extends @Regex(1) Object&gt; {}

MyList&lt;?&gt; listOfRegexes;
MyList&lt;@Regex(5) ? extends @Regex(1) Object&gt; listOfRegexes;
</pre><p>Note, this copying of annotations for a wildcard&#X2019;s bounds applies only to
unbounded wildcards. The two wildcards in the
following example are equivalent.</p><pre class="verbatim">class MyList&lt;@NonNull T extends @Nullable Object&gt; {}

MyList&lt;? extends Object&gt; listOfNonNulls;
MyList&lt;@NonNull ? extends @NonNull Object&gt; listOfNonNulls2;
</pre><p>Note, the upper bound of the wildcard <span style="font-family:monospace">?&#XA0;extends Object</span> is defaulted to
<span style="font-family:monospace">@NonNull</span> using the CLIMB-to-top rule (see Section&#XA0;<a href="#climb-to-top">26.5.3</a>).
Also note that the <span style="font-family:monospace">MyList</span> class declaration could have been more succinctly
written as: <span style="font-family:monospace">class MyList&lt;T extends @Nullable Object&gt;</span> where the lower bound
is implicitly the bottom annotation: <span style="font-family:monospace">@NonNull</span>.</p>
<!--TOC subsection id="defaults-classfile" Default qualifiers for <span style="font-family:monospace">.class</span> files (library defaults)-->
<h3 id="defaults-classfile" class="subsection">26.5.6&#XA0;&#XA0;Default qualifiers for <span style="font-family:monospace">.class</span> files (library defaults) <a href="#defaults-classfile" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>(<em>Note:</em> Currently, the conservative library defaults presented in this section
are off by default and can be turned on by supplying the <span style="font-family:monospace">-AuseDefaultsForUncheckedcode=bytecode</span>
command-line option. In a future release, they will be turned on
by default and it will be possible to turn them off by supplying a
<span style="font-family:monospace">-AuseDefaultsForUncheckedCode=-bytecode</span> command-line option.)</p><p>The defaulting rules presented so far apply to source code that is read by
the compiler. When the compiler reads a <span style="font-family:monospace">.class</span> file, different
defaulting rules apply.</p><p>If the checker was run during the compiler execution that created the
<span style="font-family:monospace">.class</span> file,
then there is no need for
defaults: the <span style="font-family:monospace">.class</span> file has an explicit qualifier at each type use.
(Furthermore, unless warnings were suppressed, those qualifiers are
guaranteed to be correct.)
When you are performing pluggable type-checking,
it is best to ensure that the compiler only reads such <span style="font-family:monospace">.class</span> files.
Section&#XA0;<a href="#compiling-libraries">30.4</a> discusses how to create annotated
libraries.
</p><p>If the checker was not run during the compiler execution that created the
<span style="font-family:monospace">.class</span> file, then the <span style="font-family:monospace">.class</span> file contains only the type qualifiers
that the programmer wrote explicitly. (Furthermore, there is no guarantee
that these qualifiers are correct, since they have not been checked.)
In this case, each checker decides what qualifier to use for the
locations where the programmer did not write an annotation. Unless otherwise noted, the
choice is:</p><ul class="itemize"><li class="li-itemize">
For method parameters and lower bounds, use the bottom qualifier (see
Section&#XA0;<a href="#creating-bottom-qualifier">31.4.7</a>).
</li><li class="li-itemize">For method return values, fields, and upper bounds, use the top qualifier (see
Section&#XA0;<a href="#creating-top-qualifier">31.4.7</a>).
</li></ul><p>These choices are conservative. They are likely to cause many
false-positive type-checking errors, which will help you to know which
library methods need annotations. You can then write those library
annotations (see Chapter&#XA0;<a href="#annotating-libraries">30</a>) or alternately
suppress the warnings (see Chapter&#XA0;<a href="#suppressing-warnings">27</a>).</p><p>For example, an unannotated method</p><pre class="verbatim">  String concatenate(String p1, String p2)
</pre><p>in a classfile would be interpreted as</p><pre class="verbatim">  @Top String concatenate(@Bottom String p1, @Bottom String p2)
</pre><p>There is no single possible default that is sound for fields. In the rare
circumstance that there is a mutable public field in an unannotated
library, the Checker Framework may fail to warn about code that can
misbehave at run time.</p>
<!--TOC section id="annotations-on-constructors" Annotations on constructors-->
<h2 id="annotations-on-constructors" class="section">26.6&#XA0;&#XA0;Annotations on constructors <a href="#annotations-on-constructors" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END -->
<!--TOC subsection id="annotations-on-constructor-declarations" Annotations on constructor declarations-->
<h3 id="annotations-on-constructor-declarations" class="subsection">26.6.1&#XA0;&#XA0;Annotations on constructor declarations <a href="#annotations-on-constructor-declarations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>An annotation on the &#X201C;return type&#X201D; of a constructor declaration indicates
what the constructor creates. For example,</p><pre class="verbatim">@B class MyClass {
  @C MyClass() {}
}
</pre><p>means that invoking that constructor creates a <span style="font-family:monospace">@C MyClass</span>.</p><p>The Checker Framework cannot verify that the constructor really creates
such an object, because the Checker Framework does not know the
type-system-specific semantics of the <span style="font-family:monospace">@C</span> annotation.
Therefore, if the constructor result type is different than the top annotation in the
hierarchy, the Checker Framework will issue a warning.
The programmer should check the annotation manually, then
suppress the warning.</p>
<!--TOC subsubsection id="constructor-declaration-defaults" Defaults-->
<h4 id="constructor-declaration-defaults" class="subsubsection">Defaults <a href="#constructor-declaration-defaults" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h4><!--SEC END --><p>If a constructor declaration is unannotated, it defaults to the same type as that of
its enclosing class (rather than the default qualifier in the hierarchy).
For example, the Tainting Checker (Chapter&#XA0;<a href="#tainting-checker">10</a>) has <span style="font-family:monospace">@Tainted</span>
as its default qualifier. Consider the following class:</p><pre class="verbatim">  @Untainted class MyClass {
    MyClass() {}
  }
</pre><p>The constructor declaration is equivalent to <span style="font-family:monospace">@Untainted MyClass() </span><span style="font-family:monospace">{</span><span style="font-family:monospace">}</span>.</p><p>The Checker Framework produces the same error messages for
explicitly-written and defaulted annotations.</p>
<!--TOC subsection id="annotations-on-constructor-invocations" Annotations on constructor invocations-->
<h3 id="annotations-on-constructor-invocations" class="subsection">26.6.2&#XA0;&#XA0;Annotations on constructor invocations <a href="#annotations-on-constructor-invocations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The type of a method call expression <span style="font-family:monospace">x.myMethod(y, z)</span> is determined by
the return type of the declaration of <span style="font-family:monospace">myMethod</span>. There is no way to
write an annotation on the call to change its type. However, it is
possible to write a cast: <span style="font-family:monospace">(@Anno SomeType) x.myMethod(y, z)</span>. The Checker
Framework will issue a warning that it cannot verify that the downcast is
correct. The programmer should manually determine that the annotation is
correct and then suppress the warning.</p><p>A constructor invocation <span style="font-family:monospace">new MyClass()</span> is also a call, so its semantics
are similar. The type of the expression is determined by the annotation on
the result type of the constructor declaration. It is possible to write a cast
<span style="font-family:monospace">(@Anno MyClass) new MyClass()</span>. The syntax <span style="font-family:monospace">new @Anno MyClass()</span> is shorthand
for the cast. For either syntax, the Checker Framework will issue a
warning that it cannot verify that the cast is correct. The programmer may
suppress the warning if the code is correct.</p>
<!--TOC section id="type-refinement" Type refinement (flow-sensitive type qualifier inference)-->
<h2 id="type-refinement" class="section">26.7&#XA0;&#XA0;Type refinement (flow-sensitive type qualifier inference) <a href="#type-refinement" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The
checkers treat expressions within a method body as having a
subtype of their declared or defaulted (Section&#XA0;<a href="#defaults">26.5</a>)
type.</p><p>Type refinement eliminates some false positive warnings.
Type refinement also
reduces your burden of writing type qualifiers in your program,
since you do not need to write type qualifiers on local variables.</p>
<!--TOC subsection id="type-refinement-examples" Type refinement examples-->
<h3 id="type-refinement-examples" class="subsection">26.7.1&#XA0;&#XA0;Type refinement examples <a href="#type-refinement-examples" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Here is an example for the Nullness Checker
(Chapter&#XA0;<a href="#nullness-checker">3</a>).
<span style="font-family:monospace">myVar</span> is declared as <span style="font-family:monospace">@Nullable String</span>, but
it is treated as <span style="font-family:monospace">@NonNull String</span> within the body of the <span style="font-family:monospace">if</span> test.</p><pre class="verbatim">  @Nullable String myVar;
  ...                   // myVar has type @Nullable String here.
  myVar.hashCode();     // warning: possible dereference of null.
  ...
  if (myVar != null) {
    ...                 // myVar has type @NonNull String here.
    myVar.hashCode();   // no warning.
  }
</pre><p>Here is another example.
Note that the same expression may yield a
warning or not depending on its context (that is, depending on the current
type refinement).</p><pre class="verbatim">  @Nullable String myVar;
  ...                   // myVar has type @Nullable String
  myVar = "hello";
  ...                   // myVar has type @NonNull String
  myVar.hashCode();     // no warning
  ...
  myVar = myMap.get(someKey);
  ...                   // myVar has type @Nullable String
  myVar.hashCode();     // warning: posible dereference of null
</pre><p>Type refinement applies to every checker, including new
checkers that you write. Here is an example for the Regex Checker
(Chapter&#XA0;<a href="#regex-checker">11</a>):</p><pre class="verbatim">  void m2(@Unannotated String s) {
    s = RegexUtil.asRegex(s, 2);  // asRegex throws an exception if its argument is not
                                  // a regex with the given number of capturing groups
    ...   // s now has type "@Regex(2) String"
  }
</pre>
<!--TOC subsection id="type-refinement-behavior" Type refinement behavior-->
<h3 id="type-refinement-behavior" class="subsection">26.7.2&#XA0;&#XA0;Type refinement behavior <a href="#type-refinement-behavior" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The checker treats a variable or expression as a subtype of its declared type:
</p><ul class="itemize"><li class="li-itemize">
starting at the time that
it is assigned a value,
a method establishes a postcondition (e.g., as
expressed by <a href="../api/org/checkerframework/checker/nullness/qual/EnsuresNonNull.html"><span style="font-family:monospace">@EnsuresNonNull</span></a> or
<a href="../api/org/checkerframework/framework/qual/EnsuresQualifierIf.html"><span style="font-family:monospace">@EnsuresQualifierIf</span></a>), or
a run-time check is performed (e.g., via an assertion or
<span style="font-family:monospace">if</span> statement).
</li><li class="li-itemize">until its value might change (e.g.,
via an assignment, or because a method call might have a side effect).
</li></ul><p>The checker never treats a variable as
a supertype of its declared type. For example, an expression with declared type <a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a>
type is never treated as possibly-null, and such an assignment is always illegal.</p><p>The functionality has a variety of names: automatic type refinement,
flow-sensitive type qualifier inference, local type inference, and
sometimes just &#X201C;flow&#X201D;.</p>
<!--TOC subsection id="type-refinement-which-types" Which types are refined-->
<h3 id="type-refinement-which-types" class="subsection">26.7.3&#XA0;&#XA0;Which types are refined <a href="#type-refinement-which-types" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>You generally do not need to annotate the top-level type of a local variable.
You do need to annotate its type arguments or array element types.
(Type refinement does not change them, because doing so would not produce a
subtype, as explained in see Section&#XA0;<a href="#covariant-type-parameters">25.1.6</a> and
Section&#XA0;<a href="#invariant-arrays">26.1</a>.)
Type refinement works within a method, so you still need to
annotate method signatures (parameter and return type) and field types.</p><p>If you find examples where you think a value should be inferred to have
(or not have) a
given annotation, but the checker does not do so, please submit a bug
report (see Section&#XA0;<a href="#reporting-bugs">34.2</a>) that includes a small piece of
Java code that reproduces the problem.</p>
<!--TOC subsubsection id="type-refinement-fields" Fields and type refinement-->
<h4 id="type-refinement-fields" class="subsubsection">Fields and type refinement <a href="#type-refinement-fields" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h4><!--SEC END --><p>Type refinement infers the type of fields in some restricted cases:</p><ul class="itemize"><li class="li-itemize">A final initialized field:
Type inference is performed for final fields that are initialized to a
compile-time constant at the declaration site; so the type of <span style="font-family:monospace">protocol</span>
is <span style="font-family:monospace">@NonNull String</span> in the following declaration:<pre class="verbatim">    public final String protocol = "https";
</pre><p>Such an inferred type may leak to the public interface of the class.
If you wish to override such behavior, you can explicitly insert the desired
annotation, e.g.,</p><pre class="verbatim">    public final @Nullable String protocol = "https";
</pre></li><li class="li-itemize">Within method bodies:
Type inference is performed for fields in the context of method bodies,
like local variables or any other expression.
Consider the following example, where <span style="font-family:monospace">updatedAt</span> is a nullable
field:<pre class="verbatim">class DBObject {
  @Nullable Date updatedAt;

  void m() {
    // updatedAt is @Nullable, so warning about .getTime()
    ... updatedAt.getTime() ... // warning about possible NullPointerException

    if (updatedAt == null) {
      updatedAt = new Date();
    }

    // updatedAt is now @NonNull, so .getTime() call is OK
    ... updatedAt.getTime() ...
  }
}
</pre><p>A method call may invalidate inferences about field types; see
Section&#XA0;<a href="#type-refinement-purity">26.7.5</a>.</p></li></ul>
<!--TOC subsection id="type-refinement-runtime-tests" Run-time tests and type refinement-->
<h3 id="type-refinement-runtime-tests" class="subsection">26.7.4&#XA0;&#XA0;Run-time tests and type refinement <a href="#type-refinement-runtime-tests" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Some type systems support a run-time test that the Checker Framework can
use to refine types within the scope of a conditional such as <span style="font-family:monospace">if</span>, after
an <span style="font-family:monospace">assert</span> statement, etc.</p><p>Whether a type system supports such a run-time test depends on whether the
type system is computing properties of data itself, or properties of
provenance (the source of the data). An example of a property about data is
whether a string is a regular expression. An example of a property about
provenance is units of measure: there is no way to look at the
representation of a number and determine whether it is intended to
represent kilometers or miles.</p><p>Type systems that support a run-time test are:
</p><ul class="itemize"><li class="li-itemize">
<a href="#nullness-checker">Nullness Checker</a> for null pointer errors
(see Chapter&#XA0;<a href="#nullness-checker">3</a>)
</li><li class="li-itemize"><a href="#map-key-checker">Map Key Checker</a> to track which values are
keys in a map (see Chapter&#XA0;<a href="#map-key-checker">4</a>)
</li><li class="li-itemize"><a href="#optional-checker">Optional Checker</a> for errors in using the
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html"><span style="font-family:monospace">Optional</span></a> type (see
Chapter&#XA0;<a href="#optional-checker">5</a>)
</li><li class="li-itemize"><a href="#lock-checker">Lock Checker</a> for concurrency and lock errors
(see Chapter&#XA0;<a href="#lock-checker">7</a>)
</li><li class="li-itemize"><a href="#index-checker">Index Checker</a> for array accesses
(see Chapter&#XA0;<a href="#index-checker">8</a>)
</li><li class="li-itemize"><a href="#regex-checker">Regex Checker</a> to prevent use of syntactically
invalid regular expressions (see Chapter&#XA0;<a href="#regex-checker">11</a>)
</li><li class="li-itemize"><a href="#formatter-checker">Format String Checker</a> to ensure that format
strings have the right number and type of <span style="font-family:monospace">%</span> directives (see
Chapter&#XA0;<a href="#formatter-checker">12</a>)
</li><li class="li-itemize"><a href="#i18n-formatter-checker">Internationalization Format String Checker</a>
to ensure that i18n format strings have the right number and type of
<span style="font-family:monospace">{}</span> directives (see Chapter&#XA0;<a href="#i18n-formatter-checker">13</a>)
</li></ul><p>Type systems that do not currently support a run-time test, but could do so with some
additional implementation work, are</p><ul class="itemize"><li class="li-itemize">
<a href="#interning-checker">Interning Checker</a> for errors in equality
testing and interning (see Chapter&#XA0;<a href="#interning-checker">6</a>)
</li><li class="li-itemize"><a href="#propkey-checker">Property File Checker</a> to ensure that valid
keys are used for property files and resource bundles (see
Chapter&#XA0;<a href="#propkey-checker">14</a>)
</li><li class="li-itemize"><a href="#i18n-checker">Internationalization Checker</a> to
ensure that code is properly internationalized (see
Chapter&#XA0;<a href="#i18n-checker">14.2</a>)
</li><li class="li-itemize"><a href="#signature-checker">Signature String Checker</a> to ensure that the
string representation of a type is properly used, for example in
<span style="font-family:monospace">Class.forName</span> (see Chapter&#XA0;<a href="#signature-checker">15</a>).
</li><li class="li-itemize"><a href="#constant-value-checker">Constant Value Checker</a> to determine
whether an expression&#X2019;s value can be known at compile time
(see Chapter&#XA0;<a href="#constant-value-checker">21</a>)
</li></ul><p>Type systems that cannot support a run-time test are:</p><ul class="itemize"><li class="li-itemize">
<a href="#initialization-checker">Initialization Checker</a> to ensure all
fields are set in the constructor (see
Chapter&#XA0;<a href="#initialization-checker">3.8</a>)
</li><li class="li-itemize"><a href="#fenum-checker">Fake Enum Checker</a> to allow type-safe fake enum
patterns and type aliases or typedefs (see Chapter&#XA0;<a href="#fenum-checker">9</a>)
</li><li class="li-itemize"><a href="#tainting-checker">Tainting Checker</a> for trust and security errors
(see Chapter&#XA0;<a href="#tainting-checker">10</a>)
</li><li class="li-itemize"><a href="#guieffect-checker">GUI Effect Checker</a> to ensure that non-GUI
threads do not access the UI, which would crash the application
(see Chapter&#XA0;<a href="#guieffect-checker">16</a>)
</li><li class="li-itemize"><a href="#units-checker">Units Checker</a> to ensure operations are
performed on correct units of measurement
(see Chapter&#XA0;<a href="#units-checker">17</a>)
</li><li class="li-itemize"><a href="#signedness-checker">Signedness Checker</a> to
ensure unsigned and signed values are not mixed
(see Chapter&#XA0;<a href="#signedness-checker">18</a>)
</li><li class="li-itemize"><a href="#aliasing-checker">Aliasing Checker</a> to identify whether
expressions have aliases (see Chapter&#XA0;<a href="#aliasing-checker">19</a>)
</li><li class="li-itemize"><a href="#purity-checker">Purity Checker</a> to identify whether
methods have side effects (see Chapter&#XA0;<a href="#aliasing-checker">19</a>)
</li><li class="li-itemize"><a href="#subtyping-checker">Subtyping Checker</a> for customized checking without
writing any code (see Chapter&#XA0;<a href="#subtyping-checker">23</a>)
</li></ul>
<!--TOC subsection id="type-refinement-purity" Side effects, determinism, purity, and type refinement-->
<h3 id="type-refinement-purity" class="subsection">26.7.5&#XA0;&#XA0;Side effects, determinism, purity, and type refinement <a href="#type-refinement-purity" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Calling a method typically causes the checker to discard its knowledge of
the refined type, because the method might assign a field.
The <a href="../api/org/checkerframework/dataflow/qual/SideEffectFree.html"><span style="font-family:monospace">@SideEffectFree</span></a> annotation indicates that
the method has no side effects, so calling it does not invalidate any
dataflow facts.</p><p>Calling a method twice might have different results, so facts known about
one call cannot be relied upon at another call.
The <a href="../api/org/checkerframework/dataflow/qual/Deterministic.html"><span style="font-family:monospace">@Deterministic</span></a> annotation indicates that
the method returns the same result every time it is called on the same
arguments.</p><p><a href="../api/org/checkerframework/dataflow/qual/Pure.html"><span style="font-family:monospace">@Pure</span></a> means both
<a href="../api/org/checkerframework/dataflow/qual/SideEffectFree.html"><span style="font-family:monospace">@SideEffectFree</span></a> and
<a href="../api/org/checkerframework/dataflow/qual/Deterministic.html"><span style="font-family:monospace">@Deterministic</span></a>.
The <a href="../api/org/checkerframework/dataflow/qual/TerminatesExecution.html"><span style="font-family:monospace">@TerminatesExecution</span></a> annotation
indicates that a given method never returns. This can enable the
type refinement to be more precise.</p><p>Chapter&#XA0;<a href="#purity-checker">20</a> gives more information about these annotations.
This section explains how to use them to improve type refinement.</p>
<!--TOC subsubsection id="type-refinement-side-effects" Side effects-->
<h4 id="type-refinement-side-effects" class="subsubsection">Side effects <a href="#type-refinement-side-effects" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h4><!--SEC END --><p>Consider the following declarations and uses:</p><pre class="verbatim">  @Nullable Object myField;

  int computeValue() { ... }

  void m() {
    ...
    if (myField != null) {
                        // The type of myField is now "@NonNull Object".
      int result = computeValue();
                        // The type of myField is now "@Nullable Object",
                        // because computeValue might have set myField to null.
      myField.toString(); // Warning: possible null pointer exception.
    }
  }
</pre><p>There are three ways to express that <span style="font-family:monospace">computeValue</span> does not set
<span style="font-family:monospace">myField</span> to <span style="font-family:monospace">null</span>, and thus to prevent the Nullness Checker from
issuing a warning about the call <span style="font-family:monospace">myField.toString()</span>.</p><ol class="enumerate" type=1><li class="li-enumerate">
If <span style="font-family:monospace">computeValue</span> has no side effects, declare it as<pre class="verbatim">  @SideEffectFree
  int computeValue() { ... }
</pre><p>The Nullness Checker issues no warnings, because it can reason that
the second occurrence of <span style="font-family:monospace">myField</span> has the same (non-null) value as
the one in the test.</p></li><li class="li-enumerate">If no method resets <span style="font-family:monospace">myField</span> to <span style="font-family:monospace">null</span> after it has been initialized
to a non-null value (even if a method has some other side effect),
declare <span style="font-family:monospace">myField</span> as <a href="../api/org/checkerframework/checker/nullness/qual/MonotonicNonNull.html"><span style="font-family:monospace">@MonotonicNonNull</span></a>.<pre class="verbatim">  @MonotonicNonNull Object myField;
</pre></li><li class="li-enumerate">If <span style="font-family:monospace">computeValue</span> sets <span style="font-family:monospace">myField</span> to a non-null value, declare it as<pre class="verbatim">  @EnsuresNonNull("myField")
  int computeValue() { ... }
</pre><p>If <span style="font-family:monospace">computeValue</span> maintains <span style="font-family:monospace">myField</span> as a non-null value, even if it
might have other side effects and even if other methods might set
<span style="font-family:monospace">myField</span> to <span style="font-family:monospace">null</span>, declare it as</p><pre class="verbatim">  @RequiresNonNull("myField")
  @EnsuresNonNull("myField")
  int computeValue() { ... }
</pre></li></ol>
<!--TOC subsubsection id="type-refinement-determinism" Deterministic methods-->
<h4 id="type-refinement-determinism" class="subsubsection">Deterministic methods <a href="#type-refinement-determinism" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h4><!--SEC END --><p>Consider the following declaration and uses:</p><pre class="verbatim">  @Nullable Object getField(Object arg) { ... }

  void m() {
    ...
    if (x.getField(y) != null) {
      x.getField(y).toString(); // warning: possible null pointer exception
    }
  }
</pre><p>The Nullness Checker issues a warning regarding the
<span style="font-family:monospace">toString()</span> call, because its receiver <span style="font-family:monospace">x.getField(y)</span> might
be <span style="font-family:monospace">null</span>, according to the <span style="font-family:monospace">@Nullable</span> return type in the
declaration of <span style="font-family:monospace">getField</span>. The Nullness Checker cannot assume that
<span style="font-family:monospace">getField</span> returns non-null on the second call, just based on the fact
that it returned non-null on the first call.</p><p>To indicate that a method returns the same value each time it is called on
the same arguments, use the <a href="../api/org/checkerframework/dataflow/qual/Deterministic.html"><span style="font-family:monospace">@Deterministic</span></a> annotation.
Actually, it is necessary to use <a href="../api/org/checkerframework/dataflow/qual/Pure.html"><span style="font-family:monospace">@Pure</span></a> which
means both <span style="font-family:monospace">@Deterministic</span> and <span style="font-family:monospace">@SideEffectFree</span>, because otherwise the
first call might change a value that the method depends on.</p><p>If you change the declaration of <span style="font-family:monospace">getField</span> to</p><pre class="verbatim">  @Pure
  @Nullable Object getField(Object arg) { ... }
</pre><p>then the Nullness Checker issues no warnings.
Because <span style="font-family:monospace">getField</span> is <span style="font-family:monospace">@SideEffectFree</span>, the values of <span style="font-family:monospace">x</span> and <span style="font-family:monospace">y</span> are the
same at both invocations.
Because <span style="font-family:monospace">getField</span> is <span style="font-family:monospace">@Deterministic</span>, the two invocations of
<span style="font-family:monospace">x.getField(y)</span> have the same value.
Therefore, <span style="font-family:monospace">x.getField(y)</span> is non-null within the <span style="font-family:monospace">then</span> branch
of the <span style="font-family:monospace">if</span> statement.</p>
<!--TOC subsection id="type-refinement-assertions" Assertions-->
<h3 id="type-refinement-assertions" class="subsection">26.7.6&#XA0;&#XA0;Assertions <a href="#type-refinement-assertions" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>If your code contains an <span style="font-family:monospace">assert</span> statement, then your code could behave
in two different ways at run time, depending on whether assertions are
enabled or disabled
via the <span style="font-family:monospace">-ea</span> or <span style="font-family:monospace">-da</span> command-line options to java.</p><p>By default, the Checker Framework outputs warnings about any error that
could happen at run time, whether assertions are enabled or disabled.</p><p>If you supply the <span style="font-family:monospace">-AassumeAssertionsAreEnabled</span> command-line option, then
the Checker Framework assumes assertions are enabled. If you supply the
<span style="font-family:monospace">-AassumeAssertionsAreDisabled</span> command-line option, then the Checker
Framework assumes assertions are disabled. You may not supply both
command-line options. It is uncommon to supply either one.</p><p>These command-line arguments have no effect on processing of <span style="font-family:monospace">assert</span>
statements whose message contains the text <span style="font-family:monospace">@AssumeAssertion</span>; see
Section&#XA0;<a href="#assumeassertion">27.2</a>.</p>
<!--TOC section id="java-expressions-as-arguments" Writing Java expressions as annotation arguments-->
<h2 id="java-expressions-as-arguments" class="section">26.8&#XA0;&#XA0;Writing Java expressions as annotation arguments <a href="#java-expressions-as-arguments" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>Sometimes, it is necessary to write a Java expression as the argument to an
annotation. The annotations that take a Java
expression as an argument include:</p><ul class="itemize"><li class="li-itemize">
<a href="../api/org/checkerframework/framework/qual/RequiresQualifier.html"><span style="font-family:monospace">@RequiresQualifier</span></a>
</li><li class="li-itemize"><a href="../api/org/checkerframework/framework/qual/EnsuresQualifier.html"><span style="font-family:monospace">@EnsuresQualifier</span></a>
</li><li class="li-itemize"><a href="../api/org/checkerframework/framework/qual/EnsuresQualifierIf.html"><span style="font-family:monospace">@EnsuresQualifierIf</span></a>
</li><li class="li-itemize"><a href="../api/org/checkerframework/checker/nullness/qual/RequiresNonNull.html"><span style="font-family:monospace">@RequiresNonNull</span></a>
</li><li class="li-itemize"><a href="../api/org/checkerframework/checker/nullness/qual/EnsuresNonNull.html"><span style="font-family:monospace">@EnsuresNonNull</span></a>
</li><li class="li-itemize"><a href="../api/org/checkerframework/checker/nullness/qual/EnsuresNonNullIf.html"><span style="font-family:monospace">@EnsuresNonNullIf</span></a>
</li><li class="li-itemize"><a href="../api/org/checkerframework/checker/nullness/qual/KeyFor.html"><span style="font-family:monospace">@KeyFor</span></a>
</li><li class="li-itemize"><a href="../api/org/checkerframework/checker/nullness/qual/EnsuresKeyFor.html"><span style="font-family:monospace">@EnsuresKeyFor</span></a>
</li><li class="li-itemize"><a href="../api/org/checkerframework/checker/nullness/qual/EnsuresKeyForIf.html"><span style="font-family:monospace">@EnsuresKeyForIf</span></a>
</li><li class="li-itemize"><a href="../api/org/checkerframework/checker/i18nformatter/qual/I18nFormatFor.html"><span style="font-family:monospace">@I18nFormatFor</span></a>
</li><li class="li-itemize"><a href="../api/org/checkerframework/checker/lock/qual/EnsuresLockHeld.html"><span style="font-family:monospace">@EnsuresLockHeld</span></a>
</li><li class="li-itemize"><a href="../api/org/checkerframework/checker/lock/qual/EnsuresLockHeldIf.html"><span style="font-family:monospace">@EnsuresLockHeldIf</span></a>
</li><li class="li-itemize"><a href="../api/org/checkerframework/checker/lock/qual/GuardedBy.html"><span style="font-family:monospace">@GuardedBy</span></a>
</li><li class="li-itemize"><a href="../api/org/checkerframework/checker/lock/qual/Holding.html"><span style="font-family:monospace">@Holding</span></a>
</li></ul><p>The set of permitted expressions is a subset of all Java expressions:</p><ul class="itemize"><li class="li-itemize">
the receiver object, <span style="font-family:monospace">this</span>. You can write <span style="font-family:monospace">this</span> to annotate any
variable or declaration where you could write <span style="font-family:monospace">this</span> in code.
Notably, it cannot be used in annotations on declarations of
static fields or methods. For a field, <span style="font-family:monospace">this</span> is the field&#X2019;s
receiver, i.e. its container. For a local variable, it is the
method&#X2019;s receiver.</li><li class="li-itemize">the receiver object as seen from the superclass, <span style="font-family:monospace">super</span>. This can be used
to refer to fields shadowed in the subclass (although shadowing fields is
discouraged in Java).</li><li class="li-itemize"><span style="font-family:monospace">&lt;self&gt;</span>, i.e. the value of the annotated reference (non-primitive) variable.
Currently only defined for the <span style="font-family:monospace">@GuardedBy</span> type system.
For example, <span style="font-family:monospace">@GuardedBy("&lt;self&gt;") Object o</span> indicates that the value
referenced by <span style="font-family:monospace">o</span> is guarded by the intrinsic (monitor) lock of the value
referenced by <span style="font-family:monospace">o</span>.</li><li class="li-itemize">a formal parameter, represented as <span style="font-family:monospace">#</span> followed by the <span style="font-weight:bold">one-based</span> parameter
index. For example: <span style="font-family:monospace">#1</span>, <span style="font-family:monospace">#3</span>. It is not permitted to write <span style="font-family:monospace">#0</span> to
refer to the receiver object; use <span style="font-family:monospace">this</span> instead. (A side note:
The formal parameter syntax <span style="font-family:monospace">#1</span> is less natural in source code
than writing the formal parameter name. This syntax is necessary for
separate compilation, when an annotated method has already been compiled
into a <span style="font-family:monospace">.class</span> file and a client of that method is later compiled.
In the <span style="font-family:monospace">.class</span> file, no formal parameter name information is available,
so it is necessary to use a number to indicate a formal parameter.)
</li><li class="li-itemize">a local variable. Write the variable name. For example: <span style="font-family:monospace">myLocalVar</span>.
The variable must be in scope; for example, a method annotation on method
<span style="font-family:monospace">m</span> cannot mention a local variable that is declared inside <span style="font-family:monospace">m</span>.</li><li class="li-itemize">a static variable. Write the class name and the variable, as in
<span style="font-family:monospace">System.out</span>.</li><li class="li-itemize">a field of any expression. For example: <span style="font-family:monospace">next</span>,
<span style="font-family:monospace">this.next</span>, <span style="font-family:monospace">#1.next</span>. You may optionally omit a leading &#X201C;<span style="font-family:monospace">this.</span>&#X201D;, just as in Java. Thus,
<span style="font-family:monospace">this.next</span> and <span style="font-family:monospace">next</span> are equivalent.</li><li class="li-itemize">an array access. For example: <span style="font-family:monospace">this.myArray[i]</span>, <span style="font-family:monospace">vals[#1]</span>.</li><li class="li-itemize">an array creation. For example: <span style="font-family:monospace">new int[10]</span>, <span style="font-family:monospace">new String[] </span><span style="font-family:monospace">"a", "b"</span>.</li><li class="li-itemize">literals: string, integer, char, long, float, double, null, class literals.</li><li class="li-itemize">a method invocation on any expression.
This even works for overloaded methods and methods with type parameters.
For example:
<span style="font-family:monospace">m1(x, y.z, #2)</span>, <span style="font-family:monospace">a.m2("hello")</span>.<p>Currently, the Checker Framework cannot prove all contracts about method
calls, so you may need to suppress some warnings.</p><p>One unusual feature of the Checker Framework&#X2019;s Java expressions is that a
method call is allowed to have side effects. Other tools forbid methods
with side effects (and doing so is necessary if a specification is going
to be checked at run time via assertions). The Checker Framework enables
you to state more facts. For example, consider the annotation on
<span style="font-family:monospace">java.io.BufferedReader.ready()</span>:</p><pre class="verbatim">  @EnsuresNonNullIf(expression="readLine()", result=true)
  @Pure public boolean ready() throws IOException { ... }
</pre><p>This states that if <span style="font-family:monospace">readLine()</span> is called immediately after <span style="font-family:monospace">ready()</span>
returns true, then <span style="font-family:monospace">readLine()</span> returns a non-null value.</p></li></ul><p><span style="font-weight:bold">Limitations:</span>
The following Java expressions may not currently be written:
</p><ul class="itemize"><li class="li-itemize">
String concatenation expressions.
</li><li class="li-itemize">Mathematical operators (plus, minus, division, ...).
</li><li class="li-itemize">Comparisons (equality, less than, etc.).
</li></ul><p>Additionally, it is not possible to write
quantification over all array components (e.g. to express that all
array elements are non-null). There is no such Java expression, but it
would be useful when writing specifications.</p>
<!--TOC section id="field-invariants" Field invariants-->
<h2 id="field-invariants" class="section">26.9&#XA0;&#XA0;Field invariants <a href="#field-invariants" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>Sometimes a field declared in a superclass has a more precise type in a
subclass. To express this fact, write
<a href="../api/org/checkerframework/framework/qual/FieldInvariant.html"><span style="font-family:monospace">@FieldInvariant</span></a> on the subclass. It specifies
the field&#X2019;s type in the class on which this annotation is written.
The field must be declared in a superclass and
must be final.</p><p>For example,
</p><pre class="verbatim">class Person {
  final @Nullable String nickname;
  public Person(@Nullable String nickname) {
    this.nickname = nickname;
  }
}

// A rapper always has a nickname.
@FieldInvariant(qualifier = NonNull.class, field = "nickname")
class Rapper extends Person {
  public Rapper(String nickname) {
    super(nickname);
  }
  void method() {
    ... nickname.length() ...   // legal, nickname is non-null in this class.
  }
}
</pre><p>A field invariant annotation can refer to more than one field. For example,
<span style="font-family:monospace">@FieldInvariant(qualifier = NonNull.class, field = {fieldA, fieldB})</span> means
that <span style="font-family:monospace">fieldA</span> and <span style="font-family:monospace">fieldB</span> are both non-null in the class upon which the
annotation is written. A field invariant annotation
can also apply different qualifiers to different fields. For example,
<span style="font-family:monospace">@FieldInvariant(qualifier = {NonNull.class, Untainted.class}, field =
{fieldA, fieldB})</span> means that <span style="font-family:monospace">fieldA</span> is non-null and <span style="font-family:monospace">fieldB</span> is untainted.</p><p>This annotation is inherited: if a superclass is annotated with
<span style="font-family:monospace">@FieldInvariant</span>, its subclasses have the same annotation. If a subclass has its
own <span style="font-family:monospace">@FieldInvariant</span>, then it must include the fields in the superclass
annotation and those fields&#X2019; annotations must be a subtype (or equal) to the
annotations for those fields in the superclass <span style="font-family:monospace">@FieldInvariant</span>.</p><p>Currently, the <span style="font-family:monospace">@FieldInvariant</span> annotation is trusted rather than
checked. In other words, the <span style="font-family:monospace">@FieldInvariant</span> annotation introduces a
loophole in the type system, which requires verification by other means
such as manual examination.</p>
<!--TOC section id="unused-fields" Unused fields-->
<h2 id="unused-fields" class="section">26.10&#XA0;&#XA0;Unused fields <a href="#unused-fields" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>In an inheritance hierarchy, subclasses often introduce new methods and
fields. For example, a <span style="font-family:monospace">Marsupial</span> (and its subclasses such as
<span style="font-family:monospace">Kangaroo</span>) might have a variable <span style="font-family:monospace">pouchSize</span> indicating the size of the animal&#X2019;s
pouch. The field does not exist in superclasses such as
<span style="font-family:monospace">Mammal</span> and <span style="font-family:monospace">Animal</span>, so Java issues a compile-time
error if a program tries to access <span style="font-family:monospace">myMammal.pouchSize</span>.</p><p>If you cannot use subtypes in your program, you can enforce similar
requirements using type qualifiers.
For fields, use the <span style="font-family:monospace">@Unused</span> annotation (Section&#XA0;<a href="#unused-annotation">26.10.1</a>), which enforces that a field or method may only
be accessed from a receiver expression with a given annotation (or one of
its subtypes).
For methods, annotate the receiver parameter <span style="font-family:monospace">this</span>; then a method call
type-checks only if the actual receiver is of the specified type.</p><p>Also see the discussion of typestate checkers, in
Chapter&#XA0;<a href="#typestate-checker">24.1</a>.</p>
<!--TOC subsection id="unused-annotation" <span style="font-family:monospace">@Unused</span> annotation-->
<h3 id="unused-annotation" class="subsection">26.10.1&#XA0;&#XA0;<span style="font-family:monospace">@Unused</span> annotation <a href="#unused-annotation" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>A Java subtype can have more fields than its supertype. For example:</p><pre class="verbatim">class Animal {}
class Mammal extends Animal { ... }
class Marsupial extends Mammal {
  int pouchSize;  // pouch capacity, in cubic centimeters
  ...
}
</pre><p>You can simulate
the same effect for type qualifiers:
the <a href="../api/org/checkerframework/framework/qual/Unused.html"><span style="font-family:monospace">@Unused</span></a> annotation
on a field declares that the field may <em>not</em> be accessed via a receiver of
the given qualified type (or any <em>super</em>type).
For example:</p><pre class="verbatim">class Animal {
  @Unused(when=Mammal.class)
  int pouchSize;  // pouch capacity, in cubic centimeters
  ...
}
@interface Mammal {}
@interface Marsupial {}

@Marsupial Animal joey = ...;
... joey.pouchSize ...    // OK
@Mammal Animal mae = ...;
... mae.pouchSize ...    // compile-time error
</pre><p>The above class declaration is like writing</p><pre class="verbatim">class @Mammal-Animal { ... }
class @Marsupial-Animal {
  int pouchSize;  // pouch capacity, in cubic centimeters
  ...
}
</pre><hr>
<!--TOC chapter id="suppressing-warnings" Suppressing warnings-->
<h1 id="suppressing-warnings" class="chapter">Chapter&#XA0;27&#XA0;&#XA0;Suppressing warnings <a href="#suppressing-warnings" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h1><!--SEC END --><p>When the Checker Framework reports a warning, it&#X2019;s best to fix the
underlying problem, by changing the code or its annotations. For each
warning, follow the methodology in Section&#XA0;<a href="#handling-warnings">2.4.5</a> to
correct the underlying problem.</p><p>This section describes what to do if the methodology of
Section&#XA0;<a href="#handling-warnings">2.4.5</a> indicates that you need to suppress the
warning. You won&#X2019;t change your code, but you will prevent the Checker
Framework from reporting this particular warning to you. (Changing the
code to fix a bug is another way to prevent the Checker Framework from
issuing a warning, but it is not what this chapter is about.)</p><p>You may wish to suppress checker warnings because of unannotated libraries
or un-annotated portions of your own code, because of application
invariants that are beyond the capabilities of the type system, because of
checker limitations, because you are interested in only some of the
guarantees provided by a checker, or for other reasons.
Suppressing a warning is similar to writing a cast in a Java
program: the programmer knows more about the type than the type system does
and uses the warning suppression or cast to convey that information to the
type system.</p><p>You can suppress a warning message in a single variable initializer,
method, or class by using the following mechanisms:</p><ul class="itemize"><li class="li-itemize">
the <span style="font-family:monospace">@SuppressWarnings</span> annotation
(Section&#XA0;<a href="#suppresswarnings-annotation">27.1</a>), or
</li><li class="li-itemize">the <span style="font-family:monospace">@AssumeAssertion</span> string in an <span style="font-family:monospace">assert</span> message (Section&#XA0;<a href="#assumeassertion">27.2</a>).
</li></ul><p>You can suppress warnings throughout the codebase by using the following mechanisms:</p><ul class="itemize"><li class="li-itemize">
the <span style="font-family:monospace">-AsuppressWarnings</span> command-line option (Section&#XA0;<a href="#suppresswarnings-command-line">27.3</a>),
</li><li class="li-itemize">the <span style="font-family:monospace">-AskipUses</span> and <span style="font-family:monospace">-AonlyUses</span> command-line options (Section&#XA0;<a href="#askipuses">27.4</a>),
</li><li class="li-itemize">the <span style="font-family:monospace">-AskipDefs</span> and <span style="font-family:monospace">-AonlyDefs</span> command-line options (Section&#XA0;<a href="#askipdefs">27.5</a>),
</li><li class="li-itemize">the <span style="font-family:monospace">-AuseDefaultsForUncheckedCode=source</span> command-line
option (Section&#XA0;<a href="#compiling-libraries">30.4</a>),
</li><li class="li-itemize">the <span style="font-family:monospace">-Alint</span> command-line option enables/disables optional checks (Section&#XA0;<a href="#alint">27.6</a>), or
</li><li class="li-itemize">not running the annotation processor
(Section&#XA0;<a href="#no-processor">27.7</a>).
</li></ul><p>Some type checkers can suppress warnings via
</p><ul class="itemize"><li class="li-itemize">
checker-specific mechanisms (Section&#XA0;<a href="#checker-specific-suppression">27.8</a>).
</li></ul><p>The rest of this chapter explains these mechanisms in turn.</p><p>You can use the <span style="font-family:monospace">-AwarnUnneededSuppressions</span> command-line option to issue a
warning if a <span style="font-family:monospace">@SuppressWarnings</span> did not suppress any warnings issued by the current checker.</p>
<!--TOC section id="suppresswarnings-annotation" <span style="font-family:monospace">@SuppressWarnings</span> annotation-->
<h2 id="suppresswarnings-annotation" class="section">27.1&#XA0;&#XA0;<span style="font-family:monospace">@SuppressWarnings</span> annotation <a href="#suppresswarnings-annotation" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>
You can suppress specific errors and warnings by use of the
<span style="font-family:monospace">@SuppressWarnings</span> annotation, for example
<span style="font-family:monospace">@SuppressWarnings("interning")</span> or <span style="font-family:monospace">@SuppressWarnings("nullness")</span>.
Section&#XA0;<a href="#suppresswarnings-annotation-syntax">27.1.1</a> explains the syntax of the
argument string.
</p><p>A <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/SuppressWarnings.html"><span style="font-family:monospace">@SuppressWarnings</span></a>
annotation may be placed on program declarations such as a local
variable declaration, a method, or a class. It suppresses all warnings
within that program element.
Section&#XA0;<a href="#suppresswarnings-annotation-locations">27.1.2</a> discusses where the
annotation may be written in source code.</p><p>Section&#XA0;<a href="#suppresswarnings-best-practices">27.1.3</a> gives best practices for
writing <span style="font-family:monospace">@SuppressWarnings</span> annotations.</p>
<!--TOC subsection id="suppresswarnings-annotation-syntax" <span style="font-family:monospace">@SuppressWarnings</span> syntax-->
<h3 id="suppresswarnings-annotation-syntax" class="subsection">27.1.1&#XA0;&#XA0;<span style="font-family:monospace">@SuppressWarnings</span> syntax <a href="#suppresswarnings-annotation-syntax" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The <span style="font-family:monospace">@SuppressWarnings</span> annotation takes a string argument, in one of
the following forms:
<span style="font-family:monospace">"</span><span style="font-family:monospace"><em>checkername</em></span><span style="font-family:monospace">:</span><span style="font-family:monospace"><em>messagekey</em></span><span style="font-family:monospace">"</span>,
<span style="font-family:monospace">"</span><span style="font-family:monospace"><em>checkername</em></span><span style="font-family:monospace">"</span>,
or
<span style="font-family:monospace">"</span><span style="font-family:monospace"><em>messagekey</em></span><span style="font-family:monospace">"</span>.</p><p>The argument <em>checkername</em> is
in lower case and is derived from the way you invoke the checker. For
example, if you invoke a checker as
<span style="font-family:monospace">javac -processor MyNiftyChecker ...</span>,
then you would suppress its error messages with
<span style="font-family:monospace">@SuppressWarnings("mynifty")</span>. (An exception is the Subtyping
Checker, for which you use the annotation name; see
Section&#XA0;<a href="#subtyping-using">23.1</a>.)
Sometimes, a checker honors <em>checkername</em> arguments; use
the <span style="font-family:monospace">-AshowSuppressWarningKeys</span> command-line option to see them.
Using <span style="font-family:monospace">"all"</span> as the checkername applies to all checkers; this is not
recommended, except for messages common to all checkers such as
purity-related messages when using <span style="font-family:monospace">-AcheckPurityAnnotations</span>.</p><p>The argument <em>messagekey</em> is the message key for the error.
Each warning message from the compiler gives the most specific
suppression key that can be used to suppress that warning.
An example is <span style="font-family:monospace">dereference.of.nullable</span> in</p><pre class="verbatim">MyFile.java:107: error: [dereference.of.nullable] dereference of possibly-null reference myList
          myList.add(elt);
          ^
</pre><p>You are allowed to use any substring of a message key. Beware writing a very
short messagekey, because it might suppress more warnings than you expect.</p><p>If the <em>checkername</em> part is omitted, the <span style="font-family:monospace">@SuppressWarnings</span> applies
to all checkers.
If the <em>messagekey</em> part is omitted, the <span style="font-family:monospace">@SuppressWarnings</span> applies
to all messages (it suppresses all warnings from the given checker).</p><p>With the <span style="font-family:monospace">-ArequirePrefixInWarningSuppressions</span> command-line
option, a warning is only suppressed if the key is in the
<span style="font-family:monospace">"</span><span style="font-family:monospace"><em>checkername</em></span><span style="font-family:monospace">"</span> or
<span style="font-family:monospace">"</span><span style="font-family:monospace"><em>checkername</em></span><span style="font-family:monospace">:</span><span style="font-family:monospace"><em>messagekey</em></span><span style="font-family:monospace">"</span>
format, as in
<span style="font-family:monospace">@SuppressWarnings("nullness")</span> or
<span style="font-family:monospace">@SuppressWarnings("nullness:assignment.type.incompatible")</span>.</p>
<!--TOC subsection id="suppresswarnings-annotation-locations" Where <span style="font-family:monospace">@SuppressWarnings</span> can be written-->
<h3 id="suppresswarnings-annotation-locations" class="subsection">27.1.2&#XA0;&#XA0;Where <span style="font-family:monospace">@SuppressWarnings</span> can be written <a href="#suppresswarnings-annotation-locations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p><span style="font-family:monospace">@SuppressWarnings</span> is a declaration annotation, so it may be placed on
program declarations such as a local variable declaration, a method, or a
class. It cannot be used on statements, expressions, or types.
(<span style="font-family:monospace">assert</span> plus <span style="font-family:monospace">@AssumeAssertion</span> can be used between statements and can
affect arbitrary expressions; see Section&#XA0;<a href="#assumeassertion">27.2</a>.)</p><p>Always write a <span style="font-family:monospace">@SuppressWarnings</span> annotation on the smallest possible
scope. To reduce the scope of a <span style="font-family:monospace">@SuppressWarnings</span> annotation, it is
sometimes desirable to refactor the code. You might extract an expression
into a local variable, so that warnings can be suppressed just for that
local variable&#X2019;s initializer expression. Likewise, you might extract some
code into a separate method, so that warnings can be suppressed just for
its body. Or, you can use <span style="font-family:monospace">@AssumeAssertion</span> on an <span style="font-family:monospace">assert</span> statement;
see Section&#XA0;<a href="#assumeassertion">27.2</a>.</p><p>As an example, consider suppressing a warning at an assignment that you know is
safe. Here is an example that uses the Tainting Checker
(Section&#XA0;<a href="#tainting-checker">10</a>). Assume that <span style="font-family:monospace">expr</span> has compile-time
(declared) type <span style="font-family:monospace">@Tainted String</span>, but you know that the run-time value of
<span style="font-family:monospace">expr</span> is untainted.</p><pre class="verbatim">  @SuppressWarnings("tainting:cast.unsafe") // expr is untainted because ... [explanation goes here]
  @Untainted String myvar = expr;
</pre><p>Java does not permit annotations (such as <span style="font-family:monospace">@SuppressWarnings</span>) on
assignments (or on other statements or expressions), so
it would have been <em>illegal</em> to write</p><pre class="verbatim">  @Untainted String myvar;
  ...
  @SuppressWarnings("tainting:cast.unsafe") // expr is untainted because ...
  myvar = expr;
</pre>
<!--TOC subsection id="suppresswarnings-best-practices" Good practices when suppressing warnings-->
<h3 id="suppresswarnings-best-practices" class="subsection">27.1.3&#XA0;&#XA0;Good practices when suppressing warnings <a href="#suppresswarnings-best-practices" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END -->
<!--TOC subsubsection id="suppresswarnings-best-practices-smallest-scope" Suppress warnings in the smallest possible scope-->
<h4 id="suppresswarnings-best-practices-smallest-scope" class="subsubsection">Suppress warnings in the smallest possible scope <a href="#suppresswarnings-best-practices-smallest-scope" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h4><!--SEC END --><p>Prefer <span style="font-family:monospace">@SuppressWarnings</span> on a local variable to one on a method, and
prefer one on a method to one on a class.</p><p>You may be able to suppress a warning about a use of an expression by
writing <span style="font-family:monospace">@AssumeAssertion</span> for the expression, before the use. See
Section&#XA0;<a href="#assumeassertion">27.2</a>.</p><p>Another way to reduce the scope of a <span style="font-family:monospace">@SuppressWarnings</span> is to
extract the expression into a new local variable
and place a <span style="font-family:monospace">@SuppressWarnings</span> annotation on the variable
declaration. See Section&#XA0;<a href="#suppresswarnings-annotation-locations">27.1.2</a>.</p>
<!--TOC subsubsection id="suppresswarnings-best-practices-specific-argument" Use a specific argument to <span style="font-family:monospace">@SuppressWarnings</span>-->
<h4 id="suppresswarnings-best-practices-specific-argument" class="subsubsection">Use a specific argument to <span style="font-family:monospace">@SuppressWarnings</span> <a href="#suppresswarnings-best-practices-specific-argument" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h4><!--SEC END --><p><a id="compiler-message-keys"></a></p><p>It is best to use the most specific possible message key to suppress just a
specific error that you know to be a false positive. The checker outputs
this message key when it issues an error. If you use a broader
<span style="font-family:monospace">@SuppressWarnings</span> annotation, then it may mask other errors that you
needed to know about.</p><p>Any of the following would have suppressed the warning in
Section&#XA0;<a href="#suppresswarnings-annotation-locations">27.1.2</a>:</p><pre class="verbatim">  @SuppressWarnings("tainting")              // suppresses all tainting-related warnings
  @SuppressWarnings("cast")                  // suppresses warnings from all checkers about casts
  @SuppressWarnings("unsafe")                // suppresses warnings from all checkers about unsafe code
  @SuppressWarnings("cast.unsafe")           // suppresses warnings from all checkers about unsafe casts
  @SuppressWarnings("tainting:cast")         // suppresses tainting warnings about casts
  @SuppressWarnings("tainting:unsafe")       // suppresses tainting warnings about unsafe code
  @SuppressWarnings("tainting:cast.unsafe")  // suppresses tainting warnings about unsafe casts
</pre><p>The last one is the most specific, and therefore is the best style.</p>
<!--TOC subsubsection id="suppresswarnings-best-practices-justification" Justify why the warning is a false positive-->
<h4 id="suppresswarnings-best-practices-justification" class="subsubsection">Justify why the warning is a false positive <a href="#suppresswarnings-best-practices-justification" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h4><!--SEC END --><p>A <span style="font-family:monospace">@SuppressWarnings</span> annotation asserts that the programmer knows that
the code is actually correct or safe (that is, no undesired behavior will
occur), even though the type system is unable to prove that the code is
correct or safe.</p><p>Whenever you write a <span style="font-family:monospace">@SuppressWarnings</span> annotation, you should also
write, typically on the same line, a code comment
explaining why the code is actually correct. In some cases you might also
justify why the code cannot be rewritten in a simpler way that would be
amenable to type-checking. Also make it clear what error is being
suppressed. (This is particularly important when the <span style="font-family:monospace">@SuppressWarnings</span> is
on a method declaration and the suppressed warning might be anywhere in the
method body.)</p><p>This documentation will help you and others to understand the reason for
the <span style="font-family:monospace">@SuppressWarnings</span> annotation. It will also help you audit your code
to verify all the warning suppressions. (The code is correct only if the
checker issues no warnings <em>and</em> each <span style="font-family:monospace">@SuppressWarnings</span> is correct.)</p><p>A suppression message like &#X201C;a.f is not null&#X201D; is not useful. The fact
that you are suppressing the warning means that you believe that <span style="font-family:monospace">a.f</span> is
not null. The message should explain <em>why</em> you believe that; for
example, &#X201C;a.f was checked above and no subsequent side effect can affect it&#X201D;.</p><p>Here are some terse examples from libraries in <a href="https://github.com/plume-lib/">plume-lib</a>:</p><pre class="verbatim">@SuppressWarnings("purity") // side effect to local state of type BitSet
@SuppressWarnings("cast") // cast is redundant (except when checking nullness)
@SuppressWarnings("interning") // FbType.FREE is interned but is not annotated
@SuppressWarnings("interning") // equality testing optimization
@SuppressWarnings("nullness") // used portion of array is non-null
@SuppressWarnings("nullness") // oi.factory is a static method, so null first argument is OK
</pre><p>A particularly good (and concise) justification is to reference an issue in
the issue tracker, as in these two from <a href="https://plse.cs.washington.edu/daikon/">Daikon</a>:</p><pre class="verbatim">@SuppressWarnings("keyfor") // https://tinyurl.com/cfissue/877
@SuppressWarnings("flowexpr.parse.error") // https://tinyurl.com/cfissue/862
</pre><p>Please report false positive warnings, then reference them in your warning suppressions.
This permits the Checker Framework maintainers to know about the
problem, it helps them with prioritization (by knowing how often in your
codebase a particular issue arises), and it enables you to know when an
issue has been fixed (though the <span style="font-family:monospace">-AwarnUnneededSuppressions</span> command-line
option also serves the latter purpose).</p>
<!--TOC section id="assumeassertion" <span style="font-family:monospace">@AssumeAssertion</span> string in an <span style="font-family:monospace">assert</span> message-->
<h2 id="assumeassertion" class="section">27.2&#XA0;&#XA0;<span style="font-family:monospace">@AssumeAssertion</span> string in an <span style="font-family:monospace">assert</span> message <a href="#assumeassertion" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>
You can suppress a warning by <span style="font-family:monospace">assert</span>ing that some property is true, and
placing the string <span style="font-family:monospace">@AssumeAssertion(</span><span style="font-family:monospace"><em>warningkey</em></span><span style="font-family:monospace">)</span> in the assertion
message.
</p><p>For example, in this code:</p><pre class="verbatim">while (c != Object.class) {
  ...
  c = c.getSuperclass();
  assert c != null
    : "@AssumeAssertion(nullness): c was not Object, so its superclass is not null";
 }
</pre><p>the Nullness Checker assumes that <span style="font-family:monospace">c</span> is non-null from the <span style="font-family:monospace">assert</span>
statement forward (including on the next iteration through the loop).</p><p>The <span style="font-family:monospace">assert</span> expression must be an expression that would affect flow-sensitive
type refinement (Section&#XA0;<a href="#type-refinement">26.7</a>), if the
expression appeared in a conditional test. Each type system has its own
rules about what type refinement it performs.</p><p>The warning key is exactly as in the <span style="font-family:monospace">@SuppressWarnings</span> annotation
(Section&#XA0;<a href="#suppresswarnings-annotation">27.1</a>). The same good practices apply
as for <span style="font-family:monospace">@SuppressWarnings</span> annotations, such as writing a comment
justifying why the assumption is safe
(Section&#XA0;<a href="#suppresswarnings-best-practices">27.1.3</a>).
Sometimes, writing an assertion and <span style="font-family:monospace">@AssumeAssertion</span> is a less
disruptive code change than refactoring to create a location where
<span style="font-family:monospace">@SuppressWarnings</span> can be written.</p><p>The <span style="font-family:monospace">-AassumeAssertionsAreEnabled</span> and <span style="font-family:monospace">-AassumeAssertionsAreDisabled</span>
command-line options (Section&#XA0;<a href="#type-refinement-assertions">26.7.6</a>) do not
affect processing of <span style="font-family:monospace">assert</span> statements that have <span style="font-family:monospace">@AssumeAssertion</span> in
their message. Writing <span style="font-family:monospace">@AssumeAssertion</span> means that the assertion would
succeed if it were executed, and the Checker Framework makes use of that
information regardless of the <span style="font-family:monospace">-AassumeAssertionsAreEnabled</span> and
<span style="font-family:monospace">-AassumeAssertionsAreDisabled</span> command-line options.</p>
<!--TOC subsection id="defensive-programming" Suppressing warnings and defensive programming-->
<h3 id="defensive-programming" class="subsection">27.2.1&#XA0;&#XA0;Suppressing warnings and defensive programming <a href="#defensive-programming" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>This section explains the distinction between two different uses for
assertions (and for related methods like JUnit&#X2019;s <span style="font-family:monospace">Assert.assertNotNull</span>).</p><p>Assertions are commonly used for two distinct purposes: documenting how
the program works and debugging the program when it does not work
correctly. By default, the Checker Framework assumes that each assertion
is used for debugging: the assertion might fail at run time, and the programmer
wishes to be informed at compile time about such possible run-time errors. On
the other hand, if you write the <span style="font-family:monospace">@AssumeAssertion</span> string in the <span style="font-family:monospace">assert</span>
message, then the Checker Framework assumes that you have used some other
technique to verify that the assertion can never fail at run time, so the
checker assumes the assertion passes and does not issue a warning.</p><p>Distinguishing the purpose of each assertion is important for precise
type-checking.
Suppose that a
programmer encounters a failing test, adds an assertion to aid debugging, and fixes the
test. The programmer leaves the assertion in the program if the programmer
is worried that the program might fail in a similar way in the future.
The Checker Framework should not assume that the assertion succeeds &#X2014;
doing so would defeat the very purpose of the Checker Framework, which is
to detect errors at compile time and prevent them from occurring at run
time.</p><p>On the other hand, assertions sometimes document facts that a programmer
has independently verified to be true, and the Checker Framework can
leverage these assertions in order to avoid issuing false positive
warnings. The programmer marks such assertions with the <span style="font-family:monospace">@AssumeAssertion</span>
string in the <span style="font-family:monospace">assert</span> message. Only do so if you are sure
that the assertion always succeeds at run time.</p><p>Sometimes methods such as
<a href="../api/org/checkerframework/checker/nullness/NullnessUtil.html#castNonNull-T-"><span style="font-family:monospace">NullnessUtil.castNonNull</span></a> are used
instead of assertions. Just as for assertions, you can treat them as
debugging aids or as documentation.
If you know that a particular codebase uses
a nullness-checking method not for defensive programming but to indicate
facts that are guaranteed to be true (that is, these assertions will never
fail at run time), then you can suppress
warnings related to it.
Annotate its definition just as
<a href="../api/org/checkerframework/checker/nullness/NullnessUtil.html#castNonNull-T-"><span style="font-family:monospace">NullnessUtil.castNonNull</span></a> is annotated (see the
source code for the Checker Framework).
Also, be sure to document the intention in the method&#X2019;s Javadoc, so that
programmers do not
accidentally misuse it for defensive programming.</p><p>If you are annotating a codebase that already contains precondition checks,
such as:</p><pre class="verbatim">  public String get(String key, String def) {
    checkNotNull(key, "key"); // NOI18N
    ...
  }
</pre><p>then you should mark the appropriate parameter as <span style="font-family:monospace">@NonNull</span> (which is the
default). This will prevent the checker from issuing a warning about the
<span style="font-family:monospace">checkNotNull</span> call.</p>
<!--TOC section id="suppresswarnings-command-line" <span style="font-family:monospace">-AsuppressWarnings</span> command-line option-->
<h2 id="suppresswarnings-command-line" class="section">27.3&#XA0;&#XA0;<span style="font-family:monospace">-AsuppressWarnings</span> command-line option <a href="#suppresswarnings-command-line" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>Supplying the <span style="font-family:monospace">-AsuppressWarnings</span> command-line option is equivalent to
writing a <span style="font-family:monospace">@SuppressWarnings</span> annotation on every class that the compiler
type-checks. The argument to <span style="font-family:monospace">-AsuppressWarnings</span> is a comma-separated
list of warning suppression keys, as in
<span style="font-family:monospace">-AsuppressWarnings=purity,uninitialized</span>.</p><p>When possible, it is better to write a <span style="font-family:monospace">@SuppressWarnings</span> annotation with a
smaller scope, rather than using the <span style="font-family:monospace">-AsuppressWarnings</span> command-line option.</p>
<!--TOC section id="askipuses" <span style="font-family:monospace">-AskipUses</span> and <span style="font-family:monospace">-AonlyUses</span> command-line options-->
<h2 id="askipuses" class="section">27.4&#XA0;&#XA0;<span style="font-family:monospace">-AskipUses</span> and <span style="font-family:monospace">-AonlyUses</span> command-line options <a href="#askipuses" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>You can suppress all errors and warnings at all <em>uses</em> of a given
class, or suppress all errors and warnings except those at uses of a given
class. (The class itself is still type-checked, unless you also use
the <span style="font-family:monospace">-AskipDefs</span> or <span style="font-family:monospace">-AonlyDefs</span> command-line option, see&#XA0;<a href="#askipdefs">27.5</a>).</p><p>Set the <span style="font-family:monospace">-AskipUses</span> command-line option to a
regular expression that matches class names (not file names) for which warnings and errors
should be suppressed.
Or, set the <span style="font-family:monospace">-AonlyUses</span> command-line option to a
regular expression that matches class names (not file names) for which warnings and errors
should be emitted; warnings about uses of all other classes will be suppressed.</p><p>For example, suppose that you use
&#X201C;<code>-AskipUses=^java\.</code>&#X201D; on the command line
(with appropriate quoting) when invoking
<span style="font-family:monospace">javac</span>. Then the checkers will suppress all warnings related to
classes whose fully-qualified name starts with <code>java.</code>, such
as all warnings relating to invalid arguments and all warnings relating to
incorrect use of the return value.</p><p>To suppress all errors and warnings related to multiple classes, you can use
the regular expression alternative operator &#X201C;<span style="font-family:monospace">|</span>&#X201D;, as in
&#X201C;<code>-AskipUses="java\.lang\.|java\.util\."</code>&#X201D; to suppress
all warnings related to uses of classes that belong to the <span style="font-family:monospace">java.lang</span> or
<span style="font-family:monospace">java.util</span> packages. (Depending on your shell or other tool, you
might need to change or remove the quoting.)</p><p>You can supply both <span style="font-family:monospace">-AskipUses</span> and <span style="font-family:monospace">-AonlyUses</span>, in which case
the <span style="font-family:monospace">-AskipUses</span> argument takes precedence, and <span style="font-family:monospace">-AonlyUses</span> does
further filtering but does not add anything that <span style="font-family:monospace">-AskipUses</span> removed.</p><p>Warning: Use the <span style="font-family:monospace">-AonlyUses</span> command-line option with care,
because it can have unexpected results. For example, if the
given regular expression does not match classes in the JDK, then the
Checker Framework will suppress every warning that involves a JDK class
such as <span style="font-family:monospace">Object</span> or <span style="font-family:monospace">String</span>. The meaning of <span style="font-family:monospace">-AonlyUses</span> may be
refined in the future. Oftentimes <span style="font-family:monospace">-AskipUses</span> is more useful.</p>
<!--TOC section id="askipdefs" <span style="font-family:monospace">-AskipDefs</span> and <span style="font-family:monospace">-AonlyDefs</span> command-line options-->
<h2 id="askipdefs" class="section">27.5&#XA0;&#XA0;<span style="font-family:monospace">-AskipDefs</span> and <span style="font-family:monospace">-AonlyDefs</span> command-line options <a href="#askipdefs" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>You can suppress all errors and warnings in the <em>definition</em> of a given
class, or suppress all errors and warnings except those in the definition
of a given class. (Uses of the class are still type-checked, unless you also use
the <span style="font-family:monospace">-AskipUses</span> or <span style="font-family:monospace">-AonlyUses</span> command-line option,
see&#XA0;<a href="#askipuses">27.4</a>.)</p><p>Set the <span style="font-family:monospace">-AskipDefs</span> command-line option to a
regular expression that matches class names (not file names) in whose definition warnings and errors
should be suppressed.
Or, set the <span style="font-family:monospace">-AonlyDefs</span> command-line option to a
regular expression that matches class names (not file names) whose
definitions should be type-checked.</p><p>For example, if you use
&#X201C;<code>-AskipDefs=^mypackage\.</code>&#X201D; on the command line
(with appropriate quoting) when invoking
<span style="font-family:monospace">javac</span>, then the definitions of
classes whose fully-qualified name starts with <code>mypackage.</code>
will not be checked.</p><p>If you supply both <span style="font-family:monospace">-AskipDefs</span> and <span style="font-family:monospace">-AonlyDefs</span>, then
<span style="font-family:monospace">-AskipDefs</span> takes precedence.</p><p>Another way not to type-check a file is not to pass it on the compiler
command-line: the Checker Framework type-checks only files that are passed
to the compiler on the command line, and does not type-check any file that
is not passed to the compiler. The <span style="font-family:monospace">-AskipDefs</span> and <span style="font-family:monospace">-AonlyDefs</span>
command-line options
are intended for situations in which the build system is hard to understand
or change. In such a situation, a programmer may find it easier to supply
an extra command-line argument, than to change the set of files that is
compiled.</p><p>A common scenario for using the arguments is when you are starting out by
type-checking only part of a legacy codebase. After you have verified the
most important parts, you can incrementally check more classes until you
are type-checking the whole thing.</p>
<!--TOC section id="lint-options" <span style="font-family:monospace">-Alint</span> command-line option-->
<h2 id="lint-options" class="section">27.6&#XA0;&#XA0;<span style="font-family:monospace">-Alint</span> command-line option<a id="alint"></a> <a href="#alint" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The <span style="font-family:monospace">-Alint</span> option enables or disables optional checks, analogously to
javac&#X2019;s <span style="font-family:monospace">-Xlint</span> option.
Each of the distributed checkers supports at least the following lint options:</p><ul class="itemize"><li class="li-itemize"><span style="font-family:monospace">cast:unsafe</span> (default: on) warn about unsafe casts that are not
checked at run time, as in <span style="font-family:monospace">((@NonNull String) myref)</span>. Such casts
are generally not necessary because of type refinement
(Section&#XA0;<a href="#type-refinement">26.7</a>).</li><li class="li-itemize"><span style="font-family:monospace">cast:redundant</span> (default: on) warn about redundant
casts that are guaranteed to succeed at run time,
as in <span style="font-family:monospace">((@NonNull String) "m")</span>. Such casts are not necessary,
because the target expression of the cast already has the given type
qualifier.</li><li class="li-itemize"><span style="font-family:monospace">cast</span> Enable or disable all cast-related warnings.</li><li class="li-itemize">
<span style="font-family:monospace">all</span> Enable or disable all lint warnings, including
checker-specific ones if any. Examples include <span style="font-family:monospace">redundantNullComparison</span> for the
Nullness Checker (see Section&#XA0;<a href="#nullness-lint-nulltest">2</a>) and <span style="font-family:monospace">dotequals</span> for
the Interning Checker (see Section&#XA0;<a href="#lint-dotequals">6.4</a>). This option
does not enable/disable the checker&#X2019;s standard checks, just its optional
ones.
</li><li class="li-itemize"><span style="font-family:monospace">none</span> The inverse of <span style="font-family:monospace">all</span>: disable or enable all lint warnings,
including checker-specific ones if any.</li></ul><p>To activate a lint option, write <span style="font-family:monospace">-Alint=</span> followed by a
comma-delimited list of check names. If the option is preceded by a
hyphen (<span style="font-family:monospace">-</span>), the warning is disabled. For example, to disable all
lint options except redundant casts, you can pass
<span style="font-family:monospace">-Alint=-all,cast:redundant</span> on the command line.</p><p>Only the last <span style="font-family:monospace">-Alint</span> option is used; all previous <span style="font-family:monospace">-Alint</span>
options are silently ignored. In particular, this means that <span style="font-family:monospace">-Alint=all
-Alint=cast:redundant</span> is <em>not</em> equivalent to
<span style="font-family:monospace">-Alint=-all,cast:redundant</span>.</p>
<!--TOC section id="no-processor" Don&#X2019;t run the processor-->
<h2 id="no-processor" class="section">27.7&#XA0;&#XA0;Don&#X2019;t run the processor <a href="#no-processor" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>You can compile parts of your code without use of the
<span style="font-family:monospace">-processor</span> switch to <span style="font-family:monospace">javac</span>. No checking is done during
such compilations, so no warnings are issued related to pluggable
type-checking.</p><p>You can direct your build system to avoid compiling certain parts of your
code. For example, the <span style="font-family:monospace">-Dmaven.test.skip=true</span> command-line argument
tells Maven not to compile (or run) the tests.</p>
<!--TOC section id="checker-specific-suppression" Checker-specific mechanisms-->
<h2 id="checker-specific-suppression" class="section">27.8&#XA0;&#XA0;Checker-specific mechanisms <a href="#checker-specific-suppression" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>Finally, some checkers have special rules. For example, the Nullness
checker (Chapter&#XA0;<a href="#nullness-checker">3</a>) uses
the special <span style="font-family:monospace">castNonNull</span> method to suppress warnings
(Section&#XA0;<a href="#suppressing-warnings-with-assertions">3.4.1</a>).
This manual also explains special mechanisms for
suppressing warnings issued by the Fenum Checker
(Section&#XA0;<a href="#fenum-suppressing">9.4</a>) and the Units Checker
(Section&#XA0;<a href="#units-suppressing">17.5</a>).</p><hr>
<!--TOC chapter id="legacy-code" Handling legacy code-->
<h1 id="legacy-code" class="chapter">Chapter&#XA0;28&#XA0;&#XA0;Handling legacy code <a href="#legacy-code" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h1><!--SEC END --><p>Section&#XA0;<a href="#get-started-with-legacy-code">2.4.2</a> describes a methodology for
applying annotations to legacy code. This chapter tells you what to do if,
for some reason, you cannot change your code in such a way as to eliminate
a checker warning.</p><p>Also recall that you can convert checker errors into warnings via the
<span style="font-family:monospace">-Awarns</span> command-line option; see Section&#XA0;<a href="#checker-options">2.2.3</a>.</p>
<!--TOC section id="unannotated-code" Checking partially-annotated programs: handling unannotated code-->
<h2 id="unannotated-code" class="section">28.1&#XA0;&#XA0;Checking partially-annotated programs: handling unannotated code <a href="#unannotated-code" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>Sometimes, you wish to type-check only part of your program.
You might focus on the most mission-critical or error-prone part of your
code. When you start to use a checker, you may not wish to annotate
your entire program right away.
You may not have
enough knowledge to annotate poorly-documented libraries that your program uses.</p><p>If annotated code uses unannotated code, then the checker may issue
warnings. For example, the Nullness Checker (Chapter&#XA0;<a href="#nullness-checker">3</a>) will
warn whenever an unannotated method result is used in a non-null context:</p><pre class="verbatim">  @NonNull myvar = unannotated_method();   // WARNING: unannotated_method may return null
</pre><p>If the call <em>can</em> return null, you should fix the bug in your program by
removing the <a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a> annotation in your own program.</p><p>If the library call <em>never</em> returns null,
there are several ways to eliminate the compiler warnings.
</p><ol class="enumerate" type=1><li class="li-enumerate">
Annotate <span style="font-family:monospace">unannotated_method</span> in full. This approach provides
the strongest guarantees, but may require you to annotate additional
methods that <span style="font-family:monospace">unannotated_method</span> calls. See
Chapter&#XA0;<a href="#annotating-libraries">30</a> for a discussion of how to annotate
libraries for which you have no source code.
</li><li class="li-enumerate">Annotate only the signature of <span style="font-family:monospace">unannotated_method</span>, and
suppress warnings in its body. Two ways to suppress the warnings are via a
<span style="font-family:monospace">@SuppressWarnings</span> annotation or by not running the checker on that
file (see Chapter&#XA0;<a href="#suppressing-warnings">27</a>).
</li><li class="li-enumerate">Suppress all warnings related to uses of <span style="font-family:monospace">unannotated_method</span>
via the <span style="font-family:monospace">skipUses</span> processor option
(see Section&#XA0;<a href="#askipuses">27.4</a>).
Since this can suppress more warnings than you may expect,
it is usually better to annotate at least the method&#X2019;s signature. If you
choose the boundary between the annotated and unannotated code wisely,
then you only have to annotate the signatures of a limited number of
classes/methods
(e.g., the public interface to a library or package).</li></ol><p>Chapter&#XA0;<a href="#annotating-libraries">30</a> discusses adding annotations to
signatures when you do not have source code available.
Chapter&#XA0;<a href="#suppressing-warnings">27</a> discusses suppressing warnings.</p>
<!--TOC subsection id="declaration-annotations-moved" Declaration annotations-->
<h3 id="declaration-annotations-moved" class="subsection">28.1.1&#XA0;&#XA0;Declaration annotations <a href="#declaration-annotations-moved" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>When a declaration annotation is an alias for a type annotation, then the
Checker Framework may move the annotation before replacing it by the
canonical version. (If the declaration annotation is in an <span style="font-family:monospace">org.checkerframework</span>
package, it is not moved.)</p><p>For example,</p><pre class="verbatim">  import android.support.annotation.NonNull;
  ...
  @NonNull Object [] returnsArray();
</pre><p>is treated as if the programmer had written</p><pre class="verbatim">  import org.checkerframework.checker.nullness.qual.NonNull;
  ...
  Object @NonNull [] returnsArray();
</pre><p>because Android&#X2019;s <span style="font-family:monospace">@NonNull</span> annotation is a declaration annotation, which
is understood to apply to the top-level return type of the annotated method.</p><p>When possible, you should use type annotations rather than declaration
annotations.</p><p>Users who are using old Java 5&#X2013;7 declaration annotations (for instance,
from the no-longer-supported FindBugs tool) can use annotations in
package <span style="font-family:monospace">org.checkerframework.checker.nullness.compatqual</span> to avoid name
conflicts. These are available in package
<a href="https://search.maven.org/search?q=a:checker-compat-qual"><span style="font-family:monospace">checker-compat-qual</span></a>
on Maven Central. Once the users are ready to upgrade to Java 8+ type
annotations, those compatibility annotations are no longer necessary.</p><hr>
<!--TOC chapter id="type-inference" Type inference-->
<h1 id="type-inference" class="chapter">Chapter&#XA0;29&#XA0;&#XA0;Type inference <a href="#type-inference" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h1><!--SEC END --><p>There are two different tasks that are commonly called &#X201C;type inference&#X201D;:
</p><ol class="enumerate" type=1><li class="li-enumerate">
Type inference during type-checking:
The type-checker fills in an appropriate type where the programmer didn&#X2019;t
write one, but does not change the source code.
See Section&#XA0;<a href="#type-inference-refinement">29.1</a>.
</li><li class="li-enumerate">Type inference to annotate a program:
As a separate step before type-checking, a type inference tool
inserts type qualifiers into the source code.
See Section&#XA0;<a href="#type-inference-to-annotate">29.2</a>.
</li></ol><p>Each variety has its own advantages, discussed below.
Advantages of <em>all</em> varieties of type inference include:
</p><ul class="itemize"><li class="li-itemize">
Less work for the programmer.
</li><li class="li-itemize">The tool chooses the most general type, whereas a programmer might
accidentally write a more-specific, less-generally-useful annotation.
</li></ul>
<!--TOC section id="type-inference-refinement" Local type inference during type-checking-->
<h2 id="type-inference-refinement" class="section">29.1&#XA0;&#XA0;Local type inference during type-checking <a href="#type-inference-refinement" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>During type-checking, if certain variables have no programmer-written type qualifier, the
type-checker determines whether there is some type qualifier that would
permit the program to type-check. If so, the type-checker uses that type
qualifier, but does not change the source code. Each time the
type-checker runs, it re-infers the type qualifier for that variable. If
no type qualifier exists that permits the program to type-check, the
type-checker issues a warning.</p><p>Local type inference is built into the Checker Framework.
Every checker automatically uses it. As a result, a programmer typically
does not have to write any qualifiers inside the body of a method
(except occasionally on type arguments).
However, it primarily
works within a method, not across method boundaries.
The source code must already contain annotations for method
signatures (arguments and return values) and fields.</p><p>Advantages of this variety of type inference include:
</p><ul class="itemize"><li class="li-itemize">
If the type qualifier is obvious to the programmer, then omitting it
can reduce annotation clutter in the program.
</li><li class="li-itemize">If the code changes, then there is no old annotation that
might need to be updated.
</li><li class="li-itemize">Within-method type inference occurs automatically.
The programmer doesn&#X2019;t have to do anything to take advantage of it.
</li></ul><p>For more details about local type inference during type-checking, also
known as &#X201C;flow-sensitive type refinement&#X201D;, see
Section&#XA0;<a href="#type-refinement">26.7</a>.</p>
<!--TOC section id="type-inference-to-annotate" Type inference to annotate a program-->
<h2 id="type-inference-to-annotate" class="section">29.2&#XA0;&#XA0;Type inference to annotate a program <a href="#type-inference-to-annotate" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>As a separate step before type-checking, a type inference tool takes the
program as input, and outputs a set of type qualifiers that would
make the program type-check. (If no such set exists, for example because
the program is not type-correct, then the inference tool does its best but
makes no guarantees.)
These qualifiers are inserted into the source code or the
class file. They can be viewed and adjusted by the programmer, and can
be used by tools such as the type-checker.</p><p>Advantages of this variety of type inference include:
</p><ul class="itemize"><li class="li-itemize">
The inference may be more precise by taking account of the entire program
rather than just reasoning one method at a time.
</li><li class="li-itemize">The program source code contains documentation in the form of type
qualifiers, which can aid programmer understanding and may make
type-checking warnings more comprehensible.
</li></ul>
<!--TOC subsection id="type-inference-tools" Type inference tools-->
<h3 id="type-inference-tools" class="subsection">29.2.1&#XA0;&#XA0;Type inference tools <a href="#type-inference-tools" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>This section lists tools that take a program and output a set of
annotations for it.
It first lists tools that work only for a single type system (but may do a
more accurate job for that type system)
then lists general tools that work for any type system.</p>
<!--TOC subsubsection id="type-inference-tools-specialized" Type inference for specific type systems-->
<h4 id="type-inference-tools-specialized" class="subsubsection">Type inference for specific type systems <a href="#type-inference-tools-specialized" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h4><!--SEC END --><p>Section&#XA0;<a href="#nullness-inference">3.3.7</a> lists several tools that infer
annotations for the Nullness Checker.</p><p>If you run the Checker Framework with the <span style="font-family:monospace">-AsuggestPureMethods</span>
command-line option, it will suggest methods that can be marked as
<span style="font-family:monospace">@SideEffectFree</span>, <span style="font-family:monospace">@Deterministic</span>, or <span style="font-family:monospace">@Pure</span>; see
Section&#XA0;<a href="#type-refinement-purity">26.7.5</a>.</p>
<!--TOC subsubsection id="type-inference-tools-general" Type inference for any type system-->
<h4 id="type-inference-tools-general" class="subsubsection">Type inference for any type system <a href="#type-inference-tools-general" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h4><!--SEC END --><p>By supplying the <span style="font-family:monospace">-Ainfer</span> command-line option,
any type-checker can infer annotations. See Section&#XA0;<a href="#whole-program-inference">29.3</a>.</p><p><a href="https://github.com/reprogrammer/cascade/">Cascade</a>&#XA0;[<a href="#VakilianPEJ2014">VPEJ14</a>]
is an Eclipse plugin that implements interactive type qualifier inference.
Cascade is interactive rather than fully-automated: it makes it easier for
a developer to insert annotations.
Cascade starts with an unannotated program and runs a type-checker. For each
warning it suggests multiple fixes, the developer chooses a fix, and
Cascade applies it. Cascade works with any checker built on the Checker
Framework.
You can find installation instructions and a video tutorial at <a href="https://github.com/reprogrammer/cascade"><span style="font-family:monospace">https://github.com/reprogrammer/cascade</span></a>.</p>
<!--TOC section id="whole-program-inference" Whole-program inference-->
<h2 id="whole-program-inference" class="section">29.3&#XA0;&#XA0;Whole-program inference <a href="#whole-program-inference" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>Whole-program inference is an interprocedural inference that
infers types for fields, method parameters, and method return types that do not
have a user-written qualifier (for the given type system).
The inferred type qualifiers are inserted into
your program.
The inferred type is the most specific type that is compatible with all the
uses in the program. For example, the inferred type for a field is the
least upper bound of the types of all the expressions that are assigned
into the field.</p><p>
To use whole-program inference, make sure that
<span style="font-family:monospace">insert-annotations-to-source</span>, from the Annotation File Utilities project,
is on your path (for example, its directory is in the <span style="font-family:monospace">$PATH</span> environment variable).
Then, run the script <span style="font-family:monospace">checker-framework/checker/bin/infer-and-annotate.sh</span>.
Its command-line arguments are:
</p><ol class="enumerate" type=1><li class="li-enumerate">
Optional: Command-line arguments to
<a href="https://checkerframework.org/annotation-file-utilities/#insert-annotations-to-source"><span style="font-family:monospace">insert-annotations-to-source</span></a>.
</li><li class="li-enumerate">Processor&#X2019;s name.
</li><li class="li-enumerate">Target program&#X2019;s classpath. This argument is required; pass "" if it
is empty.
</li><li class="li-enumerate">Optional: Extra processor arguments which will be passed to the checker, if any.
You may supply any number of such arguments, or none. Each such argument
must start with a hyphen.
</li><li class="li-enumerate">Optional: Paths to <span style="font-family:monospace">.jaif</span> files used as input in the inference
process.
</li><li class="li-enumerate">Paths to <span style="font-family:monospace">.java</span> files in the program.
</li></ol><p>For example, to add annotations to the <span style="font-family:monospace">plume-lib</span> project:
</p><pre class="verbatim">git clone https://github.com/mernst/plume-lib.git
cd plume-lib
make jar
$CHECKERFRAMEWORK/checker/bin/infer-and-annotate.sh \
    "LockChecker,NullnessChecker" java/plume.jar:java/lib/junit-4.12.jar:$JAVA_HOME/lib/tools.jar \
    `find java/src/plume/ -name "*.java"`
# View the results
git diff
</pre><p>You may need to wait a few minutes for the command to complete.
You can ignore warnings that the command outputs while trying different
annotations in your code.</p><p>It is recommended that you run <span style="font-family:monospace">infer-and-annotate.sh</span> on a copy of your
code, so that you can see what changes it made and so that it does not
change your only copy. One way to do this is to work in a clone of your
repository that has no uncommitted changes.</p><p>Whole-program inference differs from type refinement (Section&#XA0;<a href="#type-refinement">26.7</a>)
in three ways. First, type refinement only works within a method body.
Second, type refinement always
refines the current type, regardless of whether the value already has an
annotation in the source code.
Third, whole-program inference can infer a subtype
or a supertype of the default type, by contrast with type refinement which
always refines the current type to a subtype.</p>
<!--TOC subsection id="whole-program-inference-ignores-some-code" Whole-program inference ignores some code-->
<h3 id="whole-program-inference-ignores-some-code" class="subsection">29.3.1&#XA0;&#XA0;Whole-program inference ignores some code <a href="#whole-program-inference-ignores-some-code" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Whole-program inference ignores code within the scope of a
<span style="font-family:monospace">@SuppressWarnings</span> annotation with an appropriate key
(Section&#XA0;<a href="#suppresswarnings-annotation">27.1</a>). In particular, uses within
the scope do not contribute to the inferred type, and declarations within
the scope are not changed. You should remove <span style="font-family:monospace">@SuppressWarnings</span> annotations
from the class declaration of any class you wish to infer types for.</p><p>As noted below, whole-program inference requires invocations of your code, or
assignments to your methods, to generalize from. If a field is set via
reflection (such as via injection), then whole-program inference would produce
an inaccurate result. There are two ways to make whole-program inference
ignore such a field.
(1)
You probably have an annotation such as
<a href="https://docs.oracle.com/javaee/7/api/javax/inject/Inject.html"><span style="font-family:monospace">@Inject</span></a>
or
<a href="https://types.cs.washington.edu/plume-lib/api/plume/Option.html"><span style="font-family:monospace">@Option</span></a>
that indicates such fields. Meta-annotate the declaration of the <span style="font-family:monospace">Inject</span>
or <span style="font-family:monospace">Option</span> annotation with
<a href="../api/org/checkerframework/framework/qual/IgnoreInWholeProgramInference.html"><span style="font-family:monospace">@IgnoreInWholeProgramInference</span></a>.
(2)
Annotate the field to be ignored with
<a href="../api/org/checkerframework/framework/qual/IgnoreInWholeProgramInference.html"><span style="font-family:monospace">@IgnoreInWholeProgramInference</span></a>.</p><p>Whole-program inference, for a type-checker other than the Nullness Checker,
ignores (pseudo-)assignments where the right-hand-side is the <span style="font-family:monospace">null</span> literal.</p>
<!--TOC subsection id="whole-program-inference-manual-checking" Manually checking whole-program inference results-->
<h3 id="whole-program-inference-manual-checking" class="subsection">29.3.2&#XA0;&#XA0;Manually checking whole-program inference results <a href="#whole-program-inference-manual-checking" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>As with any type inference tool, it is a good idea to manually examine the
results.</p><ul class="itemize"><li class="li-itemize">
Whole-program inference can produce undesired results when your code has
non-representative or erroneous calls to a particular method or assignments to a
particular field, as explained below.
This is especially noticeable when the arguments or assignments are literals.</li><li class="li-itemize">If an annotation is inferred for a <em>use</em> of type variables;
it might be more appropriate for you to move those annotations
to the corresponding upper bounds of the type variable <em>declaration</em>.</li></ul>
<!--TOC subsubsection id="whole-program-inference-non-representative-uses" Poor whole-program inference results due to non-representative uses-->
<h4 id="whole-program-inference-non-representative-uses" class="subsubsection">Poor whole-program inference results due to non-representative uses <a href="#whole-program-inference-non-representative-uses" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h4><!--SEC END --><p>Whole-program inference determines a method parameter&#X2019;s type
annotation based on what arguments are passed to the method, but not on how the
parameter is used within the method body.</p><ul class="itemize"><li class="li-itemize">
If the program contains erroneous calls, the
inferred annotations may reflect those errors.<p>Suppose you intend method <span style="font-family:monospace">m2</span> to be called with
non-null arguments, but your program contains an error and one of the calls
to <span style="font-family:monospace">m2</span> passes <span style="font-family:monospace">null</span> as the argument. Then the tool will infer that
<span style="font-family:monospace">m2</span>&#X2019;s parameter has <span style="font-family:monospace">@Nullable</span> type.
You should correct the bug and re-run inference.</p></li><li class="li-itemize">If the program uses (say) a method in a limited way, then the inferred
annotations will be legal for the program as
currently written but may not be as general as possible and may not
accommodate future program changes.<p>Here are some examples:</p><ul class="itemize"><li class="li-itemize">
Suppose that your program currently calls
method <span style="font-family:monospace">m1</span> only with non-null
arguments. The tool will infer that <span style="font-family:monospace">m1</span>&#X2019;s parameter has
<span style="font-family:monospace">@NonNull</span> type. If you had intended the method to be able to
take <span style="font-family:monospace">null</span> as an argument and you later add such a call, the type-checker
will issue a warning because the automatically-inserted <span style="font-family:monospace">@NonNull</span>
annotation is inconsistent with the new call.</li><li class="li-itemize">If your program (or test suite) passes only <span style="font-family:monospace">null</span> as an argument, the
inferred type will be the bottom type, such as <span style="font-family:monospace">@GuardedByBottom</span>.</li><li class="li-itemize">It is common for whole-program inference to infer
<span style="font-family:monospace">@Interned</span> and <span style="font-family:monospace">@Regex</span> annotations on String variables for which the
analyzed code only uses a constant string.</li></ul><p>In each case, you can correct the inferred results manually, or you can
add tests that pass additional values then re-run inference.</p></li></ul>
<!--TOC subsection id="how-whole-program-inference-works" How whole-program inference works-->
<h3 id="how-whole-program-inference-works" class="subsection">29.3.3&#XA0;&#XA0;How whole-program inference works <a href="#how-whole-program-inference-works" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>This section explains how the <span style="font-family:monospace">infer-and-annotate.sh</span> script works. If you
merely want to run the script and you are not encountering trouble, you can
skip this section.</p><p>The <span style="font-family:monospace">infer-and-annotate.sh</span> script repeatedly runs the following steps:
</p><ol class="enumerate" type=1><li class="li-enumerate">
Run the checker with the <span style="font-family:monospace">-Ainfer</span> command-line option to infer
types for fields and method signatures. The output of this step
is a <span style="font-family:monospace">.jaif</span> file that records the inferred types.
</li><li class="li-enumerate">Insert the inferred annotations in the program. This step uses the
Annotation File Utilities
(<a href="https://checkerframework.org/annotation-file-utilities/"><span style="font-family:monospace">https://checkerframework.org/annotation-file-utilities/</span></a>).
</li></ol><p>The process halts when there are no more changes to the inference results,
that is, the <span style="font-family:monospace">.jaif</span> file is unchanged between two runs. On each
iteration through the process, there may be new annotations in the <span style="font-family:monospace">.jaif</span>
file, and some type-checking errors may be eliminated (though others might
be introduced).</p><p>When the type-checker is run on the program with the final annotations
inserted, there might still be errors. This may be because the tool did
not infer enough annotations, or because your program contains a defect.
However, each of the inferred annotations is sound, and this reduces your
manual effort in annotating the program.</p><p>The iterative process is required because type-checking is modular: it
processes each class and each method only once, independently. Modularity
enables you to run type-checking on only part of your program, and it makes
type-checking fast. However, it has some disadvantages:
</p><ul class="itemize"><li class="li-itemize">
The first run of the type-checker cannot take advantage of whole-program
inference results because whole-program inference is only complete at the
end of type-checking, and modular type-checking does not revisit any
already-processed classes.
</li><li class="li-itemize">Revisiting an
already-processed class may result in a better estimate.
</li></ul><hr>
<!--TOC chapter id="annotating-libraries" Annotating libraries-->
<h1 id="annotating-libraries" class="chapter">Chapter&#XA0;30&#XA0;&#XA0;Annotating libraries <a href="#annotating-libraries" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h1><!--SEC END --><p>When your code uses a library that is not currently being compiled,
the Checker Framework looks up the library&#X2019;s annotations in its class files.
Section&#XA0;<a href="#annotated-libraries-using">2.2.1</a> tells you how to find and use a
version of a library that contains type annotations.</p><p>If your code uses a library that does <em>not</em> contain type annotations,
then the type-checker has no way to know the library&#X2019;s behavior.
The type-checker
makes conservative assumptions about unannotated bytecode.
(See
Section&#XA0;<a href="#defaults-classfile">26.5.6</a> for details, an example, and how to
override this conservative behavior.)
These conservative library
annotations invariably lead to checker warnings.</p><p>This chapter describes how to eliminate
the warnings by adding annotations to the library.
(Alternately, you can instead
suppress all warnings related to an unannotated library, or to part of your
codebase, by use of the
<span style="font-family:monospace">-AskipUses</span> or <span style="font-family:monospace">-AonlyUses</span> command-line option; see
Sections&#XA0;<a href="#askipuses">27.4</a>&#X2013;<a href="#askipdefs">27.5</a>.)</p><p>You can write annotations for a library, and make them known to a checker, in two ways.</p><ol class="enumerate" type=1><li class="li-enumerate">
Write annotations in a copy of the library&#X2019;s source code (for instance,
in a fork of the library&#X2019;s GitHub project). In addition to writing
annotations, adjust the build system to run pluggable-type-checking when
compiling (see Chapter&#XA0;<a href="#external-tools">32</a>).<p>Then, when doing pluggable type-checking,
put the annotated library&#X2019;s <span style="font-family:monospace">.jar</span> file on the classpath, as explained in
Section&#XA0;<a href="#annotated-libraries-using">2.2.1</a>.
</p><p>With this compilation approach, the syntax of the library annotations is
validated ahead of time. Thus, this compilation approach is less
error-prone, and the type-checker runs faster. You get
correctness guarantees about the library in addition to your code.</p><p>For instructions, see Section&#XA0;<a href="#annotating-libraries-create">30.2</a>.</p></li><li class="li-enumerate">Write annotations in a &#X201C;stub file&#X201D;, if you do not have access to the
source code.
<p>Then, when doing pluggable type-checking,
supply the &#X201C;stub file&#X201D; textually to the Checker Framework.</p><p>This approach does not require you to compile the library source
code.
A stub file is applicable to multiple versions of a library, so
the stub file does not need to be updated when a new version of the
library is released, unless the API has changed (such as defining a new
method).</p><p>For instructions, see Section&#XA0;<a href="#stub">30.5</a>.</p></li></ol><p>If you annotate a new library (either in its source code or in a stub
file), please inform the Checker Framework
developers so that your annotated library can be distributed with the
Checker Framework.
Sharing your annotations is useful even if the library is only partially
annotated.
However, as noted in Sections&#XA0;<a href="#get-started-with-legacy-code">2.4.2</a> and&#XA0;<a href="#library-tips-fully-annotate">30.1.4</a>, you
should annotate an entire class at a time.
You may find type inference tools (Chapter&#XA0;<a href="#type-inference-to-annotate">29.2</a>) helpful
when getting started, but you should always examine their results.
</p>
<!--TOC section id="library-tips" Tips for annotating a library-->
<h2 id="library-tips" class="section">30.1&#XA0;&#XA0;Tips for annotating a library <a href="#library-tips" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>Section&#XA0;<a href="#tips-about-writing-annotations">2.4</a> gives general tips for writing
annotations. This section gives tips that are specific to annotating a
third-party library.</p>
<!--TOC subsection id="library-tips-dont-change-the-code" Don&#X2019;t change the code-->
<h3 id="library-tips-dont-change-the-code" class="subsection">30.1.1&#XA0;&#XA0;Don&#X2019;t change the code <a href="#library-tips-dont-change-the-code" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>If you annotate a library that you maintain, you can refactor it to improve
its design.</p><p>When you annotate a library that you do not maintain, you should only add
annotations and, when necessary, documentation of those annotations. You
can place the documentation in a Java comment (<span style="font-family:monospace">//</span> or <span style="font-family:monospace">/*...*/</span>) or in a
<a href="../api/org/checkerframework/framework/qual/CFComment.html"><span style="font-family:monospace">@CFComment</span></a> annotation.</p><p>Do not change the library&#X2019;s code, which will change its behavior and make
the annotated version inconsistent with the unannotated version.
(Sometimes it is acceptable to make a refactoring, such as extracting an
expression into a new local variable in order to annotate its type or
suppress a warning. Perform refactoring only when you cannot use
<span style="font-family:monospace">@AssumeAssertion</span>.)
</p><p>Do not change publicly-visible documentation, such as Javadoc comments.
That also makes the annotated version inconsistent with the unannotated
version.</p><p>Do not change formatting and whitespace.</p><p>All of these changes increase the difference between upstream (the original
version) and your annotated version. This makes it harder for others to
understand what you have done, and they make it harder to pull changes from
upstream into the annotated library.</p>
<!--TOC subsection id="library-tips-specification" Library annotations should reflect the specification, not the implementation-->
<h3 id="library-tips-specification" class="subsection">30.1.2&#XA0;&#XA0;Library annotations should reflect the specification, not the implementation <a href="#library-tips-specification" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Publicly-visible annotations (including those on public method formal
parameters and return types) should be based on the
documentation, typically the method&#X2019;s Javadoc.
In other words, your annotations should re-state facts that are in the Javadoc
documentation.</p><p>Do not add requirements or guarantees beyond what the library author has
already committed to. If a project&#X2019;s Javadoc says nothing about nullness,
then you should not assume that the specification forbids null, nor that it
permits it.
(If the project&#X2019;s Javadoc explicitly mentions null everywhere it is permitted,
then you can assume it is forbidden elsewhere, where the author omitted those
statements.)</p><p>If a fact is not mentioned in the documentation, then it is usually an
implementation detail. Clients should not depend on implementation
details, which are prone to change without notice.
(In some cases, you can infer some facts from the
implementation, such as that null is permitted for a method&#X2019;s parameter or
return type if the implementation explicitly passes null to the method or
the method implementation returns null.)</p><p>If there is a fact that you think should be in the library&#X2019;s documentation
but was unintentionally omitted by its authors, then please submit a bug
report asking them to update the documentation to reflect this fact. After
they do, you can also express the fact as an annotation.</p>
<!--TOC subsection id="library-tips-report-bugs" Report bugs upstream-->
<h3 id="library-tips-report-bugs" class="subsection">30.1.3&#XA0;&#XA0;Report bugs upstream <a href="#library-tips-report-bugs" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>While annotating the library, you may discover bugs or missing/wrong
documentation. If you have a documentation improvement or a bug fix, then
open a pull request against the upstream version of the library. This will
benefit all users of the library. And, once the documentation is updated,
you will be able to add annotations that are consistent with the
documentation.</p>
<!--TOC subsection id="library-tips-fully-annotate" Fully annotate the library, or indicate which parts you did not-->
<h3 id="library-tips-fully-annotate" class="subsection">30.1.4&#XA0;&#XA0;Fully annotate the library, or indicate which parts you did not <a href="#library-tips-fully-annotate" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>If you do not annotate all the files in the library, then use
<a href="../api/org/checkerframework/framework/qual/AnnotatedFor.html"><span style="font-family:monospace">@AnnotatedFor</span></a> to indicate what files you have
annotated.</p><p>Whenever you annotate any part of a file, fully annotate the file! That
is, write annotations for all the methods and fields, based on their
documentation. If you don&#X2019;t annotate the whole file, then other people
won&#X2019;t know whether a particular method is unannotated because you didn&#X2019;t
get to it yet or because you decided that it didn&#X2019;t need any annotations.</p>
<!--TOC subsection id="library-tips-verify" Verify your annotations-->
<h3 id="library-tips-verify" class="subsection">30.1.5&#XA0;&#XA0;Verify your annotations <a href="#library-tips-verify" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Ideally, after you annotate a file, you should type-check the file to verify
the correctness and completeness of your annotations.</p><p>An alternative is to
only annotate method signatures. The alternative is quicker but more
error-prone, and there is no difference from the point of view of clients,
who can only see annotations on public methods and fields. When you
compile the library, the type-checker will probably issue warnings, but if
you supply <span style="font-family:monospace">-Awarns</span>, you don&#X2019;t have to suppress those warnings and the
compiler will still produce <span style="font-family:monospace">.class</span> files.</p>
<!--TOC section id="annotating-libraries-create" Creating an annotated library-->
<h2 id="annotating-libraries-create" class="section">30.2&#XA0;&#XA0;Creating an annotated library <a href="#annotating-libraries-create" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>This section describes how to create an annotated library.</p><ol class="enumerate" type=1><li class="li-enumerate">
See the
<a href="https://search.maven.org/search?q=org.checkerframework.annotatedlib">the
<span style="font-family:monospace">org.checkerframework.annotatedlib</span> group in the Central Repository</a>
to find out whether an annotated version of the library already exists.
<ul class="itemize"><li class="li-itemize">
If it exists, but you want to add annotations for a different checker:<p>Clone its repository from <a href="https://github.com/typetools/"><span style="font-family:monospace">https://github.com/typetools/</span></a>, tweak
its buildfile to run an additional checker.</p></li><li class="li-itemize">If it does not already exist:<p>Fork the project. (First, verify that its license permits forking.)</p><p>Add a line in its main README to indicate that this is an annotated
version of the library. That line should also indicate how to obtain
the corresponding upstream version (typically a git tag
<a href="https://rawgit.com/typetools/checker-framework/master/docs/developer/developer-manual.html#annotated-library-version-numbers">corresponding
to a release</a>), so that others can see exactly what edits you have
made.</p><p>Adjust the library&#X2019;s
build process, such as an Ant, Gradle, or Maven buildfile.
Every time the build system runs the compiler, it should:
</p><ul class="itemize"><li class="li-itemize">
pass the <span style="font-family:monospace">-AuseDefaultsForUncheckedCode=source,bytecode</span>
command-line option and
</li><li class="li-itemize">run every pluggable type-checker for which any
annotations exist, using <span style="font-family:monospace">-processor
</span><span style="font-family:monospace"><em>TypeSystem1</em></span><span style="font-family:monospace">,</span><span style="font-family:monospace"><em>TypeSystem2</em></span><span style="font-family:monospace">,</span><span style="font-family:monospace"><em>TypeSystem3</em></span>
</li></ul><p>You are not adding new build targets, but modifying existing targets.
The reason to run every type-checker is to verify
the annotations you wrote, and to use appropriate defaults for all
unannotated type uses.
</p></li></ul></li><li class="li-enumerate">Annotate some files.
<p>When you annotate a file, annotate the whole thing, not just a few of its
methods. Once the file is fully annotated, add an
<a href="../api/org/checkerframework/framework/qual/AnnotatedFor.html"><span style="font-family:monospace">@AnnotatedFor</span></a><span style="font-family:monospace">(</span><span style="font-family:monospace">{</span><span style="font-family:monospace">"</span><span style="font-family:monospace"><em>checkername</em></span><span style="font-family:monospace">"</span><span style="font-family:monospace">}</span><span style="font-family:monospace">)</span>
annotation to its class(es), or augment an existing <span style="font-family:monospace">@AnnotatedFor</span>
annotation.</p></li><li class="li-enumerate">Build the library.<p>Because of the changes that you made in step 1, this will run pluggable
type-checkers. If there are any compiler warnings, fix them and re-compile.</p><p>Now you have a <span style="font-family:monospace">.jar</span> file that you can use while type-checking and at
run time.</p></li><li class="li-enumerate">Tell other people about your work so that they can benefit from it.<ul class="itemize"><li class="li-itemize">
Please inform the Checker Framework developers
about your new annotated library by opening a pull request or an issue.
This will let us add your annotations to a repository in
<a href="https://github.com/typetools/"><span style="font-family:monospace">https://github.com/typetools/</span></a> and upload a compiled artifact to
the Maven Central Repository.</li><li class="li-itemize">Encourage the library&#X2019;s maintainers to accept your annotations into its
main version control repository. This will make the annotations easier
to maintain, the library will obtain the correctness guarantees of
pluggable type-checking, and there will be no need for the Checker
Framework to include an annotated version of the library.<p>If the library maintainers do not accept the annotations, then
periodically, such as when a new version of the library is released,
pull changes from upstream (the library&#X2019;s main version control system)
into your fork, add annotations to any newly-added methods in classes
that are annotated with <span style="font-family:monospace">@AnnotatedFor</span>, rebuild to create an updated
<span style="font-family:monospace">.jar</span> file, and inform the Checker Framework developers by opening an
issue or issuing a pull request.
</p></li></ul></li></ol>
<!--TOC section id="annotating-jdk" Creating an annotated JDK-->
<h2 id="annotating-jdk" class="section">30.3&#XA0;&#XA0;Creating an annotated JDK <a href="#annotating-jdk" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>This section tells how to create an annotated JDK for a new type system.
Section&#XA0;<a href="#reporting-bugs-annotated-libraries">34.2.1</a> tells how to improve
annotations for the JDK for an existing type system.</p><p>When you create a new checker, you need to also supply annotations for
parts of the JDK, either as stub files or as source code that will be
compiled and its annotations inserted into the JDK. This
section describes the latter approach.
It assumes that you have already followed the instructions for building the
Checker Framework from source (Section&#XA0;<a href="#build-source">34.3</a>).</p><p>If you are adding annotations to an existing annotated JDK, then you only
need to follow the last two steps.</p><ol class="enumerate" type=1><li class="li-enumerate">
Get Java 8 source code (must be version 8)
<ol class="enumerate" type=a><li class="li-enumerate">
Download JDK8 from Oracle
</li><li class="li-enumerate">Open the downloaded tar (<span style="font-family:monospace">tar -xvzf</span>)
</li><li class="li-enumerate">Unzip the contained <span style="font-family:monospace">src.zip</span> (resulting in folders: <span style="font-family:monospace">com/</span>, <span style="font-family:monospace">java/</span>, <span style="font-family:monospace">javax/</span>, <span style="font-family:monospace">launcher/</span>, <span style="font-family:monospace">org/</span>)
</li></ol></li><li class="li-enumerate">Set up the Checker Framework (replace <span style="font-style:italic">mychecker</span> with the name of your checker)
<ol class="enumerate" type=a><li class="li-enumerate">
<span style="font-family:monospace">mkdir $CHECKERFRAMEWORK/checker/jdk/</span><span style="font-family:monospace"><span style="font-style:italic">mychecker</span></span><span style="font-family:monospace">/</span> <br>
 <span style="font-family:monospace">cd $CHECKERFRAMEWORK/checker/jdk/</span><span style="font-family:monospace"><span style="font-style:italic">mychecker</span></span><span style="font-family:monospace">/</span> <br>
 <span style="font-family:monospace">echo "include ../Makefile.jdk" &gt; Makefile</span></li><li class="li-enumerate">Add <span style="font-style:italic">mychecker</span> to
<span style="font-family:monospace">$CHECKERFRAMEWORK/checker/jdk/MakeFile</span> in the definition of
<span style="font-family:monospace">CHECKER_DIRS</span> and in the definition of <span style="font-family:monospace">ANNOTATED_CLASSES</span> (don&#X2019;t forget
to add a closing parenthesis at the end of the definition of <span style="font-family:monospace">ANNOTATED_CLASSES</span>!).</li></ol></li><li class="li-enumerate">For each file you want to annotate, copy the JDK version into the
directory
<span style="font-family:monospace">$CHECKERFRAMEWORK/checker/jdk/</span><span style="font-family:monospace"><span style="font-style:italic">mychecker</span></span><span style="font-family:monospace">/src/</span>, using
the same directory structure as the JDK.<p>Whenever you add a file, fully annotate it, as described in
Section&#XA0;<a href="#library-tips">30.1</a>.</p><p>If you are only annotating fields and method signatures (but not
ensuring that method bodies type-check), then you don&#X2019;t need to suppress
warnings, because the JDK is built using the <span style="font-family:monospace">-Awarns</span> command-line
option.</p></li><li class="li-enumerate">Build the annotated JDK. There are two ways:
<ul class="itemize"><li class="li-itemize">
Pass a flag.
Run <span style="font-family:monospace">./gradlew buildJdk -PuseLocalJdk</span>
</li><li class="li-itemize">Make a setting in the buildfile.
Set <span style="font-family:monospace">jdkShaHash</span> to <span style="font-family:monospace">&#X2018;local&#X2019;</span> in <span style="font-family:monospace">checker/build.gradle</span>, then
run <span style="font-family:monospace">./gradlew buildJdk</span>
</li></ul><p>(First, be sure you have followed the instructions for building the Checker
Framework from source (Section&#XA0;<a href="#build-source">34.3</a>)
including running <span style="font-family:monospace">./gradlew cloneAndBuildDependencies</span>.)</p><p>You may receive a compilation error because your files use a part of the
JDK that is not in the annotated JDK. If the missing part is relatively
small, please add it. If the missing part is large, then you can make
small changes to the JDK source code, such as commenting out a method body.
(Use <span style="font-family:monospace">/*</span> and <span style="font-family:monospace">*/</span> on their own lines, so that the diffs are minimal.)</p><p>To upload a compiled version of the annotated JDK, for use by other people,
see <a href="https://github.com/typetools/annotated-libraries"><span style="font-family:monospace">https://github.com/typetools/annotated-libraries</span></a>.</p></li></ol>
<!--TOC section id="compiling-libraries" Compiling partially-annotated libraries-->
<h2 id="compiling-libraries" class="section">30.4&#XA0;&#XA0;Compiling partially-annotated libraries <a href="#compiling-libraries" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>If you completely annotate a library, then you can compile it using a
pluggable type-checker, and include the resulting <span style="font-family:monospace">.jar</span> file on your
classpath. You get a guarantee that the library contains no errors.</p><p>The rest of this section tells you how to compile a library if you
<em>partially</em> annotate it: that is, you write annotations for some of its
classes but not others.
(There is another type of partial annotation, which is when you annotate
method signatures but do not type-check the bodies.
See Section&#XA0;<a href="#library-tips">30.1</a>.)</p><p>There are two concerns:</p><ul class="itemize"><li class="li-itemize">
Ignoring type-checking errors in unannotated parts of the library.
Use the <span style="font-family:monospace">-AskipDefs</span> or <span style="font-family:monospace">-AonlyDefs</span> command-line arguments; see
Section&#XA0;<a href="#askipdefs">27.5</a>.</li><li class="li-itemize">Putting conservative annotations in unannotated parts of the library.
The checker needs to use normal defaulting rules
(Section&#XA0;<a href="#climb-to-top">26.5.3</a>) for code you have annotated and conservative
defaulting rules (Section&#XA0;<a href="#defaults-classfile">26.5.6</a>) for code you have not
yet annotated. This section describes how to do this. You use
<span style="font-family:monospace">@AnnotatedFor</span> to indicate which classes you have annotated.
</li></ul>
<!--TOC subsection id="AuseDefaultsForUncheckedCodesource" The <span style="font-family:monospace">-AuseDefaultsForUncheckedCode=source,bytecode</span> command-line argument-->
<h3 id="AuseDefaultsForUncheckedCodesource" class="subsection">30.4.1&#XA0;&#XA0;The <span style="font-family:monospace">-AuseDefaultsForUncheckedCode=source,bytecode</span> command-line argument <a href="#AuseDefaultsForUncheckedCodesource" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>
When compiling a library that is not fully annotated, use command-line
argument <span style="font-family:monospace">-AuseDefaultsForUncheckedCode=source,bytecode</span>. This causes
the checker to behave normally for classes with a relevant <span style="font-family:monospace">@AnnotatedFor</span>
annotation. For classes without <span style="font-family:monospace">@AnnotatedFor</span>, the checker uses
unchecked code defaults
(see Section&#XA0;<a href="#defaults-classfile">26.5.6</a>) for any type use with no explicit
user-written annotation, and the checker issues no warnings.
</p><p>The <a href="../api/org/checkerframework/framework/qual/AnnotatedFor.html"><span style="font-family:monospace">@AnnotatedFor</span></a> annotation, written on a
class, indicates that the class has been annotated for certain type
systems. For example, <span style="font-family:monospace">@AnnotatedFor(</span><span style="font-family:monospace">{</span><span style="font-family:monospace">"nullness", "regex"</span><span style="font-family:monospace">}</span><span style="font-family:monospace">)</span> means that
the programmer has written annotations for the Nullness and Regular
Expression type systems. If one of those two type-checkers is run,
the <span style="font-family:monospace">-AuseDefaultsForUncheckedCode=source,bytecode</span> command-line argument
has no effect and this class is treated normally:
unannotated types are defaulted using normal source-code
defaults and type-checking warnings are issued.
<a href="../api/org/checkerframework/framework/qual/AnnotatedFor.html"><span style="font-family:monospace">@AnnotatedFor</span></a>&#X2019;s arguments are any string that
may be passed to the <span style="font-family:monospace">-processor</span> command-line argument: the
fully-qualified class name for the checker, or a shorthand for built-in
checkers (see Section&#XA0;<a href="#shorthand-for-checkers">2.2.5</a>).
Writing <span style="font-family:monospace">@AnnotatedFor</span> on a class doesn&#X2019;t necessarily mean that you wrote
any annotations, but that the user examined the source code and verified
that all appropriate annotations are present.</p><p>
Whenever you compile a class using the Checker Framework, including when
using the <span style="font-family:monospace">-AuseDefaultsForUncheckedCode=source,bytecode</span> command-line
argument, the resulting <span style="font-family:monospace">.class</span> files are fully-annotated; each type use
in the <span style="font-family:monospace">.class</span> file has an explicit type qualifier for any checker that
is run.
</p>
<!--TOC section id="stub" Using stub classes-->
<h2 id="stub" class="section">30.5&#XA0;&#XA0;Using stub classes <a href="#stub" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>A stub file contains &#X201C;stub classes&#X201D; that contain annotated signatures,
but no method bodies. A
checker uses the annotated signatures at compile time, instead of or in
addition to annotations that appear in the library.</p><p>Section&#XA0;<a href="#annotating-jdk">30.3</a> explains how you should choose between
creating stub classes or creating an annotated library.
Section&#XA0;<a href="#stub-creating">30.5.3</a> describes how to create stub classes.
Section&#XA0;<a href="#stub-using">30.5.1</a> describes how to use stub classes.
These sections illustrate stub classes via the example of creating a <a href="../api/org/checkerframework/checker/interning/qual/Interned.html"><span style="font-family:monospace">@Interned</span></a>-annotated
version of <span style="font-family:monospace">java.lang.String</span>. You don&#X2019;t need to repeat these steps
to handle <span style="font-family:monospace">java.lang.String</span> for the Interning Checker,
but you might do something similar for a different class and/or checker.</p>
<!--TOC subsection id="stub-using" Using a stub file-->
<h3 id="stub-using" class="subsection">30.5.1&#XA0;&#XA0;Using a stub file <a href="#stub-using" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The <span style="font-family:monospace">-Astubs</span> argument causes the Checker Framework to read
annotations from annotated stub classes in preference to the unannotated
original library classes. For example:</p><div style="font-size:x-small;">
<pre class="verbatim">  javac -processor org.checkerframework.checker.interning.InterningChecker -Astubs=String.astub:stubs MyFile.java MyOtherFile.java ...
</pre></div><p>Each stub path entry is a stub file (ending with <span style="font-family:monospace">.astub</span>), directory, or
<span style="font-family:monospace">.jar</span> file; specifying a directory or <span style="font-family:monospace">.jar</span> file is
equivalent to specifying every file in it whose name ends with
<span style="font-family:monospace">.astub</span>. The stub path entries are delimited by
<span style="font-family:monospace">File.pathSeparator</span> (&#X2018;<span style="font-family:monospace">:</span>&#X2019; for Linux and Mac, &#X2018;<span style="font-family:monospace">;</span>&#X2019; for Windows).</p><p>A checker automatically reads the stub file <span style="font-family:monospace">jdk.astub</span>, unless
command-line option <span style="font-family:monospace">-Aignorejdkastub</span> is supplied. (The checker
author should place <span style="font-family:monospace">jdk.astub</span> in the same directory as the Checker class, i.e.,
the subclass of <span style="font-family:monospace">BaseTypeVisitor</span>.) Programmers should only use the
<span style="font-family:monospace">-Astubs</span> argument for additional stub files they create themselves.</p><p>If a method appears in more than one stub file (or twice in the same
stub file), then the annotations are merged. If any of the
methods have different annotations from the same hierarchy on the same type,
then the annotation from the last declaration is used.</p><p>If both bytecode and a stub file provide information for the same
element, the stub file information is used. In particular, an
un-annotated type variable in a stub file is used instead of
annotations on a type variable in bytecode.
This feature allows stub files to change the effective annotations in
all possible situations.
Use the <span style="font-family:monospace">-AstubWarnIfOverwritesBytecode</span> command-line option to get a
warning whenever a stub file overwrites bytecode annotations.</p><p>A file being compiled takes precedence over a stub file. If file <span style="font-family:monospace">A.java</span>
is being compiled, then any stub for class <span style="font-family:monospace">A</span> is ignored.</p><p>When a stub file is provided by the author of a checker, the stub file is used
automatically, with no need for the user to supply a command-line option.</p>
<!--TOC subsection id="stub-format" Stub file format-->
<h3 id="stub-format" class="subsection">30.5.2&#XA0;&#XA0;Stub file format <a href="#stub-format" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Every Java file is a valid stub file. However, you can omit information
that is not relevant to pluggable type-checking; this makes the stub file
smaller and easier for people to read and write.
Also note that the stub file&#X2019;s extension must be <span style="font-family:monospace">.astub</span>, not <span style="font-family:monospace">.java</span>.</p><p>As an illustration, a stub file for the Interning type system
(Chapter&#XA0;<a href="#interning-checker">6</a>) could be:</p><pre class="verbatim">  import org.checkerframework.checker.interning.qual.Interned;
  package java.lang;
  @Interned class Class&lt;T&gt; {}
  class String {
    @Interned String intern();
  }
</pre><p>The stub file format is allowed to differ from Java source code in the
following ways:
</p><dl class="description"><dt class="dt-description"></dt><dd class="dd-description"><span style="font-weight:bold">Method bodies:</span>
The stub class does not require method bodies for classes; any method
body may be replaced by a semicolon (<span style="font-family:monospace">;</span>), as in an interface or
abstract method declaration.</dd><dt class="dt-description"></dt><dd class="dd-description"><span style="font-weight:bold">Method declarations:</span>
You only have to specify the methods that you need to annotate.
Any method declaration may be omitted, in which case the checker reads
its annotations from library&#X2019;s <span style="font-family:monospace">.class</span> files. (If you are using a stub class, then
typically the library is unannotated.)</dd><dt class="dt-description"></dt><dd class="dd-description"><span style="font-weight:bold">Declaration specifiers:</span>
Declaration specifiers (e.g., <span style="font-family:monospace">public</span>, <span style="font-family:monospace">final</span>, <span style="font-family:monospace">volatile</span>)
may be omitted.</dd><dt class="dt-description"></dt><dd class="dd-description"><span style="font-weight:bold">Return types:</span>
The return type of a method does not need to match the real method.
In particular, it is valid to use <span style="font-family:monospace">java.lang.Object</span> for every method.
This simplifies the creation of stub files.</dd><dt class="dt-description"></dt><dd class="dd-description"><span style="font-weight:bold">Import statements:</span>
Imports may appear at the beginning of the file or after any package declaration.
The only required import statements are the ones to import type
annotations. Import statements for types are optional.</dd><dt class="dt-description"></dt><dd class="dd-description"><span style="font-weight:bold">Multiple classes and packages:</span>
The stub file format permits having multiple classes and packages.
The packages are separated by a package statement:
<span style="font-family:monospace">package my.package;</span>. Each package declaration may occur only once; in
other words, all classes from a package must appear together.</dd></dl>
<!--TOC subsection id="stub-creating" Creating a stub file-->
<h3 id="stub-creating" class="subsection">30.5.3&#XA0;&#XA0;Creating a stub file <a href="#stub-creating" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Stub files are generally stored together with the checker implementation,
in the same directory as the checker&#X2019;s <span style="font-family:monospace">.java</span> source code.</p>
<!--TOC subsubsection id="stub-creating-with-source" If you have access to the Java source code-->
<h4 id="stub-creating-with-source" class="subsubsection">If you have access to the Java source code <a href="#stub-creating-with-source" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h4><!--SEC END --><p>Every Java file is a stub file. If you have access to the Java file,
rename file <span style="font-family:monospace">A.java</span> to <span style="font-family:monospace">A.astub</span>. You can add
annotations to the signatures, leaving the method bodies unchanged.
The stub file parser silently ignores any annotations that it cannot
resolve to a type, so don&#X2019;t forget the <span style="font-family:monospace">import</span> statement.</p><p>Optionally (but highly recommended!), run the type-checker to verify that
your annotations are correct. When you run the type-checker on your
annotations, there should not be any stub file that also contains
annotations for the class. In particular, if you are type-checking the JDK
itself, then you should use the <span style="font-family:monospace">-Aignorejdkastub</span> command-line option.</p><p>This approach retains the original
documentation and source code, making it easier for a programmer to
double-check the annotations. It also enables creation of diffs, easing
the process of upgrading when a library adds new methods. And, the
annotations are in a format that the library maintainers can even
incorporate.</p><p>The downside of this approach is that the stub files are larger. This can
slow down the Checker Framework, because it parses the stub files each time
it runs.
</p>
<!--TOC subsubsection id="stub-creating-without-source" If you do not have access to the Java source code-->
<h4 id="stub-creating-without-source" class="subsubsection">If you do not have access to the Java source code <a href="#stub-creating-without-source" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h4><!--SEC END --><p>If you do not have access to the library source code, then you can create a
stub file from the class file (Section&#XA0;<a href="#stub-creating">30.5.3</a>),
and then annotate it. The rest of this section describes this approach.</p><ol class="enumerate" type=1><li class="li-enumerate">Create a stub file by running the stub class generator. (<span style="font-family:monospace">checker.jar</span> must be on your classpath.)<pre class="verbatim">  cd nullness-stub
  java -cp $CHECKERFRAMEWORK/checker/dist/checker.jar org.checkerframework.framework.stub.StubGenerator java.lang.String &gt; String.astub
</pre><p>Supply it with the fully-qualified name of the class for which you wish to
generate a stub class. The stub class generator prints the
stub class to standard out, so you may wish to redirect its output to a
file.</p></li><li class="li-enumerate">Add import statements for the annotations. So you would need to
add the following import statement at the beginning of the file:<pre class="verbatim">  import org.checkerframework.checker.interning.qual.*;
</pre><p>The stub file parser silently ignores any annotations that it cannot
resolve to a type, so don&#X2019;t forget the import statement.
Use the <span style="font-family:monospace">-AstubWarnIfNotFound</span> command-line option to see warnings
if an entry could not be found.</p></li><li class="li-enumerate">Add annotations to the stub class. For example, you might annotate
the <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/String.html#intern--"><span style="font-family:monospace">String.intern()</span></a> method as follows:<pre class="verbatim">  @Interned String intern();
</pre><p>You may also remove irrelevant parts of the stub file; see
Section&#XA0;<a href="#stub-format">30.5.2</a>.</p></li></ol>
<!--TOC subsection id="stub-troubleshooting" Troubleshooting stub libraries-->
<h3 id="stub-troubleshooting" class="subsection">30.5.4&#XA0;&#XA0;Troubleshooting stub libraries <a href="#stub-troubleshooting" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END -->
<!--TOC subsubsection id="stub-troubleshooting-type-checking-results" Type-checking does not yield the expected results-->
<h4 id="stub-troubleshooting-type-checking-results" class="subsubsection">Type-checking does not yield the expected results <a href="#stub-troubleshooting-type-checking-results" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h4><!--SEC END --><p>By default, the stub parser silently ignores
annotations on unknown classes and methods.
The stub parser also silently ignores unknown annotations, so don&#X2019;t forget to
<span style="font-family:monospace">import</span> any annotations.
Some command-line options make the stub parser issue more warnings:</p><dl class="description"><dt class="dt-description">
<span style="font-weight:bold"><span style="font-family:monospace">-AstubWarnIfNotFound</span></span></dt><dd class="dd-description">
Warn whenever some element of a stub file cannot be found.
The <span style="font-family:monospace">@NoStubParserWarning</span> annotation on a package or type in a stub file
overrides the <span style="font-family:monospace">-AstubWarnIfNotFound</span> command-line option, and no warning
will be issued.</dd><dt class="dt-description"><span style="font-weight:bold"><span style="font-family:monospace">-AstubWarnIfNotFoundIgnoresClasses</span></span></dt><dd class="dd-description">
Modifies the behavior of <span style="font-family:monospace">-AstubWarnIfNotFound</span>
to report only missing methods/fields, but ignore missing classes, even if
other classes from the same package are present.
Useful if a package spans more than one jar.</dd><dt class="dt-description"><span style="font-weight:bold"><span style="font-family:monospace">-AstubWarnIfOverwritesBytecode</span></span></dt><dd class="dd-description">
Warn whenever some element of a
stub file overwrites annotations contained in bytecode.
</dd></dl><p>Finally,
use command-line option <span style="font-weight:bold"><span style="font-family:monospace">-AstubDebug</span></span> to output debugging messages while
parsing stub files, including about unknown classes, methods, and
annotations. This overrides the <span style="font-family:monospace">@NoStubParserWarning</span> annotation.</p>
<!--TOC subsubsection id="stub-troubleshooting-parsing" Problems parsing stub libraries-->
<h4 id="stub-troubleshooting-parsing" class="subsubsection">Problems parsing stub libraries <a href="#stub-troubleshooting-parsing" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h4><!--SEC END --><p>When using command-line option <span style="font-family:monospace">-AstubWarnIfNotFound</span>,
an error is issued if a stub file has a typo or the API method does not
exist.</p><p>Fix an error of the form
</p><pre class="verbatim">StubParser: Method isLLowerCase(char) not found in type java.lang.Character
</pre><p>by removing the extra &#X201C;L&#X201D; in the method name.</p><p>Fix an error of the form
</p><pre class="verbatim">StubParser: Method enableForegroundNdefPush(Activity,NdefPushCallback)
      not found in type android.nfc.NfcAdapter
</pre><p>by removing the method <span style="font-family:monospace">enableForgroundNdefPush(...)</span> from
the stub file, because it is not defined in class <span style="font-family:monospace">android.nfc.NfcAdapter</span>
in the version of the library you are using.</p>
<!--TOC section id="libraries-troubleshooting" Troubleshooting/debugging annotated libraries-->
<h2 id="libraries-troubleshooting" class="section">30.6&#XA0;&#XA0;Troubleshooting/debugging annotated libraries <a href="#libraries-troubleshooting" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>Sometimes, it may seem that a checker is treating a library as unannotated
even though the library has annotations. The compiler has two flags that
may help you in determining whether library files are read, and if they are
read whether the library&#X2019;s annotations are parsed.</p><dl class="description"><dt class="dt-description">
</dt><dd class="dd-description"><span style="font-family:monospace">-verbose</span>
Outputs info about compile phases &#X2014; when the compiler
reads/parses/attributes/writes any file. Also outputs the classpath and
sourcepath paths.
</dd><dt class="dt-description"></dt><dd class="dd-description"><span style="font-family:monospace">-XDTA:parser</span> (which is equivalent to <span style="font-family:monospace">-XDTA:reader</span> plus <span style="font-family:monospace">-XDTA:writer</span>)
Sets the internal <span style="font-family:monospace">debugJSR308</span> flag, which outputs information about
reading and writing.
</dd></dl><hr>
<!--TOC chapter id="creating-a-checker" How to create a new checker-->
<h1 id="creating-a-checker" class="chapter">Chapter&#XA0;31&#XA0;&#XA0;How to create a new checker <a href="#creating-a-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h1><!--SEC END --><p>
<a id="writing-a-checker"></a> </p><p>This chapter describes how to create a checker
&#X2014; a type-checking compiler plugin that detects bugs or verifies their
absence. After a programmer annotates a program,
the checker plugin verifies that the code is consistent
with the annotations.
If you only want to <em>use</em> a checker, you do not need to read this
chapter.
There is also a
<a href="https://rawgit.com/typetools/checker-framework/master/docs/developer/developer-manual.html">developer
manual</a> for people who wish to edit the Checker Framework source code or
make pull requests.</p><p>Writing a simple checker is easy! For example, here is a complete, useful
type-checker:</p><pre class="verbatim">import java.lang.annotation.Target;
import java.lang.annotation.ElementType;
import org.checkerframework.common.subtyping.qual.Unqualified;
import org.checkerframework.framework.qual.SubtypeOf;

@SubtypeOf(Unqualified.class)
@Target({ElementType.TYPE_USE, ElementType.TYPE_PARAMETER})
public @interface Encrypted {}
</pre><p>This checker is so short because it builds on the Subtyping Checker
(Chapter&#XA0;<a href="#subtyping-checker">23</a>).
See Section&#XA0;<a href="#subtyping-example">23.2</a> for more details about this particular checker.
When you wish to create a new checker, it is often easiest to begin by
building it declaratively on top of the Subtyping Checker, and then return to
this chapter when you need more expressiveness or power than the Subtyping
Checker affords.</p><p>Three choices for creating your own checker are:
</p><ul class="itemize"><li class="li-itemize">
Customize an existing checker.
Checkers that are designed for extension include
the Subtyping Checker (Chapter&#XA0;<a href="#subtyping-checker">23</a>),
the Fake Enumeration Checker (Chapter&#XA0;<a href="#fenum-checker">9</a>),
and the Units Checker (Chapter&#XA0;<a href="#units-checker">17</a>).
</li><li class="li-itemize">Follow the instructions in this chapter to create a checker from scratch.
This enables creation of checkers that are more powerful than customizing
an existing checker.
</li><li class="li-itemize">Copy and then modify a different existing checker &#X2014; whether
one distributed with the Checker Framework or a third-party one.
You can get tangled up if you don&#X2019;t fully understand
the subtleties of the existing checker that you are modifying.
Usually, it is easier to follow the instructions in this chapter.
(If you are going to copy a checker, one good choice to copy and modify
is the Regex Checker (Chapter&#XA0;<a href="#regex-checker">11</a>). A bad choice is
the Nullness Checker (Chapter&#XA0;<a href="#nullness-checker">3</a>),
which is more sophisticated than anything you want to start out building.)
</li></ul><p>You do not need all of the details in this chapter, at least at first.
In addition to reading this chapter of the manual, you may find it helpful
to examine the implementations of the checkers that are distributed with
the Checker Framework.
The Javadoc documentation of the framework and the checkers is in the
distribution and is also available online at
<a href="https://checkerframework.org/api/"><span style="font-family:monospace">https://checkerframework.org/api/</span></a>.</p><p>If you write a new checker and wish to advertise it to the world, let us
know so we can mention it in Chapter&#XA0;<a href="#third-party-checkers">24</a>
or even include it in the Checker Framework distribution.</p>
<!--TOC section id="creating-tool-relationships" How checkers build on the Checker Framework-->
<h2 id="creating-tool-relationships" class="section">31.1&#XA0;&#XA0;How checkers build on the Checker Framework <a href="#creating-tool-relationships" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>This table shows the relationship among tools that the Checker Framework
builds on or that are built on the Checker Framework.
You use the Checker Framework to build pluggable type systems, and the
Annotation File Utilities to manipulate <span style="font-family:monospace">.java</span> and <span style="font-family:monospace">.class</span> files.</p><div class="center">
<table border=1  style="border-spacing:0;" class="cellpadding1"><tr><td style="vertical-align:top;text-align:left;border:solid 1px;" ><div class="center">Subtyping </div><p>Checker</p></td><td style="vertical-align:top;text-align:left;border:solid 1px;" ><div class="center">Nullness </div><p>Checker</p></td><td style="vertical-align:top;text-align:left;border:solid 1px;" ><div class="center">Index </div><p>Checker</p></td><td style="vertical-align:top;text-align:left;border:solid 1px;" ><div class="center">Tainting </div><p>Checker</p></td><td style="vertical-align:top;text-align:left;border:solid 1px;" ><div class="center">&#X2026;</div></td><td style="vertical-align:top;text-align:left;border:solid 1px;" ><div class="center">Your </div><p>Checker</p></td><td style="text-align:center;border:solid 1px;white-space:nowrap"  colspan=2>&nbsp;</td></tr>
<tr><td style="vertical-align:top;text-align:left;border:solid 1px;"  colspan=6><div class="center">Base Checker </div><p>(enforces subtyping rules)</p></td><td style="vertical-align:top;text-align:left;border:solid 1px;" ><div class="center">Type </div><p>inference</p></td><td style="vertical-align:top;text-align:left;border:solid 1px;" >Other <p>tools
</p></td></tr>
<tr><td style="vertical-align:top;text-align:left;border:solid 1px;"  colspan=6><div class="center">Checker Framework </div><p>(enables creation of pluggable type-checkers)</p></td><td style="vertical-align:top;text-align:left;border:solid 1px;"  colspan=2><div class="center"><a href="https://checkerframework.org/annotation-file-utilities/">Annotation File Utilities</a> </div><p>(<span style="font-family:monospace">.java</span> &#X2194; <span style="font-family:monospace">.class</span> files)
</p></td></tr>
<tr><td style="vertical-align:top;text-align:left;border:solid 1px;"  colspan=8><div class="center"><a href="https://checkerframework.org/jsr308/">Java type annotations</a> syntax
and classfile format </div><p>(no built-in semantics) </p></td></tr>
</table>
</div><p>The Base Checker
(more precisely, the <a href="../api/org/checkerframework/common/basetype/BaseTypeChecker.html"><span style="font-family:monospace">BaseTypeChecker</span></a>)
enforces the standard subtyping rules.
The Subtyping Checker is a simple use of the Base Checker that supports
providing type qualifiers on the command line.
You usually want to build your checker on the Base Checker.</p>
<!--TOC section id="creating-parts-of-a-checker" The parts of a checker-->
<h2 id="creating-parts-of-a-checker" class="section">31.2&#XA0;&#XA0;The parts of a checker <a href="#creating-parts-of-a-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The Checker Framework provides abstract base classes (default
implementations), and a specific checker overrides as little or as much of
the default implementations as necessary.
To simplify checker implementations, by default the Checker Framework
automatically discovers the parts of a checker by looking for specific files.
Thus, checker implementations follow a very formulaic structure.
To illustrate, a checker for MyProp must be laid out as follows:
</p><pre class="verbatim">myPackage/
  | qual/                               type qualifiers
  | MyPropChecker.java                  [optional] interface to the compiler
  | MyPropVisitor.java                  [optional] type rules
  | MyPropAnnotatedTypeFactory.java     [optional] type introduction and dataflow rules
</pre><p>Note that <span style="font-family:monospace">MyPropChecker.java</span> is required unless you are building on the
Subtyping Checker.</p><p>Sections&#XA0;<a href="#creating-typequals">31.4</a>&#X2013;<a href="#creating-dataflow">31.8</a> describe
the individual components of a type system as written using the Checker
Framework:</p><dl class="description"><dt class="dt-description"></dt><dd class="dd-description"><a href="#creating-typequals">31.4</a>
<span style="font-weight:bold">Type qualifiers and hierarchy.</span> You define the annotations for
the type system and the subtyping relationships among qualified types
(for instance, <span style="font-family:monospace">@NonNull Object</span> is a subtype of <span style="font-family:monospace">@Nullable
Object</span>). This is also where you specify the default annotation that
applies whenever the programmer wrote no annotation and no other defaulting
rule applies.</dd><dt class="dt-description"></dt><dd class="dd-description"><a href="#creating-compiler-interface">31.5</a>
<span style="font-weight:bold">Interface to the compiler.</span> The compiler interface indicates
which annotations are part of the type system, which command-line options
and <span style="font-family:monospace">@SuppressWarnings</span> annotations the checker recognizes, etc.</dd><dt class="dt-description"></dt><dd class="dd-description"><a href="#creating-extending-visitor">31.6</a>
<span style="font-weight:bold">Type rules.</span> You specify the type system semantics (type
rules), violation of which yields a type error. A type system has two types of
rules.
<ul class="itemize"><li class="li-itemize">
Subtyping rules related to the type hierarchy, such as that in every
assignment,
the type of the right-hand-side is a subtype of the type of the left-hand-side.
Your checker automatically inherits these subtyping rules from the Base
Checker (Chapter&#XA0;<a href="#subtyping-checker">23</a>), so there is nothing for you to do.
</li><li class="li-itemize">Additional rules that are specific to your particular checker. For
example, in the Nullness type system, only references whose type is
<a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a> may be dereferenced. You
write these additional rules yourself.
</li></ul></dd><dt class="dt-description"></dt><dd class="dd-description"><a href="#creating-type-introduction">31.7</a>
<span style="font-weight:bold">Type introduction rules.</span> You specify the type of some expressions where
the rules differ from the built in framework rules</dd><dt class="dt-description"></dt><dd class="dd-description"><a href="#creating-dataflow">31.8</a>
<span style="font-weight:bold">Dataflow rules.</span> These optional rules enhance flow-sensitive
type qualifier inference (also known as local variable type inference).
</dd></dl>
<!--TOC section id="creating-compiling" Compiling and using a custom checker-->
<h2 id="creating-compiling" class="section">31.3&#XA0;&#XA0;Compiling and using a custom checker <a href="#creating-compiling" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>You can place your checker&#X2019;s source files wherever you like.
One choice is to write your checker in a fork of the Checker Framework
repository <a href="https://github.com/typetools/checker-framework"><span style="font-family:monospace">https://github.com/typetools/checker-framework</span></a>.
Another choice is to write it in a stand-alone repository. Here is a
template for a stand-alone repository:
<a href="https://github.com/typetools/templatefora-checker"><span style="font-family:monospace">https://github.com/typetools/templatefora-checker</span></a>; at that URL,
click the &#X201C;Use this template&#X201D; button.</p><p>Once your custom checker is written, using it is very similar to using a
built-in checker (Section&#XA0;<a href="#running">2.2</a>):
simply pass the fully-qualified name of your <span style="font-family:monospace">BaseTypeChecker</span>
subclass to the <span style="font-family:monospace">-processor</span> command-line option:
</p><pre>
  javac -processor <span style="font-style:italic">mypackage.MyPropChecker</span> SourceFile.java
</pre><p>
Note that your custom checker&#X2019;s
<span style="font-family:monospace">.class</span> files must be on the Java classpath.
Invoking a custom checker that builds on
the Subtyping Checker is slightly different (Section&#XA0;<a href="#subtyping-using">23.1</a>).</p>
<!--TOC subsection id="creating-tips" Tips for creating a checker-->
<h3 id="creating-tips" class="subsection">31.3.1&#XA0;&#XA0;Tips for creating a checker <a href="#creating-tips" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>To make your job easier, we recommend that you build your type-checker
incrementally, testing at each phase rather than trying to build the whole
thing at once.</p><p>Here is a good way to proceed.</p><ol class="enumerate" type=1><li class="li-enumerate">
Before you start coding, first write the user manual. The manual
explains the type system, what it guarantees, how to use it, etc., from
the point of view of a user. Writing the manual will help you flesh out
your goals and the concepts, which are easier to understand and change in
text than in an implementation.
Section&#XA0;<a href="#creating-documenting-a-checker">31.12</a> gives a suggested structure
for the manual chapter, which will help you avoid omitting any parts.
Get feedback from someone else at this point to ensure that your manual
is comprehensible.<p>Once you have designed and documented the parts of your type system, you
should &#X201C;play computer&#X201D;, manually
type-checking some code according to the rules you defined.
During manual checking, ask
yourself what reasoning you applied, what information you needed, and
whether your written-down rules were sufficient.</p></li><li class="li-enumerate">Implement the type qualifiers and hierarchy
(Section&#XA0;<a href="#creating-typequals">31.4</a>).<p>Write simple test cases that consist of only assignments,
to test your type hierarchy. For instance, if
your type hierarchy consists of a supertype <span style="font-family:monospace">@UnknownSign</span> and a subtype
<span style="font-family:monospace">@NonNegative</span>, then you could write a test case such as:</p><pre class="verbatim">  void foo(@UnknownSign int us, @NonNegative int nn) {
    @UnknownSign int a = us;
    @UnknownSign int b = nn;
    // :: error: assignment.type.incompatible
    @NonNegative int c = us;  // expected error on this line
    @NonNegative int d = nn;
  }
</pre><p>Type-check your test files using the Subtyping Checker
(Chapter&#XA0;<a href="#subtyping-checker">23</a>).</p></li><li class="li-enumerate">Write the checker class itself
(Section&#XA0;<a href="#creating-compiler-interface">31.5</a>).<p>Ensure that you can still type-check your test files and that the results
are the same. You will not use the Subtyping Checker any more; you will
call the checker directly, as in</p><pre class="verbatim">  javac -processor mypackage.MyChecker File1.java File2.java ...
</pre></li><li class="li-enumerate">If your checker source code is in a clone of the Checker Framework
repository, integrate your checker with the Checker Framework&#X2019;s Gradle
targets for testing (Section&#XA0;<a href="#creating-testing-framework">31.10</a>). This
will make it much more convenient to run tests, and to ensure that they
are passing, as your work proceeds.</li><li class="li-enumerate">Annotate parts of the JDK, if relevant
(Section&#XA0;<a href="#creating-a-checker-annotated-jdk">31.9</a>).<p>Write test cases for at least some of the annotated JDK methods to ensure
that the annotations are being properly read by your checker.</p></li><li class="li-enumerate">Implement type rules, if any (Section&#XA0;<a href="#creating-extending-visitor">31.6</a>).
(Some type systems need JDK annotations but don&#X2019;t have any additional
type rules.)<p>Before implementing type rules (or any other code in your type-checker),
read the Javadoc to familiarize yourself with the utility routines in the
<span style="font-family:monospace">org.checkerframework.javacutil</span> package, especially
<a href="../api/org/checkerframework/javacutil/AnnotationBuilder.html"><span style="font-family:monospace">AnnotationBuilder</span></a>,
<a href="../api/org/checkerframework/javacutil/AnnotationUtils.html"><span style="font-family:monospace">AnnotationUtils</span></a>,
<a href="../api/org/checkerframework/javacutil/ElementUtils.html"><span style="font-family:monospace">ElementUtils</span></a>,
<a href="../api/org/checkerframework/javacutil/TreeUtils.html"><span style="font-family:monospace">TreeUtils</span></a>,
<a href="../api/org/checkerframework/javacutil/TypeAnnotationUtils.html"><span style="font-family:monospace">TypeAnnotationUtils</span></a>, and
<a href="../api/org/checkerframework/javacutil/TypesUtils.html"><span style="font-family:monospace">TypesUtils</span></a>.
You will learn how to access needed information and avoid
reimplementing existing functionality.</p><p>Write simple test cases to test the type rules, and ensure that the
type-checker behaves as expected on those test files.
For example, if your type system forbids indexing an array by a
possibly-negative value, then you would write a test case such as:</p><pre class="verbatim">  void foo(String[] myArray, @UnknownSign int us, @NonNegative int nn) {
    myArray[us];  // expected error on this line
    myArray[nn];
  }
</pre></li><li class="li-enumerate">Implement type introduction rules, if any (Section&#XA0;<a href="#creating-type-introduction">31.7</a>).<p>Test your type introduction rules.
For example, if your type system sets the qualifier for manifest literal
integers and for array lengths, you would write a test case like the following:</p><pre class="verbatim">  void foo(String[] myArray) {
    @NonNegative nn1 = -1;  // expected error on this line
    @NonNegative nn2 = 0;
    @NonNegative nn3 = 1;
    @NonNegative nn4 = myArray.length;
  }
</pre></li><li class="li-enumerate">Optionally, implement dataflow refinement rules
(Section&#XA0;<a href="#creating-dataflow">31.8</a>).<p>Test them if you wrote any.
For instance, if after an arithmetic comparison, your type system infers
which expressions are now known to be non-negative, you could write a
test case such as:</p><pre class="verbatim">  void foo(@UnknownSign int us, @NonNegative int nn) {
    @NonNegative nn2;
    nn2 = us;  // expected error on this line
    if (us &gt; j) {
      nn2 = us;
    }
    if (us &gt;= j) {
      nn2 = us;
    }
    if (j &lt; us) {
      nn2 = us;
    }
    if (j &lt;= us) {
      nn2 = us;
    }
    nn = us;  // expected error on this line
  }
</pre></li></ol>
<!--TOC section id="creating-typequals" Annotations: Type qualifiers and hierarchy-->
<h2 id="creating-typequals" class="section">31.4&#XA0;&#XA0;Annotations: Type qualifiers and hierarchy <a href="#creating-typequals" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>A type system designer specifies the qualifiers in the type system (Section&#XA0;<a href="#creating-define-type-qualifiers">31.4.1</a>)
and
the type hierarchy that relates them.
The type hierarchy &#X2014; the subtyping relationships among the qualifiers &#X2014;
can be defined either
declaratively via meta-annotations (Section&#XA0;<a href="#creating-declarative-hierarchy">31.4.2</a>), or procedurally through
subclassing <a href="../api/org/checkerframework/framework/type/QualifierHierarchy.html"><span style="font-family:monospace">QualifierHierarchy</span></a> or
<a href="../api/org/checkerframework/framework/type/TypeHierarchy.html"><span style="font-family:monospace">TypeHierarchy</span></a> (Section&#XA0;<a href="#creating-procedural-hierarchy">31.4.3</a>).</p>
<!--TOC subsection id="creating-define-type-qualifiers" Defining the type qualifiers-->
<h3 id="creating-define-type-qualifiers" class="subsection">31.4.1&#XA0;&#XA0;Defining the type qualifiers <a href="#creating-define-type-qualifiers" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Type qualifiers are defined as Java annotations. In Java, an
annotation is defined using the Java <span style="font-family:monospace">@interface</span> keyword.
Here is how to define a two-qualifier hierarchy:</p><pre class="verbatim">package mypackage.qual;
import java.lang.annotation.Documented;
import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;
import org.checkerframework.framework.qual.DefaultQualifierInHierarchy;
import org.checkerframework.framework.qual.SubtypeOf;
/**
 * The run-time value of the integer is unknown.
 *
 * @checker_framework.manual #nonnegative-checker Non-Negative Checker
 */
@Documented
@Retention(RetentionPolicy.RUNTIME)
@Target({ElementType.TYPE_USE, ElementType.TYPE_PARAMETER})
@SubtypeOf({})
@DefaultQualifierInHierarchy
public @interface UnknownSign {}


package mypackage.qual;
import java.lang.annotation.Documented;
import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;
import org.checkerframework.framework.qual.LiteralKind;
import org.checkerframework.framework.qual.SubtypeOf;
/**
 * Indicates that the value is greater than or equal to zero.
 *
 * @checker_framework.manual #nonnegative-checker Non-Negative Checker
 */
@Documented
@Retention(RetentionPolicy.RUNTIME)
@Target({ElementType.TYPE_USE, ElementType.TYPE_PARAMETER})
@SubtypeOf({UnknownSign.class})
public @interface NonNegative {}
</pre><p>The <a href="../api/org/checkerframework/framework/qual/SubtypeOf.html"><span style="font-family:monospace">@SubtypeOf</span></a> meta-annotation
indicates the parent in the type hierarchy.</p><p>The <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/annotation/Target.html"><span style="font-family:monospace">@Target</span></a>
meta-annotation indicates where the annotation
may be written. All type qualifiers that users can write in source code should
have the value <span style="font-family:monospace">ElementType.TYPE_USE</span> and optionally with the additional value
of <span style="font-family:monospace">ElementType.TYPE_PARAMETER</span>, but no other <span style="font-family:monospace">ElementType</span> values.
</p><p>The annotations should be placed within a directory called <span style="font-family:monospace">qual</span>, and
<span style="font-family:monospace">qual</span> should be placed in the same directory as your checker&#X2019;s source file.</p><p>For example, the Nullness Checker&#X2019;s source file is located at
<span style="font-family:monospace">.../nullness/NullnessChecker.java</span>. The <span style="font-family:monospace">@NonNull</span> qualifier is defined in
file <span style="font-family:monospace">.../nullness/qual/NonNull.java</span>.</p><p>The Checker Framework automatically treats any annotation that
is declared in the <span style="font-family:monospace">qual</span> package as a type qualifier.
(See Section <a href="#creating-indicating-supported-annotations">31.5.1</a> for more details.)</p><p>Your type system should include a top qualifier and a bottom qualifier
(Section&#XA0;<a href="#creating-bottom-and-top-qualifier">31.4.7</a>).</p><p>You should also define a
polymorphic qualifier <span style="font-family:monospace">@Poly</span><span style="font-family:monospace"><em>MyTypeSystem</em></span>
(Section&#XA0;<a href="#qualifier-polymorphism">25.2</a>).</p><p>The Javadoc of every type qualifier should include an example use of the
qualifier.</p>
<!--TOC subsection id="creating-declarative-hierarchy" Declaratively defining the qualifier hierarchy-->
<h3 id="creating-declarative-hierarchy" class="subsection">31.4.2&#XA0;&#XA0;Declaratively defining the qualifier hierarchy <a href="#creating-declarative-hierarchy" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Declaratively, the type system designer uses two meta-annotations (written
on the declaration of qualifier annotations) to specify the qualifier
hierarchy.</p><ul class="itemize"><li class="li-itemize"><a href="../api/org/checkerframework/framework/qual/SubtypeOf.html"><span style="font-family:monospace">@SubtypeOf</span></a> denotes that a qualifier is a subtype of
another qualifier or qualifiers, specified as an array of class
literals. For example, for any type <span style="font-style:italic">T</span>,
<a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a> <span style="font-style:italic">T</span> is a subtype of <a href="../api/org/checkerframework/checker/nullness/qual/Nullable.html"><span style="font-family:monospace">@Nullable</span></a> <span style="font-style:italic">T</span>:<pre class="verbatim">    @Target({ElementType.TYPE_USE, ElementType.TYPE_PARAMETER})
    @SubtypeOf( { Nullable.class } )
    public @interface NonNull {}
  </pre><p><a href="../api/org/checkerframework/framework/qual/SubtypeOf.html"><span style="font-family:monospace">@SubtypeOf</span></a> accepts multiple annotation classes as an argument,
permitting the type hierarchy to be an arbitrary DAG.</p><p>All type qualifiers, except for polymorphic qualifiers (see below and
also Section&#XA0;<a href="#qualifier-polymorphism">25.2</a>), need to be
properly annotated with <a href="../api/org/checkerframework/framework/qual/SubtypeOf.html"><span style="font-family:monospace">SubtypeOf</span></a>.</p><p>The top qualifier is annotated with
<span style="font-family:monospace">@SubtypeOf( { } )</span>. The top qualifier is the qualifier that is
a supertype of all other qualifiers. For example, <a href="../api/org/checkerframework/checker/nullness/qual/Nullable.html"><span style="font-family:monospace">@Nullable</span></a>
is the top qualifier of the Nullness type system, hence is defined as:</p><pre class="verbatim">    @Target({ElementType.TYPE_USE, ElementType.TYPE_PARAMETER})
    @SubtypeOf( {} )
    public @interface Nullable {}
  </pre><p>
If the top qualifier of the hierarchy is the generic unqualified type
(this is not recommended!), then its children
will use <span style="font-family:monospace">@SubtypeOf(Unqualified.class)</span>, but no
<span style="font-family:monospace">@SubtypeOf({})</span> annotation on the top qualifier <span style="font-family:monospace">Unqualified</span> is
necessary. For an example, see the
<span style="font-family:monospace">Encrypted</span> type system of Section&#XA0;<a href="#encrypted-example">23.2</a>.
</p></li><li class="li-itemize"><a href="../api/org/checkerframework/framework/qual/PolymorphicQualifier.html"><span style="font-family:monospace">@PolymorphicQualifier</span></a> denotes that a qualifier is a
polymorphic qualifier. For example:<pre class="verbatim">    @Target({ElementType.TYPE_USE, ElementType.TYPE_PARAMETER})
    @PolymorphicQualifier
    public @interface PolyNull {}
  </pre><p>For a description of polymorphic qualifiers, see
Section&#XA0;<a href="#qualifier-polymorphism">25.2</a>. A polymorphic qualifier needs
no <a href="../api/org/checkerframework/framework/qual/SubtypeOf.html"><span style="font-family:monospace">@SubtypeOf</span></a> meta-annotation and need not be
mentioned in any other <a href="../api/org/checkerframework/framework/qual/SubtypeOf.html"><span style="font-family:monospace">@SubtypeOf</span></a>
meta-annotation.</p></li></ul><p>The declarative and procedural mechanisms for specifying the hierarchy can
be used together. In particular, when using the <a href="../api/org/checkerframework/framework/qual/SubtypeOf.html"><span style="font-family:monospace">@SubtypeOf</span></a>
meta-annotation, further customizations may be
performed procedurally (Section&#XA0;<a href="#creating-procedural-hierarchy">31.4.3</a>)
by overriding the <a href="../api/org/checkerframework/framework/util/GraphQualifierHierarchy.html#isSubtype-java.util.Collection-java.util.Collection-"><span style="font-family:monospace">isSubtype</span></a> method in the checker class
(Section&#XA0;<a href="#creating-compiler-interface">31.5</a>).
However, the declarative mechanism is sufficient for most type systems.</p>
<!--TOC subsection id="creating-procedural-hierarchy" Procedurally defining the qualifier hierarchy-->
<h3 id="creating-procedural-hierarchy" class="subsection">31.4.3&#XA0;&#XA0;Procedurally defining the qualifier hierarchy <a href="#creating-procedural-hierarchy" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>While the declarative syntax suffices for many cases, more complex
type hierarchies can be expressed by overriding, in your subclass of <a href="../api/org/checkerframework/common/basetype/BaseTypeVisitor.html"><span style="font-family:monospace">BaseTypeVisitor</span></a>,
either <a href="../api/org/checkerframework/framework/type/AnnotatedTypeFactory.html#createQualifierHierarchy--"><span style="font-family:monospace">createQualifierHierarchy</span></a> or <a href="../api/org/checkerframework/framework/type/AnnotatedTypeFactory.html#createTypeHierarchy--"><span style="font-family:monospace">createTypeHierarchy</span></a> (typically
only one of these needs to be overridden).
For more details, see the Javadoc of those methods and of the classes
<a href="../api/org/checkerframework/framework/type/QualifierHierarchy.html"><span style="font-family:monospace">QualifierHierarchy</span></a> and <a href="../api/org/checkerframework/framework/type/TypeHierarchy.html"><span style="font-family:monospace">TypeHierarchy</span></a>.</p><p>The <a href="../api/org/checkerframework/framework/type/QualifierHierarchy.html"><span style="font-family:monospace">QualifierHierarchy</span></a> class represents the qualifier hierarchy (not the
type hierarchy). A type-system designer may subclass
<a href="../api/org/checkerframework/framework/type/QualifierHierarchy.html"><span style="font-family:monospace">QualifierHierarchy</span></a> to express customized qualifier
relationships (e.g., relationships based on annotation
arguments).</p><p>The <a href="../api/org/checkerframework/framework/type/TypeHierarchy.html"><span style="font-family:monospace">TypeHierarchy</span></a> class represents the type hierarchy &#X2014;
that is, relationships between
annotated types, rather than merely type qualifiers, e.g., <span style="font-family:monospace">@NonNull
Date</span> is a subtype of <span style="font-family:monospace">@Nullable Date</span>. The default <a href="../api/org/checkerframework/framework/type/TypeHierarchy.html"><span style="font-family:monospace">TypeHierarchy</span></a> uses
<a href="../api/org/checkerframework/framework/type/QualifierHierarchy.html"><span style="font-family:monospace">QualifierHierarchy</span></a> to determine all subtyping relationships.
The default <a href="../api/org/checkerframework/framework/type/TypeHierarchy.html"><span style="font-family:monospace">TypeHierarchy</span></a> handles
generic type arguments, array components, type variables, and
wildcards in a similar manner to the Java standard subtype
relationship but with taking qualifiers into consideration. Some type
systems may need to override that behavior. For instance, the Java
Language Specification specifies that two generic types are subtypes only
if their type arguments are identical: for example,
<span style="font-family:monospace">List&lt;Date&gt;</span> is not a subtype of <span style="font-family:monospace">List&lt;Object&gt;</span>, or of any other
generic <span style="font-family:monospace">List</span>.
(In the technical jargon, the generic arguments are &#X201C;invariant&#X201D; or &#X201C;novariant&#X201D;.)</p>
<!--TOC subsection id="creating-typesystem-defaults" Defining the default annotation-->
<h3 id="creating-typesystem-defaults" class="subsection">31.4.4&#XA0;&#XA0;Defining the default annotation <a href="#creating-typesystem-defaults" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>A type system applies the default qualifier where the user has not written a
qualifier (and no other default qualifier is applicable), as explained in
Section&#XA0;<a href="#defaults">26.5</a>.</p><p>The type system designer must specify the default annotation. The designer can specify the default annotation declaratively,
using the <a href="../api/org/checkerframework/framework/qual/DefaultQualifierInHierarchy.html"><span style="font-family:monospace">@DefaultQualifierInHierarchy</span></a>
meta-annotation.
Note that the default will apply to any source code that the checker reads,
including stub libraries, but will not apply to compiled <span style="font-family:monospace">.class</span>
files that the checker reads.</p><p>
Alternately, the type system designer may specify a default procedurally,
by overriding the
<a href="../api/org/checkerframework/framework/type/GenericAnnotatedTypeFactory.html#addCheckedCodeDefaults-org.checkerframework.framework.util.defaults.QualifierDefaults-"><span style="font-family:monospace">GenericAnnotatedTypeFactory.addCheckedCodeDefaults</span></a>
method. You may do this even if you have declaratively defined the
qualifier hierarchy.
</p><p>If the default qualifier in the type hierarchy requires a value, there are
ways for the type system designer to specify a default value both
declaratively and procedurally, as well. To do so declaratively, append
the string <span style="font-family:monospace">default </span><span style="font-family:monospace"><em>value</em></span> where <em>value</em> is the actual value
you want to be the default, after the declaration of the value in the
qualifier file. For instance, <span style="font-family:monospace">int value() default 0;</span> would make
<span style="font-family:monospace">value</span> default to zero. Alternatively, the procedural method
described above can be used.</p><p>The default qualifier applies to most, but not all, unannotated types, Section&#XA0;<a href="#climb-to-top">26.5.3</a>
other defaulting rules are automatically added to every checker. Also, Section&#XA0;<a href="#defaults">26.5</a>
describes other meta-annotations used to specify default annotations.</p>
<!--TOC subsection id="creating-relevant-java-types" Relevant Java types-->
<h3 id="creating-relevant-java-types" class="subsection">31.4.5&#XA0;&#XA0;Relevant Java types <a href="#creating-relevant-java-types" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Sometimes, a checker only processes certain Java types. For example, the
<a href="#formatter-checker">Format String Checker</a> is relevant only to
<span style="font-family:monospace">CharSequence</span> and its subtypes such as <span style="font-family:monospace">String</span>.
The <a href="../api/org/checkerframework/framework/qual/RelevantJavaTypes.html"><span style="font-family:monospace">@RelevantJavaTypes</span></a>
annotation on the checker class indicates that its qualifiers may only be
written on those types and no others. All irrelevant types are defaulted to
the top annotation.</p>
<!--TOC subsection id="creating-do-not-re-use-type-qualifiers" Do not re-use type qualifiers-->
<h3 id="creating-do-not-re-use-type-qualifiers" class="subsection">31.4.6&#XA0;&#XA0;Do not re-use type qualifiers <a href="#creating-do-not-re-use-type-qualifiers" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Every annotation should belong to only one type system. No annotation
should be used by multiple type systems. This is true even of annotations
that are internal to the type system and are not intended to be written by
the programmer.</p><p>Suppose that you have two type systems that both use the same type
qualifier <span style="font-family:monospace">@Bottom</span>. In a client program, a use of type <span style="font-family:monospace">T</span> may require type
qualifier <span style="font-family:monospace">@Bottom</span> for one type system but a different qualifier for the other
type system. There is no annotation that a programmer can write to make
the program type-check under both type systems.</p><p>This also applies to type qualifiers that a programmer does not write,
because the compiler outputs <span style="font-family:monospace">.class</span> files that contain an explicit type
qualifier on every type &#X2014; a defaulted or inferred type qualifier if the
programmer didn&#X2019;t write a type qualifier explicitly.</p>
<!--TOC subsection id="creating-bottom-and-top-qualifier" Completeness of the type hierarchy-->
<h3 id="creating-bottom-and-top-qualifier" class="subsection">31.4.7&#XA0;&#XA0;Completeness of the type hierarchy <a href="#creating-bottom-and-top-qualifier" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>When you define a type system, its type hierarchy must be a
lattice: every set of types has a unique least upper bound and a unique
greatest lower bound. This implies that there must be a top type that is a
supertype of all other types, and there must be a bottom type that is a
subtype of all other types.
Furthermore, the top type and bottom type should be defined
specifically for the type system. Don&#X2019;t reuse an existing qualifier from the
Checker Framework such as <span style="font-family:monospace">@Unqualified</span>.</p><p>It is possible that a single type-checker checks multiple type hierarchies.
An example is the Nullness Checker, which has three separate type
hierarchies, one each for
nullness, initialization, and map keys. In this case, each type hierarchy
would have its own top qualifier and its own bottom qualifier; they don&#X2019;t
all have to share a single top qualifier or a single bottom qualifier.</p>
<!--TOC paragraph id="creating-bottom-qualifier" Bottom qualifier-->
<h5 id="creating-bottom-qualifier" class="paragraph">Bottom qualifier <a href="#creating-bottom-qualifier" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h5><!--SEC END --><p>
Your type hierarchy must have a bottom qualifier
&#X2014; a qualifier that is a (direct or indirect) subtype of every other
qualifier.</p><p><span style="font-family:monospace">null</span> is the bottom type. Because the only value with type <span style="font-family:monospace">Void</span> is
<span style="font-family:monospace">null</span>, uses of the type <span style="font-family:monospace">Void</span> are also bottom.
(The only exception
is if the type system has special treatment for <span style="font-family:monospace">null</span> values, as the
Nullness Checker does. In that case, add the meta-annotation <span style="font-family:monospace">@QualifierForLiterals(LiteralKind.NULL)</span>
to the correct qualifier.)
This legal code
will not type-check unless <span style="font-family:monospace">null</span> has the bottom type:
</p><pre class="verbatim">&lt;T&gt; T f() {
    return null;
}
</pre><p>Some type systems have a special bottom type that is used <em>only</em> for
the <span style="font-family:monospace">null</span> value, and for dead code and other erroneous situations.
In this case, users should only write the bottom qualifier on explicit
bounds. In this case, the definition of the bottom qualifier should be
meta-annotated with:</p><pre class="verbatim">@Target({ElementType.TYPE_USE, ElementType.TYPE_PARAMETER})
@TargetLocations({TypeUseLocation.EXPLICIT_LOWER_BOUND, TypeUseLocation.EXPLICIT_UPPER_BOUND})
</pre><p>Furthermore, by convention the name of such a qualifier ends with &#X201C;<span style="font-family:monospace">Bottom</span>&#X201D;.</p><p>The hierarchy shown in Figure&#XA0;<a href="#fig-initialization-hierarchy">3.3</a> lacks
a bottom qualifier, but the actual implementation does contain a (non-user-visible) bottom qualifier.</p>
<!--TOC paragraph id="creating-top-qualifier" Top qualifier-->
<h5 id="creating-top-qualifier" class="paragraph">Top qualifier <a href="#creating-top-qualifier" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h5><!--SEC END --><p>
Your type hierarchy must have a top qualifier
&#X2014; a qualifier that is a (direct or indirect) supertype of every other
qualifier.
Here is one reason.
The default type for local variables is the top
qualifier (that type is then flow-sensitively
refined depending on what values are stored in the local variable).
If there is no single top qualifier, then there is no
unambiguous choice to make for local variables.</p>
<!--TOC subsection id="expression-annotations" Annotations whose argument is a Java expression (dependent type annotations)-->
<h3 id="expression-annotations" class="subsection">31.4.8&#XA0;&#XA0;Annotations whose argument is a Java expression (dependent type annotations)<a id="dependent-types"></a> <a href="#dependent-types" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Sometimes, an annotation needs to refer to a Java expression.
Section&#XA0;<a href="#java-expressions-as-arguments">26.8</a> gives examples of such
annotations and also explains what Java expressions can and cannot be
referred to.</p><p>This section explains how to implement a dependent type annotation.</p><p>A &#X201C;dependent type annotation&#X201D;
must have one attribute, <span style="font-family:monospace">value</span>, that is an
array of strings. The Checker Framework verifies that the annotation&#X2019;s
arguments are valid expressions according to the rules of
Section&#XA0;<a href="#java-expressions-as-arguments">26.8</a>. If
the expression is not valid, an error is issued and the string in the
annotation is changed to indicate that the expression is not valid.</p><p>The Checker Framework standardizes the expression strings. For example, a
field <span style="font-family:monospace">f</span> can be referred to as either &#X201C;<span style="font-family:monospace">f</span>&#X201D; or &#X201C;<span style="font-family:monospace">this.f</span>&#X201D;. If the
programmer writes &#X201C;<span style="font-family:monospace">f</span>&#X201D;, the Checker Framework treats it
as if the programmer had written &#X201C;<span style="font-family:monospace">this.f</span>&#X201D;.
An advantage of this canonicalization is
that comparisons, such as <span style="font-family:monospace">isSubtype</span>, can be implemented as string comparisons.</p><p>The Checker Framework viewpoint-adapts type annotations on method, constructor,
and field declarations at uses for those methods. For example, given the
following class</p><pre class="verbatim">class MyClass {
   Object field = ...;
   @Anno("this.field") Object field2 = ...;
}
</pre><p>and assuming the variable <span style="font-family:monospace">myClass</span> is of type <span style="font-family:monospace">MyClass</span>, then the type of
<span style="font-family:monospace">myClass.field</span> is viewpoint-adapted to <span style="font-family:monospace">@Anno("myClass.field")</span>.</p><p>To use this built-in functionality, add a <a href="../api/org/checkerframework/framework/qual/JavaExpression.html"><span style="font-family:monospace">@JavaExpression</span></a> annotation
to any annotation element that should be interpreted as a Java expression. The type of the
element must be an array of Strings. If your checker requires special handling of Java expressions,
your checker implementation should override
<a href="../api/org/checkerframework/framework/type/GenericAnnotatedTypeFactory.html#createDependentTypesHelper--"><span style="font-family:monospace">GenericAnnotatedTypeFactory.createDependentTypesHelper</span></a>
to return a subclass of <span style="font-family:monospace">DependentTypesHelper</span>.</p><p>Given a specific expression in the program (of type Tree or Node), a
checker may need to obtain its canonical string representation. This
enables the checker to create an dependent type annotation that refers to
it, or to compare to the string expression of an existing expression
annotation.
To obtain the string, first create a
<a href="../api/org/checkerframework/dataflow/analysis/FlowExpressions.Receiver.html"><span style="font-family:monospace">FlowExpressions.Receiver</span></a> object by calling
<a href="../api/org/checkerframework/dataflow/analysis/FlowExpressions.html#internalReprOf-org.checkerframework.javacutil.AnnotationProvider-com.sun.source.tree.ExpressionTree-"><span style="font-family:monospace">internalReprOf(AnnotationProvider,
ExpressionTree)</span></a> or
<a href="../api/org/checkerframework/dataflow/analysis/FlowExpressions.html#internalReprOf-org.checkerframework.javacutil.AnnotationProvider-org.checkerframework.dataflow.cfg.node.Node-"><span style="font-family:monospace">internalReprOf(AnnotationProvider,
Node)</span></a>.
Then, call <span style="font-family:monospace">toString()</span> on the <span style="font-family:monospace">FlowExpressions.Receiver</span> object.</p>
<!--TOC section id="creating-compiler-interface" The checker class: Compiler interface-->
<h2 id="creating-compiler-interface" class="section">31.5&#XA0;&#XA0;The checker class: Compiler interface <a href="#creating-compiler-interface" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>A checker&#X2019;s entry point is a subclass of
<a href="../api/org/checkerframework/framework/source/SourceChecker.html"><span style="font-family:monospace">SourceChecker</span></a>, and is usually a direct subclass
of either <a href="../api/org/checkerframework/common/basetype/BaseTypeChecker.html"><span style="font-family:monospace">BaseTypeChecker</span></a> or
<a href="../api/org/checkerframework/framework/source/AggregateChecker.html"><span style="font-family:monospace">AggregateChecker</span></a>.
This entry
point, which we call the checker class, serves two
roles: an interface to the compiler and a factory for constructing
type-system classes.</p><p>Because the Checker Framework provides reasonable defaults, oftentimes the
checker class has no work to do. Here are the complete definitions of the
checker classes for the Interning Checker and the Nullness Checker:</p><pre class="verbatim">  package my.package;
  import org.checkerframework.common.basetype.BaseTypeChecker;
  @SupportedLintOptions({"dotequals"})
  public final class InterningChecker extends BaseTypeChecker {}

  package my.package;
  import org.checkerframework.common.basetype.BaseTypeChecker;
  @SupportedLintOptions({"flow", "cast", "cast:redundant"})
  public class NullnessChecker extends BaseTypeChecker {}
</pre><p>(The <a href="../api/org/checkerframework/framework/source/SupportedLintOptions.html"><span style="font-family:monospace">@SupportedLintOptions</span></a> annotation is
optional, and many checker classes do not have one.)</p><p>The checker class bridges between the Java compiler and the checker. It
invokes the type-rule check visitor on every Java source file being
compiled, and provides a simple API,
<a href="../api/org/checkerframework/framework/source/SourceChecker.html#report-org.checkerframework.framework.source.Result-java.lang.Object-"><span style="font-family:monospace">SourceChecker.report</span></a>, to issue
errors using the compiler error reporting mechanism.</p><p>Also, the checker class follows the factory method pattern to
construct the concrete classes (e.g., visitor, factory) and annotation
hierarchy representation. It is a convention that, for
a type system named Foo, the compiler
interface (checker), the visitor, and the annotated type factory are
named as <span style="font-family:monospace">FooChecker</span>, <span style="font-family:monospace">FooVisitor</span>, and <span style="font-family:monospace">FooAnnotatedTypeFactory</span>.
<a href="../api/org/checkerframework/common/basetype/BaseTypeChecker.html"><span style="font-family:monospace">BaseTypeChecker</span></a> uses the convention to
reflectively construct the components. Otherwise, the checker writer
must specify the component classes for construction.</p><p>
A checker can customize the default error messages through a
<a href="https://docs.oracle.com/javase/8/docs/api/java/util/Properties.html"><span style="font-family:monospace">Properties</span></a>-loadable text file named
<span style="font-family:monospace">messages.properties</span> that appears in the same directory as the checker class.
The property file keys are the strings passed to <a href="../api/org/checkerframework/framework/source/SourceChecker.html#report-org.checkerframework.framework.source.Result-java.lang.Object-"><span style="font-family:monospace">report</span></a>
(like <span style="font-family:monospace">type.incompatible</span>) and the values are the strings to be
printed (<span style="font-family:monospace">"cannot assign ..."</span>).
The <span style="font-family:monospace">messages.properties</span> file only need to mention the new messages that
the checker defines.
It is also allowed to override messages defined in superclasses, but this
is rarely needed.
Section&#XA0;<a href="#compiler-message-keys">27.1.3</a> discusses best practices
when using a message key in a <span style="font-family:monospace">@SuppressWarnings</span> annotation.
</p>
<!--TOC subsection id="creating-indicating-supported-annotations" Indicating supported annotations-->
<h3 id="creating-indicating-supported-annotations" class="subsection">31.5.1&#XA0;&#XA0;Indicating supported annotations <a href="#creating-indicating-supported-annotations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>A checker must indicate the annotations that it supports (that make up its type
hierarchy), including whether it supports the polymorphic qualifier
<a href="../api/org/checkerframework/framework/qual/PolyAll.html"><span style="font-family:monospace">@PolyAll</span></a>.</p><p>By default, a checker supports <span style="font-family:monospace">PolyAll</span>, and all type annotations located in a
subdirectory called <span style="font-family:monospace">qual</span> that&#X2019;s located in the same directory as the checker.
A type annotation is meta-annotated with either
<span style="font-family:monospace">@Target(ElementType.TYPE_USE)</span>
or
<span style="font-family:monospace">@Target(</span><span style="font-family:monospace">ElementType.TYPE_USE, ElementType.TYPE_PARAMETER</span><span style="font-family:monospace">)</span>.</p><p>To indicate support for annotations that are located outside of the <span style="font-family:monospace">qual</span>
subdirectory, annotations that have other <span style="font-family:monospace">ElementType</span> values, or to indicate
whether a checker supports the polymorphic qualifier
<a href="../api/org/checkerframework/framework/qual/PolyAll.html"><span style="font-family:monospace">@PolyAll</span></a>, checker writers can override the
<a href="../api/org/checkerframework/framework/type/AnnotatedTypeFactory.html#createSupportedTypeQualifiers--"><span style="font-family:monospace">createSupportedTypeQualifiers</span></a>
method (see its Javadoc for details).</p><p>An aggregate checker (which extends
<a href="../api/org/checkerframework/framework/source/AggregateChecker.html"><span style="font-family:monospace">AggregateChecker</span></a>) does not need to specify its
type qualifiers, but each of its component checkers should do so.</p>
<!--TOC subsection id="creating-bundling-multiple-checkers" Bundling multiple checkers-->
<h3 id="creating-bundling-multiple-checkers" class="subsection">31.5.2&#XA0;&#XA0;Bundling multiple checkers <a href="#creating-bundling-multiple-checkers" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Sometimes, multiple checkers work together and should always be run
together. There are two different ways to bundle multiple checkers
together, by creating either an &#X201C;aggregate checker&#X201D; or a &#X201C;compound checker&#X201D;.</p><ol class="enumerate" type=1><li class="li-enumerate">
An aggregate checker runs multiple independent, unrelated checkers. There
is no communication or cooperation among them.<p>The effect is the same as if a user passes
multiple processors to the <span style="font-family:monospace">-processor</span> command-line option.</p><p>For example, instead of a user having to run</p><pre class="verbatim">  javac -processor DistanceUnitChecker,VelocityUnitChecker,MassUnitChecker MyFile.java
</pre><p>the user can write</p><pre class="verbatim">  javac -processor MyUnitCheckers MyFile.java
</pre><p>if you define an aggregate checker class. Extend <a href="../api/org/checkerframework/framework/source/AggregateChecker.html"><span style="font-family:monospace">AggregateChecker</span></a> and override
the <span style="font-family:monospace">getSupportedTypeCheckers</span> method, like the following:</p><pre class="verbatim">  public class MyUnitCheckers extends AggregateChecker {
    protected Collection&lt;Class&lt;? extends SourceChecker&gt;&gt; getSupportedCheckers() {
      return Arrays.asList(DistanceUnitChecker.class,
                           VelocityUnitChecker.class,
                           MassUnitChecker.class);
    }
  }
</pre><p>An example of an aggregate checker is <a href="../api/org/checkerframework/checker/i18n/I18nChecker.html"><span style="font-family:monospace">I18nChecker</span></a>
(see Chapter&#XA0;<a href="#i18n-checker">14.2</a>), which consists of
<a href="../api/org/checkerframework/checker/i18n/I18nSubchecker.html"><span style="font-family:monospace">I18nSubchecker</span></a> and
<a href="../api/org/checkerframework/checker/i18n/LocalizableKeyChecker.html"><span style="font-family:monospace">LocalizableKeyChecker</span></a>.</p></li><li class="li-enumerate">Use a compound checker to express dependencies among checkers. Suppose it
only makes sense to run MyChecker if MyHelperChecker has already been run;
that might be the case if MyHelperChecker computes some information that
MyChecker needs to use.<p>Override
<span style="font-family:monospace">MyChecker.</span><a href="../api/org/checkerframework/common/basetype/BaseTypeChecker.html#getImmediateSubcheckerClasses--"><span style="font-family:monospace">getImmediateSubcheckerClasses</span></a>
to return a list of the checkers that MyChecker depends on. Every one of
them will be run before MyChecker is run. One of MyChecker&#X2019;s subcheckers
may itself be a compound checker, and multiple checkers may declare a
dependence on the same subchecker. The Checker Framework will run each
checker once, and in an order consistent with all the dependences.</p><p>A checker obtains information from its subcheckers (those that ran before
it) by querying their <a href="../api/org/checkerframework/framework/type/AnnotatedTypeFactory.html"><span style="font-family:monospace">AnnotatedTypeFactory</span></a> to
determine the types of variables. Obtain the <span style="font-family:monospace">AnnotatedTypeFactory</span> by
calling
<a href="../api/org/checkerframework/common/basetype/BaseTypeChecker.html#getTypeFactoryOfSubchecker-java.lang.Class-"><span style="font-family:monospace">getTypeFactoryOfSubchecker</span></a>.</p></li></ol>
<!--TOC subsection id="creating-providing-command-line-options" Providing command-line options-->
<h3 id="creating-providing-command-line-options" class="subsection">31.5.3&#XA0;&#XA0;Providing command-line options <a href="#creating-providing-command-line-options" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>A checker can provide two kinds of command-line options:
boolean flags and
named string values (the standard annotation processor
options).</p>
<!--TOC subsubsection id="creating-providing-command-line-options-boolean-flags" Boolean flags-->
<h4 id="creating-providing-command-line-options-boolean-flags" class="subsubsection">Boolean flags <a href="#creating-providing-command-line-options-boolean-flags" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h4><!--SEC END --><p>To specify a simple boolean flag, add:</p><pre>
  <a href="../api/org/checkerframework/framework/source/SupportedLintOptions.html"><span style="font-family:monospace">@SupportedLintOptions</span></a>({"myflag"})
</pre><p>to your checker subclass.
The value of the flag can be queried using</p><pre class="verbatim">  checker.getLintOption("myflag", false)
</pre><p>The second argument sets the default value that should be returned.</p><p>To pass a flag on the command line, call javac as follows:</p><pre class="verbatim">  javac -processor MyChecker -Alint=myflag
</pre>
<!--TOC subsubsection id="creating-providing-command-line-options-named-string-values" Named string values-->
<h4 id="creating-providing-command-line-options-named-string-values" class="subsubsection">Named string values <a href="#creating-providing-command-line-options-named-string-values" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h4><!--SEC END --><p>For more complicated options, one can use the standard
<span style="font-family:monospace">@SupportedOptions</span> annotation on the checker, as in:</p><pre>
  <a href="../api/org/checkerframework/framework/source/SupportedOptions.html"><span style="font-family:monospace">@SupportedOptions</span></a>({"myoption"})
</pre><p>The value of the option can be queried using</p><pre class="verbatim">  checker.getOption("myoption")
</pre><p>To pass an option on the command line, call javac as follows:</p><pre class="verbatim">  javac -processor MyChecker -Amyoption=p1,p2
</pre><p>The value is returned as a single string and you have to perform the
required parsing of the option.</p>
<!--TOC section id="creating-extending-visitor" Visitor: Type rules-->
<h2 id="creating-extending-visitor" class="section">31.6&#XA0;&#XA0;Visitor: Type rules <a href="#creating-extending-visitor" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>A type system&#X2019;s rules define which operations on values of a
particular type are forbidden.
These rules must be defined procedurally, not declaratively.
Put them in a file <span style="font-family:monospace"><em>MyChecker</em></span><span style="font-family:monospace">Visitor.java</span> that extends
<a href="../api/org/checkerframework/common/basetype/BaseTypeVisitor.html"><span style="font-family:monospace">BaseTypeVisitor</span></a>.</p><p>BaseTypeVisitor performs type-checking at each node of a
source file&#X2019;s AST. It uses the visitor design pattern to traverse
Java syntax trees as provided by Oracle&#X2019;s
<a href="https://docs.oracle.com/javase/8/docs/jdk/api/javac/tree/">Tree
API</a>,
and it issues a warning (by calling
<a href="../api/org/checkerframework/framework/source/SourceChecker.html#report-org.checkerframework.framework.source.Result-java.lang.Object-"><span style="font-family:monospace">SourceChecker.report</span></a>)
whenever the type system is violated.</p><p>Most type-checkers
override only a few methods in <a href="../api/org/checkerframework/common/basetype/BaseTypeVisitor.html"><span style="font-family:monospace">BaseTypeVisitor</span></a>.
A checker&#X2019;s visitor overrides one method in the base visitor for each special
rule in the type qualifier system.
The last line of the overridden version is
&#X201C;<span style="font-family:monospace">return super.visit</span><span style="font-family:monospace"><em>TreeType</em></span><span style="font-family:monospace">(node, p);</span>&#X201D;.
If the method didn&#X2019;t raise any error,
the superclass implementation can perform standard checks.</p><p>By default, <a href="../api/org/checkerframework/common/basetype/BaseTypeVisitor.html"><span style="font-family:monospace">BaseTypeVisitor</span></a> performs subtyping checks that are
similar to Java subtype rules, but taking the type qualifiers into account.
<a href="../api/org/checkerframework/common/basetype/BaseTypeVisitor.html"><span style="font-family:monospace">BaseTypeVisitor</span></a> issues these errors:</p><ul class="itemize"><li class="li-itemize">invalid assignment (type.incompatible) for an assignment from
an expression type to an incompatible type. The assignment may be a
simple assignment, or pseudo-assignment like return expressions or
argument passing in a method invocation<p>In particular, in every assignment and pseudo-assignment, the
left-hand side of the assignment is a supertype of (or the same type
as) the right-hand side. For example, this assignment is not
permitted:</p><pre class="verbatim">    @Nullable Object myObject;
    @NonNull Object myNonNullObject;
    ...
    myNonNullObject = myObject;  // invalid assignment
  </pre></li><li class="li-itemize">invalid generic argument (type.argument.type.incompatible) when a type
is bound to an incompatible generic type variable</li><li class="li-itemize">invalid method invocation (method.invocation.invalid) when a
method is invoked on an object whose type is incompatible with the
method receiver type</li><li class="li-itemize">invalid overriding parameter type (override.parameter.invalid)
when a parameter in a method declaration is incompatible with that
parameter in the overridden method&#X2019;s declaration</li><li class="li-itemize">invalid overriding return type (override.return.invalid) when a
parameter in a method declaration is incompatible with that
parameter in the overridden method&#X2019;s declaration</li><li class="li-itemize">invalid overriding receiver type (override.receiver.invalid)
when a receiver in a method declaration is incompatible with that
receiver in the overridden method&#X2019;s declaration</li></ul>
<!--TOC subsection id="creating-ast-traversal" AST traversal-->
<h3 id="creating-ast-traversal" class="subsection">31.6.1&#XA0;&#XA0;AST traversal <a href="#creating-ast-traversal" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The Checker Framework needs to do its own traversal of the AST even though
it operates as an ordinary annotation processor&#XA0;[<a href="#JSR269">Dar06</a>]. Java
provides a visitor for Java code that is intended to be used by annotation
processors, but that visitor only
visits the public elements of Java code, such as classes, fields, methods,
and method arguments &#X2014; it does not visit code bodies or various other
locations. The Checker Framework hardly uses the built-in visitor &#X2014; as
soon as the built-in visitor starts to visit a class, then the Checker
Framework&#X2019;s visitor takes over and visits all of the class&#X2019;s source code.</p><p>Because there is no standard API for the AST of Java
code<sup><a id="text1" href="#note1">1</a></sup>, the Checker Framework uses
the javac implementation. This is why the Checker Framework is not deeply
integrated with Eclipse or IntelliJ IDEA, but runs as an external tool (see
Section&#XA0;<a href="#eclipse">32.5</a>).</p>
<!--TOC subsection id="creating-avoid-hardcoding" Avoid hardcoding-->
<h3 id="creating-avoid-hardcoding" class="subsection">31.6.2&#XA0;&#XA0;Avoid hardcoding <a href="#creating-avoid-hardcoding" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>If a method&#X2019;s contract is expressible in the type system&#X2019;s annotation
syntax, then you should write annotations, in a stub file or annotated JDK
(Chapter&#XA0;<a href="#annotating-libraries">30</a>).</p><p>Only if the contract is not expressible should you write a type-checking
rule for method invocation, where your rule checks the name of the method
being called and then treats the method in a special way.</p>
<!--TOC section id="creating-type-introduction" Type factory: Type introduction rules-->
<h2 id="creating-type-introduction" class="section">31.7&#XA0;&#XA0;Type factory: Type introduction rules <a href="#creating-type-introduction" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The annotated type of expressions and types are defined via type introduction rules in the
type factory. For most expressions and types, these rules are the same regardless of the type system.
For example, the type of a method invocation expression is the return type of the invoked method
viewpoint-adapted for the call site. The framework implements these rules so that all type systems
automatically use them. For other expressions, such as string literals, their (annotated) types depend
on the type system, so the framework provides way to specify what qualifiers should apply to these expressions.</p><p>Defaulting rules are type introduction rules for computing the annotated type for an unannotated type;
these rules are explained in Section&#XA0;<a href="#creating-typesystem-defaults">31.4.4</a>. The meta-annotation <a href="../api/org/checkerframework/framework/qual/QualifierForLiterals.html"><span style="font-family:monospace">@QualifierForLiterals</span></a> can be written on an annotation
declaration to specifiy that that annotation should be applied to the type of literals listed in the
meta-annotation.</p>
<!--TOC subsection id="creating-procedurally-specifying-implicit-annotations" Procedurally specifying type introduction rules-->
<h3 id="creating-procedurally-specifying-implicit-annotations" class="subsection">31.7.1&#XA0;&#XA0;Procedurally specifying type introduction rules <a href="#creating-procedurally-specifying-implicit-annotations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>If the meta-annotations are not sufficiently expressive, then you
can write your own type introduction rules. To do so, create a subclass of
<a href="../api/org/checkerframework/framework/type/AnnotatedTypeFactory.html"><span style="font-family:monospace">AnnotatedTypeFactory</span></a> and override its
two <span style="font-family:monospace">addComputedTypeAnnotations</span> methods.</p><p><span style="font-family:monospace">AnnotatedTypeFactory</span>, when given a program
expression, returns the expression&#X2019;s type. This should include not only
the qualifiers that the programmer explicitly wrote in the source code, but
also default annotations and type
refinement (see Section&#XA0;<a href="#effective-qualifier">26.4</a> for explanations of these
concepts).</p><p>To add type introduction rules, you should override
<a href="../api/org/checkerframework/framework/type/AnnotatedTypeFactory.html#addComputedTypeAnnotations-com.sun.source.tree.Tree-org.checkerframework.framework.type.AnnotatedTypeMirror-"><span style="font-family:monospace">addComputedTypeAnnotations(Tree,AnnotatedTypeMirror)</span></a>
(or
<a href="../api/org/checkerframework/framework/type/GenericAnnotatedTypeFactory.html#addComputedTypeAnnotations-com.sun.source.tree.Tree-org.checkerframework.framework.type.AnnotatedTypeMirror-boolean-"><span style="font-family:monospace">addComputedTypeAnnotations(Tree,AnnotatedTypeMirror,boolean)</span></a>
if extending <span style="font-family:monospace">GenericAnnotatedTypeFactory</span>)
and
<a href="../api/org/checkerframework/framework/type/AnnotatedTypeFactory.html#addComputedTypeAnnotations-javax.lang.model.element.Element-org.checkerframework.framework.type.AnnotatedTypeMirror-"><span style="font-family:monospace">addComputedTypeAnnotations(Element,AnnotatedTypeMirror)</span></a>.
The methods operate on <a href="../api/org/checkerframework/framework/type/AnnotatedTypeMirror.html"><span style="font-family:monospace">AnnotatedTypeMirror</span></a>,
which is the Checker Framework&#X2019;s representation of an annotated type.
The methods can make arbitrary changes to the annotations on a type.</p>
<!--TOC section id="creating-dataflow" Dataflow: enhancing flow-sensitive type refinement-->
<h2 id="creating-dataflow" class="section">31.8&#XA0;&#XA0;Dataflow: enhancing flow-sensitive type refinement <a href="#creating-dataflow" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>By default, every checker performs flow-sensitive type refinement, also known as
local type inference, as described
in Section&#XA0;<a href="#type-refinement">26.7</a>.</p><p>This section of the manual explains how to enhance the Checker Framework&#X2019;s
built-in type refinement.
Most commonly, you will inform the Checker Framework about a run-time test
that gives information about the type qualifiers in your type system.
Section&#XA0;<a href="#type-refinement-runtime-tests">26.7.4</a> gives examples of
type systems with and without run-time tests.</p><p>The steps to customizing type refinement are:
</p><ol class="enumerate" type=1><li class="li-enumerate">
&#XA7;<a href="#creating-dataflow-determine-expressions">31.8.1</a>
Determine which expressions will be refined.
</li><li class="li-enumerate">&#XA7;<a href="#creating-dataflow-create-classes">31.8.2</a>
Create required class and configure its use.
</li><li class="li-enumerate">&#XA7;<a href="#creating-dataflow-override-methods">31.8.3</a>
Override methods that handle <a href="../api/org/checkerframework/dataflow/cfg/node/Node.html"><span style="font-family:monospace">Node</span></a>s of interest.
</li><li class="li-enumerate">&#XA7;<a href="#creating-dataflow-implement-refinement">31.8.4</a>
Implement the refinement.
</li></ol><p>The Regex Checker&#X2019;s dataflow customization for the
<a href="../api/org/checkerframework/checker/regex/RegexUtil.html#asRegex-java.lang.String-"><span style="font-family:monospace">RegexUtil.asRegex</span></a>
run-time check is used as a running example.</p><p>If needed, you can find more details about the implementation of
type refinement, and the control flow graph (CFG) data
structure that it uses, in the
<a href="https://checkerframework.org/manual/checker-framework-dataflow-manual.pdf">Dataflow
Manual</a>.</p>
<!--TOC subsection id="creating-dataflow-determine-expressions" Determine expressions to refine the types of-->
<h3 id="creating-dataflow-determine-expressions" class="subsection">31.8.1&#XA0;&#XA0;Determine expressions to refine the types of <a href="#creating-dataflow-determine-expressions" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>A run-time check or run-time
operation involves multiple expressions (arguments, results).
Determine which expression the customization will refine. This is
usually specific to the type system and run-time test.
There is no code to write in this step; you are merely determining
the design of your type refinement.</p><p>For the program operation <span style="font-family:monospace">op(a,b)</span>, you can refine
the types in either or both of the following ways:
</p><ol class="enumerate" type=1><li class="li-enumerate">
Change the result type of the entire expression <span style="font-family:monospace">op(a,b)</span>.<p>As an example (and as the running example of implementing a dataflow
refinement), the <span style="font-family:monospace">RegexUtil.asRegex</span> method is declared as:</p><pre class="verbatim">  @Regex(0) String asRegex(String s, int groups) { ... }
</pre><p>This annotation is sound and conservative: it says that an expression such
as <span style="font-family:monospace">RegexUtil.asRegex(myString, myInt)</span> has type <span style="font-family:monospace">@Regex(0)
String</span>. However, this annotation is imprecise. When the <span style="font-family:monospace">group</span>
argument is known at compile time, a better estimate can be given. For
example, <span style="font-family:monospace">RegexUtil.asRegex(myString, 2)</span> has type <span style="font-family:monospace">@Regex(2)
String</span>.</p></li><li class="li-enumerate">Change the type of some other expression, such as <span style="font-family:monospace">a</span> or <span style="font-family:monospace">b</span>.<p>As an example, consider an equality test in the Nullness type system:</p><pre class="verbatim">  @Nullable String s;
    if (s != null) {
      ...
    } else {
      ...
    }
</pre><p>The type of <span style="font-family:monospace">s != null</span> is always <span style="font-family:monospace">boolean</span>. However, in the
true branch, the type of <span style="font-family:monospace">s</span> can be refined to <span style="font-family:monospace">@NonNull String</span>.</p></li></ol><p>If you are refining the types of arguments or the result of a method call,
then you may be able to implement your flow-sensitive refinement rules by
just writing <a href="../api/org/checkerframework/framework/qual/EnsuresQualifier.html"><span style="font-family:monospace">@EnsuresQualifier</span></a> and/or
<a href="../api/org/checkerframework/framework/qual/EnsuresQualifierIf.html"><span style="font-family:monospace">@EnsuresQualifierIf</span></a> annotations.
When this is possible, it is the best approach.</p><p>Sections&#XA0;<a href="#creating-dataflow-create-classes">31.8.2</a>&#X2013;<a href="#creating-dataflow-implement-refinement">31.8.4</a>
explain how to create a transfer class when the
<a href="../api/org/checkerframework/framework/qual/EnsuresQualifier.html"><span style="font-family:monospace">@EnsuresQualifier</span></a> and
<a href="../api/org/checkerframework/framework/qual/EnsuresQualifierIf.html"><span style="font-family:monospace">@EnsuresQualifierIf</span></a> annotations are insufficient.</p>
<!--TOC subsection id="creating-dataflow-create-classes" Create required class-->
<h3 id="creating-dataflow-create-classes" class="subsection">31.8.2&#XA0;&#XA0;Create required class <a href="#creating-dataflow-create-classes" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>In the same directory as <span style="font-family:monospace"><em>MyChecker</em></span><span style="font-family:monospace">Checker.java</span>, create a class
named <span style="font-family:monospace"><em>MyChecker</em></span><span style="font-family:monospace">Transfer</span> that extends
<a href="../api/org/checkerframework/framework/flow/CFTransfer.html"><span style="font-family:monospace">CFTransfer</span></a>.</p><p>Leave the class body empty for now. Your class will add functionality by
overriding methods of <span style="font-family:monospace">CFTransfer</span>, which performs the default Checker
Framework type refinement.</p><p>As an example, the Regex Checker&#X2019;s extended
<a href="../api/org/checkerframework/framework/flow/CFTransfer.html"><span style="font-family:monospace">CFTransfer</span></a> is
<a href="../api/org/checkerframework/checker/regex/RegexTransfer.html"><span style="font-family:monospace">RegexTransfer</span></a>.</p><p>(If you disregard the instructions above and choose a different name or a
different directory for your <span style="font-family:monospace"><em>MyChecker</em></span><span style="font-family:monospace">Transfer</span> class, you will
also need to override the <span style="font-family:monospace">createFlowTransferFunction</span> method in your type
factory to return to return a new instance of the class.)</p><p>(As a reminder, use of <a href="../api/org/checkerframework/framework/qual/EnsuresQualifier.html"><span style="font-family:monospace">@EnsuresQualifier</span></a> and
<a href="../api/org/checkerframework/framework/qual/EnsuresQualifierIf.html"><span style="font-family:monospace">@EnsuresQualifierIf</span></a> may obviate the need for
a transfer class.)</p>
<!--TOC subsection id="creating-dataflow-override-methods" Override methods that handle Nodes of interest-->
<h3 id="creating-dataflow-override-methods" class="subsection">31.8.3&#XA0;&#XA0;Override methods that handle Nodes of interest <a href="#creating-dataflow-override-methods" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Decide what source code syntax is relevant to the run-time checks or
run-time operations you are trying to support. The CFG (control flow
graph) represents source code as <a href="../api/org/checkerframework/dataflow/cfg/node/Node.html"><span style="font-family:monospace">Node</span></a>, a
node in the abstract syntax tree of the program being checked (see
<a href="#creating-dataflow-representation">&#X201C;Program representation&#X201D;</a> below).</p><p>In your extended <a href="../api/org/checkerframework/framework/flow/CFTransfer.html"><span style="font-family:monospace">CFTransfer</span></a>
override the visitor method that handles the <a href="../api/org/checkerframework/dataflow/cfg/node/Node.html"><span style="font-family:monospace">Node</span></a>s
relevant to your run-time check or run-time operation.
Leave the body of the overriding method empty for now.</p><p>For example, the Regex Checker refines the type of a run-time test method
call. A method call is represented by a
<a href="../api/org/checkerframework/dataflow/cfg/node/MethodInvocationNode.html"><span style="font-family:monospace">MethodInvocationNode</span></a>. Therefore,
<a href="../api/org/checkerframework/checker/regex/RegexTransfer.html"><span style="font-family:monospace">RegexTransfer</span></a> overrides the
<span style="font-family:monospace">visitMethodInvocation</span> method:</p><pre class="verbatim">  public TransferResult&lt;CFValue, CFStore&gt; visitMethodInvocation(
    MethodInvocationNode n, TransferInput&lt;CFValue, CFStore&gt; in)  { ... }
</pre>
<!--TOC subsubsection id="creating-dataflow-representation" Program representation-->
<h4 id="creating-dataflow-representation" class="subsubsection">Program representation <a href="#creating-dataflow-representation" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h4><!--SEC END --><p>The <a href="../api/org/checkerframework/dataflow/cfg/node/Node.html"><span style="font-family:monospace">Node</span></a> subclasses can be found in the
<span style="font-family:monospace">org.checkerframework.dataflow.cfg.node</span> package. Some examples are
<a href="../api/org/checkerframework/dataflow/cfg/node/EqualToNode.html"><span style="font-family:monospace">EqualToNode</span></a>,
<a href="../api/org/checkerframework/dataflow/cfg/node/LeftShiftNode.html"><span style="font-family:monospace">LeftShiftNode</span></a>,
<a href="../api/org/checkerframework/dataflow/cfg/node/VariableDeclarationNode.html"><span style="font-family:monospace">VariableDeclarationNode</span></a>.</p><p>A <a href="../api/org/checkerframework/dataflow/cfg/node/Node.html"><span style="font-family:monospace">Node</span></a>
is basically equivalent to a javac compiler <a href="https://docs.oracle.com/javase/8/docs/jdk/api/javac/tree/com/sun/source/tree/Tree.html?is-external=true"><span style="font-family:monospace">Tree</span></a>.</p><p>See Section&#XA0;<a href="#creating-javac-tips">31.13</a> for more information about <a href="https://docs.oracle.com/javase/8/docs/jdk/api/javac/tree/com/sun/source/tree/Tree.html?is-external=true"><span style="font-family:monospace">Tree</span></a>s.
As an example, the statement <span style="font-family:monospace">String a = "";</span> is represented as this
abstract syntax tree:
</p><pre class="verbatim">VariableTree:
  name: "a"
  type:
    IdentifierTree
      name: String
  initializer:
    LiteralTree
      value: ""
</pre>
<!--TOC subsection id="creating-dataflow-implement-refinement" Implement the refinement-->
<h3 id="creating-dataflow-implement-refinement" class="subsection">31.8.4&#XA0;&#XA0;Implement the refinement <a href="#creating-dataflow-implement-refinement" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>
Each visitor method in <a href="../api/org/checkerframework/framework/flow/CFAbstractTransfer.html"><span style="font-family:monospace">CFAbstractTransfer</span></a>
returns a <a href="../api/org/checkerframework/dataflow/analysis/TransferResult.html"><span style="font-family:monospace">TransferResult</span></a>. A
<a href="../api/org/checkerframework/dataflow/analysis/TransferResult.html"><span style="font-family:monospace">TransferResult</span></a> represents the
refined information that is known after an operation. It has two
components: the result type for the <a href="../api/org/checkerframework/dataflow/cfg/node/Node.html"><span style="font-family:monospace">Node</span></a>
being evaluated, and a map from expressions in scope to estimates of their
types (a <a href="../api/org/checkerframework/dataflow/analysis/Store.html"><span style="font-family:monospace">Store</span></a>). Each of these components is
relevant to one of the two cases in
Section&#XA0;<a href="#creating-dataflow-determine-expressions">31.8.1</a>:
</p><ol class="enumerate" type=1><li class="li-enumerate">

Changing the <a href="../api/org/checkerframework/dataflow/analysis/TransferResult.html"><span style="font-family:monospace">TransferResult</span></a>&#X2019;s result type changes
the type that is returned by the <a href="../api/org/checkerframework/framework/type/AnnotatedTypeFactory.html"><span style="font-family:monospace">AnnotatedTypeFactory</span></a>
for the tree corresponding to the <a href="../api/org/checkerframework/dataflow/cfg/node/Node.html"><span style="font-family:monospace">Node</span></a> that was
visited. (Remember that <a href="../api/org/checkerframework/common/basetype/BaseTypeVisitor.html"><span style="font-family:monospace">BaseTypeVisitor</span></a> uses the
<a href="../api/org/checkerframework/framework/type/AnnotatedTypeFactory.html"><span style="font-family:monospace">AnnotatedTypeFactory</span></a> to look up the type of a
<a href="https://docs.oracle.com/javase/8/docs/jdk/api/javac/tree/com/sun/source/tree/Tree.html?is-external=true"><span style="font-family:monospace">Tree</span></a>, and then performs checks on types of one or more
<a href="https://docs.oracle.com/javase/8/docs/jdk/api/javac/tree/com/sun/source/tree/Tree.html?is-external=true"><span style="font-family:monospace">Tree</span></a>s.)
<p>For example, When <a href="../api/org/checkerframework/checker/regex/RegexTransfer.html"><span style="font-family:monospace">RegexTransfer</span></a> evaluates a
<span style="font-family:monospace">RegexUtils.asRegex</span> invocation, it updates the
<a href="../api/org/checkerframework/dataflow/analysis/TransferResult.html"><span style="font-family:monospace">TransferResult</span></a>&#X2019;s result type. This changes the
type of the <span style="font-family:monospace">RegexUtils.asRegex</span> invocation when its
<a href="https://docs.oracle.com/javase/8/docs/jdk/api/javac/tree/com/sun/source/tree/Tree.html?is-external=true"><span style="font-family:monospace">Tree</span></a> is looked up by the
<a href="../api/org/checkerframework/framework/type/AnnotatedTypeFactory.html"><span style="font-family:monospace">AnnotatedTypeFactory</span></a>. See below for details.</p></li><li class="li-enumerate">Updating the <a href="../api/org/checkerframework/dataflow/analysis/Store.html"><span style="font-family:monospace">Store</span></a> treats an expression as
having a refined type for the remainder of the method or conditional block. For
example, when the Nullness Checker&#X2019;s dataflow evaluates <span style="font-family:monospace">myvar != null</span>, it
updates the <a href="../api/org/checkerframework/dataflow/analysis/Store.html"><span style="font-family:monospace">Store</span></a> to specify that the variable
<span style="font-family:monospace">myvar</span> should be treated as having type <span style="font-family:monospace">@NonNull</span> for the rest of the
then conditional block. Not all kinds of expressions can be refined; currently
method return values, local variables, fields, and array values can be stored in
the <a href="../api/org/checkerframework/dataflow/analysis/Store.html"><span style="font-family:monospace">Store</span></a>. Other kinds of expressions, like
binary expressions or casts, cannot be stored in the
<a href="../api/org/checkerframework/dataflow/analysis/Store.html"><span style="font-family:monospace">Store</span></a>.</li></ol><p>
The rest of this section details implementing the visitor method
<span style="font-family:monospace">RegexTransfer.visitMethodInvocation</span> for the <span style="font-family:monospace">RegexUtil.asRegex</span>
run-time test. You can find other examples of visitor methods in
<a href="../api/org/checkerframework/checker/lock/LockTransfer.html"><span style="font-family:monospace">LockTransfer</span></a> and
<a href="../api/org/checkerframework/checker/formatter/FormatterTransfer.html"><span style="font-family:monospace">FormatterTransfer</span></a>.
</p><ol class="enumerate" type=1><li class="li-enumerate">
<span style="font-weight:bold">Determine if the visited </span><a href="../api/org/checkerframework/dataflow/cfg/node/Node.html"><span style="font-weight:bold"><span style="font-family:monospace">Node</span></span></a><span style="font-weight:bold"> is of
interest</span><p>A visitor method is invoked for all
instances of a given <a href="../api/org/checkerframework/dataflow/cfg/node/Node.html"><span style="font-family:monospace">Node</span></a> kind in the
program.
The visitor must inspect the
<a href="../api/org/checkerframework/dataflow/cfg/node/Node.html"><span style="font-family:monospace">Node</span></a> to determine if it is an
instance of the desired run-time test or operation. For example,
<span style="font-family:monospace">visitMethodInvocation</span> is called when dataflow processes any method
invocation, but the <a href="../api/org/checkerframework/checker/regex/RegexTransfer.html"><span style="font-family:monospace">RegexTransfer</span></a> should only refine
the result of <span style="font-family:monospace">RegexUtils.asRegex</span> invocations:</p><pre class="verbatim">  @Override
  public TransferResult&lt;CFValue, CFStore&gt; visitMethodInvocation(...)
    ...
    MethodAccessNode target = n.getTarget();
    ExecutableElement method = target.getMethod();
    Node receiver = target.getReceiver();
    if (receiver instanceof ClassNameNode) {
      String receiverName = ((ClassNameNode) receiver).getElement().toString();

      // Is this a call to static method isRegex(s, groups) in a class named RegexUtil?
      if (receiverName.equals("RegexUtil")
          &amp;&amp; ElementUtils.matchesElement(method,
                 null, "isRegex", String.class, int.class)) {
            ...
</pre></li><li class="li-enumerate"><span style="font-weight:bold">Determine the refined type</span><p>Sometimes the refined type is dependent on the parts of the operation,
such as arguments passed to it.</p><p>For example, the refined type of <span style="font-family:monospace">RegexUtils.asRegex</span> is dependent on the
integer argument to the method call. The <a href="../api/org/checkerframework/checker/regex/RegexTransfer.html"><span style="font-family:monospace">RegexTransfer</span></a>
uses this argument to build the resulting type <span style="font-family:monospace">@Regex(</span><span style="font-family:monospace"><em>i</em></span><span style="font-family:monospace">)</span>, where <span style="font-family:monospace"><em>i</em></span>
is the value of the integer argument. For simplicity the below code only uses
the value of the integer argument if the argument was an integer literal. It
could be extended to use the value of the argument if it was any compile-time
constant or was inferred at compile time by another analysis, such as the
Constant Value Checker (Chapter&#XA0;<a href="#constant-value-checker">21</a>).</p><pre class="verbatim">  AnnotationMirror regexAnnotation;
  Node count = n.getArgument(1);
  if (count instanceof IntegerLiteralNode) {
    // argument is a literal integer
    IntegerLiteralNode iln = (IntegerLiteralNode) count;
    Integer groupCount = iln.getValue();
    regexAnnotation = factory.createRegexAnnotation(groupCount);
  } else {
    // argument is not a literal integer; fall back to @Regex(), which is the same as @Regex(0)
    regexAnnotation = AnnotationBuilder.fromClass(factory.getElementUtils(), Regex.class);
  }
</pre></li><li class="li-enumerate"><span style="font-weight:bold">Return a </span><a href="../api/org/checkerframework/dataflow/analysis/TransferResult.html"><span style="font-weight:bold"><span style="font-family:monospace">TransferResult</span></span></a><span style="font-weight:bold"> with the
refined types</span><p>Recall that the type of an expression is refined by modifying the
<a href="../api/org/checkerframework/dataflow/analysis/TransferResult.html"><span style="font-family:monospace">TransferResult</span></a> returned by a visitor method.
Since the <a href="../api/org/checkerframework/checker/regex/RegexTransfer.html"><span style="font-family:monospace">RegexTransfer</span></a> is updating the type of
the run-time test itself, it will update the result type and not the
<a href="../api/org/checkerframework/dataflow/analysis/Store.html"><span style="font-family:monospace">Store</span></a>.</p><p>A <a href="../api/org/checkerframework/framework/flow/CFValue.html"><span style="font-family:monospace">CFValue</span></a> is created to hold the type inferred.
<a href="../api/org/checkerframework/framework/flow/CFValue.html"><span style="font-family:monospace">CFValue</span></a> is a wrapper class for values being inferred
by dataflow:
</p><pre class="verbatim">  CFValue newResultValue = analysis.createSingleAnnotationValue(regexAnnotation,
      result.getResultValue().getType().getUnderlyingType());
</pre><p>Then, RegexTransfer&#X2019;s <span style="font-family:monospace">visitMethodInvocation</span> creates and returns a
<a href="../api/org/checkerframework/dataflow/analysis/TransferResult.html"><span style="font-family:monospace">TransferResult</span></a> using <span style="font-family:monospace">newResultValue</span> as the
result type.</p><pre class="verbatim">  return new RegularTransferResult&lt;&gt;(newResultValue, result.getRegularStore());
</pre><p>As a result of this code, when the Regex Checker encounters a
<span style="font-family:monospace">RegexUtils.asRegex</span> method call, the checker will refine the return
type of the method if it can determine the value of the integer parameter
at compile time.</p></li></ol>
<!--TOC subsection id="creating-dataflow-disable" Disabling flow-sensitive inference-->
<h3 id="creating-dataflow-disable" class="subsection">31.8.5&#XA0;&#XA0;Disabling flow-sensitive inference <a href="#creating-dataflow-disable" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>In the uncommon case that you wish to disable the Checker Framework&#X2019;s
built-in flow inference in your checker (this is different than choosing
not to extend it as described in Section&#XA0;<a href="#creating-dataflow">31.8</a>), put the
following two lines at the beginning of the constructor for your subtype of
<a href="../api/org/checkerframework/common/basetype/BaseAnnotatedTypeFactory.html"><span style="font-family:monospace">BaseAnnotatedTypeFactory</span></a>:</p><pre class="verbatim">        // disable flow inference
        super(checker, /*useFlow=*/ false);
</pre>
<!--TOC section id="creating-a-checker-annotated-jdk" Annotated JDK-->
<h2 id="creating-a-checker-annotated-jdk" class="section">31.9&#XA0;&#XA0;Annotated JDK <a href="#creating-a-checker-annotated-jdk" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>You will need to supply annotations for relevant parts of the JDK;
otherwise, your type-checker may produce spurious warnings for code that
uses the JDK. As described in Section&#XA0;<a href="#annotating-libraries">30</a>,
there are two general ways to supply an annotated library: in Java files
that will be compiled to <span style="font-family:monospace">.class</span> files, or as stub files (partial Java source files).</p><p>It&#X2019;s easier to start out with stub files. If you need to annotate many
classes (say, more than 20 or so), then you should create an annotated JDK.</p><p>To supply an annotated JDK that will be compiled, see Section&#XA0;<a href="#annotating-jdk">30.3</a>.</p><p>To supply an annotated JDK as a stub file, create a file <span style="font-family:monospace">jdk.astub</span> in
the checker&#X2019;s main source directory. It will be automatically used by the
checker.
You can also supply <span style="font-family:monospace">.astub</span> files in that directory for other libraries.
You should list those other libraries in a
<a href="../api/org/checkerframework/framework/qual/StubFiles.html"><span style="font-family:monospace">@StubFiles</span></a> annotation on the checker&#X2019;s main
class, so that they will also be automatically used.</p>
<!--TOC section id="creating-testing-framework" Testing framework-->
<h2 id="creating-testing-framework" class="section">31.10&#XA0;&#XA0;Testing framework <a href="#creating-testing-framework" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>
The Checker Framework provides a convenient way to write tests for your
checker.
It is extensively documented in file <span style="font-family:monospace">checker-framework/checker/tests/README</span>.
</p><p>If your checker&#X2019;s source code is within a fork of the Checker Framework
repository, then you can copy the testing infrastructure used by some
existing type system. Here are some of the tasks you will perform:</p><ul class="itemize"><li class="li-itemize">Make sure <span style="font-family:monospace">all-tests</span> tests the new checker.
</li></ul>
<!--TOC section id="creating-debugging-options" Debugging options-->
<h2 id="creating-debugging-options" class="section">31.11&#XA0;&#XA0;Debugging options <a href="#creating-debugging-options" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The Checker Framework provides debugging options that can be helpful when
implementing a checker. These are provided via the standard <span style="font-family:monospace">javac</span> &#X201C;<span style="font-family:monospace">-A</span>&#X201D;
switch, which is used to pass options to an annotation processor.</p>
<!--TOC subsection id="creating-debugging-options-detail" Amount of detail in messages-->
<h3 id="creating-debugging-options-detail" class="subsection">31.11.1&#XA0;&#XA0;Amount of detail in messages <a href="#creating-debugging-options-detail" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><ul class="itemize"><li class="li-itemize">
<span style="font-family:monospace">-AprintAllQualifiers</span>: print all type qualifiers, including
qualifiers meta-annotated with <span style="font-family:monospace">@InvisibleQualifier</span>, which are
usually not shown.</li><li class="li-itemize"><span style="font-family:monospace">-AprintVerboseGenerics</span>: print more information about type
parameters and wildcards when they appear in warning messages. Supplying
this also implies <span style="font-family:monospace">-AprintAllQualifiers</span>.</li><li class="li-itemize"><span style="font-family:monospace">-Adetailedmsgtext</span>: Output error/warning messages in a
stylized format that is easy for tools to parse. This is useful for
tools that run the Checker Framework and parse its output, such as IDE
plugins. See the source code of <span style="font-family:monospace">SourceChecker.java</span> for details about
the format.</li><li class="li-itemize"><span style="font-family:monospace">-Anomsgtext</span>: use message keys (such as &#X201C;<span style="font-family:monospace">type.invalid</span>&#X201D;)
rather than full message text when reporting errors or warnings. This is
used by the Checker Framework&#X2019;s own tests, so they do not need to be
changed if the English message is updated.</li><li class="li-itemize"><span style="font-family:monospace">-AnoPrintErrorStack</span>: don&#X2019;t print a stack trace when an
internal Checker Framework error occurs. Setting this option is rare. You
should only do it if you have discovered a bug in a checker, you have
already reported the bug, and you want to continue using the checker on a
large codebase without being inundated in stack traces.</li></ul>
<!--TOC subsection id="creating-debugging-options-libraries" Stub and JDK libraries-->
<h3 id="creating-debugging-options-libraries" class="subsection">31.11.2&#XA0;&#XA0;Stub and JDK libraries <a href="#creating-debugging-options-libraries" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><ul class="itemize"><li class="li-itemize"><span style="font-family:monospace">-Aignorejdkastub</span>:
ignore the <span style="font-family:monospace">jdk.astub</span> file in the checker directory. Files passed
through the <span style="font-family:monospace">-Astubs</span> option are still processed. This is useful
when experimenting with an alternative stub file.</li><li class="li-itemize"><span style="font-family:monospace">-Anocheckjdk</span>:
don&#X2019;t issue an error if no annotated JDK can be found.</li><li class="li-itemize"><span style="font-family:monospace">-AstubDebug</span>:
Print debugging messages while processing stub files.</li></ul>
<!--TOC subsection id="creating-debugging-options-progress" Progress tracing-->
<h3 id="creating-debugging-options-progress" class="subsection">31.11.3&#XA0;&#XA0;Progress tracing <a href="#creating-debugging-options-progress" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><ul class="itemize"><li class="li-itemize"><span style="font-family:monospace">-Afilenames</span>: print the name of each file before type-checking it.</li><li class="li-itemize"><span style="font-family:monospace">-Ashowchecks</span>: print debugging information for each
pseudo-assignment check (as performed by
<a href="../api/org/checkerframework/common/basetype/BaseTypeVisitor.html"><span style="font-family:monospace">BaseTypeVisitor</span></a>; see
Section&#XA0;<a href="#creating-extending-visitor">31.6</a>).</li><li class="li-itemize"><span style="font-family:monospace">-AshowInferenceSteps</span>: print debugging information
about intermediate steps in method type argument inference
(as performed by <a href="../api/org/checkerframework/framework/util/typeinference/DefaultTypeArgumentInference.html"><span style="font-family:monospace">DefaultTypeArgumentInference</span></a>).</li></ul>
<!--TOC subsection id="creating-debugging-options-output-args" Saving the command-line arguments to a file-->
<h3 id="creating-debugging-options-output-args" class="subsection">31.11.4&#XA0;&#XA0;Saving the command-line arguments to a file <a href="#creating-debugging-options-output-args" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><ul class="itemize"><li class="li-itemize"><span style="font-family:monospace">-AoutputArgsToFile</span>:
This saves the final command-line parameters as passed to the compiler in a file.
This file can be used as a script (if the file is marked as executable on Unix, or
if it includes a <span style="font-family:monospace">.bat</span> extension on Windows) to re-execute the same compilation command.
Note that this argument cannot be included in a file containing command-line arguments
passed to the compiler using the @argfile syntax.<p>Example usage: <span style="font-family:monospace">-AoutputArgsToFile=$HOME/scriptfile</span></p></li></ul>
<!--TOC subsection id="creating-debugging-dataflow-graph" Visualizing the dataflow graph-->
<h3 id="creating-debugging-dataflow-graph" class="subsection">31.11.5&#XA0;&#XA0;Visualizing the dataflow graph <a href="#creating-debugging-dataflow-graph" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>To understand control flow in your program and the resulting type
refinement, you can create a graphical representation of the CFG.</p><p>Typical use is:</p><pre class="verbatim">javac -processor myProcessor -Aflowdotdir=. MyClass.java
for dotfile in *.dot; do dot -Tpdf -o $dotfile.pdf $dotfile; done
</pre><p>where the first command creates file <span style="font-family:monospace">someDirectory/myClass.dot</span> that
represents the CFG, and the last command draws the CFG in a PDF file.
The <span style="font-family:monospace">dot</span> program is part of <a href="http://www.graphviz.org">Graphviz</a>.</p><ul class="itemize"><li class="li-itemize"><span style="font-family:monospace">-Aflowdotdir=</span><span style="font-family:monospace"><em>somedir</em></span>:
Specify directory for <span style="font-family:monospace">.dot</span> files visualizing the CFG.
Shorthand for<br>
 <span style="font-family:monospace">-Acfgviz=org.checkerframework.dataflow.cfg.DOTCFGVisualizer,outdir=</span><span style="font-family:monospace"><em>somedir</em></span>.
The directory must already exist.</li><li class="li-itemize"><span style="font-family:monospace">-Averbosecfg</span>:
Enable additional output in the CFG visualization.
Equivalent to passing <span style="font-family:monospace">verbose</span> to <span style="font-family:monospace">cfgviz</span>, e.g. as in
<span style="font-family:monospace">-Acfgviz=MyVisualizer,verbose</span></li><li class="li-itemize"><span style="font-family:monospace">-Acfgviz=</span><span style="font-family:monospace"><em>VizClassName</em></span><span style="font-family:monospace">[,</span><span style="font-family:monospace"><em>opts</em></span><span style="font-family:monospace">,...]</span>:
Mechanism to visualize the control flow graph (CFG) of
all the methods and code fragments
analyzed by the dataflow analysis (Section&#XA0;<a href="#creating-dataflow">31.8</a>).
The graph also contains information about flow-sensitively refined
types of various expressions at many program points.<p>The argument is a comma-separated sequence of values or key-value pairs.
The first argument is the fully-qualified name of the
<span style="font-family:monospace">org.checkerframework.dataflow.cfg.CFGVisualizer</span> implementation
that should be used. The remaining values or key-value pairs are
passed to <span style="font-family:monospace">CFGVisualizer.init</span>.</p></li></ul>
<!--TOC subsection id="creating-debugging-options-misc" Miscellaneous debugging options-->
<h3 id="creating-debugging-options-misc" class="subsection">31.11.6&#XA0;&#XA0;Miscellaneous debugging options <a href="#creating-debugging-options-misc" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><ul class="itemize"><li class="li-itemize"><span style="font-family:monospace">-AresourceStats</span>:
Whether to output resource statistics at JVM shutdown.</li></ul>
<!--TOC subsection id="creating-debugging-options-examples" Examples-->
<h3 id="creating-debugging-options-examples" class="subsection">31.11.7&#XA0;&#XA0;Examples <a href="#creating-debugging-options-examples" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The following example demonstrates how these options are used:</p><pre class="verbatim">$ javac -processor org.checkerframework.checker.interning.InterningChecker \
    docs/examples/InternedExampleWithWarnings.java -Ashowchecks -Anomsgtext -Afilenames

[InterningChecker] InterningExampleWithWarnings.java
 success (line  18): STRING_LITERAL "foo"
     actual: DECLARED @org.checkerframework.checker.interning.qual.Interned java.lang.String
   expected: DECLARED @org.checkerframework.checker.interning.qual.Interned java.lang.String
 success (line  19): NEW_CLASS new String("bar")
     actual: DECLARED java.lang.String
   expected: DECLARED java.lang.String
docs/examples/InterningExampleWithWarnings.java:21: (not.interned)
    if (foo == bar)
            ^
 success (line  22): STRING_LITERAL "foo == bar"
     actual: DECLARED @org.checkerframework.checker.interning.qual.Interned java.lang.String
   expected: DECLARED java.lang.String
1 error
</pre>
<!--TOC subsection id="creating-debugging-options-external" Using an external debugger-->
<h3 id="creating-debugging-options-external" class="subsection">31.11.8&#XA0;&#XA0;Using an external debugger <a href="#creating-debugging-options-external" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>You can use any standard debugger to observe the execution of your checker.</p><p>You can also set up remote (or local) debugging using the following command as a template:</p><pre class="verbatim">java -jar "$CHECKERFRAMEWORK/checker/dist/checker.jar" \
    -J-Xdebug -J-Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=5005 \
    -processor org.checkerframework.checker.nullness.NullnessChecker \
    src/sandbox/FileToCheck.java

</pre>
<!--TOC section id="creating-documenting-a-checker" Documenting the checker-->
<h2 id="creating-documenting-a-checker" class="section">31.12&#XA0;&#XA0;Documenting the checker <a href="#creating-documenting-a-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>This section describes how to write a chapter for this manual that
describes a new type-checker. This is a prerequisite to having your
type-checker distributed with the Checker Framework, which is the best way
for users to find it and for it to be kept up to date with Checker
Framework changes. Even if you do not want your checker distributed with
the Checker Framework, these guidelines may help you write better
documentation.</p><p>When writing a chapter about a new type-checker, see the existing chapters
for inspiration. (But recognize that the existing chapters aren&#X2019;t perfect:
maybe they can be improved too.)</p><p>A chapter in the Checker Framework manual should generally have the
following sections:</p><dl class="description"><dt class="dt-description">
<span style="font-weight:bold">Chapter: Belly Rub Checker</span></dt><dd class="dd-description">
The text before the first section in the chapter should state the
guarantee that the checker provides and why it is important. It should
give an overview of the concepts. It should state how to run the checker.
</dd><dt class="dt-description"><span style="font-weight:bold">Section: Belly Rub Annotations</span></dt><dd class="dd-description">
This section includes descriptions of the annotations with links to the
Javadoc. Separate type annotations from declaration annotations, and put
any type annotations that a programmer may not write (they are only used
internally by the implementation) last within variety of annotation.<p>Draw a diagram of the type hierarchy. A textual description of
the hierarchy is not sufficient; the diagram really helps readers to
understand the system.
The diagram will appear in directory <span style="font-family:monospace">docs/manual/figures/</span>;
see its <span style="font-family:monospace">README</span> file for tips.</p><p>The Javadoc for the annotations deserves the same care as the manual
chapter. Each annotation&#X2019;s Javadoc comment should use the
<span style="font-family:monospace">@checker_framework.manual</span> Javadoc taglet to refer to the chapter that
describes the checker; see <a href="../api/org/checkerframework/javacutil/dist/ManualTaglet.html"><span style="font-family:monospace">ManualTaglet</span></a>.
</p></dd><dt class="dt-description"><span style="font-weight:bold">Section: What the Belly Rub Checker checks</span></dt><dd class="dd-description">
This section gives more details about when an error is issued, with examples.
This section may be omitted if the checker does not contain special
type-checking rules &#X2014; that is, if the checker only enforces the usual
Java subtyping rules.
</dd><dt class="dt-description"><span style="font-weight:bold">Section: Examples</span></dt><dd class="dd-description">
Code examples.
</dd></dl><p>Sometimes you can omit some of the above sections. Sometimes there are
additional sections, such as tips on suppressing warnings, comparisons to
other tools, and run-time support.</p><p>You will create a new <span style="font-family:monospace">belly-rub-checker.tex</span> file,
then <code>\input</code> it at a logical place in <span style="font-family:monospace">manual.tex</span> (not
necessarily as the last checker-related chapter). Also add two references
to the checker&#X2019;s chapter: one at the beginning of
chapter&#XA0;<a href="#introduction">1</a>, and identical text in the appropriate part of
Section&#XA0;<a href="#type-refinement-runtime-tests">26.7.4</a> And add the file to <span style="font-family:monospace">docs/manual/Makefile</span>.
Keep the lists appear in
the same order as the manual chapters, to help us notice if anything is
missing.</p><p>For a chapter or (sub)*section, use <code>\sectionAndLabel{Section title}{section-label}</code>.
Section labels should start with the checker
name (as in <code>bellyrub-examples</code>) and not with &#X201C;<span style="font-family:monospace">sec:</span>&#X201D;.
Figure labels should start with &#X201C;fig-<em>checkername</em>&#X201D; and not with &#X201C;fig:&#X201D;.
These conventions are for the benefit of the Hevea program that produces
the HTML version of the manual.
Use <code>\begin{figure}</code> for all figures, including those whose
content is a table, in order to have a single consistent numbering for all
figures.</p><p>Don&#X2019;t forget to write Javadoc for any annotations that the checker uses.
That is part of the documentation and is the first thing that many users
may see. The documentation for any annotation should include an example
use of the annotation.
Also ensure that the Javadoc links back to the manual, using the
<span style="font-family:monospace">@checker_framework.manual</span> custom Javadoc tag.</p>
<!--TOC section id="creating-javac-tips" javac implementation survival guide-->
<h2 id="creating-javac-tips" class="section">31.13&#XA0;&#XA0;javac implementation survival guide <a href="#creating-javac-tips" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>Since this section of the manual was written, the useful &#X201C;The Hitchhiker&#X2019;s
Guide to javac&#X201D; has become available at
<a href="http://openjdk.java.net/groups/compiler/doc/hhgtjavac/index.html"><span style="font-family:monospace">http://openjdk.java.net/groups/compiler/doc/hhgtjavac/index.html</span></a>.
See it first, and then refer to this section. (This section of the manual
should be revised, or parts eliminated, in light of that document.)</p><p>A checker built using the Checker Framework makes use of a few interfaces
from the underlying compiler (Oracle&#X2019;s OpenJDK javac).
This section describes those interfaces.</p>
<!--TOC subsection id="creating-compiler-information" Checker access to compiler information-->
<h3 id="creating-compiler-information" class="subsection">31.13.1&#XA0;&#XA0;Checker access to compiler information <a href="#creating-compiler-information" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The compiler uses and exposes three hierarchies to model the Java
source code and classfiles.</p>
<!--TOC subsubsection id="creating-javac-types" Types &#X2014; Java Language Model API-->
<h4 id="creating-javac-types" class="subsubsection">Types &#X2014; Java Language Model API <a href="#creating-javac-types" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h4><!--SEC END --><p>A <a href="https://docs.oracle.com/javase/8/docs/api/javax/lang/model/type/TypeMirror.html?is-external=true"><span style="font-family:monospace">TypeMirror</span></a> represents a Java type.
</p><p>
There is a <span style="font-family:monospace">TypeMirror</span> interface to represent each type kind,
e.g., <span style="font-family:monospace">PrimitiveType</span> for primitive types, <span style="font-family:monospace">ExecutableType</span>
for method types, and <span style="font-family:monospace">NullType</span> for the type of the <span style="font-family:monospace">null</span> literal.
</p><p><span style="font-family:monospace">TypeMirror</span> does not represent annotated types though. A checker
should use the Checker Framework types API,
<a href="../api/org/checkerframework/framework/type/AnnotatedTypeMirror.html"><span style="font-family:monospace">AnnotatedTypeMirror</span></a>, instead. <span style="font-family:monospace">AnnotatedTypeMirror</span>
parallels the <span style="font-family:monospace">TypeMirror</span> API, but also presents the type annotations
associated with the type.</p><p>The Checker Framework and the checkers use the types API extensively.</p>
<!--TOC subsubsection id="creating-javac-elements" Elements &#X2014; Java Language Model API-->
<h4 id="creating-javac-elements" class="subsubsection">Elements &#X2014; Java Language Model API <a href="#creating-javac-elements" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h4><!--SEC END --><p>An <a href="https://docs.oracle.com/javase/8/docs/api/javax/lang/model/element/Element.html?is-external=true"><span style="font-family:monospace">Element</span></a> represents a potentially-public
declaration that can be accessed from elsewhere: classes, interfaces, methods, constructors, and
fields. <span style="font-family:monospace">Element</span> represents elements found in both source
code and bytecode.</p><p>There is an <span style="font-family:monospace">Element</span> interface to represent each construct, e.g.,
<span style="font-family:monospace">TypeElement</span> for class/interfaces, <span style="font-family:monospace">ExecutableElement</span> for
methods/constructors, and <span style="font-family:monospace">VariableElement</span> for local variables and
method parameters.</p><p>If you need to operate on the declaration level, always use elements rather
than trees
(see below). This allows the code to work on
both source and bytecode elements.</p><p>Example: retrieve declaration annotations, check variable
modifiers (e.g., <span style="font-family:monospace">strictfp</span>, <span style="font-family:monospace">synchronized</span>)</p>
<!--TOC subsubsection id="creating-javac-trees" Trees &#X2014; Compiler Tree API-->
<h4 id="creating-javac-trees" class="subsubsection">Trees &#X2014; Compiler Tree API <a href="#creating-javac-trees" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h4><!--SEC END --><p>A <a href="https://docs.oracle.com/javase/8/docs/jdk/api/javac/tree/com/sun/source/tree/Tree.html?is-external=true"><span style="font-family:monospace">Tree</span></a> represents a syntactic unit in the source code,
like a method declaration, statement, block, <span style="font-family:monospace">for</span> loop, etc. Trees only
represent source code to be compiled (or found in <span style="font-family:monospace">-sourcepath</span>);
no tree is available for classes read from bytecode.</p><p>There is a Tree interface for each Java source structure, e.g.,
<span style="font-family:monospace">ClassTree</span> for class declaration, <span style="font-family:monospace">MethodInvocationTree</span>
for a method invocation, and <span style="font-family:monospace">ForEachTree</span> for an enhanced-for-loop
statement.</p><p>You should limit your use of trees. A checker uses Trees mainly to
traverse the source code and retrieve the types/elements corresponding to
them. Then, the checker performs any needed checks on the types/elements instead.</p>
<!--TOC subsubsection id="creating-using-the-apis" Using the APIs-->
<h4 id="creating-using-the-apis" class="subsubsection">Using the APIs <a href="#creating-using-the-apis" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h4><!--SEC END --><p>The three APIs use some common idioms and conventions; knowing them will
help you to create your checker.</p><p><em>Type-checking</em>:
Do not use <span style="font-family:monospace">instanceof</span> to determine the class of the object,
because you cannot necessarily predict the run-time type of the object that
implements an interface. Instead, use the <span style="font-family:monospace">getKind()</span> method. The
method returns <a href="https://docs.oracle.com/javase/8/docs/api/javax/lang/model/type/TypeKind.html?is-external=true"><span style="font-family:monospace">TypeKind</span></a>,
<a href="https://docs.oracle.com/javase/8/docs/api/javax/lang/model/element/ElementKind.html?is-external=true"><span style="font-family:monospace">ElementKind</span></a>, and <a href="https://docs.oracle.com/javase/8/docs/jdk/api/javac/tree/com/sun/source/tree/Tree.Kind.html?is-external=true"><span style="font-family:monospace">Tree.Kind</span></a>
for the three interfaces, respectively.</p><p><em>Visitors and Scanners</em>:
The compiler and the Checker Framework use the visitor pattern
extensively. For example, visitors are used to traverse the source tree
(<a href="../api/org/checkerframework/common/basetype/BaseTypeVisitor.html"><span style="font-family:monospace">BaseTypeVisitor</span></a> extends
<a href="https://docs.oracle.com/javase/8/docs/jdk/api/javac/tree/com/sun/source/util/TreePathScanner.html?is-external=true"><span style="font-family:monospace">TreePathScanner</span></a>) and for type
checking (<a href="../api/org/checkerframework/framework/type/treeannotator/TreeAnnotator.html"><span style="font-family:monospace">TreeAnnotator</span></a> implements
<a href="https://docs.oracle.com/javase/8/docs/jdk/api/javac/tree/com/sun/source/tree/TreeVisitor.html?is-external=true"><span style="font-family:monospace">TreeVisitor</span></a>).</p><p><em>Utility classes</em>:
Some useful methods appear in a utility class. The OpenJDK convention is that
the utility class for a <span style="font-family:monospace">Foo</span> hierarchy is <span style="font-family:monospace">Foos</span> (e.g.,
<a href="https://docs.oracle.com/javase/8/docs/api/javax/lang/model/util/Types.html?is-external=true"><span style="font-family:monospace">Types</span></a>, <a href="https://docs.oracle.com/javase/8/docs/api/javax/lang/model/util/Elements.html?is-external=true"><span style="font-family:monospace">Elements</span></a>, and
<a href="https://docs.oracle.com/javase/8/docs/jdk/api/javac/tree/com/sun/source/util/Trees.html?is-external=true"><span style="font-family:monospace">Trees</span></a>). The Checker Framework uses a common
<span style="font-family:monospace">Utils</span> suffix to distinguish the class names (e.g., <a href="../api/org/checkerframework/javacutil/TypesUtils.html"><span style="font-family:monospace">TypesUtils</span></a>,
<a href="../api/org/checkerframework/javacutil/TreeUtils.html"><span style="font-family:monospace">TreeUtils</span></a>, <a href="../api/org/checkerframework/javacutil/ElementUtils.html"><span style="font-family:monospace">ElementUtils</span></a>), with one
notable exception: <a href="../api/org/checkerframework/framework/util/AnnotatedTypes.html"><span style="font-family:monospace">AnnotatedTypes</span></a>.</p>
<!--TOC subsubsection id="equality-for-annotations" Equality for annotations-->
<h4 id="equality-for-annotations" class="subsubsection">Equality for annotations <a href="#equality-for-annotations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h4><!--SEC END --><p><span style="font-family:monospace">AnnotationMirror</span> is an interface that is implemented both by javac and
the Checker Framework. Using <span style="font-family:monospace">equals</span> with one object created by the
Checker Framework and one by javac will always return false even if they
represent the same annotation. Therefore, never use any method that
compares <span style="font-family:monospace">AnnotationMirror</span>s using equals. <a href="../api/org/checkerframework/javacutil/AnnotationUtils.html"><span style="font-family:monospace">AnnotationUtils</span></a> has various
methods that should be used instead. Also,
<a href="../api/org/checkerframework/framework/util/AnnotationMirrorMap.html"><span style="font-family:monospace">AnnotationMirrorMap</span></a> and
<a href="../api/org/checkerframework/framework/util/AnnotationMirrorSet.html"><span style="font-family:monospace">AnnotationMirrorSet</span></a> can be used.</p>
<!--TOC subsection id="creating-checker-as-annotation-processor" How a checker fits in the compiler as an annotation processor-->
<h3 id="creating-checker-as-annotation-processor" class="subsection">31.13.2&#XA0;&#XA0;How a checker fits in the compiler as an annotation processor <a href="#creating-checker-as-annotation-processor" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The Checker Framework builds on the Annotation Processing API
introduced in Java 6. A type annotation processor is one that extends
<a href="../api/org/checkerframework/javacutil/AbstractTypeProcessor.html"><span style="font-family:monospace">AbstractTypeProcessor</span></a>; it gets run on each class
source file after the compiler confirms that the class is valid Java code.</p><p>The most important methods of <a href="../api/org/checkerframework/javacutil/AbstractTypeProcessor.html"><span style="font-family:monospace">AbstractTypeProcessor</span></a>
are <span style="font-family:monospace">typeProcess</span> and <span style="font-family:monospace">getSupportedSourceVersion</span>. The former
class is where you would insert any sort of method call to walk the AST,
and the latter just returns a constant indicating that we are targeting
version 8 of the compiler. Implementing these two methods should be enough
for a basic plugin; see the Javadoc for the class for other methods that
you may find useful later on.</p><p>The Checker Framework uses Oracle&#X2019;s Tree API to access a program&#X2019;s AST.
The Tree API is specific to the Oracle OpenJDK, so the Checker Framework only
works with the OpenJDK javac, not with Eclipse&#X2019;s compiler ecj.
This also limits the tightness of
the integration of the Checker Framework into other IDEs such as <a href="http://www.jetbrains.com/idea/">IntelliJ IDEA</a>.
An implementation-neutral API would be preferable.
In the future, the Checker Framework
can be migrated to use the Java Model AST of JSR 198 (Extension API for
Integrated Development Environments)&#XA0;[<a href="#JSR198">Cro06</a>], which gives access to
the source code of a method. But, at present no tools
implement JSR&#XA0;198. Also see Section&#XA0;<a href="#creating-ast-traversal">31.6.1</a>.</p>
<!--TOC subsubsection id="creating-learning-more-about-javac" Learning more about javac-->
<h4 id="creating-learning-more-about-javac" class="subsubsection">Learning more about javac <a href="#creating-learning-more-about-javac" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h4><!--SEC END --><p>Sun&#X2019;s javac compiler interfaces can be daunting to a
newcomer, and its documentation is a bit sparse. The Checker Framework
aims to abstract a lot of these complexities.
You do not have to understand the implementation of javac to
build powerful and useful checkers.
Beyond this document,
other useful resources include the Java Infrastructure
Developer&#X2019;s guide at
<a href="http://wiki.netbeans.org/Java_DevelopersGuide"><span style="font-family:monospace">http://wiki.netbeans.org/Java_DevelopersGuide</span></a> and the compiler
mailing list archives at
<a href="http://mail.openjdk.java.net/pipermail/compiler-dev/"><span style="font-family:monospace">http://mail.openjdk.java.net/pipermail/compiler-dev/</span></a>
(subscribe at
<a href="http://mail.openjdk.java.net/mailman/listinfo/compiler-dev"><span style="font-family:monospace">http://mail.openjdk.java.net/mailman/listinfo/compiler-dev</span></a>).</p>
<!--TOC section id="creating-integrating-a-checker" Integrating a checker with the Checker Framework-->
<h2 id="creating-integrating-a-checker" class="section">31.14&#XA0;&#XA0;Integrating a checker with the Checker Framework <a href="#creating-integrating-a-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>To integrate a new checker with the Checker Framework release, perform
the following:</p><ul class="itemize"><li class="li-itemize">Make sure <span style="font-family:monospace">check-compilermsgs</span> and <span style="font-family:monospace">check-purity</span> run
without warnings or errors.</li></ul><hr>
<!--BEGIN NOTES chapter-->
<hr class="footnoterule"><dl class="thefootnotes"><dt class="dt-thefootnotes">
<a id="note1" href="#text1">1</a></dt><dd class="dd-thefootnotes"><div class="footnotetext">Actually, there is a standard API for Java ASTs &#X2014; JSR 198
(Extension API for Integrated Development Environments)&#XA0;[<a href="#JSR198">Cro06</a>].
If tools were to implement it (which would just require writing wrappers
or adapters), then the Checker Framework and similar tools could be
portable among different compilers and IDEs.</div></dd></dl>
<!--END NOTES-->
<!--TOC chapter id="external-tools" Integration with external tools-->
<h1 id="external-tools" class="chapter">Chapter&#XA0;32&#XA0;&#XA0;Integration with external tools <a href="#external-tools" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h1><!--SEC END --><p>This chapter discusses how to run a checker from the command line, from a
build system, or from an IDE. You can skip to the appropriate section:</p><ul class="itemize"><li class="li-itemize">
Android (Section&#XA0;<a href="#android">32.1</a>)
</li><li class="li-itemize">Android Gradle Plugin (Section&#XA0;<a href="#android-gradle">32.2</a>)
</li><li class="li-itemize">Ant (Section&#XA0;<a href="#ant-task">32.3</a>)
</li><li class="li-itemize">Buck (Section&#XA0;<a href="#buck">32.4</a>)
</li><li class="li-itemize">Eclipse (Section&#XA0;<a href="#eclipse">32.5</a>)
</li><li class="li-itemize">Gradle (Section&#XA0;<a href="#gradle">32.6</a>)
</li><li class="li-itemize">IntelliJ IDEA (Section&#XA0;<a href="#intellij">32.7</a>)
</li><li class="li-itemize">javac or command line (Section&#XA0;<a href="#javac-installation">32.8</a>)
</li><li class="li-itemize">Lombok (Section&#XA0;<a href="#lombok">32.9</a>)
</li><li class="li-itemize">Maven (Section&#XA0;<a href="#maven">32.10</a>)
</li><li class="li-itemize">NetBeans (Section&#XA0;<a href="#netbeans">32.11</a>)
</li><li class="li-itemize">tIDE (Section&#XA0;<a href="#tide">32.12</a>)
</li></ul><p>If your build system or IDE is not listed above, you should customize how
it runs the javac command on your behalf. See your build system or IDE
documentation to learn how to
customize it, adapting the instructions for javac in Section&#XA0;<a href="#javac-installation">32.8</a>.
If you make another tool support running a checker, please
inform us via the
<a href="https://groups.google.com/forum/#!forum/checker-framework-discuss">mailing
list</a> or
<a href="https://github.com/typetools/checker-framework/issues">issue tracker</a> so
we can add it to this manual.</p><p>All examples in this chapter are in the public domain, with no copyright nor
licensing restrictions.</p>
<!--TOC section id="android" Android-->
<h2 id="android" class="section">32.1&#XA0;&#XA0;Android <a href="#android" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>When creating an Android app, you may wish to use <span style="font-family:monospace">checker-qual-android</span>
whenever this document mentions <span style="font-family:monospace">checker-qual</span>. This can lead to smaller
dex files (smaller distributed apps).</p><p>The <span style="font-family:monospace">checker-qual-android</span> artifact is identical to the <span style="font-family:monospace">checker-qual</span>
artifact, except that in <span style="font-family:monospace">checker-qual-android</span> annotations have classfile
retention. The default Android Gradle plugin retains types annotated with
runtime annotations in the main dex, but strips out class-retention
annotations.</p>
<!--TOC section id="android-gradle" Android Studio 3.0 and the Android Gradle Plugin 3.0-->
<h2 id="android-gradle" class="section">32.2&#XA0;&#XA0;Android Studio 3.0 and the Android Gradle Plugin 3.0 <a href="#android-gradle" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>Android Studio 3.0 and Android Gradle Plugin 3.0.0 support type
annotations. (See
<a href="https://developer.android.com/studio/write/java8-support"><span style="font-family:monospace">https://developer.android.com/studio/write/java8-support</span></a>
for more details.) This section explains how to configure your Android
project to use the Checker Framework. All the changes should be made to
the module&#X2019;s <span style="font-family:monospace">build.gradle</span> file &#X2014; not the app&#X2019;s <span style="font-family:monospace">build.gradle</span> file.</p><ol class="enumerate" type=1><li class="li-enumerate">In your module&#X2019;s <span style="font-family:monospace">build.gradle</span> file, set the source and target
compatibility to <span style="font-family:monospace">JavaVersion.VERSION_1_8</span><pre class="verbatim">android {
    ...
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_1_8
        targetCompatibility JavaVersion.VERSION_1_8
    }
}
</pre></li><li class="li-enumerate">Add a build variant for running checkers.<pre class="verbatim"> android {
    ...
      buildTypes {
      ...
        checkTypes {
            javaCompileOptions.annotationProcessorOptions.
                    classNames.add("org.checkerframework.checker.nullness.NullnessChecker")
            // You can pass options like so:
            // javaCompileOptions.annotationProcessorOptions.arguments.put("warns", "")
        }
    }
}
</pre></li><li class="li-enumerate">Add a dependency configuration for the annotated JDK:<div style="font-size:small;">
<pre class="verbatim">configurations {
    checkerFrameworkAnnotatedJDK {
        description = 'a copy of JDK classes with Checker Framework type qualifiers inserted'
    }
}

</pre></div></li><li class="li-enumerate">Declare the Checker Framework dependencies:<div style="font-size:small;">
<pre class="verbatim">dependencies {
    ... existing dependencies...
    ext.checkerFrameworkVersion = '2.11.0'
    implementation "org.checkerframework:checker-qual-android:${checkerFrameworkVersion}"
    annotationProcessor "org.checkerframework:checker:${checkerFrameworkVersion}"
    checkerFrameworkAnnotatedJDK "org.checkerframework:jdk8:${checkerFrameworkVersion}"
}
</pre></div></li><li class="li-enumerate">Direct all tasks of type <span style="font-family:monospace">JavaCompile</span> used by the CheckTypes build variant to use the annotated JDK.
<div style="font-size:small;">
<pre class="verbatim">gradle.projectsEvaluated {
    tasks.withType(JavaCompile).all { compile -&gt;
        if (compile.name.contains("CheckTypes")) {
            compile.options.compilerArgs += [
                    "-Xbootclasspath/p:${configurations.checkerFrameworkAnnotatedJDK.asPath}"
            ]
        }
    }
}
</pre></div></li><li class="li-enumerate">To run the checkers, build using the checkTypes variant.
<pre class="verbatim">gradlew checkTypes
</pre></li></ol>
<!--TOC section id="ant-task" Ant task-->
<h2 id="ant-task" class="section">32.3&#XA0;&#XA0;Ant task <a href="#ant-task" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>If you use the <a href="http://ant.apache.org/">Ant</a> build tool to compile
your software, then you can add an Ant task that runs a checker. We assume
that your Ant file already contains a compilation target that uses the
<span style="font-family:monospace">javac</span> task.</p><ol class="enumerate" type=1><li class="li-enumerate">
Set the <span style="font-family:monospace">jsr308javac</span> property:<pre class="verbatim">  &lt;property environment="env"/&gt;

  &lt;property name="checkerframework" value="${env.CHECKERFRAMEWORK}" /&gt;

  &lt;!-- On Mac/Linux, use the javac shell script; on Windows, use javac.bat --&gt;
  &lt;condition property="cfJavac" value="javac.bat" else="javac"&gt;
      &lt;os family="windows" /&gt;
  &lt;/condition&gt;

  &lt;presetdef name="jsr308.javac"&gt;
    &lt;javac fork="yes" executable="${checkerframework}/checker/bin/${cfJavac}" &gt;
      &lt;compilerarg value="-version"/&gt;
      &lt;compilerarg value="-implicit:class"/&gt;
    &lt;/javac&gt;
  &lt;/presetdef&gt;
</pre></li><li class="li-enumerate"><span style="font-weight:bold">Duplicate</span> the compilation target, then <span style="font-weight:bold">modify</span> it slightly as
indicated in this example:<pre class="verbatim">  &lt;target name="check-nullness"
          description="Check for null pointer dereferences"
          depends="clean,..."&gt;
    &lt;!-- use jsr308.javac instead of javac --&gt;
    &lt;jsr308.javac ... &gt;
      &lt;compilerarg line="-processor org.checkerframework.checker.nullness.NullnessChecker"/&gt;
      &lt;!-- optional, to not check uses of library methods:
        &lt;compilerarg value="-AskipUses=^(java\.awt\.|javax\.swing\.)"/&gt;
      --&gt;
      &lt;compilerarg line="-Xmaxerrs 10000"/&gt;
      ...
    &lt;/jsr308.javac&gt;
  &lt;/target&gt;
</pre><p>Fill in each ellipsis (&#X2026;) from the original compilation target.</p><p>In the example, the target is named <span style="font-family:monospace">check-nullness</span>, but you can
name it whatever you like.
</p></li></ol>
<!--TOC subsection id="ant-task-explanation" Explanation-->
<h3 id="ant-task-explanation" class="subsection">32.3.1&#XA0;&#XA0;Explanation <a href="#ant-task-explanation" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>This section explains each part of the Ant task.</p><ol class="enumerate" type=1><li class="li-enumerate">
Definition of <span style="font-family:monospace">jsr308.javac</span>:<p>The <span style="font-family:monospace">fork</span> field of the <span style="font-family:monospace">javac</span> task
ensures that an external javac program is called. Otherwise, Ant will run
javac via a Java method call, and there is no guarantee that it will get
the Checker Framework compiler that is distributed with the Checker Framework.</p><p>The <span style="font-family:monospace">-version</span> compiler argument is just for debugging; you may omit
it.</p><p>The <span style="font-family:monospace">-implicit:class</span> compiler argument causes annotation processing
to be performed on implicitly compiled files. (An implicitly compiled file
is one that was not specified on the command line, but for which the source
code is newer than the <span style="font-family:monospace">.class</span> file.) This is the default, but
supplying the argument explicitly suppresses a compiler warning.</p></li><li class="li-enumerate">The <span style="font-family:monospace">check-nullness</span> target:<p>The target assumes the existence of a <span style="font-family:monospace">clean</span> target that removes all
<span style="font-family:monospace">.class</span> files. That is necessary because Ant&#X2019;s <span style="font-family:monospace">javac</span> target
doesn&#X2019;t re-compile <span style="font-family:monospace">.java</span> files for which a <span style="font-family:monospace">.class</span> file
already exists.</p><p>The <span style="font-family:monospace">-processor ...</span> compiler argument indicates which checker to
run. You can supply additional arguments to the checker as well.</p></li></ol>
<!--TOC section id="buck" Buck-->
<h2 id="buck" class="section">32.4&#XA0;&#XA0;Buck <a href="#buck" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>Buck is a build system maintained by Facebook.</p><p>Buck has support for annotation processors, but that support is
undocumented because the Buck maintainers may change the syntax in the
future and they don&#X2019;t wish to ever change anything that is documented.</p><p>You can learn more about Buck and annotation processors at these URLs:
<a href="https://stackoverflow.com/questions/32915721/documentation-for-annotation-processors-buck"><span style="font-family:monospace">https://stackoverflow.com/questions/32915721/documentation-for-annotation-processors-buck</span></a>,
<a href="https://github.com/facebook/buck/issues/85"><span style="font-family:monospace">https://github.com/facebook/buck/issues/85</span></a>.</p><p>Here is an example Buck <span style="font-family:monospace">BUILD</span> file:</p><pre class="verbatim">prebuilt_jar(
    name = 'checker-framework',
    binary_jar = 'checker-2.11.0.jar',
    visibility = [ 'PUBLIC' ]
)

prebuilt_jar(
    name = 'checker-qual',
    binary_jar = 'checker-qual-2.11.0.jar',
    visibility = [ 'PUBLIC' ]
)

java_library (
 name = 'hello',
 srcs = glob(['src/main/java/**/*.java']),
 java_version = '1.8',
 provided_deps = [ ':checker-framework', ':checker-qual' ],
# To add annotation processing
 annotation_processors = [ 'org.checkerframework.checker.units.UnitsChecker' ],
 annotation_processor_deps = [ ':checker-framework', ':checker-qual' ],
 annotation_processor_params = [ 'nocheckjdk' ]
)
</pre>
<!--TOC section id="eclipse" Eclipse-->
<h2 id="eclipse" class="section">32.5&#XA0;&#XA0;Eclipse <a href="#eclipse" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>You
need to run the Checker Framework via Ant or via another build tool, rather
than by supplying the <span style="font-family:monospace">-processor</span> command-line option to the ejc
compiler, which is also known as eclipsec.
The reason is that the Checker Framework is built upon javac,
and ejc represents the Java program differently. (If both javac and ejc
implemented JSR 198&#XA0;[<a href="#JSR198">Cro06</a>], then it would be possible to build
a type-checking plug-in that works with both compilers.)</p><p>There is no dedicated Eclipse plug-in for running the Checker Framework,
but it&#X2019;s still easy to run the Checker Framework. First, create a
target/task in your build system to run the Checker Framework. Then, run
the target/task from Eclipse. Section&#XA0;<a href="#eclipse-ant">32.5.1</a> gives details for
Ant, but other build systems are similar.</p>
<!--TOC subsection id="eclipse-ant" Using an Ant task-->
<h3 id="eclipse-ant" class="subsection">32.5.1&#XA0;&#XA0;Using an Ant task <a href="#eclipse-ant" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Add an Ant target as described in Section&#XA0;<a href="#ant-task">32.3</a>. You can
run the Ant target by executing the following steps
(instructions copied from <a href="http://help.eclipse.org/luna/index.jsp?topic=%2Forg.eclipse.platform.doc.user%2FgettingStarted%2Fqs-84_run_ant.htm"><span style="font-family:monospace">http://help.eclipse.org/luna/index.jsp?topic=%2Forg.eclipse.platform.doc.user%2FgettingStarted%2Fqs-84_run_ant.htm</span></a>):</p><ol class="enumerate" type=1><li class="li-enumerate">Select <span style="font-family:monospace">build.xml</span> in one of the navigation views and choose
<span style="font-weight:bold">Run As </span>&gt;<span style="font-weight:bold"> Ant Build...</span> from its context menu.</li><li class="li-enumerate">A launch configuration dialog is opened on a launch configuration
for this Ant buildfile.</li><li class="li-enumerate">In the <span style="font-weight:bold">Targets</span> tab, select the new ant task (e.g., check-interning).</li><li class="li-enumerate">Click <span style="font-weight:bold">Run</span>.</li><li class="li-enumerate">The Ant buildfile is run, and the output is sent to the Console view.</li></ol>
<!--TOC subsection id="eclipse-troubleshooting" Troubleshooting Eclipse-->
<h3 id="eclipse-troubleshooting" class="subsection">32.5.2&#XA0;&#XA0;Troubleshooting Eclipse <a href="#eclipse-troubleshooting" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Eclipse issues an &#X201C;Unhandled Token in @SuppressWarnings&#X201D; warning if you
write a <span style="font-family:monospace">@SuppressWarnings</span> annotation containing a string that does not
know about. Unfortunately, Eclipse
<a href="https://bugs.eclipse.org/bugs/show_bug.cgi?id=122475">hard-codes</a>
this list.</p><p>To eliminate the warnings:
disable all &#X201C;Unhandled Token in @SuppressWarnings&#X201D; warnings in Eclipse.
Look under the menu headings Java &#X2192; Compiler &#X2192; Errors/Warnings &#X2192; Annotations &#X2192; Unhandled Token in &#X2019;@SuppressWarnings&#X2019;, and set it to ignore.</p>
<!--TOC section id="gradle" Gradle-->
<h2 id="gradle" class="section">32.6&#XA0;&#XA0;Gradle <a href="#gradle" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>To run a checker
on a project that uses the <a href="https://gradle.org/">Gradle</a> build system,
use the
<a href="https://github.com/kelloggm/checkerframework-gradle-plugin">Checker
Framework Gradle plugin</a>. Its documentation explains how to use it.</p>
<!--TOC section id="intellij" IntelliJ IDEA-->
<h2 id="intellij" class="section">32.7&#XA0;&#XA0;IntelliJ IDEA <a href="#intellij" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>This section tells you how to make IntelliJ IDEA automatically run a
checker on every compile for Java projects and/or modules.</p><p>If your project uses a build tool such as Gradle, these instructions will
not work. Follow the instructions for that build tool instead (they are in
a different section of this chapter). To compile your project, run the
build tool (possibly from within Gradle, possibly not).</p><p>To run a checker within IntelliJ IDEA on every compile:</p><ol class="enumerate" type=1><li class="li-enumerate">Change the project SDK to 1.8, as explained at
<a href="https://www.jetbrains.com/help/idea/sdk.html#change-project-sdk"><span style="font-family:monospace">https://www.jetbrains.com/help/idea/sdk.html#change-project-sdk</span></a>.</li><li class="li-enumerate">Change the language level for your project to 8, as explained at
<a href="https://www.jetbrains.com/help/idea/project-page.html"><span style="font-family:monospace">https://www.jetbrains.com/help/idea/project-page.html</span></a>.</li><li class="li-enumerate">Add the annotated JDK library to the bootclasspath.
On the Java compiler settings page, see <a href="https://www.jetbrains.com/help/idea/java-compiler.html"><span style="font-family:monospace">https://www.jetbrains.com/help/idea/java-compiler.html</span></a>,
in the &#X201C;Additional command line parameters&#X201D;: section, add:<br>
 <span style="font-family:monospace">-Xbootclasspath/p:"&lt;path to checker framework&gt;/checker/dist/jdk8.jar"</span></li><li class="li-enumerate">Configure an annotation profile.
<ol class="enumerate" type=a><li class="li-enumerate">
Create an
<a href="https://www.jetbrains.com/help/idea/configuring-annotation-processing.html#create_profile">annotation profile</a>.
</li><li class="li-enumerate"><a href="https://www.jetbrains.com/help/idea/configuring-annotation-processing.html#associate">Associate</a>
any desired modules with that profile.
</li><li class="li-enumerate">Configure that profile:
<ol class="enumerate" type=i><li class="li-enumerate">
Add checker.jar to the processor path. (It&#X2019;s located in
<span style="font-family:monospace">checker-framework/checker/dist/</span>.)
</li><li class="li-enumerate">Add checkers to be run during compilation by writing the
fully-qualified name of the checker in the &#X201C;Processor FQ Name&#X201D;
section.
</li></ol>
</li></ol></li><li class="li-enumerate">Add <span style="font-family:monospace">checker-qual.jar</span>, located in
<span style="font-family:monospace">checker-framework/checker/dist/checker-qual.jar</span>, as a dependency to all
modules you wish to type check. (They should all have been associated with
the annotation profile above.)
Instructions appear at
<a href="https://www.jetbrains.com/help/idea/creating-and-managing-projects.html"><span style="font-family:monospace">https://www.jetbrains.com/help/idea/creating-and-managing-projects.html</span></a>.</li></ol><p>Now, when you compile your code, the checker will be run.</p><p>It is necessary to manually inform the IDE via a plugin if an annotation
system adds any dependencies beyond those that normally exist in Java.
For information about the extension points, see
<a href="https://youtrack.jetbrains.com/issue/IDEA-159286"><span style="font-family:monospace">https://youtrack.jetbrains.com/issue/IDEA-159286</span></a>.</p>
<!--TOC section id="javac-installation" Javac compiler (command line)-->
<h2 id="javac-installation" class="section">32.8&#XA0;&#XA0;Javac compiler (command line) <a href="#javac-installation" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>To perform pluggable type-checking, run the <span style="font-family:monospace">javac</span> compiler with the
Checker Framework on the classpath.
There are three ways to achieve this. You can use any
one of them. However, if you are using the Windows command shell, you must
use the last one.
</p><ul class="itemize"><li class="li-itemize">
Option 1:
Add directory
<span style="font-family:monospace">.../checker-framework-2.11.0/checker/bin</span> to your path, <em>before</em> any other
directory that contains a <span style="font-family:monospace">javac</span> executable.<p>If you are
using the bash shell, a way to do this is to add the following to your
<code>~/.profile</code> (or alternately <code>~/.bash_profile</code> or <code>~/.bashrc</code>) file:
</p><pre class="verbatim">  export CHECKERFRAMEWORK=${HOME}/checker-framework-2.11.0
  export PATH=${CHECKERFRAMEWORK}/checker/bin:${PATH}
</pre><p>then log out and back in to ensure that the environment variable
setting takes effect.</p><p>Now, whenever you run <span style="font-family:monospace">javac</span>, you will use the &#X201C;Checker
Framework compiler&#X201D;. It is exactly the same as the OpenJDK compiler,
with one small differences: it includes the Checker Framework jar file
on its classpath.</p></li><li class="li-itemize">
Option 2:
Whenever this document tells you to run <span style="font-family:monospace">javac</span>, you
can instead run <span style="font-family:monospace">$CHECKERFRAMEWORK/checker/bin/javac</span>.
<p>You can simplify this by introducing an alias. Then,
whenever this document tells you to run <span style="font-family:monospace">javac</span>, instead use that
alias. Here is the syntax for your
<code>~/.bashrc</code> file:
</p><pre class="verbatim">  export CHECKERFRAMEWORK=${HOME}/checker-framework-2.11.0
  alias javacheck='$CHECKERFRAMEWORK/checker/bin/javac'
</pre></li><li class="li-itemize">Option 3:
Whenever this document tells you to run <span style="font-family:monospace">javac</span>, instead
run checker.jar via <span style="font-family:monospace">java</span> (not <span style="font-family:monospace">javac</span>) as in:<pre class="verbatim">  java -jar "$CHECKERFRAMEWORK/checker/dist/checker.jar" -cp "myclasspath" -processor nullness MyFile.java
</pre><p>You can simplify the above command by introducing an alias. Then,
whenever this document tells you to run <span style="font-family:monospace">javac</span>, instead use that
alias. For example:</p><pre class="verbatim">  # Unix
  export CHECKERFRAMEWORK=${HOME}/checker-framework-2.11.0
  alias javacheck='java -jar "$CHECKERFRAMEWORK/checker/dist/checker.jar"'

  # Windows
  set CHECKERFRAMEWORK = C:\Program Files\checker-framework-2.11.0\
  doskey javacheck=java -jar "%CHECKERFRAMEWORK%\checker\dist\checker.jar" $*
</pre><p>(Explanation for advanced users: More generally, anywhere that you would use <span style="font-family:monospace">javac.jar</span>, you can substitute
<span style="font-family:monospace">$CHECKERFRAMEWORK/checker/dist/checker.jar</span>;
the result is to use the Checker
Framework compiler instead of the regular <span style="font-family:monospace">javac</span>.)</p></li></ul>
<!--TOC section id="lombok" Lombok-->
<h2 id="lombok" class="section">32.9&#XA0;&#XA0;Lombok <a href="#lombok" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>Project Lombok (<a href="https://projectlombok.org/"><span style="font-family:monospace">https://projectlombok.org/</span></a>) is a library that
generates getter, setter, and builder methods &#X2014; among other features.
For example, if you declare
a field:</p><pre class="verbatim">  @Getter @Setter
  private @Regex String role;
</pre><p>then Lombok will generate getter and setter methods:</p><pre class="verbatim">  public String getRole() { return role; }
  public void setRole(String role) { this.role = role; }
</pre><p>Unfortunately, the generated code is lacking <span style="font-family:monospace">@Regex</span> annotations on
the return type of <span style="font-family:monospace">getRole</span> and the argument type of <span style="font-family:monospace">setRole</span>.
You need to tell Lombok to copy type annotations from the field, so that
clients that use the generated methods will type-check properly.</p><p>In your <span style="font-family:monospace">lombok.config</span> file, add to the <span style="font-family:monospace">lombok.copyableAnnotations</span>
configuration key any type annotations that might interact with a
Lombok feature (e.g., a type use annotation on a field annotated with
<span style="font-family:monospace">@Getter</span> or <span style="font-family:monospace">@Setter</span>). For example:</p><pre class="verbatim">  lombok.copyableAnnotations += org.checkerframework.checker.regex.qual.Regex
</pre><p>Directory <span style="font-family:monospace">docs/examples/lombok</span> contains an example Gradle project that
augments the configuration key.</p><p>(Note:
Lombok does support a limited set of annotations without the need for the
<span style="font-family:monospace">lombok.copyableAnnotations</span> configuration key, but as of version 1.18.4
(October 2018),
Lombok does not yet support any of the Checker Framework annotations; see variable
<span style="font-family:monospace">BASE_COPYABLE_ANNOTATIONS</span> in
<a href="https://github.com/rzwitserloot/lombok/blob/master/src/core/lombok/core/handlers/HandlerUtil.java"><span style="font-family:monospace">https://github.com/rzwitserloot/lombok/blob/master/src/core/lombok/core/handlers/HandlerUtil.java</span></a>.)</p>
<!--TOC section id="maven" Maven-->
<h2 id="maven" class="section">32.10&#XA0;&#XA0;Maven <a href="#maven" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>If you use the <a href="http://maven.apache.org/">Maven</a> tool,
then you can enable Checker Framework checkers by following the
instructions below.</p><p>See the directory <span style="font-family:monospace">docs/examples/MavenExample/</span> for examples of the use of
Maven build files that run a checker. These examples can be used to verify that
Maven is correctly downloading the Checker Framework from the
<a href="https://search.maven.org/search?q=org.checkerframework">Maven
Central Repository</a> and executing it.</p><p>Please note that the <span style="font-family:monospace">-AoutputArgsToFile</span> command-line option
(see Section&#XA0;<a href="#creating-debugging-options-output-args">31.11.4</a>) and shorthands for built-in checkers
(see Section&#XA0;<a href="#shorthand-for-checkers">2.2.5</a>) are not available when
following these instructions. Both these features are available only when a checker is
launched via <span style="font-family:monospace">checker.jar</span> such as when <span style="font-family:monospace">$CHECKERFRAMEWORK/checker/bin/javac</span>
is run. The instructions in this section
bypass <span style="font-family:monospace">checker.jar</span> and cause the compiler to run a
checker as an annotation processor directly.</p><ol class="enumerate" type=1><li class="li-enumerate">Declare a dependency on the Checker Framework artifacts, either from
Maven Central or from a local directory. Find the
existing <span style="font-family:monospace">&lt;dependencies&gt;</span> section and add the following new
<span style="font-family:monospace">&lt;dependency&gt;</span> items:<ol class="enumerate" type=a><li class="li-enumerate">
To obtain artifacts from Maven Central:<pre>
  &lt;dependencies&gt;
    ... existing &lt;dependency&gt; items ...

    &lt;!-- Annotations from the Checker Framework: nullness, interning, locking, ... --&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.checkerframework&lt;/groupId&gt;
      &lt;artifactId&gt;checker-qual&lt;/artifactId&gt;
      &lt;version&gt;2.11.0&lt;/version&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.checkerframework&lt;/groupId&gt;
      &lt;artifactId&gt;jdk8&lt;/artifactId&gt;
      &lt;version&gt;2.11.0&lt;/version&gt;
    &lt;/dependency&gt;
  &lt;/dependencies&gt;
</pre><p>Periodically update to the most recent version, to obtain the
latest bug fixes and new features:
</p><pre class="verbatim">  mvn versions:use-latest-versions -Dincludes="org.checkerframework:*"
</pre></li><li class="li-enumerate">To use a local version of the Checker Framework (for example,
one that you have built from source):<pre>
  &lt;dependencies&gt;
    ... existing &lt;dependency&gt; items ...

    &lt;!-- Annotations from the Checker Framework: nullness, interning, locking, ... --&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.checkerframework&lt;/groupId&gt;
      &lt;artifactId&gt;checker-qual&lt;/artifactId&gt;
      &lt;version&gt;2.11.0&lt;/version&gt;
      &lt;scope&gt;system&lt;/scope&gt;
      &lt;systemPath&gt;${env.CHECKERFRAMEWORK}/checker/dist/checker-qual.jar&lt;/systemPath&gt;
    &lt;/dependency&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.checkerframework&lt;/groupId&gt;
      &lt;artifactId&gt;checker&lt;/artifactId&gt;
      &lt;version&gt;2.11.0&lt;/version&gt;
      &lt;scope&gt;system&lt;/scope&gt;
      &lt;systemPath&gt;${env.CHECKERFRAMEWORK}/checker/dist/checker.jar&lt;/systemPath&gt;
    &lt;/dependency&gt;
    &lt;!-- The annotated JDK to use. --&gt;
    &lt;dependency&gt;
      &lt;groupId&gt;org.checkerframework&lt;/groupId&gt;
      &lt;artifactId&gt;jdk8&lt;/artifactId&gt;
      &lt;version&gt;2.11.0&lt;/version&gt;
      &lt;scope&gt;system&lt;/scope&gt;
      &lt;systemPath&gt;${env.CHECKERFRAMEWORK}/checker/dist/jdk8.jar&lt;/systemPath&gt;
    &lt;/dependency&gt;
  &lt;/dependencies&gt;
</pre><p>Periodically update to the most recent version, to obtain the
latest bug fixes and new features:
</p><pre class="verbatim">  mvn versions:use-latest-versions -Dincludes="org.checkerframework:*"
</pre></li></ol></li><li class="li-enumerate">Use Maven properties to hold the locations of the
annotated JDK. It was declared as Maven dependencies above.
To set the value of this property automatically, you will use the Maven Dependency plugin.<p>First, create the property in the <span style="font-family:monospace">properties</span> section of the POM:</p><pre>
&lt;properties&gt;
  &lt;!-- These properties will be set by the Maven Dependency plugin --&gt;
  &lt;annotatedJdk&gt;${org.checkerframework:jdk8:jar}&lt;/annotatedJdk&gt;
&lt;/properties&gt;
</pre><p>Change the reference to the <span style="font-family:monospace">maven-dependency-plugin</span> within the <span style="font-family:monospace">&lt;plugins&gt;</span>
section, or add it if it is not present.</p><pre>
  &lt;plugin&gt;
    &lt;!-- This plugin will set properties values using dependency information --&gt;
    &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
    &lt;artifactId&gt;maven-dependency-plugin&lt;/artifactId&gt;
    &lt;executions&gt;
      &lt;execution&gt;
        &lt;goals&gt;
          &lt;goal&gt;properties&lt;/goal&gt;
        &lt;/goals&gt;
      &lt;/execution&gt;
    &lt;/executions&gt;
  &lt;/plugin&gt;
</pre></li><li class="li-enumerate">If you are using Java 8, use the javac from Error Prone.<pre>
  &lt;!-- using github.com/google/error-prone-javac is required when running on JDK 8 --&gt;
  &lt;profiles&gt;
    &lt;profile&gt;
      &lt;id&gt;jdk8&lt;/id&gt;
      &lt;activation&gt;
        &lt;jdk&gt;1.8&lt;/jdk&gt;
      &lt;/activation&gt;
      &lt;properties&gt;
        &lt;javac.version&gt;9+181-r4173-1&lt;/javac.version&gt;
      &lt;/properties&gt;
      &lt;dependencies&gt;
        &lt;dependency&gt;
          &lt;groupId&gt;com.google.errorprone&lt;/groupId&gt;
          &lt;artifactId&gt;javac&lt;/artifactId&gt;
          &lt;version&gt;9+181-r4173-1&lt;/version&gt;
        &lt;/dependency&gt;
      &lt;/dependencies&gt;
      &lt;build&gt;
        &lt;plugins&gt;
          &lt;plugin&gt;
            &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
            &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
            &lt;configuration&gt;
              &lt;fork&gt;true&lt;/fork&gt;
              &lt;compilerArgs combine.children="append"&gt;
                &lt;arg&gt;-J-Xbootclasspath/p:$settings.localRepository/com/google/errorprone/javac/$javac.version/javac-$javac.version.jar&lt;/arg&gt;
              &lt;/compilerArgs&gt;
            &lt;/configuration&gt;
          &lt;/plugin&gt;
        &lt;/plugins&gt;
      &lt;/build&gt;
    &lt;/profile&gt;
  &lt;/profiles&gt;
</pre></li><li class="li-enumerate">Direct the Maven compiler plugin to use the desired checkers.
Change the reference to the <span style="font-family:monospace">maven-compiler-plugin</span> within the <span style="font-family:monospace">&lt;plugins&gt;</span>
section, or add it if it is not present.<p>For example, to use the <span style="font-family:monospace">org.checkerframework.checker.nullness.NullnessChecker</span>:</p><div style="font-size:small;">
<pre>
  &lt;plugin&gt;
    &lt;artifactId&gt;maven-compiler-plugin&lt;/artifactId&gt;
    &lt;version&gt;3.8.0&lt;/version&gt;
    &lt;configuration&gt;
      &lt;fork&gt;true&lt;/fork&gt;
      &lt;source&gt;1.8&lt;/source&gt;
      &lt;target&gt;1.8&lt;/target&gt;
      &lt;compilerArguments&gt;
        &lt;Xmaxerrs&gt;10000&lt;/Xmaxerrs&gt;
        &lt;Xmaxwarns&gt;10000&lt;/Xmaxwarns&gt;
      &lt;/compilerArguments&gt;
      &lt;annotationProcessorPaths&gt;
        &lt;path&gt;
          &lt;groupId&gt;org.checkerframework&lt;/groupId&gt;
          &lt;artifactId&gt;checker&lt;/artifactId&gt;
          &lt;version&gt;2.11.0&lt;/version&gt;
        &lt;/path&gt;
      &lt;/annotationProcessorPaths&gt;
      &lt;annotationProcessors&gt;
        &lt;!-- Add all the checkers you want to enable here --&gt;
        &lt;annotationProcessor&gt;org.checkerframework.checker.nullness.NullnessChecker&lt;/annotationProcessor&gt;
      &lt;/annotationProcessors&gt;
      &lt;compilerArgs combine.children="append"&gt;
        &lt;!-- location of the annotated JDK, which comes from a Maven dependency --&gt;
        &lt;arg&gt;-Xbootclasspath/p:${annotatedJdk}&lt;/arg&gt;
        &lt;!-- -Awarns turns type-checking warnings into errors. --&gt;
        &lt;!-- &lt;arg&gt;-Awarns&lt;/arg&gt; --&gt;
      &lt;/compilerArgs&gt;
    &lt;/configuration&gt;
  &lt;/plugin&gt;
</pre>
</div><p>Now, building with Maven will run the checkers during compilation.</p><p>If you want to allow Maven to compile your code without running the
checkers, you may want to move the declarations above to within a Maven
profile, so that the checkers run only if the profile was enabled.</p></li></ol>
<!--TOC section id="netbeans" NetBeans-->
<h2 id="netbeans" class="section">32.11&#XA0;&#XA0;NetBeans <a href="#netbeans" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>There are two approaches to running a checker in NetBeans: via modifying the
project properties, or via a custom ant target.</p><p>Note: The &#X2019;compile and save&#X2019; action in NetBeans 8.1 automatically
runs the Checker Framework whereas this functionality has not yet
been incorporated into NetBeans 8.2. Additionally, JDK annotations
are currently unavailable on NetBeans 8.1 and 8.2.</p>
<!--TOC subsection id="netbeans-project-properties" Adding a checker via the Project Properties window-->
<h3 id="netbeans-project-properties" class="subsection">32.11.1&#XA0;&#XA0;Adding a checker via the Project Properties window <a href="#netbeans-project-properties" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><ol class="enumerate" type=1><li class="li-enumerate">
Add the Checker Framework libraries to your project&#X2019;s
library. First, right click on the project in the Projects panel,
and select &#X201C;Properties&#X201D; in the drop-down menu. Then, in the
&#X201C;Project Properties&#X201D; window, navigate to the &#X201C;Libraries&#X201D; tab.</li><li class="li-enumerate">Add <span style="font-family:monospace">checker-qual.jar</span> to the compile-time libraries. To do so,
select the &#X201C;Compile&#X201D; tab, click the &#X201C;Add JAR/Folder&#X201D; button on
the right and browse to
add <span style="font-family:monospace">$CHECKERFRAMEWORK/checker/dist/checker-qual.jar</span>.</li><li class="li-enumerate">Add <span style="font-family:monospace">checker.jar</span> to the processor-path libraries. To do so, select
the &#X201C;Processor&#X201D; tab, click the &#X201C;Add JAR/Folder&#X201D; button on the
right and browse to
add <span style="font-family:monospace">$CHECKERFRAMEWORK/checker/dist/checker.jar</span>.</li><li class="li-enumerate">Enable annotation processor underlining in the editor. Go to
&#X201C;Build&gt;Compiling&#X201D; and check the box &#X201C;Enable Annotation
Processing,&#X201D; and under that, &#X201C;Enable Annotation Processing in
Editor.&#X201D;</li><li class="li-enumerate">Add the checker to run, by clicking &#X201C;Add&#X201D; next to the box labeled
&#X201C;Annotation Processors&#X201D; and enter the fully qualified name of the
checker (for
example, <span style="font-family:monospace">org.checkerframework.checker.nullness.NullnessChecker</span>)
and click &#X201C;OK&#X201D; to add.
</li></ol><p>The selected checker should be run on the project either on a save (if
Compile on Save is enabled), or when the project is built, and
annotation processor output will appear in the editor.</p>
<!--TOC subsection id="netbeans-ant-target" Adding a checker via an ant target-->
<h3 id="netbeans-ant-target" class="subsection">32.11.2&#XA0;&#XA0;Adding a checker via an ant target <a href="#netbeans-ant-target" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><ol class="enumerate" type=1><li class="li-enumerate">
Set the <span style="font-family:monospace">jsr308javac</span> property:<pre class="verbatim">  &lt;property environment="env"/&gt;

  &lt;property name="checkerframework" value="${env.CHECKERFRAMEWORK}" /&gt;

  &lt;!-- On Mac/Linux, use the javac shell script; on Windows, use javac.bat --&gt;
  &lt;condition property="cfJavac" value="javac.bat" else="javac"&gt;
      &lt;os family="windows" /&gt;
  &lt;/condition&gt;

  &lt;presetdef name="jsr308.javac"&gt;
    &lt;javac fork="yes" executable="${checkerframework}/checker/bin/${cfJavac}" &gt;
      &lt;compilerarg value="-version"/&gt;
      &lt;compilerarg value="-implicit:class"/&gt;
    &lt;/javac&gt;
  &lt;/presetdef&gt;
</pre></li><li class="li-enumerate">Override the <span style="font-family:monospace">-init-macrodef-javac-with-processors</span> target to
use <span style="font-family:monospace">jsr308.javac</span> instead of <span style="font-family:monospace">javac</span> and to run the checker.
In this example, a nullness checker is run:<pre class="verbatim">  &lt;target depends="-init-ap-cmdline-properties" if="ap.supported.internal"
        name="-init-macrodef-javac-with-processors"&gt;
    &lt;echo message = "${checkerframework}"/&gt;
    &lt;macrodef name="javac" uri="http://www.netbeans.org/ns/j2se-project/3"&gt;
        &lt;attribute default="${src.dir}" name="srcdir"/&gt;
        &lt;attribute default="${build.classes.dir}" name="destdir"/&gt;
        &lt;attribute default="${javac.classpath}" name="classpath"/&gt;
        &lt;attribute default="${javac.processorpath}" name="processorpath"/&gt;
        &lt;attribute default="${build.generated.sources.dir}/ap-source-output" name="apgeneratedsrcdir"/&gt;
        &lt;attribute default="${includes}" name="includes"/&gt;
        &lt;attribute default="${excludes}" name="excludes"/&gt;
        &lt;attribute default="${javac.debug}" name="debug"/&gt;
        &lt;attribute default="${empty.dir}" name="sourcepath"/&gt;
        &lt;attribute default="${empty.dir}" name="gensrcdir"/&gt;
        &lt;element name="customize" optional="true"/&gt;
        &lt;sequential&gt;
            &lt;property location="${build.dir}/empty" name="empty.dir"/&gt;
            &lt;mkdir dir="${empty.dir}"/&gt;
            &lt;mkdir dir="@{apgeneratedsrcdir}"/&gt;
            &lt;jsr308.javac debug="@{debug}" deprecation="${javac.deprecation}"
                    destdir="@{destdir}" encoding="${source.encoding}"
                    excludes="@{excludes}" fork="${javac.fork}"
                    includeantruntime="false" includes="@{includes}"
                    source="${javac.source}" sourcepath="@{sourcepath}"
                    srcdir="@{srcdir}" target="${javac.target}"
                    tempdir="${java.io.tmpdir}"&gt;
  &lt;src&gt;
                    &lt;dirset dir="@{gensrcdir}" erroronmissingdir="false"&gt;
                        &lt;include name="*"/&gt;
                    &lt;/dirset&gt;
                &lt;/src&gt;
                &lt;classpath&gt;
                    &lt;path path="@{classpath}"/&gt;
                &lt;/classpath&gt;
                &lt;compilerarg line="${endorsed.classpath.cmd.line.arg}"/&gt;
                &lt;compilerarg line="${javac.profile.cmd.line.arg}"/&gt;
                &lt;compilerarg line="${javac.compilerargs}"/&gt;
                &lt;compilerarg value="-processorpath"/&gt;
                &lt;compilerarg path="@{processorpath}:${empty.dir}"/&gt;
                &lt;compilerarg line="${ap.processors.internal}"/&gt;
                &lt;compilerarg line="${annotation.processing.processor.options}"/&gt;
                &lt;compilerarg value="-s"/&gt;
                &lt;compilerarg path="@{apgeneratedsrcdir}"/&gt;
                &lt;compilerarg line="${ap.proc.none.internal}"/&gt;
                &lt;compilerarg line="-processor org.checkerframework.checker.nullness.NullnessChecker"/&gt;
                &lt;compilerarg line="-Xmaxerrs 10000"/&gt;
                &lt;compilerarg line="-Xmaxwarns 10000"/&gt;
                &lt;customize/&gt;
            &lt;/jsr308.javac&gt;
        &lt;/sequential&gt;
    &lt;/macrodef&gt;
  &lt;/target&gt;
  &lt;target name="-post-jar"&gt;
  &lt;/target&gt;
</pre><p>When Build and Clean Project is used, the output of the checker will
now appear in the build console. However, annotation processor output
will not appear in the editor.</p></li></ol>
<!--TOC section id="tide" tIDE-->
<h2 id="tide" class="section">32.12&#XA0;&#XA0;tIDE <a href="#tide" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>
tIDE, an open-source Java IDE, supports the Checker Framework.
You can download it from <a href="https://sourceforge.net/projects/tide/"><span style="font-family:monospace">https://sourceforge.net/projects/tide/</span></a>.
</p>
<!--TOC section id="type-inference-varieties" Type inference tools-->
<h2 id="type-inference-varieties" class="section">32.13&#XA0;&#XA0;Type inference tools <a href="#type-inference-varieties" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>There are two different tasks that are commonly called &#X201C;type inference&#X201D;.
You are probably interested in type inference to annotate a program&#X2019;s
source code; see Section&#XA0;<a href="#type-inference-to-annotate">29.2</a>. This section
explains the two different varieties of type inference.</p><ol class="enumerate" type=1><li class="li-enumerate">
Type inference during type-checking (Section&#XA0;<a href="#type-refinement">26.7</a>):
During type-checking, if certain variables have no programmer-written type qualifier, the
type-checker determines whether there is some type qualifier that would
permit the program to type-check. If so, the type-checker uses that type
qualifier, but never tells the programmer what it was. Each time the
type-checker runs, it re-infers the type qualifier for that variable. If
no type qualifier exists that permits the program to type-check, the
type-checker issues a type warning.<p>This variety of type inference is built into the Checker Framework. Every
checker can take advantage of it at no extra effort. However, it only
works within a method, not across method boundaries.</p><p>Advantages of this variety of type inference include:
</p><ul class="itemize"><li class="li-itemize">
If the type qualifier is obvious to the programmer, then omitting it
can reduce annotation clutter in the program.
</li><li class="li-itemize">The type inference can take advantage of only the code currently being
compiled, rather than having to be correct for all possible calls.
Additionally, if the code changes, then there is no old annotation to
update.
</li></ul></li><li class="li-enumerate">Type inference to annotate a program (Section&#XA0;<a href="#type-inference-to-annotate">29.2</a>):
As a separate step before type-checking, a type inference tool takes the
program as input, and outputs a set of type qualifiers that would
type-check. These qualifiers are inserted into the source code or the
class file. They can be viewed and adjusted by the programmer, and can
be used by tools such as the type-checker.<p>This variety of type inference must be provided by a separate tool. It
is not built into the Checker Framework.</p><p>Advantages of this variety of type inference include:
</p><ul class="itemize"><li class="li-itemize">
The program contains documentation in the form of type qualifiers,
which can aid programmer understanding.
</li><li class="li-itemize">Error messages may be more comprehensible. With type inference
during type-checking, error messages can be obscure, because the
compiler has already inferred (possibly incorrect) types for a number
of variables.
</li><li class="li-itemize">A minor advantage is speed: type-checking can be modular, which can be
faster than re-doing type inference every time the
program is type-checked.
</li></ul></li></ol><p>Advantages of both varieties of inference include:
</p><ul class="itemize"><li class="li-itemize">
Less work for the programmer.
</li><li class="li-itemize">The tool chooses the most general type, whereas a programmer might
accidentally write a more specific, less generally-useful annotation.
</li></ul><p>Each variety of type inference has its place. When using the Checker
Framework, type inference during type-checking is performed only
<em>within</em> a method (Section&#XA0;<a href="#type-refinement">26.7</a>). Every method
signature (arguments and return values) and field must have already been explicitly annotated,
either by the programmer or by a separate type-checking tool
(Section&#XA0;<a href="#type-inference-to-annotate">29.2</a>).
This approach enables modular checking (one class or method at a time) and
gives documentation benefits.
The programmer still has to
put in some effort, but much less than without inference: typically, a
programmer does not have to write any qualifiers
inside the body of a method (except sometimes on type arguments).</p><hr>
<!--TOC chapter id="faq" Frequently Asked Questions (FAQs)-->
<h1 id="faq" class="chapter">Chapter&#XA0;33&#XA0;&#XA0;Frequently Asked Questions (FAQs) <a href="#faq" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h1><!--SEC END --><p>These are some common questions about the Checker Framework and about
pluggable type-checking in general. Feel free to suggest improvements to
the answers, or other questions to include here.</p><p><span style="font-weight:bold">Contents:</span></p><p><a href="#faq-motivation-section"><span style="font-weight:bold">33.1</span></a><span style="font-weight:bold">: Motivation for pluggable type-checking</span>
<br>
<a href="#faq-never-make-type-errors">33.1.1</a>: I don&#X2019;t make type errors, so would pluggable type-checking help me?
<br>
<a href="#faq-typequals-vs-subtypes">33.1.2</a>: Should I use pluggable types (type qualifiers), or should I used Java subtypes?</p><p><a href="#faq-getting-started-section"><span style="font-weight:bold">33.2</span></a><span style="font-weight:bold">: Getting started</span>
<br>
<a href="#faq-annotate-existing-program">33.2.1</a>: How do I get started annotating an existing program?
<br>
<a href="#faq-first-checker">33.2.2</a>: Which checker should I start with?
<br>
<a href="#faq-checker-framework-dev">33.2.3</a>: How can I join the checker-framework-dev mailing list?</p><p><a href="#faq-usability-section"><span style="font-weight:bold">33.3</span></a><span style="font-weight:bold">: Usability of pluggable type-checking</span>
<br>
<a href="#faq-ease-of-use">33.3.1</a>: Are type annotations easy to read and write?
<br>
<a href="#faq-code-clutter">33.3.2</a>: Will my code become cluttered with type annotations?
<br>
<a href="#faq-slowdown">33.3.3</a>: Will using the Checker Framework slow down my program? Will it slow down the compiler?
<br>
<a href="#faq-shorten-command-line">33.3.4</a>: How do I shorten the command line when invoking a checker?
<br>
<a href="#faq-pre-conditions">33.3.5</a>: Method pre-condition contracts, including formal parameter annotations, make no sense for public methods.</p><p><a href="#faq-warnings-section"><span style="font-weight:bold">33.4</span></a><span style="font-weight:bold">: How to handle warnings</span>
<br>
<a href="#faq-handling-warnings">33.4.1</a>: What should I do if a checker issues a warning about my code?
<br>
<a href="#faq-interpreting-warnings">33.4.2</a>: What does a certain Checker Framework warning message mean?
<br>
<a href="#faq-no-absolute-guarantee">33.4.3</a>: Can a pluggable type-checker guarantee that my code is correct?
<br>
<a href="#faq-concurrency">33.4.4</a>: What guarantee does the Checker Framework give for concurrent code?
<br>
<a href="#faq-awarns">33.4.5</a>: How do I make compilation succeed even if a checker issues errors?
<br>
<a href="#faq-100-warnings">33.4.6</a>: Why does the checker always say there are 100 errors or warnings?
<br>
<a href="#faq-type-i-did-not-write">33.4.7</a>: Why does the Checker Framework report an error regarding a type I have not written in my program?
<br>
<a href="#faq-same-code-different-behavior">33.4.8</a>: Why does the Checker Framework accept code on one line but reject it on the next?
<br>
<a href="#faq-run-time-checking">33.4.9</a>: How can I do run-time monitoring of properties that were not statically checked?</p><p><a href="#faq-false-positives-section"><span style="font-weight:bold">33.5</span></a><span style="font-weight:bold">: False positive warnings</span>
<br>
<a href="#faq-false-positive">33.5.1</a>: What is a &#X201C;false positive&#X201D; warning?
<br>
<a href="#faq-false-positive-extend-checker-framework">33.5.2</a>: How can I improve the Checker Framework to eliminate a false positive warning?
<br>
<a href="#faq-infer-fields">33.5.3</a>: Why doesn&#X2019;t the Checker Framework infer types for fields and method return types?
<br>
<a href="#faq-relationships-between-variables">33.5.4</a>: Why doesn&#X2019;t the Checker Framework track relationships between variables?
<br>
<a href="#faq-path-sensitive">33.5.5</a>: Why isn&#X2019;t the Checker Framework path-sensitive?</p><p><a href="#faq-syntax-section"><span style="font-weight:bold">33.6</span></a><span style="font-weight:bold">: Syntax of type annotations</span>
<br>
<a href="#faq-receiver">33.6.1</a>: What is a &#X201C;receiver&#X201D;?
<br>
<a href="#faq-annotation-after-type">33.6.2</a>: What is the meaning of an annotation after a type, such as <span style="font-family:monospace">@NonNull Object @Nullable</span>?
<br>
<a href="#faq-array-syntax-meaning">33.6.3</a>: What is the meaning of array annotations such as <span style="font-family:monospace">@NonNull Object @Nullable []</span>?
<br>
<a href="#faq-varargs-syntax-meaning">33.6.4</a>: What is the meaning of varargs annotations such as <span style="font-family:monospace">@English String @NonEmpty&#XA0;...</span>?
<br>
<a href="#faq-type-qualifier-on-class-declaration">33.6.5</a>: What is the meaning of a type qualifier at a class declaration?
<br>
<a href="#faq-type-qualifier-on-bounds">33.6.6</a>: How are type qualifiers written on upper and lower bounds?
<br>
<a href="#faq-no-annotation-on-types-and-declarations">33.6.7</a>: Why shouldn&#X2019;t a qualifier apply to both types and declarations?
<br>
<a href="#faq-annotate-fully-qualified-name">33.6.8</a>: How do I annotate a
fully-qualified type name?
<br>
<a href="#faq-type-vs-declaration-annotations">33.6.9</a>: What is the difference between type annotations and declaration annotations?</p><p><a href="#faq-semantics-section"><span style="font-weight:bold">33.7</span></a><span style="font-weight:bold">: Semantics of type annotations</span>
<br>
<a href="#faq-typestate">33.7.1</a>: How can I handle typestate, or phases of my program with different data properties?
<br>
<a href="#faq-implicit-bounds">33.7.2</a>: Why are explicit and implicit bounds defaulted differently?
<br>
<a href="#faq-runtime-retention">33.7.3</a>: Why are type annotations declared with <span style="font-family:monospace">@Retention(RetentionPolicy.RUNTIME)</span>?</p><p><a href="#faq-create-a-checker-section"><span style="font-weight:bold">33.8</span></a><span style="font-weight:bold">: Creating a new checker</span>
<br>
<a href="#faq-create-a-checker">33.8.1</a>: How do I create a new checker?
<br>
<a href="#faq-type-properties">33.8.2</a>: What properties can and cannot be handled by type-checking?
<br>
<a href="#faq-declarative-syntax-for-type-rules">33.8.3</a>: Why is there no declarative syntax for writing type rules?</p><p><a href="#faq-tool-section"><span style="font-weight:bold">33.9</span></a><span style="font-weight:bold">: Tool questions</span>
<br>
<a href="#faq-pluggable-type-checking">33.9.1</a>: How does pluggable type-checking work?
<br>
<a href="#faq-classpath-to-use-annotated-library">33.9.2</a>: What classpath is needed to use an annotated library?
<br>
<a href="#faq-checked-exceptions">33.9.4</a>: Is there a type-checker for managing checked and unchecked exceptions?</p><p><a href="#faq-other-tools-section"><span style="font-weight:bold">33.10</span></a><span style="font-weight:bold">: Relationship to other tools</span>
<br>
<a href="#faq-type-checking-vs-bug-detectors">33.10.1</a>: Why not just use a bug detector (like FindBugs or Error Prone)?
<br>
<a href="#faq-eclipse">33.10.2</a>: How does the Checker Framework compare with Eclipse&#X2019;s Null Analysis?
<br>
<a href="#faq-nullaway">33.10.3</a>: How does the Checker Framework compare with NullAway?
<br>
<a href="#faq-optional">33.10.4</a>: How does the Checker Framework compare with the JDK&#X2019;s <span style="font-family:monospace">Optional</span> type?
<br>
<a href="#faq-jml">33.10.5</a>: How does pluggable type-checking compare with JML?
<br>
<a href="#faq-checker-framework-part-of-java">33.10.6</a>: Is the Checker Framework an official part of Java?
<br>
<a href="#faq-jsr-305">33.10.7</a>: What is the relationship between the Checker Framework and JSR 305?
<br>
<a href="#faq-jsr-308">33.10.8</a>: What is the relationship between the Checker Framework and JSR 308?</p>
<!--TOC section id="faq-motivation-section" Motivation for pluggable type-checking-->
<h2 id="faq-motivation-section" class="section">33.1&#XA0;&#XA0;Motivation for pluggable type-checking <a href="#faq-motivation-section" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END -->
<!--TOC subsection id="faq-never-make-type-errors" I don&#X2019;t make type errors, so would pluggable type-checking help me?-->
<h3 id="faq-never-make-type-errors" class="subsection">33.1.1&#XA0;&#XA0;I don&#X2019;t make type errors, so would pluggable type-checking help me? <a href="#faq-never-make-type-errors" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Occasionally, a developer says that he makes no errors that type-checking
could catch, or that any such errors are unimportant because they have low
impact and are easy to fix. When I investigate the claim, I invariably
find that the developer is mistaken.</p><p>Very frequently, the developer has underestimated what type-checking can
discover. Not every type error leads to an exception being thrown; and
even if an exception is thrown, it may not seem related to classical types.
Remember that a type system can discover
null pointer dereferences,
incorrect side effects,
security errors such as information leakage or SQL injection,
partially-initialized data,
wrong units of measurement,
and many other errors.
Every programmer makes errors sometimes and works with other people
who do.
Even where type-checking does not discover a
problem directly, it can indicate code with bad smells, thus revealing
problems, improving documentation, and making future maintenance easier.</p><p>There are other ways to discover errors, including extensive testing and
debugging. You should continue to use these.
But type-checking is a good complement to these. Type-checking is more
effective for some problems, and less effective for other problems. It can
reduce (but not eliminate) the time and effort that you spend on other
approaches. There are many important errors that type-checking and other
automated approaches cannot find; pluggable type-checking gives you more
time to focus on those.</p>
<!--TOC subsection id="faq-typequals-vs-subtypes" Should I use pluggable types (type qualifiers), or should I used Java subtypes?-->
<h3 id="faq-typequals-vs-subtypes" class="subsection">33.1.2&#XA0;&#XA0;Should I use pluggable types (type qualifiers), or should I used Java subtypes? <a href="#faq-typequals-vs-subtypes" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p><a id="when-to-use-type-qualifiers"></a>
<a id="faq-qualifiers-vs-subclasses"></a></p><p>In brief, use subtypes when you can, and use type qualifiers when you cannot
use subtypes.</p><p>For some programming tasks, you can use either a Java subtype (interfaces
or subclasses) or a type
qualifier. As an example, suppose that your code currently uses <span style="font-family:monospace">String</span> to
represent an address. You could use Java subclasses by creating a new
<span style="font-family:monospace">Address</span> class and refactor your code to use it, or you could use
type qualifiers by creating an <span style="font-family:monospace">@Address</span> annotation and applying it
to some uses of <span style="font-family:monospace">String</span> in your code. As another example, suppose
that your code currently uses <span style="font-family:monospace">MyClass</span> in two different ways that
should not interact with one another. You could use Java subclasses by
changing MyClass into an interface or abstract class, defining two
subclasses, and ensuring that neither subclass ever refers to the other
subclass nor to the parent class.</p><p>If Java subclasses solve your problem, then that is probably better.
We do not encourage you to use type qualifiers as a poor substitute for
classes. An advantage of using classes is that the Java type-checker
runs every time you compile your code;
by contrast, it is possible to forget to run the pluggable
type-checker. However, sometimes type qualifiers are a
better choice; here are some reasons:</p><dl class="description"><dt class="dt-description"><span style="font-weight:bold">Backward compatibility</span></dt><dd class="dd-description">
Using a new class may make your code incompatible with existing libraries or
clients. Brian Goetz expands on this issue in an article on the
pseudo-typedef antipattern&#XA0;[<a href="#Goetz2006%3Atypedef">Goe06</a>]. Even if compatibility
is not a concern, a code change may introduce bugs, whereas adding
annotations does not change the run-time behavior. It is possible to add
annotations to existing code, including code you do not maintain or cannot
change. For code that strictly cannot be changed, you
can write library annotations (see Chapter&#XA0;<a href="#annotating-libraries">30</a>).</dd><dt class="dt-description"><span style="font-weight:bold">Broader applicability</span></dt><dd class="dd-description">
Type annotations can be applied to primitives and to final classes such as
<span style="font-family:monospace">String</span>, which cannot be subclassed.</dd><dt class="dt-description"><span style="font-weight:bold">Richer semantics and new supertypes</span></dt><dd class="dd-description">
Type qualifiers permit you to remove operations, with a compile-time
guarantee. More
generally, type qualifiers permit creating a new supertype, not just a
subtype, of an existing Java type.</dd><dt class="dt-description"><span style="font-weight:bold">More precise type-checking</span></dt><dd class="dd-description">
The Checker Framework is able to verify the correctness of code that the
Java type-checker would reject. Here are a few examples.
<ul class="itemize"><li class="li-itemize">
It uses a dataflow analysis to determine a more precise type for
variables after conditional tests or assignments.
</li><li class="li-itemize">It treats certain Java constructs more precisely, such as
reflection (see Chapter&#XA0;<a href="#reflection-resolution">22</a>).
</li><li class="li-itemize">It includes special-case logic for type-checking specific methods, such
as the Nullness Checker&#X2019;s treatment of <span style="font-family:monospace">Map.get</span>.
</li></ul></dd><dt class="dt-description"><span style="font-weight:bold">Efficiency</span></dt><dd class="dd-description">
Type qualifiers have no run-time representation. Therefore, there is no
space overhead for separate classes or for wrapper classes for
primitives. There is no run-time overhead for due to extra dereferences
or dynamic dispatch for methods that could otherwise be statically
dispatched.</dd><dt class="dt-description"><span style="font-weight:bold">Less code clutter</span></dt><dd class="dd-description">
The programmer does not have to convert primitive types to wrappers,
which would make the code both uglier and slower. Thanks to defaults and
type inference (Section&#XA0;<a href="#defaults">26.5</a>),
you may be able to write and think in terms of the
original Java type, rather than having to explicitly write one of the
subtypes in all locations.</dd></dl><p>For more details, see Section&#XA0;<a href="#faq-typequals-vs-subtypes">33.1.2</a>.</p>
<!--TOC section id="faq-getting-started-section" Getting started-->
<h2 id="faq-getting-started-section" class="section">33.2&#XA0;&#XA0;Getting started <a href="#faq-getting-started-section" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END -->
<!--TOC subsection id="faq-annotate-existing-program" How do I get started annotating an existing program?-->
<h3 id="faq-annotate-existing-program" class="subsection">33.2.1&#XA0;&#XA0;How do I get started annotating an existing program? <a href="#faq-annotate-existing-program" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>See Section&#XA0;<a href="#get-started-with-legacy-code">2.4.2</a>.</p>
<!--TOC subsection id="faq-first-checker" Which checker should I start with?-->
<h3 id="faq-first-checker" class="subsection">33.2.2&#XA0;&#XA0;Which checker should I start with? <a href="#faq-first-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>You should start with a property that matters to you. Think about what
aspects of your code cause the most errors, or cost the most time during
maintenance, or are the most common to be incorrectly-documented. Focusing
on what you care about will give you the best benefits.</p><p>When you first start out with the Checker Framework, it&#X2019;s usually best to
get experience with an existing type-checker before you write your own new
checker.</p><p>Many users are tempted to start with the
<a href="#nullness-checker">Nullness Checker</a> (see
Chapter&#XA0;<a href="#nullness-checker">3</a>), since null pointer errors are common
and familiar. The Nullness Checker works very well, but be warned of three
facts that make the absence of null pointer exceptions challenging to
verify.</p><ol class="enumerate" type=1><li class="li-enumerate">
Dereferences happen throughout your codebase, so there are a lot of
potential problems. By contrast, fewer lines of code are related to
locking, regular expressions, etc., so those properties are easier to
check.
</li><li class="li-enumerate">Programmers use <span style="font-family:monospace">null</span> for many different purposes. More seriously,
programmers write run-time tests against <span style="font-family:monospace">null</span>, and those are difficult
for any static analysis to capture.
</li><li class="li-enumerate">The Nullness Checker interacts with initialization and map keys.
</li></ol><p>If null pointer exceptions are most important to you, then by all means use
the Nullness Checker. But if you just want to try <em>some</em>
type-checker, there are others that are easier to use.</p><p>We do not recommend indiscriminately running all the checkers on your code.
The reason is that each one has a cost &#X2014; not just at compile time, but
also in terms of code clutter and human time to maintain the annotations.
If the property is important to you, is difficult for people to reason
about, or has caused problems in the past, then you should run that
checker. For other properties, the benefits may not repay the effort to
use it. You will be the best judge of this for your own code, of course.</p><p>Some of the third-party checkers (see
Chapter&#XA0;<a href="#third-party-checkers">24</a>)
have known bugs that limit their
usability. (Report the ones that affect you, so the developers
will prioritize fixing them.)</p>
<!--TOC subsection id="faq-checker-framework-dev" How can I join the checker-framework-dev mailing list?-->
<h3 id="faq-checker-framework-dev" class="subsection">33.2.3&#XA0;&#XA0;How can I join the checker-framework-dev mailing list? <a href="#faq-checker-framework-dev" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The <span style="font-family:monospace">checker-framework-dev@googlegroups.com</span> mailing list is for
Checker Framework developers. Anyone is welcome to
<a href="https://groups.google.com/forum/#!forum/checker-framework-dev">join
<span style="font-family:monospace">checker-framework-dev</span></a>, after they have had several pull requests
accepted.</p><p>Anyone is welcome to send mail to the
<span style="font-family:monospace">checker-framework-dev@googlegroups.com</span> mailing list &#X2014; for
implementation details it is generally a better place for discussions than
the general <span style="font-family:monospace">checker-framework-discuss@googlegroups.com</span> mailing list,
which is for user-focused discussions.</p><p>Anyone is welcome to
<a href="https://groups.google.com/forum/#!forum/checker-framework-discuss">join
<span style="font-family:monospace">checker-framework-discuss@googlegroups.com</span></a> and send mail to it.</p>
<!--TOC section id="faq-usability-section" Usability of pluggable type-checking-->
<h2 id="faq-usability-section" class="section">33.3&#XA0;&#XA0;Usability of pluggable type-checking <a href="#faq-usability-section" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END -->
<!--TOC subsection id="faq-ease-of-use" Are type annotations easy to read and write?-->
<h3 id="faq-ease-of-use" class="subsection">33.3.1&#XA0;&#XA0;Are type annotations easy to read and write? <a href="#faq-ease-of-use" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The papers
<a href="https://homes.cs.washington.edu/~mernst/pubs/pluggable-checkers-issta2008-abstract.html">&#X201C;Practical
pluggable types for Java&#X201D;</a>&#XA0;[<a href="#PapiACPE2008">PAC+08</a>]
and
<a href="https://homes.cs.washington.edu/~mernst/pubs/pluggable-checkers-icse2011-abstract.html">&#X201C;Building
and using pluggable type-checkers&#X201D;</a>&#XA0;[<a href="#DietlDEMS2011">DDE+11</a>]
discuss case studies in
which programmers
found type annotations to be natural to read and write. The code
continued to feel like Java, and the type-checking errors were easy to
comprehend and often led to real bugs.</p><p>You don&#X2019;t have to take our word for it, though. You can try the
Checker Framework for yourself.</p><p>The difficulty of adding and verifying annotations depends on your program.
If your program is well-designed and -documented, then skimming the
existing documentation and writing type annotations is extremely easy.
Otherwise, you may find yourself spending a lot of time trying to
understand, reverse-engineer, or fix bugs in your program, and then just a
moment writing a type annotation that describes what you discovered. This
process inevitably improves your code. You must decide whether it is a
good use of your time. For code that is not causing trouble now and is
unlikely to do so in the future (the code is bug-free, and you do not
anticipate changing it or using it in new contexts), then the
effort of writing type annotations for it may not be justified.</p>
<!--TOC subsection id="faq-code-clutter" Will my code become cluttered with type annotations?-->
<h3 id="faq-code-clutter" class="subsection">33.3.2&#XA0;&#XA0;Will my code become cluttered with type annotations? <a href="#faq-code-clutter" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>In summary: annotations do not clutter code; they are used much
less frequently than generic types, which Java programmers find acceptable;
and they reduce the overall volume of documentation that a codebase needs.</p><p>As with any language feature, it is possible to write ugly code that
over-uses annotations. However, in normal use, very few annotations need
to be written. Figure 1 of the paper
<a href="https://homes.cs.washington.edu/~mernst/pubs/pluggable-checkers-issta2008-abstract.html">Practical
pluggable types for Java</a>&#XA0;[<a href="#PapiACPE2008">PAC+08</a>] reports data for over
350,000 lines of type-annotated code:</p><ul class="itemize"><li class="li-itemize">
1 annotation per 62 lines for nullness annotations (<span style="font-family:monospace">@NonNull</span>, <span style="font-family:monospace">@Nullable</span>, etc.)
</li><li class="li-itemize">1 annotation per 1736 lines for interning annotations (<span style="font-family:monospace">@Interned</span>)
</li></ul><p>These numbers are for annotating existing code. New code that
is written with the type annotation system in mind is cleaner and more
correct, so it requires even fewer annotations.</p><p>Each annotation that a programmer writes replaces a sentence or phrase of
English descriptive text that would otherwise have been written in the
Javadoc. So, use of annotations actually reduces the overall size of the
documentation, at the same time as making it machine-processable
and less ambiguous.</p>
<!--TOC subsection id="faq-slowdown" Will using the Checker Framework slow down my program? Will it slow down the compiler?-->
<h3 id="faq-slowdown" class="subsection">33.3.3&#XA0;&#XA0;Will using the Checker Framework slow down my program? Will it slow down the compiler? <a href="#faq-slowdown" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Using the Checker Framework has no impact on the execution of your program:
the compiler emits the identical bytecodes as the Java 8
compiler and so there is no run-time effect. Because there is no run-time
representation of type qualifiers, there is no way to use reflection to
query the qualifier on a given object, though you can use reflection to
examine a class/method/field declaration.</p><p>Using the Checker Framework does increase compilation time. In theory it
should only add a few percent overhead, but our current implementation
can double the compilation time &#X2014; or more, if you run many pluggable
type-checkers at once. This is especially true if you run pluggable
type-checking on every file (as we recommend) instead of just on the ones
that have recently changed.
Nonetheless, compilation with pluggable type-checking still feels like
compilation, and you can do it as part of your normal development process.</p>
<!--TOC subsection id="faq-shorten-command-line" How do I shorten the command line when invoking a checker?-->
<h3 id="faq-shorten-command-line" class="subsection">33.3.4&#XA0;&#XA0;How do I shorten the command line when invoking a checker? <a href="#faq-shorten-command-line" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>
The compile options to javac can be long to type; for example,
<span style="font-family:monospace">javac -processor org.checkerframework.checker.nullness.NullnessChecker ...</span>.
See Section&#XA0;<a href="#checker-auto-discovery">2.2.4</a> for a way to avoid the need for
the <span style="font-family:monospace">-processor</span> command-line option.
</p>
<!--TOC subsection id="faq-pre-conditions" Method pre-condition contracts, including formal parameter annotations, make no sense for public methods-->
<h3 id="faq-pre-conditions" class="subsection">33.3.5&#XA0;&#XA0;Method pre-condition contracts, including formal parameter annotations, make no sense for public methods <a href="#faq-pre-conditions" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Some people go further and say that pre-condition contracts make no sense
for any method. This objection is sometimes stated as, "A method parameter
should never be annotated as <span style="font-family:monospace">@NonNull</span>. A client could pass any value at
all, so the method implementation cannot depend on the value being
non-null. Furthermore, if a client passes an illegal value, it is the
method&#X2019;s responsibility to immediately tell the client about the illegal
value."</p><p>Here is an example that invalidates this general argument. Consider a
binary search routine. Its specification requires that clients pass in a
sorted array.</p><pre class="verbatim">  /** Return index of the search key, if it is contained it the sorted array a; otherwise ... */
  int binarySearch(Object @Sorted [] a, Object key)
</pre><p>The <span style="font-family:monospace">binarySearch</span> routine is fast &#X2014; it runs in O(log n) time where n is
the length of the array. If the routine had to validate that its input
array is sorted, then it would run in O(n) time, negating all benefit of
binary search. In other words, <span style="font-family:monospace">binarySearch</span> should <em>not</em> validate
its input!</p><p>The nature of a contract is that if the <em>caller</em> violates its
responsibilities by passing bad values, then the <em>callee</em> is absolved
of its responsibilities. It is polite for the callee to try to provide a
useful diagnostic to the misbehaving caller (for example, by raising a
particular exception quickly), but it is <em>not</em> required. In such a
situation, the callee has the flexibility to do anything that is
convenient.</p><p>In some cases a routine has a <em>complete</em> specification: the contract
permits the caller to pass any value, and the callee is required to throw
particular exceptions for particular inputs. This approach is common for
public methods, but it is not required and is not always the right thing.
As explained in section&#XA0;<a href="#annotate-normal-behavior">2.4.3</a>, even when a method
has a complete specification, the annotations should indicate normal
behavior: behavior that will avoid exceptions.</p>
<!--TOC section id="faq-warnings-section" How to handle warnings and errors-->
<h2 id="faq-warnings-section" class="section">33.4&#XA0;&#XA0;How to handle warnings and errors <a href="#faq-warnings-section" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END -->
<!--TOC subsection id="faq-handling-warnings" What should I do if a checker issues a warning about my code?-->
<h3 id="faq-handling-warnings" class="subsection">33.4.1&#XA0;&#XA0;What should I do if a checker issues a warning about my code? <a href="#faq-handling-warnings" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>For a discussion of this issue, see Section&#XA0;<a href="#handling-warnings">2.4.5</a>.</p>
<!--TOC subsection id="faq-interpreting-warnings" What does a certain Checker Framework warning message mean?-->
<h3 id="faq-interpreting-warnings" class="subsection">33.4.2&#XA0;&#XA0;What does a certain Checker Framework warning message mean? <a href="#faq-interpreting-warnings" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Read the error message first; sometimes that is enough to clarify it.</p><p>Search through this manual for the text of the warning message or for words
that appear in it.</p><p>If nothing else explains it, then ask on the
<a href="https://groups.google.com/forum/#!forum/checker-framework-discuss">mailing
list</a>. Be sure to say what you think it means or what specific part does
not make sense to you, and what you have already done to try to understand it.</p>
<!--TOC subsection id="faq-no-absolute-guarantee" Can a pluggable type-checker guarantee that my code is correct?-->
<h3 id="faq-no-absolute-guarantee" class="subsection">33.4.3&#XA0;&#XA0;Can a pluggable type-checker guarantee that my code is correct? <a href="#faq-no-absolute-guarantee" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Each checker looks for certain errors. You can use multiple checkers to
detect more errors in your code, but you will never have a guarantee that
your code is completely bug-free.</p><p>If the type-checker issues no warning, then you have a guarantee that your
code is free of some particular error. There are some limitations to the
guarantee.</p><p>Most importantly, if you run a pluggable checker on only part of a program, then
you only get a guarantee that those parts of the program are error-free.
For example, suppose you have type-checked a framework that clients
are intended to extend. You should recommend that clients
run the pluggable checker. There is no way to force users to do so, so you
may want to retain dynamic checks or use other mechanisms to detect errors.</p><p>Section&#XA0;<a href="#checker-guarantees">2.3</a> states other limitations to a checker&#X2019;s
guarantee, such as regarding concurrency. Java&#X2019;s type system is also
unsound in certain situations, such as for arrays and casts (however, the
Checker Framework is sound for arrays and casts). Java uses dynamic checks
is some places it is unsound, so that errors are thrown at run time. The
pluggable type-checkers do not currently have built-in dynamic checkers to
check for the places they are unsound.
Writing dynamic checkers would be an interesting and valuable project.</p><p>Other types of dynamism in a Java application do not jeopardize the
guarantee, because the type-checker is conservative. For example, at a
method call, dynamic dispatch chooses some implementation of the method,
but it is impossible to know at compile time which one it will be. The
type-checker gives a guarantee no matter what implementation of the method
is invoked.</p><p>Even if a pluggable checker cannot give an ironclad
guarantee of correctness, it is still useful. It can find errors,
exclude certain types of possible problems (e.g., restricting the
possible class of problems), improve documentation, and increase confidence
in your software.</p>
<!--TOC subsection id="faq-concurrency" What guarantee does the Checker Framework give for concurrent code?-->
<h3 id="faq-concurrency" class="subsection">33.4.4&#XA0;&#XA0;What guarantee does the Checker Framework give for concurrent code? <a href="#faq-concurrency" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The Lock Checker (see Chapter&#XA0;<a href="#lock-checker">7</a>) offers a way to detect
and prevent certain concurrency errors.</p><p>By default, the Checker Framework assumes that the code that it is checking
is sequential: that is, there are no concurrent accesses from another
thread. This means that the Checker Framework is unsound for concurrent
code, in the sense that it may fail to issue a warning about errors that
occur only when the code is running in a concurrent setting.
For example, the Nullness Checker issues no warning for this
code:</p><pre class="verbatim">  if (myobject.myfield != null) {
    myobject.myfield.toString();
  }
</pre><p>This code is safe when run on its own.
However, in the presence of multithreading, the call to <span style="font-family:monospace">toString</span> may
fail because another thread may set <span style="font-family:monospace">myobject.myfield</span> to <span style="font-family:monospace">null</span> after
the nullness check in the <span style="font-family:monospace">if</span> condition, but before the <span style="font-family:monospace">if</span> body is
executed.</p><p>If you supply the <span style="font-family:monospace">-AconcurrentSemantics</span> command-line option, then the
Checker Framework assumes that any field can be changed at any time. This
limits the amount of type refinement
(Section&#XA0;<a href="#type-refinement">26.7</a>) that the Checker Framework can do.</p>
<!--TOC subsection id="faq-awarns" How do I make compilation succeed even if a checker issues errors?-->
<h3 id="faq-awarns" class="subsection">33.4.5&#XA0;&#XA0;How do I make compilation succeed even if a checker issues errors? <a href="#faq-awarns" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Section&#XA0;<a href="#running">2.2</a> describes the <span style="font-family:monospace">-Awarns</span> command-line
option that turns checker errors into warnings, so type-checking errors
will not cause <span style="font-family:monospace">javac</span> to exit with a failure status.</p>
<!--TOC subsection id="faq-100-warnings" Why does the checker always say there are 100 errors or warnings?-->
<h3 id="faq-100-warnings" class="subsection">33.4.6&#XA0;&#XA0;Why does the checker always say there are 100 errors or warnings? <a href="#faq-100-warnings" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>By default, javac only reports the first 100 errors or warnings.
Furthermore, once javac encounters an error, it doesn&#X2019;t try compiling any
more files (but does complete compilation of all the ones that it has
started so far).</p><p>To see more than 100 errors or warnings, use the javac options <span style="font-family:monospace">-Xmaxerrs</span>
and <span style="font-family:monospace">-Xmaxwarns</span>. To convert Checker Framework errors into warnings so
that javac will process all your source files, use the option <span style="font-family:monospace">-Awarns</span>.
See Section&#XA0;<a href="#running">2.2</a> for more details.</p>
<!--TOC subsection id="faq-type-i-did-not-write" Why does the Checker Framework report an error regarding a type I have not written in my program?-->
<h3 id="faq-type-i-did-not-write" class="subsection">33.4.7&#XA0;&#XA0;Why does the Checker Framework report an error regarding a type I have not written in my program? <a href="#faq-type-i-did-not-write" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Sometimes, a Checker Framework warning message will mention a type you have
not written in your program. This is typically because a default has been
applied where you did not write a type; see Section&#XA0;<a href="#defaults">26.5</a>. In
other cases, this is because type refinement has given an
expression a more specific type than you wrote or than was defaulted; see
Section&#XA0;<a href="#type-refinement">26.7</a>.
Note that an invocation of an impure method may cause the loss of all
information that was determined via type refinement; see
Section&#XA0;<a href="#type-refinement-purity">26.7.5</a>.</p>
<!--TOC subsection id="faq-same-code-different-behavior" Why does the Checker Framework accept code on one line but reject it on the next?-->
<h3 id="faq-same-code-different-behavior" class="subsection">33.4.8&#XA0;&#XA0;Why does the Checker Framework accept code on one line but reject it on the next? <a href="#faq-same-code-different-behavior" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Sometimes, the Checker Framework permits code on one line, but rejects the
same code a few lines later:</p><pre class="verbatim">  if (myField != null) {
    myField.hashCode();   // no warning
    someMethod();
    myField.hashCode();   // warning about potential NullPointerException
  }
</pre><p>The reason is explained in the section on type refinement
(Section&#XA0;<a href="#type-refinement">26.7</a>), which also tells how to specify the side
effects of <span style="font-family:monospace">someMethod</span> (Section&#XA0;<a href="#type-refinement-purity">26.7.5</a>).</p>
<!--TOC subsection id="faq-run-time-checking" How can I do run-time monitoring of properties that were not statically checked?-->
<h3 id="faq-run-time-checking" class="subsection">33.4.9&#XA0;&#XA0;How can I do run-time monitoring of properties that were not statically checked? <a href="#faq-run-time-checking" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Some properties are not checked statically (see
Chapter&#XA0;<a href="#suppressing-warnings">27</a> for reasons that code might not be
statically checked). In such cases, it would be desirable to check the
property dynamically, at run time.
Currently, the Checker Framework has no support for adding code to perform
run-time checking.</p><p>Adding such support would be an interesting and valuable project.
An example would be an option that causes the Checker Framework to
automatically insert a run-time check anywhere that static checking is
suppressed.
If you
are able to add run-time verification functionality, we would gladly
welcome it as a contribution to the Checker Framework.</p><p>Some checkers have library methods that you can explicitly insert in your
source code.
Examples include the Nullness Checker&#X2019;s
<a href="../api/org/checkerframework/checker/nullness/NullnessUtil.html#castNonNull-T-"><span style="font-family:monospace">NullnessUtil.castNonNull</span></a> method (see
Section&#XA0;<a href="#suppressing-warnings-with-assertions">3.4.1</a>) and the Regex Checker&#X2019;s
<span style="font-family:monospace">RegexUtil</span> class (see Section&#XA0;<a href="#regexutil-methods">11.2.4</a>).
But, it would be better to have more general support that does not require
the user to explicitly insert method calls.</p>
<!--TOC section id="faq-false-positives-section" False positive warnings-->
<h2 id="faq-false-positives-section" class="section">33.5&#XA0;&#XA0;False positive warnings <a href="#faq-false-positives-section" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END -->
<!--TOC subsection id="faq-false-positive" What is a &#X201C;false positive&#X201D; warning?-->
<h3 id="faq-false-positive" class="subsection">33.5.1&#XA0;&#XA0;What is a &#X201C;false positive&#X201D; warning? <a href="#faq-false-positive" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>A &#X201C;false positive&#X201D; is when the tool reports a potential problem, but the
code is actually correct and will never violate the given property at run
time.</p><p>The Checker Framework aims to be sound; that is, if the Checker Framework
does not report any possible errors, then your code is correct.</p><p>Every sound tool suffers false positive errors.
Wherever the Checker Framework issues an error, you can think of it as
saying, &#X201C;I can&#X2019;t prove this code is safe,&#X201D; but the code might be safe for
some complex, tricky reason that is beyond the capabilities of its
analysis.</p><p>If you are sure that the warning is a false positive, you have several
options.
Perhaps you just need to write annotations, especially on method signatures
but perhaps within method bodies as well.
Sometimes you can rewrite the code in a clearer way that the Checker
Framework can verify, and that might be easier for people to understand, too.
If these don&#X2019;t work, then you can suppress the warning
(Section&#XA0;<a href="#handling-warnings">2.4.5</a>).
You also might want to report
the false positive in the Checker Framework issue tracker
(Section&#XA0;<a href="#reporting-bugs">34.2</a>), if it appears in real-world, well-written code.
Finally, you could improve the Checker Framework to make it more
precise, so that it does not suffer that false positive (see
Section&#XA0;<a href="#faq-false-positive-extend-checker-framework">33.5.2</a>).</p>
<!--TOC subsection id="faq-false-positive-extend-checker-framework" How can I improve the Checker Framework to eliminate a false positive warning?-->
<h3 id="faq-false-positive-extend-checker-framework" class="subsection">33.5.2&#XA0;&#XA0;How can I improve the Checker Framework to eliminate a false positive warning? <a href="#faq-false-positive-extend-checker-framework" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>As noted in Section&#XA0;<a href="#faq-false-positive">33.5.1</a>, <em>every</em> sound analysis
tool suffers false positives.</p><p>For any given false positive warning, it is theoretically possible to
improve the Checker Framework to eliminate it. (But, it&#X2019;s theoretically
impossible to eliminate all false positives. That is, there
will always exist some programs that don&#X2019;t go wrong at run time but for
which the Checker Framework issues a warning.)</p><p>Some improvements affect the implementation of the type system; they do not
add any new types. Such an improvement is invisible to users, except that
the users suffer fewer false positive warnings. This type of improvement
to the type checker&#X2019;s implementation is often worthwhile.</p><p>Other improvements change the type system or add a new type system.
Defining new types is a powerful way to improve precision, but it is costly
too. A simpler type system is easier for users to understand, less likely
to contain bugs, and more efficient.</p><p>By design, each type system in the Checker Framework has limited
expressiveness. Our goal is to implement enough functionality to handle
common, well-written real-world code, not to cover every possible
situation.</p><p>When reporting bugs, please focus on realistic scenarios. We are sure that
you can make up artificial code that stymies the type-checker! Those bugs
aren&#X2019;t a good use of your time to report nor the maintainers&#X2019; time to
evaluate and fix. When reporting a bug, it&#X2019;s very helpful to minimize it
to give a tiny example that is easy to evaluate and fix, but please also
indicate how it arises in real-world, well-written code.</p>
<!--TOC subsection id="faq-infer-fields" Why doesn&#X2019;t the Checker Framework infer types for fields and method return types?-->
<h3 id="faq-infer-fields" class="subsection">33.5.3&#XA0;&#XA0;Why doesn&#X2019;t the Checker Framework infer types for fields and method return types? <a href="#faq-infer-fields" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Consider the following code. A programmer can tell that all three
invocations of <span style="font-family:monospace">format</span> are safe &#X2014; they never suffer an
<span style="font-family:monospace">IllegalFormatException</span> exception at run time:</p><pre class="verbatim">class MyClass {

  final String field = "%d";

  String method() {
    return "%d";
  }

  void method m() {
    String local = "%d";
    String.format(local, 5);    // Format String Checker verifies the call is safe
    String.format(field, 5);    // Format String Checker warns the call might not be safe
    String.format(method(), 5); // Format String Checker warns the call might not be safe
  }
}
</pre><p>However, the Format String Checker can only verify the first call. It issues a
false positive warning about the second and third calls.</p><p>The Checker Framework can verify all three calls, with no false positive
warnings, if you annotate the type of <span style="font-family:monospace">field</span> and the return type of
<span style="font-family:monospace">method</span> as <span style="font-family:monospace">@Format(INT)</span>.</p><p>By default, the Checker Framework infers types for local variables
(Section&#XA0;<a href="#type-refinement">26.7</a>), but not for fields and method return
types. (The Checker Framework includes a whole-program type inference tool
that infers field and method return types; see
Section&#XA0;<a href="#whole-program-inference">29.3</a>.)
There are several reasons for this design choice.</p><dl class="description"><dt class="dt-description">
<span style="font-weight:bold">Separation of specification from implementation</span></dt><dd class="dd-description">
The designer of an API makes certain promises to clients; these are
codified in the API&#X2019;s specification or contract. The implementation
might return a more specific type today, but the designer does not want
clients to depend on that. For example, a string might happen to be a
regular expression because it contains no characters with special meaning
in regexes, but that is not guaranteed to always be true. It&#X2019;s better
for the programmer to explicitly write the intended specification.</dd><dt class="dt-description"><span style="font-weight:bold">Separate compilation</span></dt><dd class="dd-description">
To infer types for a non-final method, it is necessary to examine every
overriding implementation, so that the method&#X2019;s return type annotation is
compatible with all values that are returned by any overriding
implementation. In general, examining all implementations is impossible,
because clients may override the method. When possible, it is
inconvenient to provide all that source code, and it would slow down the
type-checker.<p>A related issue is that determining which values can be returned by a
method <span style="font-style:italic">m</span> requires analyzing <span style="font-style:italic">m</span>&#X2019;s body, which requires analyzing
all the methods called by <span style="font-style:italic">m</span>, and so forth. This quickly devolves to
analyzing the whole program.
Determining all possible values assigned to a field is equally hard.</p><p>Type-checking is modular &#X2014; it works on one procedure at a time,
examining that procedure and the specifications (not implementations) of
methods that it calls. Therefore, type-checking is fast and can work on
partial programs. The Checker Framework performs modular type-checking,
not a whole-program analysis.</p></dd><dt class="dt-description"><span style="font-weight:bold">Order of compilation</span></dt><dd class="dd-description">
When the compiler is called on class <span style="font-family:monospace">Client</span> and class <span style="font-family:monospace">Library</span>, the
programmer has no control over which class is analyzed first. When the
first class is compiled, it has access only to the signature of the other
class. Therefore, a programmer would see inconsistent results depending
on whether <span style="font-family:monospace">Client</span> was compiled first and had access only to the
declared types of <span style="font-family:monospace">Library</span>, or the <span style="font-family:monospace">Library</span> was compiled first and
the compiler refined the types of its methods and fields before <span style="font-family:monospace">Client</span>
looked them up.</dd><dt class="dt-description"><span style="font-weight:bold">Consistent behavior with or without pluggable type-checking</span></dt><dd class="dd-description">
The <span style="font-family:monospace">.class</span> files produced with or without pluggable type-checking
should specify the same types for all public fields and methods. If
pluggable type-checking changed the those types, then users would be
confused. Depending on how a library was compiled, pluggable
type-checking of a client program would give different results.</dd></dl>
<!--TOC subsection id="faq-relationships-between-variables" Why doesn&#X2019;t the Checker Framework track relationships between variables?-->
<h3 id="faq-relationships-between-variables" class="subsection">33.5.4&#XA0;&#XA0;Why doesn&#X2019;t the Checker Framework track relationships between variables? <a href="#faq-relationships-between-variables" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The Checker Framework estimates the possible run-time value of each
variable, as expressed in a type system. In general, the Checker Framework
does estimate relationships between two variables, except for specific
relationships listed in Section&#XA0;<a href="#java-expressions-as-arguments">26.8</a>.</p><p>For example, the Checker Framework does not track which variables are equal
to one another. The Nullness Checker issues a warning, &#X201C;dereference of
possibly-null reference y&#X201D;, for expression <span style="font-family:monospace">y.toString()</span>:</p><pre class="verbatim">void nullnessExample1(@Nullable Object x) {
    Object y = x;
    if (x != null) {
      System.out.println(y.toString());
    }
  }
</pre><p>Code that checks one variable and then uses a different variable is
confusing and is often considered poor style.</p><p>The Nullness Checker is able to verify the correctness of a small variant
of the program, thanks to type refinement
(Section&#XA0;<a href="#type-refinement">26.7</a>):</p><pre class="verbatim">  void nullnessExample12(@Nullable Object x) {
    if (x != null) {
      Object y = x;
      System.out.println(y.toString());
    }
  }
</pre><p>The difference is that in the first example, nothing was known about <span style="font-family:monospace">x</span> at
the time <span style="font-family:monospace">y</span> was set to it, and so the Nullness Checker recorded no facts
about <span style="font-family:monospace">y</span>. In the second example, the Nullness Checker knew that <span style="font-family:monospace">x</span>
was non-null when <span style="font-family:monospace">y</span> was assigned to it.</p><p>In the future, the Checker Framework could be enriched by tracking which
variables are equal to one another, a technique called &#X201C;copy
propagation&#X201D;.</p><p>This would handle the above examples, but wouldn&#X2019;t handle other examples.
For example, the following code is safe:</p><pre class="verbatim">  void requiresPositive(@Positive int arg) {}

  void intExample1(int x) {
    int y = x*x;
    if (x &gt; 0) {
      requiresPositive(y);
    }
  }

  void intExample2(int x) {
    int y = x*x;
    if (y &gt; 0) {
      requiresPositive(x);
    }
  }
</pre><p>However, the Index Checker (Chapter&#XA0;<a href="#index-checker">8</a>), which defines the
<a href="../api/org/checkerframework/checker/index/qual/Positive.html"><span style="font-family:monospace">@Positive</span></a> type qualifier, issues warnings
saying that it cannot prove that the arguments are <span style="font-family:monospace">@Positive</span>.</p><p>A slight variant of <span style="font-family:monospace">intExample1</span> can be verified:</p><pre class="verbatim">  void intExample1a(int x) {
    if (x &gt; 0) {
      int y = x*x;
      requiresPositive(y);
    }
  }
</pre><p>No variant of <span style="font-family:monospace">intExample2</span> can be verified. It is not worthwhile to make
the Checker Framework more complex and slow by tracking rich properties
such as arbitrary arithmetic.</p><p>As another example of a false positive warning due to arbitrary arithmetic
properties, consider the following code:</p><pre class="verbatim">  void falsePositive2(int arg) {
    Object o;
    if (arg * arg &gt;= arg) { // always true!
      o = new Object();
    }
    o.toString();  // Nullness Checker issues a false positive warning
  }
</pre>
<!--TOC subsection id="faq-path-sensitive" Why isn&#X2019;t the Checker Framework path-sensitive?-->
<h3 id="faq-path-sensitive" class="subsection">33.5.5&#XA0;&#XA0;Why isn&#X2019;t the Checker Framework path-sensitive? <a href="#faq-path-sensitive" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The Checker Framework is not path-sensitive. That is, it maintains one
estimate for each variable, and it assumes at every branch (such as <span style="font-family:monospace">if</span>
statement) that every choice could be taken.</p><p>In the following code, there are two <span style="font-family:monospace">if</span> statements.</p><pre class="verbatim">  void falsePositive1(boolean b) {
    Object o;
    if (b) {
      o = new Object();
    }
    if (b) {
      o.toString();  // Nullness Checker issues a false positive warning
    }
  }
</pre><p>In general, if code has two <span style="font-family:monospace">if</span> statements in succession, then there are
4 possible paths through the code: [true, true], [true, false], [false,
true], and [false, false]. However, for this code only two of those
paths are feasible: namely, [true, true] and [false, false].</p><p>The Checker Framework is not path-sensitive, so it issues a warning.</p><p>The lack of path-sensitivity can be viewed as special case of the fact that
the Checker Framework maintains a single estimate for each variable value,
rather than tracking relationships between multiple variables
(Section&#XA0;<a href="#faq-relationships-between-variables">33.5.4</a>).</p><p>Making the Checker Framework path-sensitive would make it more powerful,
but also much more complex and much slower. We have not yet found this
necessary.</p>
<!--TOC section id="faq-syntax-section" Syntax of type annotations-->
<h2 id="faq-syntax-section" class="section">33.6&#XA0;&#XA0;Syntax of type annotations <a href="#faq-syntax-section" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>There is also a separate FAQ for the type annotations syntax
(<a href="https://checkerframework.org/jsr308/jsr308-faq.html"><span style="font-family:monospace">https://checkerframework.org/jsr308/jsr308-faq.html</span></a>).</p>
<!--TOC subsection id="faq-receiver" What is a &#X201C;receiver&#X201D;?-->
<h3 id="faq-receiver" class="subsection">33.6.1&#XA0;&#XA0;What is a &#X201C;receiver&#X201D;? <a href="#faq-receiver" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The <em>receiver</em> of a method is the <span style="font-family:monospace">this</span> formal parameter, sometimes
also called the &#X201C;current object&#X201D;. Within the method declaration, <span style="font-family:monospace">this</span>
is used to refer to the receiver formal parameter. At a method call, the
receiver actual argument is written before a period and the method name.</p><p>The method <span style="font-family:monospace">compareTo</span> takes <em>two</em> formal parameters. At a call site
like <span style="font-family:monospace">x.compareTo(y)</span>, the two arguments are <span style="font-family:monospace">x</span> and <span style="font-family:monospace">y</span>. It is
desirable to be able to annotate the types of both of the formal
parameters, and doing so is supported by both Java&#X2019;s type annotations
syntax and by the Checker Framework.</p><p>A type annotation on the receiver is treated exactly like a type annotation
on any other formal parameter. At each call site, the type of the argument
must be a consistent with (a subtype of or equal to) the declaration of the
corresponding formal parameter. If not, the type-checker issues a warning.</p><p>Here is an example. Suppose that <span style="font-family:monospace">@A Object</span> is a supertype of <span style="font-family:monospace">@B
Object</span> in the following declaration:</p><pre class="verbatim">  class MyClass {
    void requiresA(@A MyClass this) { ... }
    void requiresB(@B MyClass this) { ... }
  }
</pre><p>Then the behavior of four different invocations is as follows:</p><pre class="verbatim">  @A MyClass myA = ...;
  @B MyClass myB = ...;

  myA.requiresA()    // OK
  myA.requiresB()    // compile-time error
  myB.requiresA()    // OK
  myB.requiresB()    // OK
</pre><p>The invocation <span style="font-family:monospace">myA.requiresB()</span> does not type-check because the actual
argument&#X2019;s type is not a subtype of the formal parameter&#X2019;s type.</p><p>A top-level constructor does not have a receiver. An inner class
constructor does have a receiver, whose type is the same as the containing
outer class. The receiver is distinct from the object being constructed.
In a method of a top-level class, the receiver is named <span style="font-family:monospace">this</span>. In a
constructor of an inner class, the receiver is named <span style="font-family:monospace">Outer.this</span> and the
result is named <span style="font-family:monospace">this</span>.</p><p>A method in an anonymous class has a receiver, but it is not possible to
write the receiver in the formal parameter list because there is no name
for the type of <span style="font-family:monospace">this</span>.</p>
<!--TOC subsection id="faq-annotation-after-type" What is the meaning of an annotation after a type, such as <span style="font-family:monospace">@NonNull Object @Nullable</span>?-->
<h3 id="faq-annotation-after-type" class="subsection">33.6.2&#XA0;&#XA0;What is the meaning of an annotation after a type, such as <span style="font-family:monospace">@NonNull Object @Nullable</span>? <a href="#faq-annotation-after-type" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>In a type such as <span style="font-family:monospace">@NonNull Object @Nullable []</span>, it may appear that the
<span style="font-family:monospace">@Nullable</span> annotation is written <em>after</em> the type <span style="font-family:monospace">Object</span>. In
fact, <span style="font-family:monospace">@Nullable</span> modifies <span style="font-family:monospace">[]</span>. See the next FAQ, about array
annotations (Section&#XA0;<a href="#faq-array-syntax-meaning">33.6.3</a>).</p>
<!--TOC subsection id="faq-array-syntax-meaning" What is the meaning of array annotations such as <span style="font-family:monospace">@NonNull Object @Nullable []</span>?-->
<h3 id="faq-array-syntax-meaning" class="subsection">33.6.3&#XA0;&#XA0;What is the meaning of array annotations such as <span style="font-family:monospace">@NonNull Object @Nullable []</span>? <a href="#faq-array-syntax-meaning" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>You should parse this as:
(<span style="font-weight:bold"><span style="font-family:monospace">@NonNull Object</span></span>) (<span style="font-weight:bold"><span style="font-family:monospace">@Nullable []</span></span>).
Each annotation precedes the component of the type that it qualifies.</p><p>Thus,
<span style="font-family:monospace">@NonNull Object @Nullable []</span> is a possibly-null array of non-null
objects. Note that the first token in the type,
&#X201C;<span style="font-family:monospace">@NonNull</span>&#X201D;, applies to the element
type <span style="font-family:monospace">Object</span>, not to the array type as a whole. The annotation <span style="font-family:monospace">@Nullable</span> applies to the
array (<span style="font-family:monospace">[]</span>).</p><p>Similarly,
<span style="font-family:monospace">@Nullable Object @NonNull []</span> is a non-null array of possibly-null
objects.</p><p>Some older tools have inconsistent semantics for annotations on array and
varargs elements. Their semantics is unfortunate and confusing; developers
should convert their code to use type annotations instead.
Section&#XA0;<a href="#declaration-annotations-moved">28.1.1</a> explains how the Checker
Framework handles declaration annotations in the meanwhile.</p>
<!--TOC subsection id="faq-varargs-syntax-meaning" What is the meaning of varargs annotations such as <span style="font-family:monospace">@English String @NonEmpty&#XA0;...</span>?-->
<h3 id="faq-varargs-syntax-meaning" class="subsection">33.6.4&#XA0;&#XA0;What is the meaning of varargs annotations such as <span style="font-family:monospace">@English String @NonEmpty&#XA0;...</span>? <a href="#faq-varargs-syntax-meaning" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Varargs annotations are treated similarly to array annotations.
(A way to remember this is that
when you write a varargs formal parameter such as
<span style="font-family:monospace">void method(String... x) </span><span style="font-family:monospace">{</span><span style="font-family:monospace">}</span>, the Java compiler generates a
method that takes an array of strings; whenever your source code calls the
method with multiple arguments, the Java compiler packages them up into an
array before calling the method.)</p><p>Either of these annotations</p><pre class="verbatim">  void method(String @NonEmpty [] x) {}
  void method(String @NonEmpty ... x) {}
</pre><p>applies to the array: the method takes a non-empty array of strings, or
the varargs list must not be empty.</p><p>Either of these annotations</p><pre class="verbatim">  void method(@English String [] x) {}
  void method(@English String ... x) {}
</pre><p>.
applies to the element type. The annotation documents that the method takes an array of English strings.</p>
<!--TOC subsection id="faq-type-qualifier-on-class-declaration" What is the meaning of a type qualifier at a class declaration?-->
<h3 id="faq-type-qualifier-on-class-declaration" class="subsection">33.6.5&#XA0;&#XA0;What is the meaning of a type qualifier at a class declaration? <a href="#faq-type-qualifier-on-class-declaration" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>See Section&#XA0;<a href="#upper-bound-for-use">26.3</a>.</p>
<!--TOC subsection id="faq-type-qualifier-on-bounds" How are type qualifiers written on upper and lower bounds?-->
<h3 id="faq-type-qualifier-on-bounds" class="subsection">33.6.6&#XA0;&#XA0;How are type qualifiers written on upper and lower bounds? <a href="#faq-type-qualifier-on-bounds" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>See Section&#XA0;<a href="#generics-instantiation">25.1.2</a>.</p>
<!--TOC subsection id="faq-no-annotation-on-types-and-declarations" Why shouldn&#X2019;t a qualifier apply to both types and declarations?-->
<h3 id="faq-no-annotation-on-types-and-declarations" class="subsection">33.6.7&#XA0;&#XA0;Why shouldn&#X2019;t a qualifier apply to both types and declarations? <a href="#faq-no-annotation-on-types-and-declarations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>It is bad style for an annotation to apply to both types and declarations.
In other words, every annotation should have a <span style="font-family:monospace">@Target</span> meta-annotation,
and the <span style="font-family:monospace">@Target</span> meta-annotation should list either only declaration
locations or only type annotations. (It&#X2019;s OK for an annotation to target
both <span style="font-family:monospace">ElementType.TYPE_PARAMETER</span> and <span style="font-family:monospace">ElementType.TYPE_USE</span>, but no
other declaration location along with <span style="font-family:monospace">ElementType.TYPE_USE</span>.)</p><p>Sometimes, it may seem tempting for an annotation to apply to both type
uses and (say) method declarations. Here is a hypothetical example:</p><blockquote class="quote">
&#X201C;Each <span style="font-family:monospace">Widget</span> type may have a <span style="font-family:monospace">@Version</span> annotation.
I wish to prove that versions of widgets don&#X2019;t get assigned to
incompatible variables, and that older code does not call newer code (to
avoid problems when backporting).<p>A <span style="font-family:monospace">@Version</span> annotation could be written like so:</p><pre class="verbatim">  @Version("2.0") Widget createWidget(String value) { ... }
</pre><p><span style="font-family:monospace">@Version("2.0")</span> on the method could mean that the <span style="font-family:monospace">createWidget</span> method
only appears in the 2.0 version. <span style="font-family:monospace">@Version("2.0")</span> on the return type
could mean that the returned <span style="font-family:monospace">Widget</span> should only be used by code that
uses the 2.0 API of <span style="font-family:monospace">Widget</span>. It should be possible to specify these
independently, such as a 2.0 method that returns a value that allows the
1.0 API method invocations.&#X201D;
</p></blockquote><p>Both of these are type properties and should be specified with type
annotations. No method annotation is necessary or desirable. The best way
to require that the receiver has a certain property is to use a type
annotation on the receiver of the method. (Slightly more formally, the
property being checked is compatibility between the annotation on the type
of the formal parameter receiver and the annotation on the type of the
actual receiver.) If you do not know what &#X201C;receiver&#X201D; means, see
Section&#XA0;<a href="#faq-receiver">33.6.1</a>.</p><p>Another example of a type-and-declaration annotation that represents poor
design is JCIP&#X2019;s <span style="font-family:monospace">@GuardedBy</span> annotation&#XA0;[<a href="#Goetz2006">GPB+06</a>]. As discussed
in Section&#XA0;<a href="#lock-jcip-annotations">7.6.1</a>, it means two different things when
applied to a field or a method. To reduce confusion and increase
expressiveness, the Lock Checker (see Chapter&#XA0;<a href="#lock-checker">7</a>) uses the
<span style="font-family:monospace">@Holding</span> annotation for one of these meanings, rather than overloading
<span style="font-family:monospace">@GuardedBy</span> with two distinct meanings.</p><p>A final example of a type-and-declaration annotation is some <span style="font-family:monospace">@Nullable</span>
or <span style="font-family:monospace">@NonNull</span> annotations that are intended to work both with modern tools
that process type annotations and with old tools that were written before
Java had type annotations. Such type-and-declaration annotations were a
temporary measure, intended to be used until the tool supported Java 8, and
should not be necessary any longer.</p>
<!--TOC subsection id="faq-annotate-fully-qualified-name" How do I annotate a fully-qualified type name?-->
<h3 id="faq-annotate-fully-qualified-name" class="subsection">33.6.8&#XA0;&#XA0;How do I annotate a fully-qualified type name? <a href="#faq-annotate-fully-qualified-name" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>If you write a fully-qualified type name in your program, then the Java
language requires you to write a type annotation on the simple name part,
such as
</p><pre class="verbatim">  entity.hibernate. @Nullable User x;
</pre><p>If you try to write the type annotation before the entire fully-qualified
name, such as
</p><pre class="verbatim">  @Nullable entity.hibernate.User x;  // illegal Java syntax
</pre><p>then you will get an error like one of the following:
</p><pre class="verbatim">error: scoping construct for static nested type cannot be annotated
error: scoping construct cannot be annotated with type-use annotation
</pre>
<!--TOC subsection id="faq-type-vs-declaration-annotations" What is the difference between type annotations and declaration annotations?-->
<h3 id="faq-type-vs-declaration-annotations" class="subsection">33.6.9&#XA0;&#XA0;What is the difference between type annotations and declaration annotations? <a href="#faq-type-vs-declaration-annotations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Java has two distinct varieties of annotation: type annotations and
declaration annotations.</p><p>A <span style="font-weight:bold">type annotation</span> can be written on any use of a <span style="font-weight:bold">type</span>.
It conceptually creates a new, more specific type.
That is, it describes what values the type represents.</p><p>As an example, the <span style="font-family:monospace">int</span> type contains these values: ..., -2, -1, 0, 1, 2, ... <br>
The <span style="font-family:monospace">@Positive int</span> type contains these values: 1, 2, ... <br>
Therefore, <span style="font-family:monospace">@Positive int</span> is a subtype of <span style="font-family:monospace">int</span>.</p><p>A <span style="font-weight:bold">declaration annotation</span> can be written on any <span style="font-weight:bold">declaration</span> (a class, method, or variable). It describes the thing being declared, but does not describe run-time values. Here are examples of declaration annotations:</p><pre class="verbatim">    @Deprecated    // programmers should not use this class
    class MyClass { ... }

    @Override      // this method overrides a method in a supertype
    void myMethod() { ... }

    @SuppressWarnings(...) // compiler should not warn about the initialization expr
    int myField = INITIALIZATION-EXPRESSION;
</pre><p>Here are examples that use both a declaration annotation and a type annotation:</p><pre class="verbatim">    @Override
    @Regex String getPattern() { ... }

    @GuardedBy("myLock")
    @NonNull String myField;
</pre><p>Note that the type annotation describes the value, and the declaration annotation says something about the method or use of the field.</p><p>As a matter of style, declaration annotations are written on their own line, and type annotations are written directly before the type, on the same line.</p>
<!--TOC section id="faq-semantics-section" Semantics of type annotations-->
<h2 id="faq-semantics-section" class="section">33.7&#XA0;&#XA0;Semantics of type annotations <a href="#faq-semantics-section" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END -->
<!--TOC subsection id="faq-typestate" How can I handle typestate, or phases of my program with different data properties?-->
<h3 id="faq-typestate" class="subsection">33.7.1&#XA0;&#XA0;How can I handle typestate, or phases of my program with different data properties? <a href="#faq-typestate" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Sometimes, your program works in phases that have different behavior. For
example, you might have a field that starts out null and becomes non-null
at some point during execution, such as after a method is called. You can
express this property as follows:</p><ol class="enumerate" type=1><li class="li-enumerate">
Annotate the field type as <a href="../api/org/checkerframework/checker/nullness/qual/MonotonicNonNull.html"><span style="font-family:monospace">@MonotonicNonNull</span></a>.
</li><li class="li-enumerate">Annotate the method that sets the field as <a href="../api/org/checkerframework/checker/nullness/qual/EnsuresNonNull.html"><span style="font-family:monospace">@EnsuresNonNull</span></a><span style="font-family:monospace">("</span><em><span style="font-family:monospace">myFieldName</span></em><span style="font-family:monospace">")</span>.
(If method <span style="font-family:monospace">m1</span> calls method <span style="font-family:monospace">m2</span>, which actually sets the field, then
you would probably write this annotation on both <span style="font-family:monospace">m1</span> and <span style="font-family:monospace">m2</span>.)
</li><li class="li-enumerate">Annotate any method that depends on the field being non-null as
<a href="../api/org/checkerframework/checker/nullness/qual/RequiresNonNull.html"><span style="font-family:monospace">@RequiresNonNull</span></a><span style="font-family:monospace">("</span><em><span style="font-family:monospace">myFieldName</span></em><span style="font-family:monospace">")</span>.
The type-checker will verify that such a method is only called when the
field isn&#X2019;t null &#X2014; that is, the method is only called after the setting
method.
</li></ol><p>You can also use a typestate checker (see
Chapter&#XA0;<a href="#typestate-checker">24.1</a>), but they have not been as extensively
tested.</p>
<!--TOC subsection id="faq-implicit-bounds" Why are explicit and implicit bounds defaulted differently?-->
<h3 id="faq-implicit-bounds" class="subsection">33.7.2&#XA0;&#XA0;Why are explicit and implicit bounds defaulted differently? <a href="#faq-implicit-bounds" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The following two bits of code have the same semantics under Java, but are
treated differently by the Checker Framework&#X2019;s CLIMB-to-top defaulting
rules (Section&#XA0;<a href="#climb-to-top">26.5.3</a>):</p><pre class="verbatim">class MyClass&lt;T&gt; { ... }
class MyClass&lt;T extends Object&gt; { ... }
</pre><p>The difference is the annotation on the upper bound of the type argument
<span style="font-family:monospace">T</span>. They are treated in the following way.</p><pre class="verbatim">class MyClass&lt;T&gt;                 ==  class MyClass&lt;T extends @TOPTYPEANNO Object&gt;
class MyClass&lt;T extends Object&gt;  ==  class MyClass&lt;T extends @DEFAULTANNO Object&gt;
</pre><p><span style="font-family:monospace">@TOPTYPEANNO</span> is the top annotation in the type qualifier hierarchy. For
example, for the nullness type system, the top type annotation is
<span style="font-family:monospace">@Nullable</span>, as shown in Figure&#XA0;<a href="#fig-nullness-hierarchy">3.1</a>.
<span style="font-family:monospace">@DEFAULTANNO</span> is the default annotation for the type system. For
example, for the nullness type system, the default type annotation is
<span style="font-family:monospace">@NonNull</span>.</p><p>In some type systems, the top qualifier and the default are the same. For
such type systems, the two code snippets shown above are treated the same.
An example is the regular expression type system; see
Figure&#XA0;<a href="#fig-regex-hierarchy">11.1</a>.</p><p>The CLIMB-to-top rule reduces the code edits required to annotate an
existing program, and it treats types written in the program consistently.</p><p>When a user writes no upper bound, as in
<span style="font-family:monospace">class C&lt;T&gt; </span><span style="font-family:monospace">{</span><span style="font-family:monospace"> ... </span><span style="font-family:monospace">}</span>,
then Java permits the class to be instantiated with any type parameter.
The Checker Framework behaves exactly the same, no matter what the default
is for a particular type system &#X2014; and no matter whether the user has
changed the default locally.</p><p>When a user writes an upper bound, as in
<span style="font-family:monospace">class C&lt;T extends OtherClass&gt; </span><span style="font-family:monospace">{</span><span style="font-family:monospace"> ... </span><span style="font-family:monospace">}</span>,
then the Checker Framework treats this occurrence of <span style="font-family:monospace">OtherClass</span> exactly
like any other occurrence, and applies the usual defaulting rules. Use of
<span style="font-family:monospace">Object</span> is treated consistently with all other types in this location and
all other occurrences of <span style="font-family:monospace">Object</span> in the program.</p><p>Here are some style guidelines:
</p><ul class="itemize"><li class="li-itemize">
Omit the <span style="font-family:monospace">extends</span> clause when possible. To indicate no constraints on
type qualifiers, write <span style="font-family:monospace">class MyClass&lt;T&gt;</span> rather than <span style="font-family:monospace">class
MyClass&lt;T extends @TOPTYPEANNO Object&gt;</span>.
</li><li class="li-itemize">When you write an <span style="font-family:monospace">Object</span> upper bound, give an explicit type annotation.
That is, write <span style="font-family:monospace">class C&lt;T extends @DEFAULTANNO Object&gt;
</span><span style="font-family:monospace">{</span><span style="font-family:monospace"> ... </span><span style="font-family:monospace">}</span> even though it is equivalent to writing
<span style="font-family:monospace">class C&lt;T extends Object&gt; </span><span style="font-family:monospace">{</span><span style="font-family:monospace"> ... </span><span style="font-family:monospace">}</span>.<p>If you write just <span style="font-family:monospace">extends Object</span>, then someone who is reading the code
might think that it is irrelevant (which it is in plain Java). Also,
some IDEs will suggest removing it.
</p></li></ul>
<!--TOC subsection id="faq-runtime-retention" Why are type annotations declared with <span style="font-family:monospace">@Retention(RetentionPolicy.RUNTIME)</span>?-->
<h3 id="faq-runtime-retention" class="subsection">33.7.3&#XA0;&#XA0;Why are type annotations declared with <span style="font-family:monospace">@Retention(RetentionPolicy.RUNTIME)</span>? <a href="#faq-runtime-retention" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Annotations such as <a href="../api/org/checkerframework/checker/nullness/qual/NonNull.html"><span style="font-family:monospace">@NonNull</span></a> are
declared with
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/annotation/Retention.html"><span style="font-family:monospace">@Retention</span></a><span style="font-family:monospace">(RetentionPolicy.</span><a href="https://docs.oracle.com/javase/8/docs/api/java/lang/annotation/RetentionPolicy.html#RUNTIME"><span style="font-family:monospace">RUNTIME</span></a><span style="font-family:monospace">)</span>. In other words,
these type annotations are available to tools at run time. Such run-time
tools could check the annotations (like an <span style="font-family:monospace">assert</span> statement), type-check
dynamically-loaded code, check casts and <span style="font-family:monospace">instanceof</span> operations, resolve
reflection more precisely, or other tasks that we have not yet thought of.
Not many such tools exist today, but the annotation designers wanted to
accommodate them in the future.</p><p><span style="font-family:monospace">RUNTIME</span> retention has negligible costs (no run-time dependency, minimal
increase in heap size).</p><p>For the purpose of static checking at compile time,
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/annotation/RetentionPolicy.html#CLASS"><span style="font-family:monospace">CLASS</span></a>
retention would be sufficient. Note that
<a href="https://docs.oracle.com/javase/8/docs/api/java/lang/annotation/RetentionPolicy.html#SOURCE"><span style="font-family:monospace">SOURCE</span></a>
retention would not be sufficient, because of separate compilation: when
type-checking a class, the compiler needs to read the annotations on
libraries that it uses, and separately-compiled libraries are available to
the compiler only as class files.</p>
<!--TOC section id="faq-create-a-checker-section" Creating a new checker-->
<h2 id="faq-create-a-checker-section" class="section">33.8&#XA0;&#XA0;Creating a new checker <a href="#faq-create-a-checker-section" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END -->
<!--TOC subsection id="faq-create-a-checker" How do I create a new checker?-->
<h3 id="faq-create-a-checker" class="subsection">33.8.1&#XA0;&#XA0;How do I create a new checker? <a href="#faq-create-a-checker" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>In addition to using the checkers that are distributed with the Checker
Framework, you can write your own checker to check specific properties that
you care about. Thus, you can find and prevent the bugs that are most
important to you.</p><p>Chapter&#XA0;<a href="#creating-a-checker">31</a> gives
complete details regarding how to write a checker. It also suggests places
to look for more help, such as the <a href="../api/">Checker Framework
API documentation (Javadoc)</a> and the source code of the distributed
checkers.</p><p>To whet your interest and demonstrate how easy it is to get started, here
is an example of a complete, useful type-checker.</p><pre class="verbatim">  @SubtypeOf(Unqualified.class)
  @Target({ElementType.TYPE_USE, ElementType.TYPE_PARAMETER})
  public @interface Encrypted {}
</pre><p>Section&#XA0;<a href="#subtyping-example">23.2</a> explains this checker and tells
you how to run it.</p>
<!--TOC subsection id="faq-type-properties" What properties can and cannot be handled by type-checking?-->
<h3 id="faq-type-properties" class="subsection">33.8.2&#XA0;&#XA0;What properties can and cannot be handled by type-checking? <a href="#faq-type-properties" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>In theory, any property about a program can be expressed and checked within
a type system. In practice, types are a good choice for some properties
and a bad choice for others.</p><p>A type expresses the set of possible values for an expression. Therefore,
types are a good choice for any property that is about variable values or
provenance.</p><p>Types are a poor choice for expressing properties about timing, such as
that action B will happen within 10 milliseconds of action A. Types are
not good for verifying the results of calculations; for example, they could
ensure that code always call an <span style="font-family:monospace">encrypt</span> routine in the appropriate
places, but not that the <span style="font-family:monospace">encrypt</span> routine is correctly implemented.
Types are not a good solution for preventing infinite loops, except perhaps
in special cases.</p>
<!--TOC subsection id="faq-declarative-syntax-for-type-rules" Why is there no declarative syntax for writing type rules?-->
<h3 id="faq-declarative-syntax-for-type-rules" class="subsection">33.8.3&#XA0;&#XA0;Why is there no declarative syntax for writing type rules? <a href="#faq-declarative-syntax-for-type-rules" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>A type system implementer can declaratively specify the type qualifier
hierarchy (Section&#XA0;<a href="#creating-declarative-hierarchy">31.4.2</a>) and the type introduction rules
(Section&#XA0;<a href="#creating-type-introduction">31.7</a>). However, the Checker
Framework uses a procedural syntax for specifying type-checking
rules (Section&#XA0;<a href="#creating-extending-visitor">31.6</a>).
A declarative syntax might be more concise, more readable, and more
verifiable than a procedural syntax.</p><p>We have not found the procedural syntax to be the most important impediment
to writing a checker.</p><p>Previous attempts to devise a declarative syntax
for realistic type systems have failed; see a technical
paper&#XA0;[<a href="#PapiACPE2008">PAC+08</a>] for a discussion. When an
adequate syntax exists, then the Checker Framework can be extended to
support it.</p>
<!--TOC section id="faq-tool-section" Tool questions-->
<h2 id="faq-tool-section" class="section">33.9&#XA0;&#XA0;Tool questions <a href="#faq-tool-section" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END -->
<!--TOC subsection id="faq-pluggable-type-checking" How does pluggable type-checking work?-->
<h3 id="faq-pluggable-type-checking" class="subsection">33.9.1&#XA0;&#XA0;How does pluggable type-checking work? <a href="#faq-pluggable-type-checking" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The Checker Framework enables you to define a new type system. It finds
errors, or guarantees their absence, by performing type-checking that is
similar to that already performed by the Java compiler.</p><p>Type-checking examines each statement of your program in turn, one at a time.
</p><ul class="itemize"><li class="li-itemize">
Expressions are processed bottom-up. Given types for each sub-expression,
the type-checker determines whether the types are legal for the
expression&#X2019;s operator and determines the type of the expression.
</li><li class="li-itemize">An assignment is legal if the type of the right-hand side is a subtype of
the declared type of the left-hand side.</li><li class="li-itemize">At a method call, the arguments are legal if they can be assigned to the
formal parameters (this is called a &#X201C;pseudo-assignment&#X201D; and it follows
the normal rules for assignment). The type of the method call is the
declared type of the return type, where the method is declared. If
the method declaration is not annotated, then a default annotation is
used.</li><li class="li-itemize">Suppose that method <span style="font-family:monospace">Sub.m</span> overrides method <span style="font-family:monospace">Super.m</span>.
The return type of <span style="font-family:monospace">Sub.m</span> must be equal to or a subtype of the return
type of <span style="font-family:monospace">Super.m</span> (this is called &#X201C;covariance&#X201D;).
The type of formal parameter <span style="font-style:italic">i</span> of <span style="font-family:monospace">Sub.m</span> must be equal to or a
<em>super</em>type of the type of formal parameter <span style="font-style:italic">i</span> in <span style="font-family:monospace">Super.m</span> (this
is called &#X201C;contravariance&#X201D;).</li></ul>
<!--TOC subsection id="faq-classpath-to-use-annotated-library" What classpath is needed to use an annotated library?-->
<h3 id="faq-classpath-to-use-annotated-library" class="subsection">33.9.2&#XA0;&#XA0;What classpath is needed to use an annotated library? <a href="#faq-classpath-to-use-annotated-library" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Suppose that you distribute a library, which contains Checker Framework
annotations such as <span style="font-family:monospace">@Nullable</span>. This enables clients of the library to
use the Checker Framework to type-check their programs. To do so, they
must have the Checker Framework annotations on their classpath, for
instance by using the Checker Framework Compiler.</p><p>Clients who do not wish to perform pluggable type-checking do not need to
have the Checker Framework annotations
(<span style="font-family:monospace">checker-qual.jar</span>) in their classpath, either when compiling or running
their programs.</p><p>The JVM does not issue a link error if an annotation is not found when a
class is loaded. (By contrast, the JVM does issue a link error if a
superclass, or a parameter/return/field type, is not found.)
Likewise, there is no problem compiling against a library even if the
library&#X2019;s annotations are not on the classpath.
These are properties of Java, and are not specific to the Checker
Framework&#X2019;s annotations.</p>
<!--TOC subsection id="faq-classfile-annotations" Why do <span style="font-family:monospace">.class</span> files contain more annotations than the source code?-->
<h3 id="faq-classfile-annotations" class="subsection">33.9.3&#XA0;&#XA0;Why do <span style="font-family:monospace">.class</span> files contain more annotations than the source code? <a href="#faq-classfile-annotations" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>You may notice annotations such as <span style="font-family:monospace">@Pure</span> and <span style="font-family:monospace">@SideEffectFree</span> in
compiled <span style="font-family:monospace">.class</span> files even though the source code contains no
annotations. These annotations are propagated from annotated libraries,
such as the JDK, to your code.</p><p>When an overridden method has a side effect annotation, the overriding
method must have one too. If you do not write one explicitly, the Checker
Framework could issue a warning, or it could automatically add the missing
annotation. It does the latter, for annotations declared with the
<a href="../api/org/checkerframework/framework/qual/InheritedAnnotation.html"><span style="font-family:monospace">@InheritedAnnotation</span></a> meta-annotation.</p><p>In addition, defaulted and inferred type qualifiers are written into
<span style="font-family:monospace">.class</span> files; see Section&#XA0;<a href="#effective-qualifier">26.4</a>.</p>
<!--TOC subsection id="faq-checked-exceptions" Is there a type-checker for managing checked and unchecked exceptions?-->
<h3 id="faq-checked-exceptions" class="subsection">33.9.4&#XA0;&#XA0;Is there a type-checker for managing checked and unchecked exceptions? <a href="#faq-checked-exceptions" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>It is possible to annotate exception types, and any type-checker built on the
Checker Framework enforces that type annotations are consistent between
<span style="font-family:monospace">throw</span> statements and <span style="font-family:monospace">catch</span> clauses that might catch them.</p><p>The Java compiler already enforces that all checked exceptions are caught
or are declared to be passed through, so you would use annotations to
express other properties about exceptions.</p><p>Checked exceptions are an example of a &#X201C;type and effect&#X201D; system, which is
like a type system but also accounts for actions/behaviors such as side
effects. The GUI Effect Checker (Chapter&#XA0;<a href="#guieffect-checker">16</a>) is a
type-and-effect system that is distributed with the Checker Framework.</p>
<!--TOC section id="faq-other-tools-section" Relationship to other tools-->
<h2 id="faq-other-tools-section" class="section">33.10&#XA0;&#XA0;Relationship to other tools <a href="#faq-other-tools-section" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END -->
<!--TOC subsection id="faq-type-checking-vs-bug-detectors" Why not just use a bug detector (like FindBugs or Error Prone)?-->
<h3 id="faq-type-checking-vs-bug-detectors" class="subsection">33.10.1&#XA0;&#XA0;Why not just use a bug detector (like FindBugs or Error Prone)? <a href="#faq-type-checking-vs-bug-detectors" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>A pluggable type-checker
is a verification tool that prevents or detects all errors of a given
variety. If it issues no warnings, your code has no errors of a given
variety (for details about the guarantee, see
Section&#XA0;<a href="#checker-guarantees">2.3</a>).</p><p>An alternate approach is to use a bug detector such as
<a href="https://errorprone.info//">Error Prone</a>,
<a href="http://findbugs.sourceforge.net/">FindBugs</a>&#XA0;[<a href="#HovemeyerP2004">HP04</a>, <a href="#HovemeyerSP2005">HSP05</a>],
<a href="http://jlint.sourceforge.net/">Jlint</a>&#XA0;[<a href="#Artho2001">Art01</a>], or
<a href="https://pmd.github.io/">PMD</a>&#XA0;[<a href="#Copeland2005">Cop05</a>], or the
tools built into Eclipse (see Section&#XA0;<a href="#faq-eclipse">33.10.2</a>) and IntelliJ.</p><p>A pluggable type-checker or verifier
differs from a bug detector in several ways:
</p><ul class="itemize"><li class="li-itemize">
A type-checker reports <em>all</em> errors in your code. If a type-checker
reports no warnings, then you have a guarantee (a proof) of correctness
(Section&#XA0;<a href="#faq-no-absolute-guarantee">33.4.3</a>).<p>A bug detector aims to find <em>some</em> of the most obvious errors. Even
if a bug detector reports no warnings, there may still be errors in your
code.</p></li><li class="li-itemize">A type-checker requires you to annotate your code with type qualifiers,
or to run an inference tool that does so for you. That is, it requires
you to write a specification, then it verifies that your code meets its
specification.<p>Some bug detectors do not require annotations. This means that it may be
easier to get started running a bug detector. The tool makes guesses
about the intended behavior of your code, leading to false alarms or
missed alarms.</p></li><li class="li-itemize">A verification tool may issue more warnings for a programmer to
investigate. Some bug detectors internally generate many warnings, then
use heuristics to discard some of them. The cost is missed alarms, when
the tool&#X2019;s heuristics classified the warnings as likely false positives
and discarded them.</li><li class="li-itemize">A type-checker uses a more sophisticated and precise analysis. For
example, it can take advantage of method annotations and annotations on
generic type parameters, such as <span style="font-family:monospace">List&lt;@NonNull String&gt;</span>. An
example specific to the Nullness Checker (Section&#XA0;<a href="#nullness-checker">3</a>,
no other tool correctly handles map keys or initialization.<p>A bug detector does a more lightweight analysis. This means that a bug
detector usually runs faster, giving feedback to the programmer more
rapidly and avoiding slowdowns. Its analysis is often narrow, avoiding
properties that are tricky to reason about or that might lead to false
alarms. The cost is missed alarms, when analysis is too weak to find the
errors.</p></li><li class="li-itemize">Neither type checking nor bug detection subsumes the other. A
type-checker finds problems that a bug detector cannot. A bug detector
finds problems that a type-checker does not: there is no need for the
type-checker to address style rules, when a bug detector is adequate.<p>If your code is important to you, it is advantageous to run both types of
tools.</p></li></ul><p>For a case study that compared the nullness analysis of FindBugs, Jlint,
PMD, and the Checker Framework, see section 6 of the paper
<a href="https://homes.cs.washington.edu/~mernst/pubs/pluggable-checkers-issta2008.pdf">&#X201C;Practical pluggable types for Java&#X201D;</a>&#XA0;[<a href="#PapiACPE2008">PAC+08</a>].
The case study was on a well-tested program in daily use. The Checker
Framework tool found 8 nullness errors (that is, null pointer
dereferences). None of the other tools found any errors. A follow-up 10
years later found that Eclipse&#X2019;s and IntelliJ&#X2019;s nullness analyses found 0
and 3 out of the 9 errors that the Nullness Checker found.</p><p>The
<a href="https://checkerframework.org/jsr308/">JSR 308</a>&#XA0;[<a href="#JSR308-2008-09-12">Ern08</a>]
documentation also contains a discussion of related work.</p>
<!--TOC subsection id="faq-eclipse" How does the Checker Framework compare with Eclipse&#X2019;s null analysis?-->
<h3 id="faq-eclipse" class="subsection">33.10.2&#XA0;&#XA0;How does the Checker Framework compare with Eclipse&#X2019;s null analysis? <a href="#faq-eclipse" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Eclipse comes with a
<a href="http://help.eclipse.org/luna/index.jsp?topic=%2Forg.eclipse.jdt.doc.user%2Ftasks%2Ftask-using_null_annotations.htm">null analysis</a> that
can detect potential null pointer errors in your code. Eclipse&#X2019;s built-in
analysis differs from the Checker Framework in several respects.</p><p>The Checker Framework&#X2019;s Nullness Checker
(see&#XA0;Chapter&#XA0;<a href="#nullness-checker">3</a>) is more precise: it does a deeper
semantic analysis, so it issues fewer false positives than Eclipse.
Eclipse&#X2019;s nullness analysis is missing many features that the Checker
Framework supports, such as handling of map keys, partially-initialized
objects, method pre- and post-conditions, polymorphism, and a powerful
dataflow analysis. These are essential for practical verification of
real-world code without poor precision.
Furthermore, Eclipse by default ignores unannotated code (even unannotated
parameters within a method that contains other annotations).
As a result, Eclipse is more useful for bug-finding than for verification,
and that is what the Eclipse documentation recommends.
</p><p>Eclipse assumes by default that all code is multi-threaded, which cripples its local
type inference. (This default can be turned off, however.)
The Checker Framework allows the user to
specify whether code will be run concurrently or not via the
<span style="font-family:monospace">-AconcurrentSemantics</span> command-line option (see
Section&#XA0;<a href="#faq-concurrency">33.4.4</a>).</p><p>The Checker Framework builds on javac, so it is easier to run in
integration scripts or in
environments where not all developers have installed Eclipse.
</p><p>Eclipse handles only nullness properties and is not extensible, whereas the
Checker Framework comes with over 20 type-checkers (for a list,
see&#XA0;Chapter&#XA0;<a href="#introduction">1</a>) and is extensible to more properties.</p><p>There are also some benefits to Eclipse&#X2019;s null analysis.
It is faster than the Checker Framework, in part because it is less featureful.
It is built into Eclipse, so you do not have to add it to your build scripts.
Its IDE integration is tighter and slicker.</p><p>In a case study, the Nullness Checker found 9 errors in a program, and
Eclipse&#X2019;s analysis found 0.</p>
<!--TOC subsection id="faq-nullaway" How does the Checker Framework compare with NullAway?-->
<h3 id="faq-nullaway" class="subsection">33.10.3&#XA0;&#XA0;How does the Checker Framework compare with NullAway? <a href="#faq-nullaway" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p><a href="https://github.com/uber/NullAway">NullAway</a> is a lightweight, unsound
type-checker whose aim is similar to that of the Nullness Checker
(Chapter&#XA0;<a href="#nullness-checker">3</a>). For both tools, the user writes
nullness annotations, and then the tool checks them.</p><p>NullAway is faster than the Nullness Checker and requires fewer annotations.</p><p>NullAway is unsound: even if NullAway issues no warnings, your code might
crash with a null pointer exception. Two differences are that NullAway
makes unchecked assumptions about getter methods and NullAway assumes all
objects are always fully initialized. NullAway forces all generic
arguments to be non-null, which is not an unsoundness but is less flexible
than the Nullness Checker.</p>
<!--TOC subsection id="faq-optional" How does the Checker Framework compare with the JDK&#X2019;s <span style="font-family:monospace">Optional</span> type?-->
<h3 id="faq-optional" class="subsection">33.10.4&#XA0;&#XA0;How does the Checker Framework compare with the JDK&#X2019;s <span style="font-family:monospace">Optional</span> type? <a href="#faq-optional" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>JDK 8 introduced the <a href="https://docs.oracle.com/javase/8/docs/api/java/util/Optional.html"><span style="font-family:monospace">Optional</span></a>
class, a container that is either empty or contains a non-null value.
The Optional Checker (see Chapter&#XA0;<a href="#optional-checker">5</a>) guarantees that
programmers use <span style="font-family:monospace">Optional</span> correctly.</p><p>Section&#XA0;<a href="#nullness-vs-optional">3.7.3</a> explains the relationship between
nullness and <span style="font-family:monospace">Optional</span> and the benefits of each.</p>
<!--TOC subsection id="faq-jml" How does pluggable type-checking compare with JML?-->
<h3 id="faq-jml" class="subsection">33.10.5&#XA0;&#XA0;How does pluggable type-checking compare with JML? <a href="#faq-jml" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p><a href="http://www.eecs.ucf.edu/~leavens/JML//index.shtml">JML</a>, the Java Modeling
Language&#XA0;[<a href="#LeavensBR2006%3AJML">LBR06</a>], is a language for writing formal
specifications.</p><p><span style="font-weight:bold">JML aims to be more expressive than pluggable type-checking.</span>
A programmer can write a JML specification that
describes arbitrary facts about program behavior. Then, the programmer can
use formal reasoning or a theorem-proving tool to verify that the code
meets the specification. Run-time checking is also possible.
By contrast, pluggable type-checking can express a more limited set of
properties about your program. Pluggable type-checking annotations are
more concise and easier to understand.</p><p><span style="font-weight:bold">JML is not as practical as pluggable type-checking.</span>
The JML toolset is less mature. For instance, if your code uses
generics or other features of Java 5, then you cannot use JML.
However, JML has a run-time checker, which the Checker Framework currently
lacks.</p>
<!--TOC subsection id="faq-checker-framework-part-of-java" Is the Checker Framework an official part of Java?-->
<h3 id="faq-checker-framework-part-of-java" class="subsection">33.10.6&#XA0;&#XA0;Is the Checker Framework an official part of Java? <a href="#faq-checker-framework-part-of-java" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>The Checker Framework is not an official part of Java.
The Checker Framework relies on
type annotations, which are part of Java 8. See the
<a href="https://checkerframework.org/jsr308/jsr308-faq.html#pluggable-type-checking-in-java">Type
Annotations (JSR 308) FAQ</a> for more details.</p>
<!--TOC subsection id="faq-jsr-305" What is the relationship between the Checker Framework and JSR 305?-->
<h3 id="faq-jsr-305" class="subsection">33.10.7&#XA0;&#XA0;What is the relationship between the Checker Framework and JSR 305? <a href="#faq-jsr-305" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>JSR 305 aimed to define official Java names for some annotations, such as
<span style="font-family:monospace">@NonNull</span> and <span style="font-family:monospace">@Nullable</span>. However, it did not aim to precisely define
the semantics of those annotations nor to provide a reference
implementation of an annotation processor that validated their use;
as a result, JSR 305 was of limited utility as a specification.
JSR 305 has been abandoned; there has been
no activity by its expert group since
2009.</p><p>By contrast, the Checker Framework precisely defines the meaning of a set
of annotations and provides powerful type-checkers that validate them.
However, the Checker Framework is not an official part of the Java
language; it chooses one set of names, but another tool might choose other
names.</p><p>In the future, the Java Community Process might revitalize JSR 305 or
create a replacement JSR to standardize the names and
meanings of specific annotations, after there is more experience with their
use in practice.</p><p>The Checker Framework defines annotations <span style="font-family:monospace">@NonNull</span> and <span style="font-family:monospace">@Nullable</span> that
are compatible with annotations defined by JSR 305, FindBugs, IntelliJ, and
other tools; see Section&#XA0;<a href="#nullness-related-work">3.7</a>.</p>
<!--TOC subsection id="faq-jsr-308" What is the relationship between the Checker Framework and JSR 308?-->
<h3 id="faq-jsr-308" class="subsection">33.10.8&#XA0;&#XA0;What is the relationship between the Checker Framework and JSR 308? <a href="#faq-jsr-308" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>JSR 308, also known as the Type Annotations specification, dictates the
syntax of type annotations in Java SE 8: how they are expressed in the
Java language.</p><p>JSR 308 does not define any type annotations such as <span style="font-family:monospace">@NonNull</span>, and it does
not specify the semantics of any annotations. Those tasks are left to
third-party tools. The Checker Framework is one such tool.</p><hr>
<!--TOC chapter id="troubleshooting" Troubleshooting, getting help, and contributing-->
<h1 id="troubleshooting" class="chapter">Chapter&#XA0;34&#XA0;&#XA0;Troubleshooting, getting help, and contributing <a href="#troubleshooting" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h1><!--SEC END --><p>
The manual might already answer your question, so first please look for
your answer in the manual,
including this chapter and the FAQ (Chapter&#XA0;<a href="#faq">33</a>).
If not, you can use the mailing list,
<span style="font-family:monospace">checker-framework-discuss@googlegroups.com</span>, to ask other users for
help. For archives and to subscribe, see <a href="https://groups.google.com/forum/#!forum/checker-framework-discuss"><span style="font-family:monospace">https://groups.google.com/forum/#!forum/checker-framework-discuss</span></a>.
To report bugs, please see Section&#XA0;<a href="#reporting-bugs">34.2</a>.
If you want to help out, you can give feedback (including on the
documentation), choose a bug and fix it, or select a
project from the ideas list at
<a href="https://rawgit.com/typetools/checker-framework/master/docs/developer/gsoc-ideas.html"><span style="font-family:monospace">https://rawgit.com/typetools/checker-framework/master/docs/developer/gsoc-ideas.html</span></a>.
</p>
<!--TOC section id="common-problems" Common problems and solutions-->
<h2 id="common-problems" class="section">34.1&#XA0;&#XA0;Common problems and solutions <a href="#common-problems" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><ul class="itemize"><li class="li-itemize">
To verify that you are using the compiler you think you are, you can add
<span style="font-family:monospace">-version</span> to the command line. For instance, instead of running
<span style="font-family:monospace">javac -g MyFile.java</span>, you can run <span style="font-family:monospace">javac </span><span style="font-family:monospace"><U>-version</U></span><span style="font-family:monospace"> -g
MyFile.java</span>. Then, javac will print out its version number in addition
to doing its normal processing.</li></ul>
<!--TOC subsection id="common-problems-compiling" Unable to compile the Checker Framework-->
<h3 id="common-problems-compiling" class="subsection">34.1.1&#XA0;&#XA0;Unable to compile the Checker Framework <a href="#common-problems-compiling" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>If you get the following error while compiling the Checker Framework itself:</p><pre class="verbatim">checker-framework/stubparser/dist/stubparser.jar(org/checkerframework/stubparser/ast/CompilationUnit.class):
warning: [classfile] Signature attribute introduced in version 49.0 class files is ignored in version 46.0 class files
</pre><p>and you have used Eclipse to compile the Checker Framework, then probably
you are using a very old version of Eclipse. (If you
install Eclipse from the Ubuntu 16.04 repository, you get Eclipse version
3.8. Ubuntu 16.04 was released in April 2016, and Eclipse 3.8 was released
in June 2012, with subsequent major releases in June 2013, June 2014, and
June 2015.)
Install the latest version of Eclipse and use it instead.</p>
<!--TOC subsection id="common-problems-running" Unable to run the checker, or checker crashes-->
<h3 id="common-problems-running" class="subsection">34.1.2&#XA0;&#XA0;Unable to run the checker, or checker crashes <a href="#common-problems-running" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>If you are unable to run the checker, or if the checker or the compiler
terminates with an error, then the problem may be a problem with your environment.
(If the checker or the compiler crashes, that is a bug in the Checker
Framework; please report it. See Section&#XA0;<a href="#reporting-bugs">34.2</a>.)
This section describes some possible problems and solutions.</p><ul class="itemize"><li class="li-itemize">
If you get the error<pre class="verbatim">com.sun.tools.javac.code.Symbol$CompletionFailure: class file for com.sun.source.tree.Tree not found
</pre><p>then you are using the source installation and file <span style="font-family:monospace">tools.jar</span> is not
on your classpath. See the installation instructions
(Section&#XA0;<a href="#installation">1.3</a>).</p></li><li class="li-itemize">If you get an error like one of the following,<pre class="verbatim">...\build.xml:59: Error running ${env.CHECKERFRAMEWORK}\checker\bin\javac.bat compiler
</pre><pre class="verbatim">.../bin/javac: Command not found
</pre><p>then the problem may be that you have not set the <span style="font-family:monospace">CHECKERFRAMEWORK</span> environment
variable, as described in Section&#XA0;<a href="#javac-installation">32.8</a>. Or, maybe
you made it a user variable instead of a system variable.</p></li><li class="li-itemize">If you get one of these errors:<pre>
The hierarchy of the type <em>ClassName</em> is inconsistent

The type com.sun.source.util.AbstractTypeProcessor cannot be resolved.
  It is indirectly referenced from required .class files
</pre><p>
then you are likely <span style="font-weight:bold">not</span> using the Checker Framework compiler. Use
either <span style="font-family:monospace">$CHECKERFRAMEWORK/checker/bin/javac</span> or one of the alternatives
described in Section&#XA0;<a href="#javac-installation">32.8</a>.
</p></li><li class="li-itemize">If you get the error<pre class="verbatim">  java.lang.ArrayStoreException: sun.reflect.annotation.TypeNotPresentExceptionProxy
</pre><p>If you get an error such as</p><pre class="verbatim">  java.lang.NoClassDefFoundError: java/util/Objects
</pre><p>then you are trying to run the compiler using a JDK 6 or earlier JVM.
Install and use a Java 8
JDK, at least for running the Checker
Framework.</p><p>then an annotation is not present at run time that was present at compile
time. For example, maybe when you compiled the code, the <span style="font-family:monospace">@Nullable</span>
annotation was available, but it was not available at run time.
You can use JDK 8 at run time.</p></li><li class="li-itemize"><a id="troubleshooting-class-file-not-found"></a>
A &#X201C;class file for &#X2026; not found&#X201D; error, especially for an inner class
in the JDK, is probably due to a JDK version mismatch. To solve the
problem, you need to perform compilation with a different Java version or
different version of the JDK.<p>In general, Java issues a &#X201C;class file for &#X2026; not found&#X201D; error when
your classpath contains code that was compiled
with some library, but your classpath does not contain that library itself.</p><p>For example, suppose that when you run the compiler, you are using JDK 8,
but some library on your classpath was compiled against JDK 6 or 7, and the
compiled library refers to a class that only appears in JDK 6 or 7. (If only
one version of Java existed, or the Checker Framework didn&#X2019;t try to support
multiple different versions of Java, this would not be a problem.)</p><p>Examples of classes that were removed from the JDK include:</p><pre class="verbatim">  class file for java.io.File$LazyInitialization not found  -- removed in JDK 7
  class file for java.util.Hashtable$EmptyIterator not found  -- removed in JDK 7
  java.lang.NoClassDefFoundError: java/util/Hashtable$EmptyEnumerator  -- removed in JDK 7
  class file for java.util.TimeZone$DisplayNames not found  -- removed in JDK 8
</pre><p>Examples of classes that were added to the JDK include:</p><pre class="verbatim">  class file for java.util.Vector$Itr not found  -- introduced in JDK 7
  class file for java.lang.Class$ReflectionData not found  -- introduced in JDK 7 release 45
  The type java.lang.Class$ReflectionData cannot be resolved  -- introduced in JDK 8
  class file for java.util.regex.Pattern$HorizWS not found  -- introduced in JDK 9
</pre><p>You may be able to solve the problem by running</p><pre class="verbatim">  ./gradlew buildJdk assemble
</pre><p>to re-generate files <span style="font-family:monospace">checker/jdk/jdk{8,9}.jar</span> and <span style="font-family:monospace">checker/bin/jdk{8,9}.jar</span>.</p><p>That usually works, but if not, then you should recompile the Checker
Framework from source (Section&#XA0;<a href="#build-source">34.3</a>) rather than using
the pre-compiled distribution.</p></li><li class="li-itemize">A <span style="font-family:monospace">NoSuchFieldError</span> such as this:<pre class="verbatim">java.lang.NoSuchFieldError: NATIVE_HEADER_OUTPUT
</pre><p>Field <span style="font-family:monospace">NATIVE_HEADER_OUTPUT</span> was added in JDK 8.
The error message suggests that
you&#X2019;re not executing with the right bootclasspath: some classes were
compiled with the JDK 8 version and expect the field, but you&#X2019;re
executing the compiler on a JDK without the field.</p><p>One possibility is that you are not running the Checker Framework compiler
&#X2014; use <span style="font-family:monospace">javac -version</span> to check this, then use the right one. (Maybe
the Checker Framework javac is at the end rather than the beginning of your
path.)</p><p>If you are using Ant, then one possibility
is that the javac compiler is using the same JDK as Ant is using. You can
correct this by being sure to use <span style="font-family:monospace">fork="yes"</span> (see
Section&#XA0;<a href="#ant-task">32.3</a>) and/or setting the <span style="font-family:monospace">build.compiler</span> property to
<span style="font-family:monospace">extJavac</span>.</p><p>If you are building from source (Section&#XA0;<a href="#build-source">34.3</a>),
you might need to rebuild the Annotation
File Utilities before recompiling or using the Checker Framework.</p></li><li class="li-itemize">If you get an error that contains lines like these:<pre class="verbatim">Caused by: java.util.zip.ZipException: error in opening zip file
    at java.util.zip.ZipFile.open(Native Method)
    at java.util.zip.ZipFile.&lt;init&gt;(ZipFile.java:131)
</pre><p>then one possibility is that you have installed the Checker Framework in a
directory that contains special characters that Java&#X2019;s ZipFile
implementation cannot handle. For instance, if the directory name contains
&#X201C;<span style="font-family:monospace">+</span>&#X201D;, then Java 1.6 throws a ZipException, and Java 1.7 throws a
FileNotFoundException and prints out the directory name with &#X201C;<span style="font-family:monospace">+</span>&#X201D;
replaced by blanks.</p></li><li class="li-itemize">The Checker Framework sometimes runs out of memory when processing very
large Java files, or files with very large methods.<p>If you get an error such as
</p><pre class="verbatim">error: SourceChecker.typeProcess: unexpected Throwable (OutOfMemoryError) while processing ...; message: GC overhead limit exceeded
</pre><p>then either give the JVM more memory when running the Checker Framework, or
split your files and methods into smaller ones, or both.</p></li><li class="li-itemize"><a href="https://errorprone.info/">Error Prone</a> uses the Checker Framework&#X2019;s
dataflow analysis library.
Unfortunately, Error Prone uses an old version of the library, so you
cannot use both Error Prone and the current Checker Framework (because each
one depends on a different version of the dataflow library).<p>You can use an older version of the Checker Framework (the one that Error
Prone is built on), or you can use a switch that causes your build to use either
Error Prone or the Checker Framework, but not both.
The
<a href="https://github.com/kelloggm/checkerframework-gradle-plugin#incompatibility-with-error-prone">Gradle
plugin documentation</a> shows how to do the latter for Gradle.</p></li></ul>
<!--TOC subsection id="common-problems-non-typechecking" Unexpected warnings not related to type-checking-->
<h3 id="common-problems-non-typechecking" class="subsection">34.1.3&#XA0;&#XA0;Unexpected warnings not related to type-checking <a href="#common-problems-non-typechecking" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>This section gives solutions for some warning messages that are not related
to type errors in your code.</p><ul class="itemize"><li class="li-itemize">If you get an error like the following<pre class="verbatim">error: scoping construct for static nested type cannot be annotated
error: scoping construct cannot be annotated with type-use annotation
</pre><p>then you have probably written something like one of the following:
</p><dl class="description"><dt class="dt-description">
<span style="font-weight:bold"><span style="font-family:monospace">@Nullable java.util.List</span></span></dt><dd class="dd-description">
The correct Java syntax to write an annotation on a fully-qualified type
name is to put the annotation on the simple name part, as in
<span style="font-family:monospace">java.util.@Nullable List</span>. But, it&#X2019;s usually
better to add <span style="font-family:monospace">import java.util.List</span> to your source file, so that you can
just write <span style="font-family:monospace">@Nullable List</span>.
</dd><dt class="dt-description"><span style="font-weight:bold"><span style="font-family:monospace">@Nullable Map.Entry</span></span></dt><dd class="dd-description"> You must write <span style="font-family:monospace">Outer.@Nullable
StaticNestedClass</span> rather than <span style="font-family:monospace">@Nullable Outer.StaticNestedClass</span>.
Since a static nested class does not depend on its outer class, the
annotation on the outer class would have no effect and is forbidden.
</dd></dl><p>Java 8 requires that a type qualifier be written directly on the type that
it qualifies, rather than on a scoping mechanism that assists in resolving
the name. Examples of scoping mechanisms are package names and outer
classes of static nested classes.</p><p>The reason for the Java 8 syntax is to avoid syntactic irregularity. When
writing a member nested class (also known as an inner class), it is
possible to write annotations on both the outer and the inner class: <span style="font-family:monospace">@A1
Outer. @A2 Inner</span>. Therefore, when writing a static nested class, the
annotations should go on the same place: <span style="font-family:monospace">Outer. @A3 StaticNested</span> (rather
than <span style="font-family:monospace">@ConfusingAnnotation Outer. Nested</span> where
<span style="font-family:monospace">@ConfusingAnnotation</span> applies to <span style="font-family:monospace">Outer</span> if <span style="font-family:monospace">Nested</span> is a member class
and applies to <span style="font-family:monospace">Nested</span> if <span style="font-family:monospace">Nested</span> is a static class). It&#X2019;s not legal
to write an annotation on the outer class of a static nested class, because
neither annotations nor instantiations of the outer class affect the static
nested class.</p><p>Similar arguments apply when annotating <span style="font-family:monospace">package.Outer.Nested</span>.</p></li><li class="li-itemize">An &#X201C;error: package ... does not exist&#X201D; or &#X201C;error: cannot find symbol&#X201D;
about classes in your own project or its dependencies means that you have
left your own project or its dependencies off the classpath when you
invoked the compiler.</li></ul>
<!--TOC subsection id="common-problems-typechecking" Unexpected type-checking results-->
<h3 id="common-problems-typechecking" class="subsection">34.1.4&#XA0;&#XA0;Unexpected type-checking results <a href="#common-problems-typechecking" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>This section describes possible problems that can lead the type-checker to
give unexpected results.</p><ul class="itemize"><li class="li-itemize">
If the Checker Framework is unable to verify a property that you know is
true, then you should formulate a proof about why the property is true.
Your proof depends on some set of facts about the program and its
operation. State them completely; for example, don&#X2019;t write &#X201C;the field
<span style="font-family:monospace">f</span> cannot be null when execution reaches line 22&#X201D;, but justify
<em>why</em> the field cannot be null.<p>Once you have written down your proof, translate each fact into a Java
annotation.</p><p>If you are unable to express some aspect of your proof as an annotation,
then the type system is not capable of reproducing your proof. You might
need to find a different proof, or extend the type system to be more
expressive, or suppress the warning.</p><p>If you are able to express your entire proof as annotations, then look at
the Checker Framework error messages. One possibility is that the errors
indicate that your proof was incomplete or incorrect. Maybe your proof
implicitly depended on some fact you didn&#X2019;t write down, such as &#X201C;method
<span style="font-family:monospace">m</span> has no side effects.&#X201D; In this case, you should revise your proof
and add more annotations to your Java code. Another possibility is that
your proof is incorrect, and the errors indicate where. Another
possibility is that there is a bug in the type-checker. In this case,
you should report it to the maintainers, giving your proof and explaining
why the type-checker should be able to make the same inferences that you did.</p><p>Recall that the Checker Framework does modular verification,
one procedure at a time; it observes the specifications, but not the
implementations, of other methods.</p><p>Also see Section&#XA0;<a href="#handling-warnings">2.4.5</a>, which explains this same
methodology in different words.</p></li><li class="li-itemize">If a checker seems to be ignoring the annotation on a method, then it is
possible that the checker is reading the method&#X2019;s signature from its
<span style="font-family:monospace">.class</span> file, but the <span style="font-family:monospace">.class</span> file was not created by a Java 8
or later compiler.
You can check whether the annotations actually appear in the
<span style="font-family:monospace">.class</span> file by using the <span style="font-family:monospace">javap</span> tool.<p>If the annotations do not appear in the <span style="font-family:monospace">.class</span> file, here are two
ways to solve the problem:
</p><ul class="itemize"><li class="li-itemize">
Re-compile the method&#X2019;s class with the Checker Framework compiler. This will
ensure that the type annotations are written to the class file, even if
no type-checking happens during that execution.
</li><li class="li-itemize">Pass the method&#X2019;s file explicitly on the command line when type-checking,
so that the compiler reads its source code instead of its <span style="font-family:monospace">.class</span>
file.
</li></ul></li><li class="li-itemize">If a checker issues a warning about a property that it accepted (or that
was checked) on a previous line, then probably there was a side-effecting
method call in between that could invalidate the property. For example, in
this code:<pre class="verbatim">if (currentOutgoing != null &amp;&amp; !message.isCompleted()) {
    currentOutgoing.continueBuffering(message);
}
</pre><p>the Nullness Checker will issue a warning on the second line:
</p><pre class="verbatim">warning: [dereference.of.nullable] dereference of possibly-null reference currentOutgoing
    currentOutgoing.continueBuffering(message);
    ^
</pre><p>If <span style="font-family:monospace">currentOutgoing</span> is a field rather than a local variable, and
<span style="font-family:monospace">isCompleted()</span> is not a pure method, then a null pointer
dereference can occur at the given location, because <span style="font-family:monospace">isCompleted()</span> might set
the field <span style="font-family:monospace">currentOutgoing</span> to <span style="font-family:monospace">null</span>.</p><p>If you want to communicate that
isCompleted() does not set the field <span style="font-family:monospace">currentOutgoing</span> to <span style="font-family:monospace">null</span>, you can use
<a href="../api/org/checkerframework/dataflow/qual/Pure.html"><span style="font-family:monospace">@Pure</span></a>,
<a href="../api/org/checkerframework/dataflow/qual/SideEffectFree.html"><span style="font-family:monospace">@SideEffectFree</span></a>,
or <a href="../api/org/checkerframework/checker/nullness/qual/EnsuresNonNull.html"><span style="font-family:monospace">@EnsuresNonNull</span></a> on the
declaration of <span style="font-family:monospace">isCompleted()</span>; see Sections&#XA0;<a href="#type-refinement-purity">26.7.5</a>
and&#XA0;<a href="#nullness-method-annotations">3.2.2</a>.</p></li><li class="li-itemize">If a checker issues a type-checking error for a call that the library&#X2019;s
documentation states is correct, then maybe that library method has not yet
been annotated, so default annotations are being used.<p>To solve the problem, add the missing annotations to the library (see
Chapter&#XA0;<a href="#annotating-libraries">30</a>). Depending on the checker, the
annotations might be expressed in the form of stub files (which appear
together with the checker&#X2019;s source code, such as in file
<span style="font-family:monospace">checker/src/org/checkerframework/checker/interning/jdk.astub</span> for the
Interning Checker) or in the form of annotated libraries (which appear
under <span style="font-family:monospace">checker/jdk/</span>, such as at <span style="font-family:monospace">checker/jdk/nullness/src/</span> for
the Nullness Checker.</p></li><li class="li-itemize">If the compiler reports that it cannot find a method from the JDK or
another external library, then maybe the stub file for that class
is incomplete.<p>To solve the problem, add the missing annotations to the library, as
described in the previous item.</p><p>The error might take one of these forms:</p><pre class="verbatim">method sleep in class Thread cannot be applied to given types
cannot find symbol: constructor StringBuffer(StringBuffer)
</pre></li><li class="li-itemize">If you get an error related to a bounded type parameter and a literal such
as <span style="font-family:monospace">null</span>, the problem may be missing defaulting. Here is an example:<pre class="verbatim">mypackage/MyClass.java:2044: warning: incompatible types in assignment.
      T retval = null;
                 ^
  found   : null
  required: T extends @MyQualifier Object
</pre><p>A value that can be assigned to a variable of type <span style="font-family:monospace">T extends @MyQualifier
Object</span> only if that value is of the bottom type, since the bottom type is
the only one that is a subtype of every subtype of <span style="font-family:monospace">T extends @MyQualifier
Object</span>. The value <span style="font-family:monospace">null</span> satisfies this for the Java type system, and it
must be made to satisfy it for the pluggable type system as well. The
typical way to address this is to call <span style="font-family:monospace">addStandardLiteralQualifiers</span> on the <span style="font-family:monospace">LiteralTreeAnnotator</span>.</p></li><li class="li-itemize">An error such as<pre class="verbatim">MyFile.java:123: error: incompatible types in argument.
                        myModel.addElement("Scanning directories...");
                                           ^
  found   : String
  required: ? extends Object
</pre><p>may stem from use of raw types. (&#X201C;<span style="font-family:monospace">String</span>&#X201D; might be a different type
and might have type annotations.) If your declaration was</p><pre class="verbatim">  DefaultListModel myModel;
</pre><p>then it should be
</p><pre class="verbatim">  DefaultListModel&lt;String&gt; myModel;
</pre><p>Running the regular Java compiler with the <span style="font-family:monospace">-Xlint:unchecked</span> command-line
option will help you to find and fix problems such as raw types.</p></li><li class="li-itemize">The error<pre class="verbatim">error: annotation type not applicable to this kind of declaration
    ... List&lt;@NonNull String&gt; ...
</pre><p>indicates that you are using a definition of <span style="font-family:monospace">@NonNull</span> that is a
declaration annotation, which cannot be used in that syntactic location.
For example, many legacy annotations such as those listed in
Figure&#XA0;<a href="#fig-nullness-refactoring">3.2</a> are declaration annotations. You can
fix the problem by instead using a definition of <span style="font-family:monospace">@NonNull</span> that is a type
annotation, such as the Checker Framework&#X2019;s annotations; often this only
requires changing an <span style="font-family:monospace">import</span> statement.</p></li><li class="li-itemize">If Eclipse gives the warning<pre class="verbatim">The annotation @NonNull is disallowed for this location
</pre><p>then you have the wrong version of the <span style="font-family:monospace">org.eclipse.jdt.annotation</span>
classes. Eclipse includes two incompatible versions of these annotations.
You want the one with a name like
<span style="font-family:monospace">org.eclipse.jdt.annotation_2.0.0.....jar</span>, which you can find in the
<span style="font-family:monospace">plugins</span> subdirectory under the Eclipse installation directory.
Add this .jar file to your build path.</p></li><li class="li-itemize">When one formal parameter&#X2019;s annotation references another formal
parameter&#X2019;s name, as in this constructor:<pre class="verbatim">public String(char value[], @IndexFor("value") int offset, @IndexOrHigh("value") int count) { ... }
</pre><p>you will get an error such as</p><pre class="verbatim">[expression.unparsable.type.invalid] Expression in dependent type annotation invalid:
Use "#1" rather than "value"
</pre><p>Section&#XA0;<a href="#java-expressions-as-arguments">26.8</a> explains that you need to use
a different syntax to refer to a formal parameter:</p><pre class="verbatim">public String(char value[], @IndexFor("#1") int offset, @IndexOrHigh("#1") int count) { ... }
</pre></li></ul>
<!--TOC subsection id="common-problems-running-javac" Unexpected compilation output when running javac without a pluggable type-checker-->
<h3 id="common-problems-running-javac" class="subsection">34.1.5&#XA0;&#XA0;Unexpected compilation output when running javac without a pluggable type-checker <a href="#common-problems-running-javac" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>On rare occasions, javac may issue an error when compiling against the
Checker Framework&#X2019;s annotated JDK that you do not get when using the
regular JDK. (Recall that the Checker Framework compiler uses the
annotated JDK.) This may occur even when you are <em>not</em> running any
annotation processor. The error is:</p><pre class="verbatim">  unchecked method invocation: method myMethod in class C is applied to given types
</pre><p>The reason for this is that there are some wildcards in the annotated JDK
that have been given an explicit upper bound &#X2014; they have been changed
from, for example, <span style="font-family:monospace">List&lt;?&gt;</span> to <span style="font-family:monospace">List&lt;? extends Object&gt;</span>. The
JDK treats these two types as identical in almost all respects. However,
they have a different representation in bytecode. More importantly,
<span style="font-family:monospace">List&lt;?&gt;</span> is reifiable but <span style="font-family:monospace">List&lt;? extends Object&gt;</span> is not; this
means that the compiler permits uses of the former in some locations where
it issues a warning for the latter. You can suppress the warning.</p><p>A message of the form</p><pre class="verbatim">  error: annotation values must be of the form 'name=value'
        @LTLengthOf("firstName", "lastName") int index;
                    ^
</pre><p>is caused by incorrect Java syntax. When you supply a set of multiple
values as an annotation argument, you need to put curly braces around them:</p><pre class="verbatim">        @LTLengthOf({"firstName", "lastName"}) int index;
</pre><p>A message of the form</p><pre class="verbatim">  Error: cannot find symbol
</pre><p>for an annotation type that is imported, and is a applied to a
statically-imported enum, is caused by a javac bug, unrelated to the
Checker Framework. See
<a href="https://bugs.openjdk.java.net/browse/JDK-7101822"><span style="font-family:monospace">https://bugs.openjdk.java.net/browse/JDK-7101822</span></a> and <a href="https://bugs.openjdk.java.net/browse/JDK-8169095"><span style="font-family:monospace">https://bugs.openjdk.java.net/browse/JDK-8169095</span></a>.
</p>
<!--TOC section id="reporting-bugs" How to report problems (bug reporting)-->
<h2 id="reporting-bugs" class="section">34.2&#XA0;&#XA0;How to report problems (bug reporting) <a href="#reporting-bugs" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>If you have a problem with any checker, or with the Checker Framework,
please file a bug at
<a href="https://github.com/typetools/checker-framework/issues"><span style="font-family:monospace">https://github.com/typetools/checker-framework/issues</span></a>.
(First, check whether there is an existing bug report for that issue.)
If the problem is with an incorrect or missing annotation on a library,
including the JDK, see Section&#XA0;<a href="#reporting-bugs-annotated-libraries">34.2.1</a>.</p><p>Alternately (especially if your communication is not a bug report), you can
send mail to checker-framework-dev@googlegroups.com.
We welcome suggestions, annotated libraries, bug fixes, new
features, new checker plugins, and other improvements.</p><p>Please ensure that your bug report is clear and that it is complete.
Otherwise, we may be unable to understand it or to reproduce it, either of
which would prevent us from helping you. Your bug report will be most
helpful if you:</p><ul class="itemize"><li class="li-itemize">
Add <span style="font-family:monospace">-version -verbose -AprintAllQualifiers</span>
to the javac options. This causes the compiler to output
debugging information, including its version number.
</li><li class="li-itemize">Indicate exactly what you did. Don&#X2019;t skip any steps, and don&#X2019;t merely
describe your actions in words. Show the exact commands by attaching a
file or using cut-and-paste from your command shell. Always include
plaintext, not just a screenshot. Try to reproduce the problem from the
command line as well as from an IDE or within a build system; that helps
to indicate whether the problem is with the IDE or build system.
</li><li class="li-itemize">Include all files that are necessary to reproduce the problem. This
includes every file that is used by any of the commands you reported, and
possibly other files as well. Please attach the files, rather than
pasting their contents into the body of your bug report or email message,
because some mailers mangle formatting of pasted text. If you
encountered a problem while using tool integration such as
Maven integration, then try to reproduce the problem from the
command line as well &#X2014; this will indicate whether the problem is with
the checker itself or with the tool integration.
</li><li class="li-itemize">Indicate exactly what the result was by attaching a file or using
cut-and-paste from your command shell (don&#X2019;t merely describe it in
words, and don&#X2019;t use a screenshot).
</li><li class="li-itemize">Indicate what you expected the result to be, since a bug is a difference
between desired and actual outcomes. Also, please indicate <span style="font-weight:bold">why</span>
you expected that result &#X2014; explaining your reasoning can help you
understand how your reasoning is different than the checker&#X2019;s and which
one is wrong. Remember that the checker reasons modularly and
intraprocedurally: it examines one method at a time, using only the
method signatures of other methods.
</li><li class="li-itemize">Indicate what you have already done to try to understand the problem.
Did you do any additional experiments? What parts of the manual did
read, and what else did you search for in the manual? This information
will prevent you from being given redundant suggestions.
</li></ul><p>A particularly useful format for a test case is as a new file, or a diff to
an existing file, for the existing Checker Framework test suite. For
instance, for the Nullness
Checker, see directory <span style="font-family:monospace">checker-framework/checker/tests/nullness/</span>.
But, please report your bug even if you do not report it in this format.</p><p>When reporting bugs, please focus on realistic scenarios and well-written
code. We are sure that you can make up artificial code that stymies the
type-checker! Those aren&#X2019;t a good use of your time to report nor the
maintainers&#X2019; time to evaluate and fix.</p>
<!--TOC subsection id="reporting-bugs-annotated-libraries" Problems with annotated libraries-->
<h3 id="reporting-bugs-annotated-libraries" class="subsection">34.2.1&#XA0;&#XA0;Problems with annotated libraries <a href="#reporting-bugs-annotated-libraries" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Sometimes, a checker will report a warning because a library is not
annotated or because the library contains incorrect annotations.
Please do not open GitHub issues for these.
Instead, we appreciate pull requests to help us improve the annotations.
Alternatively or in the interim, you can use stub files as described in
Section&#XA0;<a href="#stub">30.5</a>.</p><p>If the library is annotated but has some incorrect or missing annotations,
then please open a pull request that adds the annotations.
You can find the annotated source for non-JDK libraries in
<a href="https://github.com/typetools/"><span style="font-family:monospace">https://github.com/typetools/</span></a>.
You can find the annotated JDK source in the
<a href="https://github.com/typetools/checker-framework">Checker Framework
GitHub repository</a>, either in subdirectories of
<a href="https://github.com/typetools/checker-framework/tree/master/checker/jdk"><span style="font-family:monospace">checker/jdk</span></a>
or in files named <span style="font-family:monospace">jdk.astub</span> in the checker&#X2019;s implementation directory.</p><p>If the library is not annotated at all, you can fork it, add annotations,
and propose that your annotated version be moved into
<a href="https://github.com/typetools/"><span style="font-family:monospace">https://github.com/typetools/</span></a>.</p><p>For either approach, please see Chapter&#XA0;<a href="#annotating-libraries">30</a> for
tips about writing library annotations.</p><p>Thanks for your contribution to the annotated libraries!</p>
<!--TOC section id="build-source" Building from source-->
<h2 id="build-source" class="section">34.3&#XA0;&#XA0;Building from source <a href="#build-source" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>The Checker Framework release (Section&#XA0;<a href="#installation">1.3</a>) contains
everything that most users need, both to use the distributed checkers and
to write your own checkers. This section describes how to compile its
binaries from source. You will be using the latest development version of
the Checker Framework, rather than an official release.</p><p>The Checker Framework can be easily built on Unix (Linux and Mac). You
might have trouble building on Windows. If so, you can switch to Unix (at
least for building, if not for running, the Checker Framework) or you can
report the problems to the Checker Framework developers.</p>
<!--TOC subsection id="building-prerequisites" Install prerequisites-->
<h3 id="building-prerequisites" class="subsection">34.3.1&#XA0;&#XA0;Install prerequisites <a href="#building-prerequisites" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>You need to install several packages in order to build the Checker
Framework.
Follow the instructions for your operating system.</p><dl class="description"><dt class="dt-description">
<span style="font-weight:bold">Ubuntu</span></dt><dd class="dd-description">
Run the following commands:<pre class="verbatim">sudo apt-get -qqy update
sudo apt-get -qqy install ant cpp git gradle junit4 libcurl3-gnutls \
 make maven mercurial unzip wget openjdk-8-jdk \
 dia hevea latexmk librsvg2-bin maven python-pip \
 texlive-font-utils texlive-fonts-recommended \
 texlive-latex-base texlive-latex-extra texlive-latex-recommended
</pre></dd><dt class="dt-description"><span style="font-weight:bold">Mac OS</span></dt><dd class="dd-description">
If you employ <a href="https://brew.sh">homebrew</a> to install packages, run
the following commands (you may need to update the version number <span style="font-family:monospace">2.31</span>):<pre class="verbatim">brew update
brew install git ant hevea maven mercurial librsvg unzip make
brew cask install java
brew cask install mactex
</pre><p>Make a <span style="font-family:monospace">latex</span> directory and copy <span style="font-family:monospace">hevea.sty</span> file into it:</p><pre class="verbatim">mkdir -p $HOME/Library/texmf/tex/latex
cp -p /usr/local/Cellar/hevea/2.31/lib/hevea/hevea.sty $HOME/Library/texmf/tex/latex/
</pre><p>Note: If copy permission is denied, try <span style="font-family:monospace">sudo</span>.</p><p>Also set the <span style="font-family:monospace">JAVA_HOME</span> environment variable in your <span style="font-family:monospace">.bashrc</span> file;
for example,</p><pre class="verbatim">export JAVA_HOME=/Library/Java/JavaVirtualMachines/jdk1.8.0_144.jdk/Contents/Home
</pre></dd><dt class="dt-description"><span style="font-weight:bold">Windows</span></dt><dd class="dd-description">
To build on Windows 10,
run <span style="font-family:monospace">bash</span> to obtain a version of
Ubuntu (provided by the Windows Subsystem for Linux) and follow the Ubuntu
instructions.</dd></dl>
<!--TOC subsection id="building-obtain-source" Obtain the source-->
<h3 id="building-obtain-source" class="subsection">34.3.2&#XA0;&#XA0;Obtain the source <a href="#building-obtain-source" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Obtain the latest source code from the version control repository:</p><pre class="verbatim">git clone https://github.com/typetools/checker-framework.git checker-framework
export CHECKERFRAMEWORK=`pwd`/checker-framework
</pre><p>You might want to add an <span style="font-family:monospace">export CHECKERFRAMEWORK=...</span> line to your
<span style="font-family:monospace">.bashrc</span> file.</p><p>Set the <span style="font-family:monospace">JAVA_HOME</span> environment variable to the location of your JDK
8 installation (not the JRE installation, and not JDK 7 or earlier).
This needs to be an Oracle JDK.
(The <span style="font-family:monospace">JAVA_HOME</span> environment
variable might already be set, because it is needed for Ant to work.)</p><dl class="description"><dt class="dt-description">
<span style="font-weight:bold">Ubuntu</span></dt><dd class="dd-description">
If you use the bash shell, put the following command in your
<span style="font-family:monospace">.bashrc</span> file. (This might not work if <span style="font-family:monospace">java</span> refers to an executable
in the JRE rather than in the JDK, but you need the JDK installed to build
the Checker Framework anyway.)
<pre class="verbatim">  export JAVA_HOME=${JAVA_HOME:-$(dirname $(dirname $(dirname $(readlink -f $(/usr/bin/which java)))))}
</pre></dd><dt class="dt-description"><span style="font-weight:bold">Mac OS X 10.5 or later</span></dt><dd class="dd-description">
Add one of the following two commands in your <span style="font-family:monospace">.bash_profile</span> or
<span style="font-family:monospace">.profile</span> file according to the version of your JDK.
<pre class="verbatim">  export JAVA_HOME=$(/usr/libexec/java_home -v 1.8)
  export JAVA_HOME=$(/usr/libexec/java_home -v 1.9)
</pre></dd></dl>
<!--TOC subsection id="building" Build the Checker Framework-->
<h3 id="building" class="subsection">34.3.3&#XA0;&#XA0;Build the Checker Framework <a href="#building" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><ol class="enumerate" type=1><li class="li-enumerate">Run <span style="font-family:monospace">./gradlew cloneAndBuildDependencies</span> to build the Checker Framework dependencies:<pre class="verbatim">  cd $CHECKERFRAMEWORK
  ./gradlew cloneAndBuildDependencies
</pre></li><li class="li-enumerate">Run <span style="font-family:monospace">./gradlew assemble</span> to build the Checker Framework:<pre class="verbatim">  cd $CHECKERFRAMEWORK
  ./gradlew assemble
</pre></li><li class="li-enumerate">Once it is built, you may wish to put the Checker Framework&#X2019;s <span style="font-family:monospace">javac</span>
even earlier in your <span style="font-family:monospace">PATH</span>:<pre class="verbatim">export PATH=$CHECKERFRAMEWORK/checker/bin:${PATH}
</pre><p>The Checker Framework&#X2019;s <span style="font-family:monospace">javac</span> ensures that all required
libraries are on your classpath and boot classpath, but is otherwise
identical to the Type Annotations compiler.</p><p>Putting the Checker Framework&#X2019;s <span style="font-family:monospace">javac</span> earlier in your <span style="font-family:monospace">PATH</span> will
ensure that the Checker Framework&#X2019;s version is used.</p></li><li class="li-enumerate">If you are developing a checker within the Checker Framework, there is
a developer version of <span style="font-family:monospace">javac</span> in the <span style="font-family:monospace">bin-devel</span> directory. This
version will use compiled classes from <span style="font-family:monospace">dataflow/build</span>,
<span style="font-family:monospace">javacutil/build</span>, <span style="font-family:monospace">framework/build</span>,
and <span style="font-family:monospace">checker/build</span> in the <span style="font-family:monospace">checker-framework</span> directory instead of
the compiled jar files, and by default will print stack traces for all
errors.<p>To use it, set your <span style="font-family:monospace">PATH</span> to use <span style="font-family:monospace">javac</span> in the <span style="font-family:monospace">bin-devel</span> directory:</p><pre class="verbatim">export PATH=$CHECKERFRAMEWORK/checker/bin-devel:${PATH}
</pre><p>The developer version of <span style="font-family:monospace">javac</span> allows you to not have to rebuild
the jar files after every code change, in turn allowing you to test
your changes faster. Source files can be compiled using command <span style="font-family:monospace">./gradlew
compileJava</span>, or can be automatically compiled by
an IDE such as Eclipse.</p></li><li class="li-enumerate">Test that everything works:<ul class="itemize"><li class="li-itemize">Run <span style="font-family:monospace">./gradlew allTests</span>:
<pre class="verbatim">  cd $CHECKERFRAMEWORK
  ./gradlew allTests
</pre></li><li class="li-itemize">Run the Nullness Checker examples (see
Section&#XA0;<a href="#nullness-example">3.5</a>).</li></ul></li></ol>
<!--TOC subsection id="building-manual" Build the Checker Framework Manual (this document)-->
<h3 id="building-manual" class="subsection">34.3.4&#XA0;&#XA0;Build the Checker Framework Manual (this document) <a href="#building-manual" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><ol class="enumerate" type=1><li class="li-enumerate">
Install needed packages; see Section&#XA0;<a href="#building-prerequisites">34.3.1</a> for
instructions.</li><li class="li-enumerate">Run <span style="font-family:monospace">make</span> in the <span style="font-family:monospace">docs/manual</span> directory to build both the PDF and HTML versions of the manual.
</li></ol>
<!--TOC subsection id="building-developer-manual" Code style, IDE configuration, pull requests, etc.-->
<h3 id="building-developer-manual" class="subsection">34.3.5&#XA0;&#XA0;Code style, IDE configuration, pull requests, etc. <a href="#building-developer-manual" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Please see the
<a href="https://rawgit.com/typetools/checker-framework/master/docs/developer/developer-manual.html">Checker Framework Developer Manual</a>.</p>
<!--TOC subsection id="building-travis" Enable Travis continuous integration builds-->
<h3 id="building-travis" class="subsection">34.3.6&#XA0;&#XA0;Enable Travis continuous integration builds <a href="#building-travis" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h3><!--SEC END --><p>Travis-CI is a continuous integration system: it runs tests every time you
push a commit to GitHub.</p><p>If you have forked any of the projects rather than just creating a clone,
then we recommend that you enable Travis-CI builds,
so that you learn quickly of any errors that creep into your fork.</p><p>Run the
<a href="https://docs.travis-ci.com/user/getting-started/#To-get-started-with-Travis-CI%3A">Travis-CI getting started directions</a>,
though note that the <span style="font-family:monospace">.travis.yml</span> files already exist, so only the first
two steps may be necessary.</p><p>To save time, by default the Travis jobs download a pre-built version of
the JDK rather than building the JDK from the sources in the Checker
Framework repository. This means that if you make a change to the
annotated JDK, your tests will fail. Here is how to deal with this issue:
</p><ol class="enumerate" type=1><li class="li-enumerate">
In your pull request, edit file <span style="font-family:monospace">.travis.yml</span> so that it rebuilds
the JDK (some jobs might time out).
</li><li class="li-enumerate">Verify that all tests pass.
</li><li class="li-enumerate">A Checker Framework developer needs to update the pre-built JDK from
your branch.
</li><li class="li-enumerate">Undo your edits to file <span style="font-family:monospace">.travis.yml</span>.
</li><li class="li-enumerate">Verify that all tests pass.
</li><li class="li-enumerate">A Checker Framework developer will review your code and merge your branch.
</li></ol>
<!--TOC subsubsection id="building-travis-debug" Debugging Travis continuous integration builds-->
<h4 id="building-travis-debug" class="subsubsection">Debugging Travis continuous integration builds <a href="#building-travis-debug" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h4><!--SEC END --><p>If a Travis job is failing, you can reproduce the problem locally.
The Travis jobs all run within Docker containers.
Install Docker on your local computer, then perform commands like the
following to get a shell within Docker:</p><pre class="verbatim">docker pull mdernst/cf-ubuntu-jdk8
docker run -it mdernst/cf-ubuntu-jdk8 /bin/bash
</pre><p>Then, you can run arbitrary commands, including those that appear in the
<span style="font-family:monospace">docker run</span> command in the <span style="font-family:monospace">.travis.yml</span> file. For example:</p><pre class="verbatim">export JAVA_HOME=`which javac|xargs readlink -f|xargs dirname|xargs dirname`
git clone -b $BRANCHNAME --depth 9 https://github.com/$USER/checker-framework.git checker-framework
cd checker-framework
./.travis-build.sh all-tests downloadjdk
</pre>
<!--TOC section id="pull-request" Contributing fixes (creating a pull request)-->
<h2 id="pull-request" class="section">34.4&#XA0;&#XA0;Contributing fixes (creating a pull request) <a href="#pull-request" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>Please see the document
<a href="https://homes.cs.washington.edu/%7emernst/advice/github-pull-request.html">How
to create and review a GitHub pull request</a> for instructions about how to
create a pull request, which is the way you can contribute code to the
Checker Framework project. Thanks in advance for your participation!</p><p>For writing new test cases, see file
<a href="https://raw.githubusercontent.com/typetools/checker-framework/master/checker/tests/README"><span style="font-family:monospace">checker-framework/checker/tests/README</span></a>.</p>
<!--TOC section id="publications" Publications-->
<h2 id="publications" class="section">34.5&#XA0;&#XA0;Publications <a href="#publications" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>Here are two technical papers about the Checker Framework itself:</p><ul class="itemize"><li class="li-itemize">
&#X201C;Practical pluggable types for Java&#X201D;&#XA0;[<a href="#PapiACPE2008">PAC+08</a>]
(ISSTA 2008, <a href="https://homes.cs.washington.edu/~mernst/pubs/pluggable-checkers-issta2008.pdf"><span style="font-family:monospace">https://homes.cs.washington.edu/~mernst/pubs/pluggable-checkers-issta2008.pdf</span></a>)
describes the design and implementation of the Checker Framework.
The paper also describes case
studies in which the Nullness, Interning, Javari, and IGJ Checkers found
previously-unknown errors in real software.
The case studies also yielded new insights about type systems.</li><li class="li-itemize">&#X201C;Building and using pluggable
type-checkers&#X201D;&#XA0;[<a href="#DietlDEMS2011">DDE+11</a>]
(ICSE 2011, <a href="https://homes.cs.washington.edu/~mernst/pubs/pluggable-checkers-icse2011.pdf"><span style="font-family:monospace">https://homes.cs.washington.edu/~mernst/pubs/pluggable-checkers-icse2011.pdf</span></a>)
discusses further experience with the Checker Framework, increasing the
number of lines of verified code to 3 million. The case studies are of the
Fake Enum, Signature String, Interning, and Nullness Checkers.
The paper also evaluates the ease
of pluggable type-checking with the Checker Framework: type-checkers
were easy to write, easy for novices to use, and effective in finding
errors.
</li></ul><p>Here are some papers about type systems that were implemented and evaluated
using the Checker Framework:</p><dl class="description"><dt class="dt-description">
<span style="font-weight:bold">Nullness (Chapter&#XA0;</span><a href="#nullness-checker"><span style="font-weight:bold">3</span></a><span style="font-weight:bold">)</span></dt><dd class="dd-description">
See the two papers about the Checker Framework, described above.</dd><dt class="dt-description"><span style="font-weight:bold">Rawness initialization (Section&#XA0;</span><a href="#initialization-rawness-checker"><span style="font-weight:bold">24.10</span></a><span style="font-weight:bold">)</span></dt><dd class="dd-description">
&#X201C;Inference of field initialization&#X201D; (ICSE 2011, <a href="https://homes.cs.washington.edu/~mernst/pubs/initialization-icse2011-abstract.html"><span style="font-family:monospace">https://homes.cs.washington.edu/~mernst/pubs/initialization-icse2011-abstract.html</span></a>)
describes inference for the Rawness Initialization Checker.</dd><dt class="dt-description"><span style="font-weight:bold">Interning (Chapter&#XA0;</span><a href="#interning-checker"><span style="font-weight:bold">6</span></a><span style="font-weight:bold">)</span></dt><dd class="dd-description">
See the two papers about the Checker Framework, described above.</dd><dt class="dt-description"><span style="font-weight:bold">Locking (Chapter&#XA0;</span><a href="#lock-checker"><span style="font-weight:bold">7</span></a><span style="font-weight:bold">)</span></dt><dd class="dd-description">
&#X201C;Locking discipline inference and checking&#X201D; (ICSE 2016,
<a href="https://homes.cs.washington.edu/~mernst/pubs/locking-inference-checking-icse2016-abstract.html"><span style="font-family:monospace">https://homes.cs.washington.edu/~mernst/pubs/locking-inference-checking-icse2016-abstract.html</span></a>)
describes the Lock Checker.</dd><dt class="dt-description"><span style="font-weight:bold">Fake enumerations, type aliases, and typedefs (Chapter&#XA0;</span><a href="#fenum-checker"><span style="font-weight:bold">9</span></a><span style="font-weight:bold">)</span></dt><dd class="dd-description">
See the ICSE 2011 paper about the Checker Framework, described above.</dd><dt class="dt-description"><span style="font-weight:bold">Regular expressions (Chapter&#XA0;</span><a href="#regex-checker"><span style="font-weight:bold">11</span></a><span style="font-weight:bold">)</span></dt><dd class="dd-description">
&#X201C;A type system for regular expressions&#X201D;&#XA0;[<a href="#SpishakDE2012">SDE12</a>] (FTfJP 2012, <a href="https://homes.cs.washington.edu/~mernst/pubs/regex-types-ftfjp2012-abstract.html"><span style="font-family:monospace">https://homes.cs.washington.edu/~mernst/pubs/regex-types-ftfjp2012-abstract.html</span></a>)
describes the Regex Checker.</dd><dt class="dt-description"><span style="font-weight:bold">Format Strings (Chapter&#XA0;</span><a href="#formatter-checker"><span style="font-weight:bold">12</span></a><span style="font-weight:bold">)</span></dt><dd class="dd-description">
&#X201C;A type system for format strings&#X201D;&#XA0;[<a href="#WeitzKSE2014">WKSE14</a>] (ISSTA 2014, <a href="https://homes.cs.washington.edu/~mernst/pubs/format-string-issta2014-abstract.html"><span style="font-family:monospace">https://homes.cs.washington.edu/~mernst/pubs/format-string-issta2014-abstract.html</span></a>)
describes the Format String Checker.</dd><dt class="dt-description"><span style="font-weight:bold">Signature strings (Chapter&#XA0;</span><a href="#signature-checker"><span style="font-weight:bold">15</span></a><span style="font-weight:bold">)</span></dt><dd class="dd-description">
See the ICSE 2011 paper about the Checker Framework, described above.</dd><dt class="dt-description"><span style="font-weight:bold">GUI Effects (Chapter&#XA0;</span><a href="#guieffect-checker"><span style="font-weight:bold">16</span></a><span style="font-weight:bold">)</span></dt><dd class="dd-description">
&#X201C;JavaUI: Effects for controlling UI object access&#X201D;&#XA0;[<a href="#GordonDEG2013">GDEG13</a>] (ECOOP 2013, <a href="https://homes.cs.washington.edu/~mernst/pubs/gui-thread-ecoop2013-abstract.html"><span style="font-family:monospace">https://homes.cs.washington.edu/~mernst/pubs/gui-thread-ecoop2013-abstract.html</span></a>)
describes the GUI Effect Checker.</dd><dt class="dt-description"></dt><dd class="dd-description">&#X201C;Verification games: Making verification fun&#X201D; (FTfJP 2012, <a href="https://homes.cs.washington.edu/~mernst/pubs/verigames-ftfjp2012-abstract.html"><span style="font-family:monospace">https://homes.cs.washington.edu/~mernst/pubs/verigames-ftfjp2012-abstract.html</span></a>)
describes a general inference approach that, at the time, had only been implemented for the Nullness Checker (Section&#XA0;<a href="#nullness-checker">3</a>).</dd><dt class="dt-description"><span style="font-weight:bold">Thread locality (Section&#XA0;</span><a href="#loci-thread-locality-checker"><span style="font-weight:bold">24.3</span></a><span style="font-weight:bold">)</span></dt><dd class="dd-description">
&#X201C;Loci: Simple thread-locality for Java&#X201D;&#XA0;[<a href="#WrigstadPMZV2009">WPM+09</a>] (ECOOP 2009,
<a href="http://janvitek.org/pubs/ecoop09.pdf"><span style="font-family:monospace">http://janvitek.org/pubs/ecoop09.pdf</span></a>)</dd><dt class="dt-description"><span style="font-weight:bold">Security (Section&#XA0;</span><a href="#sparta-checker"><span style="font-weight:bold">24.8</span></a><span style="font-weight:bold">)</span></dt><dd class="dd-description">
&#X201C;Static analysis of implicit control flow: Resolving Java reflection and
Android intents&#X201D;&#XA0;[<a href="#BarrosJMVDdAE2015">BJM+15</a>] (ASE 2015,
<a href="https://homes.cs.washington.edu/~mernst/pubs/implicit-control-flow-ase2015-abstract.html"><span style="font-family:monospace">https://homes.cs.washington.edu/~mernst/pubs/implicit-control-flow-ase2015-abstract.html</span></a>)
describes the SPARTA toolset and information flow type-checker.<p>&#X201C;Boolean formulas for the static identification of injection attacks in
Java&#X201D;&#XA0;[<a href="#ErnstLMSS2015">ELM+15</a>] (LPAR 2015, <a href="https://homes.cs.washington.edu/~mernst/pubs/detect-injections-lpar2015-abstract.html"><span style="font-family:monospace">https://homes.cs.washington.edu/~mernst/pubs/detect-injections-lpar2015-abstract.html</span></a>)</p></dd><dt class="dt-description"><a href="https://ece.uwaterloo.ca/~wdietl/ownership/"><span style="font-weight:bold">Generic Universe
Types</span></a><span style="font-weight:bold"> (Section&#XA0;</span><a href="#gut-checker"><span style="font-weight:bold">24.5</span></a><span style="font-weight:bold">)</span></dt><dd class="dd-description">
&#X201C;Tunable static inference for Generic Universe Types&#X201D; (ECOOP 2011, <a href="https://homes.cs.washington.edu/~mernst/pubs/tunable-typeinf-ecoop2011-abstract.html"><span style="font-family:monospace">https://homes.cs.washington.edu/~mernst/pubs/tunable-typeinf-ecoop2011-abstract.html</span></a>)
describes inference for the Generic Universe Types type system.<p>Another implementation of Universe Types and <a href="http://www.cs.rpi.edu/~huangw5/cf-inference/">ownership types</a> is described in
&#X201C;Inference and checking of object ownership&#X201D;&#XA0;[<a href="#HuangDME2012">HDME12</a>] (ECOOP 2012, <a href="https://homes.cs.washington.edu/~mernst/pubs/infer-ownership-ecoop2012-abstract.html"><span style="font-family:monospace">https://homes.cs.washington.edu/~mernst/pubs/infer-ownership-ecoop2012-abstract.html</span></a>).</p></dd><dt class="dt-description"><span style="font-weight:bold">Approximate data (Section&#XA0;</span><a href="#enerj-checker"><span style="font-weight:bold">24.6</span></a><span style="font-weight:bold">)</span></dt><dd class="dd-description">
&#X201C;EnerJ: Approximate Data Types for Safe and General Low-Power Computation&#X201D;&#XA0;[<a href="#SampsonDFGCG2011">SDF+11</a>] (PLDI 2011, <a href="https://homes.cs.washington.edu/~luisceze/publications/Enerj-pldi2011.pdf"><span style="font-family:monospace">https://homes.cs.washington.edu/~luisceze/publications/Enerj-pldi2011.pdf</span></a>)</dd><dt class="dt-description"><span style="font-weight:bold">Information flow and tainting (Section&#XA0;</span><a href="#sparta-checker"><span style="font-weight:bold">24.8</span></a><span style="font-weight:bold">)</span></dt><dd class="dd-description">
&#X201C;Collaborative Verification of Information Flow
for a High-Assurance App Store&#X201D;&#XA0;[<a href="#ErnstJMDPRKBBHVW2014">EJM+14</a>] (CCS 2014, <a href="https://homes.cs.washington.edu/~mernst/pubs/infoflow-ccs2014.pdf"><span style="font-family:monospace">https://homes.cs.washington.edu/~mernst/pubs/infoflow-ccs2014.pdf</span></a>) describes the SPARTA information flow type system.</dd><dt class="dt-description"><span style="font-weight:bold">IGJ and OIGJ immutability (Section&#XA0;</span><a href="#igj-checker"><span style="font-weight:bold">24.9</span></a><span style="font-weight:bold">)</span></dt><dd class="dd-description">
&#X201C;Object and reference immutability using Java generics&#X201D;&#XA0;[<a href="#ZibinPAAKE2007">ZPA+07</a>] (ESEC/FSE 2007, <a href="https://homes.cs.washington.edu/~mernst/pubs/immutability-generics-fse2007-abstract.html"><span style="font-family:monospace">https://homes.cs.washington.edu/~mernst/pubs/immutability-generics-fse2007-abstract.html</span></a>)
and
&#X201C;Ownership and immutability in generic Java&#X201D;&#XA0;[<a href="#ZibinPLAE2010">ZPL+10</a>] (OOPSLA 2010, <a href="https://homes.cs.washington.edu/~mernst/pubs/ownership-immutability-oopsla2010-abstract.html"><span style="font-family:monospace">https://homes.cs.washington.edu/~mernst/pubs/ownership-immutability-oopsla2010-abstract.html</span></a>)
describe the IGJ and OIGJ immutability type systems.
For further case studies, also see the ISSTA 2008 paper about the Checker
Framework, described above.</dd><dt class="dt-description"><span style="font-weight:bold">Javari immutability (Section&#XA0;</span><a href="#javari-checker"><span style="font-weight:bold">24.9</span></a><span style="font-weight:bold">)</span></dt><dd class="dd-description">
&#X201C;Javari: Adding reference immutability to Java&#X201D;&#XA0;[<a href="#TschantzE2005">TE05</a>] (OOPSLA 2005, <a href="https://homes.cs.washington.edu/~mernst/pubs/ref-immutability-oopsla2005-abstract.html"><span style="font-family:monospace">https://homes.cs.washington.edu/~mernst/pubs/ref-immutability-oopsla2005-abstract.html</span></a>)
describes the Javari type system.
For inference, see
&#X201C;Inference of reference immutability&#X201D;&#XA0;[<a href="#QuinonezTE2008">QTE08</a>] (ECOOP 2008, <a href="https://homes.cs.washington.edu/~mernst/pubs/infer-refimmutability-ecoop2008-abstract.html"><span style="font-family:monospace">https://homes.cs.washington.edu/~mernst/pubs/infer-refimmutability-ecoop2008-abstract.html</span></a>)
and
&#X201C;Parameter reference immutability: Formal definition, inference tool, and comparison&#X201D;&#XA0;[<a href="#ArtziQKE2009">AQKE09</a>] (J.ASE 2009, <a href="https://homes.cs.washington.edu/~mernst/pubs/mutability-jase2009-abstract.html"><span style="font-family:monospace">https://homes.cs.washington.edu/~mernst/pubs/mutability-jase2009-abstract.html</span></a>).
For further case studies, also see the ISSTA 2008 paper about the Checker
Framework, described above.</dd><dt class="dt-description"><span style="font-weight:bold">ReIm immutability</span></dt><dd class="dd-description">
&#X201C;ReIm &amp; ReImInfer: Checking and inference of reference immutability and method purity&#X201D;&#XA0;[<a href="#HuangMDE2012">HMDE12</a>] (OOPSLA 2012, <a href="https://homes.cs.washington.edu/~mernst/pubs/infer-refimmutability-oopsla2012-abstract.html"><span style="font-family:monospace">https://homes.cs.washington.edu/~mernst/pubs/infer-refimmutability-oopsla2012-abstract.html</span></a>)
describes the ReIm immutability type system.</dd></dl><p>In addition to these papers that discuss use the Checker Framework
directly, other academic papers use the Checker Framework in their
implementation or evaluation.
Most educational use of the Checker
Framework is never published, and most commercial use of the Checker
Framework is never discussed publicly.</p><p>(If you know of a paper or other use that is not listed here, please inform
the Checker Framework developers so we can add it.)</p>
<!--TOC section id="credits" Credits and changelog-->
<h2 id="credits" class="section">34.6&#XA0;&#XA0;Credits and changelog <a href="#credits" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>Differences from previous versions of the checkers and framework can be found
in the <span style="font-family:monospace">changelog.txt</span> file. This file is included in the
Checker Framework distribution and is also available on the web at
<a href="https://checkerframework.org/changelog.txt"><span style="font-family:monospace">https://checkerframework.org/changelog.txt</span></a>.</p><p>Developers who have contributed code to the Checker Framework include
Abraham Lin,
Akash Srivastava,
Alvin Abdagic,
Anatoly Kupriyanov,
Andy Turner,
Arie van Deursen,
Arthur Baars,
Ashish Rana,
Asumu Takikawa,
Atul Dada,
Ayush Agarwal,
Baorui Zhou,
Basil Peace,
Benno Stein,
Bohdan Sharipov,
Brian Corcoran,
Calvin Loncaric,
Charles Chen,
Charlie Garrett,
Christopher Mackie,
Colin S. Gordon,
Dan Brotherston,
Dan Brown,
David Lazar,
David McArthur,
Dilraj Singh,
Eric Spishak,
Felipe R. Monteiro,
Gautam Korlam,
Google Inc. (via @wmdietlGC),
Haaris Ahmed,
Javier Thaine,
Jeff Luo,
Jenny Xiang,
Jianchu Li,
Jiasen (Jason) Xu,
Joe Schafer,
John Vandenberg,
Jonathan Burke,
Jonathan Nieder,
Kartikeya Goswami,
Kivanc Muslu,
Konstantin Weitz,
Liam Miller-Cushon,
Luqman Aden,
L&#XE1;zaro Clapp,
Mahmood Ali,
Manu Sridharan,
Mark Roberts,
Martin Kellogg,
Matt Mullen,
Maximilian Gama,
Michael Bayne,
Michael Coblenz,
Michael Ernst,
Michael Sloan,
Mier Ta,
Nhat Dinh,
Nikhil Shinde,
Oleg Shchelykalnov,
Pascal Wittmann,
Patrick Meiring,
Paul Vines,
Paulo Barros,
Philip Lai,
Rashmi Mudduluru,
Ravi Roshan,
Renato Athaydes,
Ren&#XE9; Just,
Ruturaj Mohanty,
Ryan Oblak,
Sadaf Tajik,
Sagar Tewari,
Sean McLaughlin,
Shinya Yoshida,
Shubham Raj,
Stefan Heule,
Steph Dietzel,
Stuart Pernsteiner,
Suzanne Millstein,
Tony Wang,
Trask Stalnaker,
Travis Haagen,
Utsav Oza,
Vatsal Sura,
Vlastimil Dort,
Weitian Xing,
Werner Dietl.

In addition, too many users to list have provided valuable feedback, which
has improved the toolset&#X2019;s design and implementation.
Thanks for your help!</p>
<!--TOC section id="license" License-->
<h2 id="license" class="section">34.7&#XA0;&#XA0;License <a href="#license" style="color:inherit; text-decoration:none"><span style="font-size:small">&#X1F517;</span></a></h2><!--SEC END --><p>Two different licenses apply to different parts of the Checker Framework.
</p><ul class="itemize"><li class="li-itemize">
The Checker Framework itself is licensed under the GNU General Public License
(GPL), version 2, with the classpath exception.
The GPL is the same license that OpenJDK is licensed
under. Just as compiling your code with javac does not infect your code
with the GPL, type-checking your code with the Checker Framework does not
infect your code with the GPL. Running the Checker Framework during
development has no effect on your intellectual property or licensing. If
you want to ship the Checker Framework as part of your product, then your
product must be licensed under the GPL.
</li><li class="li-itemize">The more permissive MIT License applies
to code that you might want to include in your own
program, such as the annotations and run-time utility classes.
</li></ul><p>
For details, see file
<a href="https://raw.githubusercontent.com/typetools/checker-framework/master/LICENSE.txt"><span style="font-family:monospace">LICENSE.txt</span></a>.</p><hr><!--TOC chapter id="sec517" References-->
<h1 id="sec517" class="chapter">References</h1><!--SEC END --><dl class="thebibliography"><dt class="dt-thebibliography">
<a id="ArtziQKE2009">[AQKE09]</a></dt><dd class="dd-thebibliography">
Shay Artzi, Jaime Quinonez, Adam Kie&#X17C;un, and Michael&#XA0;D. Ernst.
Parameter reference immutability: Formal definition, inference tool,
and comparison.
<em>Automated Software Engineering</em>, 16(1):145&#X2013;192, March 2009.</dd><dt class="dt-thebibliography"><a id="Artho2001">[Art01]</a></dt><dd class="dd-thebibliography">
Cyrille Artho.
Finding faults in multi-threaded programs.
Master&#X2019;s thesis, Swiss Federal Institute of Technology, March&#XA0;15,
2001.</dd><dt class="dt-thebibliography"><a id="BarrosJMVDdAE2015">[BJM<sup>+</sup>15]</a></dt><dd class="dd-thebibliography">
Paulo Barros, Ren&#XE9; Just, Suzanne Millstein, Paul Vines, Werner Dietl, Marcelo
d&#X2019;Amorim, and Michael&#XA0;D. Ernst.
Static analysis of implicit control flow: Resolving Java reflection
and Android intents.
In <em>ASE 2015: Proceedings of the 30th Annual International
Conference on Automated Software Engineering</em>, pages 669&#X2013;679, Lincoln, NE,
USA, November 2015.</dd><dt class="dt-thebibliography"><a id="CoblenzNAMS2017">[CNA<sup>+</sup>17]</a></dt><dd class="dd-thebibliography">
Michael Coblenz, Whitney Nelson, Jonathan Aldrich, Brad Myers, and Joshua
Sunshine.
Glacier: Transitive class immutability for Java.
In <em>ICSE 2017, Proceedings of the 39th International Conference
on Software Engineering</em>, pages 496&#X2013;506, Buenos Aires, Argentina, May 2017.</dd><dt class="dt-thebibliography"><a id="Copeland2005">[Cop05]</a></dt><dd class="dd-thebibliography">
Tom Copeland.
<em>PMD Applied</em>.
Centennial Books, November 2005.</dd><dt class="dt-thebibliography"><a id="JSR198">[Cro06]</a></dt><dd class="dd-thebibliography">
Jose Cronembold.
JSR 198: A standard extension API for Integrated Development
Environments.
<a href="http://jcp.org/en/jsr/detail?id=198"><span style="font-family:monospace">http://jcp.org/en/jsr/detail?id=198</span></a>, May&#XA0;8, 2006.</dd><dt class="dt-thebibliography"><a id="JSR269">[Dar06]</a></dt><dd class="dd-thebibliography">
Joe Darcy.
JSR 269: Pluggable annotation processing API.
<a href="http://jcp.org/en/jsr/detail?id=269"><span style="font-family:monospace">http://jcp.org/en/jsr/detail?id=269</span></a>, May&#XA0;17, 2006.
Public review version.</dd><dt class="dt-thebibliography"><a id="DietlDEMS2011">[DDE<sup>+</sup>11]</a></dt><dd class="dd-thebibliography">
Werner Dietl, Stephanie Dietzel, Michael&#XA0;D. Ernst, Kivan&#XE7; Mu&#X15F;lu,
and Todd Schiller.
Building and using pluggable type-checkers.
In <em>ICSE 2011, Proceedings of the 33rd International Conference
on Software Engineering</em>, pages 681&#X2013;690, Waikiki, Hawaii, USA, May 2011.</dd><dt class="dt-thebibliography"><a id="DietlEM2011">[DEM11]</a></dt><dd class="dd-thebibliography">
Werner Dietl, Michael&#XA0;D. Ernst, and Peter M&#XFC;ller.
Tunable static inference for Generic Universe Types.
In <em>ECOOP 2011 &#X2014; Object-Oriented Programming, 25th European
Conference</em>, pages 333&#X2013;357, Lancaster, UK, July 2011.</dd><dt class="dt-thebibliography"><a id="ErnstJMDPRKBBHVW2014">[EJM<sup>+</sup>14]</a></dt><dd class="dd-thebibliography">
Michael&#XA0;D. Ernst, Ren&#XE9; Just, Suzanne Millstein, Werner Dietl, Stuart
Pernsteiner, Franziska Roesner, Karl Koscher, Paulo Barros, Ravi Bhoraskar,
Seungyeop Han, Paul Vines, and Edward&#XA0;X. Wu.
Collaborative verification of information flow for a high-assurance
app store.
In <em>CCS 2014: Proceedings of the 21st ACM Conference on Computer
and Communications Security</em>, pages 1092&#X2013;1104, Scottsdale, AZ, USA, November
2014.</dd><dt class="dt-thebibliography"><a id="ErnstLMSS2015">[ELM<sup>+</sup>15]</a></dt><dd class="dd-thebibliography">
Michael&#XA0;D. Ernst, Alberto Lovato, Damiano Macedonio, Ciprian Spiridon, and
Fausto Spoto.
Boolean formulas for the static identification of injection attacks
in Java.
In <em>LPAR 2015: Proceedings of the 20th International Conference
on Logic for Programming, Artificial Intelligence, and Reasoning</em>, pages
130&#X2013;145, Suva, Fiji, November 2015.</dd><dt class="dt-thebibliography"><a id="JSR308-2008-09-12">[Ern08]</a></dt><dd class="dd-thebibliography">
Michael&#XA0;D. Ernst.
Type Annotations specification (JSR 308).
<a href="https://checkerframework.org/jsr308/"><span style="font-family:monospace">https://checkerframework.org/jsr308/</span></a>, September&#XA0;12, 2008.</dd><dt class="dt-thebibliography"><a id="GordonDEG2013">[GDEG13]</a></dt><dd class="dd-thebibliography">
Colin&#XA0;S. Gordon, Werner Dietl, Michael&#XA0;D. Ernst, and Dan Grossman.
JavaUI: Effects for controlling UI object access.
In <em>ECOOP 2013 &#X2014; Object-Oriented Programming, 27th European
Conference</em>, pages 179&#X2013;204, Montpellier, France, July 2013.</dd><dt class="dt-thebibliography"><a id="Goetz2006:typedef">[Goe06]</a></dt><dd class="dd-thebibliography">
Brian Goetz.
The pseudo-typedef antipattern: Extension is not type definition.
<a href="https://www.ibm.com/developerworks/java/library/j-jtp02216/"><span style="font-family:monospace">https://www.ibm.com/developerworks/java/library/j-jtp02216/</span></a>,
February&#XA0;21, 2006.</dd><dt class="dt-thebibliography"><a id="Goetz2006">[GPB<sup>+</sup>06]</a></dt><dd class="dd-thebibliography">
Brian Goetz, Tim Peierls, Joshua Bloch, Joseph Bowbeer, David Holmes, and Doug
Lea.
<em>Java Concurrency in Practice</em>.
Addison-Wesley, 2006.</dd><dt class="dt-thebibliography"><a id="HuangDME2012">[HDME12]</a></dt><dd class="dd-thebibliography">
Wei Huang, Werner Dietl, Ana Milanova, and Michael&#XA0;D. Ernst.
Inference and checking of object ownership.
In <em>ECOOP 2012 &#X2014; Object-Oriented Programming, 26th European
Conference</em>, pages 181&#X2013;206, Beijing, China, June 2012.</dd><dt class="dt-thebibliography"><a id="HuangMDE2012">[HMDE12]</a></dt><dd class="dd-thebibliography">
Wei Huang, Ana Milanova, Werner Dietl, and Michael&#XA0;D. Ernst.
ReIm &amp; ReImInfer: Checking and inference of reference
immutability and method purity.
In <em>OOPSLA 2012, Object-Oriented Programming Systems, Languages,
and Applications</em>, pages 879&#X2013;896, Tucson, AZ, USA, October 2012.</dd><dt class="dt-thebibliography"><a id="HovemeyerP2004">[HP04]</a></dt><dd class="dd-thebibliography">
David Hovemeyer and William Pugh.
Finding bugs is easy.
In <em>OOPSLA Companion: Companion to Object-Oriented Programming
Systems, Languages, and Applications</em>, pages 132&#X2013;136, Vancouver, BC, Canada,
October 2004.</dd><dt class="dt-thebibliography"><a id="HovemeyerSP2005">[HSP05]</a></dt><dd class="dd-thebibliography">
David Hovemeyer, Jaime Spacco, and William Pugh.
Evaluating and tuning a static analysis to find null pointer bugs.
In <em>PASTE 2005: ACM SIGPLAN/SIGSOFT Workshop on Program Analysis
for Software Tools and Engineering (PASTE 2005)</em>, pages 13&#X2013;19, Lisbon,
Portugal, September 2005.</dd><dt class="dt-thebibliography"><a id="LeavensBR2006:JML">[LBR06]</a></dt><dd class="dd-thebibliography">
Gary&#XA0;T. Leavens, Albert&#XA0;L. Baker, and Clyde Ruby.
Preliminary design of JML: A behavioral interface specification
language for Java.
<em>ACM SIGSOFT Software Engineering Notes</em>, 31(3), March 2006.</dd><dt class="dt-thebibliography"><a id="PapiACPE2008">[PAC<sup>+</sup>08]</a></dt><dd class="dd-thebibliography">
Matthew&#XA0;M. Papi, Mahmood Ali, Telmo&#XA0;Luis Correa&#XA0;Jr., Jeff&#XA0;H. Perkins, and
Michael&#XA0;D. Ernst.
Practical pluggable types for Java.
In <em>ISSTA 2008, Proceedings of the 2008 International Symposium
on Software Testing and Analysis</em>, pages 201&#X2013;212, Seattle, WA, USA, July
2008.</dd><dt class="dt-thebibliography"><a id="QuinonezTE2008">[QTE08]</a></dt><dd class="dd-thebibliography">
Jaime Quinonez, Matthew&#XA0;S. Tschantz, and Michael&#XA0;D. Ernst.
Inference of reference immutability.
In <em>ECOOP 2008 &#X2014; Object-Oriented Programming, 22nd European
Conference</em>, pages 616&#X2013;641, Paphos, Cyprus, July 2008.</dd><dt class="dt-thebibliography"><a id="SteinCSC2018">[SCSC18]</a></dt><dd class="dd-thebibliography">
Benno Stein, Lazaro Clapp, Manu Sridharan, and Bor-Yuh&#XA0;Evan Chang.
Safe stream-based programming with refinement types.
In <em>ASE 2018: Proceedings of the 33rd Annual International
Conference on Automated Software Engineering</em>, pages 565&#X2013;576, Montpellier,
France, September 2018.</dd><dt class="dt-thebibliography"><a id="SpishakDE2012">[SDE12]</a></dt><dd class="dd-thebibliography">
Eric Spishak, Werner Dietl, and Michael&#XA0;D. Ernst.
A type system for regular expressions.
In <em>FTfJP: 14th Workshop on Formal Techniques for Java-like
Programs</em>, pages 20&#X2013;26, Beijing, China, June 2012.</dd><dt class="dt-thebibliography"><a id="SampsonDFGCG2011">[SDF<sup>+</sup>11]</a></dt><dd class="dd-thebibliography">
Adrian Sampson, Werner Dietl, Emily Fortuna, Danushen Gnanapragasam, Luis Ceze,
and Dan Grossman.
EnerJ: Approximate data types for safe and general low-power
computation.
In <em>PLDI 2011: Proceedings of the </em><em>ACM</em><em> </em><em>SIGPLAN</em><em> 2011 Conference
on Programming Language Design and Implementation</em>, pages 164&#X2013;174, San Jose,
CA, USA, June 2011.</dd><dt class="dt-thebibliography"><a id="SummersM2011">[SM11]</a></dt><dd class="dd-thebibliography">
Alexander&#XA0;J. Summers and Peter M&#XFC;ller.
Freedom before commitment: A lightweight type system for object
initialisation.
In <em>OOPSLA 2011, Object-Oriented Programming Systems, Languages,
and Applications</em>, pages 1013&#X2013;1032, Portland, OR, USA, October 2011.</dd><dt class="dt-thebibliography"><a id="TschantzE2005">[TE05]</a></dt><dd class="dd-thebibliography">
Matthew&#XA0;S. Tschantz and Michael&#XA0;D. Ernst.
Javari: Adding reference immutability to Java.
In <em>OOPSLA 2005, Object-Oriented Programming Systems, Languages,
and Applications</em>, pages 211&#X2013;230, San Diego, CA, USA, October 2005.</dd><dt class="dt-thebibliography"><a id="TangPJ2010">[TPV10]</a></dt><dd class="dd-thebibliography">
Daniel Tang, Ales Plsek, and Jan Vitek.
Static checking of safety critical Java annotations.
In <em>JTRES 2010: 8th International Workshop on Java Technologies
for Real-time and Embedded Systems</em>, pages 148&#X2013;154, Prague, Czech Republic,
August 2010.</dd><dt class="dt-thebibliography"><a id="VakilianPEJ2014">[VPEJ14]</a></dt><dd class="dd-thebibliography">
Mohsen Vakilian, Amarin Phaosawasdi, Michael&#XA0;D. Ernst, and Ralph&#XA0;E. Johnson.
Cascade: A universal type qualifier inference tool.
Technical report, University of Illinois at Urbana-Champaign, Urbana,
IL, USA, September 2014.</dd><dt class="dt-thebibliography"><a id="WeitzKSE2014">[WKSE14]</a></dt><dd class="dd-thebibliography">
Konstantin Weitz, Gene Kim, Siwakorn Srisakaokul, and Michael&#XA0;D. Ernst.
A type system for format strings.
In <em>ISSTA 2014, Proceedings of the 2014 International Symposium
on Software Testing and Analysis</em>, pages 127&#X2013;137, San Jose, CA, USA, July
2014.</dd><dt class="dt-thebibliography"><a id="WrigstadPMZV2009">[WPM<sup>+</sup>09]</a></dt><dd class="dd-thebibliography">
Tobias Wrigstad, Filip Pizlo, Fadi Meawad, Lei Zhao, and Jan Vitek.
Loci: Simple thread-locality for Java.
In <em>ECOOP 2009 &#X2014; Object-Oriented Programming, 23rd European
Conference</em>, pages 445&#X2013;469, Genova, Italy, July 2009.</dd><dt class="dt-thebibliography"><a id="ZibinPAAKE2007">[ZPA<sup>+</sup>07]</a></dt><dd class="dd-thebibliography">
Yoav Zibin, Alex Potanin, Mahmood Ali, Shay Artzi, Adam Kie&#X17C;un, and
Michael&#XA0;D. Ernst.
Object and reference immutability using Java generics.
In <em>ESEC/FSE 2007: Proceedings of the 11th European Software
Engineering Conference and the 15th </em><em>ACM</em><em> </em><em>SIGSOFT</em><em> Symposium on the
Foundations of Software Engineering</em>, pages 75&#X2013;84, Dubrovnik, Croatia,
September 2007.</dd><dt class="dt-thebibliography"><a id="ZibinPLAE2010">[ZPL<sup>+</sup>10]</a></dt><dd class="dd-thebibliography">
Yoav Zibin, Alex Potanin, Paley Li, Mahmood Ali, and Michael&#XA0;D. Ernst.
Ownership and immutability in generic Java.
In <em>OOPSLA 2010, Object-Oriented Programming Systems, Languages,
and Applications</em>, pages 598&#X2013;617, Revo, NV, USA, October 2010.</dd></dl><!--CUT END -->
<!--HTMLFOOT-->
<!--ENDHTML-->
</body>
</html>
